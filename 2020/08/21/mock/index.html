<!DOCTYPE html>
<html  lang="zh-CN" >
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="theme-color" content="#fff" id="theme-color">
  <meta name="description" content="本博客大多内容为慕课和网上博客，并非原创">
  <link rel="icon" href="/img/logo.png">
  <title>HTML</title>
  
  
  <meta property="og:title" content="HTML">
  
  
  <meta property="og:url" content="https://bubbleboy11.github.io/2020/08/21/mock/index.html">
  
  
  <meta property="og:img" content="/img/author_img.png">
  
  
  <meta property="og:img" content="本博客大多内容为慕课和网上博客，并非原创">
  
  
  <meta property="og:type" content="article">
  <meta property="og:article:published_time" content="2020-08-20">
  <meta property="og:article:modified_time" content="2021-04-02">
  <meta property="og:article:author" content="外心人D">
  
  
  <meta property="og:article:tag" content="剑指offer">
  
  <meta property="og:article:tag" content="Leetcode">
  
  
  
  
  <script>
    // control reverse button
    var reverseDarkList = {
      dark: 'light',
      light: 'dark'
    };
    var themeColor = {
      dark: '#1c1c1e',
      light: '#fff'
    }
    // get the data of css prefers-color-scheme
    var getCssMediaQuery = function() {
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    };
    // reverse current darkmode setting function
    var reverseDarkModeSetting = function() {
      var setting = localStorage.getItem('user-color-scheme');
      if(reverseDarkList[setting]) {
        setting = reverseDarkList[setting];
      } else if(setting === null) {
        setting = reverseDarkList[getCssMediaQuery()];
      } else {
        return;
      }
      localStorage.setItem('user-color-scheme', setting);
      return setting;
    };
    // apply current darkmode setting
    var setDarkmode = function(mode) {
      var setting = mode || localStorage.getItem('user-color-scheme');
      if(setting === getCssMediaQuery()) {
        document.documentElement.removeAttribute('data-user-color-scheme');
        localStorage.removeItem('user-color-scheme');
        document.getElementById('theme-color').content = themeColor[setting];
      } else if(reverseDarkList[setting]) {
        document.documentElement.setAttribute('data-user-color-scheme', setting);
        document.getElementById('theme-color').content = themeColor[setting];
      } else {
        document.documentElement.removeAttribute('data-user-color-scheme');
        localStorage.removeItem('user-color-scheme');
        document.getElementById('theme-color').content = themeColor[getCssMediaQuery()];
      }
    };
    setDarkmode();
  </script>
  <script>
    function loadScript(url, cb) {
      var script = document.createElement('script');
      script.src = url;
      if (cb) script.onload = cb;
      script.async = true;
      document.body.appendChild(script);
    }
  </script>
  
  <link rel="preload" href="//at.alicdn.com/t/font_1946621_i1kgafibvw.css" as="style" >
  <link rel="preload" href="//at.alicdn.com/t/font_1952792_89b4ac4k4up.css" as="style" >
  
  <link rel="preload" href="/js/lib/lightbox/baguetteBox.min.js" as="script">
  <link rel="preload" href="/js/lib/lightbox/baguetteBox.min.css" as="style" >
  
  
  <link rel="preload" href="/js/lib/lozad.min.js" as="script">
  
  
  
  
  
  <link rel="prefetch" href="//cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-svg.js" as="script">
  
  
  
  
  
<link rel="stylesheet" href="/css/main.css">

  
  
<link rel="stylesheet" href="//at.alicdn.com/t/font_1946621_i1kgafibvw.css">

  
  
<link rel="stylesheet" href="//at.alicdn.com/t/font_1952792_89b4ac4k4up.css">

  
  
<link rel="stylesheet" href="/js/lib/lightbox/baguetteBox.min.css">

  
  
  
  
<meta name="generator" content="Hexo 5.0.2"><link rel="alternate" href="/atom.xml" title="外心人D的博客" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism.css" type="text/css"></head>


<body>
  <div class="wrapper">
    
    <nav class="navbar">
  <div class="navbar-logo">
    <span class="navbar-logo-main">
      
      <img class="navbar-logo-img" src="/img/logo.png" alt="logo">
      
      <span class="navbar-logo-dsc">外心人D</span>
    </span>
  </div>
  <div class="navbar-menu">
    
    <a href="/" class="navbar-menu-item">
    
    首页
    
    </a>
    
    <a href="/archives" class="navbar-menu-item">
    
    归档
    
    </a>
    
    <a href="/tags" class="navbar-menu-item">
    
    标签
    
    </a>
    
    <a href="/categories" class="navbar-menu-item">
    
    分类
    
    </a>
    
    <a href="/about" class="navbar-menu-item">
    
    关于
    
    </a>
    
    <a href="/links" class="navbar-menu-item">
    
    友链
    
    </a>
    
    <a class="navbar-menu-item darknavbar" id="dark"><i class="iconfont icon-weather"></i></a>
    <a class="navbar-menu-item searchnavbar" id="search"><i class="iconfont icon-search" style="font-size: 1.2rem; font-weight: 400;"></i></a>
  </div>
</nav>
    
    <div id="local-search" style="display: none;">
      <input class="navbar-menu-item" id="search-input" placeholder="请输入搜索内容...">
      <div id="search-content"></div>
    </div>
    
    <div class="section-wrap">
      <div class="container">
        <div class="columns">
          <main class="main-column">
<article class="card card-content">
  <header>
    <h1 class="post-title">
      HTML
    </h1>
  </header>
  <div class="post-meta post-show-meta">
    <time datetime="2020-08-20T16:21:41.000Z">
      <i class="iconfont icon-calendar" style="margin-right: 2px;"></i>
      <span>2020-08-20</span>
    </time>
    
    <span class="dot"></span>
    
    <a href="/categories/Markdown/" class="post-meta-link">Markdown</a>
    
    
    
    <span class="dot"></span>
    <span>5.7k 字</span>
    
  </div>
  
  <div class="post-meta post-show-meta" style="margin-top: -10px;">
    <div style="display: flex; align-items: center;">
      <i class="iconfont icon-biaoqian" style="margin-right: 2px; font-size: 1.15rem;"></i>
      
      
        <a href="/tags/剑指offer/" class="post-meta-link">剑指offer</a>
      
      
      <span class="dot"></span>
      
        <a href="/tags/Leetcode/" class="post-meta-link">Leetcode</a>
      
    </div>
  </div>
  
  </header>
  <div id="section" class="post-content">
    <p>mock用来替代你测试应用的某一部分<br>好处<br>1：加快测试速度，如果你的应用是依赖于资源的，mock可以有效减少资源的占用<br>2：避免不必要的副作用</p>
<p>在单元测试进行的同时，就离不开mock模块的存在，初次接触这个概念的时候会有这样的疑问：把要测的东西都模拟掉了还测试什么呢？<br>　　但在，实际生产中的项目是非常复杂的，对其进行单元测试的时候，会遇到以下问题：<br>•接口的依赖<br>•外部接口调用<br>•测试环境非常复杂<br>单元测试应该只针对当前单元进行测试, 所有的内部或外部的依赖应该是稳定的, 已经在别处进行测试过的.使用mock 就可以对外部依赖组件实现进行模拟并且替换掉, 从而使得单元测试将焦点只放在当前的单元功能。<br>在这里插入图片描述<br>因为在为代码进行单元测试的同时，会发现该模块依赖于其他的模块，例如数据库，网络，或者第三方模块的存在，而我们对一个模块进行单元测试的目的，是测试当前模块正常工作，这样就要避开对其他模块的依赖，而mock主要作用便在于，专注于待测试的代码。而在但与测试中，如何灵活的使用mock模块是核心所在。下面便以mock为核心，结合最近所写的代码，阐述mock模块的使用。</p>
<p>这个例子，本来被调用的sum函数要执行很长时间为了加快测试进度，我们使用patch装饰器来直接mock sum函数</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre class=" language-hljs py"><span class="hljs-keyword">import</span> unittest<br><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">from</span> unittest <span class="hljs-keyword">import</span> TestCase<br><span class="hljs-keyword">from</span> unittest.mock <span class="hljs-keyword">import</span> patch<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">sum</span>(<span class="hljs-params">a, b</span>):</span><br>    time.sleep(<span class="hljs-number">100</span>)  <span class="hljs-comment"># long running process</span><br>    <span class="hljs-keyword">return</span> a + b<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestCalculator</span>(<span class="hljs-params">TestCase</span>):</span><br>    <span class="hljs-comment"># 用patch装饰器来mock对象</span><br><span class="hljs-meta">    @patch('__main__.sum', return_value=5)</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_sum</span>(<span class="hljs-params">self, sum</span>):</span><br>        self.assertEqual(sum(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>), <span class="hljs-number">5</span>)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<br>    unittest.main()<br><span class="hljs-comment"># ----------------------------------------------------------------------</span><br><span class="hljs-comment"># Ran 1 test in 0.001s</span><br><br><span class="hljs-comment"><code class="language-hljs py"><span class="hljs-keyword">import</span> unittest<br><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">from</span> unittest <span class="hljs-keyword">import</span> TestCase<br><span class="hljs-keyword">from</span> unittest.mock <span class="hljs-keyword">import</span> patch<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">sum</span>(<span class="hljs-params">a, b</span>):</span><br>    time.sleep(<span class="hljs-number">100</span>)  <span class="hljs-comment"># long running process</span><br>    <span class="hljs-keyword">return</span> a + b<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestCalculator</span>(<span class="hljs-params">TestCase</span>):</span><br>    <span class="hljs-comment"># 用patch装饰器来mock对象</span><br><span class="hljs-meta">    @patch('__main__.sum', return_value=5)</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_sum</span>(<span class="hljs-params">self, sum</span>):</span><br>        self.assertEqual(sum(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>), <span class="hljs-number">5</span>)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<br>    unittest.main()<br><span class="hljs-comment"># ----------------------------------------------------------------------</span><br><span class="hljs-comment"># Ran 1 test in 0.001s</span><br><br><span class="hljs-comment"># OK</span><br></code></pre></td></tr></tbody></table></figure>

<ol start="7">
<li>mock模块的使用<br>在mock模块中，两个常用的类型为Mock，MagicMock，两个类的关系是MagicMock继承自Mock，最重要的两个属性是return_value, side_effect。<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre class=" language-hljs py"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">from</span> mock <span class="hljs-keyword">import</span> Mock<br><span class="hljs-meta">&gt;&gt;&gt; </span>fake_obj = Mock()<br>&gt;&gt;&gt;fake_obj.return_value = <span class="hljs-string">'This is a mock object'</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>fake_obj()<br><span class="hljs-string"><code class="language-hljs py"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">from</span> mock <span class="hljs-keyword">import</span> Mock<br><span class="hljs-meta">&gt;&gt;&gt; </span>fake_obj = Mock()<br>&gt;&gt;&gt;fake_obj.return_value = <span class="hljs-string">'This is a mock object'</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>fake_obj()<br><span class="hljs-string">'This is a mock object'</span><br></code></pre></td></tr></tbody></table></figure>

</li>
</ol>
<p>我们通过Mock()可以创建一个mock对象，通过renturn_value 指定它的返回值。即当下文出现fake_obj()会返回其return_value所指定的值。<br>也可以通过side_effect指定它的副作用，这个副作用就是当你调用这个mock对象是会调用的函数,也可以选择抛出一个异常，来对程序的错误状态进行测试。</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre class=" language-hljs py">&gt;&gt;&gt;<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">b</span>():</span><br><span class="hljs-meta">... </span>   <span class="hljs-keyword">print</span> <span class="hljs-string">'This is b'</span><br>...<br>&gt;&gt;&gt;fake_obj.side_effect = b<br>&gt;&gt;&gt;fake_obj()<br>This <span class="hljs-keyword">is</span> b<br>&gt;&gt;&gt;fake_obj.side_effect = KeyError(<span class="hljs-string">'This is b'</span>)<br>&gt;&gt;&gt;fake_obj()<br>...<br>KeyError: <span class="hljs-string"><code class="language-hljs py">&gt;&gt;&gt;<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">b</span>():</span><br><span class="hljs-meta">... </span>   <span class="hljs-keyword">print</span> <span class="hljs-string">'This is b'</span><br>...<br>&gt;&gt;&gt;fake_obj.side_effect = b<br>&gt;&gt;&gt;fake_obj()<br>This <span class="hljs-keyword">is</span> b<br>&gt;&gt;&gt;fake_obj.side_effect = KeyError(<span class="hljs-string">'This is b'</span>)<br>&gt;&gt;&gt;fake_obj()<br>...<br>KeyError: <span class="hljs-string">'This is b'</span><br></code></pre></td></tr></tbody></table></figure>
<p>如果要模拟一个对象而不是函数，你可以直接在mock对象上添加属性和方法，并且每一个添加的属性都是一个mock对象【注意，这种方式很有用】，也就是说可以对这些属性进行配置,并且可以一直递归的定义下去。</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre class=" language-hljs py">&gt;&gt;&gt;fake_obj.fake_a.return_value = <span class="hljs-string">'This is fake_obj.fake_a'</span><br>&gt;&gt;&gt;fake_obj.fake_a()<br><span class="hljs-string"><code class="language-hljs py">&gt;&gt;&gt;fake_obj.fake_a.return_value = <span class="hljs-string">'This is fake_obj.fake_a'</span><br>&gt;&gt;&gt;fake_obj.fake_a()<br><span class="hljs-string">'This is fake_obj.fake_a'</span><br></code></pre></td></tr></tbody></table></figure>
<p>上述代码片段中fake_obj是一个mock对象，而fake_obj.fake_a的这种形式使得fake_a变成了fake_obj的一个属性，作用是在fake_obj.fake_a()调用时会返回其return_value。<br>另外也可以通过为side_effect指定一个列表，这样在每次调用时会依次返回，如下：</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre class=" language-hljs py"><span class="hljs-meta">&gt;&gt;&gt; </span>fake_obj = Mock(side_effect = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>])<br>&gt;&gt;&gt;fake_obj()<br><span class="hljs-number">1</span><br>&gt;&gt;&gt;fake_obj()<br><span class="hljs-number">2</span><br>&gt;&gt;&gt;fake_obj()<br><span class="hljs-number"><code class="language-hljs py"><span class="hljs-meta">&gt;&gt;&gt; </span>fake_obj = Mock(side_effect = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>])<br>&gt;&gt;&gt;fake_obj()<br><span class="hljs-number">1</span><br>&gt;&gt;&gt;fake_obj()<br><span class="hljs-number">2</span><br>&gt;&gt;&gt;fake_obj()<br><span class="hljs-number">3</span><br></code></pre></td></tr></tbody></table></figure>
<p>7.1 函数的如何mock<br>在rbd_api.py文件中如下内容：</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre class=" language-hljs py"><span class="hljs-keyword">import</span> DAO_PoolMgr<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">checkpoolstat</span>(<span class="hljs-params">pool_name</span>)</span><br>  ret， poolstat = DAO_PoolMgr.DAO_query_ispoolok(pool_name)<br><span class="hljs-keyword">if</span> ret != MGR_COMMON.MONGO_SUCCESS:<br>    <span class="hljs-keyword">return</span> ret<br><span class="hljs-keyword">if</span> poolstat <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>    <span class="hljs-keyword">return</span> MGR_COMMON.POOL_STAT_ERROR<br><span class="hljs-keyword"><code class="language-hljs py"><span class="hljs-keyword">import</span> DAO_PoolMgr<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">checkpoolstat</span>(<span class="hljs-params">pool_name</span>)</span><br>  ret， poolstat = DAO_PoolMgr.DAO_query_ispoolok(pool_name)<br><span class="hljs-keyword">if</span> ret != MGR_COMMON.MONGO_SUCCESS:<br>    <span class="hljs-keyword">return</span> ret<br><span class="hljs-keyword">if</span> poolstat <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>    <span class="hljs-keyword">return</span> MGR_COMMON.POOL_STAT_ERROR<br><span class="hljs-keyword">return</span> MGR_COMMON.SUCCESS<br></code></pre></td></tr></tbody></table></figure>

<p>要为这个函数撰写单元测试，因为其有数据库的操作，因而就需要mock 出DAO_query_ispoolok操作。<br>因此，我们在test_rbd_api.py文件中可以这么写：因为DAO_query_ispoolok是类DAO_PoolMgr的操作，因此可以这么写</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre class=" language-hljs py"><span class="hljs-comment">#!/usr/bin/python</span><br><span class="hljs-keyword">import</span> DAO_PoolMgr<br><span class="hljs-keyword">import</span> unittest<br><span class="hljs-keyword">import</span> rbd_api <span class="hljs-keyword">as</span> rbdAPI<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestAuxiliaryFunction</span>(<span class="hljs-params">unittest.TestCase</span>):</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">setUp</span>(<span class="hljs-params">self</span>):</span><br>        self.pool_name = <span class="hljs-string">"aaa"</span><br>    <br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">tearDown</span>(<span class="hljs-params">self</span>):</span><br>        self.pool_name = <span class="hljs-literal">None</span><br><span class="hljs-meta">    @mock.patch.object(DAO_PoolMgr, "DAO_query_ispoolok")</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_checkpoolstat</span>(<span class="hljs-params">self, mock_DAO_query_ispoolok</span>):</span><br>        mock_DAO_query_ispoolok.return_value = (MGR_COMMON.POOL_STAT_ERROR, <span class="hljs-literal">None</span>)<br>        self.<span class="hljs-keyword">assert</span>(rbdAPI.checkpoolstat(self.pool_name), MGR_COMMON.POOL_STAT_ERROR)<br><br>        mock_DAO_query_ispoolok.return_value = (MGR_COMMON.SUCCESS, <span class="hljs-literal">False</span>)<br>        self.<span class="hljs-keyword">assert</span>(rbdAPI.checkpoolstat(self.pool_name), MGR_COMMON.POOL_STAT_ERROR)<br>        <br>        mock_DAO_query_ispoolok.return_value = (MGR_COMMON.SUCCESS, <span class="hljs-literal">True</span>)<br>        self.<span class="hljs-keyword"><code class="language-hljs py"><span class="hljs-comment">#!/usr/bin/python</span><br><span class="hljs-keyword">import</span> DAO_PoolMgr<br><span class="hljs-keyword">import</span> unittest<br><span class="hljs-keyword">import</span> rbd_api <span class="hljs-keyword">as</span> rbdAPI<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestAuxiliaryFunction</span>(<span class="hljs-params">unittest.TestCase</span>):</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">setUp</span>(<span class="hljs-params">self</span>):</span><br>        self.pool_name = <span class="hljs-string">"aaa"</span><br>    <br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">tearDown</span>(<span class="hljs-params">self</span>):</span><br>        self.pool_name = <span class="hljs-literal">None</span><br><span class="hljs-meta">    @mock.patch.object(DAO_PoolMgr, "DAO_query_ispoolok")</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_checkpoolstat</span>(<span class="hljs-params">self, mock_DAO_query_ispoolok</span>):</span><br>        mock_DAO_query_ispoolok.return_value = (MGR_COMMON.POOL_STAT_ERROR, <span class="hljs-literal">None</span>)<br>        self.<span class="hljs-keyword">assert</span>(rbdAPI.checkpoolstat(self.pool_name), MGR_COMMON.POOL_STAT_ERROR)<br><br>        mock_DAO_query_ispoolok.return_value = (MGR_COMMON.SUCCESS, <span class="hljs-literal">False</span>)<br>        self.<span class="hljs-keyword">assert</span>(rbdAPI.checkpoolstat(self.pool_name), MGR_COMMON.POOL_STAT_ERROR)<br>        <br>        mock_DAO_query_ispoolok.return_value = (MGR_COMMON.SUCCESS, <span class="hljs-literal">True</span>)<br>        self.<span class="hljs-keyword">assert</span>(rbdAPI.checkpoolstat(self.pool_name), MGR_COMMON.SUCCESS)<br></code></pre></td></tr></tbody></table></figure>
<p>测试用例上的装饰器含义如下：<br>@mock.pathc.object(类名，“类中函数名”)，而如果想要忽略某个测试用例，则可以通过装饰器@unittest.skip(“原因”)<br>而对于另外一种情形则是在另外一个函数中调用了checkpoolstat函数。<br>如下rbd_api.py：</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre class=" language-hljs py"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">checkpoolstat</span>():</span><br>    ……<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Disk</span>(<span class="hljs-params">Resource</span>):</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span>  <span class="hljs-title">__init__</span>(<span class="hljs-params">self</span>):</span><br>        ……<br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">delete</span>(<span class="hljs-params"><code class="language-hljs py"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">checkpoolstat</span>():</span><br>    ……<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Disk</span>(<span class="hljs-params">Resource</span>):</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span>  <span class="hljs-title">__init__</span>(<span class="hljs-params">self</span>):</span><br>        ……<br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">delete</span>(<span class="hljs-params">self, pool, img</span>):</span><br>        ret = rbd_api.checkpoolstat()<br>        ……<br></code></pre></td></tr></tbody></table></figure>
<p>这样，我们在为delete函数撰写单元测试时，也可以在test_rbd_api.py中使用如下的方式：</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre class=" language-hljs py"><span class="hljs-keyword">import</span> rbd_api<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestDisk</span>(<span class="hljs-params">unittest.TestCase</span>):</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">setup</span>():</span><br>        …<br>      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">teardown</span>():</span><br>              …<br><span class="hljs-meta">      @mock.patch(“rbd_api.checkpoolstat”, Mock(return_value = True))</span><br>      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_delete</span>():</span><br>         <span class="hljs-comment"><code class="language-hljs py"><span class="hljs-keyword">import</span> rbd_api<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestDisk</span>(<span class="hljs-params">unittest.TestCase</span>):</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">setup</span>():</span><br>        …<br>      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">teardown</span>():</span><br>              …<br><span class="hljs-meta">      @mock.patch(“rbd_api.checkpoolstat”, Mock(return_value = True))</span><br>      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_delete</span>():</span><br>         <span class="hljs-comment"># rbd_api.checkpoolstat 已经成为一个mock对象了，调用时返回True</span><br>            …<br></code></pre></td></tr></tbody></table></figure>
<p>此时的装饰器应该为</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs py"><span class="hljs-meta"><code class="language-hljs py"><span class="hljs-meta">@mock.patch(“模块名.函数名”)</span><br></code></pre></td></tr></tbody></table></figure>

<p>7.2 链式函数抛出异常<br>在rbd_api.py文件中，有一行代码如下：</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs py"><code class="language-hljs py">ret = OpRBD(pool).flatten(img)<br></code></pre></td></tr></tbody></table></figure>
<p>类似这种链式调用的，在前一个函数中抛出异常，要怎么写？如下：</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre class=" language-hljs py">rbdServ.OpRBD = MagicMock()<br>rbdServ.OpRBD(pool).side_effect = rados.Error(“Error: error connecting to the cluster: error code <span class="hljs-number"><code class="language-hljs py">rbdServ.OpRBD = MagicMock()<br>rbdServ.OpRBD(pool).side_effect = rados.Error(“Error: error connecting to the cluster: error code <span class="hljs-number">24</span>”)<br></code></pre></td></tr></tbody></table></figure>
<p>7.3 全局函数如何mock<br>例如在文件rbd_api.py中有全局函数checkpoolstat(pool)，它是一个全局函数，这样在进行单元测试的过程中，我们可能需要mock该函数。该函数的具体代码如下：</p>
<p>因此，我们在test_rbd_api.py文件中为该函数撰写单元测试，可以这么做。<br>在文件开始处导入该rbd_api模块。</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre class=" language-hljs py"><span class="hljs-keyword">import</span> rbd_api <span class="hljs-keyword">as</span> rbdAPI<br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_patchInvalid_Parameter</span>(<span class="hljs-params"><code class="language-hljs py"><span class="hljs-keyword">import</span> rbd_api <span class="hljs-keyword">as</span> rbdAPI<br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_patchInvalid_Parameter</span>(<span class="hljs-params">self</span>):</span><br>    ……<br>    rbdAPI.checkpoolstat.return_value = MGR_COMMON.POOL_STAT_ERROR<br>    即可。<br></code></pre></td></tr></tbody></table></figure>
<p>7.4 链式调用正常<br>在rbd_api文件中有如下代码行：</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs py"><code class="language-hljs py">ret = OpRBD(pool).flatten(img)<br></code></pre></td></tr></tbody></table></figure>
<p>在第一个函数未出现异常，在flatten函数中返回值可以在test_rbd_api.py文件中如下写代码：</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs py"><code class="language-hljs py">rbdServ.OpRBD(pool).snap_rollback = MagicMock(return_value = RBD_COMMON.CODE_EXEC_SUCCESS_MODIFY)<br></code></pre></td></tr></tbody></table></figure>
<p>7.5 with子句mock</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre class=" language-hljs py"><span class="hljs-comment">#!/usr/bin/python</span><br><span class="hljs-keyword">import</span> rados<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OpRBD</span>:</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self</span>):</span><br>        ...<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__del__</span>(<span class="hljs-params">self</span>):</span><br>        ...<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">resize</span>(<span class="hljs-params">self, img, size</span>):</span><br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-keyword">with</span> rbd.Image(self.ioctx, img) <span class="hljs-keyword">as</span> image:<br>                <span class="hljs-keyword">if</span> image.size() &lt; size:<br>                    image.resize(size)<br>                <span class="hljs-keyword">else</span>:<br>                    <span class="hljs-keyword">return</span> RBD_COMMON.CODE_ARGUMENT_LESS_THAN_ORIGINAL<br>        <span class="hljs-keyword">except</span> rbd.ImageNotFound <span class="hljs-keyword">as</span> exce1<br>          print(exce1)<br>          <span class="hljs-keyword"><code class="language-hljs py"><span class="hljs-comment">#!/usr/bin/python</span><br><span class="hljs-keyword">import</span> rados<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OpRBD</span>:</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self</span>):</span><br>        ...<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__del__</span>(<span class="hljs-params">self</span>):</span><br>        ...<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">resize</span>(<span class="hljs-params">self, img, size</span>):</span><br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-keyword">with</span> rbd.Image(self.ioctx, img) <span class="hljs-keyword">as</span> image:<br>                <span class="hljs-keyword">if</span> image.size() &lt; size:<br>                    image.resize(size)<br>                <span class="hljs-keyword">else</span>:<br>                    <span class="hljs-keyword">return</span> RBD_COMMON.CODE_ARGUMENT_LESS_THAN_ORIGINAL<br>        <span class="hljs-keyword">except</span> rbd.ImageNotFound <span class="hljs-keyword">as</span> exce1<br>          print(exce1)<br>          <span class="hljs-keyword">return</span> RBD_COMMON.CODE_IMAGE_NOT_FOUND<br></code></pre></td></tr></tbody></table></figure>
<p>由于是在with子句中要进行mock，在此简单的对with的知识点进行说明：<br>要使用 with 语句，首先要明白上下文管理器这一概念。有了上下文管理器，with 语句才能工作。<br>下面是一组与上下文管理器和with 语句有关的概念。</p>
<p>上下文管理协议（Context Management Protocol）：包含方法 enter() 和 exit()，支持<br>该协议的对象要实现这两个方法。<br>上下文管理器（Context Manager）：支持上下文管理协议的对象，这种对象实现了 enter() 和 exit() 方法。上下文管理器定义执行 with 语句时要建立的运行时上下文，<br>负责执行 with 语句块上下文中的进入与退出操作。通常使用 with 语句调用上下文管理器，也可以通过直接调用其方法来使用。<br>运行时上下文（runtime context）：由上下文管理器创建，通过上下文管理器的 enter() 和<strong>exit</strong>() 方法实现，enter() 方法在语句体执行之前进入运行时上下文，exit() 在语句体执行完后从运行时上下文退出。with 语句支持运行时上下文这一概念。<br>上下文表达式（Context Expression）：with 语句中跟在关键字 with 之后的表达式，该表达式要返回一个上下文管理器对象。<br>语句体（with-body）：with 语句包裹起来的代码块，在执行语句体之前会调用上下文管理器的 enter() 方法，执行完语句体之后会执行 exit() 方法。<br>出现异常时，如果 exit(type, value, traceback) 返回 False，则会重新抛出异常，让with 之外的语句逻辑来处理异常，这也是通用做法；如果返回 True，则忽略异常，不再对异常进行处理。因此，在对with子句进行mock时，要具有两个函数，exit, enter，并且如果在with语句体重抛出异常并被with之外的代码进行捕获异常，要使得__exit__返回False，因此可以撰写测试代码如下：</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre class=" language-hljs py"><span class="hljs-comment">#!/usr/bin/python</span><br><span class="hljs-keyword">import</span> rados<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OpRBD</span>:</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self</span>):</span><br>    ...<br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__del__</span>(<span class="hljs-params">self</span>):</span><br>        ...<br>    <br>        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">resize</span>(<span class="hljs-params">self, img, size</span>):</span><br>            <span class="hljs-keyword">try</span>:<br>                <span class="hljs-keyword">with</span> rbd.Image(self.ioctx, img) <span class="hljs-keyword">as</span> image:<br>                    <span class="hljs-keyword">if</span> image.size() &lt; size:<br>                        image.resize(size)<br>                    <span class="hljs-keyword">else</span>:<br>                        <span class="hljs-keyword">return</span> RBD_COMMON.CODE_ARGUMENT_LESS_THAN_ORIGINAL<br>            <span class="hljs-keyword">except</span> rbd.ImageNotFound <span class="hljs-keyword">as</span> exce1<br>                print(exce1)<br>                <span class="hljs-keyword">return</span> RBD_COMMON.CODE_IMAGE_NOT_FOUND<br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestOpRBD</span>(<span class="hljs-params">unittest.TestCase</span>):</span><br>        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">setUp</span>(<span class="hljs-params">self</span>):</span><br>            ...<br>        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">tearDown</span>(<span class="hljs-params">self</span>):</span><br>            ...<br>        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_resize</span>(<span class="hljs-params">self</span>):</span><br>            fake_image = Mock()<br>            fake_image.__enter__ = Mock(return_value = fake_image)<br>            fake_image.__exit__ = Mock(return_value = <span class="hljs-literal">True</span>)<br>            rbd.Image = Mock(return_value = fake_image)<br>            size = <span class="hljs-number">1073741824L</span> / <span class="hljs-number">2</span><br>            fake_image.size = Mock(return_value = <span class="hljs-number">1073741824L</span>)<br>            fake_image.resize = Mock(return_value = <span class="hljs-literal">None</span>)<br>            self.assertEqual(self.opRBD.resize(self.img, size), RBD_COMMON.CODE_ARGUMENT_LESS_THAN_ORIGINAL)<br>            <br>            size = <span class="hljs-number">2</span> * <span class="hljs-number">1073741824L</span><br>            self.assertEqual(self.opRBD.resize(self.img, size), RBD_COMMON.CODE_EXEC_SUCCESS_MODIFY)<br>            rbd.Image = Mock(side_effect = rbd.ImageNotFound(<span class="hljs-string">"%s image not found!"</span> %self.img))<br>            self.assertEqual(self.resize(self.img, size), RBD_COMMON.CODE_IMAGE_NOT_FOUND)<br>```    <br><br><span class="hljs-number">7.6</span> 连续mock<br>在rbd_api文件中有一个OpRados类的内容如下：<br>```py<br><span class="hljs-comment">#!/usr/bin/python</span><br><span class="hljs-keyword">import</span> rados<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OpRados</span>:</span><br>     <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self</span>):</span><br>          self.cluster = rados.Rados(conffile=rconf[<span class="hljs-string">'conffile'</span>])<br>          self.cluster.connect()<br>     <br>     <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__del__</span>(<span class="hljs-params">self</span>):</span><br>          self.cluster.shutdown()<br>     <br>     <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">lists</span>(<span class="hljs-params">self</span>):</span><br>          <span class="hljs-keyword">return</span> util.return_format(RBD_COMMON.CODE_EXEC_SUCCESS_GET, <span class="hljs-string">""</span>, self.cluster.list_pools())<br><br>为该类写单元测试，具体代码如下：<br><br><span class="hljs-comment">#!/usr/bin/python</span><br><span class="hljs-keyword">import</span> rados<br><span class="hljs-keyword">import</span> unittest<br><span class="hljs-keyword">from</span> mock <span class="hljs-keyword">import</span> Mock<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestOpRados</span>(<span class="hljs-params">unittest.TestCase</span>):</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">setUp</span>(<span class="hljs-params">self</span>)：</span><br>        fake_Rados = Mock()<br>        fake_Rados.connect = Mock(return_value = <span class="hljs-literal">None</span>)<br>        fake_Rados.shutdown = Mock(return_value = <span class="hljs-literal">None</span>)<br>        fake_Rados.list_pools = Mock(return_value = [<span class="hljs-string">"sqh"</span>, <span class="hljs-string">"sqh1"</span>])<br>        <span class="hljs-comment"># 注意：此处要使得rados.Rados()调用返回fake_Rados.</span><br>        <span class="hljs-comment"># 如果写成rados.Rados = fake_Rados,只能使得self.cluster重新生成一个Mock对象</span><br>        <span class="hljs-comment"># 无法有效的控制为fake_Rados所添加的属性。</span><br>        rados.Rados = Mock(return_value = fake_Rados)<br>        self.opRados = OpRados()<br>        <br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">tearDown</span>(<span class="hljs-params">self</span>):</span><br>        fake_Rados = <span class="hljs-literal">None</span><br>        self.opRados = <span class="hljs-literal">None</span><br>    <br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_list</span>(<span class="hljs-params">self</span>):</span><br>        return_list = [<span class="hljs-string">"sqh"</span>, <span class="hljs-string">"sqh1"</span>]<br>        self.assertEqual(self.opRados.lists(), util.return_format(RBD_COMMON.CODE_EXEC_SUCCESS_GET,  <span class="hljs-string"><code class="language-hljs py"><span class="hljs-comment">#!/usr/bin/python</span><br><span class="hljs-keyword">import</span> rados<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OpRBD</span>:</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self</span>):</span><br>    ...<br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__del__</span>(<span class="hljs-params">self</span>):</span><br>        ...<br>    <br>        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">resize</span>(<span class="hljs-params">self, img, size</span>):</span><br>            <span class="hljs-keyword">try</span>:<br>                <span class="hljs-keyword">with</span> rbd.Image(self.ioctx, img) <span class="hljs-keyword">as</span> image:<br>                    <span class="hljs-keyword">if</span> image.size() &lt; size:<br>                        image.resize(size)<br>                    <span class="hljs-keyword">else</span>:<br>                        <span class="hljs-keyword">return</span> RBD_COMMON.CODE_ARGUMENT_LESS_THAN_ORIGINAL<br>            <span class="hljs-keyword">except</span> rbd.ImageNotFound <span class="hljs-keyword">as</span> exce1<br>                print(exce1)<br>                <span class="hljs-keyword">return</span> RBD_COMMON.CODE_IMAGE_NOT_FOUND<br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestOpRBD</span>(<span class="hljs-params">unittest.TestCase</span>):</span><br>        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">setUp</span>(<span class="hljs-params">self</span>):</span><br>            ...<br>        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">tearDown</span>(<span class="hljs-params">self</span>):</span><br>            ...<br>        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_resize</span>(<span class="hljs-params">self</span>):</span><br>            fake_image = Mock()<br>            fake_image.__enter__ = Mock(return_value = fake_image)<br>            fake_image.__exit__ = Mock(return_value = <span class="hljs-literal">True</span>)<br>            rbd.Image = Mock(return_value = fake_image)<br>            size = <span class="hljs-number">1073741824L</span> / <span class="hljs-number">2</span><br>            fake_image.size = Mock(return_value = <span class="hljs-number">1073741824L</span>)<br>            fake_image.resize = Mock(return_value = <span class="hljs-literal">None</span>)<br>            self.assertEqual(self.opRBD.resize(self.img, size), RBD_COMMON.CODE_ARGUMENT_LESS_THAN_ORIGINAL)<br>            <br>            size = <span class="hljs-number">2</span> * <span class="hljs-number">1073741824L</span><br>            self.assertEqual(self.opRBD.resize(self.img, size), RBD_COMMON.CODE_EXEC_SUCCESS_MODIFY)<br>            rbd.Image = Mock(side_effect = rbd.ImageNotFound(<span class="hljs-string">"%s image not found!"</span> %self.img))<br>            self.assertEqual(self.resize(self.img, size), RBD_COMMON.CODE_IMAGE_NOT_FOUND)<br>```    <br><br><span class="hljs-number">7.6</span> 连续mock<br>在rbd_api文件中有一个OpRados类的内容如下：<br>```py<br><span class="hljs-comment">#!/usr/bin/python</span><br><span class="hljs-keyword">import</span> rados<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OpRados</span>:</span><br>     <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self</span>):</span><br>          self.cluster = rados.Rados(conffile=rconf[<span class="hljs-string">'conffile'</span>])<br>          self.cluster.connect()<br>     <br>     <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__del__</span>(<span class="hljs-params">self</span>):</span><br>          self.cluster.shutdown()<br>     <br>     <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">lists</span>(<span class="hljs-params">self</span>):</span><br>          <span class="hljs-keyword">return</span> util.return_format(RBD_COMMON.CODE_EXEC_SUCCESS_GET, <span class="hljs-string">""</span>, self.cluster.list_pools())<br><br>为该类写单元测试，具体代码如下：<br><br><span class="hljs-comment">#!/usr/bin/python</span><br><span class="hljs-keyword">import</span> rados<br><span class="hljs-keyword">import</span> unittest<br><span class="hljs-keyword">from</span> mock <span class="hljs-keyword">import</span> Mock<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestOpRados</span>(<span class="hljs-params">unittest.TestCase</span>):</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">setUp</span>(<span class="hljs-params">self</span>)：</span><br>        fake_Rados = Mock()<br>        fake_Rados.connect = Mock(return_value = <span class="hljs-literal">None</span>)<br>        fake_Rados.shutdown = Mock(return_value = <span class="hljs-literal">None</span>)<br>        fake_Rados.list_pools = Mock(return_value = [<span class="hljs-string">"sqh"</span>, <span class="hljs-string">"sqh1"</span>])<br>        <span class="hljs-comment"># 注意：此处要使得rados.Rados()调用返回fake_Rados.</span><br>        <span class="hljs-comment"># 如果写成rados.Rados = fake_Rados,只能使得self.cluster重新生成一个Mock对象</span><br>        <span class="hljs-comment"># 无法有效的控制为fake_Rados所添加的属性。</span><br>        rados.Rados = Mock(return_value = fake_Rados)<br>        self.opRados = OpRados()<br>        <br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">tearDown</span>(<span class="hljs-params">self</span>):</span><br>        fake_Rados = <span class="hljs-literal">None</span><br>        self.opRados = <span class="hljs-literal">None</span><br>    <br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_list</span>(<span class="hljs-params">self</span>):</span><br>        return_list = [<span class="hljs-string">"sqh"</span>, <span class="hljs-string">"sqh1"</span>]<br>        self.assertEqual(self.opRados.lists(), util.return_format(RBD_COMMON.CODE_EXEC_SUCCESS_GET,  <span class="hljs-string">""</span>, return_list))<br></code></pre></td></tr></tbody></table></figure>
<p>7.7 Flask API 接口的模拟调用<br>有三个文件：rbd_app.py文件内容如下：</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre class=" language-hljs py"><span class="hljs-comment">#!/usr/bin/python</span><br><span class="hljs-keyword">from</span> flask imort Flask<br><span class="hljs-keyword">from</span> flask.ext <span class="hljs-keyword">import</span> restful<br><br>app = Flask(__name__)<br>api = restful.Api(app)<br><br>api_version = <span class="hljs-string">"/v1.0"</span><br><span class="hljs-comment">##</span><br><span class="hljs-comment">## Actually setup the Api resource ruting here</span><br><span class="hljs-comment">##</span><br><br>...<br>api.add_resource(rbd_api.Disk, api_version+<span class="hljs-string">"pools/&lt;pool&gt;/disks/&lt;img&gt;"</span>)<br>...<br><br><span class="hljs-keyword">if</span> __name__ == __main__:<br>    <span class="hljs-keyword">from</span> gevent.wsgi <span class="hljs-keyword">import</span> WSGIServer<br>    http_server = WSGIServer((<span class="hljs-string">'0.0.0.0'</span>, <span class="hljs-number"><code class="language-hljs py"><span class="hljs-comment">#!/usr/bin/python</span><br><span class="hljs-keyword">from</span> flask imort Flask<br><span class="hljs-keyword">from</span> flask.ext <span class="hljs-keyword">import</span> restful<br><br>app = Flask(__name__)<br>api = restful.Api(app)<br><br>api_version = <span class="hljs-string">"/v1.0"</span><br><span class="hljs-comment">##</span><br><span class="hljs-comment">## Actually setup the Api resource ruting here</span><br><span class="hljs-comment">##</span><br><br>...<br>api.add_resource(rbd_api.Disk, api_version+<span class="hljs-string">"pools/&lt;pool&gt;/disks/&lt;img&gt;"</span>)<br>...<br><br><span class="hljs-keyword">if</span> __name__ == __main__:<br>    <span class="hljs-keyword">from</span> gevent.wsgi <span class="hljs-keyword">import</span> WSGIServer<br>    http_server = WSGIServer((<span class="hljs-string">'0.0.0.0'</span>, <span class="hljs-number">4806</span>), app)<br>    http_server.serve_forever()<br></code></pre></td></tr></tbody></table></figure>

<p>rbd_api.py文件中Disk类内容如下：</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre class=" language-hljs py"><span class="hljs-comment">#!/usr/bin/python</span><br><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> request<br><span class="hljs-keyword">from</span> flask_restful <span class="hljs-keyword">import</span> reqparse, Resource<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Disk</span>(<span class="hljs-params">Resource</span>):</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get</span>(<span class="hljs-params">self, pool, img</span>):</span><br>        ret, rbd_info = DAO_query_rbd_info(pool, img)<br>        ...<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">post</span>(<span class="hljs-params">self, pool, img</span>):</span><br>        parser = reqparser.RequestParser()<br>        <span class="hljs-comment"># action: create\copy\clone</span><br>        parser.add_argument(<span class="hljs-string">'action'</span>, type=str)<br>        parser.add_argument(<span class="hljs-string">'src_pool'</span>, type=str)<br>        parser.add_argument(<span class="hljs-string">'src_rbd'</span>, type=str)<br>        parser.add_argument(<span class="hljs-string">'src_snap'</span>, type=str)<br>        parser.add_argument(<span class="hljs-string">'size'</span>, type=str)<br>        parser.add_argument(<span class="hljs-string">'unit'</span>, type=str)<br>        <br>        action = args.get(<span class="hljs-string">'action'</span>)<br>        <span class="hljs-keyword">if</span> action == <span class="hljs-string">"create"</span>:<br>            size = args.get(<span class="hljs-string">'size'</span>)<br>            unit = args.get(<span class="hljs-string">'unit'</span>)<br>            ...<br>        <span class="hljs-keyword">elif</span> action == <span class="hljs-string">'copy'</span>:<br>            src_pool = args.get(<span class="hljs-string">'src_pool'</span>)<br>            src_rbd = args.get(<span class="hljs-string">'src_rbd'</span>)<br>            ...<br>        <span class="hljs-keyword">else</span><br>            <span class="hljs-keyword">return</span> ...<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">delete</span>(<span class="hljs-params">self, pool, img</span>):</span><br>        ...<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">put</span>(<span class="hljs-params">self, pool, img</span>):</span><br>        parser = reqparser.RequestParser()<br>        parser.add_argument(<span class="hljs-string">'rb_snap'</span>, type=str)<br>        parser.add_argument(<span class="hljs-string">'action'</span>, type=str)<br>        args = parser.parse_args()<br>        <br>        <span class="hljs-keyword">if</span> action == <span class="hljs-string">"flatten"</span>:<br>            ...<br>        <span class="hljs-keyword">elif</span> action == <span class="hljs-string">"rollback"</span>:<br>            snap = args.get(<span class="hljs-string">"rb_snap"</span>)<br>            ...<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> ...<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">patch</span>(<span class="hljs-params">self, pool, img</span>):</span><br>        parser = reqparse.RequestParser()<br>        parser.add_argument(<span class="hljs-string">"action"</span>, type=srt)<br>        parser.add_argument(<span class="hljs-string">"name"</span>, type=str)<br>        parser.add_argument(<span class="hljs-string">"size"</span>, type=float)<br>        parser.add_argument(<span class="hljs-string">"unit"</span>, type=str)<br>        args = parser.parse_args()<br>        action = args.get(<span class="hljs-string">'action'</span>)<br>        <span class="hljs-keyword">if</span> action == <span class="hljs-string">"resize"</span>:<br>            size = args.get(<span class="hljs-string">'size'</span>)<br>            unit = args.get(<span class="hljs-string">'unit'</span>)<br>            ....<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword"><code class="language-hljs py"><span class="hljs-comment">#!/usr/bin/python</span><br><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> request<br><span class="hljs-keyword">from</span> flask_restful <span class="hljs-keyword">import</span> reqparse, Resource<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Disk</span>(<span class="hljs-params">Resource</span>):</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get</span>(<span class="hljs-params">self, pool, img</span>):</span><br>        ret, rbd_info = DAO_query_rbd_info(pool, img)<br>        ...<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">post</span>(<span class="hljs-params">self, pool, img</span>):</span><br>        parser = reqparser.RequestParser()<br>        <span class="hljs-comment"># action: create\copy\clone</span><br>        parser.add_argument(<span class="hljs-string">'action'</span>, type=str)<br>        parser.add_argument(<span class="hljs-string">'src_pool'</span>, type=str)<br>        parser.add_argument(<span class="hljs-string">'src_rbd'</span>, type=str)<br>        parser.add_argument(<span class="hljs-string">'src_snap'</span>, type=str)<br>        parser.add_argument(<span class="hljs-string">'size'</span>, type=str)<br>        parser.add_argument(<span class="hljs-string">'unit'</span>, type=str)<br>        <br>        action = args.get(<span class="hljs-string">'action'</span>)<br>        <span class="hljs-keyword">if</span> action == <span class="hljs-string">"create"</span>:<br>            size = args.get(<span class="hljs-string">'size'</span>)<br>            unit = args.get(<span class="hljs-string">'unit'</span>)<br>            ...<br>        <span class="hljs-keyword">elif</span> action == <span class="hljs-string">'copy'</span>:<br>            src_pool = args.get(<span class="hljs-string">'src_pool'</span>)<br>            src_rbd = args.get(<span class="hljs-string">'src_rbd'</span>)<br>            ...<br>        <span class="hljs-keyword">else</span><br>            <span class="hljs-keyword">return</span> ...<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">delete</span>(<span class="hljs-params">self, pool, img</span>):</span><br>        ...<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">put</span>(<span class="hljs-params">self, pool, img</span>):</span><br>        parser = reqparser.RequestParser()<br>        parser.add_argument(<span class="hljs-string">'rb_snap'</span>, type=str)<br>        parser.add_argument(<span class="hljs-string">'action'</span>, type=str)<br>        args = parser.parse_args()<br>        <br>        <span class="hljs-keyword">if</span> action == <span class="hljs-string">"flatten"</span>:<br>            ...<br>        <span class="hljs-keyword">elif</span> action == <span class="hljs-string">"rollback"</span>:<br>            snap = args.get(<span class="hljs-string">"rb_snap"</span>)<br>            ...<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> ...<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">patch</span>(<span class="hljs-params">self, pool, img</span>):</span><br>        parser = reqparse.RequestParser()<br>        parser.add_argument(<span class="hljs-string">"action"</span>, type=srt)<br>        parser.add_argument(<span class="hljs-string">"name"</span>, type=str)<br>        parser.add_argument(<span class="hljs-string">"size"</span>, type=float)<br>        parser.add_argument(<span class="hljs-string">"unit"</span>, type=str)<br>        args = parser.parse_args()<br>        action = args.get(<span class="hljs-string">'action'</span>)<br>        <span class="hljs-keyword">if</span> action == <span class="hljs-string">"resize"</span>:<br>            size = args.get(<span class="hljs-string">'size'</span>)<br>            unit = args.get(<span class="hljs-string">'unit'</span>)<br>            ....<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> ...<br></code></pre></td></tr></tbody></table></figure>
<p>在test_rbd_api.py中卫Disk类撰写单元测试</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre class=" language-hljs py"><span class="hljs-keyword">from</span> rbd_app <span class="hljs-keyword">import</span> app<br>        <br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestDisk</span>(<span class="hljs-params">uniitest.TestCase</span>):</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">setUp</span>(<span class="hljs-params">self</span>):</span><br>        self.disk = Disk()<br>        self.content_type = <span class="hljs-string">"application/json"</span><br>        ...<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">tearDown</span>(<span class="hljs-params">self</span>):</span><br>        self.disk = <span class="hljs-literal">None</span><br>        self.content_type = <span class="hljs-literal">None</span><br>        ...<br>    <br><span class="hljs-meta">    @mock.path.object(DAO_RBDMgr, "DAO_query_rbd_info")</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_get</span>(<span class="hljs-params">self, mock_DAO_query_rbd_info</span>):</span><br>        rbd_info = {<span class="hljs-string">"pool_name"</span>:<span class="hljs-string">"sqh"</span>, <span class="hljs-string">"parent"</span>:{}, <span class="hljs-string">"image_size"</span>:<span class="hljs-number">1073741824L</span>,...}<br>        mock_DAO_query_rbd_info.return_value = (RBD_COMMON.MONGO_SUCCESS, rbd_info)<br>        <br>        <span class="hljs-keyword">with</span> app.test_request_context(<span class="hljs-string">"/?pool_name=sqh&amp;image_name=sqh001"</span>):<br>            pool = request.args.get(<span class="hljs-string">'pool_name'</span>)<br>            img=request.args.get(<span class="hljs-string">'image_name'</span>)<br>            self.assertEqual(selff.disk.get(pool, img), RBD_COMMON.http_return(RBD_COMMON.MONGO_SUCCESS))<br>    <br>    <br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_post</span>(<span class="hljs-params">self</span>):</span><br>        pool = <span class="hljs-string">"sqh"</span><br>        img = <span class="hljs-string">"sqh001"</span><br>        path_url = <span class="hljs-string">"v1.0/pools/%s/disks%s"</span> % (pool, img)<br>        data = {<span class="hljs-string">"action"</span>:<span class="hljs-string">"create"</span>, <span class="hljs-string">"size"</span>:<span class="hljs-number">2</span>, <span class="hljs-string">"unit"</span>:<span class="hljs-string">"GB"</span>}<br>        <span class="hljs-keyword">with</span> app.test_request_context(path_url, data=json.dumps(data), content_type=self.content_type):<br>            self.assertEqual(self.disk.post(pool, img), RBD_COMMON.http_return(RBD_COMMON.CODE_EXEC_SUCCESS_GET))<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_delete</span>(<span class="hljs-params">self</span>):</span><br>        pool = <span class="hljs-string">"sqh"</span><br>        img = <span class="hljs-string">"sqh001"</span><br>        path_url = <span class="hljs-string">"v1.0/pools/%s/disks%s"</span> % (pool, img)<br>        <span class="hljs-keyword">with</span> app.test_request_context(path_url):<br>            self.assertEqual(self.disk.delete(pool, img), RBD_COMMON.http_return(RBD_COMMON.CODE_EXEC_SUCCESS_DELETE))<br>            <br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_put</span>(<span class="hljs-params">self</span>):</span><br>        pool = <span class="hljs-string">"sqh"</span><br>        img = <span class="hljs-string">"sqh001"</span><br>        path_url = <span class="hljs-string">"v1.0/pools/%s/disks%s"</span> % (pool, img)<br>        data = {<span class="hljs-string">"action"</span>:<span class="hljs-string">"rollback"</span>, <span class="hljs-string">"rb_snap"</span>:<span class="hljs-string">"sqh_snap"</span>}<br>        <span class="hljs-keyword">with</span> app.test_request_context(path_url, data=json.dumps(data), content_type=self.content_type):<br>            self.assertEqual(self.disk.put(pool, img), RBD_COMMON.http_return(RBD_COMMON.CODE_EXEC_SUCCESS_FLATTENING))<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_patch</span>(<span class="hljs-params">self</span>):</span><br>        pool = <span class="hljs-string">"sqh"</span><br>        img = <span class="hljs-string">"sqh001"</span><br>        path_url = <span class="hljs-string">'v1.0/pools/%s/disks/%s'</span> %　(pool, img)<br>        size = <span class="hljs-number">1073741824L</span><br>        data = {<span class="hljs-string">"action"</span>:<span class="hljs-string">"resize"</span>, <span class="hljs-string">"size"</span>:size, <span class="hljs-string">"unit"</span>:<span class="hljs-string">"GB"</span>}<br>        <span class="hljs-comment"># the action resize</span><br>        <span class="hljs-keyword"><code class="language-hljs py"><span class="hljs-keyword">from</span> rbd_app <span class="hljs-keyword">import</span> app<br>        <br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestDisk</span>(<span class="hljs-params">uniitest.TestCase</span>):</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">setUp</span>(<span class="hljs-params">self</span>):</span><br>        self.disk = Disk()<br>        self.content_type = <span class="hljs-string">"application/json"</span><br>        ...<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">tearDown</span>(<span class="hljs-params">self</span>):</span><br>        self.disk = <span class="hljs-literal">None</span><br>        self.content_type = <span class="hljs-literal">None</span><br>        ...<br>    <br><span class="hljs-meta">    @mock.path.object(DAO_RBDMgr, "DAO_query_rbd_info")</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_get</span>(<span class="hljs-params">self, mock_DAO_query_rbd_info</span>):</span><br>        rbd_info = {<span class="hljs-string">"pool_name"</span>:<span class="hljs-string">"sqh"</span>, <span class="hljs-string">"parent"</span>:{}, <span class="hljs-string">"image_size"</span>:<span class="hljs-number">1073741824L</span>,...}<br>        mock_DAO_query_rbd_info.return_value = (RBD_COMMON.MONGO_SUCCESS, rbd_info)<br>        <br>        <span class="hljs-keyword">with</span> app.test_request_context(<span class="hljs-string">"/?pool_name=sqh&amp;image_name=sqh001"</span>):<br>            pool = request.args.get(<span class="hljs-string">'pool_name'</span>)<br>            img=request.args.get(<span class="hljs-string">'image_name'</span>)<br>            self.assertEqual(selff.disk.get(pool, img), RBD_COMMON.http_return(RBD_COMMON.MONGO_SUCCESS))<br>    <br>    <br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_post</span>(<span class="hljs-params">self</span>):</span><br>        pool = <span class="hljs-string">"sqh"</span><br>        img = <span class="hljs-string">"sqh001"</span><br>        path_url = <span class="hljs-string">"v1.0/pools/%s/disks%s"</span> % (pool, img)<br>        data = {<span class="hljs-string">"action"</span>:<span class="hljs-string">"create"</span>, <span class="hljs-string">"size"</span>:<span class="hljs-number">2</span>, <span class="hljs-string">"unit"</span>:<span class="hljs-string">"GB"</span>}<br>        <span class="hljs-keyword">with</span> app.test_request_context(path_url, data=json.dumps(data), content_type=self.content_type):<br>            self.assertEqual(self.disk.post(pool, img), RBD_COMMON.http_return(RBD_COMMON.CODE_EXEC_SUCCESS_GET))<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_delete</span>(<span class="hljs-params">self</span>):</span><br>        pool = <span class="hljs-string">"sqh"</span><br>        img = <span class="hljs-string">"sqh001"</span><br>        path_url = <span class="hljs-string">"v1.0/pools/%s/disks%s"</span> % (pool, img)<br>        <span class="hljs-keyword">with</span> app.test_request_context(path_url):<br>            self.assertEqual(self.disk.delete(pool, img), RBD_COMMON.http_return(RBD_COMMON.CODE_EXEC_SUCCESS_DELETE))<br>            <br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_put</span>(<span class="hljs-params">self</span>):</span><br>        pool = <span class="hljs-string">"sqh"</span><br>        img = <span class="hljs-string">"sqh001"</span><br>        path_url = <span class="hljs-string">"v1.0/pools/%s/disks%s"</span> % (pool, img)<br>        data = {<span class="hljs-string">"action"</span>:<span class="hljs-string">"rollback"</span>, <span class="hljs-string">"rb_snap"</span>:<span class="hljs-string">"sqh_snap"</span>}<br>        <span class="hljs-keyword">with</span> app.test_request_context(path_url, data=json.dumps(data), content_type=self.content_type):<br>            self.assertEqual(self.disk.put(pool, img), RBD_COMMON.http_return(RBD_COMMON.CODE_EXEC_SUCCESS_FLATTENING))<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_patch</span>(<span class="hljs-params">self</span>):</span><br>        pool = <span class="hljs-string">"sqh"</span><br>        img = <span class="hljs-string">"sqh001"</span><br>        path_url = <span class="hljs-string">'v1.0/pools/%s/disks/%s'</span> %　(pool, img)<br>        size = <span class="hljs-number">1073741824L</span><br>        data = {<span class="hljs-string">"action"</span>:<span class="hljs-string">"resize"</span>, <span class="hljs-string">"size"</span>:size, <span class="hljs-string">"unit"</span>:<span class="hljs-string">"GB"</span>}<br>        <span class="hljs-comment"># the action resize</span><br>        <span class="hljs-keyword">with</span> app.test_request_context(path_url, data=json.dumps(data), content_type=self.content_type):<br>            self.assertEqual(self.disk.patch(pool, img), RBD_COMMON.http_return(RBD_COMMON.CODE_EXEC_SUCCESS_MODIFY))<br></code></pre></td></tr></tbody></table></figure>
<p>7.7.1 Get请求</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre class=" language-hljs py"><span class="hljs-meta">@mock.path.object(DAO_RBDMgr, "DAO_query_rbd_info")</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_get</span>(<span class="hljs-params">self, mock_DAO_query_rbd_info</span>):</span><br>        rbd_info = {<span class="hljs-string">"pool_name"</span>:<span class="hljs-string">"sqh"</span>, <span class="hljs-string">"parent"</span>:{}, <span class="hljs-string">"image_size"</span>:<span class="hljs-number">1073741824L</span>,...}<br>        mock_DAO_query_rbd_info.return_value = (RBD_COMMON.MONGO_SUCCESS, rbd_info)<br>        <br>        <span class="hljs-keyword">with</span> app.test_request_context(<span class="hljs-string">"/?pool_name=sqh&amp;image_name=sqh001"</span>):<br>            pool = request.args.get(<span class="hljs-string">'pool_name'</span>)<br>            img=request.args.get(<span class="hljs-string">'image_name'</span>)<br>            self.assertEqual(selff.disk.get(pool, img), RBD_COMMON.http_return(RBD_COMMON.MONGO_SUCCESS))<br>``<br><br>在为flask接口撰写单元测试时，最关键的是如何传递数据，<br>我们在setUp函数中初始化Disk类的实例,即self.disk。在传递参数的时候通过调用app.test_request_context(“url”)。因为是restful的get请求，因而我们可以使用？param1=val1&amp;param2=val2的形式。<br><br><span class="hljs-number">7.7</span><span class="hljs-number">.2</span> Post请求<br>在Post请求，我们需要传递动作的类型，即其他参数，在app.test_request_context函数中，传递了字符串url， data字典，HTTP请求头信息。<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_post</span>(<span class="hljs-params">self</span>):</span><br>        pool = <span class="hljs-string">"sqh"</span><br>        img = <span class="hljs-string">"sqh001"</span><br>        path_url = <span class="hljs-string">"v1.0/pools/%s/disks%s"</span> % (pool, img)<br>        data = {<span class="hljs-string">"action"</span>:<span class="hljs-string">"create"</span>, <span class="hljs-string">"size"</span>:<span class="hljs-number">2</span>, <span class="hljs-string">"unit"</span>:<span class="hljs-string">"GB"</span>}<br>        <span class="hljs-keyword">with</span> app.test_request_context(path_url, data=json.dumps(data), content_type=self.content_type):<br>            self.assertEqual(self.disk.post(pool, img), RBD_COMMON.http_return(RBD_COMMON.CODE_EXEC_SUCCESS_GET))<br><br><span class="hljs-number">7.7</span><span class="hljs-number">.3</span> Delete请求<br>如post<br><br><span class="hljs-number">7.7</span><span class="hljs-number">.4</span> Put请求<br>如post<br><br><span class="hljs-number">7.7</span><span class="hljs-number">.5</span> Patch请求<br>如post<br><br><span class="hljs-number">8.</span> Python 单元测试环境安装<br>因为在python2.*中，mock是单独的模块，因而我们需要单独安装mock模块才能够正常的使用。<br>因此，我们首先要在rpm find 网站下载好pip，然后通过pip安装mock。<br><br>http://rpmfind.net/linux/RPM/epel/<span class="hljs-number">7</span>/x86_64/Packages/p/python2-pip<span class="hljs-number">-8.1</span><span class="hljs-number">.2</span><span class="hljs-number">-5.</span>el7.noarch.html<br>依赖于python-setuptools<br><br>http://rpmfind.net/linux/RPM/centos/<span class="hljs-number">7.4</span><span class="hljs-number">.1708</span>/x86_64/Packages/python-setuptools<span class="hljs-number">-0.9</span><span class="hljs-number">.8</span><span class="hljs-number">-7.</span>el7.noarch.html<br><br>mock的下载网址：<br><br>https://pypi.python.org/pypi/mock/<span class="hljs-number">2.0</span><span class="hljs-number">.0</span><br><br>下一章节要用的coverage，测试代码覆盖率，网址在：<br><br>https://pypi.python.org/pypi/coverage/<span class="hljs-number">4.5</span><span class="hljs-number">.1</span><br><br><span class="hljs-number">9.</span> 使用coverage测试覆盖率<br>在单元测试的过程中，应尽量使得单元都被覆盖过，因而需要使用专门的工具来进行测试代码覆盖率。以test_rbd_api.py为准<br>测试的步骤如下：<br>```py<br><span class="hljs-meta"><code class="language-hljs py"><span class="hljs-meta">@mock.path.object(DAO_RBDMgr, "DAO_query_rbd_info")</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_get</span>(<span class="hljs-params">self, mock_DAO_query_rbd_info</span>):</span><br>        rbd_info = {<span class="hljs-string">"pool_name"</span>:<span class="hljs-string">"sqh"</span>, <span class="hljs-string">"parent"</span>:{}, <span class="hljs-string">"image_size"</span>:<span class="hljs-number">1073741824L</span>,...}<br>        mock_DAO_query_rbd_info.return_value = (RBD_COMMON.MONGO_SUCCESS, rbd_info)<br>        <br>        <span class="hljs-keyword">with</span> app.test_request_context(<span class="hljs-string">"/?pool_name=sqh&amp;image_name=sqh001"</span>):<br>            pool = request.args.get(<span class="hljs-string">'pool_name'</span>)<br>            img=request.args.get(<span class="hljs-string">'image_name'</span>)<br>            self.assertEqual(selff.disk.get(pool, img), RBD_COMMON.http_return(RBD_COMMON.MONGO_SUCCESS))<br>``<br><br>在为flask接口撰写单元测试时，最关键的是如何传递数据，<br>我们在setUp函数中初始化Disk类的实例,即self.disk。在传递参数的时候通过调用app.test_request_context(“url”)。因为是restful的get请求，因而我们可以使用？param1=val1&amp;param2=val2的形式。<br><br><span class="hljs-number">7.7</span><span class="hljs-number">.2</span> Post请求<br>在Post请求，我们需要传递动作的类型，即其他参数，在app.test_request_context函数中，传递了字符串url， data字典，HTTP请求头信息。<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_post</span>(<span class="hljs-params">self</span>):</span><br>        pool = <span class="hljs-string">"sqh"</span><br>        img = <span class="hljs-string">"sqh001"</span><br>        path_url = <span class="hljs-string">"v1.0/pools/%s/disks%s"</span> % (pool, img)<br>        data = {<span class="hljs-string">"action"</span>:<span class="hljs-string">"create"</span>, <span class="hljs-string">"size"</span>:<span class="hljs-number">2</span>, <span class="hljs-string">"unit"</span>:<span class="hljs-string">"GB"</span>}<br>        <span class="hljs-keyword">with</span> app.test_request_context(path_url, data=json.dumps(data), content_type=self.content_type):<br>            self.assertEqual(self.disk.post(pool, img), RBD_COMMON.http_return(RBD_COMMON.CODE_EXEC_SUCCESS_GET))<br><br><span class="hljs-number">7.7</span><span class="hljs-number">.3</span> Delete请求<br>如post<br><br><span class="hljs-number">7.7</span><span class="hljs-number">.4</span> Put请求<br>如post<br><br><span class="hljs-number">7.7</span><span class="hljs-number">.5</span> Patch请求<br>如post<br><br><span class="hljs-number">8.</span> Python 单元测试环境安装<br>因为在python2.*中，mock是单独的模块，因而我们需要单独安装mock模块才能够正常的使用。<br>因此，我们首先要在rpm find 网站下载好pip，然后通过pip安装mock。<br><br>http://rpmfind.net/linux/RPM/epel/<span class="hljs-number">7</span>/x86_64/Packages/p/python2-pip<span class="hljs-number">-8.1</span><span class="hljs-number">.2</span><span class="hljs-number">-5.</span>el7.noarch.html<br>依赖于python-setuptools<br><br>http://rpmfind.net/linux/RPM/centos/<span class="hljs-number">7.4</span><span class="hljs-number">.1708</span>/x86_64/Packages/python-setuptools<span class="hljs-number">-0.9</span><span class="hljs-number">.8</span><span class="hljs-number">-7.</span>el7.noarch.html<br><br>mock的下载网址：<br><br>https://pypi.python.org/pypi/mock/<span class="hljs-number">2.0</span><span class="hljs-number">.0</span><br><br>下一章节要用的coverage，测试代码覆盖率，网址在：<br><br>https://pypi.python.org/pypi/coverage/<span class="hljs-number">4.5</span><span class="hljs-number">.1</span><br><br><span class="hljs-number">9.</span> 使用coverage测试覆盖率<br>在单元测试的过程中，应尽量使得单元都被覆盖过，因而需要使用专门的工具来进行测试代码覆盖率。以test_rbd_api.py为准<br>测试的步骤如下：<br>```py<br><span class="hljs-meta">>>> </span>coverage run test_rbd_api.py<br>>>>coverage report -m path/to/rbd_api.py<br></code></pre></td></tr></tbody></table></figure>
<p>即可查看代码覆盖程度。</p>
<p>很多时候开发人员和其他系统联调时，如果关联系统还没有开发完成，这时只能使用mock来模拟关联系统的返回<br>自动化测试也常常遇到同样的问题，为了验证关联系统不同的返回对被测对象的影响，需要mock关联系统的返回<br>一个例子</p>
<ul>
<li>被测对象从关联接口获得用户信息</li>
<li>在关联接口开发完成之前，只能使用mock来模拟关联接口的返回，完成对被测对象的测试</li>
</ul>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre class=" language-hljs py"><span class="hljs-keyword">import</span> unittest<br><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">from</span> unittest <span class="hljs-keyword">import</span> TestCase<br><span class="hljs-keyword">from</span> unittest.mock <span class="hljs-keyword">import</span> patch<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span>(<span class="hljs-params">object</span>):</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_user_info</span>(<span class="hljs-params">uid</span>):</span><br>        resp = requests.get(<span class="hljs-string">"http://api.server.com/user/{0}"</span>.format(uid))<br>        <span class="hljs-keyword">return</span> resp.json()<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestUserInfo</span>(<span class="hljs-params">TestCase</span>):</span><br><span class="hljs-meta">    @patch('__main__.User')</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_user_name</span>(<span class="hljs-params">self, MockUser</span>):</span><br>        user = MockUser()<br>        user.get_user_info.return_value = {<br>            <span class="hljs-string">"user_id"</span>: <span class="hljs-number">1</span>,<br>            <span class="hljs-string">"name"</span>: <span class="hljs-string">"python"</span>,<br>            <span class="hljs-string">"age"</span>: <span class="hljs-number">20</span><br>        }<br>        resp = user.get_user_info(<span class="hljs-number">1</span>)<br>        self.assertEqual(resp.get(<span class="hljs-string">"name"</span>), <span class="hljs-string">"python"</span>)<br>        self.assertEqual(resp.get(<span class="hljs-string">"age"</span>), <span class="hljs-number">20</span>)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<br>    unittest.main()<br><span class="hljs-comment"># ----------------------------------------------------------------------</span><br><span class="hljs-comment"># Ran 1 test in 0.001s</span><br><br><span class="hljs-comment"><code class="language-hljs py"><span class="hljs-keyword">import</span> unittest<br><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">from</span> unittest <span class="hljs-keyword">import</span> TestCase<br><span class="hljs-keyword">from</span> unittest.mock <span class="hljs-keyword">import</span> patch<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span>(<span class="hljs-params">object</span>):</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_user_info</span>(<span class="hljs-params">uid</span>):</span><br>        resp = requests.get(<span class="hljs-string">"http://api.server.com/user/{0}"</span>.format(uid))<br>        <span class="hljs-keyword">return</span> resp.json()<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestUserInfo</span>(<span class="hljs-params">TestCase</span>):</span><br><span class="hljs-meta">    @patch('__main__.User')</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_user_name</span>(<span class="hljs-params">self, MockUser</span>):</span><br>        user = MockUser()<br>        user.get_user_info.return_value = {<br>            <span class="hljs-string">"user_id"</span>: <span class="hljs-number">1</span>,<br>            <span class="hljs-string">"name"</span>: <span class="hljs-string">"python"</span>,<br>            <span class="hljs-string">"age"</span>: <span class="hljs-number">20</span><br>        }<br>        resp = user.get_user_info(<span class="hljs-number">1</span>)<br>        self.assertEqual(resp.get(<span class="hljs-string">"name"</span>), <span class="hljs-string">"python"</span>)<br>        self.assertEqual(resp.get(<span class="hljs-string">"age"</span>), <span class="hljs-number">20</span>)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<br>    unittest.main()<br><span class="hljs-comment"># ----------------------------------------------------------------------</span><br><span class="hljs-comment"># Ran 1 test in 0.001s</span><br><br><span class="hljs-comment"># OK</span><br></code></pre></td></tr></tbody></table></figure>


<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre class=" language-hljs py"><span class="hljs-keyword">import</span> unittest<br><span class="hljs-keyword">from</span> unittest.mock <span class="hljs-keyword">import</span> MagicMock<br><br><br><span class="hljs-comment"># 将要测试的排序函数</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">sort</span>(<span class="hljs-params">arr</span>):</span><br>    l = len(arr)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">0</span>, l):<br>        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> range(i + <span class="hljs-number">1</span>, l):<br>            <span class="hljs-keyword">if</span> arr[i] &gt;= arr[j]:<br>                tmp = arr[i]<br>                arr[i] = arr[j]<br>                arr[j] = tmp<br><br><br><span class="hljs-comment"># 单元测试</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestSort</span>(<span class="hljs-params">unittest.TestCase</span>):</span><br>    <span class="hljs-comment"># 以test开头的函数会被测试</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_sort</span>(<span class="hljs-params">self</span>):</span><br>        arr = [<span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">1</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>]<br>        sort(arr)<br>        self.assertEqual(arr, [<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>])<br><br><br><span class="hljs-comment"># mock</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span>(<span class="hljs-params">unittest.TestCase</span>):</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">m1</span>(<span class="hljs-params">self</span>):</span><br>        val = self.m2()<br>        self.m3(val)<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">m2</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-keyword">pass</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">m3</span>(<span class="hljs-params">self, val</span>):</span><br>        <span class="hljs-keyword">pass</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_m1</span>(<span class="hljs-params">self</span>):</span><br>        a = A()<br>        a.m2 = MagicMock(return_value=<span class="hljs-string">"custom_val"</span>)<br>        a.m3 = MagicMock()<br>        a.m1()<br>        self.assertTrue(a.m2.called)<br>        a.m3.assert_called_with(<span class="hljs-string">"custom_val"</span>)<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">side_effect</span>(<span class="hljs-params">arg</span>):</span><br>    <span class="hljs-keyword">if</span> arg &lt; <span class="hljs-number">0</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">2</span><br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:<br>    unittest.main()<br>    mock = MagicMock()<br>    mock.side_effect = side_effect<br>    print(mock(<span class="hljs-number">1</span>))<br>    print(mock(<span class="hljs-number"><code class="language-hljs py"><span class="hljs-keyword">import</span> unittest<br><span class="hljs-keyword">from</span> unittest.mock <span class="hljs-keyword">import</span> MagicMock<br><br><br><span class="hljs-comment"># 将要测试的排序函数</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">sort</span>(<span class="hljs-params">arr</span>):</span><br>    l = len(arr)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">0</span>, l):<br>        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> range(i + <span class="hljs-number">1</span>, l):<br>            <span class="hljs-keyword">if</span> arr[i] &gt;= arr[j]:<br>                tmp = arr[i]<br>                arr[i] = arr[j]<br>                arr[j] = tmp<br><br><br><span class="hljs-comment"># 单元测试</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestSort</span>(<span class="hljs-params">unittest.TestCase</span>):</span><br>    <span class="hljs-comment"># 以test开头的函数会被测试</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_sort</span>(<span class="hljs-params">self</span>):</span><br>        arr = [<span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">1</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>]<br>        sort(arr)<br>        self.assertEqual(arr, [<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>])<br><br><br><span class="hljs-comment"># mock</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span>(<span class="hljs-params">unittest.TestCase</span>):</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">m1</span>(<span class="hljs-params">self</span>):</span><br>        val = self.m2()<br>        self.m3(val)<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">m2</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-keyword">pass</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">m3</span>(<span class="hljs-params">self, val</span>):</span><br>        <span class="hljs-keyword">pass</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_m1</span>(<span class="hljs-params">self</span>):</span><br>        a = A()<br>        a.m2 = MagicMock(return_value=<span class="hljs-string">"custom_val"</span>)<br>        a.m3 = MagicMock()<br>        a.m1()<br>        self.assertTrue(a.m2.called)<br>        a.m3.assert_called_with(<span class="hljs-string">"custom_val"</span>)<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">side_effect</span>(<span class="hljs-params">arg</span>):</span><br>    <span class="hljs-keyword">if</span> arg &lt; <span class="hljs-number">0</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">2</span><br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:<br>    unittest.main()<br>    mock = MagicMock()<br>    mock.side_effect = side_effect<br>    print(mock(<span class="hljs-number">1</span>))<br>    print(mock(<span class="hljs-number">-2</span>))<br></code></pre></td></tr></tbody></table></figure>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
  </div>
  <div>
  
  <div class="post-note note-warning copyright" style="margin-top: 42px">
    <p><span style="font-weight: bold;">作者：</span><a target="_blank" rel="nofollow noopener noreferrer" href="https://bubbleboy11.github.io/about">外心人D</a></p>
    <p><span style="font-weight: bold;">文章链接：</span><a target="_blank" rel="nofollow noopener noreferrer" href="https://bubbleboy11.github.io/2020/08/21/mock/">https://bubbleboy11.github.io/2020/08/21/mock/</a></p>
    <p><span style="font-weight: bold;">版权声明：</span>本博客所有文章除特别声明外，均采用<a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">CC BY-NC-SA 4.0 协议</a>。转载请注明出处！</p>
  </div>
  
  </div>
</article>
<div class="nav">
  
  <div class="nav-item-prev">
    <a href="/2020/08/21/linux/" class="nav-link">
      <i class="iconfont icon-left nav-prev-icon"></i>
      <div>
        <div class="nav-label">上一篇</div>
        
        <div class="nav-title">linux </div>
        
      </div>
    </a>
  </div>
  
  
  <div class="nav-item-next">
    <a href="/2020/08/21/sql/" class="nav-link">
      <div>
        <div class="nav-label">下一篇</div>
        
        <div class="nav-title">HTML </div>
        
      </div>
      <i class="iconfont icon-right nav-next-icon"></i>
    </a>
  </div>
  
</div>

<div class="card card-content toc-card" id="mobiletoc">
  <div class="toc-header"><i class="iconfont icon-menu" style="padding-right: 2px;"></i>目录</div>

</div></main>
          <aside class="left-column">
            
            <div class="card card-author">
              
<img src="/img/author_img.png" class="author-img">

<p class="author-name">外心人D</p>
<p class="author-description">passion & patient</p>
<div class="author-message">
  <a class="author-posts-count" href="/archives">
    <span>165</span>
    <span>文章</span>
  </a>
  <a class="author-categories-count" href="/categories">
    <span>17</span>
    <span>分类</span>
  </a>
  <a class="author-tags-count" href="/tags">
    <span>25</span>
    <span>标签</span>
  </a>
</div>

<div class="author-card-society">
  
    <div class="author-card-society-icon">
      <a target="_blank" rel="noopener" href="https://www.baidu.com">
        <i class="iconfont icon-github society-icon"></i>
      </a>
    </div>
  
    <div class="author-card-society-icon">
      <a target="_blank" rel="noopener" href="https://www.baidu.com">
        <i class="iconfont icon-bilibili society-icon"></i>
      </a>
    </div>
  
    <div class="author-card-society-icon">
      <a target="_blank" rel="noopener" href="https://www.baidu.com">
        <i class="iconfont icon-stackflow society-icon"></i>
      </a>
    </div>
  
</div>

            </div>
            
            <div class="sticky-tablet">
  
  
  <article class="display-when-two-columns spacer">
    <div class="card card-content toc-card">
      <div class="toc-header"><i class="iconfont icon-menu" style="padding-right: 2px;"></i>目录</div>

    </div>
  </article>
  
  
  <article class="card card-content categories-widget">
    <div class="categories-card">
  <div class="categories-header"><i class="iconfont icon-fenlei" style="padding-right: 2px;"></i>分类</div>
  <div class="categories-list">
    
      <a href="/categories/旅游网项目/">
        <div class="categories-list-item">
          旅游网项目
          <span class="categories-list-item-badge">26</span>
        </div>
      </a>
    
      <a href="/categories/django/">
        <div class="categories-list-item">
          django
          <span class="categories-list-item-badge">8</span>
        </div>
      </a>
    
      <a href="/categories/python/">
        <div class="categories-list-item">
          python
          <span class="categories-list-item-badge">38</span>
        </div>
      </a>
    
      <a href="/categories/Markdown/">
        <div class="categories-list-item">
          Markdown
          <span class="categories-list-item-badge">63</span>
        </div>
      </a>
    
      <a href="/categories/计算机网络/">
        <div class="categories-list-item">
          计算机网络
          <span class="categories-list-item-badge">3</span>
        </div>
      </a>
    
      <a href="/categories/web/">
        <div class="categories-list-item">
          web
          <span class="categories-list-item-badge">2</span>
        </div>
      </a>
    
      <a href="/categories/测试/">
        <div class="categories-list-item">
          测试
          <span class="categories-list-item-badge">2</span>
        </div>
      </a>
    
      <a href="/categories/docker/">
        <div class="categories-list-item">
          docker
          <span class="categories-list-item-badge">1</span>
        </div>
      </a>
    
      <a href="/categories/hexo/">
        <div class="categories-list-item">
          hexo
          <span class="categories-list-item-badge">1</span>
        </div>
      </a>
    
      <a href="/categories/java/">
        <div class="categories-list-item">
          java
          <span class="categories-list-item-badge">2</span>
        </div>
      </a>
    
      <a href="/categories/数据库/">
        <div class="categories-list-item">
          数据库
          <span class="categories-list-item-badge">2</span>
        </div>
      </a>
    
      <a href="/categories/markdown/">
        <div class="categories-list-item">
          markdown
          <span class="categories-list-item-badge">1</span>
        </div>
      </a>
    
      <a href="/categories/数据结构与算法/">
        <div class="categories-list-item">
          数据结构与算法
          <span class="categories-list-item-badge">10</span>
        </div>
      </a>
    
      <a href="/categories/面试/">
        <div class="categories-list-item">
          面试
          <span class="categories-list-item-badge">1</span>
        </div>
      </a>
    
      <a href="/categories/vue/">
        <div class="categories-list-item">
          vue
          <span class="categories-list-item-badge">1</span>
        </div>
      </a>
    
      <a href="/categories/linux/">
        <div class="categories-list-item">
          linux
          <span class="categories-list-item-badge">1</span>
        </div>
      </a>
    
      <a href="/categories/前端/">
        <div class="categories-list-item">
          前端
          <span class="categories-list-item-badge">1</span>
        </div>
      </a>
    
  </div>
</div>
  </article>
  
  <article class="card card-content tags-widget">
    <div class="tags-card">
  <div class="tags-header"><i class="iconfont icon-biaoqian" style="padding-right: 2px;"></i>热门标签</div>
  <div class="tags-list">
    
    <a href="/tags/剑指offer/" title="剑指offer"><div class="tags-list-item">剑指offer</div></a>
    
    <a href="/tags/Leetcode/" title="Leetcode"><div class="tags-list-item">Leetcode</div></a>
    
    <a href="/tags/django/" title="django"><div class="tags-list-item">django</div></a>
    
    <a href="/tags/Vue/" title="Vue"><div class="tags-list-item">Vue</div></a>
    
    <a href="/tags/python/" title="python"><div class="tags-list-item">python</div></a>
    
    <a href="/tags/测试/" title="测试"><div class="tags-list-item">测试</div></a>
    
    <a href="/tags/redis/" title="redis"><div class="tags-list-item">redis</div></a>
    
    <a href="/tags/排序/" title="排序"><div class="tags-list-item">排序</div></a>
    
    <a href="/tags/sql/" title="sql"><div class="tags-list-item">sql</div></a>
    
    <a href="/tags/前端/" title="前端"><div class="tags-list-item">前端</div></a>
    
    <a href="/tags/linux/" title="linux"><div class="tags-list-item">linux</div></a>
    
    <a href="/tags/数据结构和算法/" title="数据结构和算法"><div class="tags-list-item">数据结构和算法</div></a>
    
    <a href="/tags/Unicode/" title="Unicode"><div class="tags-list-item">Unicode</div></a>
    
    <a href="/tags/ASCII/" title="ASCII"><div class="tags-list-item">ASCII</div></a>
    
    <a href="/tags/编码/" title="编码"><div class="tags-list-item">编码</div></a>
    
    <a href="/tags/vue/" title="vue"><div class="tags-list-item">vue</div></a>
    
  </div>
</div>
  </article>
  
  
</div>
          </aside>
          <aside class="right-column">
            <div class="sticky-widescreen">
  
  
  <article class="card card-content toc-card">
    <div class="toc-header"><i class="iconfont icon-menu" style="padding-right: 2px;"></i>目录</div>

  </article>
  
  
  <article class="card card-content">
    <div class="recent-posts-card">
  <div class="recent-posts-header"><i class="iconfont icon-wenzhang_huaban" style="padding-right: 2px;"></i>最近文章</div>
  <div class="recent-posts-list">
    
      <div class="recent-posts-item">
        <div class="recent-posts-item-title">2021-04-02</div>
        <a href="/2021/04/03/admin-de-yi-xie-you-hua-pei-zhi/"><div class="recent-posts-item-content">admin的一些优化配置</div></a>
      </div>
    
      <div class="recent-posts-item">
        <div class="recent-posts-item-title">2021-04-02</div>
        <a href="/2021/04/02/django-hou-tai-guan-li/"><div class="recent-posts-item-content">Django后台管理</div></a>
      </div>
    
      <div class="recent-posts-item">
        <div class="recent-posts-item-title">2021-04-01</div>
        <a href="/2021/04/02/lu-you-wang-shan-chu-ding-dan-jie-kou-lian-diao/"><div class="recent-posts-item-content">旅游网删除订单接口联调</div></a>
      </div>
    
      <div class="recent-posts-item">
        <div class="recent-posts-item-title">2021-04-01</div>
        <a href="/2021/04/02/lu-you-wang-qu-xiao-ding-dan-jie-kou-lian-diao/"><div class="recent-posts-item-content">旅游网取消订单接口联调</div></a>
      </div>
    
  </div>
</div>
  </article>
  
  
</div>
          </aside>
        </div>
      </div>
    </div>
  </div>
  
  <footer class="footer">
  <div class="footer-container">
    <div>
      <div class="footer-dsc">
        <span>Copyright ©
          
          2021 -
          
          2021
        </span>
        &nbsp;
        <a href="/" class="footer-link">外心人D </a>
      </div>
    </div>

    
    <div class="footer-dsc">
      
      Powered by
      <a href="https://hexo.io/" class="footer-link" target="_blank" rel="nofollow noopener noreferrer">&nbsp;Hexo </a>
      
      
      <span>&nbsp;|&nbsp;</span>
      
      
      Theme -
      <a href="https://github.com/theme-kaze" class="footer-link" target="_blank"
        rel="nofollow noopener noreferrer">&nbsp;Kaze</a>
      
    </div>
    
    
    
    
</footer>
  <a role="button" id="scrollbutton" class="basebutton"  aria-label="回到顶部">
  <i class="iconfont icon-arrowleft button-icon"></i>
</a>
<a role="button" id="menubutton" class="basebutton">
  <i class="iconfont icon-menu button-icon"></i>
</a>
<a role="button" id="popbutton" class="basebutton" aria-label="控制中心">
  <i class="iconfont icon-expand button-icon"></i>
</a>
<a role="button" id="darkbutton" class="basebutton darkwidget" aria-label="夜色模式">
  <i class="iconfont icon-weather button-icon"></i>
</a>
<a role="button" id="searchbutton" class="basebutton searchwidget" aria-label="搜索">
  <i class="iconfont icon-search button-icon"></i>
</a>

  
  
  

  
  
  <script>
  var addImgLayout = function () {
    var img = document.querySelectorAll('.post-content img');
    var i;
    for (i = 0; i < img.length; i++) {
      var wrapper = document.createElement('a');
      wrapper.setAttribute('href', img[i].getAttribute('data-src'));
      wrapper.setAttribute('aria-label', 'illustration');
      wrapper.style.cssText = 'width: 100%; display: flex; justify-content: center;';
      if (img[i].alt) wrapper.dataset.caption = img[i].alt;
      wrapper.dataset.nolink = true;
      img[i].before(wrapper);
      wrapper.append(img[i]);
      var divWrap = document.createElement('div');
      divWrap.classList.add('gallery');
      wrapper.before(divWrap);
      divWrap.append(wrapper);
    }
    baguetteBox.run('.gallery');
  }
</script>
<script>loadScript("/js/lib/lightbox/baguetteBox.min.js", addImgLayout)</script>
  
  
  
<script src="/js/main.js"></script>

  
  
  <script>
    var addLazyload = function () {
      var observer = lozad('.lozad', {
        load: function (el) {
          el.srcset = el.getAttribute('data-src');
        },
        loaded: function (el) {
          el.classList.add('loaded');
        }
      });
      observer.observe();
    }
  </script>
  <script>loadScript("/js/lib/lozad.min.js", addLazyload)</script>
  
  
</body>

</html>