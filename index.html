<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.0.2">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<meta name="hexo-config" content="{&quot;hostname&quot;:&quot;bubbleboy11.github.io&quot;,&quot;root&quot;:&quot;/&quot;,&quot;images&quot;:&quot;/images&quot;,&quot;scheme&quot;:&quot;Muse&quot;,&quot;version&quot;:&quot;8.3.0&quot;,&quot;exturl&quot;:false,&quot;sidebar&quot;:{&quot;position&quot;:&quot;left&quot;,&quot;display&quot;:&quot;post&quot;,&quot;padding&quot;:18,&quot;offset&quot;:12},&quot;copycode&quot;:true,&quot;bookmark&quot;:{&quot;enable&quot;:false,&quot;color&quot;:&quot;#222&quot;,&quot;save&quot;:&quot;auto&quot;},&quot;fancybox&quot;:false,&quot;mediumzoom&quot;:false,&quot;lazyload&quot;:false,&quot;pangu&quot;:false,&quot;comments&quot;:{&quot;style&quot;:&quot;tabs&quot;,&quot;active&quot;:null,&quot;storage&quot;:true,&quot;lazyload&quot;:false,&quot;nav&quot;:null},&quot;motion&quot;:{&quot;enable&quot;:true,&quot;async&quot;:false,&quot;transition&quot;:{&quot;post_block&quot;:&quot;fadeIn&quot;,&quot;post_header&quot;:&quot;fadeInDown&quot;,&quot;post_body&quot;:&quot;fadeInDown&quot;,&quot;coll_header&quot;:&quot;fadeInLeft&quot;,&quot;sidebar&quot;:&quot;fadeInUp&quot;}},&quot;prism&quot;:false,&quot;i18n&quot;:{&quot;placeholder&quot;:&quot;搜索...&quot;,&quot;empty&quot;:&quot;没有找到任何搜索结果：${query}&quot;,&quot;hits_time&quot;:&quot;找到 ${hits} 个搜索结果（用时 ${time} 毫秒）&quot;,&quot;hits&quot;:&quot;找到 ${hits} 个搜索结果&quot;}}">
<meta name="description" content="本博客大多内容为慕课和网上博客，并非原创">
<meta property="og:type" content="website">
<meta property="og:title" content="外心人D的博客">
<meta property="og:url" content="https://bubbleboy11.github.io/index.html">
<meta property="og:site_name" content="外心人D的博客">
<meta property="og:description" content="本博客大多内容为慕课和网上博客，并非原创">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="外心人D">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://bubbleboy11.github.io/">



<meta name="hexo-config-page" content="{&quot;sidebar&quot;:&quot;&quot;,&quot;isHome&quot;:true,&quot;isPost&quot;:false,&quot;lang&quot;:&quot;zh-CN&quot;}">
<meta name="hexo-config-calendar" content="">
<script data-pjax src="/js/load-config.js"></script>
  <title>外心人D的博客</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="外心人D的博客" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism.css" type="text/css"></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">外心人D的博客</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">外心人D</p>
  <div class="site-description" itemprop="description">本博客大多内容为慕课和网上博客，并非原创</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">267</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">24</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">40</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/06/07/beego-de-orm/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/06/07/beego-de-orm/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-06-07 14:41:26" itemprop="dateCreated datePublished" datetime="2021-06-07T14:41:26Z">2021-06-07</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-06-08 07:09:42" itemprop="dateModified" datetime="2021-06-08T07:09:42Z">2021-06-08</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="orm"><a href="#orm" class="headerlink" title="orm"></a>orm</h3><p>在关系型数据库和对象之间作一个映射，在操作数据库时，不需要写复杂的SQL语句，只需要像操作对象一样。</p>
<p>ORM对象被设计为无状态的，因而天然是线程安全的。<br>建议在使用过程中，一个数据库应该只存在一个ORM对象。</p>
<p><code>conf/app.conf</code></p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">appname = demo</span><br><span class="line">httpport = 8080</span><br><span class="line">runmode = dev</span><br><span class="line"></span><br><span class="line">[dev]</span><br><span class="line">defaultdb = root:156277@(127.0.0.1:3306)/fyouku?charset=utf8</span><br><span class="line">redisdb = 127.0.0.1:6379</span><br><span class="line">rabbitmq = amqp://guest:guest@127.0.0.1:5672/</span><br><span class="line"></span><br><span class="line">[prod]</span><br><span class="line">defaultdb = root:156277@(127.0.0.1:3306)/fyouku?charset=utf8</span><br><span class="line">redisdb = 127.0.0.1:6379</span><br><span class="line">rabbitmq = amqp://guest:guest@127.0.0.1:5672/</span><br></pre></td></tr></tbody></table></figure>

<p>错误<code>missing go.sum entry for module providing package</code><br>解决 <code>go mod tidy</code> will also add requirements sums needed by all packages in the main module. It will also remove requirements and sums that aren’t needed anymore.移除未使用的依赖</p>
<h3 id="配置数据库信息，加载信息"><a href="#配置数据库信息，加载信息" class="headerlink" title="配置数据库信息，加载信息"></a>配置数据库信息，加载信息</h3><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    _ <span class="string">"demo/routers"</span></span><br><span class="line">    <span class="comment">// 引入orm</span></span><br><span class="line">    <span class="string">"github.com/beego/beego/v2/client/orm"</span></span><br><span class="line">    <span class="string">"github.com/beego/beego/v2/server/web"</span></span><br><span class="line">    _ <span class="string">"github.com/go-sql-driver/mysql"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="comment">//获取配置文件中信息</span></span><br><span class="line">    <span class="comment">//defaultdb := web.AppConfig.String("defaultdb")</span></span><br><span class="line">    <span class="comment">//defaultdb := web.AppConfig.String("root:123456@(127.0.0.1:3306)/fyouku?charset=utf8")</span></span><br><span class="line">    orm.RegisterDriver(<span class="string">"mysql"</span>, orm.DRMySQL)</span><br><span class="line">    <span class="comment">//orm.RegisterDataBase("default", "mysql", defaultdb)</span></span><br><span class="line">    <span class="comment">// ORM 必须注册一个别名为 default 的数据库，作为默认使用</span></span><br><span class="line">    orm.RegisterDataBase(<span class="string">"default"</span>, <span class="string">"mysql"</span>, <span class="string">"root:156277@(127.0.0.1:3306)/fyouku?charset=utf8"</span>)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    web.Run()</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="crud的read"><a href="#crud的read" class="headerlink" title="crud的read"></a>crud的read</h2><p><code>models/User.go</code></p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> models</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"github.com/beego/beego/v2/client/orm"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 操作数据库都需要定义struct和表结构对应</span></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> {</span><br><span class="line">    Id      <span class="keyword">int</span></span><br><span class="line">    Name    <span class="keyword">string</span></span><br><span class="line">    AddTime <span class="keyword">int64</span></span><br><span class="line">    Status  <span class="keyword">int</span></span><br><span class="line">    Mobile  <span class="keyword">string</span></span><br><span class="line">    Avatar  <span class="keyword">string</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化注册对应model</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="comment">// 注册model</span></span><br><span class="line">    orm.RegisterModel(<span class="built_in">new</span>(User))</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取用户信息</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">UserInfo</span><span class="params">(id <span class="keyword">int</span>)</span> <span class="params">(User, error)</span></span> {</span><br><span class="line">    <span class="comment">// 通过orm中的Read函数获取</span></span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        err error</span><br><span class="line">    )</span><br><span class="line">    o := orm.NewOrm()</span><br><span class="line">    user := User{Id: id}</span><br><span class="line">    err = o.Read(&amp;user)</span><br><span class="line">    <span class="keyword">return</span> user, err</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><code>controllers/demo.go</code></p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通过id获取用户名</span></span><br><span class="line"><span class="comment">// @router /user/username [get]</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(this *DemoController)</span> <span class="title">GetUsername</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        id    <span class="keyword">int</span></span><br><span class="line">        err   error</span><br><span class="line">        title <span class="keyword">string</span></span><br><span class="line">        user  models.User</span><br><span class="line">    )</span><br><span class="line">    <span class="comment">//接受浏览器中的参数</span></span><br><span class="line">    id, err = this.GetInt(<span class="string">"id"</span>)</span><br><span class="line">    user, err = models.UserInfo(id)</span><br><span class="line">    <span class="keyword">if</span> err == <span class="literal">nil</span> {</span><br><span class="line">        title = user.Name</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        title = <span class="string">"抱歉，服务器走丢了"</span></span><br><span class="line">    }</span><br><span class="line">    this.Ctx.WriteString(title)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/06/07/beego-de-orm/1.png" alt="description"></p>
<h3 id="insert"><a href="#insert" class="headerlink" title="insert"></a>insert</h3><p><code>models/User.go</code></p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 保存用户</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Save</span><span class="params">(name <span class="keyword">string</span>, mobile <span class="keyword">string</span>, avatar <span class="keyword">string</span>)</span> <span class="title">error</span></span> {</span><br><span class="line">    <span class="comment">// 通过orm中的Insert来保存</span></span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        err  error</span><br><span class="line">        user User</span><br><span class="line">    )</span><br><span class="line">    o := orm.NewOrm()</span><br><span class="line">    <span class="comment">// 设置字段的值</span></span><br><span class="line">    user.Name = name</span><br><span class="line">    user.Mobile = mobile</span><br><span class="line">    user.Avatar = avatar</span><br><span class="line">    user.Status = <span class="number">0</span></span><br><span class="line">    _, err = o.Insert(&amp;user)</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><code>controllers/demo.go</code></p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//实现用户注册功能</span></span><br><span class="line"><span class="comment">// @router /user/save [get]</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(this *DemoController)</span> <span class="title">Save</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        name   <span class="keyword">string</span></span><br><span class="line">        mobile <span class="keyword">string</span></span><br><span class="line">        avatar <span class="keyword">string</span></span><br><span class="line">        err    error</span><br><span class="line">        title  <span class="keyword">string</span></span><br><span class="line">    )</span><br><span class="line">    name = this.GetString(<span class="string">"name"</span>)</span><br><span class="line">    mobile = this.GetString(<span class="string">"mobile"</span>)</span><br><span class="line">    avatar = this.GetString(<span class="string">"avatar"</span>)</span><br><span class="line">    err = models.Save(name, mobile, avatar)</span><br><span class="line">    <span class="keyword">if</span> err == <span class="literal">nil</span> {</span><br><span class="line">        title = <span class="string">"恭喜，保存成功了"</span></span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        title = <span class="string">"抱歉，服务器又走丢了"</span></span><br><span class="line">    }</span><br><span class="line">    this.Ctx.WriteString(title)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/06/07/beego-de-orm/2.png" alt="description"><br><img src="/2021/06/07/beego-de-orm/3.png" alt="description"></p>
<h3 id="Update"><a href="#Update" class="headerlink" title="Update"></a>Update</h3><p><code>models/User.go</code></p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 更新用户名</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">UpdateUsername</span><span class="params">(id <span class="keyword">int</span>, name <span class="keyword">string</span>)</span> <span class="title">error</span></span> {</span><br><span class="line">    <span class="comment">// 通过orm中的Update来保存</span></span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        user User</span><br><span class="line">        err  error</span><br><span class="line">    )</span><br><span class="line">    o := orm.NewOrm()</span><br><span class="line">    user = User{Id: id}</span><br><span class="line">    <span class="keyword">if</span> o.Read(&amp;user) == <span class="literal">nil</span> {</span><br><span class="line">        user.Name = name</span><br><span class="line">        _, err = o.Update(&amp;user)</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><code>controllers/demo.go</code></p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 实现修改用户名</span></span><br><span class="line"><span class="comment">// @router /user/update [get]</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(this *DemoController)</span> <span class="title">UpdateUsername</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        id    <span class="keyword">int</span></span><br><span class="line">        name  <span class="keyword">string</span></span><br><span class="line">        title <span class="keyword">string</span></span><br><span class="line">        err   error</span><br><span class="line">    )</span><br><span class="line">    id, err = this.GetInt(<span class="string">"id"</span>)</span><br><span class="line">    name = this.GetString(<span class="string">"name"</span>)</span><br><span class="line">    err = models.UpdateUsername(id, name)</span><br><span class="line">    <span class="keyword">if</span> err == <span class="literal">nil</span> {</span><br><span class="line">        title = <span class="string">"恭喜，名字修改成功了"</span></span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        title = <span class="string">"抱歉，服务器又走丢了"</span></span><br><span class="line">    }</span><br><span class="line">    this.Ctx.WriteString(title)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/06/07/beego-de-orm/4.png" alt="description"><br><img src="/2021/06/07/beego-de-orm/5.png" alt="description"></p>
<h3 id="delete"><a href="#delete" class="headerlink" title="delete"></a>delete</h3><p><code>models/User.go</code></p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 删除用户，通过ID删除数据</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Delete</span><span class="params">(id <span class="keyword">int</span>)</span> <span class="title">error</span></span> {</span><br><span class="line">    <span class="comment">// 通过orm中的Delete来保存</span></span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        user User</span><br><span class="line">        err  error</span><br><span class="line">    )</span><br><span class="line">    o := orm.NewOrm()</span><br><span class="line">    user = User{Id: id}</span><br><span class="line">    _, err = o.Delete(&amp;user)</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><code>controllers/demo.go</code></p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 删除用户</span></span><br><span class="line"><span class="comment">// @router /user/delete [get]</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(this *DemoController)</span> <span class="title">Delete</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        id    <span class="keyword">int</span></span><br><span class="line">        err   error</span><br><span class="line">        title <span class="keyword">string</span></span><br><span class="line">    )</span><br><span class="line">    id, err = this.GetInt(<span class="string">"id"</span>)</span><br><span class="line"></span><br><span class="line">    err = models.Delete(id)</span><br><span class="line">    <span class="keyword">if</span> err == <span class="literal">nil</span> {</span><br><span class="line">        title = <span class="string">"恭喜，您成功的把自己删除了"</span></span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        title = <span class="string">"抱歉，服务器怎么又走丢了"</span></span><br><span class="line">    }</span><br><span class="line">    this.Ctx.WriteString(title)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/06/07/beego-de-orm/6.png" alt="description"><br><img src="/2021/06/07/beego-de-orm/7.png" alt="description"></p>
<h3 id="高级查询"><a href="#高级查询" class="headerlink" title="高级查询"></a>高级查询</h3><p><code>models/User.go</code></p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取用户列表</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">List</span><span class="params">()</span> <span class="params">([]User, error)</span></span> {</span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        users []User</span><br><span class="line">        err   error</span><br><span class="line">    )</span><br><span class="line">    o := orm.NewOrm()</span><br><span class="line">    qs := o.QueryTable(<span class="string">"user"</span>)  <span class="comment">// 声明操作的表</span></span><br><span class="line">    qs = qs.Filter(<span class="string">"id__lt"</span>, <span class="number">15</span>)  <span class="comment">// 条件id小于15</span></span><br><span class="line">    qs = qs.Limit(<span class="number">2</span>)  <span class="comment">// 返回几条数据</span></span><br><span class="line">    qs = qs.OrderBy(<span class="string">"-id"</span>) <span class="comment">// 倒序是前面加上负号</span></span><br><span class="line">    qs.All(&amp;users, <span class="string">"Id"</span>, <span class="string">"Name"</span>)  <span class="comment">// 设置返回的字段</span></span><br><span class="line">    <span class="keyword">return</span> users, err</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><code>controllers/demo.go</code></p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取用户列表</span></span><br><span class="line"><span class="comment">// @router /user/list [get]</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(this *DemoController)</span> <span class="title">List</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        err   error</span><br><span class="line">        title <span class="keyword">string</span></span><br><span class="line">        users []models.User</span><br><span class="line">    )</span><br><span class="line">    users, err = models.List()</span><br><span class="line">    <span class="keyword">if</span> err == <span class="literal">nil</span> {</span><br><span class="line">        <span class="keyword">for</span> _, v := <span class="keyword">range</span> users {</span><br><span class="line">            title += v.Name + <span class="string">","</span></span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        title = <span class="string">"抱歉，一个人也没有了"</span></span><br><span class="line">    }</span><br><span class="line">    this.Ctx.WriteString(title)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/06/07/beego-de-orm/8.png" alt="description"></p>
<h2 id="数据库原生SQL语句操作数据库"><a href="#数据库原生SQL语句操作数据库" class="headerlink" title="数据库原生SQL语句操作数据库"></a>数据库原生SQL语句操作数据库</h2><ul>
<li><p><code>QueryRow</code> 获取单条数据使用</p>
</li>
<li><p><code>QueryRows</code> 获取多条数据使用</p>
</li>
<li><p><code>Exec</code>  执行insert\update\delete语句</p>
</li>
</ul>
<h2 id="crud的read-1"><a href="#crud的read-1" class="headerlink" title="crud的read"></a>crud的read</h2><p><code>models/User.go</code></p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通过sql获取用户信息</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SqlUserInfo</span><span class="params">(id <span class="keyword">int</span>)</span> <span class="params">(User, error)</span></span> {</span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        user User</span><br><span class="line">        err  error</span><br><span class="line">    )</span><br><span class="line">    o := orm.NewOrm()</span><br><span class="line">    err = o.Raw(<span class="string">"SELECT `name`,`mobile` FROM user Where id=? LIMIT 1"</span>, id).QueryRow(&amp;user)</span><br><span class="line">    <span class="keyword">return</span> user, err</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><code>controllers/demo.go</code></p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通过原生sql方式获取用户信息</span></span><br><span class="line"><span class="comment">// @router /sql/user/userinfo [get]</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(this *DemoController)</span> <span class="title">SqlUserInfo</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        id    <span class="keyword">int</span></span><br><span class="line">        err   error</span><br><span class="line">        title <span class="keyword">string</span></span><br><span class="line">        user  models.User</span><br><span class="line">    )</span><br><span class="line">    id, err = this.GetInt(<span class="string">"id"</span>)</span><br><span class="line">    user, err = models.SqlUserInfo(id)</span><br><span class="line">    <span class="keyword">if</span> err == <span class="literal">nil</span> {</span><br><span class="line">        title = <span class="string">"用户名："</span> + user.Name + <span class="string">"，手机号："</span> + user.Mobile</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        title = <span class="string">"抱歉，没有这个人"</span></span><br><span class="line">    }</span><br><span class="line">    this.Ctx.WriteString(title)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/06/07/beego-de-orm/9.png" alt="description"></p>
<h2 id="crud的INSERT"><a href="#crud的INSERT" class="headerlink" title="crud的INSERT"></a>crud的INSERT</h2><p><code>models/User.go</code></p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通过sql保存用户</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SqlSave</span><span class="params">(name <span class="keyword">string</span>, mobile <span class="keyword">string</span>, avatar <span class="keyword">string</span>)</span> <span class="title">error</span></span> {</span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        err error</span><br><span class="line">    )</span><br><span class="line">    o := orm.NewOrm()</span><br><span class="line">    _, err = o.Raw(<span class="string">"INSERT INTO user (`name`, `mobile`, `avatar`, `status`) VALUES (?, ?, ?, ?)"</span>, name, mobile, avatar, <span class="number">0</span>).Exec()</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><code>controllers/demo.go</code></p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通过原生sql保存用户</span></span><br><span class="line"><span class="comment">// @router /sql/user/save [get]</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(this *DemoController)</span> <span class="title">SqlSave</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        err    error</span><br><span class="line">        title  <span class="keyword">string</span></span><br><span class="line">        name   <span class="keyword">string</span></span><br><span class="line">        mobile <span class="keyword">string</span></span><br><span class="line">        avatar <span class="keyword">string</span></span><br><span class="line">    )</span><br><span class="line">    name = this.GetString(<span class="string">"name"</span>)</span><br><span class="line">    mobile = this.GetString(<span class="string">"mobile"</span>)</span><br><span class="line">    avatar = this.GetString(<span class="string">"avatar"</span>)</span><br><span class="line">    err = models.SqlSave(name, mobile, avatar)</span><br><span class="line">    <span class="keyword">if</span> err == <span class="literal">nil</span> {</span><br><span class="line">        title = <span class="string">"保存成功了"</span></span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        title = <span class="string">"抱歉，服务器走丢了"</span></span><br><span class="line">    }</span><br><span class="line">    this.Ctx.WriteString(title)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/06/07/beego-de-orm/10.png" alt="description"><br><img src="/2021/06/07/beego-de-orm/11.png" alt="description"></p>
<h2 id="crud的UPDATE"><a href="#crud的UPDATE" class="headerlink" title="crud的UPDATE"></a>crud的UPDATE</h2><p><code>models/User.go</code></p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 原生sql修改用户名</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SqlUpdateUsername</span><span class="params">(id <span class="keyword">int</span>, name <span class="keyword">string</span>)</span> <span class="title">error</span></span> {</span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        err error</span><br><span class="line">    )</span><br><span class="line">    o := orm.NewOrm()</span><br><span class="line">    _, err = o.Raw(<span class="string">"UPDATE user SET name=? WHERE id=?"</span>, name, id).Exec()</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><code>controllers/demo.go</code></p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 原生sql修改用户名</span></span><br><span class="line"><span class="comment">// @router /sql/user/updatename [get]</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(this *DemoController)</span> <span class="title">SqlUpdateUsername</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        err   error</span><br><span class="line">        title <span class="keyword">string</span></span><br><span class="line">        id    <span class="keyword">int</span></span><br><span class="line">        name  <span class="keyword">string</span></span><br><span class="line">    )</span><br><span class="line">    id, err = this.GetInt(<span class="string">"id"</span>)</span><br><span class="line">    name = this.GetString(<span class="string">"name"</span>)</span><br><span class="line">    err = models.SqlUpdateUsername(id, name)</span><br><span class="line">    <span class="keyword">if</span> err == <span class="literal">nil</span> {</span><br><span class="line">        title = <span class="string">"恭喜，您把自己的名字改了"</span></span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        title = <span class="string">"抱歉，服务器又丢了~"</span></span><br><span class="line">    }</span><br><span class="line">    this.Ctx.WriteString(title)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/06/07/beego-de-orm/12.png" alt="description"><br><img src="/2021/06/07/beego-de-orm/13.png" alt="description"></p>
<h2 id="crud的UPDATE-1"><a href="#crud的UPDATE-1" class="headerlink" title="crud的UPDATE"></a>crud的UPDATE</h2><p><code>models/User.go</code></p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 原生sql删除用户</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SqlDelete</span><span class="params">(id <span class="keyword">int</span>)</span> <span class="title">error</span></span> {</span><br><span class="line">    o := orm.NewOrm()</span><br><span class="line">    _, err := o.Raw(<span class="string">"DELETE FROM user WHERE id=?"</span>, id).Exec()</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><code>controllers/demo.go</code></p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通过原生sql删除用户</span></span><br><span class="line"><span class="comment">// @router /sql/user/delete [get]</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(this *DemoController)</span> <span class="title">SqlDelete</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        id    <span class="keyword">int</span></span><br><span class="line">        err   error</span><br><span class="line">        title <span class="keyword">string</span></span><br><span class="line">    )</span><br><span class="line">    id, err = this.GetInt(<span class="string">"id"</span>)</span><br><span class="line">    err = models.SqlDelete(id)</span><br><span class="line">    <span class="keyword">if</span> err == <span class="literal">nil</span> {</span><br><span class="line">        title = <span class="string">"恭喜，您成功把自己删除了"</span></span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        title = <span class="string">"抱歉，删除错误，请联系客服"</span></span><br><span class="line">    }</span><br><span class="line">    this.Ctx.WriteString(title)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/06/07/beego-de-orm/14.png" alt="description"><br><img src="/2021/06/07/beego-de-orm/15.png" alt="description"></p>
<h2 id="crud的查询"><a href="#crud的查询" class="headerlink" title="crud的查询"></a>crud的查询</h2><p><code>models/User.go</code></p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 原生sql实现获取用户列表</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SqlList</span><span class="params">()</span> <span class="params">(<span class="keyword">int64</span>, []User, error)</span></span> {</span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        users []User</span><br><span class="line">    )</span><br><span class="line">    o := orm.NewOrm()</span><br><span class="line">    num, err := o.Raw(<span class="string">"SELECT * FROM user WHERE id&lt;? ORDER BY id DESC LIMIT 2"</span>, <span class="number">15</span>).QueryRows(&amp;users)</span><br><span class="line">    <span class="keyword">return</span> num, users, err</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><code>controllers/demo.go</code></p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 原生sql获取用户列表</span></span><br><span class="line"><span class="comment">// @router /sql/user/list [get]</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(this *DemoController)</span> <span class="title">SqlList</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        err   error</span><br><span class="line">        title <span class="keyword">string</span></span><br><span class="line">        users []models.User</span><br><span class="line">    )</span><br><span class="line">    _, users, err = models.SqlList()</span><br><span class="line">    <span class="keyword">if</span> err == <span class="literal">nil</span> {</span><br><span class="line">        <span class="keyword">for</span> _, v := <span class="keyword">range</span> users {</span><br><span class="line">            title += v.Name + <span class="string">","</span></span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        title = <span class="string">"没有相关信息"</span></span><br><span class="line">    }</span><br><span class="line">    this.Ctx.WriteString(title)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">WHERE</span> <span class="keyword">id</span>&lt;<span class="number">15</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">id</span> <span class="keyword">DESC</span> <span class="keyword">LIMIT</span> <span class="number">2</span>;</span><br><span class="line">id | name | password | addtime | stauts | mobile | avatar</span><br><span class="line">14,test3,,1583293416,0,18600008888,我是头像</span><br><span class="line">13,王五,781305f065731d4dffc1033493b03c9c,1581631477,0,18699993333,</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/06/07/beego-de-orm/16.png" alt="description"></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/06/07/drf-yong-hu-liu-yan-he-huo-qu-shou-huo-di-zhi/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/06/07/drf-yong-hu-liu-yan-he-huo-qu-shou-huo-di-zhi/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-06-07 10:35:30" itemprop="dateCreated datePublished" datetime="2021-06-07T10:35:30Z">2021-06-07</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-06-08 12:29:36" itemprop="dateModified" datetime="2021-06-08T12:29:36Z">2021-06-08</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="用户留言功能"><a href="#用户留言功能" class="headerlink" title="用户留言功能"></a>用户留言功能</h2><p>用户留言包括添加、获取和删除等功能。</p>
<p><code>user_operation/serializers.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> UserFav, UserLeavingMessage</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LeavingMessageSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    用户留言序列化</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    <span class="comment"># 获取当前登录的用户</span></span><br><span class="line">    user = serializers.HiddenField(default=serializers.CurrentUserDefault())</span><br><span class="line">    <span class="comment"># read_only=True只返回而不提交，不手动输入时间、而是自动生成</span></span><br><span class="line">    add_time = serializers.DateTimeField(read_only=<span class="literal">True</span>, format=<span class="string">'%Y-%m-%d %H:%M'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = UserLeavingMessage</span><br><span class="line">        fields = [<span class="string">'id'</span>, <span class="string">'user'</span>, <span class="string">'message_type'</span>, <span class="string">'subject'</span>, <span class="string">'message'</span>, <span class="string">'file'</span>, <span class="string">'add_time'</span>]</span><br></pre></td></tr></tbody></table></figure>

<p><code>user_operation/views.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> UserLeavingMessageSerializer</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> UserLeavingMessage</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LeavingMessageViewSet</span>(<span class="params">mixins.CreateModelMixin, mixins.ListModelMixin, mixins.DestroyModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                            viewsets.GenericViewSet</span>):</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    list:</span></span><br><span class="line"><span class="string">        留言列表</span></span><br><span class="line"><span class="string">    create:</span></span><br><span class="line"><span class="string">        添加留言</span></span><br><span class="line"><span class="string">    delete:</span></span><br><span class="line"><span class="string">        删除留言</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    queryset = UserLeavingMessage.objects.all()</span><br><span class="line">    permission_classes = [IsAuthenticated, IsOwnerOrReadOnly]</span><br><span class="line">    authentication_classes = [JWTAuthentication, SessionAuthentication]</span><br><span class="line">    serializer_class = LeavingMessageSerializer</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_queryset</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">"""只能看到自己的留言"""</span></span><br><span class="line">        <span class="comment"># return self.queryset.filter(user=self.request.user)</span></span><br><span class="line">        <span class="keyword">return</span> UserLeavingMessage.objects.filter(user=self.request.user, is_delete=<span class="literal">False</span>)</span><br></pre></td></tr></tbody></table></figure>

<p><code>url.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> user_operation.views <span class="keyword">import</span> UserLeavingMessageViewSet</span><br><span class="line"></span><br><span class="line">router.register(<span class="string">'messages'</span>, LeavingMessageViewSet)</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/06/07/drf-yong-hu-liu-yan-he-huo-qu-shou-huo-di-zhi/0.png" alt="description"><br><img src="/2021/06/07/drf-yong-hu-liu-yan-he-huo-qu-shou-huo-di-zhi/1.jpeg" alt="description"></p>
<h2 id="用户收获地址"><a href="#用户收获地址" class="headerlink" title="用户收获地址"></a>用户收获地址</h2><p><code>user_operation/serializers.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> UserFav, UserLeavingMessage</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LeavingMessageSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    用户留言序列化</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    <span class="comment"># 获取当前登录的用户</span></span><br><span class="line">    user = serializers.HiddenField(default=serializers.CurrentUserDefault())</span><br><span class="line">    <span class="comment"># read_only=True只返回而不提交，不手动输入时间、而是自动生成</span></span><br><span class="line">    add_time = serializers.DateTimeField(read_only=<span class="literal">True</span>, format=<span class="string">'%Y-%m-%d %H:%M'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = UserLeavingMessage</span><br><span class="line">        fields = [<span class="string">'id'</span>, <span class="string">'user'</span>, <span class="string">'message_type'</span>, <span class="string">'subject'</span>, <span class="string">'message'</span>, <span class="string">'file'</span>, <span class="string">'add_time'</span>]</span><br></pre></td></tr></tbody></table></figure>

<p>要实现增删改查功能，只要继承ModelViewSet就可以了<br><code>user_operation/views.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> UserLeavingMessageSerializer</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> UserLeavingMessage</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LeavingMessageViewSet</span>(<span class="params">mixins.CreateModelMixin, mixins.ListModelMixin, mixins.DestroyModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                            viewsets.GenericViewSet</span>):</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    list:</span></span><br><span class="line"><span class="string">        留言列表</span></span><br><span class="line"><span class="string">    create:</span></span><br><span class="line"><span class="string">        添加留言</span></span><br><span class="line"><span class="string">    delete:</span></span><br><span class="line"><span class="string">        删除留言</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    queryset = UserLeavingMessage.objects.all()</span><br><span class="line">    permission_classes = [IsAuthenticated, IsOwnerOrReadOnly]</span><br><span class="line">    authentication_classes = [JWTAuthentication, SessionAuthentication]</span><br><span class="line">    serializer_class = LeavingMessageSerializer</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_queryset</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">"""只能看到自己的留言"""</span></span><br><span class="line">        <span class="comment"># return self.queryset.filter(user=self.request.user)</span></span><br><span class="line">        <span class="keyword">return</span> UserLeavingMessage.objects.filter(user=self.request.user, is_delete=<span class="literal">False</span>)</span><br></pre></td></tr></tbody></table></figure>

<p><code>url.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> user_operation.views <span class="keyword">import</span> UserFavViewSet, UserLeavingMessageViewSet</span><br><span class="line"></span><br><span class="line">router.register(<span class="string">'address'</span>, AddressViewSet)</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/06/07/drf-yong-hu-liu-yan-he-huo-qu-shou-huo-di-zhi/2.png" alt="description"><br><img src="/2021/06/07/drf-yong-hu-liu-yan-he-huo-qu-shou-huo-di-zhi/3.png" alt="description"></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/06/07/pycharm-shang-chuan-wen-jian-dao-linux/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/06/07/pycharm-shang-chuan-wen-jian-dao-linux/" class="post-title-link" itemprop="url">pycharm上传文件到linux</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2021-06-06 16:21:41 / 修改时间：09:55:53" itemprop="dateCreated datePublished" datetime="2021-06-06T16:21:41Z">2021-06-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/django/" itemprop="url" rel="index"><span itemprop="name">django</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>pycharm Tools-Deployment-configuration- SFTP</p>
<p>最下面的Web server root URL是该项目在部署后的链接，点击open可打开该项目。Root path是指定自动上传到linux服务器的路径，这里就选择测试主机的/root目录。</p>
<p>选择要上传的目录或文件，出现高亮，Tools-Deployment</p>
<p>传递的是相对路径，不是把文件传到根路径，保持原来的目录结构，会创建所在的文件夹</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-0-9-centos ~]<span class="comment"># cd /root/project/mxshop_srvs/</span></span><br><span class="line">[root@VM-0-9-centos mxshop_srvs]<span class="comment"># ls</span></span><br><span class="line">order_srv</span><br><span class="line">[root@VM-0-9-centos mxshop_srvs]<span class="comment"># cd order_srv/</span></span><br><span class="line">[root@VM-0-9-centos order_srv]<span class="comment"># ls</span></span><br><span class="line">install.zip</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-0-9-centos order_srv]<span class="comment"># unzip install.zip</span></span><br><span class="line">Archive:  install.zip</span><br><span class="line">  inflating: install/README.md</span><br><span class="line">   creating: install/conf/</span><br><span class="line">  inflating: install/conf/broker.conf</span><br><span class="line">  inflating: install/docker-compose.yml</span><br><span class="line">[root@VM-0-9-centos order_srv]<span class="comment"># ls</span></span><br><span class="line">install  install.zip</span><br><span class="line">[root@VM-0-9-centos order_srv]<span class="comment"># cd install/</span></span><br><span class="line">[root@VM-0-9-centos install]<span class="comment"># ls</span></span><br><span class="line">conf  docker-compose.yml  README.md</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/06/07/pycharm-shang-chuan-wen-jian-dao-linux/1.png" alt="description"></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/06/06/drf-kong/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/06/06/drf-kong/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2021-06-06 11:27:23 / 修改时间：11:31:36" itemprop="dateCreated datePublished" datetime="2021-06-06T11:27:23Z">2021-06-06</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/06/06/drf-fan-hui-shu-ju-ge-shi/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/06/06/drf-fan-hui-shu-ju-ge-shi/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2021-06-06 09:59:11 / 修改时间：11:01:43" itemprop="dateCreated datePublished" datetime="2021-06-06T09:59:11Z">2021-06-06</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>因为接口请求需要用POST方法，因此开始直接使用输入网址的GET方法会失败，<br>DRF提供了在页面HTML form 用POST方法发送数据的功能，返回格式和Django Form中是一样的，<br>对于多个字段的验证，如果某一个字段验证失败，则提示该字段的错误信息数组，<br>如果多个字段验证失败，则将这些字段的错误信息都显示出来。<br>包含HTTP状态码和具体信息，如果是返回的错误信息可以用于对前端的有误区域进行标亮显示，以便于用户重新输入。</p>
<p>drf 默认返回的异常格式</p>
<figure class="highlight prolog"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">http_code</span><br><span class="line">{</span><br><span class="line">    <span class="string">"msg"</span>: <span class="string">"username该字段是必填项。"</span>,</span><br><span class="line">    <span class="string">"code"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">"data"</span>: <span class="string">""</span></span><br><span class="line">    field1: [<span class="string">''</span>, <span class="string">''</span>],</span><br><span class="line">    field2: [],</span><br><span class="line">    <span class="string">"username"</span>: [</span><br><span class="line">        <span class="string">"该字段是必填项。"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"password"</span>: [</span><br><span class="line">        <span class="string">"该字段是必填项。"</span></span><br><span class="line">    ]</span><br><span class="line">    ...</span><br><span class="line">    <span class="string">'non_fields_error'</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>但是在实际工作中、这样的数据不利于前端的渲染<br>就拿写IOS的AFNetworking为例、他判断请求成功还是失败不是以http的状态码判断的(当然也可以自己封装)<br>一般判断返回的code作为判断条件<br>当错误返回的时候直接使用<code>response[@"error"]</code>作为错误的提示信息<br><code>response</code>是数据返回的字典 <code>error</code>是错误信息的<code>key</code></p>
<p>自定义drf异常返回和自定义数据返回格式</p>
<p><code>EXCEPTION_HANDLER</code>对应的是你文件夹路径<br><code>settings.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># drf配置</span></span><br><span class="line">REST_FRAMEWORK = {</span><br><span class="line">    <span class="comment"># 全局配置异常模块</span></span><br><span class="line">    <span class="string">'EXCEPTION_HANDLER'</span>: <span class="string">'pine_mountain_bridge.utils.exception.custom_exception_handler'</span>,</span><br><span class="line">    <span class="comment"># 修改默认返回JSON的renderer的类</span></span><br><span class="line">    <span class="string">'DEFAULT_RENDERER_CLASSES'</span>: (</span><br><span class="line">        <span class="string">'pine_mountain_bridge.utils.rendererresponse.customrenderer'</span>,</span><br><span class="line">    ),</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>设置异常返回<br>这里我是在pine_mountain_bridge的<code>utils</code>文件夹里面新建了<code>exception.py</code>文件</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 自定义异常处理</span></span><br><span class="line"><span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> exception_handler</span><br><span class="line"><span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> Response</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> status</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将仅针对由引发的异常生成的响应调用异常处理程序。它不会用于视图直接返回的任何响应</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">custom_exception_handler</span>(<span class="params">exc, context</span>):</span></span><br><span class="line">    response = exception_handler(exc, context)</span><br><span class="line">    <span class="comment"># 这个循环是取第一个错误的提示用于渲染</span></span><br><span class="line">    <span class="keyword">for</span> index, value <span class="keyword">in</span> enumerate(response.data):</span><br><span class="line">        <span class="keyword">if</span> index == <span class="number">0</span>:</span><br><span class="line">            key = value</span><br><span class="line">            value = response.data[key]</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> isinstance(value, str):</span><br><span class="line">                message = value</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                message = key + value[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> response <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="comment"># print(exc)    #错误原因   还可以做更详细的原因，通过判断exc信息类型</span></span><br><span class="line">        <span class="comment"># print(context)  #错误信息</span></span><br><span class="line">        <span class="comment"># print('1234 = %s - %s - %s' % (context['view'], context['request'].method, exc))</span></span><br><span class="line">        <span class="keyword">return</span> Response({</span><br><span class="line">            <span class="string">'message'</span>: <span class="string">'服务器错误'</span></span><br><span class="line">        }, status=status.HTTP_500_INTERNAL_SERVER_ERROR, exception=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># print('123 = %s - %s - %s' % (context['view'], context['request'].method, exc))</span></span><br><span class="line">        <span class="keyword">return</span> Response({</span><br><span class="line">            <span class="string">'message'</span>: message,</span><br><span class="line">        }, status=response.status_code, exception=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> response</span><br></pre></td></tr></tbody></table></figure>

<p>设置自定义返回数据结构<br>这里我是在pine_mountain_bridge的<code>utils</code>文件夹里面新建了<code>rendererresponse.py</code>文件</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">自定义返回处理</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 导入控制返回的JSON格式的类</span></span><br><span class="line"><span class="keyword">from</span> rest_framework.renderers <span class="keyword">import</span> JSONRenderer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">customrenderer</span>(<span class="params">JSONRenderer</span>):</span></span><br><span class="line">    <span class="comment"># 重构render方法</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">render</span>(<span class="params">self, data, accepted_media_type=None, renderer_context=None</span>):</span></span><br><span class="line">        <span class="keyword">if</span> renderer_context:</span><br><span class="line">            <span class="keyword">if</span> isinstance(data, dict):</span><br><span class="line">                msg = data.pop(<span class="string">'msg'</span>, <span class="string">'success'</span>)</span><br><span class="line">                code = data.pop(<span class="string">'code'</span>, <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                msg = <span class="string">'success'</span></span><br><span class="line">                state = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 重新构建返回的JSON字典</span></span><br><span class="line">            <span class="keyword">for</span> key <span class="keyword">in</span> data:</span><br><span class="line">                <span class="comment"># 判断是否有自定义的异常的字段</span></span><br><span class="line">                <span class="keyword">if</span> key == <span class="string">'message'</span>:</span><br><span class="line">                    msg = data[key]</span><br><span class="line">                    data = <span class="string">''</span></span><br><span class="line">                    code = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">            ret = {</span><br><span class="line">                <span class="string">'msg'</span>: msg,</span><br><span class="line">                <span class="string">'code'</span>: code,</span><br><span class="line">                <span class="string">'data'</span>: data,</span><br><span class="line">            }</span><br><span class="line">            <span class="comment"># 返回JSON数据</span></span><br><span class="line">            <span class="keyword">return</span> super().render(ret, accepted_media_type, renderer_context)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> super().render(data, accepted_media_type, renderer_context)</span><br></pre></td></tr></tbody></table></figure>

<p>默认提示</p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">    <span class="attr">"msg"</span>: <span class="string">"name该字段是必填项。"</span>,</span><br><span class="line">    <span class="attr">"state"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"data"</span>: <span class="string">""</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>在自己对于的serializers文件中设置<code>error_messages</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">name = serializers.CharField(</span><br><span class="line">    error_messages={</span><br><span class="line">        <span class="string">"blank"</span>: <span class="string">"请输入名字"</span>,</span><br><span class="line">        <span class="string">"required"</span>: <span class="string">"请输入名字"</span>,</span><br><span class="line">    },</span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure>

<p>自定义返回<br>如果不想有name这个key请修改自定义异常exception.py的代码</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">    <span class="string">"msg"</span>: <span class="string">"name请输入名字"</span>,</span><br><span class="line">    <span class="string">"state"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">"data"</span>: <span class="string">""</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">    <span class="attr">"msg"</span>: <span class="string">"success"</span>,</span><br><span class="line">    <span class="attr">"code"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"data"</span>: {</span><br><span class="line">        <span class="attr">"refresh"</span>: <span class="string">"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ0b2tlbl90eXBlIjoicmVmcmVzaCIsImV4cCI6MTU4NjMxMDk5NCwianRpIjoiZTkzZDlhYzZhMWM5NDQ2NTgyN2ZkMzJmNWYzNDVlNjIiLCJ1c2VyX2lkIjoxfQ.Nca8X5AClJxVuDK1-wxJBFZI9WzXt2UL3bytyRckqTU"</span>,</span><br><span class="line">        <span class="attr">"access"</span>: <span class="string">"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ0b2tlbl90eXBlIjoiYWNjZXNzIiwiZXhwIjoxNTg1NjE5Nzk0LCJqdGkiOiI0NjZkMzk2ZThiMjU0MDQxYTE5OWJjZTc5MjRjNDc2ZiIsInVzZXJfaWQiOjF9.9oaLarHvtT8Zo9dV312Y5fE9HtkTp9Uxrx4WWo_8etg"</span>,</span><br><span class="line">        <span class="attr">"username"</span>: <span class="string">"hahn"</span>,</span><br><span class="line">        <span class="attr">"user_id"</span>: <span class="number">1</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/06/05/drf-xu-lie-hua-yan-zheng-qi/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/06/05/drf-xu-lie-hua-yan-zheng-qi/" class="post-title-link" itemprop="url">drf序列化验证器</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2021-06-04 16:21:41 / 修改时间：08:08:31" itemprop="dateCreated datePublished" datetime="2021-06-04T16:21:41Z">2021-06-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/django/" itemprop="url" rel="index"><span itemprop="name">django</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>对于字段的验证，除了默认的<code>required</code>、<code>max_length</code>、<code>min_length</code>等验证方式，<br>DRF还提供了专业的验证器，只需要依赖默认字段验证，或者在序列化器或字段类上编写显式验证方法。包括</p>
<ul>
<li><p><code>UniqueValidator</code><br>This validator can be used to enforce the <code>unique=True</code> constraint on model fields. It takes a single required argument, and an optional <code>messages</code> argument:对模型字段强制<code>unique=True</code>约束。它接受一个必需的参数和一个可选的消息参数:</p>
<ul>
<li><p><code>queryset</code> required - This is the queryset against which uniqueness should be enforced.必须的，这是应该强制惟一性的queryset</p>
</li>
<li><p><code>message</code> - The error message that should be used when validation fails.验证失败时应该使用的错误消息。</p>
</li>
<li><p><code>lookup</code> - The lookup used to find an existing instance with the value being validated. Defaults to ‘exact’.<br>用于查找正在验证值的现有实例。默认为“精确”。</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.validators <span class="keyword">import</span> UniqueValidator</span><br><span class="line"></span><br><span class="line">slug = SlugField(</span><br><span class="line">    max_length=<span class="number">100</span>,</span><br><span class="line">    validators=[UniqueValidator(queryset=BlogPost.objects.all())]</span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
</li>
<li><p><code>UniqueTogetherValidator</code><br>This validator can be used to enforce <code>unique_together</code> constraints on model instances. It has two required arguments, and a single optional <code>messages</code> argument:验证器可用于对模型实例强制<code>unique_together</code>约束。它有两个必需的参数和一个可选的消息参数:</p>
<ul>
<li><p><code>queryset</code> required - This is the queryset against which uniqueness should be enforced.强制惟一性的queryset</p>
</li>
<li><p><code>fields</code> required - A list or tuple of field names which should make a unique set. These must exist as fields on the serializer class.段名的列表或元组，应该构成一个惟一的集合。这些字段必须作为字段存在于序列化器类中。</p>
</li>
<li><p><code>message</code> - The error message that should be used when validation fails.验证失败时应该使用的错误消息</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.validators <span class="keyword">import</span> UniqueTogetherValidator</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExampleSerializer</span>(<span class="params">serializers.Serializer</span>):</span></span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        <span class="comment"># ToDo items belong to a parent list, and have an ordering defined</span></span><br><span class="line">        <span class="comment"># by the 'position' field. No two items in a given list may share</span></span><br><span class="line">        <span class="comment"># the same position.</span></span><br><span class="line">        validators = [</span><br><span class="line">            UniqueTogetherValidator(</span><br><span class="line">                queryset=ToDoItem.objects.all(),</span><br><span class="line">                fields=[<span class="string">'list'</span>, <span class="string">'position'</span>]</span><br><span class="line">            )</span><br><span class="line">        ]</span><br></pre></td></tr></tbody></table></figure>

</li>
</ul>
</li>
</ul>
<p>Note: The <code>UniqueTogetherValidator</code> class always imposes an implicit constraint that all the fields it applies to are always treated as required. Fields with <code>default</code> values are an exception to this as they always supply a value even when omitted from user input.<br>注意：<code>UniqueTogetherValidation</code>类总是施加一个隐式的约束，它所应用的所有字段总是按需要处理。具有默认值的字段是一个例外，因为它们总是提供一个值，即使在用户输入中省略了这个值。</p>
<p>以上<code>validators</code>不是作用域某个字段之上了，需要写在<code>Meta</code>中，因为<code>UniqueTogetherValidator</code>是作用域两个或两个字段以上的，不是针对一个字段，所以需要写在这。</p>
<ul>
<li><p><code>UniqueForDateValidator</code></p>
</li>
<li><p><code>Advanced field defaults</code></p>
</li>
</ul>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/05/31/beego/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/31/beego/" class="post-title-link" itemprop="url">beego</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-05-30 16:21:41" itemprop="dateCreated datePublished" datetime="2021-05-30T16:21:41Z">2021-05-30</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-06-07 14:41:31" itemprop="dateModified" datetime="2021-06-07T14:41:31Z">2021-06-07</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/beego/" itemprop="url" rel="index"><span itemprop="name">beego</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>不要用clash的terminal</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">go get -u github.com/beego/beego/v2</span><br><span class="line">go get -u github.com/beego/bee/v2</span><br><span class="line">bee version</span><br></pre></td></tr></tbody></table></figure>

<p>Bee主要命令<br><code>bee new project_name</code>新建一个 Web 项目</p>
<p><code>bee api</code>创建 API 应用的，和 Web 项目相比，少了 static 和 views 目录，多了一个 test 模块，用来做单元测试的</p>
<p><code>bee run</code> 运行监控 beego 的项目</p>
<p><code>bee pack</code> 发布应用的时候打包，会把项目打包成 zip 包，这样我们部署的时候直接把打包之后的项目上传，解压就可以部署</p>
<p>注意：<code>bee pack -be GOOS=linux</code><br>MAC下打的包是不能再linux执行的，需要制定参数</p>
<p>先把入门看了<br><a target="_blank" rel="noopener" href="https://beego.me/quickstart">https://beego.me/quickstart</a></p>
<p>命令行进行编译并执行</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"github.com/beego/beego/v2/server/web"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> MainController <span class="keyword">struct</span> {</span><br><span class="line">    web.Controller</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(this *MainController)</span> <span class="title">Get</span><span class="params">()</span></span> {</span><br><span class="line">    this.Ctx.WriteString(<span class="string">"hello world"</span>)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    web.Router(<span class="string">"/"</span>, &amp;MainController{})</span><br><span class="line">    web.Run()</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ go build -o hello hello.go</span><br><span class="line">$ ./hello</span><br></pre></td></tr></tbody></table></figure>

<ol>
<li><p>首先我们导入了包 <code>github.com/beego/beego/v2/server/web</code>。我们知道 Go 语言里面被导入的包会按照<strong>深度优先</strong>的顺序去执行导入包的初始化（变量和 init 函数，更多详情），beego 包中会初始化一个 BeeAPP 的应用和一些参数。</p>
</li>
<li><p>定义 Controller，这里我们定义了一个 <code>struct</code> 为 M<code>ainController</code>，充分利用了 Go 语言的组合的概念，匿名包含了 <code>web.Controller</code>，这样我们的 <code>MainController</code> 就拥有了 <code>web.Controller</code> 的所有方法。</p>
</li>
<li><p>定义 RESTful 方法，通过匿名组合之后，其实目前的 <code>MainController</code> 已经拥有了 <code>Get</code>、<code>Post</code>、<code>Delete</code>、<code>Put</code> 等方法，这些方法是分别用来对应用户请求的 Method 函数，<br>如果用户发起的是 POST 请求，那么就执行 Post 函数。<br>所以这里我们定义了 <code>MainController</code> 的 <code>Get</code> 方法用来重写继承的 <code>Get</code> 函数，这样当用户发起 GET 请求的时候就会执行该函数。</p>
</li>
<li><p>定义 <code>main</code> 函数，所有的 Go 应用程序和 C 语言一样都是 main 函数作为入口，所以我们这里定义了我们应用的入口。</p>
</li>
<li><p>Router 注册路由，路由就是告诉 beego，当用户来请求的时候，该如何去调用相应的 Controller，这里我们注册了请求 <code>/</code> 的时候，请求到 <code>MainController</code>。这里我们需要知道，Router 函数的两个参数函数，第一个是路径，第二个是 Controller 的指针。</p>
</li>
<li><p>Run 应用，最后一步就是把在步骤 1 中初始化的 BeeApp 开启起来，其实就是内部监听了 8080 端口：Go 默认情况会监听你本机所有的 IP 上面的 8080 端口。</p>
</li>
</ol>
<p><code>URLMapping</code> 新增加的函数，用户如果没有进行注册，那么就会通过反射来执行对应的函数，如果注册了就会通过 interface 来进行执行函数，性能上面会提升很多</p>
<h3 id="路由设置"><a href="#路由设置" class="headerlink" title="路由设置"></a>路由设置</h3><p>v1是<code>beego.Router</code><br>v2是<code>web.Router</code></p>
<p>有两种方式：</p>
<h4 id="在router-go中配置"><a href="#在router-go中配置" class="headerlink" title="在router.go中配置"></a>在<code>router.go</code>中配置</h4><p><code>default.go</code></p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 浏览器输出Hello World</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *MainController)</span> <span class="title">GetHello</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        title <span class="keyword">string</span></span><br><span class="line">    )</span><br><span class="line">    title = <span class="string">"Hello world"</span></span><br><span class="line">    c.Ctx.WriteString(title)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><code>router.go</code></p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> {</span><br><span class="line">    web.Router(<span class="string">"/hello"</span>, &amp;controllers.MainController{}, <span class="string">"get:GetHello"</span>)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/05/31/beego/1.png" alt="description"></p>
<h4 id="在router-go中include引入，直接在函数上方配置规则"><a href="#在router-go中include引入，直接在函数上方配置规则" class="headerlink" title="在router.go中include引入，直接在函数上方配置规则"></a>在<code>router.go</code>中<code>include</code>引入，直接在函数上方配置规则</h4><p><code>demo.go</code></p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 输出Hello World!</span></span><br><span class="line"><span class="comment">// @router /demo/hello [get]</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(this *DemoController)</span> <span class="title">GetHello</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        title <span class="keyword">string</span></span><br><span class="line">    )</span><br><span class="line">    title = <span class="string">"Hello World!"</span></span><br><span class="line">    this.Ctx.WriteString(title)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><code>router.go</code>注册路由</p>
<p>controller 的 method 方法上面须有 router 注释（// @router），</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> {</span><br><span class="line">    web.Include(&amp;controllers.DemoController{})</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/05/31/beego/2.png" alt="description"></p>
<h3 id="MVC模式"><a href="#MVC模式" class="headerlink" title="MVC模式"></a>MVC模式</h3><p>在目录下有 controllers models views 文件夹分别存放controller文件，model文件和模板文件。<br>后面项目中用到的文件都会分别在这三个文件夹中</p>
<p>过滤器，<br>进行安全验证，访问用户中心的时候，<br>进行是否登录的判断可以在过滤器中，<br>也可以实现屏蔽IP的功能，<br>屏蔽黑名单的功能等等，对项目有整体的规则时，<br>都可以在过滤器中实现，不用在每个函数中来实现了</p>
<p>过滤器是通过<code>beego.insertfilter(pattern string, positon int, filter FilterFunc, skip ...bool)</code>函数来实现的</p>
<p><code>router.go</code></p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="comment">// 这里是屏蔽规则，包含demo/的url都走过滤规则屏蔽；</span></span><br><span class="line">    <span class="comment">// 第二个参数是BeforeRouter，在寻找加载路由之前</span></span><br><span class="line">    <span class="comment">// 第三个参数是要执行的函数名。</span></span><br><span class="line">    <span class="keyword">var</span> FilterDemo = <span class="function"><span class="keyword">func</span><span class="params">(ctx *context.Context)</span></span> {</span><br><span class="line">        <span class="keyword">var</span> (</span><br><span class="line">            title <span class="keyword">string</span></span><br><span class="line">        )</span><br><span class="line">        title = <span class="string">"禁止访问"</span></span><br><span class="line">        ctx.WriteString(title)</span><br><span class="line">    }</span><br><span class="line">    web.InsertFilter(<span class="string">"/demo/*"</span>, web.BeforeRouter, FilterDemo)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/05/31/beego/3.png" alt="description"></p>
<h3 id="配置信息"><a href="#配置信息" class="headerlink" title="配置信息"></a>配置信息</h3><p>beego提供了专门配置文件，配置信息定义在conf文件夹中的app.conf</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">appname = fyouku // 项目名称</span><br><span class="line">httpport = 8098  // 访问端口号</span><br><span class="line">runmode = dev    // 运行环境，下面会根据运行环境加载不同配置</span><br><span class="line"></span><br><span class="line">[dev]  // 开发环境</span><br><span class="line">apiurl = http://127.0.0.1:8099</span><br><span class="line">microApi = http://127.0.0.1:8085</span><br><span class="line">defaultdb = root:123456@(127.0.0.1:3306)/fyouku?charset=utf8</span><br><span class="line">redisdb = 127.0.0.1:6379</span><br><span class="line">rabbitmq = amqp://guest:guest@127.0.0.1:5672/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[prod]  // 线上环境</span><br><span class="line">apiurl = http://127.0.0.1:8099</span><br><span class="line">microApi = http://127.0.0.1:8085</span><br><span class="line">defaultdb = root:123456@(127.0.0.1:3306)/fyouku?charset=utf8</span><br><span class="line">redisdb = 127.0.0.1:6379</span><br><span class="line">rabbitmq = amqp://guest:guest@127.0.0.1:5672/</span><br></pre></td></tr></tbody></table></figure>

<p>静态文件</p>
<p>项目中的css、js、img文件都是怎样访问的，bee new创建的项目中有static文件夹，这是beego默认注册的静态文件处理目录</p>
<figure class="highlight actionscript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">├── <span class="keyword">static</span></span><br><span class="line">    │   ├── css</span><br><span class="line">    │   ├── img</span><br><span class="line">    │   └── js</span><br></pre></td></tr></tbody></table></figure>
<p>访问地址为：<a target="_blank" rel="noopener" href="http://127.0.0.1:8080/static/js/fyouku.js">http://127.0.0.1:8080/static/js/fyouku.js</a></p>
<p>也可以通过下面命令来自定义目录</p>
<figure class="highlight less"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">beego</span><span class="selector-class">.SetStaticPath</span>(<span class="string">"/down1"</span>, <span class="string">"download1"</span>)</span><br></pre></td></tr></tbody></table></figure>

<p>view语法</p>
<ul>
<li>统一使用 作为左右标签</li>
<li><code>.</code> 访问当前位置的上下文</li>
<li><code>$</code> 引用当前模板根级的上下文</li>
<li><code>$var</code> 访问创建的变量</li>
</ul>
<p>判断语句 <code>if ... else ... end</code></p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">{{if eq .IsEmail 1}}</span><br><span class="line">    &lt;a class="email" href="mailto:{{.Email}}"&gt;{{.Email}}&lt;/a&gt;</span><br><span class="line">{{else}}</span><br><span class="line">    &lt;a class="email" href="#"&gt;不允许访问Email&lt;/a&gt;</span><br><span class="line">{{end}}</span><br></pre></td></tr></tbody></table></figure>

<p>循环语句 range</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">{{range $index,$value := .Pages}}</span><br><span class="line">    {{$index}} - {{$value.Num}} of {{$.Website}}</span><br><span class="line">    &lt;br&gt;</span><br><span class="line">{{end}}</span><br></pre></td></tr></tbody></table></figure>

<p>载入其它模板</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">{{template "head.html" .}}</span><br></pre></td></tr></tbody></table></figure>

<p><code>controllers/default.go</code></p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *MainController)</span> <span class="title">Get</span><span class="params">()</span></span> {</span><br><span class="line">    c.Data[<span class="string">"Website"</span>] = <span class="string">"beego.me"</span></span><br><span class="line">    c.Data[<span class="string">"Email"</span>] = <span class="string">"astaxie@gmail.com"</span></span><br><span class="line">    c.Data[<span class="string">"IsEmail"</span>] = <span class="number">1</span></span><br><span class="line">    c.TplName = <span class="string">"index.tpl"</span></span><br><span class="line">    pages := []<span class="keyword">struct</span> {</span><br><span class="line">        Num <span class="keyword">int</span></span><br><span class="line">    }{{<span class="number">10</span>}, {<span class="number">20</span>}, {<span class="number">30</span>}}</span><br><span class="line">    c.Data[<span class="string">"Pages"</span>] = pages</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><code>views/footer.tpl</code></p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;footer&gt;</span><br><span class="line">  &lt;div class="author"&gt;</span><br><span class="line">    demo Official website:</span><br><span class="line">    &lt;a href="http://{{.Website}}"&gt;{{.Website}}&lt;/a&gt; /</span><br><span class="line">    Contact me:</span><br><span class="line">    {{if eq .IsEmail 1}}</span><br><span class="line">      &lt;a class="email" href="mailto:{{.Email}}"&gt;{{.Email}}&lt;/a&gt;</span><br><span class="line">    {{else}}</span><br><span class="line">          &lt;a class="email" href="mailto:{{.Email}}"&gt;禁止显示&lt;/a&gt;</span><br><span class="line">    {{end}}</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/footer&gt;</span><br></pre></td></tr></tbody></table></figure>

<p><code>views/index.tpl</code></p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">  &lt;header&gt;</span><br><span class="line">    &lt;h1 class="logo"&gt;Welcome to Beego&lt;/h1&gt;</span><br><span class="line">    &lt;div class="description"&gt;</span><br><span class="line">      Beego is a simple &amp; powerful Go web framework which is inspired by tornado and sinatra.</span><br><span class="line">      {{range $index, $value := .Pages}}</span><br><span class="line">      &lt;br&gt;</span><br><span class="line">      {{$index}} - {{$value.Num}} of {{$.Website}}</span><br><span class="line">      {{end}}</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/header&gt;</span><br><span class="line">{{template "footer.tpl" .}}</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/05/31/beego/4.png" alt="description"></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/05/31/drf-yong-hu-shou-cang-jie-kou-shi-xian/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/31/drf-yong-hu-shou-cang-jie-kou-shi-xian/" class="post-title-link" itemprop="url">drf用户收藏接口实现</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-05-30 16:21:41" itemprop="dateCreated datePublished" datetime="2021-05-30T16:21:41Z">2021-05-30</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-06-07 10:34:25" itemprop="dateModified" datetime="2021-06-07T10:34:25Z">2021-06-07</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/django/" itemprop="url" rel="index"><span itemprop="name">django</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>用户点击收藏会创建一条收藏数据，用户再次点击一次，应该删除该条数据<br>设置user与good唯一索引验证：</p>
<p>法一<br>因为在<code>UserFavSerializer</code>中使用的是<code>ModelSerializer</code>，类似于Django的<code>ModelForm</code>，它需要满足model中配置的条件，model中配置了<code>unique_together = ['user', 'goods']</code>，当提交的数据不满足就会抛出异常。</p>
<p><code>user_operation/models.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserFav</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    <span class="string">'''用户收藏'''</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        <span class="comment"># 联合唯一验证，当数据已存在时，数据库就会抛出异常</span></span><br><span class="line">        unique_together = (<span class="string">'user'</span>, <span class="string">'goods'</span>)</span><br></pre></td></tr></tbody></table></figure>

<p>法二：<br>序列化验证器<code>UniqueTogetherValidator</code></p>
<h3 id="Advanced-field-defaults"><a href="#Advanced-field-defaults" class="headerlink" title="Advanced field defaults"></a>Advanced field defaults</h3><p>添加指定商品和当前用户到收藏，所以需要获取当前用户<br><a target="_blank" rel="noopener" href="https://www.django-rest-framework.org/api-guide/validators/#advanced-field-defaults">https://www.django-rest-framework.org/api-guide/validators/#advanced-field-defaults</a></p>
<p>Validators that are applied across multiple fields in the serializer can sometimes require a field input that should not be provided by the API client, but that is available as input to the validator.<br>在序列化器中跨多个字段应用的验证器有时可能需要一个字段输入，这个字段不应该由API客户机提供，但是可以作为验证器的输入。</p>
<p>Two patterns that you may want to use for this sort of validation include:<br>可能想要使用两种模式来进行这种验证:</p>
<ul>
<li><p>Using <code>HiddenField</code>. This field will be present in <code>validated_data</code> but will not be used in the serializer output representation.<br>使用<code>HiddenField</code>隐藏字段，该字段将出现在<code>validated_data</code>中，但序列化输出时不会显示出来</p>
</li>
<li><p>Using a standard field with <code>read_only=True</code>, but that also includes a <code>default=…</code> argument. This field will be used in the serializer output representation, but cannot be set directly by the user.<br>使用带有<code>read_only=True</code>的标准字段，但该字段也包含一个<code>default=…</code>参数。此字段将在序列化器输出表示中使用，但不能由用户直接设置。</p>
</li>
</ul>
<p>REST framework includes a couple of defaults that may be useful in this context.REST框架包含一些缺省值，这些缺省值在此上下文中可能很有用。</p>
<h4 id="CurrentUserDefault"><a href="#CurrentUserDefault" class="headerlink" title="CurrentUserDefault"></a><code>CurrentUserDefault</code></h4><p>A default class that can be used to represent the current user. In order to use this, the ‘request’ must have been provided as part of the context dictionary when instantiating the serializer.<br>可用于表示当前用户的默认类。为了使用它，在实例化序列化器时，request必须作为上下文字典的一部分提供</p>
<p><code>user_operation/serializers.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"><span class="keyword">from</span> rest_framework.validators <span class="keyword">import</span> UniqueTogetherValidator</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> UserFav</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserFavSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="string">"""序列化用户收藏数据"""</span></span><br><span class="line">    <span class="comment"># 获取当前登录用户，不可以选择其他用户</span></span><br><span class="line">    user = serializers.HiddenField(default=serializers.CurrentUserDefault())</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = UserFav</span><br><span class="line">        <span class="comment"># 收藏的时候需要返回商品的id，因为取消收藏的时候必须知道商品的id是多少</span></span><br><span class="line">        fields = [<span class="string">'id'</span>, <span class="string">'user'</span>, <span class="string">'goods'</span>]</span><br><span class="line">        <span class="comment"># UserFav items belong to a parent list, and have an ordering defined by the 'position' field.</span></span><br><span class="line">        <span class="comment"># No two items in a given list may share the same position.</span></span><br><span class="line">        <span class="comment"># UserFav项目属于父列表，并且有一个由“position”字段定义的顺序。给定列表中的任何两项不得共享同一位置。</span></span><br><span class="line">        validators = [  <span class="comment"># validate实现唯一联合，同一用户对同一商品只能收藏一次</span></span><br><span class="line">            UniqueTogetherValidator(</span><br><span class="line">                queryset=UserFav.objects.filter(is_delete=<span class="literal">False</span>),</span><br><span class="line">                fields=[<span class="string">'user'</span>, <span class="string">'goods'</span>],</span><br><span class="line">                message=<span class="string">'请勿重复收藏'</span>  <span class="comment"># message的信息可以自定义</span></span><br><span class="line">            )</span><br><span class="line">        ]</span><br></pre></td></tr></tbody></table></figure>

<p>按照商品的<code>id</code>显示收藏详情。可用性高，用户进入商品详情页，用户要去查询这个商品有没有被收藏，<br>在数据接口url中传入商品 goods_id去查询，<br>如果有记录，则页面就显示已收藏的信息，如果没被记录，表明商品没被收藏。<br>而不再是根据默认的UserFav收藏表的主键id进行查找，实现自己设置查询使用字段进行查询queryset对象</p>
<p><code>lookup_field</code>字段是在<code>get_queryset(self)</code>筛选过滤之后的结果进行查找，也就是过滤当前登录用户，保证了唯一性，所以不会出错。对于同一个商品，可能会被很多人收藏，但并不会造成查询出错，因为模型定义了商品和用户构成了联合唯一，过滤当前登录用户则对应的收藏商品唯一</p>
<p><code>user_operation/views.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> viewsets, mixins</span><br><span class="line"><span class="keyword">from</span> rest_framework.authentication <span class="keyword">import</span> SessionAuthentication</span><br><span class="line"><span class="keyword">from</span> rest_framework.permissions <span class="keyword">import</span> IsAuthenticated</span><br><span class="line"><span class="keyword">from</span> rest_framework_simplejwt.authentication <span class="keyword">import</span> JWTAuthentication</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> utils.permissions <span class="keyword">import</span> IsOwnerOrReadOnly</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> UserFav</span><br><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> UserFavSerializer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserFavViewSet</span>(<span class="params">mixins.CreateModelMixin, mixins.ListModelMixin, mixins.RetrieveModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                     mixins.DestroyModelMixin, viewsets.GenericViewSet</span>):</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    list:</span></span><br><span class="line"><span class="string">        用户收藏列表</span></span><br><span class="line"><span class="string">    create:</span></span><br><span class="line"><span class="string">        创建添加一条收藏记录</span></span><br><span class="line"><span class="string">    retrieve:</span></span><br><span class="line"><span class="string">        根据ID查询到用户收藏详情</span></span><br><span class="line"><span class="string">    destroy:</span></span><br><span class="line"><span class="string">        删除用户收藏</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    queryset = UserFav.objects.filter(is_delete=<span class="literal">False</span>)</span><br><span class="line">    <span class="comment"># IsAuthenticated：必须登录用户；IsOwnerOrReadOnly：必须是当前登录的用户</span></span><br><span class="line">    permission_classes = [IsAuthenticated, IsOwnerOrReadOnly]</span><br><span class="line">    serializer_class = UserFavSerializer</span><br><span class="line">    authentication_classes = [JWTAuthentication, SessionAuthentication]</span><br><span class="line">    lookup_field = <span class="string">'goods_id'</span>  <span class="comment"># 传入商品 goods_id去查询，而不再是根据默认的UserFav收藏表的主键id进行查找</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_queryset</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">"""只能查看当前登录用户的收藏，不会获取所有用户的收藏"""</span></span><br><span class="line">        <span class="keyword">return</span> UserFav.objects.filter(user=self.request.user, is_delete=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_serializer_class</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">'''动态设置序列化'''</span></span><br><span class="line">        <span class="keyword">if</span> self.action == <span class="string">'list'</span>:</span><br><span class="line">            <span class="keyword">return</span> UserFavDetailSerializer</span><br><span class="line">        <span class="keyword">elif</span> self.action == <span class="string">'create'</span>:</span><br><span class="line">            <span class="keyword">return</span> UserFavSerializer</span><br><span class="line">        <span class="keyword">return</span> UserFavSerializer</span><br></pre></td></tr></tbody></table></figure>

<p><code>url.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> user_operation.views <span class="keyword">import</span> UserFavViewSet</span><br><span class="line"></span><br><span class="line">router.register(<span class="string">'userfavs'</span>, UserFavViewSet)</span><br></pre></td></tr></tbody></table></figure>

<p>查看已收藏列表<br><img src="/2021/05/31/drf-yong-hu-shou-cang-jie-kou-shi-xian/1.png" alt="description"></p>
<p>选中一个商品，点击POST，这时候会向后台提交一个数据<br><img src="/2021/05/31/drf-yong-hu-shou-cang-jie-kou-shi-xian/2.png" alt="description"><br><img src="/2021/05/31/drf-yong-hu-shou-cang-jie-kou-shi-xian/3.png" alt="description"></p>
<p>查看一个已收藏详情<br><img src="/2021/05/31/drf-yong-hu-shou-cang-jie-kou-shi-xian/4.png" alt="description"></p>
<p>当某个商品已经存在收藏时再重复添加收藏，在两个及以上字段联合验证失败时返回错误信息的关键字段，前端在接收后可以进行相应处理<code>non_field_errors</code>，会提示自定义提示“请勿重复收藏”<br><img src="/2021/05/31/drf-yong-hu-shou-cang-jie-kou-shi-xian/5.png" alt="description"></p>
<p><code>non_field_errors</code>表示不能指定某一个字段的错误，而是多个字段造成的错误。可以在前端判断，如果出现<code>non_field_errors</code>字段，则表示整体的错误，不需要写在某个表单下面提示。</p>
<p>取消收藏前 <code>user_operation_userfav</code></p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">+<span class="comment">------------------+------------------+--------------------+</span></span><br><span class="line">| id  | add_time         | is_delete       | goods_id | user_id |</span><br><span class="line">+<span class="comment">------------------------------------------+---------------+-</span></span><br><span class="line">| 1   | 2021-05-31 15:31:54.767265  |  0   |   1   |   1      |</span><br><span class="line">| 2   | 2021-05-31 16:11:07.655320  |  0   |   4   |   1      |</span><br><span class="line">| 3   | 2021-05-31 16:11:22.720074  |  0   |  10   |   6      |</span><br><span class="line">| 8   | 2021-05-31 22:30:30.567272  |  0   |   2   |   1      |</span><br><span class="line">+<span class="comment">------------------------------------------+---------------+-</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></tbody></table></figure>

<p>取消收藏，例如取消商品goods_id=10</p>
<p><img src="/2021/05/31/drf-yong-hu-shou-cang-jie-kou-shi-xian/6.png" alt="description"><br><img src="/2021/05/31/drf-yong-hu-shou-cang-jie-kou-shi-xian/7.png" alt="description"></p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">+<span class="comment">------------------+------------------+--------------------+</span></span><br><span class="line">| id  | add_time          | is_delete    | goods_id | user_id |</span><br><span class="line">+<span class="comment">------------------------------------------+---------------+-</span></span><br><span class="line">| 1 | 2021-05-31 15:31:54.767265 |  0    |       1 | 1        |</span><br><span class="line">| 2 | 2021-05-31 16:11:07.655320 |  0    |       4 | 1        |</span><br><span class="line">| 8 | 2021-05-31 22:30:30.567272 |  0    |       2 | 1        |</span><br><span class="line">+<span class="comment">------------------------------------------+---------------+-</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></tbody></table></figure>

<p>第一次DELETE请求时返回信息204，说明删除成功，第二次再执行则返回未找到，再次印证删除成功。</p>
<h3 id="用户收藏商品详情"><a href="#用户收藏商品详情" class="headerlink" title="用户收藏商品详情"></a>用户收藏商品详情</h3><p>在前面已经写好了用户收藏和取消收藏商品的功能，访问 <a target="_blank" rel="noopener" href="http://127.0.0.1:8000/userfavs/">http://127.0.0.1:8000/userfavs/</a> 即可看到，但收藏的商品只显示了商品的id</p>
<p>显示商品的具体信息，首先还得做序列化。直接使用商品已做好的序列化类，也可以自己写，只显示所需要的信息。</p>
<p><code>user_operation/serializer.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> goods.serializers <span class="keyword">import</span> GoodsSerializer</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserFavDetailSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    用户收藏详情</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    <span class="comment"># 通过商品id而不是收藏表id获取收藏的商品，需要嵌套商品的序列化</span></span><br><span class="line">    goods = GoodsSerializer()</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = UserFav</span><br><span class="line">        fields = [<span class="string">'id'</span>, <span class="string">'goods'</span>]</span><br></pre></td></tr></tbody></table></figure>

<p>收藏商品和显示用户已收藏的商品使用了不同的序列化类，则也需要用到动态Serializer<br><code>user_operation/views.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> viewsets</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> mixins</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> UserFav</span><br><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> UserFavSerializer, UserFavDetailSerializer</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserFavViewSet</span>(<span class="params">mixins.CreateModelMixin, mixins.ListModelMixin, mixins.RetrieveModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                     mixins.DestroyModelMixin, viewsets.GenericViewSet</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    list:获取用户收藏商品列表</span></span><br><span class="line"><span class="string">    create:</span></span><br><span class="line"><span class="string">        添加一条用户收藏商品</span></span><br><span class="line"><span class="string">    retrieve:</span></span><br><span class="line"><span class="string">        根据商品ID获取用户收藏详情</span></span><br><span class="line"><span class="string">    destroy:</span></span><br><span class="line"><span class="string">        删除用户收藏商品</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    queryset = UserFav.objects.filter(is_delete=<span class="literal">False</span>)</span><br><span class="line">    <span class="comment"># IsAuthenticated：必须登录用户；IsOwnerOrReadOnly：必须是当前登录的用户</span></span><br><span class="line">    permission_classes = [IsAuthenticated, IsOwnerOrReadOnly]</span><br><span class="line">    authentication_classes = [JWTAuthentication, SessionAuthentication]</span><br><span class="line">    lookup_field = <span class="string">'goods_id'</span>  <span class="comment"># 单个模型实例的对象查找的模型字段，即查询单一数据库对象时使用的条件字段，默认为pk，即主键</span></span><br><span class="line">    <span class="comment"># 这样在数据接口中就可以直接传入商品id并根据该字段进行查询，</span></span><br><span class="line">    <span class="comment"># 而不再是根据UserFav的主键id进行查找，就到了自己设置查询使用字段的目的，可用性更高。</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_queryset</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># 只能查看当前登录用户的收藏，不会获取所有用户的收藏</span></span><br><span class="line">        <span class="keyword">return</span> UserFav.objects.filter(user=self.request.user, is_delete=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_serializer_class</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">'''不同的action使用不同的序列化'''</span></span><br><span class="line">        <span class="keyword">if</span> self.action == <span class="string">'list'</span>:</span><br><span class="line">            <span class="keyword">return</span> UserFavDetailSerializer</span><br><span class="line">        <span class="keyword">elif</span> self.action == <span class="string">'create'</span>:</span><br><span class="line">            <span class="keyword">return</span> UserFavSerializer</span><br><span class="line">        <span class="keyword">return</span> UserFavSerializer</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/05/31/drf-yong-hu-shou-cang-jie-kou-shi-xian/8.png" alt="description"><br><img src="/2021/05/31/drf-yong-hu-shou-cang-jie-kou-shi-xian/9.jpeg" alt="description"></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/05/31/drf-yong-hu-zhu-ce-he-biao-dan-deng-lu-token/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/31/drf-yong-hu-zhu-ce-he-biao-dan-deng-lu-token/" class="post-title-link" itemprop="url">drf用户注册和表单登录token</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-05-30 16:21:41" itemprop="dateCreated datePublished" datetime="2021-05-30T16:21:41Z">2021-05-30</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-06-07 06:35:05" itemprop="dateModified" datetime="2021-06-07T06:35:05Z">2021-06-07</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/django/" itemprop="url" rel="index"><span itemprop="name">django</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>注册接口成功</p>
<ol>
<li><p>正常返回，能浏览器代开对应路由，点击注册，弹框提示注册成功不点击确定，<br>F12开发者调试模式-localstore 有本地存储username token cart_count数据，<br>或者通过postman查看有没有生成token</p>
</li>
<li><p>服务器数据库生成数据</p>
</li>
</ol>
<h2 id="登录返回token"><a href="#登录返回token" class="headerlink" title="登录返回token"></a>登录返回token</h2><figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework_simplejwt.views <span class="keyword">import</span> (</span><br><span class="line">    TokenObtainPairView,</span><br><span class="line">    TokenRefreshView,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    <span class="comment"># simple jwt 认证接口</span></span><br><span class="line">    <span class="comment"># TokenObtainPairView是simple jwt的内置类</span></span><br><span class="line">    path(<span class="string">'api/token/'</span>, TokenObtainPairView.as_view(), name=<span class="string">'token_obtain_pair'</span>),</span><br><span class="line">    path(<span class="string">'api/token/refresh/'</span>, TokenRefreshView.as_view(), name=<span class="string">'token_refresh'</span>),</span><br><span class="line">    path(<span class="string">'login/'</span>, TokenObtainPairView.as_view(), name=<span class="string">'token_obtain_pair'</span>),</span><br><span class="line">]</span><br></pre></td></tr></tbody></table></figure>

<p>现在就可以登录了<br><img src="/2021/05/31/drf-yong-hu-zhu-ce-he-biao-dan-deng-lu-token/1.png" alt="description"><br><img src="/2021/05/31/drf-yong-hu-zhu-ce-he-biao-dan-deng-lu-token/2.png" alt="description"></p>
<p><img src="/2021/05/31/drf-yong-hu-zhu-ce-he-biao-dan-deng-lu-token/3.png" alt="description"><br><img src="/2021/05/31/drf-yong-hu-zhu-ce-he-biao-dan-deng-lu-token/10.png" alt="description"><br><img src="/2021/05/31/drf-yong-hu-zhu-ce-he-biao-dan-deng-lu-token/4.png" alt="description"></p>
<p><code>token</code> 和 <code>access</code> 是一样的，这里是为了前端获取方便换了个名字<br>返回了三个值：</p>
<p>refresh：刷新token，当前端token过期需要刷新token的时候就可以访问前边说的<code>api/token/refresh</code>url，<br>参数是原来的<code>refresh</code>的值。</p>
<p>access：这个就是<code>token</code>但是框架里叫做<code>access</code>。</p>
<p><code>apps\users\serializers.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyTokenObtainPairSerializer</span>(<span class="params">TokenObtainPairSerializer</span>):</span></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_token</span>(<span class="params">cls, user</span>):</span></span><br><span class="line">        token = super().get_token(user)</span><br><span class="line">        token[<span class="string">'name'</span>] = user.username  <span class="comment"># 因为程序可能运行在集群上，这里不写也可以</span></span><br><span class="line">        <span class="keyword">return</span> token</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate</span>(<span class="params">self, attrs</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        登录返回token和refresh</span></span><br><span class="line"><span class="string">        :param attrs:</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        data = super().validate(attrs)</span><br><span class="line">        <span class="comment"># access：这个就是`token`但是框架里叫做`access`</span></span><br><span class="line">        data[<span class="string">'token'</span>] = str(data[<span class="string">"access"</span>])  <span class="comment"># 给access新命名了一个值，方便前端获取：</span></span><br><span class="line">        <span class="keyword">return</span> data</span><br></pre></td></tr></tbody></table></figure>

<p><code>apps\users\views.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyTokenObtainPairView</span>(<span class="params">TokenObtainPairView</span>):</span></span><br><span class="line">    serializer_class = MyTokenObtainPairSerializer</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework_simplejwt.views <span class="keyword">import</span> (</span><br><span class="line">    TokenObtainPairView,</span><br><span class="line">    TokenRefreshView,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    <span class="comment"># simple jwt 认证接口</span></span><br><span class="line">    <span class="comment"># path('login/', TokenObtainPairView.as_view(), name='token_obtain_pair'),</span></span><br><span class="line">    path(<span class="string">'login/'</span>, MyTokenObtainPairView.as_view(), name=<span class="string">'token_obtain_pair'</span>),</span><br><span class="line">]</span><br></pre></td></tr></tbody></table></figure>

<h3 id="增加手机号登录验证功能"><a href="#增加手机号登录验证功能" class="headerlink" title="增加手机号登录验证功能"></a>增加手机号登录验证功能</h3><p>drf jwt默认验证的是username和password</p>
<p><code>apps\users\views.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib.auth <span class="keyword">import</span> get_user_model</span><br><span class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> Q</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth.backends <span class="keyword">import</span> ModelBackend</span><br><span class="line"></span><br><span class="line">User = get_user_model()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CustomBackend</span>(<span class="params">ModelBackend</span>):</span></span><br><span class="line">    <span class="string">"""自定义用户登录，可以使用用户名和手机登录，重写authenticate方法"""</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">authenticate</span>(<span class="params">self, request, username=None, password=None, **kwargs</span>):</span></span><br><span class="line">        <span class="comment"># print(request.data) 参考请求的其他数据</span></span><br><span class="line">        <span class="comment"># print(request.data['demo']) 比如说key是demo的数据用来做你要的数据校验</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 用户名和手机都能登录，没有做邮箱验证功能</span></span><br><span class="line">            user = User.objects.get(</span><br><span class="line">                Q(username=username) | Q(mobile=username))</span><br><span class="line">            <span class="keyword">if</span> user.check_password(password) <span class="keyword">and</span> user.is_delete != <span class="literal">True</span>:</span><br><span class="line">                <span class="keyword">return</span> user</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CustomBackend</span>(<span class="params">ModelBackend</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">authenticate</span>(<span class="params">self, request, username=None, password=None, **kwargs</span>):</span></span><br><span class="line">        <span class="comment"># print(request.data) 参考请求的其他数据</span></span><br><span class="line">        <span class="comment"># print(request.data['demo']) 比如说key是demo的数据用来做你要的数据校验</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                user = Users.objects.get(Q(username=username) | Q(mobile=username))</span><br><span class="line">            <span class="keyword">except</span> Exception:</span><br><span class="line">                <span class="keyword">raise</span> serializers.ValidationError({<span class="string">''</span>: <span class="string">'账号没有注册'</span>})</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> user.check_password(password):</span><br><span class="line">                <span class="keyword">return</span> user</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># 如果不想密码登录也可以验证码在这里写</span></span><br><span class="line">                <span class="comment"># 这里做验证码的操作</span></span><br><span class="line">                <span class="keyword">raise</span> serializers.ValidationError({<span class="string">''</span>: <span class="string">'密码错误'</span>})</span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">raise</span> e</span><br></pre></td></tr></tbody></table></figure>

<p><code>settings.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AUTHENTICATION_BACKENDS = (<span class="string">'users.views.CustomBackend'</span>,)  <span class="comment"># 指定认证后台</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="用户序列化user-serializer和验证器validator"><a href="#用户序列化user-serializer和验证器validator" class="headerlink" title="用户序列化user serializer和验证器validator"></a>用户序列化user serializer和验证器validator</h2><p><strong>注册就是将用户的数据POST到用户数据库，所以继承<code>CreateModelMixin</code></strong></p>
<p>用户注册需要填写手机号，验证码和密码，对应3个字段，需要定义视图并验证。<br>在Django中username字段为必填字段，DRF序列化只需要验证username满足即可，<br>将 UserProfile 中mobile字段作为username 使得username的手机号验证通过后，将手机号填入mobile中<br>设置可为空<code>blank=True, null=True</code>，如果不这样设置，后端做验证的时候就会提示mobile这个字段必填。</p>
<p>之前创建的admin用户没有设置mobile字段，现在设定一个手机号也可以登录<br>将传入的username字段的内容直接填充到mobile中<br>这个Serializer中直接继承<code>ModelSerializer</code>，</p>
<p>模型<code>UserProfile</code>中没有<code>code</code>字段，<br>在验证时为了判断验证码的正误而加入<code>code</code>这个字段，用于验证验证码是否正确，更新或创建实例反序列化包含自定义<code>code</code>字段，序列化时找不到<code>code</code>字段会出错，需要将字段的<code>write_only</code>设置<code>True</code>确保序列化表示形式时不包括该字段</p>
<p><code>users/serializers.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.validators <span class="keyword">import</span> UniqueValidator</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="string">'''用户注册序列化'''</span></span><br><span class="line">    code = serializers.CharField(required=<span class="literal">True</span>, write_only=<span class="literal">True</span>, max_length=<span class="number">4</span>, min_length=<span class="number">4</span>, label=<span class="string">'验证码'</span>,</span><br><span class="line">                                 error_messages={</span><br><span class="line">                                     <span class="string">"blank"</span>: <span class="string">"请输入验证码"</span>,</span><br><span class="line">                                     <span class="string">"required"</span>: <span class="string">"请输入验证码"</span>,</span><br><span class="line">                                     <span class="string">"max_length"</span>: <span class="string">"请输入4位验证码"</span>,</span><br><span class="line">                                     <span class="string">"min_length"</span>: <span class="string">"请输入4位验证码"</span></span><br><span class="line">                                 },</span><br><span class="line">                                 help_text=<span class="string">"验证码"</span>)</span><br><span class="line">    <span class="comment"># 验证用户名是否存在，如果已存在，则提示message中的内容</span></span><br><span class="line">    username = serializers.CharField(label=<span class="string">"用户名"</span>, help_text=<span class="string">"用户名"</span>, required=<span class="literal">True</span>, allow_blank=<span class="literal">False</span>,</span><br><span class="line">                                     validators=[</span><br><span class="line">                                         UniqueValidator(queryset=User.objects.filter(is_delete=<span class="literal">False</span>), message=<span class="string">"用户已经存在"</span>)])</span><br><span class="line">    <span class="comment"># 输入密码的时候不显示明文，注册成功不返回让password字段，也就是序列化时不包含该字段</span></span><br><span class="line">    password = serializers.CharField(</span><br><span class="line">        style={<span class="string">'input_type'</span>: <span class="string">'password'</span>}, label=<span class="string">"密码"</span>, write_only=<span class="literal">True</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate_code</span>(<span class="params">self, code</span>):</span></span><br><span class="line">        <span class="comment"># 验证验证码</span></span><br><span class="line">        <span class="comment"># 用户以post方式提交注册信息，前端post的数据都保存在initial_data里面</span></span><br><span class="line">        <span class="comment"># username就是用户注册的手机号，</span></span><br><span class="line">        <span class="comment"># 验证码按添加时间倒序排序，为了后面验证过期，错误等</span></span><br><span class="line">        verify_records = VerifyCode.objects.filter(mobile=self.initial_data[<span class="string">"username"</span>]).order_by(<span class="string">"-add_time"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> verify_records:  <span class="comment"># 验证验证码是否存在</span></span><br><span class="line">            <span class="comment"># 最近的一个验证码</span></span><br><span class="line">            last_record = verify_records[<span class="number">0</span>]</span><br><span class="line">            <span class="comment"># 获取5分钟以前的时间</span></span><br><span class="line">            five_mintes_ago = datetime.now() - timedelta(hours=<span class="number">0</span>, minutes=<span class="number">5</span>, seconds=<span class="number">0</span>)</span><br><span class="line">            <span class="keyword">if</span> five_mintes_ago &gt; last_record.add_time:</span><br><span class="line">                <span class="keyword">raise</span> serializers.ValidationError(<span class="string">"验证码过期"</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> last_record.code != code:</span><br><span class="line">                <span class="keyword">raise</span> serializers.ValidationError(<span class="string">"验证码错误"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> serializers.ValidationError(<span class="string">"验证码错误"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate</span>(<span class="params">self, attrs</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        作用于所有的字段</span></span><br><span class="line"><span class="string">        :param attrs: 所有字段验证合法之后返回的所有字段的dict</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="comment"># 人为设定前端传递到后端的手机号数据变量名为username而非mobile</span></span><br><span class="line">        <span class="comment"># 把`username`的值赋值给`mobile`的值。</span></span><br><span class="line">        attrs[<span class="string">"mobile"</span>] = attrs[<span class="string">"username"</span>]</span><br><span class="line">        <span class="comment"># code字段只是为了验证临时生成的、不需要保存到用户数据表中，因此在验证之后需要删除</span></span><br><span class="line">        <span class="keyword">del</span> attrs[<span class="string">"code"</span>]</span><br><span class="line">        <span class="keyword">return</span> attrs</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = User</span><br><span class="line">        fields = (<span class="string">'username'</span>, <span class="string">'code'</span>, <span class="string">'mobile'</span>, <span class="string">'password'</span>)</span><br></pre></td></tr></tbody></table></figure>

<p><code>users/views.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserViewSet</span>(<span class="params">CreateModelMixin, RetrieveModelMixin, UpdateModelMixin, viewsets.GenericViewSet</span>):</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    list:用户列表</span></span><br><span class="line"><span class="string">    create:</span></span><br><span class="line"><span class="string">        创建添加一用户，用户注册成功携带token登录</span></span><br><span class="line"><span class="string">    retrieve:</span></span><br><span class="line"><span class="string">        根据ID查询到用户详情</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    serializer_class = UserSerializer</span><br><span class="line">    queryset = User.objects.filter(is_delete=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="string">"""注册后自动登录需要携带token"""</span></span><br><span class="line">        serializer = self.get_serializer(data=request.data)</span><br><span class="line">        serializer.is_valid(raise_exception=<span class="literal">True</span>)</span><br><span class="line">        user = self.perform_create(serializer)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 添加自己的逻辑，手动生成token</span></span><br><span class="line">        refresh = RefreshToken.for_user(user)</span><br><span class="line"></span><br><span class="line">        tokens_for_user = {</span><br><span class="line">            <span class="string">'refresh'</span>: str(refresh),</span><br><span class="line">            <span class="comment"># 'access': str(refresh.access_token),  # 默认是</span></span><br><span class="line">            <span class="comment"># 数据定制化</span></span><br><span class="line">            <span class="string">'token'</span>: str(refresh.access_token),  <span class="comment"># 前端是token</span></span><br><span class="line">            <span class="string">'username'</span>: user.username,  <span class="comment"># 由于前端也需要传入username，需要将其加上。cookie.setCookie('name', response.data.username, 7);</span></span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        headers = self.get_success_headers(serializer.data)</span><br><span class="line">        <span class="keyword">return</span> Response(tokens_for_user, status=status.HTTP_201_CREATED, headers=headers)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">perform_create</span>(<span class="params">self, serializer</span>):</span></span><br><span class="line">        <span class="keyword">return</span> serializer.save()</span><br></pre></td></tr></tbody></table></figure>

<p><code>CreateModelMixin</code>源码</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CreateModelMixin</span>(<span class="params">object</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Create a model instance.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        serializer = self.get_serializer(data=request.data)</span><br><span class="line">        serializer.is_valid(raise_exception=<span class="literal">True</span>)</span><br><span class="line">        self.perform_create(serializer)</span><br><span class="line">        headers = self.get_success_headers(serializer.data)</span><br><span class="line">        <span class="keyword">return</span> Response(serializer.data, status=status.HTTP_201_CREATED, headers=headers)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">perform_create</span>(<span class="params">self, serializer</span>):</span></span><br><span class="line">        serializer.save()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_success_headers</span>(<span class="params">self, data</span>):</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> {<span class="string">'Location'</span>: str(data[api_settings.URL_FIELD_NAME])}</span><br><span class="line">        <span class="keyword">except</span> (TypeError, KeyError):</span><br><span class="line">            <span class="keyword">return</span> {}</span><br></pre></td></tr></tbody></table></figure>

<p>在生成<code>token</code>之前，<code>self.perform_create(serializer)</code>这个函数，他只是调用了<code>serializer.save()</code>，<br>因为要生成用户的token之前，必须要拿到user，所以这个函数也需要被重载。<br>原函数中只是调用<code>.save()</code>，并没有返回。实际上<code>serializer.save()</code>中的<code>serializer</code>就是<code>UserSerializer</code>中<code>model</code>的对象。<br>重载它，把它返回，才能得到user对象。</p>
<h3 id="新建用户，密码在数据库加密保存而不是明文存储"><a href="#新建用户，密码在数据库加密保存而不是明文存储" class="headerlink" title="新建用户，密码在数据库加密保存而不是明文存储"></a>新建用户，密码在数据库加密保存而不是明文存储</h3><p>法一：重载Create方法</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="string">'''用户注册序列化'''</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">self, validated_data</span>):</span></span><br><span class="line">        <span class="string">"""密码在数据库加密保存而不是明文存储"""</span></span><br><span class="line">        user = super(UserSerializer, self).create(validated_data=validated_data)</span><br><span class="line">        <span class="comment"># # UserProfile--&gt;AbstractUser--&gt;AbstractBaseUser中有个set_password(self, raw_password)方法</span></span><br><span class="line">        user.set_password(validated_data[<span class="string">"password"</span>])  <span class="comment"># user.set_password(validated_data['password'])  # 取出password密码，进行加密后保存</span></span><br><span class="line">        user.save()</span><br><span class="line">        <span class="keyword">return</span> user</span><br></pre></td></tr></tbody></table></figure>

<p>法二：同时创建Token<br>信号<br>[<a target="_blank" rel="noopener" href="https://docs.djangoproject.com/en/3.2/ref/signals/]">https://docs.djangoproject.com/en/3.2/ref/signals/]</a><br>其中一类信号是模型信号，django.db.models.signals模块定义了模型系统发送的一组信号，对模型进行操作后，Django会发出全局信号，捕捉到之后可以加入需要的业务逻辑，具体包括pre_init、post_init、pre_save和post_save等，这里我们使用post_save信号实现密码设置。</p>
<p><code>apps/users/signals.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib.auth <span class="keyword">import</span> get_user_model</span><br><span class="line"><span class="keyword">from</span> django.db.models.signals <span class="keyword">import</span> post_save</span><br><span class="line"><span class="keyword">from</span> django.dispatch <span class="keyword">import</span> receiver</span><br><span class="line"><span class="keyword">from</span> rest_framework.authtoken.models <span class="keyword">import</span> Token</span><br><span class="line"></span><br><span class="line">User = get_user_model()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@receiver(post_save, sender=User)</span></span><br><span class="line"><span class="comment"># post_save:接收信号的方式</span></span><br><span class="line"><span class="comment"># sender: 接收User这个Model传递过来的信号</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_user</span>(<span class="params">sender, instance=None, created=False, **kwargs</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    在传过来后，它需要确认是否是created新建数据，</span></span><br><span class="line"><span class="string">    如果是新建数据，才进行密码加密。</span></span><br><span class="line"><span class="string">    因为如果是update更新的时候也会传递post_save信号。</span></span><br><span class="line"><span class="string">    使用信号，代码分离性较强。</span></span><br><span class="line"><span class="string">    :param sender:</span></span><br><span class="line"><span class="string">    :param instance: 相当于user</span></span><br><span class="line"><span class="string">    :param created:是否新建，因为update的时候也会进行post_save</span></span><br><span class="line"><span class="string">    :param kwargs:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">if</span> created:</span><br><span class="line">        password = instance.password  <span class="comment"># instance指的就是创建的用户对象</span></span><br><span class="line">        instance.set_password(password)</span><br><span class="line">        instance.save()</span><br><span class="line">        <span class="comment"># Token.objects.create(user=instance)  # 用jwt而不是token</span></span><br></pre></td></tr></tbody></table></figure>

<p><code>users/apps.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.apps <span class="keyword">import</span> AppConfig</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UsersConfig</span>(<span class="params">AppConfig</span>):</span></span><br><span class="line">    default_auto_field = <span class="string">'django.db.models.BigAutoField'</span></span><br><span class="line">    name = <span class="string">'users'</span></span><br><span class="line">    verbose_name = <span class="string">"用户管理"</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">ready</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">import</span> users.signals</span><br></pre></td></tr></tbody></table></figure>

<p><code>url.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> users.views <span class="keyword">import</span> UserViewSet</span><br><span class="line"></span><br><span class="line">router.register(<span class="string">'users'</span>, UserViewset)</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/05/31/drf-yong-hu-zhu-ce-he-biao-dan-deng-lu-token/5.png" alt="description"><br><img src="/2021/05/31/drf-yong-hu-zhu-ce-he-biao-dan-deng-lu-token/6.png" alt="description"></p>
<p>token：这个是在序列化文件中给access新命名了一个值，<code>token</code> 和 <code>access</code> 是一样的，这里是为了前端获取方便换了个名字</p>
<p>测试接口</p>
<ul>
<li>输入已经存在的用户名</li>
<li>不输入验证码<br><img src="/2021/05/31/drf-yong-hu-zhu-ce-he-biao-dan-deng-lu-token/7.png" alt="description"></li>
</ul>
<p><img src="/2021/05/31/drf-yong-hu-zhu-ce-he-biao-dan-deng-lu-token/8.png" alt="description"><br><img src="/2021/05/31/drf-yong-hu-zhu-ce-he-biao-dan-deng-lu-token/11.png" alt="description"></p>
<ul>
<li>注册成功，返回注册信息，前端跳转到首页<br><img src="/2021/05/31/drf-yong-hu-zhu-ce-he-biao-dan-deng-lu-token/9.png" alt="description"><br><img src="/2021/05/31/drf-yong-hu-zhu-ce-he-biao-dan-deng-lu-token/12.png" alt="description"></li>
</ul>
<p>simple jwt获取token源码</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TokenObtainPairSerializer</span>(<span class="params">TokenObtainSerializer</span>):</span></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_token</span>(<span class="params">cls, user</span>):</span></span><br><span class="line">        <span class="keyword">return</span> RefreshToken.for_user(user)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate</span>(<span class="params">self, attrs</span>):</span></span><br><span class="line">        data = super().validate(attrs)</span><br><span class="line"></span><br><span class="line">        refresh = self.get_token(self.user)</span><br><span class="line"></span><br><span class="line">        data[<span class="string">'refresh'</span>] = str(refresh)</span><br><span class="line">        data[<span class="string">'access'</span>] = str(refresh.access_token)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> api_settings.UPDATE_LAST_LOGIN:</span><br><span class="line">            update_last_login(<span class="literal">None</span>, self.user)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> data</span><br></pre></td></tr></tbody></table></figure>

<h3 id="获取用户详细信息"><a href="#获取用户详细信息" class="headerlink" title="获取用户详细信息"></a>获取用户详细信息</h3><p>用户个人信息修改，因为手机号是验证过的，不能随便改<br>在会员中心页面，想要获取个人信息，只需在UserViewset中多继承一个类：mixins.RetrieveModelMixin</p>
<p>在用户注册时，因为用户还没有账号，会执行<code>create(request, *args, **kwargs)</code>和<code>perform_create(serializer)</code>方法，因此这些方法应该对所有用户开放，不进行验证；<br>而在用户注册之后，修改用户信息需要先获取用户信息，此时执行<code>get_object()</code>方法，因此需要对该方法进行权限验证。<br>所以不能采用原来的权限验证方法，即<code>permission_classes = [IsAuthenticated]</code>，而是需要动态设置权限，即重写<code>get_permissions()</code>方法；<br>除此之外，因为之前定义的用户序列化<code>UserSerializer</code>是针对用户注册功能的，虽然定义了<code>('username', 'mobile', 'code', 'password')</code>多个序列化字段，<br>但其中有两个配置了<code>write_only=True</code>属性，序列化将不会包括该字段。<br>而此时需要获取用户信息，包括name、gender、birthday、email等，<br>因此需要重新定义一个序列化类<code>UserDetailSerializer</code>，并且对于用户注册和获取信息，<br><code>UserViewSet</code>也需要实现动态设置序列化，即重写<code>get_serializer_class()</code>方法。</p>
<p><code>users/serializers.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserDetailSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="string">"""用户详情序列化"""</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = User</span><br><span class="line">        fields = (<span class="string">"name"</span>, <span class="string">"gender"</span>, <span class="string">"birthday"</span>, <span class="string">"email"</span>, <span class="string">"mobile"</span>)</span><br></pre></td></tr></tbody></table></figure>

<p>用户在进个人中心的时候，用户并不知道这个id，也就无法拼凑users/id/的url。<br>action只有使用了viewsets的好处，判断当前的动作是什么，例如POST、GET等。这里面的action的值对应mixins中的各种类方法名称</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserViewSet</span>(<span class="params">CreateModelMixin, RetrieveModelMixin, viewsets.GenericViewSet</span>):</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    list:用户列表</span></span><br><span class="line"><span class="string">    retrieve:</span></span><br><span class="line"><span class="string">        根据ID查询到用户详情</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    queryset = User.objects.filter(is_delete=<span class="literal">False</span>)</span><br><span class="line">    <span class="comment"># serializer_class = UserSerializer  # 改用get_serializer_class</span></span><br><span class="line">    <span class="comment"># permissions = [IsAuthenticated]  # 改用get_permissions</span></span><br><span class="line">    authentication_classes = [JWTAuthentication, SessionAuthentication]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_permissions</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        动态设置不同的action动作拥有不同的权限列表</span></span><br><span class="line"><span class="string">        1.用户注册的时候不应该有权限限制</span></span><br><span class="line"><span class="string">        2.当想获取用户详情信息的时候，必须登录才行</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> self.action == <span class="string">"retrieve"</span>:</span><br><span class="line">            <span class="keyword">return</span> [IsAuthenticated()]  <span class="comment"># 一定要加()表明返回它的实例</span></span><br><span class="line">        <span class="keyword">elif</span> self.action == <span class="string">"create"</span>:</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_serializer_class</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        动态设置不同的action动作拥有不同的序列化方式</span></span><br><span class="line"><span class="string">        1.UserSerializer（用户注册），只返回username和mobile，会员中心页面需要显示更多字段，</span></span><br><span class="line"><span class="string">        2.如果注册的使用创建一个UserDetailSerializer，又会导致验证失败，所以需要动态的使用serializer</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> self.action == <span class="string">"retrieve"</span>:</span><br><span class="line">            <span class="keyword">return</span> UserDetailSerializer  <span class="comment"># 返回类名，不需要实例化</span></span><br><span class="line">        <span class="keyword">elif</span> self.action == <span class="string">"create"</span>:</span><br><span class="line">            <span class="keyword">return</span> UserSerializer</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> UserDetailSerializer</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_object</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        Returns the object the view is displaying.返回视图显示的对象</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        You may want to override this if you need to provide non-standard</span></span><br><span class="line"><span class="string">        queryset lookups. 如果需要提供非标准的查询集查找，则可能需要重写此项</span></span><br><span class="line"><span class="string">        重写get_object方法，</span></span><br><span class="line"><span class="string">        继承了Retrieve获取用户详情和和DestroyModelMixin，</span></span><br><span class="line"><span class="string">        不管url传递id为多少，都只返回当前登录的用户</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">return</span> self.request.user</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/05/31/drf-yong-hu-zhu-ce-he-biao-dan-deng-lu-token/13.png" alt="description"><br><img src="/2021/05/31/drf-yong-hu-zhu-ce-he-biao-dan-deng-lu-token/14.png" alt="description"><br><img src="/2021/05/31/drf-yong-hu-zhu-ce-he-biao-dan-deng-lu-token/15.png" alt="description"><br><img src="/2021/05/31/drf-yong-hu-zhu-ce-he-biao-dan-deng-lu-token/16.png" alt="description"><br><img src="/2021/05/31/drf-yong-hu-zhu-ce-he-biao-dan-deng-lu-token/17.png" alt="description"></p>
<h3 id="用户个人信息修改"><a href="#用户个人信息修改" class="headerlink" title="用户个人信息修改"></a>用户个人信息修改</h3><p>在个人中心中可以修改姓名、出生日期、性别和电子邮件地址等，在修改之前，需要显示用户信息，所以需要定义获取用户信息的接口，并且需要进行权限验证，<br>只需要多添加一个继承<code>mixins.UpdateModelMixin</code>就可以了</p>
<p>url也不需要去配置，接受PUT（更新）、PATCH（部分更新）操作。</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserViewset</span>(<span class="params">UpdateModelMixin, viewsets.GenericViewSet</span>):</span></span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/05/31/drf-yong-hu-zhu-ce-he-biao-dan-deng-lu-token/17.png" alt="description"></p>
<hr>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings  <span class="comment"># 不要用相对导入的方式导入配置文件</span></span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> JsonResponse</span><br><span class="line"><span class="keyword">from</span> .model <span class="keyword">import</span> UserProfile</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_token</span>(<span class="params">username, expire=<span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span></span>):</span></span><br><span class="line">    <span class="string">"""生成 token，有效期一天"""</span></span><br><span class="line">    <span class="keyword">import</span> jwt</span><br><span class="line">    now = time.time()</span><br><span class="line">    key = settings.SECRET_KEY</span><br><span class="line">    payload = {<span class="string">'username'</span>: username, <span class="string">'exp'</span>: int(now + expire)}</span><br><span class="line">    token = jwt.encode(payload, key, algorithm=<span class="string">'HS256'</span>)  <span class="comment"># 生成str类型</span></span><br><span class="line">    <span class="keyword">return</span> token</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</span><br><span class="line">        <span class="comment"># 注册用户</span></span><br><span class="line">        data = request.body</span><br><span class="line">        json_obj = json.loads(data)</span><br><span class="line">        username = json_obj[<span class="string">'username'</span>]</span><br><span class="line">        email = json_obj[<span class="string">'email'</span>]</span><br><span class="line">        password = json_obj[<span class="string">'password'</span>]</span><br><span class="line">        phone = json_obj[<span class="string">'phone'</span>]</span><br><span class="line">        <span class="keyword">if</span> len(password) &lt; <span class="number">6</span>:</span><br><span class="line">            result = {<span class="string">'code'</span>: <span class="number">10100</span>, <span class="string">'error'</span>: <span class="string">'Password lenth is wrong'</span>}</span><br><span class="line">            <span class="keyword">return</span> JsonResponse(result)</span><br><span class="line">        <span class="comment"># 用户名是否可用；已注册的话给个错误返回</span></span><br><span class="line">        old_user = UserProfile.objects.filter()</span><br><span class="line">        <span class="keyword">if</span> old_user:</span><br><span class="line">            result = {<span class="string">'code'</span>: <span class="number">10101</span>, <span class="string">'error'</span>: <span class="string">'Your name is already existed'</span>}</span><br><span class="line">            <span class="keyword">return</span> JsonResponse(result)</span><br><span class="line">        <span class="comment"># 创建用户也避免同时注册相同名字，密码用md5</span></span><br><span class="line">        m = hashlib.md5()</span><br><span class="line">        m.update(password.encode())  <span class="comment"># 参数为bytes</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            user = UserProfile.objects.create(username=username, password=m.hexdigest(), email=email, phone=phone)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            result = {<span class="string">'code'</span>: <span class="number">10102</span>, <span class="string">'error'</span>: <span class="string">'Your name is used'</span>}</span><br><span class="line">            <span class="keyword">return</span> JsonResponse(result)</span><br><span class="line">        <span class="comment"># 用jwt签发token有效期1天, token里面存放username: xxxx</span></span><br><span class="line">        token = generate_token(username)</span><br><span class="line">        <span class="keyword">return</span> JsonResponse({<span class="string">'code'</span>: <span class="number">200</span>, <span class="string">'username'</span>: username, <span class="string">'data'</span>: {<span class="string">'token'</span>: token}, <span class="string">'cart_count'</span>: <span class="number">0</span>})</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="comment"># 登录验证</span></span><br><span class="line">    <span class="keyword">if</span> request.method != <span class="string">'POST'</span>:</span><br><span class="line">        result = {<span class="string">'code'</span>: <span class="number">10200</span>, <span class="string">'error'</span>: <span class="string">'Please send POST`s request'</span>}</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(result)</span><br><span class="line"></span><br><span class="line">    json_str = request.body</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> json_str:</span><br><span class="line">        result = {<span class="string">'code'</span>: <span class="number">10201</span>, <span class="string">'error'</span>: <span class="string">'Please give me data'</span>}</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(result)</span><br><span class="line"></span><br><span class="line">    json_obj = json.loads(json_str)  <span class="comment"># 转换为dict</span></span><br><span class="line"></span><br><span class="line">    username = json_obj.get(<span class="string">'username'</span>)</span><br><span class="line">    password = json_obj.get(<span class="string">'password'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> username:  <span class="comment"># 没有输入用户名提交</span></span><br><span class="line">        result = {<span class="string">'code'</span>: <span class="number">10202</span>, <span class="string">'error'</span>: <span class="string">'Please give me username'</span>}</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(result)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> password:  <span class="comment"># 没有输入密码提交</span></span><br><span class="line">        result = {<span class="string">'code'</span>: <span class="number">10203</span>, <span class="string">'error'</span>: <span class="string">'Please give me password'</span>}</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(result)</span><br><span class="line"></span><br><span class="line">    user = UserProfile.objects.filter(username=username)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> user:  <span class="comment"># 不存在的用户名提交</span></span><br><span class="line">        result = {<span class="string">'code'</span>: <span class="number">10204</span>, <span class="string">'error'</span>: <span class="string">'The username or password is wrong'</span>}</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(result)</span><br><span class="line"></span><br><span class="line">    user = user[<span class="number">0</span>]  <span class="comment"># user存在只有一个，因为加了unique唯一约束</span></span><br><span class="line">    <span class="comment"># 对比密码</span></span><br><span class="line">    p_m = hashlib.md5()  <span class="comment"># 生成md5对象</span></span><br><span class="line">    p_m.update(password.encode())</span><br><span class="line">    <span class="keyword">if</span> p_m.hexdigest() != user.password:</span><br><span class="line">        result = {<span class="string">'code'</span>: <span class="number">10205</span>, <span class="string">'error'</span>: <span class="string">'The username or password is wrong'</span>}</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(result)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 生成token</span></span><br><span class="line">    token = generate_token(username)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> JsonResponse({<span class="string">'code'</span>: <span class="number">200</span>, <span class="string">'username'</span>: username, <span class="string">'data'</span>: {<span class="string">'token'</span>: token}, <span class="string">'cart_count'</span>: <span class="number">0</span>})</span><br></pre></td></tr></tbody></table></figure>


<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/05/29/django-jie-ru-pian-yun-wang-duan-xin-yan-zheng-dan-tiao-fa-song/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/29/django-jie-ru-pian-yun-wang-duan-xin-yan-zheng-dan-tiao-fa-song/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-05-29 04:22:45" itemprop="dateCreated datePublished" datetime="2021-05-29T04:22:45Z">2021-05-29</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-06-01 13:59:37" itemprop="dateModified" datetime="2021-06-01T13:59:37Z">2021-06-01</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>django 接入片云片网</p>
<h2 id="云片网单条发送短信"><a href="#云片网单条发送短信" class="headerlink" title="云片网单条发送短信"></a>云片网单条发送短信</h2><p>在注册页面输入手机号发送验证码，后端需要有相应的接口来发送验证码，在成功和失败后需要进行相应的操作。<br>发送短信验证码需要使用第三方服务，可以使用云片网、阿里妈妈等平台的短信验证码服务，这里选择云片网。</p>
<p><a target="_blank" rel="noopener" href="https://www.yunpian.com/doc/zh_CN/domestic/single_send.html">https://www.yunpian.com/doc/zh_CN/domestic/single_send.html</a><br><a target="_blank" rel="noopener" href="https://www.yunpian.com/official/document/sms/zh_cn/domestic_single_send">https://www.yunpian.com/official/document/sms/zh_cn/domestic_single_send</a></p>
<p>（1）注册</p>
<p> “开发认证”–&gt;&gt;“签名管理”–&gt;&gt;“模板管理”<br>申请自己的签名和模板</p>
<p>在系统设置里面加入IP白名单，测试就用本地ip，部署的时候一定要换成服务器的ip</p>
<p>（2）发送验证码<br>请求参数中必传参数为apikey、mobile和text。</p>
<p>apps下新建<code>utils</code>包。再新建 <code>apps/utils/yunpian.py</code>，代码如下：</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">YunPian</span>(<span class="params">object</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, api_key</span>):</span></span><br><span class="line">        self.api_key = api_key</span><br><span class="line">        self.single_send_url = <span class="string">"https://sms.yunpian.com/v2/sms/single_send.json"</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">send_sms</span>(<span class="params">self, code, mobile</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        调用短信服务商API发送短信验证码</span></span><br><span class="line"><span class="string">        :param code: 验证码</span></span><br><span class="line"><span class="string">        :param mobile: 手机号码</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        parmas = {</span><br><span class="line">            <span class="string">"apikey"</span>: self.api_key,</span><br><span class="line">            <span class="string">"mobile"</span>: mobile,</span><br><span class="line">            <span class="comment"># 这个text的值要跟你模板内容一模一样</span></span><br><span class="line">            <span class="string">"text"</span>: <span class="string">"【慕雪生鲜超市】您的验证码是{code}。如非本人操作，请忽略本短信"</span>.format(code=code)</span><br><span class="line">        }</span><br><span class="line">        <span class="comment"># 发送post请求  请求的地址self.single_send_url  发送的数据data=params</span></span><br><span class="line">        response = requests.post(self.single_send_url, data=parmas)</span><br><span class="line">        <span class="comment"># response.text是json数据，把json数据转换成字典</span></span><br><span class="line">        re_dict = json.loads(response.text)</span><br><span class="line">        <span class="keyword">return</span> re_dict</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="comment"># 例如：9b11127a9701975c734b8aee81ee3526</span></span><br><span class="line">    yun_pian = YunPian(<span class="string">"2e87d17327d4be01608f7c6da23ecea2"</span>)  <span class="comment"># 改为你自己的apikey</span></span><br><span class="line">    yun_pian.send_sms(<span class="string">"2021"</span>, <span class="string">"13312345678"</span>)  <span class="comment"># 改为你自己的手机号</span></span><br></pre></td></tr></tbody></table></figure>

<p>运行该文件，打印：</p>
<figure class="highlight 1c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">{'code': <span class="number">0</span>, 'msg': '发送成功', 'count': <span class="number">1</span>, 'fee': <span class="number">0.05</span>, 'unit': 'RMB', 'mobile': '<span class="number">1331234567</span>8', 'sid': <span class="number">56592475448</span>}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="drf实现发送短信验证码接口"><a href="#drf实现发送短信验证码接口" class="headerlink" title="drf实现发送短信验证码接口"></a>drf实现发送短信验证码接口</h2><p>在发送短信验证码前需要进行验证，包括</p>
<ul>
<li>手机号是否合法</li>
<li>是否被注册</li>
<li>注册验证码发送频率</li>
</ul>
<p><code>settings.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 手机号码正则表达式</span></span><br><span class="line">REGEX_MOBILE = <span class="string">"^1[358]\d{9}$|^147\d{8}$|^176\d{8}$"</span></span><br></pre></td></tr></tbody></table></figure>

<p><code>users/serializers.py</code>中进行验证</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, timedelta</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth <span class="keyword">import</span> get_user_model</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> mxshop.settings <span class="keyword">import</span> REGEX_MOBILE</span><br><span class="line"><span class="keyword">from</span> users.models <span class="keyword">import</span> VerifyCode</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SmsSerializer</span>(<span class="params">serializers.Serializer</span>):</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    短信验证码序列化</span></span><br><span class="line"><span class="string">    不用ModelSerializer原因：发送验证码只需要提交手机号码</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    mobile = serializers.CharField(max_length=<span class="number">11</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 函数名必须：validate + 验证字段名</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate_mobile</span>(<span class="params">self, mobile</span>):</span></span><br><span class="line">        <span class="string">"""手机号码验证"""</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 验证手机是否注册</span></span><br><span class="line">        <span class="keyword">if</span> User.objects.filter(mobile=mobile).count():</span><br><span class="line">            <span class="keyword">raise</span> serializers.ValidationError(<span class="string">"用户已经存在"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 验证手机号码是否合法</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> re.match(REGEX_MOBILE, mobile):</span><br><span class="line">            <span class="keyword">raise</span> serializers.ValidationError(<span class="string">"手机号格式有误，请重新输入"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 验证码发送频率 60s内只能发送一次</span></span><br><span class="line">        one_mintes_ago = datetime.now() - timedelta(hours=<span class="number">0</span>, minutes=<span class="number">1</span>, seconds=<span class="number">0</span>)  <span class="comment"># 获取一分钟以前的时间</span></span><br><span class="line">        <span class="keyword">if</span> VerifyCode.objects.filter(add_time__gt=one_mintes_ago, mobile=mobile).count():</span><br><span class="line">            <span class="comment"># 如果添加时间大于一分钟以前的时间，则在这一分钟内已经发过短信，不允许再次发送</span></span><br><span class="line">            <span class="keyword">raise</span> serializers.ValidationError(<span class="string">"距离上一次发送未超过60s"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> mobile</span><br></pre></td></tr></tbody></table></figure>

<p>APIKEY加到<code>settings.py</code>里面</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 云片网APIKEY</span></span><br><span class="line">APIKEY = <span class="string">"xxxxx327d4be01608xxxxxxxxxx"</span></span><br></pre></td></tr></tbody></table></figure>

<p><code>apps/users/views.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.mixins <span class="keyword">import</span> CreateModelMixin</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> viewsets</span><br><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> SmsSerializer</span><br><span class="line"><span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> status</span><br><span class="line"><span class="keyword">from</span> utils.yunpian <span class="keyword">import</span> YunPian</span><br><span class="line"><span class="keyword">from</span> MxShop.settings <span class="keyword">import</span> APIKEY</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> choice</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> VerifyCode</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SmsCodeViewSet</span>(<span class="params">CreateModelMixin, viewsets.GenericViewSet</span>):</span></span><br><span class="line">    <span class="string">'''手机验证码'''</span></span><br><span class="line">    queryset = VerifyCode.objects.all()</span><br><span class="line">    serializer_class = SmsSerializer</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">generate_code</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">"""生成四位数字的验证码"""</span></span><br><span class="line">        seeds = <span class="string">"1234567890"</span></span><br><span class="line">        random_str = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">            random_str.append(choice(seeds))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span>.join(random_str)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="string">"""重写CreateModelMixin的create. Create a model instance."""</span></span><br><span class="line">        serializer = self.get_serializer(data=request.data)</span><br><span class="line">        <span class="comment"># 验证合法，出错就会抛出异常，由DRF捕捉返回400状态码，便于在前端查看。</span></span><br><span class="line">        serializer.is_valid(raise_exception=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">        mobile = serializer.validated_data[<span class="string">"mobile"</span>]  <span class="comment"># 直接取mobile，上方无异常，那么mobile字段肯定是有的</span></span><br><span class="line"></span><br><span class="line">        yun_pian = YunPian(APIKEY)</span><br><span class="line">        <span class="comment"># 生成验证码</span></span><br><span class="line">        code = self.generate_code()</span><br><span class="line"></span><br><span class="line">        sms_status = yun_pian.send_sms(code=code, mobile=mobile)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> sms_status[<span class="string">"code"</span>] != <span class="number">0</span>:  <span class="comment"># 云片发送短信成功返回0</span></span><br><span class="line">            <span class="keyword">return</span> Response({</span><br><span class="line">                <span class="string">"mobile"</span>: sms_status[<span class="string">"msg"</span>]</span><br><span class="line">            }, status=status.HTTP_400_BAD_REQUEST)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            code_record = VerifyCode(code=code, mobile=mobile)  <span class="comment"># 短信发送成功之后创建数据</span></span><br><span class="line">            code_record.save()  <span class="comment"># 保存到数据库</span></span><br><span class="line">            <span class="keyword">return</span> Response({</span><br><span class="line">                <span class="string">"mobile"</span>: mobile</span><br><span class="line">            }, status=status.HTTP_201_CREATED)</span><br></pre></td></tr></tbody></table></figure>

<p>CreateModelMixin源码</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CreateModelMixin</span>(<span class="params">object</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Create a model instance.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        serializer = self.get_serializer(data=request.data)</span><br><span class="line">        serializer.is_valid(raise_exception=<span class="literal">True</span>)</span><br><span class="line">        self.perform_create(serializer)</span><br><span class="line">        headers = self.get_success_headers(serializer.data)</span><br><span class="line">        <span class="keyword">return</span> Response(serializer.data, status=status.HTTP_201_CREATED, headers=headers)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">perform_create</span>(<span class="params">self, serializer</span>):</span></span><br><span class="line">        serializer.save()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_success_headers</span>(<span class="params">self, data</span>):</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> {<span class="string">'Location'</span>: str(data[api_settings.URL_FIELD_NAME])}</span><br><span class="line">        <span class="keyword">except</span> (TypeError, KeyError):</span><br><span class="line">            <span class="keyword">return</span> {}</span><br></pre></td></tr></tbody></table></figure>

<p><code>apps/utils/yunpian.py</code>，代码如下：</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> mx_shop.settings <span class="keyword">import</span> APIKEY</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">YunPian</span>(<span class="params">object</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, api_key</span>):</span></span><br><span class="line">        self.api_key = api_key</span><br><span class="line">        self.single_send_url = <span class="string">"https://sms.yunpian.com/v2/sms/single_send.json"</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">send_sms</span>(<span class="params">self, code, mobile</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        发送验证码</span></span><br><span class="line"><span class="string">        :param code: 验证码</span></span><br><span class="line"><span class="string">        :param mobile: 手机号码</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        parmas = {</span><br><span class="line">            <span class="string">"apikey"</span>: self.api_key,</span><br><span class="line">            <span class="string">"mobile"</span>: mobile,</span><br><span class="line">            <span class="comment"># 这个text的值要跟你模板内容一模一样</span></span><br><span class="line">            <span class="string">"text"</span>: <span class="string">"【慕雪生鲜超市】您的验证码是{code}。如非本人操作，请忽略本短信"</span>.format(code=code)</span><br><span class="line">        }</span><br><span class="line">        <span class="comment"># 发送post请求  请求的地址self.single_send_url  发送的数据data=params</span></span><br><span class="line">        response = requests.post(self.single_send_url, data=parmas)</span><br><span class="line">        <span class="comment"># response.text是json数据，把json数据转换成字典</span></span><br><span class="line">        re_dict = json.loads(response.text)</span><br><span class="line">        <span class="keyword">return</span> re_dict</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="comment"># 例如：9b11127a9701975c734b8aee81ee3526</span></span><br><span class="line">    yun_pian = YunPian(APIKEY)  <span class="comment"># 改为你自己的apikey</span></span><br><span class="line">    yun_pian.send_sms(<span class="string">"2021"</span>, <span class="string">"13312345678"</span>)  <span class="comment"># 改为你自己的手机号</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> users.views <span class="keyword">import</span> SmsCodeViewSet</span><br><span class="line"></span><br><span class="line">router = DefaultRouter()  <span class="comment"># 生成一个实例对象</span></span><br><span class="line"><span class="comment"># 配置短信验证码的路由</span></span><br><span class="line">router.register(<span class="string">'codes'</span>, SmsCodeViewSet)</span><br></pre></td></tr></tbody></table></figure>

<p>开始验证</p>
<p>输入不合法的手机号<br><img src="/2021/05/29/django-jie-ru-pian-yun-wang-duan-xin-yan-zheng-dan-tiao-fa-song/1.png" alt="description"></p>
<p> 输入合法的手机号<br><img src="/2021/05/29/django-jie-ru-pian-yun-wang-duan-xin-yan-zheng-dan-tiao-fa-song/2.png" alt="description"><br>返回输入的手机号码，并受到短信验证码，同时在数据库中也会保存该验证码的内容。</p>
<p>此时查看数据库，可以看到刚刚保存的验证码如下：</p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">+<span class="comment">----+------+-------------+----------------------------+-----------+</span></span><br><span class="line">| id | code | mobile      | add_time                   | is_delete |</span><br><span class="line">+<span class="comment">----+------+-------------+----------------------------+-----------+</span></span><br><span class="line">|  1 | 4745 | 13311111111 | 2020-07-28 17:10:38.142213 |         0 |</span><br><span class="line">+<span class="comment">----+------+-------------+----------------------------+-----------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></tbody></table></figure>

<p>测试注册接口自己添加验证码数据</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/27/">27</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>
<script src="/js/comments.js"></script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">外心人D</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
