<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.0.2">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"bubbleboy11.github.io","root":"/","images":"/images","scheme":"Muse","version":"8.6.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>
<meta name="description" content="本博客大多内容为慕课和网上博客，并非原创">
<meta property="og:type" content="website">
<meta property="og:title" content="外心人D的博客">
<meta property="og:url" content="https://bubbleboy11.github.io/index.html">
<meta property="og:site_name" content="外心人D的博客">
<meta property="og:description" content="本博客大多内容为慕课和网上博客，并非原创">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="外心人D">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://bubbleboy11.github.io/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>外心人D的博客</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="外心人D的博客" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism.css" type="text/css"></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">外心人D的博客</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-overview">
            <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">外心人D</p>
  <div class="site-description" itemprop="description">本博客大多内容为慕课和网上博客，并非原创</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">357</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">22</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">39</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



          </div>
        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/09/28/rpc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/09/28/rpc/" class="post-title-link" itemprop="url">RPC</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-09-27 16:21:41" itemprop="dateCreated datePublished" datetime="2021-09-27T16:21:41Z">2021-09-27</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-09-29 04:34:09" itemprop="dateModified" datetime="2021-09-29T04:34:09Z">2021-09-29</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>RPC（Remote Procedure Call）远程过程调用</p>
<p>通俗地说就是调用远处的一个函数。远处到底有多远呢？可能是同一个文件内的不同函数，也可能是同一个机器的另一个进程的函数，还可能是远在火星好奇号上面的某个秘密方法。因为RPC涉及的函数可能非常之远，远到它们之间说着完全不同的语言，语言就成了两边的沟通障碍。而Protobuf因为支持多种不同的语言（甚至不支持的语言也可以扩展支持），其本身特性也非常方便描述服务的接口（也就是方法列表），因此非常适合作为RPC世界的接口交流语言。本章将讨论RPC的基本用法，如何针对不同场景设计自己的RPC服务，以及围绕Protobuf构造的更为庞大的RPC生态。</p>
<p>简单的理解是一个节点请求另一个节点提供的服务<br>对应rpc的是本地过程调用，函数调用是最常见的本地过程调用<br>将本地过程调用变成远程过程调用会面临各种问题</p>
<p>远程过程调用带来的新问题<br>在远程调用时，我们需要执行原本的本地函数体是在远程的服务器机器上去运行，也就是说，add是在另一个进程中执行的。这就带来了几个新问题：</p>
<ol>
<li>Call ID映射。我们怎么告诉远程机器我们要调用add，而不是sub或者Foo呢？在本地调用中，函数体是直接通过函数指针来指定的，我们调用add，编译器就自动帮我们调用它相应的函数指针。但是在远程调用中，函数指针是不行的，因为两个进程的地址空间是完全不一样的。所以，在RPC中，所有的函数都必须有自己的一个ID。这个ID在所有进程中都是唯一确定的。客户端在做远程过程调用时，必须附上这个ID。然后我们还需要在客户端和服务端分别维护一个 {函数 &lt;–&gt; Call ID} 的对应表。两者的表不一定需要完全相同，但相同的函数对应的Call ID必须相同。当客户端需要进行远程调用时，它就查一下这个表，找出相应的Call ID，然后把它传给服务端，服务端也通过查表，来确定客户端需要调用的函数，然后执行相应函数的代码。</li>
<li>序列化和反序列化。客户端怎么把参数值传给远程的函数呢？在本地调用中，我们只需要把参数压到栈里，然后让函数自己去栈里读就行。但是在远程过程调用时，客户端跟服务端是不同的进程，不能通过内存来传递参数。甚至有时候客户端和服务端使用的都不是同一种语言（比如服务端用C++，客户端用Java或者Python）。这时候就需要客户端把参数先转成一个字节流，传给服务端后，再把字节流转成自己能读取的格式。这个过程叫序列化和反序列化。同理，从服务端返回的值也需要序列化反序列化的过程。</li>
<li>网络传输。远程调用往往用在网络上，客户端和服务端是通过网络连接的。所有的数据都需要通过网络传输，因此就需要有一个网络传输层。网络传输层需要把Call ID和序列化后的参数字节流传给服务端，然后再把序列化后的调用结果传回客户端。只要能完成这两者的，都可以作为传输层使用。因此，它所使用的协议其实是不限的，能完成传输就行。尽管大部分RPC框架都使用TCP协议，但其实UDP也可以，而gRPC干脆就用了HTTP2。Java的Netty也属于这层的东西。</li>
</ol>
<p>解决了上面三个机制，就能实现RPC了，具体过程如下：<br>client端解决的问题：</p>
<ol>
<li>将这个调用映射为Call ID。这里假设用最简单的字符串当Call ID的方法</li>
<li>将Call ID，a和b序列化。可以直接将它们的值以二进制形式打包</li>
<li>把2中得到的数据包发送给ServerAddr，这需要使用网络传输层</li>
<li>等待服务器返回结果</li>
<li>如果服务器调用成功，那么就将结果反序列化，并赋给total<br>server端解决的问题</li>
<li>在本地维护一个Call ID到函数指针的映射call_id_map，可以用dict完成</li>
<li>等待请求，包括多线程的并发处理能力</li>
<li>得到一个请求后，将其数据包反序列化，得到Call ID</li>
<li>通过在call_id_map中查找，得到相应的函数指针</li>
<li>将a和rb反序列化后，在本地调用add函数，得到结果</li>
<li>将结果序列化后通过网络返回给Client<br>在上面的整个流程中，估计有部分同学看到了熟悉的计算机网络的流程和web服务器的定义。<br>所以要实现一个RPC框架，其实只需要按以上流程实现就基本完成了。</li>
</ol>
<p>其中：<br>● Call ID映射可以直接使用函数字符串，也可以使用整数ID。映射表一般就是一个哈希表。<br>● 序列化反序列化可以自己写，也可以使用Protobuf或者FlatBuffers之类的。<br>● 网络传输库可以自己写socket，或者用asio，ZeroMQ，Netty之类。</p>
<p>实际上真正的开发过程中，除了上面的基本功能以外还需要更多的细节：网络错误、流量控制、超时和重试等。</p>
<p>最后提一个问题： 如何将远程的这些过程写出本地函数调用的感觉来</p>
<p>RPC 和 REST 区别是什么？<br>你一定会觉得这个问题很奇怪，是的，包括我，但是你在网络上一搜，会发现类似对比的文章比比皆是，我在想可能很多初学者由于基础不牢固，才会将不相干的二者拿出来对比吧。既然是这样，那为了让你更加了解陌生的RPC，就从你熟悉得不能再熟悉的 REST 入手吧。</p>
<p>REST，是Representational State Transfer 的简写，中文描述表述性状态传递（是指某个瞬间状态的资源数据的快照，包括资源数据的内容、表述格式(XML、JSON)等信息。）</p>
<p>REST 是一种软件架构风格。这种风格的典型应用，就是HTTP。其因为简单、扩展性强的特点而广受开发者的青睐。</p>
<p>而RPC 呢，是 Remote Procedure Call Protocol 的简写，中文描述是远程过程调用，它可以实现客户端像调用本地服务(方法)一样调用服务器的服务(方法)。</p>
<p>而 RPC 可以基于 TCP/UDP，也可以基于 HTTP 协议进行传输的，按理说它和REST不是一个层面意义上的东西，不应该放在一起讨论，但是谁让REST这么流行呢，它是目前最流行的一套互联网应用程序的API设计标准，某种意义下，我们说 REST 可以其实就是指代 HTTP 协议。</p>
<p>2、使用方式不同<br>从使用上来看，HTTP 接口只关注服务提供方，对于客户端怎么调用并不关心。接口只要保证有客户端调用时，返回对应的数据就行了。而RPC则要求客户端接口保持和服务端的一致。</p>
<p>REST 是服务端把方法写好，客户端并不知道具体方法。客户端只想获取资源，所以发起HTTP请求，而服务端接收到请求后根据URI经过一系列的路由才定位到方法上面去RPC是服务端提供好方法给客户端调用，客户端需要知道服务端的具体类，具体方法，然后像调用本地方法一样直接调用它。</p>
<p>3、面向对象不同<br>从设计上来看，RPC，所谓的远程过程调用 ，是面向方法的 ，REST：所谓的 Representational state transfer ，是面向资源的，除此之外，还有一种叫做 SOA，所谓的面向服务的架构，它是面向消息的，这个接触不多，就不多说了。</p>
<p>4、序列化协议不同<br>接口调用通常包含两个部分，序列化和通信协议。</p>
<p>通信协议，上面已经提及了，REST 是 基于 HTTP 协议，而 RPC 可以基于 TCP/UDP，也可以基于 HTTP 协议进行传输的。</p>
<p>常见的序列化协议，有：json、xml、hession、protobuf、thrift、text、bytes等，REST 通常使用的是 JSON或者XML，而 RPC 使用的是 JSON-RPC，或者 XML-RPC。</p>
<p>通过以上几点，我们知道了 REST 和 RPC 之间有很明显的差异。</p>
<p>然后第二个问题：为什么要采用RPC呢？</p>
<p>那到底为何要使用 RPC，单纯的依靠RESTful API不可以吗？为什么要搞这么多复杂的协议，渣渣表示真的学不过来了。</p>
<p>关于这一点，以下几点仅是我的个人猜想，仅供交流哈：</p>
<p>RPC 和 REST 两者的定位不同，REST 面向资源，更注重接口的规范，因为要保证通用性更强，所以对外最好通过 REST。而 RPC 面向方法，主要用于函数方法的调用，可以适合更复杂通信需求的场景。RESTful API客户端与服务端之间采用的是同步机制，当发送HTTP请求时，客户端需要等待服务端的响应。当然对于这一点是可以通过一些技术来实现异步的机制的。采用RESTful API，客户端与服务端之间虽然可以独立开发，但还是存在耦合。比如，客户端在发送请求的时，必须知道服务器的地址，且必须保证服务器正常工作。而 rpc + ralbbimq中间件可以实现低耦合的分布式集群架构。说了这么多，我们该如何选择这两者呢？我总结了如下两点，供你参考：</p>
<p>REST 接口更加规范，通用适配性要求高，建议对外的接口都统一成 REST。而组件内部的各个模块，可以选择 RPC，一个是不用耗费太多精力去开发和维护多套的HTTP接口，一个RPC的调用性能更高（见下条）从性能角度看，由于HTTP本身提供了丰富的状态功能与扩展功能，但也正由于HTTP提供的功能过多，导致在网络传输时，需要携带的信息更多，从性能角度上讲，较为低效。而RPC服务网络传输上仅传输与业务内容相关的数据，传输数据更小，性能更高。</p>
<h3 id="为什么一定要rpc，不能只学http协议和restful协议吗？"><a href="#为什么一定要rpc，不能只学http协议和restful协议吗？" class="headerlink" title="为什么一定要rpc，不能只学http协议和restful协议吗？"></a>为什么一定要rpc，不能只学http协议和restful协议吗？</h3><ol>
<li><p>rpc可以基于tcp直接开发自己的协议，这个是可以保持长连接的，tcp的传输效率高，并且可以一直维持链接</p>
</li>
<li><p>自定义协议可以优化数据的传输</p>
</li>
</ol>
<p>如果我们只是开发web网站或者一些服务的使用者， 那么我们用restful看起来已经足够了，但是rpc的这种模式在大量的服务中都有，比如redis协议， rabbitmq的AMQP协议， 聊天软件的协议，也就是说我们想要开发一个redis的客户端，我们只需要用我们喜欢的语言实现redis定义的协议就行了，这对于开发服务来说非常有用，一般这种协议的价值在于我们自己开发的服务之间需要通信的时候 - 那你会问了，自己开发的组件之间协作，直接调用函数不就行了吗？ - 对了，有些人已经反映过来了 – 分布式系统，分布式系统中非常常用， 比如openstack中。 还有就是微服务！</p>
<p>所以掌握rpc开发，对于进阶和分布式开发就变得非常重要。</p>
<p>http协议1.x一般情况下一个来回就关闭连接，虽然提供了keep-alive可以保持长连接，但是依然不方便，所以就出现了http2.0， http2.0基本上可以当做tcp协议使用了。所以后面讲解到的grpc就会使用http2.0开发</p>
<h3 id="通过httpserver实现"><a href="#通过httpserver实现" class="headerlink" title="通过httpserver实现"></a>通过httpserver实现</h3><p>rpc首先一点需要明确：一定会发起一个网络请求，一定会有个网络连接(tcp/udp)</p>
<p>把远程的函数变成一个http请求</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlparse, parse_qsl</span><br><span class="line"><span class="keyword">from</span> http.server <span class="keyword">import</span> HTTPServer, BaseHTTPRequestHandler</span><br><span class="line"></span><br><span class="line">host = (<span class="string">''</span>, <span class="number">8003</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将url映射到对应的函数 urlconfig route call id的映射</span></span><br><span class="line"><span class="comment"># 反序列化</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AddHandler</span>(<span class="params">BaseHTTPRequestHandler</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">do_GET</span>(<span class="params">self</span>):</span></span><br><span class="line">        parsed_url = urlparse(self.path)</span><br><span class="line">        qs = dict(parse_qsl(parsed_url.query))</span><br><span class="line">        a = int(qs.get(<span class="string">"a"</span>, <span class="number">0</span>))</span><br><span class="line">        b = int(qs.get(<span class="string">"b"</span>, <span class="number">0</span>))</span><br><span class="line">        self.send_response(<span class="number">200</span>)</span><br><span class="line">        self.send_header(<span class="string">"content-type"</span>, <span class="string">"application/json"</span>)</span><br><span class="line">        self.end_headers()</span><br><span class="line">        self.wfile.write(json.dumps({</span><br><span class="line">            <span class="string">"result"</span>:a+b</span><br><span class="line">        }).encode(<span class="string">"utf-8"</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    server = HTTPServer(host, AddHandler)</span><br><span class="line">    print(<span class="string">"Starting server, listen at: %s:%s"</span> % host)</span><br><span class="line">    server.serve_forever()</span><br></pre></td></tr></tbody></table></figure>

<p>本地调用</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">a, b</span>):</span></span><br><span class="line">    <span class="keyword">return</span> a+b</span><br><span class="line"></span><br><span class="line">print(add(<span class="number">1</span>+<span class="number">2</span>))</span><br></pre></td></tr></tbody></table></figure>

<p>总结说来，本地程序调用的过程大致可以分为几个步骤和阶段：<br>● 开发者开发好的程序，并进行编译，编译成机器认可的可执行文件。<br>● 运行可执行文件，调用对应的功能方法，期间会读取可执行文件中的机器指令，进行入栈，出栈赋值等操作。此时，计算机由可执行程序所在的进程控制。<br>● 调用结束，所有的内存数据出栈，程序执行结束。计算机继续由操作系统进行控制。</p>
<p>远程过程调用是在两台或者多台不同的物理机器上实现的调用，其间要跨越网络进行调用。因此，我们再想通过前文本地方法调用的形式完成功能调用，就无法实现了，因为编译器无法通过编译的可执行文件来调用远程机器上的程序方法。因此需要采用RPC的方式来实现远端服务器上的程序方法的调用。<br>RPC技术内部原理是通过两种技术的组合来实现的：<strong>本地方法调用 和 网络通信技术</strong>。<br><strong>如果想要做到不用url来确定调用方法和参数怎么办？</strong></p>
<p>改进一下client的代码</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="comment"># 自己实现了一个demo级别的rpc封装 代理</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ClientStub</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, url</span>):</span></span><br><span class="line">        self.url = url</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">self, a, b</span>):</span></span><br><span class="line">        <span class="comment"># 1. call id</span></span><br><span class="line">        <span class="comment"># 2. 序列化和反序列化</span></span><br><span class="line">        <span class="comment"># 3. 传输协议 http</span></span><br><span class="line">        rsp = requests.get(<span class="string">f"<span class="subst">{self.url}</span>/?a=<span class="subst">{a}</span>&amp;b=<span class="subst">{b}</span>"</span>)</span><br><span class="line">        <span class="keyword">return</span> json.loads(rsp.text).get(<span class="string">"result"</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># def add(self, a, b):</span></span><br><span class="line">    <span class="comment">#     payload = {</span></span><br><span class="line">    <span class="comment">#         "method": "add",</span></span><br><span class="line">    <span class="comment">#         "params": [a, b],</span></span><br><span class="line">    <span class="comment">#         "jsonrpc": "2.0",</span></span><br><span class="line">    <span class="comment">#         "id": 0,</span></span><br><span class="line">    <span class="comment">#     }</span></span><br><span class="line">    <span class="comment">#     response = requests.post(self.url, json=payload).json()</span></span><br><span class="line">    <span class="comment">#     print(response)</span></span><br><span class="line">    <span class="comment">#     return response["result"]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#这不是就是写一个web服务器 无非就是自己封装一下client</span></span><br><span class="line"><span class="comment">#不想知道过多的细节 只想像本地一样调用</span></span><br><span class="line">client = ClientStub(<span class="string">"http://127.0.0.1:8003"</span>)</span><br><span class="line">print(client.add(<span class="number">1</span>, <span class="number">2</span>))</span><br><span class="line">print(client.add(<span class="number">2</span>, <span class="number">3</span>))</span><br><span class="line">print(client.add(<span class="number">22</span>, <span class="number">33</span>))</span><br></pre></td></tr></tbody></table></figure>

<p>从上面的代码我们关注几点：</p>
<ol>
<li>通信使用了json，所以json中的内容应该如何写就成为了一种协议</li>
<li>要想实现远程调用必须要要有网络连接</li>
<li>上面通过http连接，可以发现客户端和服务器端之间可以独立，实际上除了通过json以外还可以通过xml作为数据格式</li>
<li>rpc不应该和http拿来比较</li>
<li>rpc也不应该和restful拿来比较，我们完全可以把上述代码通过client和server端的封装将rpc编程基于restful来实现</li>
<li>rpc可以理解为一种调用风格，具体实现可以随意写，至于底层是走tcp协议还是http协议看需求</li>
</ol>
<p>rpc开发的四大要素<br>RPC技术在架构设计上有四部分组成，分别是：客户端、客户端存根、服务端、服务端存根。</p>
<p><strong>客户端(Client)：</strong>服务调用发起方，也称为服务消费者。<br><strong>客户端存根(Client  Stub)：</strong>该程序运行在客户端所在的计算机机器上，主要用来存储要调用的服务器的地址，另外，该程序还负责将客户端请求远端服务器程序的数据信息打包成数据包，通过网络发送给服务端Stub程序；其次，还要接收服务端Stub程序发送的调用结果数据包，并解析返回给客户端。<br><strong>服务端(Server)：</strong>远端的计算机机器上运行的程序，其中有客户端要调用的方法。<br><strong>服务端存根(Server Stub)：</strong>接收客户Stub程序通过网络发送的请求消息数据包，并调用服务端中真正的程序功能方法，完成功能调用；其次，将服务端执行调用的结果进行数据处理打包发送给客户端Stub程序。</p>
<p>了解完了RPC技术的组成结构我们来看一下具体是如何实现客户端到服务端的调用的。实际上，如果我们想要在网络中的任意两台计算机上实现远程调用过程，要解决很多问题，比如：</p>
<ul>
<li>两台物理机器在网络中要建立稳定可靠的通信连接。</li>
<li>两台服务器的通信协议的定义问题，即两台服务器上的程序如何识别对方的请求和返回结果。也就是说两台计算机必须都能够识别对方发来的信息，并且能够识别出其中的请求含义和返回含义，然后才能进行处理。这其实就是通信协议所要完成的工作。<br>图片.png</li>
</ul>
<p>RPC原理图客户端(Client)服务端(server)10客户端Stub服务端Stubsocket通信Socket通信服务提供端请求发起端</p>
<p>在上述图中，通过1-10的步骤图解的形式，说明了RPC每一步的调用过程。具体描述为：</p>
<p>1、客户端想要发起一个远程过程调用，首先通过调用本地客户端Stub程序的方式调用想要使用的功能方法名；<br>2、客户端Stub程序接收到了客户端的功能调用请求，将客户端请求调用的方法名，携带的参数等信息做序列化操作，并打包成数据包。<br>3、客户端Stub查找到远程服务器程序的IP地址，调用Socket通信协议，通过网络发送给服务端。<br>4、服务端Stub程序接收到客户端发送的数据包信息，并通过约定好的协议将数据进行反序列化，得到请求的方法名和请求参数等信息。<br>5、服务端Stub程序准备相关数据，调用本地Server对应的功能方法进行，并传入相应的参数，进行业务处理。<br>6、服务端程序根据已有业务逻辑执行调用过程，待业务执行结束，将执行结果返回给服务端Stub程序。<br>7、服务端Stub程序<strong>将程序调用结果按照约定的协议进行序列化，</strong>并通过网络发送回客户端Stub程序。<br>8、客户端Stub程序接收到服务端Stub发送的返回数据，<strong>对数据进行反序列化操作，</strong>并将调用返回的数据传递给客户端请求发起者。<br>9、客户端请求发起者得到调用结果，整个RPC调用过程结束。</p>
<p>rpc需要使用到的术语</p>
<p>通过上文一系列的文字描述和讲解，我们已经了解了RPC的由来和RPC整个调用过程。我们可以看到RPC是一系列操作的集合，其中涉及到很多对数据的操作，以及网络通信。因此，我们对RPC中涉及到的技术做一个总结和分析：</p>
<p>1、动态代理技术： 上文中我们提到的Client Stub和Sever Stub程序，在具体的编码和开发实践过程中，都是使用动态代理技术自动生成的一段程序。<br>2、序列化和反序列化：  在RPC调用的过程中，我们可以看到数据需要在一台机器上传输到另外一台机器上。在互联网上，所有的数据都是以字节的形式进行传输的。而我们在编程的过程中，往往都是使用数据对象，因此想要在网络上将数据对象和相关变量进行传输，就需要对数据对象做序列化和反序列化的操作。<br><strong>序列化：</strong>把对象转换为字节序列的过程称为对象的序列化，也就是编码的过程。<br><strong>反序列化：</strong>把字节序列恢复为对象的过程称为对象的反序列化，也就是解码的过程。<br>我们常见的Json,XML等相关框架都可以对数据做序列化和反序列化编解码操作。后面我们要学习的Protobuf协议，这也是一种数据编解码的协议，在RPC框架中使用的更广泛。</p>
<h3 id="基于xml的rpc调用"><a href="#基于xml的rpc调用" class="headerlink" title="基于xml的rpc调用"></a>基于xml的rpc调用</h3><p>服务端</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> xmlrpc.server <span class="keyword">import</span> SimpleXMLRPCServer</span><br><span class="line"></span><br><span class="line"><span class="comment">#python中类的命名方式遵循驼峰命名法</span></span><br><span class="line"><span class="comment">#1. 没有出现url的映射</span></span><br><span class="line"><span class="comment">#2. 没有编码和解码</span></span><br><span class="line"><span class="comment">#序列化和反序列化协议是 xml 不是 json</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Calculater</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">self, x, y</span>):</span></span><br><span class="line">        <span class="keyword">return</span> x + y</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">multiply</span>(<span class="params">self, x, y</span>):</span></span><br><span class="line">        <span class="keyword">return</span> x * y</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">subtract</span>(<span class="params">self, x, y</span>):</span></span><br><span class="line">        <span class="keyword">return</span> abs(x-y)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">divide</span>(<span class="params">self, x, y</span>):</span></span><br><span class="line">        <span class="keyword">return</span> x/y</span><br><span class="line"></span><br><span class="line">obj = Calculater()</span><br><span class="line">server = SimpleXMLRPCServer((<span class="string">"localhost"</span>, <span class="number">8088</span>))</span><br><span class="line"><span class="comment"># 将实例注册给rpc server</span></span><br><span class="line">server.register_instance(obj)</span><br><span class="line">print(<span class="string">"Listening on port 8088"</span>)</span><br><span class="line">server.serve_forever()</span><br></pre></td></tr></tbody></table></figure>

<p>客户端</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> xmlrpc <span class="keyword">import</span> client</span><br><span class="line"></span><br><span class="line"><span class="comment">#xmlrpc挺好用的 和我们调用django的服务器 django这种web框架来说一定是可以做到xmlrpc的效果 django的目的不是这种</span></span><br><span class="line"><span class="comment">#rpc强调的是本地调用效果</span></span><br><span class="line"><span class="comment">#rpc在内部调用很多</span></span><br><span class="line"></span><br><span class="line">server = client.ServerProxy(<span class="string">"http://localhost:8088"</span>)</span><br><span class="line">print(server.add(<span class="number">2</span>, <span class="number">3</span>)) <span class="comment"># 5</span></span><br><span class="line">print(server.multiply(<span class="number">2</span>, <span class="number">3</span>))  <span class="comment"># 6</span></span><br><span class="line">print(server.subtract(<span class="number">2</span>, <span class="number">3</span>))  <span class="comment"># 1</span></span><br></pre></td></tr></tbody></table></figure>

<p>然后，我们通过 server_proxy 对象就可以远程调用之前的rpc server的函数了。</p>
<h3 id="json实现rpc的调用"><a href="#json实现rpc的调用" class="headerlink" title="json实现rpc的调用"></a>json实现rpc的调用</h3><p>SimpleXMLRPCServer 是基于 xml-rpc 实现的远程调用，上面我们也提到 除了 xml-rpc 之外，还有 json-rpc 协议。<br>那 python 如何实现基于 json-rpc 协议呢？答案是很多，很多web框架其自身都自己实现了json-rpc，但我们要独立这些框架之外，要寻求一种较为干净的解决方案，我们使用 jsonrpclib<br><a target="_blank" rel="noopener" href="https://github.com/tcalmant/jsonrpclib/">https://github.com/tcalmant/jsonrpclib/</a></p>
<figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install jsonrpclib-pelix</span><br></pre></td></tr></tbody></table></figure>

<p>它与 Python 标准库的 SimpleXMLRPCServer 很类似（因为它的类名就叫做 SimpleJSONRPCServer ，不明真相的人真以为它们是亲兄弟）。或许可以说，jsonrpclib 就是仿照 SimpleXMLRPCServer 标准库来进行编写的。<br>它的导入与 SimpleXMLRPCServer 略有不同，因为SimpleJSONRPCServer分布在jsonrpclib库中。</p>
<p>服务端</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> jsonrpclib.SimpleJSONRPCServer <span class="keyword">import</span> SimpleJSONRPCServer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">a, b</span>):</span></span><br><span class="line">    <span class="keyword">return</span> a + b</span><br><span class="line"></span><br><span class="line"><span class="comment">#1. 实例化server</span></span><br><span class="line">server = SimpleJSONRPCServer((<span class="string">'localhost'</span>, <span class="number">8000</span>))</span><br><span class="line"><span class="comment">#2. 将函数注册到server中</span></span><br><span class="line">server.register_function(add)</span><br><span class="line"><span class="comment">#3. 启动server</span></span><br><span class="line">server.serve_forever()</span><br></pre></td></tr></tbody></table></figure>

<p>多线程<br>协程 go中 netty asyncio<br>jsonrpclib如果只是完成了这样一个简单的调用那么jsonrpclib和xmlrpcserver几乎没有优势可言<br>任何一个web服务如果不具备并发接收和处理的能力的话 那么这个server就没有用</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> jsonrpclib.SimpleJSONRPCServer <span class="keyword">import</span> PooledJSONRPCServer</span><br><span class="line"><span class="keyword">from</span> jsonrpclib.threadpool <span class="keyword">import</span> ThreadPool</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">a, b</span>):</span></span><br><span class="line">    <span class="keyword">import</span> time</span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> a + b</span><br><span class="line"></span><br><span class="line"><span class="comment"># Setup the notification and request pools</span></span><br><span class="line">nofif_pool = ThreadPool(max_threads=<span class="number">10</span>, min_threads=<span class="number">0</span>)</span><br><span class="line">request_pool = ThreadPool(max_threads=<span class="number">50</span>, min_threads=<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Don't forget to start them</span></span><br><span class="line">nofif_pool.start()</span><br><span class="line">request_pool.start()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Setup the server</span></span><br><span class="line">server = PooledJSONRPCServer((<span class="string">'localhost'</span>, <span class="number">8000</span>), thread_pool=request_pool)</span><br><span class="line">server.set_notification_pool(nofif_pool)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Register methods</span></span><br><span class="line">server.register_function(add)</span><br><span class="line"></span><br><span class="line"><span class="comment">#1. 超时机制 - 重试</span></span><br><span class="line"><span class="comment">#2. 限流 处于长期可用的状态 - 高可用</span></span><br><span class="line"><span class="comment">#3. 解耦</span></span><br><span class="line"><span class="comment">#4. 负载均衡 微服务 -分布式应用的一种具体的体现</span></span><br><span class="line"><span class="comment">#5. json-rpc是否满足上述的要求</span></span><br><span class="line"><span class="comment">#6. 序列化和反序列化数据压缩是否高效 json这种数据格式已经非常的简单了 1.这个序列化协议能将数据的压缩变得更小 2. 这个序列化和反序列化的速度够快</span></span><br><span class="line"><span class="comment">#json.dumps() json.loads()</span></span><br><span class="line"><span class="comment">#做架构 技术选型的时候 这些都是我们需要考虑到的点</span></span><br><span class="line"><span class="comment">#更加高效和更加全面的技术 zerorpc</span></span><br><span class="line"><span class="comment">#7. 这个rpc框架是否支持多语言 生态很好</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    server.serve_forever()</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    <span class="comment"># Stop the thread pools (let threads finish their current task)</span></span><br><span class="line">    request_pool.stop()</span><br><span class="line">    nofif_pool.stop()</span><br><span class="line">    server.set_notification_pool(<span class="literal">None</span>)</span><br></pre></td></tr></tbody></table></figure>

<p>客户端</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> jsonrpclib</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">request</span>():</span></span><br><span class="line">    server = jsonrpclib.ServerProxy(<span class="string">'http://localhost:8000'</span>)</span><br><span class="line">    print(server.add(<span class="number">2</span>, <span class="number">3</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">    thread = threading.Thread(target=request)</span><br><span class="line">    thread.start()</span><br><span class="line"></span><br><span class="line">time.sleep(<span class="number">30</span>)  <span class="comment"># 主线程不直接退出</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="zerorpc实现rpc调用"><a href="#zerorpc实现rpc调用" class="headerlink" title="zerorpc实现rpc调用"></a>zerorpc实现rpc调用</h3><p>zerorpc 是利用 zeroMQ消息队列 + msgpack 消息序列化(二进制) 来实现类似 grpc 的功能，跨语言远程调用。<br>主要使用到 zeroMQ 的通信模式是 ROUTER–DEALER，模拟 grpc 的 &nbsp;请求-响应式 和 应答流式 RPC ：zerorpc 还支持 PUB-SUB 通信模式的远程调用。<br>zerorpc实际上会依赖msgpack-python, pyzmq, future, greenlet, gevent</p>
<p><a target="_blank" rel="noopener" href="https://github.com/0rpc/zerorpc-python">https://github.com/0rpc/zerorpc-python</a></p>
<h4 id="一元调用"><a href="#一元调用" class="headerlink" title="一元调用"></a>一元调用</h4><ol>
<li>服务端</li>
</ol>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> zerorpc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloRPC</span>(<span class="params">object</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">hello</span>(<span class="params">self, name</span>):</span></span><br><span class="line">        <span class="comment">#调用了另一个服务</span></span><br><span class="line">        <span class="comment">#流处理</span></span><br><span class="line">        <span class="comment">#本地查询了数据， 源源不断的给数据给客户端</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Hello, %s"</span> % name</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#1. 实例化一个server</span></span><br><span class="line"><span class="comment">#2. 绑定我们的业务代码到server中</span></span><br><span class="line"><span class="comment">#3. 启动server</span></span><br><span class="line">s = zerorpc.Server(HelloRPC())</span><br><span class="line">s.bind(<span class="string">"tcp://0.0.0.0:4242"</span>)</span><br><span class="line">s.run()</span><br></pre></td></tr></tbody></table></figure>

<ol start="2">
<li>客户端</li>
</ol>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> zerorpc</span><br><span class="line"></span><br><span class="line"><span class="comment">#生成器</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span>():</span></span><br><span class="line">    <span class="keyword">yield</span> <span class="string">"ni"</span></span><br><span class="line">    <span class="keyword">yield</span> <span class="string">"hao"</span></span><br><span class="line">    <span class="keyword">yield</span> <span class="string">"bobby"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#在功能体验上 client端没有太大的差异</span></span><br><span class="line"><span class="comment">#差异在性能上 服务端上</span></span><br><span class="line"><span class="keyword">for</span> data <span class="keyword">in</span> hello():</span><br><span class="line">    print(data)</span><br><span class="line"></span><br><span class="line">c = zerorpc.Client()</span><br><span class="line">c.connect(<span class="string">"tcp://127.0.0.1:4242"</span>)</span><br><span class="line"><span class="comment">#python中的生成器和迭代器</span></span><br><span class="line">print(c.hello(<span class="string">"慕课网"</span>))</span><br></pre></td></tr></tbody></table></figure>

<h4 id="流式响应"><a href="#流式响应" class="headerlink" title="流式响应"></a>流式响应</h4><ol>
<li>服务端</li>
</ol>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> zerorpc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StreamingRPC</span>(<span class="params">object</span>):</span></span><br><span class="line"><span class="meta">    @zerorpc.stream #@zerorpc.stream这里的函数修饰是必须的，否则会有异常，如TypeError: can’t serialize</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">streaming_range</span>(<span class="params">self, fr, to, step</span>):</span></span><br><span class="line">        <span class="keyword">return</span> range(fr, to, step)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">s = zerorpc.Server(StreamingRPC())</span><br><span class="line">s.bind(<span class="string">"tcp://0.0.0.0:4242"</span>)</span><br><span class="line">s.run()</span><br></pre></td></tr></tbody></table></figure>

<p>客户端</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> zerorpc</span><br><span class="line"></span><br><span class="line">c = zerorpc.Client()</span><br><span class="line">c.connect(<span class="string">"tcp://127.0.0.1:4242"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#1. 生态 - grpc</span></span><br><span class="line"><span class="comment">#2. 语言的支持 python nodejs go</span></span><br><span class="line"><span class="comment">#3. grpc</span></span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> c.streaming_range(<span class="number">10</span>, <span class="number">20</span>, <span class="number">2</span>):</span><br><span class="line">    print(item)</span><br></pre></td></tr></tbody></table></figure>
<h3 id="传入多个参数"><a href="#传入多个参数" class="headerlink" title="传入多个参数"></a>传入多个参数</h3><ol>
<li>服务端</li>
</ol>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> zerorpc</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myRPC</span>(<span class="params">object</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">listinfo</span>(<span class="params">self,message</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"get info : %s"</span>%message</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getpow</span>(<span class="params">self,n,m</span>):</span></span><br><span class="line">        <span class="keyword">return</span> n**m</span><br><span class="line"></span><br><span class="line">s = zerorpc.Server(myRPC())</span><br><span class="line">s.bind(<span class="string">"tcp://0.0.0.0:4242"</span>)</span><br><span class="line">s.run()</span><br></pre></td></tr></tbody></table></figure>

<ol start="2">
<li>客户端</li>
</ol>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> zerorpc</span><br><span class="line"></span><br><span class="line">c = zerorpc.Client()</span><br><span class="line">c.connect(<span class="string">"tcp://127.0.0.1:4242"</span>)</span><br><span class="line">print(c.listinfo(<span class="string">"this is test string"</span>))</span><br><span class="line">print(c.getpow(<span class="number">2</span>,<span class="number">5</span>))</span><br></pre></td></tr></tbody></table></figure>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/09/22/go-de-option-mo-shi/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/09/22/go-de-option-mo-shi/" class="post-title-link" itemprop="url">go的Options 模式</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2021-09-21 16:21:41 / 修改时间：14:23:58" itemprop="dateCreated datePublished" datetime="2021-09-21T16:21:41Z">2021-09-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Options 模式<br>一般原则：</p>
<ol>
<li>定义一个 Option 类型，它是 func(*YourType) 的形式；</li>
<li>在创建的方法那里，增加不定参数options…Option。内部遍历 options，并应用在实例上</li>
<li>WithXXXX的方法定义返回各种 Option<br>Tip：Go 没有构造函数，也没有方法重载，所以一般会用Option 模式来设计一个NewXX方法。<br>偶尔也会考虑用Builder 模式。</li>
</ol>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> web</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    lru <span class="string">"github.com/hashicorp/golang-lru"</span></span><br><span class="line">    <span class="string">"io/ioutil"</span></span><br><span class="line">    <span class="string">"net/http"</span></span><br><span class="line">    <span class="string">"os"</span></span><br><span class="line">    <span class="string">"path/filepath"</span></span><br><span class="line">    <span class="string">"strings"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> StaticResourceHandlerOption <span class="function"><span class="keyword">func</span><span class="params">(h *StaticResourceHandler)</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> StaticResourceHandler <span class="keyword">struct</span> {</span><br><span class="line">    dir <span class="keyword">string</span></span><br><span class="line">    pathPrefix <span class="keyword">string</span></span><br><span class="line">    extensionContentTypeMap <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 缓存静态资源的限制</span></span><br><span class="line">    cache *lru.Cache</span><br><span class="line">    maxFileSize <span class="keyword">int</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> fileCacheItem <span class="keyword">struct</span> {</span><br><span class="line">    fileName <span class="keyword">string</span></span><br><span class="line">    fileSize <span class="keyword">int</span></span><br><span class="line">    contentType <span class="keyword">string</span></span><br><span class="line">    data []<span class="keyword">byte</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewStaticResourceHandler</span><span class="params">(dir <span class="keyword">string</span>, pathPrefix <span class="keyword">string</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    options...StaticResourceHandlerOption)</span> *<span class="title">StaticResourceHandler</span></span> {</span><br><span class="line">    res := &amp;StaticResourceHandler{</span><br><span class="line">        dir: dir,</span><br><span class="line">        pathPrefix: pathPrefix,</span><br><span class="line">        extensionContentTypeMap: <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>{</span><br><span class="line">            <span class="comment">// 这里根据自己的需要不断添加</span></span><br><span class="line">            <span class="string">"jpeg"</span>: <span class="string">"image/jpeg"</span>,</span><br><span class="line">            <span class="string">"jpe"</span>: <span class="string">"image/jpeg"</span>,</span><br><span class="line">            <span class="string">"jpg"</span>: <span class="string">"image/jpeg"</span>,</span><br><span class="line">            <span class="string">"png"</span>: <span class="string">"image/png"</span>,</span><br><span class="line">            <span class="string">"pdf"</span>: <span class="string">"image/pdf"</span>,</span><br><span class="line">        },</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> _, o := <span class="keyword">range</span> options {</span><br><span class="line">        o(res)</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line">}</span><br><span class="line"><span class="comment">// WithFileCache 静态文件将会被缓存</span></span><br><span class="line"><span class="comment">// maxFileSizeThreshold 超过这个大小的文件，就被认为是大文件，我们将不会缓存</span></span><br><span class="line"><span class="comment">// maxCacheFileCnt 最多缓存多少个文件</span></span><br><span class="line"><span class="comment">// 所以我们最多缓存 maxFileSizeThreshold * maxCacheFileCnt</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithFileCache</span><span class="params">(maxFileSizeThreshold <span class="keyword">int</span>, maxCacheFileCnt <span class="keyword">int</span>)</span> <span class="title">StaticResourceHandlerOption</span></span> {</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(h *StaticResourceHandler)</span></span> {</span><br><span class="line">        c, err := lru.New(maxCacheFileCnt)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">            fmt.Printf(<span class="string">"could not create LRU, we won't cache static file"</span>)</span><br><span class="line">        }</span><br><span class="line">        h.maxFileSize = maxFileSizeThreshold</span><br><span class="line">        h.cache = c</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithMoreExtension</span><span class="params">(extMap <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</span> <span class="title">StaticResourceHandlerOption</span></span> {</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(h *StaticResourceHandler)</span></span> {</span><br><span class="line">        <span class="keyword">for</span> ext, contentType := <span class="keyword">range</span> extMap {</span><br><span class="line">            h.extensionContentTypeMap[ext] = contentType</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h *StaticResourceHandler)</span> <span class="title">ServeStaticResource</span><span class="params">(c *Context)</span></span>  {</span><br><span class="line">    req := strings.TrimPrefix(c.R.URL.Path, h.pathPrefix)</span><br><span class="line">    <span class="keyword">if</span> item, ok := h.readFileFromData(req); ok {</span><br><span class="line">        fmt.Printf(<span class="string">"read data from cache..."</span>)</span><br><span class="line">        h.writeItemAsResponse(item, c.W)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    }</span><br><span class="line">    path := filepath.Join(h.dir, req)</span><br><span class="line">    f, err := os.Open(path)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">        c.W.WriteHeader(http.StatusInternalServerError)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    }</span><br><span class="line">    ext := getFileExt(f.Name())</span><br><span class="line">    t, ok := h.extensionContentTypeMap[ext]</span><br><span class="line">    <span class="keyword">if</span> !ok {</span><br><span class="line">        c.W.WriteHeader(http.StatusBadRequest)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    data, err := ioutil.ReadAll(f)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">        c.W.WriteHeader(http.StatusInternalServerError)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    }</span><br><span class="line">    item := &amp;fileCacheItem{</span><br><span class="line">        fileSize: <span class="built_in">len</span>(data),</span><br><span class="line">        data: data,</span><br><span class="line">        contentType: t,</span><br><span class="line">        fileName: req,</span><br><span class="line">    }</span><br><span class="line">    h.cacheFile(item)</span><br><span class="line">    h.writeItemAsResponse(item, c.W)</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h *StaticResourceHandler)</span> <span class="title">cacheFile</span><span class="params">(item *fileCacheItem)</span></span> {</span><br><span class="line">    <span class="keyword">if</span> h.cache != <span class="literal">nil</span> &amp;&amp; item.fileSize &lt; h.maxFileSize {</span><br><span class="line">        h.cache.Add(item.fileName, item)</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h *StaticResourceHandler)</span> <span class="title">writeItemAsResponse</span><span class="params">(item *fileCacheItem, writer http.ResponseWriter)</span></span> {</span><br><span class="line">    writer.WriteHeader(http.StatusOK)</span><br><span class="line">    writer.Header().Set(<span class="string">"Content-Type"</span>, item.contentType)</span><br><span class="line">    writer.Header().Set(<span class="string">"Content-Length"</span>, fmt.Sprintf(<span class="string">"%d"</span>, item.fileSize))</span><br><span class="line">    _, _ = writer.Write(item.data)</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h *StaticResourceHandler)</span> <span class="title">readFileFromData</span><span class="params">(fileName <span class="keyword">string</span>)</span> <span class="params">(*fileCacheItem, <span class="keyword">bool</span>)</span></span> {</span><br><span class="line">    <span class="keyword">if</span> h.cache != <span class="literal">nil</span> {</span><br><span class="line">        <span class="keyword">if</span> item, ok := h.cache.Get(fileName); ok {</span><br><span class="line">            <span class="keyword">return</span> item.(*fileCacheItem), <span class="literal">true</span></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">false</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getFileExt</span><span class="params">(name <span class="keyword">string</span>)</span> <span class="title">string</span></span> {</span><br><span class="line">    index := strings.LastIndex(name, <span class="string">"."</span>)</span><br><span class="line">    <span class="keyword">if</span> index == <span class="built_in">len</span>(name) - <span class="number">1</span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span></span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> name[index+<span class="number">1</span>:]</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/09/05/wei-fu-wu-she-ji/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/09/05/wei-fu-wu-she-ji/" class="post-title-link" itemprop="url">微服务设计</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2021-09-04 16:21:41 / 修改时间：13:11:11" itemprop="dateCreated datePublished" datetime="2021-09-04T16:21:41Z">2021-09-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="API-Gateway"><a href="#API-Gateway" class="headerlink" title="API Gateway"></a>API Gateway</h2><p>我们进行了 SOA 服务化的架构演进，按<br>照垂直功能进行了拆分，对外暴露了一批<br>微服务，但是因为缺乏统一的出口面临了<br>不少困难：<br>• 客户端到微服务直接通信，强耦合。<br>• 需要多次请求，客户端聚合数据，工作量巨大，延迟高。<br>• 协议不利于统一，各个部门间有差异，需要端来兼容。<br>• 面向“端”的API适配，耦合到了内部服务。<br>• 多终端兼容逻辑复杂，每个服务都需要处理。<br>• 统一逻辑无法收敛，比如安全认证、限流。我们之前提到了我们工作模型，要内聚模式配合。</p>
<p>需要一个 Backend for frontend 数据聚合</p>
<p>在服务内进行大量的 dataset join，按照业务场景来设计粗粒度的 API，给后续服务的演进带来的很多优势：</p>
<p>轻量交互：协议精简、聚合。<br>差异服务：数据裁剪以及聚合、针对终端定制化 API。<br>动态升级：原有系统兼容升级，更新服务而非协议。<br>沟通效率提升，协作模式演进为移动业务 + 网关小组。<br>BFF 可以认为是一种适配服务，将后端的微服务进行适配 (主要包括聚合裁剪和格式适配等逻辑)，向无线端设备暴露友好和统一的 API，方便无线设备接入访问后端服务。</p>
<p>最致命的一个问题是整个 app-interface 属于<br>single point of failure，严重代码缺陷或者流量洪<br>峰可能引发集群宕机。<br>• 单个模块也会导致后续业务集成复杂度高，根据康<br>威法则，单块的无线BFF和多团队之间就出现不匹<br>配问题，团队之间沟通协调成本高，交付效率低下。<br>• 很多跨横切面逻辑，比如安全认证，日志监控，限<br>流熔断等。随着时间的推移，代码变得越来越复杂，<br>技术债越堆越多。</p>
<p>跨横切面(Cross-Cutting Concerns)的功能，需要<br>协调更新框架升级发版(路由、认证、限流、安<br>全)，因此全部上沉，引入了 API Gateway，把业<br>务集成度高的 BFF 层和通用功能服务层 API<br>Gateway 进行了分层处理。<br>在新的架构中，网关承担了重要的角色，它是解耦拆分<br>和后续升级迁移的利器。在网关的配合下，单块 BFF<br>实现了解耦拆分，各业务线团队可以独立开发和交付各<br>自的微服务，研发效率大大提升。另外，把跨横切面逻<br>辑从 BFF 剥离到网关上去以后，BFF 的开发人员可以<br>更加专注业务逻辑交付，实现了架构上的关注分离<br>(Separation of Concerns)。<br>我们业务流量实际为：<br>移动端 -&gt; API Gateway -&gt; BFF -&gt; Mircoservice，在<br>FE Web业务中，BFF 可以是 nodejs 来做服务端渲染<br>(SSR，Server-Side Rendering)，注意这里忽略了上<br>游的 CDN、4/7层负载均衡(ELB)。</p>
<h2 id="Mircoservice-划分"><a href="#Mircoservice-划分" class="headerlink" title="Mircoservice 划分"></a>Mircoservice 划分</h2><p>在实际项目中通常会采用两种不同的<br>方式划分服务边界，即通过业务职能(Business<br>Capability)或是 DDD 的限界上下文(Bounded<br>Context)。<br>• Business Capability<br>由公司内部不同部门提供的职能。例如客户服务部<br>门提供客户服务的职能，财务部门提供财务相关的职能。<br>• Bounded Context<br>限界上下文是 DDD 中用来划分不同业务边界的元素，<br>这里业务边界的含义是“解决不同业务问题”的问题域<br>和对应的解决方案域，为了解决某种类型的业务问题，<br>贴近领域知识，也就是业务。<br>这本质上也促进了组织结构的演进：Service per team</p>
<p>CQRS（查询职责分离），将应用程序分为两部分：命令端和查询端。</p>
<p>命令端处理程序创建，更新和删除请求，并在数据更改时发出事件。<br>查询端通过针对一个或多个物化视图执行查询来处理查询，这些物化视图通过订阅数据更改时发出的事件流而保持最新</p>
<p>在稿件服务演进过程中，我们发现围绕着创作稿件、审<br>核稿件、最终发布稿件有大量的逻辑揉在一块，其中稿<br>件本身的状态也有非常多种，但是最终前台用户只关注<br>稿件能否查看，我们依赖稿件数据库 binlog 以及订阅<br>binlog 的中间件 canal，将我们的稿件结果发布到消息<br>队列 kafka 中，最终消费数据独立组建一个稿件查阅结<br>果数据库，并对外提供一个独立查询服务，来拆分复杂<br>架构和业务。<br>我们架构也从 Polling publisher -&gt; Transaction log<br>tailing 进行了演进(Pull vs Push)。</p>
<h2 id="Mircoservice-安全"><a href="#Mircoservice-安全" class="headerlink" title="Mircoservice 安全"></a>Mircoservice 安全</h2><p>对于外网的请求来说，我们通常在 API Gateway 进行统一的认证拦截，一旦认证成功，我们会使用 JWT 方式通过 RPC 元数据传递的方式带到 BFF 层，BFF 校验 Token 完整性后把身份信息注入到应用的 Context 中，BFF 到其他下层的微服务，建议是直接在 RPC Request 中带入用户身份信息 (UserID) 请求服务。</p>
<p>• API Gateway -&gt; BFF -&gt; Service<br>Biz Auth -&gt; JWT -&gt; Request Args<br>对于服务内部，一般要区分身份认证和授权。</p>
<ul>
<li>Full Trust</li>
<li>Half Trust</li>
<li>Zero Trust</li>
</ul>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/09/03/wei-fu-wu/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/09/03/wei-fu-wu/" class="post-title-link" itemprop="url">微服务</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-09-02 16:21:41" itemprop="dateCreated datePublished" datetime="2021-09-02T16:21:41Z">2021-09-02</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-09-09 00:57:35" itemprop="dateModified" datetime="2021-09-09T00:57:35Z">2021-09-09</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p>微服务将单体应用系统拆分成多个分而治之的小应用,降低系统整体崩溃的风险性;同时也可根据这些小应用的不同需求调整实体机的性能</p>
<p>微服务主要缺点是将系统复杂化,但对于本身就复杂的系统,微服务受益会很高  </p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2021/09/03/wei-fu-wu/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/08/23/go-de-select/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/08/23/go-de-select/" class="post-title-link" itemprop="url">go的select</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-08-22 16:21:41" itemprop="dateCreated datePublished" datetime="2021-08-22T16:21:41Z">2021-08-22</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-09-21 11:05:24" itemprop="dateModified" datetime="2021-09-21T11:05:24Z">2021-09-21</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="多路通道"><a href="#多路通道" class="headerlink" title="多路通道"></a>多路通道</h4><p>在真实的世界中，还有一种消息传递场景，那就是消费者有多个消费来源，只要有一个来源生产了数据，消费者就可以读这个数据进行消费。<br>这时候可以将多个来源通道的数据汇聚到目标通道，然后统一在目标通道进行消费。</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 每隔一会生产一个数</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">send</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">int</span>, gap time.Duration)</span></span> {</span><br><span class="line">    i := <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> {</span><br><span class="line">        i++</span><br><span class="line">        ch &lt;- i</span><br><span class="line">        time.Sleep(gap)</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将多个原通道内容拷贝到单一的目标通道</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">collect</span><span class="params">(source <span class="keyword">chan</span> <span class="keyword">int</span>, target <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> {</span><br><span class="line">    <span class="keyword">for</span> v := <span class="keyword">range</span> source {</span><br><span class="line">        target &lt;- v</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从目标通道消费数据</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">recv</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> {</span><br><span class="line">    <span class="keyword">for</span> v := <span class="keyword">range</span> ch {</span><br><span class="line">        fmt.Printf(<span class="string">"receive %d\n"</span>, v)</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">var</span> ch1 = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line">    <span class="keyword">var</span> ch2 = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line">    <span class="keyword">var</span> ch3 = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line">    <span class="keyword">go</span> send(ch1, time.Second)</span><br><span class="line">    <span class="keyword">go</span> send(ch2, <span class="number">2</span> * time.Second)</span><br><span class="line">    <span class="keyword">go</span> collect(ch1, ch3)</span><br><span class="line">    <span class="keyword">go</span> collect(ch2, ch3)</span><br><span class="line">    recv(ch3)</span><br><span class="line">}</span><br><span class="line">---------</span><br><span class="line">receive <span class="number">1</span></span><br><span class="line">receive <span class="number">1</span></span><br><span class="line">receive <span class="number">2</span></span><br><span class="line">receive <span class="number">2</span></span><br><span class="line">receive <span class="number">3</span></span><br><span class="line">receive <span class="number">4</span></span><br><span class="line">receive <span class="number">3</span></span><br><span class="line">receive <span class="number">5</span></span><br><span class="line">receive <span class="number">6</span></span><br><span class="line">receive <span class="number">4</span></span><br><span class="line">receive <span class="number">7</span></span><br><span class="line">receive <span class="number">8</span></span><br><span class="line">receive <span class="number">5</span></span><br><span class="line">receive <span class="number">9</span></span><br><span class="line">...</span><br></pre></td></tr></tbody></table></figure>

<p>但是上面这种形式比较繁琐，需要为每一种消费来源都单独启动一个汇聚协程。<br>Go 语言为这种使用场景带来了「多路复用」语法糖，也就是下面要讲的 <code>select</code> 语句，<br>它可以同时管理多个通道的send写操作和receive读操作，如果所有通道都不能读写，它就整体阻塞，只要有一个通道可以读写，它就会继续。</p>
<p>如果有同时多个case去处理，比如同时有多个channel可以接收数据，那么Go只会伪随机的选择一个case处理(pseudo-random)。同时的情况下，顺序随机<br><code>select</code>语句和<code>switch</code>语句一样，它不是循环，如果想一直处理channel，你可以在外面加一个无限的for循环：</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">    ch1 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">1</span>)</span><br><span class="line">    ch2 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">1</span>)</span><br><span class="line">    ch1 &lt;- <span class="number">1</span></span><br><span class="line">    ch2 &lt;- <span class="number">2</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">select</span> {</span><br><span class="line">    <span class="keyword">case</span> data := &lt;- ch1:</span><br><span class="line">        fmt.Println(data)</span><br><span class="line">    <span class="keyword">case</span> data := &lt;- ch2:</span><br><span class="line">        fmt.Println(data)</span><br><span class="line">    }</span><br><span class="line">--</span><br><span class="line">随机打印<span class="number">1</span> or <span class="number">2</span></span><br></pre></td></tr></tbody></table></figure>

<p>下面用 select 语句来简化上面的逻辑</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">send</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">int</span>, gap time.Duration)</span></span> {</span><br><span class="line">    i := <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> {</span><br><span class="line">        i++</span><br><span class="line">        ch &lt;- i</span><br><span class="line">        time.Sleep(gap)</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">recv</span><span class="params">(ch1 <span class="keyword">chan</span> <span class="keyword">int</span>, ch2 <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> {</span><br><span class="line">    <span class="keyword">for</span> {</span><br><span class="line">        <span class="keyword">select</span> {</span><br><span class="line">        <span class="keyword">case</span> v := &lt;-ch1:</span><br><span class="line">            fmt.Printf(<span class="string">"recv %d from ch1\n"</span>, v)</span><br><span class="line">        <span class="keyword">case</span> v := &lt;-ch2:</span><br><span class="line">            fmt.Printf(<span class="string">"recv %d from ch2\n"</span>, v)</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">var</span> ch1 = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line">    <span class="keyword">var</span> ch2 = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line">    <span class="keyword">go</span> send(ch1, time.Second)</span><br><span class="line">    <span class="keyword">go</span> send(ch2, <span class="number">2</span> * time.Second)</span><br><span class="line">    recv(ch1, ch2)</span><br><span class="line">}</span><br><span class="line">------------</span><br><span class="line">recv <span class="number">1</span> from ch2</span><br><span class="line">recv <span class="number">1</span> from ch1</span><br><span class="line">recv <span class="number">2</span> from ch1</span><br><span class="line">recv <span class="number">3</span> from ch1</span><br><span class="line">recv <span class="number">2</span> from ch2</span><br><span class="line">recv <span class="number">4</span> from ch1</span><br><span class="line">recv <span class="number">3</span> from ch2</span><br><span class="line">recv <span class="number">5</span> from ch1</span><br><span class="line">...</span><br></pre></td></tr></tbody></table></figure>

<p>上面是多路复用 select 语句的读通道形式，下面是它的写通道形式，只要有一个通道能写进去，它就会打破阻塞。</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> {</span><br><span class="line">    <span class="keyword">case</span> ch1 &lt;- v:</span><br><span class="line">        fmt.Println(<span class="string">"send to ch1"</span>)</span><br><span class="line">    <span class="keyword">case</span> ch2 &lt;- v:</span><br><span class="line">        fmt.Println(<span class="string">"send to ch2"</span>)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>非阻塞读写需要依靠 select 语句的 default 分支。<br>前面我们讲的读写都是阻塞读写，Go 语言还提供了通道的非阻塞读写。<br>非阻塞读写：当通道空时，读操作不会阻塞，当通道满时，写操作也不会阻塞。</p>
<p>当 select 语句所有通道都不可读写时，没有case需要处理，如果定义了 default 分支，那就会执行 default 分支逻辑，这样就起到了不阻塞的效果，决定通道读写操作阻塞与否；如果没有<code>default case</code>，则<code>select</code>语句会阻塞，直到某个case需要处理。</p>
<p>最多允许有一个<code>default case</code>，它可以放在case列表的任何位置，尽管我们大部分会将它放在最后。</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> c1, c2 <span class="keyword">chan</span> <span class="keyword">int</span> <span class="comment">// nil</span></span><br><span class="line"><span class="keyword">select</span> { <span class="comment">// 哪一个条件满足就走哪个条件</span></span><br><span class="line"><span class="keyword">case</span> n := &lt;-c1:</span><br><span class="line">    fmt.Println(<span class="string">"received from c1:"</span>, n)</span><br><span class="line"><span class="keyword">case</span> n := &lt;-c2:</span><br><span class="line">    fmt.Println(<span class="string">"received from c2:"</span>, n)</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">    fmt.Println(<span class="string">"no value"</span>) <span class="comment">// no value</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>下面演示一个单生产者多消费者的场景。生产者同时向两个通道写数据，写不进去就丢弃。</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">send</span><span class="params">(ch1 <span class="keyword">chan</span> <span class="keyword">int</span>, ch2 <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> {</span><br><span class="line">    i := <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> {</span><br><span class="line">        i++</span><br><span class="line">        <span class="keyword">select</span> {</span><br><span class="line">        <span class="keyword">case</span> ch1 &lt;- i:</span><br><span class="line">            fmt.Printf(<span class="string">"send ch1 %d\n"</span>, i)</span><br><span class="line">        <span class="keyword">case</span> ch2 &lt;- i:</span><br><span class="line">            fmt.Printf(<span class="string">"send ch2 %d\n"</span>, i)</span><br><span class="line">        <span class="keyword">default</span>:  <span class="comment">// 在接收的等待期，default会一直执行，本轮循环不会执行发数据给通道</span></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">recv</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">int</span>, gap time.Duration, name <span class="keyword">string</span>)</span></span> {</span><br><span class="line">    <span class="keyword">for</span> v := <span class="keyword">range</span> ch {</span><br><span class="line">        fmt.Printf(<span class="string">"receive %s %d\n"</span>, name, v)</span><br><span class="line">        time.Sleep(gap)</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="comment">// 无缓冲通道</span></span><br><span class="line">    <span class="keyword">var</span> ch1 = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line">    <span class="keyword">var</span> ch2 = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line">    <span class="comment">// 两个消费者的休眠时间不一样，名称不一样</span></span><br><span class="line">    <span class="keyword">go</span> recv(ch1, time.Second, <span class="string">"ch1"</span>)</span><br><span class="line">    <span class="keyword">go</span> recv(ch2, <span class="number">2</span> * time.Second, <span class="string">"ch2"</span>)</span><br><span class="line">    send(ch1, ch2)</span><br><span class="line">}</span><br><span class="line">----</span><br><span class="line">send ch2 <span class="number">1</span></span><br><span class="line">send ch1 <span class="number">2</span></span><br><span class="line">receive ch2 <span class="number">1</span></span><br><span class="line">receive ch1 <span class="number">2</span></span><br><span class="line">...</span><br><span class="line">send ch1 <span class="number">14864576</span></span><br><span class="line">receive ch1 <span class="number">14864576</span></span><br><span class="line">send ch2 <span class="number">29189693</span></span><br><span class="line">receive ch2 <span class="number">29189693</span></span><br><span class="line">send ch1 <span class="number">29429195</span></span><br><span class="line">receive ch1 <span class="number">29429195</span></span><br><span class="line">send ch1 <span class="number">44623181</span></span><br><span class="line">receive ch1 <span class="number">44623181</span></span><br><span class="line">send ch2 <span class="number">59129320</span></span><br><span class="line">receive ch2 <span class="number">59129320</span></span><br><span class="line">...</span><br></pre></td></tr></tbody></table></figure>

<p>从输出中可以明显看出有很多的数据写不进去都丢弃了，消费者读到的数据是不连续的。如果将 <code>select</code> 语句里面的 <code>default</code> 分支干掉，再运行一次，结果如下</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">send ch1 <span class="number">1</span></span><br><span class="line">receive ch1 <span class="number">1</span></span><br><span class="line">receive ch2 <span class="number">2</span></span><br><span class="line">send ch2 <span class="number">2</span></span><br><span class="line">receive ch1 <span class="number">3</span></span><br><span class="line">send ch1 <span class="number">3</span></span><br><span class="line">receive ch2 <span class="number">4</span></span><br><span class="line">send ch2 <span class="number">4</span></span><br><span class="line">receive ch1 <span class="number">5</span></span><br><span class="line">send ch1 <span class="number">5</span></span><br><span class="line">receive ch1 <span class="number">6</span></span><br><span class="line">send ch1 <span class="number">6</span></span><br><span class="line">...</span><br></pre></td></tr></tbody></table></figure>

<p>可以看到消费者读到的数据都连续了，但是每个数据只给了一个消费者。</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"math/rand"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 随机生成数字</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">generator</span><span class="params">()</span> <span class="title">chan</span> <span class="title">int</span></span> {</span><br><span class="line">    c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line">    i := <span class="number">0</span></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">        <span class="keyword">for</span> {</span><br><span class="line">            time.Sleep(time.Millisecond * time.Duration(rand.Intn(<span class="number">1500</span>))) <span class="comment">// 0到n之间的整数</span></span><br><span class="line">            c &lt;- i</span><br><span class="line">            i++</span><br><span class="line">        }</span><br><span class="line">    }()</span><br><span class="line">    <span class="keyword">return</span> c</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">var</span> c1, c2 = generator(), generator()</span><br><span class="line">    <span class="keyword">for</span> {</span><br><span class="line">        <span class="keyword">select</span> {</span><br><span class="line">        <span class="keyword">case</span> n := &lt;-c1:</span><br><span class="line">            fmt.Println(<span class="string">"received from c1:"</span>, n)</span><br><span class="line">        <span class="keyword">case</span> n := &lt;-c2:</span><br><span class="line">            fmt.Println(<span class="string">"received from c2:"</span>, n)</span><br><span class="line">        <span class="comment">// 这里不用default，因为在生成数字的等待期，default会一直执行</span></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line">----</span><br><span class="line">received from c2: <span class="number">0</span></span><br><span class="line">received from c1: <span class="number">0</span></span><br><span class="line">received from c1: <span class="number">1</span></span><br><span class="line">received from c2: <span class="number">1</span></span><br><span class="line">received from c2: <span class="number">2</span></span><br><span class="line">received from c1: <span class="number">2</span></span><br><span class="line">received from c2: <span class="number">3</span></span><br><span class="line">received from c1: <span class="number">3</span></span><br><span class="line">received from c1: <span class="number">4</span></span><br><span class="line">received from c1: <span class="number">5</span></span><br><span class="line">received from c2: <span class="number">4</span></span><br><span class="line">received from c2: <span class="number">5</span></span><br><span class="line">received from c2: <span class="number">6</span></span><br><span class="line">received from c1: <span class="number">6</span></span><br><span class="line">...</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">collector</span><span class="params">(c <span class="keyword">chan</span> <span class="keyword">string</span>, n <span class="keyword">int</span>)</span></span>{</span><br><span class="line">    <span class="keyword">for</span> {</span><br><span class="line">        time.Sleep(time.Second)</span><br><span class="line">        c &lt;- <span class="string">"imooc"</span>+strconv.Itoa(n)</span><br><span class="line">        <span class="comment">//fmt.Println(fmt.Sprintf("%d 获取到了数据"))</span></span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>{</span><br><span class="line">    msg1 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>)</span><br><span class="line">    msg2 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>)</span><br><span class="line">    <span class="keyword">go</span> collector(msg1, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">go</span> collector(msg2, <span class="number">2</span>)</span><br><span class="line">    <span class="comment">//for{</span></span><br><span class="line">    <span class="comment">//    data, ok := &lt;-msg1</span></span><br><span class="line">    <span class="comment">//    if ok {</span></span><br><span class="line">    <span class="comment">//        fmt.Println(data)</span></span><br><span class="line">    <span class="comment">//    }</span></span><br><span class="line">    <span class="comment">//    data, ok = &lt;-msg2</span></span><br><span class="line">    <span class="comment">//    if ok {</span></span><br><span class="line">    <span class="comment">//        fmt.Println(data)</span></span><br><span class="line">    <span class="comment">//    }</span></span><br><span class="line">    <span class="comment">//}</span></span><br><span class="line">    <span class="keyword">for</span>{</span><br><span class="line">        <span class="keyword">select</span> {</span><br><span class="line">        <span class="keyword">case</span> data1 := &lt;- msg1:</span><br><span class="line">            fmt.Println(data1)</span><br><span class="line">        <span class="keyword">case</span> data2 := &lt;- msg2:</span><br><span class="line">            fmt.Println(data2)</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line">---</span><br><span class="line">imooc1</span><br><span class="line">imooc2</span><br><span class="line">imooc1</span><br><span class="line">imooc2</span><br><span class="line">imooc2</span><br><span class="line">imooc1</span><br><span class="line">imooc1</span><br><span class="line">...</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">fibonacci</span><span class="params">(c, quit <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> {</span><br><span class="line">    x, y := <span class="number">0</span>, <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> {</span><br><span class="line">        <span class="keyword">select</span> {</span><br><span class="line">        <span class="keyword">case</span> c &lt;- x:</span><br><span class="line">            x, y = y, x+y</span><br><span class="line">        <span class="keyword">case</span> &lt;-quit:</span><br><span class="line">            fmt.Println(<span class="string">"quit"</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line">    quit := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">        <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ {</span><br><span class="line">            fmt.Println(&lt;-c)</span><br><span class="line">        }</span><br><span class="line">        quit &lt;- <span class="number">0</span></span><br><span class="line">    }()</span><br><span class="line">    fibonacci(c, quit)</span><br><span class="line">}</span><br><span class="line">----</span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">8</span></span><br><span class="line"><span class="number">13</span></span><br><span class="line"><span class="number">21</span></span><br><span class="line"><span class="number">34</span></span><br><span class="line">quit</span><br></pre></td></tr></tbody></table></figure>

<p><code>select</code> 有很重要的一个应用场景就是处理超时 timeout。<br>因为上面我们提到，如果没有case需要处理，select语句就会一直阻塞着。这时候我们可能就需要一个超时操作，用来处理超时的情况。</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// After waits for the duration to elapse and then sends the current time</span></span><br><span class="line"><span class="comment">// on the returned channel.在指定的时间发送一个当前时间给返回的channel中。</span></span><br><span class="line"><span class="comment">// It is equivalent to NewTimer(d).C.</span></span><br><span class="line"><span class="comment">// The underlying Timer is not recovered by the garbage collector</span></span><br><span class="line"><span class="comment">// until the timer fires. If efficiency is a concern, use NewTimer</span></span><br><span class="line"><span class="comment">// instead and call Timer.Stop if the timer is no longer needed.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">After</span><span class="params">(d Duration)</span> &lt;-<span class="title">chan</span> <span class="title">Time</span></span> {</span><br><span class="line">    <span class="keyword">return</span> NewTimer(d).C</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>下面这个例子我们会在2秒后往channel c1中发送一个数据，但是select设置为2秒超时，因此我们会打印出timeout 1，而不是result 1。</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">    c1 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">        time.Sleep(time.Second * <span class="number">2</span>)</span><br><span class="line">        c1 &lt;- <span class="string">"result 1"</span></span><br><span class="line">    }()</span><br><span class="line">    <span class="keyword">select</span> {</span><br><span class="line">    <span class="keyword">case</span> res := &lt;-c1: <span class="comment">// 等待2秒才能运行</span></span><br><span class="line">        fmt.Println(res)</span><br><span class="line">    <span class="keyword">case</span> &lt;-time.After(time.Second): <span class="comment">// 等待1秒才能运行</span></span><br><span class="line">        fmt.Println(<span class="string">"timeout 1"</span>)</span><br><span class="line">    }</span><br><span class="line">---</span><br><span class="line">timeout <span class="number">1</span></span><br><span class="line">[Done] exited with code=<span class="number">0</span> in <span class="number">1.661</span> seconds</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">    timeout := <span class="literal">false</span> <span class="comment">// 全局共享</span></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">        <span class="comment">// 该groutine如果执行的间超过了2s，就报告给主的 goroutine</span></span><br><span class="line">        time.Sleep(time.Second * <span class="number">2</span>)</span><br><span class="line">        timeout = <span class="literal">true</span></span><br><span class="line">    }()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> {</span><br><span class="line">        <span class="keyword">if</span> timeout {</span><br><span class="line">            fmt.Println(<span class="string">"end"</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        }</span><br><span class="line">        time.Sleep(time.Millisecond * <span class="number">10</span>)</span><br><span class="line">    }</span><br><span class="line">----</span><br><span class="line">end 立刻打印， <span class="number">2.687</span> seconds后结束程序</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">    timeout := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">        <span class="comment">// 该groutine如果执行的间超过了2s，那么就报告给主的 goroutine</span></span><br><span class="line">        time.Sleep(time.Second * <span class="number">2</span>)</span><br><span class="line">        timeout &lt;- <span class="literal">true</span></span><br><span class="line">    }()</span><br><span class="line">    fmt.Println(&lt;-timeout)</span><br><span class="line">----</span><br><span class="line"><span class="literal">true</span></span><br><span class="line">[Done] exited with code=<span class="number">0</span> in <span class="number">2.621</span> seconds</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">    timeout := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">        <span class="comment">// 该groutine如果执行的间超过了2s，那么就报告给主的 goroutine</span></span><br><span class="line">        time.Sleep(time.Second * <span class="number">2</span>)</span><br><span class="line">        timeout &lt;- <span class="literal">true</span></span><br><span class="line">    }()</span><br><span class="line">    <span class="keyword">select</span> {</span><br><span class="line">    <span class="keyword">case</span> &lt;-timeout: <span class="comment">// 没有取值阻塞的方式判断timeout</span></span><br><span class="line">        fmt.Println(<span class="string">"timeout"</span>)</span><br><span class="line">    }</span><br><span class="line">----</span><br><span class="line">timeout</span><br><span class="line">[Done] exited with code=<span class="number">0</span> in <span class="number">2.588</span> seconds</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">    timeout := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>, <span class="number">2</span>)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">        time.Sleep(time.Second * <span class="number">5</span>)</span><br><span class="line">        timeout &lt;- <span class="literal">true</span></span><br><span class="line">    }()</span><br><span class="line">    timeout2 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>, <span class="number">2</span>)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">        time.Sleep(time.Second * <span class="number">1</span>)</span><br><span class="line">        timeout2 &lt;- <span class="literal">true</span></span><br><span class="line">    }()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">select</span> {</span><br><span class="line">    <span class="keyword">case</span> &lt;-timeout:</span><br><span class="line">        fmt.Println(<span class="string">"timeout 5"</span>)</span><br><span class="line">    <span class="keyword">case</span> &lt;-timeout2:</span><br><span class="line">        fmt.Println(<span class="string">"timeout 1"</span>)</span><br><span class="line">    }</span><br><span class="line">----</span><br><span class="line">timeout <span class="number">1</span></span><br><span class="line">[Done] exited with code=<span class="number">0</span> in <span class="number">1.628</span> seconds</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">    timeout := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>, <span class="number">2</span>)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">        time.Sleep(time.Second * <span class="number">5</span>)</span><br><span class="line">        timeout &lt;- <span class="literal">true</span></span><br><span class="line">    }()</span><br><span class="line"></span><br><span class="line">    timeout2 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>, <span class="number">2</span>)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">        time.Sleep(time.Second * <span class="number">1</span>)</span><br><span class="line">        timeout2 &lt;- <span class="literal">true</span></span><br><span class="line">    }()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">select</span> {</span><br><span class="line">    <span class="keyword">case</span> &lt;-timeout:</span><br><span class="line">        fmt.Println(<span class="string">"timeout"</span>)</span><br><span class="line">    <span class="keyword">case</span> &lt;-timeout2:</span><br><span class="line">        fmt.Println(<span class="string">"timeout"</span>)</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        fmt.Println(<span class="string">"one more time"</span>)</span><br><span class="line">    }</span><br><span class="line">----</span><br><span class="line">one more time</span><br><span class="line">[Done] exited with code=<span class="number">0</span> in <span class="number">0.604</span> seconds</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">createWorker</span><span class="params">(id <span class="keyword">int</span>)</span> <span class="title">chan</span>&lt;- <span class="title">int</span></span> {</span><br><span class="line">    w := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">        <span class="keyword">for</span> {</span><br><span class="line">            fmt.Printf(<span class="string">"worker %d receiver:%d\n"</span>, id, &lt;-w)</span><br><span class="line">        }</span><br><span class="line">    }()</span><br><span class="line">    <span class="keyword">return</span> w</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">var</span> c1, c2 = generator(), generator()</span><br><span class="line">    <span class="keyword">var</span> w = createWorker(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">for</span> {</span><br><span class="line">        <span class="keyword">select</span> {</span><br><span class="line">        <span class="keyword">case</span> n := &lt;-c1:</span><br><span class="line">            w &lt;- n</span><br><span class="line">        <span class="keyword">case</span> n := &lt;-c2:</span><br><span class="line">            w &lt;- n</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line">----</span><br><span class="line">Worker <span class="number">0</span> received <span class="number">0</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">0</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">1</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">1</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">2</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">2</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">3</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">3</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">4</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">4</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">5</span></span><br><span class="line">...</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">var</span> c1, c2 = generator(), generator()</span><br><span class="line">    w := createWorker(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">var</span> n <span class="keyword">int</span></span><br><span class="line">    <span class="keyword">for</span> {</span><br><span class="line">        <span class="keyword">select</span> { <span class="comment">// 哪一个条件满足就走哪个条件</span></span><br><span class="line">        <span class="keyword">case</span> n = &lt;-c1:</span><br><span class="line">            fmt.Println(<span class="string">"received from c1:"</span>, n)</span><br><span class="line">        <span class="keyword">case</span> n = &lt;-c2:</span><br><span class="line">            fmt.Println(<span class="string">"received from c2:"</span>, n)</span><br><span class="line">        <span class="keyword">case</span> w &lt;- n: <span class="comment">// 也可以发 但是因为w不是nil 如果n没有值他会输出零值 这里就会无限循环走这个逻辑</span></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line">----</span><br><span class="line">received <span class="number">5</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">5</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">5</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">5</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">5</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">5</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">5</span></span><br><span class="line">----下面这段运行不出来了</span><br><span class="line">received from c2: <span class="number">0</span></span><br><span class="line">received from c1: <span class="number">0</span></span><br><span class="line">received from c1: <span class="number">1</span></span><br><span class="line">received from c2: <span class="number">1</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">0</span></span><br><span class="line">received from c2: <span class="number">2</span></span><br><span class="line">received from c1: <span class="number">2</span></span><br><span class="line">received from c2: <span class="number">3</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">1</span></span><br><span class="line">received from c1: <span class="number">3</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">3</span></span><br><span class="line">received from c1: <span class="number">4</span></span><br></pre></td></tr></tbody></table></figure>

<p>解决办法利用chan的nil值</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">worker</span><span class="params">(id <span class="keyword">int</span>, c <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> {</span><br><span class="line">    <span class="keyword">for</span> n := <span class="keyword">range</span> c {</span><br><span class="line">        <span class="comment">//time.Sleep(time.Second)</span></span><br><span class="line">        fmt.Printf(<span class="string">"Worker %d received %d\n"</span>, id, n)</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">var</span> c1, c2 = generator(), generator()</span><br><span class="line">    w := createWorker(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">var</span> n <span class="keyword">int</span></span><br><span class="line">    hasValue := <span class="literal">false</span></span><br><span class="line">    <span class="keyword">for</span> {</span><br><span class="line">        <span class="keyword">var</span> activeWork <span class="keyword">chan</span>&lt;- <span class="keyword">int</span></span><br><span class="line">        <span class="keyword">if</span> hasValue {</span><br><span class="line">            activeWork = w</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">select</span> { <span class="comment">//哪一个条件满足就走哪个条件</span></span><br><span class="line">        <span class="keyword">case</span> n = &lt;-c1:</span><br><span class="line">            hasValue = <span class="literal">true</span></span><br><span class="line">        <span class="keyword">case</span> n = &lt;-c2:</span><br><span class="line">            hasValue = <span class="literal">true</span></span><br><span class="line">        <span class="keyword">case</span> activeWork &lt;- n: <span class="comment">// 这样的话如果hasValue为false 这里activeWork为nil这样就会被阻塞住</span></span><br><span class="line">            hasValue = <span class="literal">false</span> <span class="comment">// 但是这样数据会丢失因为接收和发送的速度不匹配，可以弄一个队列然后存到队列中去 然后hasValue的判断规则为队列长度是否大于0</span></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line">----</span><br><span class="line">Worker <span class="number">0</span> received <span class="number">0</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">0</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">1</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">1</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">2</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">2</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">3</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">3</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">4</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">5</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">4</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">5</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">6</span></span><br><span class="line">...</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">worker</span><span class="params">(id <span class="keyword">int</span>, c <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> {</span><br><span class="line">    <span class="keyword">for</span> n := <span class="keyword">range</span> c {</span><br><span class="line">        time.Sleep(<span class="number">5</span> * time.Second) <span class="comment">// 消耗数据过慢，数据没有被存下来，新接收的数据会把之前接收的数据覆盖</span></span><br><span class="line">        fmt.Printf(<span class="string">"Worker %d received %d\n"</span>, id, n)</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">var</span> c1, c2 = generator(), generator()</span><br><span class="line">    w := createWorker(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">var</span> n <span class="keyword">int</span></span><br><span class="line">    hasValue := <span class="literal">false</span></span><br><span class="line">    <span class="keyword">for</span> {</span><br><span class="line">        <span class="keyword">var</span> activeWork <span class="keyword">chan</span>&lt;- <span class="keyword">int</span></span><br><span class="line">        <span class="keyword">if</span> hasValue {</span><br><span class="line">            activeWork = w</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">select</span> { <span class="comment">//哪一个条件满足就走哪个条件</span></span><br><span class="line">        <span class="keyword">case</span> n = &lt;-c1:</span><br><span class="line">            hasValue = <span class="literal">true</span></span><br><span class="line">        <span class="keyword">case</span> n = &lt;-c2:</span><br><span class="line">            hasValue = <span class="literal">true</span></span><br><span class="line">        <span class="keyword">case</span> activeWork &lt;- n: <span class="comment">//这样的话如果hasValue为false 这里activeWork为nil这样就会被阻塞住</span></span><br><span class="line">            hasValue = <span class="literal">false</span> <span class="comment">// 但是这样数据会丢失因为接收和发送的速度不匹配，可以弄一个队列然后存到队列中去 然后hasValue的判断规则为队列长度是否大于0</span></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line">----</span><br><span class="line">Worker <span class="number">0</span> received <span class="number">0</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">7</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">12</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">18</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">26</span></span><br><span class="line">...</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">createWorker</span><span class="params">(id <span class="keyword">int</span>)</span> <span class="title">chan</span>&lt;- <span class="title">int</span></span> {</span><br><span class="line">    w := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">        <span class="keyword">for</span> {</span><br><span class="line">            fmt.Printf(<span class="string">"worker %d receiver:%d\n"</span>, id, &lt;-w)</span><br><span class="line">        }</span><br><span class="line">    }()</span><br><span class="line">    <span class="keyword">return</span> w</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">generator</span><span class="params">()</span> <span class="title">chan</span> <span class="title">int</span></span> {</span><br><span class="line">    c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line">    i := <span class="number">0</span></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">        <span class="keyword">for</span> {</span><br><span class="line">            time.Sleep(time.Millisecond * time.Duration(rand.Intn(<span class="number">1500</span>)))</span><br><span class="line">            c &lt;- i</span><br><span class="line">            i++</span><br><span class="line">        }</span><br><span class="line">    }()</span><br><span class="line">    <span class="keyword">return</span> c</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">var</span> c1, c2 = generator(), generator()</span><br><span class="line">    w := createWorker(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">var</span> n <span class="keyword">int</span></span><br><span class="line">    hasValue := <span class="literal">false</span></span><br><span class="line">    <span class="keyword">for</span> {</span><br><span class="line">        <span class="keyword">var</span> activeWork <span class="keyword">chan</span>&lt;- <span class="keyword">int</span></span><br><span class="line">        <span class="keyword">if</span> hasValue {</span><br><span class="line">            activeWork = w</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">select</span> { <span class="comment">//哪一个条件满足就走哪个条件</span></span><br><span class="line">        <span class="keyword">case</span> n = &lt;-c1:</span><br><span class="line">            hasValue = <span class="literal">true</span></span><br><span class="line">            fmt.Println(<span class="string">"received from c1:"</span>, n)</span><br><span class="line">        <span class="keyword">case</span> n = &lt;-c2:</span><br><span class="line">            hasValue = <span class="literal">true</span></span><br><span class="line">            fmt.Println(<span class="string">"received from c2:"</span>, n)</span><br><span class="line">        <span class="keyword">case</span> activeWork &lt;- n: <span class="comment">//这样的话如果hasValue为false 这里activeWork为nil这样就会被阻塞住</span></span><br><span class="line">            hasValue = <span class="literal">false</span> <span class="comment">// 但是这样数据会丢失因为接收和发送的速度不匹配，可以弄一个队列然后存到队列中去 然后hasValue的判断规则为队列长度是否大于0</span></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line">----</span><br><span class="line">received from c2: <span class="number">0</span></span><br><span class="line">received from c1: <span class="number">0</span></span><br><span class="line">received from c1: <span class="number">1</span></span><br><span class="line">received from c2: <span class="number">1</span></span><br><span class="line">received from c2: <span class="number">2</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">0</span></span><br><span class="line">received from c1: <span class="number">2</span></span><br><span class="line">received from c2: <span class="number">3</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">2</span></span><br><span class="line">received from c1: <span class="number">3</span></span><br><span class="line">received from c1: <span class="number">4</span></span><br><span class="line">received from c1: <span class="number">5</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">3</span></span><br><span class="line">received from c2: <span class="number">4</span></span><br><span class="line">received from c2: <span class="number">5</span></span><br><span class="line">received from c2: <span class="number">6</span></span><br><span class="line">received from c1: <span class="number">6</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">5</span></span><br><span class="line">received from c2: <span class="number">7</span></span><br><span class="line">received from c1: <span class="number">7</span></span><br></pre></td></tr></tbody></table></figure>




<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">worker</span><span class="params">(id <span class="keyword">int</span>, c <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> {</span><br><span class="line">    <span class="keyword">for</span> n := <span class="keyword">range</span> c {</span><br><span class="line">        time.Sleep(time.Second)</span><br><span class="line">        fmt.Printf(<span class="string">"Worker %d received %d\n"</span>,</span><br><span class="line">            id, n)</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line">    <span class="keyword">var</span> c1, c2 = generator(), generator()</span><br><span class="line">    w := createWorker(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">var</span> values []<span class="keyword">int</span></span><br><span class="line">    <span class="keyword">for</span> {</span><br><span class="line">        <span class="keyword">var</span> activeWorker <span class="keyword">chan</span>&lt;- <span class="keyword">int</span></span><br><span class="line">        <span class="keyword">var</span> activeValue <span class="keyword">int</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(values) &gt; <span class="number">0</span> {</span><br><span class="line">            activeWorker = w</span><br><span class="line">            activeValue = values[<span class="number">0</span>]</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">select</span> { <span class="comment">//哪一个条件满足就走哪个条件</span></span><br><span class="line">        <span class="keyword">case</span> n := &lt;-c1:</span><br><span class="line">            values = <span class="built_in">append</span>(values, n)</span><br><span class="line">        <span class="keyword">case</span> n := &lt;-c2:</span><br><span class="line">            values = <span class="built_in">append</span>(values, n)</span><br><span class="line">        <span class="keyword">case</span> activeWorker &lt;- activeValue:</span><br><span class="line">            values = values[<span class="number">1</span>:] <span class="comment">//弄一个队列然后存到队列中去 然后hasValue的判断规则为队列长度是否大于0</span></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">----</span><br><span class="line">Worker <span class="number">0</span> received <span class="number">0</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">0</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">1</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">1</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">2</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">2</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">3</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">3</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">4</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">5</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">4</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">----</span><br><span class="line">set one =  <span class="number">0</span></span><br><span class="line">set one =  <span class="number">1</span></span><br><span class="line">set one =  <span class="number">2</span></span><br><span class="line">set one =  <span class="number">3</span></span><br><span class="line">set one =  <span class="number">4</span></span><br><span class="line">set one =  <span class="number">5</span></span><br><span class="line">set one =  <span class="number">6</span></span><br><span class="line">set one =  <span class="number">7</span></span><br><span class="line">set one =  <span class="number">8</span></span><br><span class="line">set one =  <span class="number">9</span></span><br><span class="line">get two =  a</span><br><span class="line">[D] [router.<span class="keyword">go</span>:<span class="number">955</span>]  |      <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>| <span class="number">200</span> |      <span class="number">442.9</span>µs|   match| GET      /<span class="keyword">go</span>/<span class="keyword">select</span>/demo   r:/<span class="keyword">go</span>/<span class="keyword">select</span>/demo</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></tbody></table></figure>


<p>Timer和Ticker</p>
<p>关于时间的两个Channel。<br>timer是一个定时器，代表未来的一个单一事件，你可以告诉timer你要等待多长时间，它提供一个Channel，在将来的那个时间那个Channel提供了一个时间值。<br>下面的例子中第二行会阻塞2秒钟左右的时间，直到时间到了才会继续执行。</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">    timer1 := time.NewTimer(time.Second * <span class="number">2</span>)</span><br><span class="line">    &lt;-timer1.C</span><br><span class="line">    fmt.Println(<span class="string">"Timer 1 expired"</span>)</span><br><span class="line">----</span><br><span class="line">Timer <span class="number">1</span> expired</span><br><span class="line">[Done] exited with code=<span class="number">0</span> in <span class="number">2.653</span> seconds</span><br></pre></td></tr></tbody></table></figure>

<p>当然如果你只是想单纯的等待的话，可以使用 <code>time.Sleep</code> 来实现。<br>你还可以使用 <code>timer.Stop</code> 来停止计时器。</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">    timer2 := time.NewTimer(time.Second)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">        &lt;-timer2.C</span><br><span class="line">        fmt.Println(<span class="string">"Timer 2 expired"</span>)</span><br><span class="line">    }()</span><br><span class="line">    stop2 := timer2.Stop()</span><br><span class="line">    <span class="keyword">if</span> stop2 {</span><br><span class="line">        fmt.Println(<span class="string">"Timer 2 stopped"</span>)</span><br><span class="line">    }</span><br><span class="line">----</span><br><span class="line">Timer <span class="number">2</span> stopped</span><br><span class="line">[Done] exited with code=<span class="number">0</span> in <span class="number">0.699</span> seconds</span><br></pre></td></tr></tbody></table></figure>

<p><code>ticker</code> 是一个定时触发的计时器，它会以一个间隔(interval)往Channel发送一个事件(当前时间)，而Channel的接收者可以以固定的时间间隔从Channel中读取事件。</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Tick is a convenience wrapper for NewTicker providing access to the ticking</span></span><br><span class="line"><span class="comment">// channel only. While Tick is useful for clients that have no need to shut down</span></span><br><span class="line"><span class="comment">// the Ticker, be aware that without a way to shut it down the underlying</span></span><br><span class="line"><span class="comment">// Ticker cannot be recovered by the garbage collector; it "leaks".</span></span><br><span class="line"><span class="comment">// Unlike NewTicker, Tick will return nil if d &lt;= 0.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Tick</span><span class="params">(d Duration)</span> &lt;-<span class="title">chan</span> <span class="title">Time</span></span> {</span><br><span class="line">    <span class="keyword">if</span> d &lt;= <span class="number">0</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> NewTicker(d).C</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>下面的例子中ticker每500毫秒触发一次，你可以观察输出的时间。</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">    ticker := time.NewTicker(time.Millisecond * <span class="number">500</span>)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">        <span class="keyword">for</span> t := <span class="keyword">range</span> ticker.C {</span><br><span class="line">            fmt.Println(<span class="string">"Tick at"</span>, t)</span><br><span class="line">        }</span><br><span class="line">    }()</span><br><span class="line">----</span><br><span class="line">[Done] exited with code=<span class="number">0</span> in <span class="number">0.496</span> seconds</span><br></pre></td></tr></tbody></table></figure>

<p>类似timer, ticker也可以通过 <code>Stop</code> 方法来停止。一旦它停止，接收者不再会从channel中接收数据了。</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"math/rand"</span></span><br><span class="line">    <span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">generator</span><span class="params">()</span> <span class="title">chan</span> <span class="title">int</span></span> {</span><br><span class="line">    out := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">        i := <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> {</span><br><span class="line">            time.Sleep(time.Duration(rand.Intn(<span class="number">1500</span>)) *time.Millisecond)</span><br><span class="line">            out &lt;- i</span><br><span class="line">            i++</span><br><span class="line">        }</span><br><span class="line">    }()</span><br><span class="line">    <span class="keyword">return</span> out</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">worker</span><span class="params">(id <span class="keyword">int</span>, c <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> {</span><br><span class="line">    <span class="keyword">for</span> n := <span class="keyword">range</span> c {</span><br><span class="line">        time.Sleep(time.Second)</span><br><span class="line">        fmt.Printf(<span class="string">"Worker %d received %d\n"</span>,</span><br><span class="line">            id, n)</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">createWorker</span><span class="params">(id <span class="keyword">int</span>)</span> <span class="title">chan</span>&lt;- <span class="title">int</span></span> {</span><br><span class="line">    c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line">    <span class="keyword">go</span> worker(id, c)</span><br><span class="line">    <span class="keyword">return</span> c</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">var</span> c1, c2 = generator(), generator()</span><br><span class="line">    <span class="keyword">var</span> worker = createWorker(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> values []<span class="keyword">int</span></span><br><span class="line">    tm := time.After(<span class="number">10</span> * time.Second) <span class="comment">//10s过后，会往tm通道发送数据</span></span><br><span class="line">    tick := time.Tick(time.Second) <span class="comment">// 定时</span></span><br><span class="line">    <span class="keyword">for</span> {</span><br><span class="line">        <span class="keyword">var</span> activeWorker <span class="keyword">chan</span>&lt;- <span class="keyword">int</span> <span class="comment">// 定义不初始化为 nil，发送始终是阻塞</span></span><br><span class="line">        <span class="keyword">var</span> activeValue <span class="keyword">int</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(values) &gt; <span class="number">0</span> {</span><br><span class="line">            activeWorker = worker <span class="comment">// 有值才初始化，可以收发数据</span></span><br><span class="line">            activeValue = values[<span class="number">0</span>]</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">select</span> {</span><br><span class="line">        <span class="keyword">case</span> n := &lt;-c1:</span><br><span class="line">            values = <span class="built_in">append</span>(values, n)</span><br><span class="line">        <span class="keyword">case</span> n := &lt;-c2:</span><br><span class="line">            values = <span class="built_in">append</span>(values, n)</span><br><span class="line">        <span class="keyword">case</span> activeWorker &lt;- activeValue:</span><br><span class="line">            values = values[<span class="number">1</span>:]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> &lt;-time.After(<span class="number">800</span> * time.Millisecond): <span class="comment">// 每次select花的时间，每两次生成数据之间的时间差超过800毫秒，800毫秒以内没有生成数据</span></span><br><span class="line">            fmt.Println(<span class="string">"timeout"</span>)</span><br><span class="line">        <span class="keyword">case</span> &lt;-tick:</span><br><span class="line">            fmt.Println(<span class="string">"queue len ="</span>, <span class="built_in">len</span>(values))</span><br><span class="line">        <span class="keyword">case</span> &lt;-tm: <span class="comment">// 程序开始到运行到这一行的时间  10s过后bye</span></span><br><span class="line">            fmt.Println(<span class="string">"bye"</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line">----</span><br><span class="line">queue <span class="built_in">len</span> = <span class="number">3</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">0</span></span><br><span class="line">queue <span class="built_in">len</span> = <span class="number">5</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">0</span></span><br><span class="line">queue <span class="built_in">len</span> = <span class="number">5</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">1</span></span><br><span class="line">queue <span class="built_in">len</span> = <span class="number">10</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">1</span></span><br><span class="line">queue <span class="built_in">len</span> = <span class="number">10</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">2</span></span><br><span class="line">queue <span class="built_in">len</span> = <span class="number">11</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">2</span></span><br><span class="line">queue <span class="built_in">len</span> = <span class="number">12</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">3</span></span><br><span class="line">queue <span class="built_in">len</span> = <span class="number">13</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">3</span></span><br><span class="line">queue <span class="built_in">len</span> = <span class="number">14</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">4</span></span><br><span class="line">bye</span><br></pre></td></tr></tbody></table></figure>

<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/08/23/go-de-context/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/08/23/go-de-context/" class="post-title-link" itemprop="url">go的context</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-08-22 16:21:41" itemprop="dateCreated datePublished" datetime="2021-08-22T16:21:41Z">2021-08-22</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-09-21 11:44:35" itemprop="dateModified" datetime="2021-09-21T11:44:35Z">2021-09-21</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>监控</p>
<p>法一：全局变量</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"sync"</span></span><br><span class="line">    <span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"><span class="keyword">var</span> stop <span class="keyword">bool</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">cpuInfo</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">defer</span> wg.Done()</span><br><span class="line">    <span class="keyword">for</span> {</span><br><span class="line">        <span class="keyword">if</span> stop {</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        }</span><br><span class="line">        time.Sleep(time.Second * <span class="number">2</span>)</span><br><span class="line">        fmt.Println(<span class="string">"cpu信息读取完成"</span>)</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    wg.Add(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">go</span> cpuInfo()</span><br><span class="line">    time.Sleep(time.Second * <span class="number">6</span>)</span><br><span class="line">    stop = <span class="literal">true</span></span><br><span class="line">    wg.Wait()</span><br><span class="line">    fmt.Println(<span class="string">"信息监控完成"</span>)</span><br><span class="line">}</span><br><span class="line">---</span><br><span class="line">cpu信息读取完成</span><br><span class="line">cpu信息读取完成</span><br><span class="line">cpu信息读取完成</span><br><span class="line">信息监控完成</span><br></pre></td></tr></tbody></table></figure>

<p>法二：通道</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> stop = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">cpuInfo</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">defer</span> wg.Done()</span><br><span class="line">    <span class="keyword">for</span> {</span><br><span class="line">        <span class="keyword">select</span> {</span><br><span class="line">        <span class="keyword">case</span> &lt;-stop:</span><br><span class="line">            fmt.Println(<span class="string">"退出cpu监控"</span>)</span><br><span class="line">        }</span><br><span class="line">        time.Sleep(time.Second * <span class="number">2</span>)</span><br><span class="line">        fmt.Println(<span class="string">"cpu信息读取完成"</span>)</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    wg.Add(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">go</span> cpuInfo()</span><br><span class="line">    time.Sleep(time.Second * <span class="number">6</span>)</span><br><span class="line">    stop &lt;- <span class="literal">true</span></span><br><span class="line">    wg.Wait()</span><br><span class="line">    fmt.Println(<span class="string">"信息监控完成"</span>)</span><br><span class="line">}</span><br><span class="line">----</span><br><span class="line">退出cpu监控</span><br><span class="line">cpu信息读取完成</span><br><span class="line">fatal error: all goroutines are asleep - deadlock! 因为第二次读取会阻塞</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> stop = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">cpuInfo</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">defer</span> wg.Done()</span><br><span class="line">Loop:</span><br><span class="line">    <span class="keyword">for</span> {</span><br><span class="line">        <span class="keyword">select</span> {</span><br><span class="line">        <span class="keyword">case</span> &lt;-stop:</span><br><span class="line">            fmt.Println(<span class="string">"退出cpu监控"</span>)</span><br><span class="line">            <span class="keyword">break</span> Loop</span><br><span class="line">        }</span><br><span class="line">        time.Sleep(time.Second * <span class="number">2</span>)</span><br><span class="line">        fmt.Println(<span class="string">"cpu信息读取完成"</span>)</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    wg.Add(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">go</span> cpuInfo()</span><br><span class="line">    time.Sleep(time.Second * <span class="number">6</span>)</span><br><span class="line">    stop &lt;- <span class="literal">true</span></span><br><span class="line">    wg.Wait()</span><br><span class="line">    fmt.Println(<span class="string">"信息监控完成"</span>)</span><br><span class="line">}</span><br><span class="line">----</span><br><span class="line">退出cpu监控</span><br><span class="line">信息监控完成</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> stop = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">cpuInfo</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">defer</span> wg.Done()</span><br><span class="line">Loop:</span><br><span class="line">    <span class="keyword">for</span> {</span><br><span class="line">        <span class="keyword">select</span> {</span><br><span class="line">        <span class="keyword">case</span> &lt;-stop:</span><br><span class="line">            fmt.Println(<span class="string">"退出cpu监控"</span>)</span><br><span class="line">            <span class="keyword">break</span> Loop</span><br><span class="line">        <span class="keyword">default</span>: <span class="comment">// 多一个default结果不一样</span></span><br><span class="line">        }</span><br><span class="line">        time.Sleep(time.Second * <span class="number">2</span>)</span><br><span class="line">        fmt.Println(<span class="string">"cpu信息读取完成"</span>)</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    wg.Add(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">go</span> cpuInfo()</span><br><span class="line">    time.Sleep(time.Second * <span class="number">6</span>)</span><br><span class="line">    stop &lt;- <span class="literal">true</span></span><br><span class="line">    wg.Wait()</span><br><span class="line">    fmt.Println(<span class="string">"信息监控完成"</span>)</span><br><span class="line">}</span><br><span class="line">----</span><br><span class="line">cpu信息读取完成</span><br><span class="line">cpu信息读取完成</span><br><span class="line">cpu信息读取完成</span><br><span class="line">cpu信息读取完成</span><br><span class="line">退出cpu监控</span><br><span class="line">信息监控完成</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> stop <span class="keyword">chan</span> <span class="keyword">bool</span> = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">cpuInfo</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">defer</span> wg.Done()</span><br><span class="line">    <span class="keyword">for</span> {</span><br><span class="line">        <span class="keyword">select</span> {</span><br><span class="line">        <span class="keyword">case</span> &lt;-stop:</span><br><span class="line">            fmt.Println(<span class="string">"退出cpu监控"</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        }</span><br><span class="line">        time.Sleep(time.Second * <span class="number">2</span>)</span><br><span class="line">        fmt.Println(<span class="string">"cpu信息读取完成"</span>)</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    wg.Add(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">go</span> cpuInfo()</span><br><span class="line">    time.Sleep(time.Second * <span class="number">6</span>)</span><br><span class="line">    stop &lt;- <span class="literal">true</span></span><br><span class="line">    wg.Wait()</span><br><span class="line">    fmt.Println(<span class="string">"信息监控完成"</span>)</span><br><span class="line">}</span><br><span class="line">----</span><br><span class="line">退出cpu监控</span><br><span class="line">信息监控完成</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> stop <span class="keyword">chan</span> <span class="keyword">bool</span> = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">cpuInfo</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">defer</span> wg.Done()</span><br><span class="line">    <span class="keyword">for</span> {</span><br><span class="line">        <span class="keyword">select</span> {</span><br><span class="line">        <span class="keyword">case</span> &lt;-stop:</span><br><span class="line">            fmt.Println(<span class="string">"退出cpu监控"</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            time.Sleep(time.Second * <span class="number">2</span>)</span><br><span class="line">            fmt.Println(<span class="string">"cpu信息读取完成"</span>)</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    wg.Add(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">go</span> cpuInfo()</span><br><span class="line">    time.Sleep(time.Second * <span class="number">6</span>)</span><br><span class="line">    stop &lt;- <span class="literal">true</span></span><br><span class="line">    wg.Wait()</span><br><span class="line">    fmt.Println(<span class="string">"信息监控完成"</span>)</span><br><span class="line">}</span><br><span class="line">---</span><br><span class="line">cpu信息读取完成</span><br><span class="line">cpu信息读取完成</span><br><span class="line">cpu信息读取完成</span><br><span class="line">退出cpu监控</span><br><span class="line">信息监控完成</span><br></pre></td></tr></tbody></table></figure>

<p>主协程中取消子协程</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A Context carries a deadline, a cancellation signal, and other values across</span></span><br><span class="line"><span class="comment">// API boundaries.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Context's methods may be called by multiple goroutines simultaneously.</span></span><br><span class="line"><span class="keyword">type</span> Context <span class="keyword">interface</span> {</span><br><span class="line">    <span class="comment">// Deadline returns the time when work done on behalf of this context</span></span><br><span class="line">    <span class="comment">// should be canceled. Deadline returns ok==false when no deadline is</span></span><br><span class="line">    <span class="comment">// set. Successive calls to Deadline return the same results.</span></span><br><span class="line">    Deadline() (deadline time.Time, ok <span class="keyword">bool</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Done returns a channel that's closed when work done on behalf of this</span></span><br><span class="line">    <span class="comment">// context should be canceled. Done may return nil if this context can</span></span><br><span class="line">    <span class="comment">// never be canceled. Successive calls to Done return the same value.</span></span><br><span class="line">    <span class="comment">// The close of the Done channel may happen asynchronously,</span></span><br><span class="line">    <span class="comment">// after the cancel function returns.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// WithCancel arranges for Done to be closed when cancel is called;</span></span><br><span class="line">    <span class="comment">// WithDeadline arranges for Done to be closed when the deadline</span></span><br><span class="line">    <span class="comment">// expires; WithTimeout arranges for Done to be closed when the timeout</span></span><br><span class="line">    <span class="comment">// elapses.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// Done is provided for use in select statements:</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  // Stream generates values with DoSomething and sends them to out</span></span><br><span class="line">    <span class="comment">//  // until DoSomething returns an error or ctx.Done is closed.</span></span><br><span class="line">    <span class="comment">//  func Stream(ctx context.Context, out chan&lt;- Value) error {</span></span><br><span class="line">    <span class="comment">//      for {</span></span><br><span class="line">    <span class="comment">//          v, err := DoSomething(ctx)</span></span><br><span class="line">    <span class="comment">//          if err != nil {</span></span><br><span class="line">    <span class="comment">//              return err</span></span><br><span class="line">    <span class="comment">//          }</span></span><br><span class="line">    <span class="comment">//          select {</span></span><br><span class="line">    <span class="comment">//          case &lt;-ctx.Done():</span></span><br><span class="line">    <span class="comment">//              return ctx.Err()</span></span><br><span class="line">    <span class="comment">//          case out &lt;- v:</span></span><br><span class="line">    <span class="comment">//          }</span></span><br><span class="line">    <span class="comment">//      }</span></span><br><span class="line">    <span class="comment">//  }</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// See https://blog.golang.org/pipelines for more examples of how to use</span></span><br><span class="line">    <span class="comment">// a Done channel for cancellation.</span></span><br><span class="line">    Done() &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>{}</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If Done is not yet closed, Err returns nil.</span></span><br><span class="line">    <span class="comment">// If Done is closed, Err returns a non-nil error explaining why:</span></span><br><span class="line">    <span class="comment">// Canceled if the context was canceled</span></span><br><span class="line">    <span class="comment">// or DeadlineExceeded if the context's deadline passed.</span></span><br><span class="line">    <span class="comment">// After Err returns a non-nil error, successive calls to Err return the same error.</span></span><br><span class="line">    Err() error</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Value returns the value associated with this context for key, or nil</span></span><br><span class="line">    <span class="comment">// if no value is associated with key. Successive calls to Value with</span></span><br><span class="line">    <span class="comment">// the same key returns the same result.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// Use context values only for request-scoped data that transits</span></span><br><span class="line">    <span class="comment">// processes and API boundaries, not for passing optional parameters to</span></span><br><span class="line">    <span class="comment">// functions.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// A key identifies a specific value in a Context. Functions that wish</span></span><br><span class="line">    <span class="comment">// to store values in Context typically allocate a key in a global</span></span><br><span class="line">    <span class="comment">// variable then use that key as the argument to context.WithValue and</span></span><br><span class="line">    <span class="comment">// Context.Value. A key can be any type that supports equality;</span></span><br><span class="line">    <span class="comment">// packages should define keys as an unexported type to avoid</span></span><br><span class="line">    <span class="comment">// collisions.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// Packages that define a Context key should provide type-safe accessors</span></span><br><span class="line">    <span class="comment">// for the values stored using that key:</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//     // Package user defines a User type that's stored in Contexts.</span></span><br><span class="line">    <span class="comment">//     package user</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//     import "context"</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//     // User is the type of value stored in the Contexts.</span></span><br><span class="line">    <span class="comment">//     type User struct {...}</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//     // key is an unexported type for keys defined in this package.</span></span><br><span class="line">    <span class="comment">//     // This prevents collisions with keys defined in other packages.</span></span><br><span class="line">    <span class="comment">//     type key int</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//     // userKey is the key for user.User values in Contexts. It is</span></span><br><span class="line">    <span class="comment">//     // unexported; clients use user.NewContext and user.FromContext</span></span><br><span class="line">    <span class="comment">//     // instead of using this key directly.</span></span><br><span class="line">    <span class="comment">//     var userKey key</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//     // NewContext returns a new Context that carries value u.</span></span><br><span class="line">    <span class="comment">//     func NewContext(ctx context.Context, u *User) context.Context {</span></span><br><span class="line">    <span class="comment">//         return context.WithValue(ctx, userKey, u)</span></span><br><span class="line">    <span class="comment">//     }</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//     // FromContext returns the User value stored in ctx, if any.</span></span><br><span class="line">    <span class="comment">//     func FromContext(ctx context.Context) (*User, bool) {</span></span><br><span class="line">    <span class="comment">//         u, ok := ctx.Value(userKey).(*User)</span></span><br><span class="line">    <span class="comment">//         return u, ok</span></span><br><span class="line">    <span class="comment">//     }</span></span><br><span class="line">    Value(key <span class="keyword">interface</span>{}) <span class="keyword">interface</span>{}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>context.Context 是 Go 提供的线程安全工具，称为上下文。<br>方法：<br>• WithTimeout：一般用户控制超时</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">    ctx, cancel := context.WithTimeout(context.Background(), time.Second * <span class="number">2</span>)</span><br><span class="line">    <span class="keyword">defer</span> cancel()</span><br><span class="line"></span><br><span class="line">    start := time.Now().Unix()</span><br><span class="line">    &lt;- ctx.Done()</span><br><span class="line">    end := time.Now().Unix()</span><br><span class="line">    fmt.Println(end-start)</span><br><span class="line">----</span><br><span class="line"><span class="number">2</span></span><br><span class="line"></span><br><span class="line">[Done] exited with code=<span class="number">0</span> in <span class="number">2.589</span> seconds</span><br><span class="line">说明在 ctx.Done()这里阻塞了两秒</span><br></pre></td></tr></tbody></table></figure>

<p>• WithCancel：用于取消整条链上的任务</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WithCancel returns a copy of parent with a new Done channel. The returned</span></span><br><span class="line"><span class="comment">// context's Done channel is closed when the returned cancel function is called</span></span><br><span class="line"><span class="comment">// or when the parent context's Done channel is closed, whichever happens first.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Canceling this context releases resources associated with it, so code should</span></span><br><span class="line"><span class="comment">// call cancel as soon as the operations running in this Context complete.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithCancel</span><span class="params">(parent Context)</span> <span class="params">(ctx Context, cancel CancelFunc)</span></span> {</span><br><span class="line">    <span class="keyword">if</span> parent == <span class="literal">nil</span> {</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">"cannot create context from nil parent"</span>)</span><br><span class="line">    }</span><br><span class="line">    c := newCancelCtx(parent)</span><br><span class="line">    propagateCancel(parent, &amp;c)</span><br><span class="line">    <span class="keyword">return</span> &amp;c, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> { c.cancel(<span class="literal">true</span>, Canceled) }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// newCancelCtx returns an initialized cancelCtx.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newCancelCtx</span><span class="params">(parent Context)</span> <span class="title">cancelCtx</span></span> {</span><br><span class="line">    <span class="keyword">return</span> cancelCtx{Context: parent}</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// A cancelCtx can be canceled. When canceled, it also cancels any children</span></span><br><span class="line"><span class="comment">// that implement canceler.</span></span><br><span class="line"><span class="keyword">type</span> cancelCtx <span class="keyword">struct</span> {</span><br><span class="line">    Context</span><br><span class="line"></span><br><span class="line">    mu       sync.Mutex            <span class="comment">// protects following fields</span></span><br><span class="line">    done     atomic.Value          <span class="comment">// of chan struct{}, created lazily, closed by first cancel call</span></span><br><span class="line">    children <span class="keyword">map</span>[canceler]<span class="keyword">struct</span>{} <span class="comment">// set to nil by the first cancel call</span></span><br><span class="line">    err      error                 <span class="comment">// set to non-nil by the first cancel call</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *cancelCtx)</span> <span class="title">Value</span><span class="params">(key <span class="keyword">interface</span>{})</span> <span class="title">interface</span></span>{} {</span><br><span class="line">    <span class="keyword">if</span> key == &amp;cancelCtxKey {</span><br><span class="line">        <span class="keyword">return</span> c</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> c.Context.Value(key)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *cancelCtx)</span> <span class="title">Done</span><span class="params">()</span> &lt;-<span class="title">chan</span> <span class="title">struct</span></span>{} {</span><br><span class="line">    d := c.done.Load()</span><br><span class="line">    <span class="keyword">if</span> d != <span class="literal">nil</span> {</span><br><span class="line">        <span class="keyword">return</span> d.(<span class="keyword">chan</span> <span class="keyword">struct</span>{})</span><br><span class="line">    }</span><br><span class="line">    c.mu.Lock()</span><br><span class="line">    <span class="keyword">defer</span> c.mu.Unlock()</span><br><span class="line">    d = c.done.Load()</span><br><span class="line">    <span class="keyword">if</span> d == <span class="literal">nil</span> {</span><br><span class="line">        d = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>{})</span><br><span class="line">        c.done.Store(d)</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> d.(<span class="keyword">chan</span> <span class="keyword">struct</span>{})</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *cancelCtx)</span> <span class="title">Err</span><span class="params">()</span> <span class="title">error</span></span> {</span><br><span class="line">    c.mu.Lock()</span><br><span class="line">    err := c.err</span><br><span class="line">    c.mu.Unlock()</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">    ctx, cancel := context.WithCancel(context.Background())</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">        &lt;- ctx.Done()</span><br><span class="line">        fmt.Println(<span class="string">"context was canceled"</span>)</span><br><span class="line">    }()</span><br><span class="line">    <span class="comment">// 确保我们的 goroutine进去执行了</span></span><br><span class="line">    time.Sleep(time.Second)</span><br><span class="line">    cancel()</span><br><span class="line">    <span class="comment">// 确保后面那句打印出来了</span></span><br><span class="line">    time.Sleep(time.Second)</span><br><span class="line">----</span><br><span class="line">context was canceled</span><br><span class="line"></span><br><span class="line">[Done] exited with code=<span class="number">0</span> in <span class="number">2.669</span> seconds</span><br></pre></td></tr></tbody></table></figure>

<p>• WithDeadline：控制时间</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 设置两秒后超时</span></span><br><span class="line">    ctx, cancel := context.WithDeadline(context.Background(),</span><br><span class="line">        time.Now().Add(<span class="number">2</span> * time.Second))</span><br><span class="line">    <span class="keyword">defer</span> cancel()</span><br><span class="line"></span><br><span class="line">    start := time.Now().Unix()</span><br><span class="line">    &lt;- ctx.Done()</span><br><span class="line">    end := time.Now().Unix()</span><br><span class="line">    <span class="comment">// 输出2，说明在 ctx.Done()这里阻塞了两秒</span></span><br><span class="line">    fmt.Println(end-start)</span><br><span class="line">----</span><br><span class="line"><span class="number">2</span></span><br><span class="line"></span><br><span class="line">[Done] exited with code=<span class="number">0</span> in <span class="number">2.614</span> seconds</span><br></pre></td></tr></tbody></table></figure>

<p>• WithValue：往里面塞入 key-value</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">    parentKey := <span class="string">"parent"</span></span><br><span class="line">    parent := context.WithValue(context.Background(), parentKey, <span class="string">"this is parent"</span>)</span><br><span class="line"></span><br><span class="line">    sonKey := <span class="string">"son"</span></span><br><span class="line">    son := context.WithValue(parent, sonKey, <span class="string">"this is son"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 尝试从 parent 里面拿出来 key = son的，会拿不到</span></span><br><span class="line">    <span class="keyword">if</span> parent.Value(parentKey) == <span class="literal">nil</span> {</span><br><span class="line">        fmt.Printf(<span class="string">"parent can not get son's key-value pair"</span>)</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> val := son.Value(parentKey); val != <span class="literal">nil</span> {</span><br><span class="line">        fmt.Printf(<span class="string">"parent can not get son's key-value pair"</span>)</span><br><span class="line">    }</span><br><span class="line">----</span><br><span class="line">parent can not get son<span class="string">'s key-value pair</span></span><br><span class="line"><span class="string">[Done] exited with code=0 in 0.6 seconds</span></span><br></pre></td></tr></tbody></table></figure>

<p>• Backgroud：返回一个空的 context.Context</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>• ToDo：返回一个空的 context.Context，但是这个标记着你也不知道传什么</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></tbody></table></figure>


<p>因为缺乏 thread-local，所以很多时候我们要实现类似的功能，都只能依赖于 context 在方法直接传递。<br>因此一般建议自己的方法签名，都把 context.Context 作为第一个参数</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"context"</span></span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"sync"</span></span><br><span class="line">    <span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">cpuInfo</span><span class="params">(ctx context.Context)</span></span> {</span><br><span class="line">    <span class="keyword">defer</span> wg.Done()</span><br><span class="line">    <span class="keyword">for</span> {</span><br><span class="line">        <span class="keyword">select</span> {</span><br><span class="line">        <span class="keyword">case</span> &lt;-ctx.Done(): <span class="comment">// 没有实例化chan，但内部还是采用通道的逻辑</span></span><br><span class="line">            fmt.Println(<span class="string">"监控退出"</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            time.Sleep(time.Second)</span><br><span class="line">            fmt.Println(<span class="string">"获取cpu信息成功"</span>)</span><br><span class="line">        } <span class="comment">// 是否取消</span></span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    wg.Add(<span class="number">1</span>)</span><br><span class="line">    ctx, cancel := context.WithCancel(context.Background())</span><br><span class="line">    <span class="keyword">go</span> cpuInfo(ctx)</span><br><span class="line"></span><br><span class="line">    time.Sleep(time.Second * <span class="number">6</span>)</span><br><span class="line">    cancel()</span><br><span class="line">    wg.Wait()</span><br><span class="line">    fmt.Println(<span class="string">"信息监控完成"</span>)</span><br><span class="line">}</span><br><span class="line">----</span><br><span class="line">获取cpu信息成功</span><br><span class="line">获取cpu信息成功</span><br><span class="line">获取cpu信息成功</span><br><span class="line">获取cpu信息成功</span><br><span class="line">获取cpu信息成功</span><br><span class="line">获取cpu信息成功</span><br><span class="line">监控退出</span><br><span class="line">信息监控完成</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"context"</span></span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"sync"</span></span><br><span class="line">    <span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">cpuInfo</span><span class="params">(ctx context.Context)</span></span> {</span><br><span class="line">    <span class="keyword">defer</span> wg.Done()</span><br><span class="line">    <span class="keyword">for</span> {</span><br><span class="line">        <span class="keyword">select</span> {</span><br><span class="line">        <span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">            fmt.Println(<span class="string">"监控cpu退出"</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            time.Sleep(time.Second)</span><br><span class="line">            fmt.Println(<span class="string">"获取cpu信息成功"</span>)</span><br><span class="line">        } <span class="comment">// 是否取消</span></span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">memoryInfo</span><span class="params">(ctx context.Context)</span></span> {</span><br><span class="line">    <span class="keyword">defer</span> wg.Done()</span><br><span class="line">    <span class="keyword">for</span> {</span><br><span class="line">        <span class="keyword">select</span> {</span><br><span class="line">        <span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">            fmt.Println(<span class="string">"监控内存退出"</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            time.Sleep(time.Second)</span><br><span class="line">            fmt.Println(<span class="string">"获取内存信息成功"</span>)</span><br><span class="line">        } <span class="comment">// 是否取消</span></span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    wg.Add(<span class="number">2</span>)</span><br><span class="line">    ctx, cancel := context.WithCancel(context.Background())</span><br><span class="line">    <span class="keyword">go</span> cpuInfo(ctx)</span><br><span class="line">    <span class="keyword">go</span> memoryInfo(ctx)</span><br><span class="line">    time.Sleep(time.Second * <span class="number">6</span>)</span><br><span class="line">    cancel()</span><br><span class="line">    wg.Wait()</span><br><span class="line">    fmt.Println(<span class="string">"信息监控完成"</span>)</span><br><span class="line">}</span><br><span class="line">----</span><br><span class="line">获取内存信息成功</span><br><span class="line">获取cpu信息成功</span><br><span class="line">获取cpu信息成功</span><br><span class="line">获取内存信息成功</span><br><span class="line">获取内存信息成功</span><br><span class="line">获取cpu信息成功</span><br><span class="line">获取cpu信息成功</span><br><span class="line">获取内存信息成功</span><br><span class="line">获取cpu信息成功</span><br><span class="line">获取内存信息成功</span><br><span class="line">获取内存信息成功</span><br><span class="line">获取cpu信息成功</span><br><span class="line">监控cpu退出</span><br><span class="line">监控内存退出</span><br><span class="line">信息监控完成</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"context"</span></span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"sync"</span></span><br><span class="line">    <span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">cpuInfo</span><span class="params">(ctx context.Context)</span></span> {</span><br><span class="line">    <span class="keyword">defer</span> wg.Done()</span><br><span class="line">    <span class="keyword">go</span> memoryInfo(ctx)</span><br><span class="line">    <span class="keyword">for</span> {</span><br><span class="line">        <span class="keyword">select</span> {</span><br><span class="line">        <span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">            fmt.Println(<span class="string">"监控cpu退出"</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            time.Sleep(time.Second)</span><br><span class="line">            fmt.Println(<span class="string">"获取cpu信息成功"</span>)</span><br><span class="line">        } <span class="comment">// 是否取消</span></span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">memoryInfo</span><span class="params">(ctx context.Context)</span></span> {</span><br><span class="line">    <span class="keyword">defer</span> wg.Done()</span><br><span class="line">    <span class="keyword">for</span> {</span><br><span class="line">        <span class="keyword">select</span> {</span><br><span class="line">        <span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">            fmt.Println(<span class="string">"监控内存退出"</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            time.Sleep(time.Second)</span><br><span class="line">            fmt.Println(<span class="string">"获取内存信息成功"</span>)</span><br><span class="line">        } <span class="comment">// 是否取消</span></span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    wg.Add(<span class="number">2</span>)</span><br><span class="line">    ctx, cancel := context.WithCancel(context.Background())</span><br><span class="line">    <span class="keyword">go</span> cpuInfo(ctx)</span><br><span class="line">    time.Sleep(time.Second * <span class="number">6</span>)</span><br><span class="line">    cancel()</span><br><span class="line">    wg.Wait()</span><br><span class="line">    fmt.Println(<span class="string">"信息监控完成"</span>)</span><br><span class="line">}</span><br><span class="line">----</span><br><span class="line">获取内存信息成功</span><br><span class="line">获取cpu信息成功</span><br><span class="line">获取cpu信息成功</span><br><span class="line">获取内存信息成功</span><br><span class="line">获取内存信息成功</span><br><span class="line">获取cpu信息成功</span><br><span class="line">获取cpu信息成功</span><br><span class="line">获取内存信息成功</span><br><span class="line">获取内存信息成功</span><br><span class="line">获取cpu信息成功</span><br><span class="line">获取cpu信息成功</span><br><span class="line">监控cpu退出</span><br><span class="line">获取内存信息成功</span><br><span class="line">监控内存退出</span><br><span class="line">信息监控完成</span><br></pre></td></tr></tbody></table></figure>

<p>父的context取消，那么这个父context生成的子context也会被取消</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"context"</span></span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"sync"</span></span><br><span class="line">    <span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">cpuInfo</span><span class="params">(ctx context.Context)</span></span> {</span><br><span class="line">    <span class="keyword">defer</span> wg.Done()</span><br><span class="line">    ctx2, _ := context.WithCancel(ctx) <span class="comment">// 根据父context生成</span></span><br><span class="line">    <span class="keyword">go</span> memoryInfo(ctx2)</span><br><span class="line">    <span class="keyword">for</span> {</span><br><span class="line">        <span class="keyword">select</span> {</span><br><span class="line">        <span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">            fmt.Println(<span class="string">"监控cpu退出"</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            time.Sleep(time.Second)</span><br><span class="line">            fmt.Println(<span class="string">"获取cpu信息成功"</span>)</span><br><span class="line">        } <span class="comment">// 是否取消</span></span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">memoryInfo</span><span class="params">(ctx context.Context)</span></span> {</span><br><span class="line">    <span class="keyword">defer</span> wg.Done()</span><br><span class="line">    <span class="keyword">for</span> {</span><br><span class="line">        <span class="keyword">select</span> {</span><br><span class="line">        <span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">            fmt.Println(<span class="string">"监控内存退出"</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            time.Sleep(time.Second)</span><br><span class="line">            fmt.Println(<span class="string">"获取内存信息成功"</span>)</span><br><span class="line">        } <span class="comment">// 是否取消</span></span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    wg.Add(<span class="number">2</span>)</span><br><span class="line">    ctx, cancel := context.WithCancel(context.Background())</span><br><span class="line">    <span class="keyword">go</span> cpuInfo(ctx)</span><br><span class="line">    time.Sleep(time.Second * <span class="number">6</span>)</span><br><span class="line">    cancel()</span><br><span class="line">    wg.Wait()</span><br><span class="line">    fmt.Println(<span class="string">"信息监控完成"</span>)</span><br><span class="line">}</span><br><span class="line">----</span><br><span class="line">获取内存信息成功</span><br><span class="line">获取cpu信息成功</span><br><span class="line">获取cpu信息成功</span><br><span class="line">获取内存信息成功</span><br><span class="line">获取cpu信息成功</span><br><span class="line">获取内存信息成功</span><br><span class="line">获取cpu信息成功</span><br><span class="line">获取内存信息成功</span><br><span class="line">获取内存信息成功</span><br><span class="line">获取cpu信息成功</span><br><span class="line">获取cpu信息成功</span><br><span class="line">监控cpu退出</span><br><span class="line">获取内存信息成功</span><br><span class="line">监控内存退出</span><br><span class="line">信息监控完成</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"context"</span></span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"sync"</span></span><br><span class="line">    <span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">cpuInfo</span><span class="params">(ctx context.Context)</span></span> {</span><br><span class="line">    <span class="keyword">defer</span> wg.Done()</span><br><span class="line">    <span class="keyword">for</span> {</span><br><span class="line">        <span class="keyword">select</span> {</span><br><span class="line">        <span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">            fmt.Println(<span class="string">"监控cpu退出"</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            time.Sleep(time.Second)</span><br><span class="line">            fmt.Println(<span class="string">"获取cpu信息成功"</span>)</span><br><span class="line">        } <span class="comment">// 是否取消</span></span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    wg.Add(<span class="number">1</span>)</span><br><span class="line">    ctx, _ := context.WithTimeout(context.Background(), <span class="number">3</span>*time.Second)</span><br><span class="line">    <span class="keyword">go</span> cpuInfo(ctx)</span><br><span class="line">    wg.Wait()</span><br><span class="line">    fmt.Println(<span class="string">"信息监控完成"</span>)</span><br><span class="line">}</span><br><span class="line">---</span><br><span class="line">获取cpu信息成功</span><br><span class="line">获取cpu信息成功</span><br><span class="line">获取cpu信息成功</span><br><span class="line">获取cpu信息成功</span><br><span class="line">监控cpu退出(<span class="number">3</span>秒后自当退出)</span><br><span class="line">信息监控完成</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"context"</span></span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"sync"</span></span><br><span class="line">    <span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">cpuInfo</span><span class="params">(ctx context.Context)</span></span> {</span><br><span class="line">    <span class="keyword">defer</span> wg.Done()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> {</span><br><span class="line">        <span class="keyword">select</span> {</span><br><span class="line">        <span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">            fmt.Println(<span class="string">"监控cpu退出"</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            time.Sleep(time.Second)</span><br><span class="line">            fmt.Println(<span class="string">"获取cpu信息成功"</span>)</span><br><span class="line">        } <span class="comment">// 是否取消</span></span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    wg.Add(<span class="number">1</span>)</span><br><span class="line">    ctx, cancel := context.WithTimeout(context.Background(), <span class="number">3</span>*time.Second)</span><br><span class="line">    <span class="keyword">go</span> cpuInfo(ctx)</span><br><span class="line">    time.Sleep(time.Second)</span><br><span class="line">    cancel() <span class="comment">// 1秒钟后3还没到3秒提前取消</span></span><br><span class="line">    wg.Wait()</span><br><span class="line">    fmt.Println(<span class="string">"信息监控完成"</span>)</span><br><span class="line">}</span><br><span class="line">----</span><br><span class="line">获取cpu信息成功</span><br><span class="line">监控cpu退出</span><br><span class="line">信息监控完成</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">f2</span><span class="params">(ctx context.Context)</span></span>{</span><br><span class="line">    <span class="keyword">defer</span> wg.Done()</span><br><span class="line">    <span class="keyword">for</span> {</span><br><span class="line">        fmt.Println(<span class="string">"f2 is running"</span>)</span><br><span class="line">        time.Sleep(time.Second)</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">f</span><span class="params">(ctx context.Context)</span></span>{</span><br><span class="line">    <span class="keyword">defer</span> wg.Done()</span><br><span class="line">    <span class="keyword">go</span> f2(ctx)</span><br><span class="line">Loop:</span><br><span class="line">    <span class="keyword">for</span> {</span><br><span class="line">        <span class="keyword">select</span> {</span><br><span class="line">        <span class="keyword">case</span> &lt;- ctx.Done():</span><br><span class="line">            <span class="keyword">break</span> Loop</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">        }</span><br><span class="line">        fmt.Println(<span class="string">"f1 is running"</span>)</span><br><span class="line">        time.Sleep(time.Second)</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>{</span><br><span class="line">    ctx, cancel := context.WithCancel(context.TODO())</span><br><span class="line">    wg.Add(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">go</span> f(ctx)</span><br><span class="line">    time.Sleep(time.Second*<span class="number">3</span>)</span><br><span class="line">    cancel()</span><br><span class="line">    wg.Wait()</span><br><span class="line">    time.Sleep(time.Second*<span class="number">3</span>)</span><br><span class="line">}</span><br><span class="line">----</span><br><span class="line">f2 is running</span><br><span class="line">f1 is running</span><br><span class="line">f1 is running</span><br><span class="line">f2 is running</span><br><span class="line">f2 is running</span><br><span class="line">f1 is running</span><br><span class="line">f2 is running</span><br><span class="line">f2 is running</span><br><span class="line">f2 is running</span><br></pre></td></tr></tbody></table></figure>


<pre><code>
</code></pre>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/08/23/web-lu-you-pi-pei-yuan-ze/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/08/23/web-lu-you-pi-pei-yuan-ze/" class="post-title-link" itemprop="url">web路由匹配原则</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-08-22 16:21:41" itemprop="dateCreated datePublished" datetime="2021-08-22T16:21:41Z">2021-08-22</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-09-21 03:26:15" itemprop="dateModified" datetime="2021-09-21T03:26:15Z">2021-09-21</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ol>
<li>用户注册了一个路由 /order/*</li>
<li>用户又注册了一个路由 /order/order_sn<br>请求 /order/order_sn 该命中哪一个？<br>答案：我们遵循最“详细”原则。按照一般的说法，应该是最左最长匹配。<br>所以应该命中 /order/order_sn 而不是 /order</li>
</ol>
<p>接下来又遇到一个问题：<br>我注册了 /order/*<br>又注册了 /order/*/checkout/confirm</p>
<p>我一个请求：/order/123/checkout/cancel应该命中 /order/* 吗？<br>答案是：犯不着命中。<br>为什么？不是做不到，而是会让代码唰一下变复杂，投入大产出小。<br>为什么代码会复杂？因为你需要回溯了，当你发现匹配不到任何的时候，你要回溯你的路由树，看看最近有没有一个通配符节点</p>
<p>注册的时候，加上校验，如果出现了 <em>，它就必须是最后一个。<br>并且我们要求，它前面必须是 /。即最终结尾应该是/</em></p>
<p>/order/* 究竟能不能匹配 /order ？<br>这个问题的看法，这是一个典型的设计决策问题。因为无论是否匹配，都能找到一些“冠冕堂皇”的理由。<br>这里我没有支持，仅仅是因为我觉得，当你希望匹配 /order的时候，你完全可以自己注册一下。当你注册 /order/* 我觉得你是期望/order之后肯定有东西的。不然你注册 /order 就可以了。<br>我也不觉得，正常的业务下 /order 和 /order/* 对应的 handler 会是一样的。<br>这就是一个很有意思的话题：中间件开发者试图教你如何写代码。<br>如果你发现有些框架，不能这么写，不能那么写。有时候是功能确实不好支持，有些时候就是作者在教你写代码，他通过不支持某些东西，来避免用户写出一些他完全无法接受的代码。所谓的无法接受的代码，你可以稍微思考一下，这个是确实是不良实践，还是说这就是作者的个人偏好。<br>Tip：不想教用户如何写代码的框架开发者是没有原则的</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/08/23/go-de-atornic/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/08/23/go-de-atornic/" class="post-title-link" itemprop="url">go的atomic</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-08-22 16:21:41" itemprop="dateCreated datePublished" datetime="2021-08-22T16:21:41Z">2021-08-22</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-09-21 12:03:11" itemprop="dateModified" datetime="2021-09-21T12:03:11Z">2021-09-21</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>atomic 包<br>方法分成这几类：<br>• AddXXX：操作一个数字类型，加上一个数字<br>• LoadXXX：读取一个值<br>• CompareAndSwapXXX：CAS 操作<br>• StoreXXX：写入一个值<br>• SwapXXX：写入一个值，并且返回旧的值。它和 CompareAndSwap 的区别在于它不关心旧的值是什么<br>• unsafepointer 相关方法，不建议使用。难写也难读，不到逼不得已不要去用。<br>尤其是不要为了优化而故意用 unsafepoint</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">"sync/atomic"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> value <span class="keyword">int32</span> = <span class="number">0</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="comment">// 要传入 value 的指针</span></span><br><span class="line">    <span class="comment">// 把 value + 10</span></span><br><span class="line">    atomic.AddInt32(&amp;value, <span class="number">10</span>)</span><br><span class="line">    nv := atomic.LoadInt32(&amp;value)</span><br><span class="line">    <span class="built_in">println</span>(nv) <span class="comment">// 10</span></span><br><span class="line">    <span class="comment">// 如果之前的值是10，那么就设置为新的值 20</span></span><br><span class="line">    swapped := atomic.CompareAndSwapInt32(&amp;value, <span class="number">10</span>, <span class="number">20</span>)</span><br><span class="line">    <span class="built_in">println</span>(swapped) <span class="comment">// true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果之前的值是19，那么就设置为新的值 50</span></span><br><span class="line">    <span class="comment">// 显然现在 value 是 20</span></span><br><span class="line">    swapped = atomic.CompareAndSwapInt32(&amp;value, <span class="number">19</span>, <span class="number">50</span>)</span><br><span class="line">    <span class="built_in">println</span>(swapped) <span class="comment">// false</span></span><br><span class="line"></span><br><span class="line">    old := atomic.SwapInt32(&amp;value, <span class="number">40</span>)</span><br><span class="line">    <span class="built_in">println</span>(old) <span class="comment">// 20 即原本的值</span></span><br><span class="line">    <span class="built_in">println</span>(value) <span class="comment">// 40 输出新的值，也就是交换后的值</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/08/20/go-de-goroutine/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/08/20/go-de-goroutine/" class="post-title-link" itemprop="url">go的goroutine</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-08-19 16:21:41" itemprop="dateCreated datePublished" datetime="2021-08-19T16:21:41Z">2021-08-19</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-09-25 07:06:33" itemprop="dateModified" datetime="2021-09-25T07:06:33Z">2021-09-25</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>场景一：<br>不允许后面的逻辑，必需要等前面的完成才能执行<br>场景二：<br>批量操作相同的信息，批量发送信息</p>
<p>简介<br>因为并发程序要考虑很多的细节，以保证对共享变量的正确访问，使得并发编程在很多情况下变得很复杂。<br>但是Go语言在开发并发时，是比较简洁的。它通过channel来传递数据。数据竞争这个问题在golang的设计上就进行了规避了。</p>
<blockquote>
<p>Don’t communicate by sharing memory; share memory by communicating.<br>不要通过共享内存来通信；通过通信来实现共享内存</p>
</blockquote>
<p>Go语言用2种手段来实现并发程序，goroutine和channel，其支持顺序通信进程（communication sequential processes），简称为CSP。CSP是一种现代的并发编程模型，在这种编程模型中，值会在不同的运行实例（goroutine）中传递。</p>
<p>在并发系统中，对goroutine的切换时机和运行结果就没有唯一的保证性。<br>在go语言中，我们采用channel来进行goroutine之间的通信，能更容易的保证结果的一致性<br>多个协程可以在一个或多个线程上运行</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go run -race xx.go</span><br></pre></td></tr></tbody></table></figure>

<p>查看运行是否有数据访问冲突</p>
<p>每一个线程 下面都有一个 Go自己实现的协程处理器<br>然后下面就是协程队列<br>Processor就会依次运行协程</p>
<p>go会监听这个队列如果一个时间段这个队列数量还是没有发生变化,golang就会吧当前的goroutine放到当前队列的队尾</p>
<p>当某一个协程被系统中断,processor就会吧这个协程,放到其他空闲的线程上</p>
<p>初学者可以完全将协程理解为线程，但是用起来比线程更加简单，占用的资源也更少。<br>通常在一个进程里启动上万个线程就已经不堪重负，但是 Go 语言允许你启动百万协程也可以轻松应付。</p>
<p>A goroutine is a lightweight thread managed by the Go runtime.<br>goroutine 是轻量级线程，goroutine 的调度是由 Golang 运行时进行管理的。</p>
<p>在Go语言中，每一个并发的执行单元就叫做goroutine。<br>每个goroutine都对应一个非常简单的模型：它是一个并发的执行函数，并且在多个并发的goroutine间，资源是共享的。goroutine非常轻量，创建的开销很少。</p>
<p>goroutine 语法格式：在函数前加上一个关键字：<code>go</code>。Go 语言就能送给调试器运行启动一个新的协程，函数调用将成为这个协程的入口。<br>不需要在定义时区分是否是异步函数，python才需要<br>调度器在合适的点进行切的</p>
<p>go routine 可能的切换点</p>
<ul>
<li>I/0, select</li>
<li>channel</li>
<li>等待锁</li>
<li>函数调用（有时）</li>
<li><code>runtime.Gosched()</code></li>
<li>只是参考，不能保证切换，不能保证在其他地方不切换<br>go语言调度器开的线程数一般不会超过机器的CPU核数</li>
</ul>
<p>值得注意的是这里的 go 关键字语法和前面的 defer 关键字语法是一样的，它后面跟了一个匿名函数，然后还要带上一对<code>()</code>，表示对匿名函数的调用。</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">go</span> 函数名( 参数列表 )</span><br><span class="line"><span class="keyword">go</span> f(x, y, z)</span><br></pre></td></tr></tbody></table></figure>

<p>starts a new goroutine running 开启一个新的 goroutine:</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">f(x, y, z)</span><br></pre></td></tr></tbody></table></figure>

<p>The evaluation of <code>f</code>, <code>x</code>, <code>y</code>, and <code>z</code> happens in the current goroutine and the execution of <code>f</code> happens in the new goroutine.<br>Go 允许使用 go 语句开启一个新的运行期线程， 即 goroutine，以一个不同的、新创建的 goroutine 来执行一个函数。<br>Goroutines run in the same address space, so access to shared memory must be synchronized. 同一个程序中的所有 goroutine 共享同一个地址空间。</p>
<p>The <code>sync</code> package provides useful primitives, although you won’t need them much in Go as there are other primitives. (See the next slide.)</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">time.Sleep(<span class="number">10</span> * time.Second)</span><br><span class="line"><span class="comment">// 等待十秒输出</span></span><br><span class="line">fmt.Println(<span class="string">"I am here"</span>) <span class="comment">// I am here</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">    time.Sleep(<span class="number">10</span> * time.Second)</span><br><span class="line">}()</span><br><span class="line"><span class="comment">// 这里直接输出，不会等待十秒</span></span><br><span class="line">fmt.Println(<span class="string">"I am here"</span>) <span class="comment">// I am here</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">say</span><span class="params">(s <span class="keyword">string</span>)</span></span> {</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">5</span>; i++ {</span><br><span class="line">        time.Sleep(<span class="number">100</span> * time.Millisecond)</span><br><span class="line">        fmt.Println(s)</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">go</span> say(<span class="string">"world"</span>)</span><br><span class="line">    say(<span class="string">"hello"</span>)</span><br><span class="line">}</span><br><span class="line">---</span><br><span class="line">world</span><br><span class="line">hello</span><br><span class="line">hello</span><br><span class="line">world</span><br><span class="line">world</span><br><span class="line">hello</span><br><span class="line">hello</span><br><span class="line">world</span><br><span class="line">world</span><br><span class="line">hello</span><br><span class="line">输出的 hello 和 world 是没有固定先后顺序。因为它们是两个 goroutine 在执行</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    fmt.Println(<span class="string">"In main"</span>)</span><br><span class="line">    <span class="keyword">go</span> longSleep()</span><br><span class="line">    <span class="keyword">go</span> shortSleep()</span><br><span class="line"></span><br><span class="line">    fmt.Println(<span class="string">"sleep "</span>)</span><br><span class="line">    time.Sleep(<span class="number">10</span> * <span class="number">1e9</span>)<span class="comment">//ns，符号 1e9 表示 1 乘 10 的 9 次方，e=指数</span></span><br><span class="line">    fmt.Println(<span class="string">"the end of main"</span>)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">longSleep</span><span class="params">()</span></span> {</span><br><span class="line">    fmt.Println(<span class="string">"longSleep begin"</span>)</span><br><span class="line">    time.Sleep(<span class="number">5</span> * <span class="number">1e9</span>)</span><br><span class="line">    fmt.Println(<span class="string">"longSleep end"</span>)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">shortSleep</span><span class="params">()</span></span> {</span><br><span class="line">    fmt.Println(<span class="string">"shortSleep begin"</span>)</span><br><span class="line">    time.Sleep(<span class="number">2</span> * <span class="number">1e9</span>)</span><br><span class="line">    fmt.Println(<span class="string">"shortSleep end"</span>)</span><br><span class="line">}</span><br><span class="line">---</span><br><span class="line">In main</span><br><span class="line">sleep</span><br><span class="line">longSleep begin</span><br><span class="line">shortSleep begin</span><br><span class="line">shortSleep end</span><br><span class="line">longSleep end</span><br><span class="line">the end of main</span><br></pre></td></tr></tbody></table></figure>

<p>main() ，longSleep() 和 shortSleep() 这3个函数都是独立的处理单元按顺序启动，然后开始并行运行。为了模拟<br>运算时间的损耗，我们使用了sleep()函数，这个函数可以按照指定时间来暂停函数或协程执行。</p>
<p>如果我们不在main()函数中sleep()较长的时间，那么main() 函数结束时，其他协程运行的程序也会结束。main()程序退出，它不会等待任何其他非main协程的结束。<br>协程是独立的处理单元，一旦陆续启动一些协程，就无法确定他们是什么时候正在开始运行的。</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestGoroutine</span><span class="params">(t *testing.T)</span></span> {</span><br><span class="line">    <span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">1999</span>; i++ {</span><br><span class="line">        wg.Add(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(i <span class="keyword">int</span>)</span></span> {</span><br><span class="line">            fmt.Println(i)</span><br><span class="line">            wg.Done()</span><br><span class="line">        }(i)</span><br><span class="line">    }</span><br><span class="line">    wg.Wait()</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    fmt.Println(<span class="string">"run in main goroutine"</span>)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">        fmt.Println(<span class="string">"run in child goroutine"</span>)</span><br><span class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">            fmt.Println(<span class="string">"run in grand child goroutine"</span>)</span><br><span class="line">            <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">                fmt.Println(<span class="string">"run in grand grand child goroutine"</span>)</span><br><span class="line">            }()</span><br><span class="line">        }()</span><br><span class="line">    }()</span><br><span class="line">    time.Sleep(time.Second)</span><br><span class="line">    fmt.Println(<span class="string">"main goroutine will quit"</span>)</span><br><span class="line">}</span><br><span class="line">-------</span><br><span class="line">run in main goroutine</span><br><span class="line">run in child goroutine</span><br><span class="line">run in grand child goroutine</span><br><span class="line">run in grand grand child goroutine</span><br><span class="line">main goroutine will quit</span><br></pre></td></tr></tbody></table></figure>

<p>main 函数运行在主协程(main goroutine)里面，上面的例子中我们在主协程里面启动了一个子协程，子协程又启动了一个孙子协程，孙子协程又启动了一个曾孙子协程。这些协程之间似乎形成了父子、子孙、关系，但是实际上协程之间并不存在这么多的层级关系，在 Go 语言里只有一个主协程，其它都是它的子协程，子协程之间是平行关系。</p>
<p>上面的代码中主协程睡眠了 1s，等待子协程们执行完毕。如果将睡眠的这行代码去掉，将会看不到子协程运行的痕迹</p>
<figure class="highlight applescript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-------------</span></span><br><span class="line"><span class="built_in">run</span> <span class="keyword">in</span> main goroutine</span><br><span class="line">main goroutine will quit</span><br></pre></td></tr></tbody></table></figure>

<p>这是因为主协程运行结束，其它协程就会立即消亡，不管它们是否已经开始运行</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">p</span><span class="params">()</span></span>{</span><br><span class="line">    fmt.Println(<span class="string">"p"</span>)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">go</span> p()</span><br><span class="line">}</span><br><span class="line">没有打印输出 因为主协程运行结束，其它协程来不及执行完就会立即消亡，不管它们是否已经开始运行</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">p</span><span class="params">()</span></span>{</span><br><span class="line">    fmt.Println(<span class="string">"p"</span>)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">go</span> p()</span><br><span class="line">    fmt.Println(<span class="string">"main"</span>)</span><br><span class="line">}</span><br><span class="line">---</span><br><span class="line">main</span><br><span class="line">没有打印输出p，主死从随，因为主协程运行结束，其它协程就会立即消亡，不管它们是否已经开始运行</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">go</span> p()</span><br><span class="line">    time.Sleep(time.Second*<span class="number">1</span>)</span><br><span class="line">}</span><br><span class="line">---</span><br><span class="line">p ，主协程挂起<span class="number">1</span>秒钟，从的协程立刻执行</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">q</span><span class="params">()</span></span>{</span><br><span class="line">    <span class="keyword">for</span> {</span><br><span class="line">        fmt.Println(<span class="string">"dead circle"</span>)</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">go</span> q()</span><br><span class="line">    time.Sleep(time.Second*<span class="number">1</span>) <span class="comment">// 如果不加这个 因为go开了协程 mian函数本身也是一个协程，如果main退出整个函数就退出了，程序中断</span></span><br><span class="line">}</span><br><span class="line">---</span><br><span class="line">dead circle</span><br><span class="line">dead circle</span><br><span class="line">dead circle</span><br><span class="line">dead circle</span><br><span class="line">... 一秒钟后程序停止</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ {</span><br><span class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(i <span class="keyword">int</span>)</span></span> {</span><br><span class="line">            fmt.Println(i)</span><br><span class="line">        }(i)</span><br><span class="line">    }</span><br><span class="line">    time.Sleep(time.Second * <span class="number">1</span>)</span><br><span class="line">----</span><br><span class="line"><span class="number">9</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">6</span></span><br><span class="line"><span class="number">7</span></span><br><span class="line"><span class="number">8</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">1</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span>{</span><br><span class="line">        <span class="keyword">for</span> {</span><br><span class="line">            fmt.Println(<span class="number">1</span>)</span><br><span class="line">        }</span><br><span class="line">    }()</span><br><span class="line">    time.Sleep(time.Second*<span class="number">1</span>)</span><br><span class="line">---</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line">... 一秒钟后程序停止</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">for</span> i:=<span class="number">0</span>; i &lt; <span class="number">5</span>; i++ {</span><br><span class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span>{</span><br><span class="line">            <span class="keyword">for</span> {</span><br><span class="line">                fmt.Println(i) <span class="comment">// 闭包，用到了匿名函数外另一个协程的变量</span></span><br><span class="line">            }</span><br><span class="line">        }()</span><br><span class="line">    }</span><br><span class="line">    time.Sleep(time.Second*<span class="number">1</span>)</span><br><span class="line">---</span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line">...</span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">5</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">for</span> i:=<span class="number">0</span>; i &lt; <span class="number">5</span>; i++ {</span><br><span class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span>{</span><br><span class="line">            <span class="keyword">for</span> {</span><br><span class="line">                fmt.Println(i) <span class="comment">// 闭包，用到了匿名函数外另一个协程的变量</span></span><br><span class="line">                time.Sleep(time.Second*<span class="number">1</span>)</span><br><span class="line">            }</span><br><span class="line">        }()</span><br><span class="line">    }</span><br><span class="line">    time.Sleep(time.Second*<span class="number">1</span>)</span><br><span class="line">---</span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line">只有打印了这几个，一秒钟后程序停止</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">for</span> i:=<span class="number">0</span>; i &lt; <span class="number">100</span>; i++ {</span><br><span class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span>{</span><br><span class="line">            <span class="keyword">for</span> {</span><br><span class="line">                fmt.Println(i) <span class="comment">// 闭包，用到了匿名函数外另一个协程的变量</span></span><br><span class="line">            }</span><br><span class="line">        }()</span><br><span class="line">    }</span><br><span class="line">---</span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">14</span></span><br><span class="line"><span class="number">15</span></span><br><span class="line"><span class="number">16</span></span><br><span class="line"><span class="number">17</span></span><br><span class="line"><span class="number">17</span></span><br><span class="line">...</span><br><span class="line"><span class="number">100</span></span><br><span class="line"><span class="number">100</span></span><br><span class="line"><span class="number">100</span></span><br><span class="line"><span class="number">100</span></span><br><span class="line">一秒钟后程序停止</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">for</span> i:=<span class="number">0</span>; i &lt; <span class="number">100</span>; i++ {</span><br><span class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span>{</span><br><span class="line">            <span class="keyword">for</span> {</span><br><span class="line">                fmt.Println(i) <span class="comment">// 闭包，用到了匿名函数外另一个协程的变量</span></span><br><span class="line">                <span class="comment">// 主死从随</span></span><br><span class="line">                time.Sleep(time.Second*<span class="number">1</span>)</span><br><span class="line">            }</span><br><span class="line">        }()</span><br><span class="line">    }</span><br><span class="line">---</span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">23</span></span><br><span class="line"><span class="number">23</span></span><br><span class="line"><span class="number">11</span></span><br><span class="line"><span class="number">11</span></span><br><span class="line"><span class="number">25</span></span><br><span class="line"><span class="number">11</span></span><br><span class="line"><span class="number">11</span></span><br><span class="line"><span class="number">11</span></span><br><span class="line"><span class="number">27</span></span><br><span class="line"><span class="number">11</span></span><br><span class="line"><span class="number">11</span></span><br><span class="line"><span class="number">27</span></span><br><span class="line">...</span><br><span class="line"><span class="number">83</span></span><br><span class="line"><span class="number">83</span></span><br><span class="line"><span class="number">83</span></span><br><span class="line"><span class="number">87</span></span><br><span class="line"><span class="number">87</span></span><br><span class="line"><span class="number">87</span></span><br><span class="line"><span class="number">88</span></span><br><span class="line"><span class="number">89</span></span><br><span class="line"><span class="number">91</span></span><br><span class="line"><span class="number">91</span></span><br><span class="line"><span class="number">90</span></span><br><span class="line"><span class="number">92</span></span><br><span class="line"><span class="number">95</span></span><br><span class="line"><span class="number">95</span></span><br><span class="line"><span class="number">95</span></span><br><span class="line"><span class="number">98</span></span><br><span class="line"><span class="number">99</span></span><br><span class="line"><span class="number">99</span></span><br><span class="line">一秒钟后程序停止</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">100</span>; i++ {</span><br><span class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(i <span class="keyword">int</span>)</span></span> {</span><br><span class="line">            <span class="keyword">for</span> {</span><br><span class="line">                fmt.Println(i)</span><br><span class="line">            }</span><br><span class="line">        }(i)</span><br><span class="line">    }</span><br><span class="line">    time.Sleep(time.Second*<span class="number">1</span>)</span><br><span class="line">----</span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">9</span></span><br><span class="line"><span class="number">6</span></span><br><span class="line"><span class="number">6</span></span><br><span class="line"><span class="number">6</span></span><br><span class="line">...</span><br><span class="line"><span class="number">66</span></span><br><span class="line"><span class="number">66</span></span><br><span class="line"><span class="number">66</span></span><br><span class="line"><span class="number">66</span></span><br><span class="line"><span class="number">79</span></span><br><span class="line"><span class="number">79</span></span><br><span class="line"><span class="number">79</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">100</span>; i++ {</span><br><span class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(i <span class="keyword">int</span>)</span></span> {</span><br><span class="line">            <span class="keyword">for</span> {</span><br><span class="line">                fmt.Println(i)</span><br><span class="line">                time.Sleep(time.Second * <span class="number">1</span>)</span><br><span class="line">            }</span><br><span class="line">        }(i)</span><br><span class="line">    }</span><br><span class="line">    time.Sleep(time.Second*<span class="number">1</span>)</span><br><span class="line">---</span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">6</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line">...</span><br><span class="line"><span class="number">69</span></span><br><span class="line"><span class="number">70</span></span><br><span class="line"><span class="number">96</span></span><br><span class="line"><span class="number">6</span></span><br><span class="line"><span class="number">67</span></span><br><span class="line"><span class="number">78</span></span><br><span class="line"><span class="number">64</span></span><br><span class="line"><span class="number">58</span></span><br><span class="line"><span class="number">84</span></span><br><span class="line">这样就没有重复，不按顺序是协程谁先调度谁后调度是系统内部，不是先启动就先运行</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">fmt.Println(<span class="string">"run in main goroutine"</span>)</span><br><span class="line">i := <span class="number">1</span></span><br><span class="line"><span class="keyword">for</span> {</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">        <span class="keyword">for</span> {</span><br><span class="line">            time.Sleep(time.Second)</span><br><span class="line">        }</span><br><span class="line">    }()</span><br><span class="line">    <span class="keyword">if</span> i%<span class="number">10000</span> == <span class="number">0</span> {</span><br><span class="line">        fmt.Printf(<span class="string">"%d goroutine started\n"</span>, i) <span class="comment">// IO操作里面切换，有等待的过程</span></span><br><span class="line">    }</span><br><span class="line">    i++</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>上面的代码将会无休止地创建协程，每个协程都在睡眠，为了确保它们都是活的，协程会 1s 钟醒过来一次。在我的个人电脑上，这个程序创建了千万个协程还没有到上限，观察内存发现占用还不到 1G，这意味着每个协程的内存占用还不到 100 字节。</p>
<p>go的协程和 python的协程-网上有些人可能喜欢拿web框架来做性能对比<br>go的 gin begoo-flask/ django 性能对比 这个不科学的 uwsgi 协程<br>go的 gin begoo-flask/ django + gevent性能对比<br>tornado sanic fastapi/ asyncio 协程库我们就不再使用python的线程来对比<br>只要大家懂了任何一门语言的协程，其他语言的协程都很好理解 GMP<br>大家都开启100W个协程<br>使用的简单性- go 启动一个协程</p>
<p><code>WaitGroup</code> 实现等待某个协程或协程组结束完成的同步操作。父线程调用 <code>Add</code> 方法来设定应等待的线程的数量。每个被等待的线程在结束时应调用 <code>Done</code> 方法 goroutine 内完成任务-1。同时，主线程里可以调用 <code>Wait</code> 方法阻塞至所有线程结束、计数归零。但在使用时要注意:<br>Add的数量和Done的调用数量必须相等。<br>另外，就是WaitGroup结构一旦定义就不能复制的原因。<br> WaitGroup在需要等待多个任务结束再返回的业务来说还是很有用的，但现实中用的更多的可能是，先等待一个协程组，若所有协程组都正确完成，则一直等到所有协程组结束；若其中有一个协程发生错误，则告诉协程组的其他协程，全部停止运行（本次任务失败）以免浪费系统资源。<br>该场景WaitGroup是无法实现的，那么该场景该如何实现呢，就需要用到通知机制，其实也可以用channel来实现</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">res := <span class="number">0</span></span><br><span class="line">wg := sync.WaitGroup{}</span><br><span class="line">wg.Add(<span class="number">10</span>)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ {</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(val <span class="keyword">int</span>)</span></span> {</span><br><span class="line">        res += val</span><br><span class="line">        wg.Done() <span class="comment">// goroutine 内完成任务-1</span></span><br><span class="line">    }(i)</span><br><span class="line">}</span><br><span class="line">wg.Wait()</span><br><span class="line">fmt.Println(res) <span class="comment">// 45</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">res := <span class="number">0</span></span><br><span class="line">wg := sync.WaitGroup{}</span><br><span class="line">wg.Add(<span class="number">10</span>)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ {</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(val <span class="keyword">int</span>)</span></span> {</span><br><span class="line">        res += val</span><br><span class="line">        wg.Done()</span><br><span class="line">    }(i)</span><br><span class="line">}</span><br><span class="line"><span class="comment">// 把这个注释掉你会发现，什么结果你都可能拿到</span></span><br><span class="line"><span class="comment">// wg.Wait()</span></span><br><span class="line">fmt.Println(res) <span class="comment">// 1 或者 15</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i&lt;<span class="number">5</span>; i++ {</span><br><span class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(n <span class="keyword">int</span>)</span></span> {</span><br><span class="line">            fmt.Println(n)</span><br><span class="line">        }(i)</span><br><span class="line">    }</span><br><span class="line">    time.Sleep(time.Second*<span class="number">3</span>)</span><br><span class="line">----</span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line">这<span class="number">5</span>个数的顺序随机</span><br></pre></td></tr></tbody></table></figure>

<p>如何解决主的goroutine在子协程结束后自动结束，主协程不用睡眠</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"sync"</span></span><br><span class="line">)</span><br><span class="line">    <span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i&lt;<span class="number">5</span>; i++ {</span><br><span class="line">        wg.Add(<span class="number">1</span>) <span class="comment">// 启动1个协程</span></span><br><span class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(n <span class="keyword">int</span>)</span></span> {</span><br><span class="line">            <span class="keyword">defer</span> wg.Done() <span class="comment">// 运行完减一个</span></span><br><span class="line">            fmt.Println(n)</span><br><span class="line">        }(i)</span><br><span class="line">    }</span><br><span class="line">    wg.Wait()</span><br><span class="line">----</span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">0</span></span><br><span class="line">这<span class="number">5</span>个数的顺序随机</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">f</span><span class="params">(n <span class="keyword">int</span>)</span></span>  {</span><br><span class="line">    <span class="keyword">defer</span> wg.Done()</span><br><span class="line">    fmt.Println(n)</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    wg.Add(<span class="number">5</span>) <span class="comment">// 启动5个协程</span></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i&lt;<span class="number">5</span>; i++ {</span><br><span class="line">        <span class="keyword">go</span> f(i)</span><br><span class="line">    }</span><br><span class="line">    wg.Wait()</span><br><span class="line">}</span><br><span class="line">----</span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line">这<span class="number">5</span>个数的顺序随机</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"sync"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> total <span class="keyword">int</span></span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">add</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">defer</span> wg.Done()</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i&lt;<span class="number">100000</span>; i++ {</span><br><span class="line">        total = total + <span class="number">1</span></span><br><span class="line">        <span class="comment">//1. 从 total 取出值</span></span><br><span class="line">        <span class="comment">//2. 将 total+1</span></span><br><span class="line">        <span class="comment">//3. 将 total+1 的计算结果放入到total中</span></span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>{</span><br><span class="line">    wg.Add(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">go</span> add()</span><br><span class="line">    wg.Wait()</span><br><span class="line">    fmt.Println(total) <span class="comment">// 100000</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>并发会产生的问题 -竞争</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sub</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">defer</span> wg.Done()</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i&lt;<span class="number">100000</span>; i++ {</span><br><span class="line">        total = total - <span class="number">1</span></span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>{</span><br><span class="line">    wg.Add(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">go</span> add()</span><br><span class="line">    <span class="keyword">go</span> sub()</span><br><span class="line">    wg.Wait()</span><br><span class="line">    fmt.Println(total) <span class="comment">// -36827</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">1. 按理说： 最后的结果应该是0</span></span><br><span class="line"><span class="comment">2. 实际的情况：</span></span><br><span class="line"><span class="comment">  1. 不是0</span></span><br><span class="line"><span class="comment">  2. 每次的运行结果还不一样 54779、-29729</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestCounter</span><span class="params">(t *testing.T)</span></span> {</span><br><span class="line">    counter := <span class="number">0</span></span><br><span class="line">    <span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">5000</span>; i++ {</span><br><span class="line">        wg.Add(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">            counter++</span><br><span class="line">            wg.Done()</span><br><span class="line">        }()</span><br><span class="line">    }</span><br><span class="line">    wg.Wait()</span><br><span class="line">    t.Log(counter)</span><br><span class="line">}</span><br><span class="line">---</span><br><span class="line">=== RUN   TestCounter</span><br><span class="line">time:  <span class="number">2071910</span></span><br><span class="line">--- PASS: TestCounter (<span class="number">0.00</span>s)</span><br><span class="line">    share_test.<span class="keyword">go</span>:<span class="number">28</span>: <span class="number">4398</span></span><br><span class="line">PASS</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestCounter</span><span class="params">(t *testing.T)</span></span> {</span><br><span class="line">    nowTime := time.Now().UnixNano()</span><br><span class="line">    counter := <span class="number">0</span></span><br><span class="line">    <span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">5000</span>; i++ {</span><br><span class="line">        wg.Add(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">            counter++</span><br><span class="line">            wg.Done()</span><br><span class="line">        }()</span><br><span class="line">    }</span><br><span class="line">    wg.Wait()</span><br><span class="line">    t.Log(counter)</span><br><span class="line">    tTime := time.Now().UnixNano()</span><br><span class="line">    fmt.Println(<span class="string">"time: "</span>, (tTime - nowTime))</span><br><span class="line">}</span><br><span class="line">=== RUN   TestCounter</span><br><span class="line">time:  <span class="number">2071910</span></span><br><span class="line">--- PASS: TestCounter (<span class="number">0.00</span>s)</span><br><span class="line">    share_test.<span class="keyword">go</span>:<span class="number">28</span>: <span class="number">4334</span></span><br><span class="line">PASS</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestMutCounter</span><span class="params">(t *testing.T)</span></span> {</span><br><span class="line">    nowTime := time.Now().UnixNano()</span><br><span class="line">    <span class="keyword">var</span> nut sync.Mutex</span><br><span class="line">    counter := <span class="number">0</span></span><br><span class="line">    <span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">5000</span>; i++ {</span><br><span class="line">        wg.Add(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">            nut.Lock()</span><br><span class="line">            <span class="keyword">defer</span> nut.Unlock()</span><br><span class="line">            counter++</span><br><span class="line">            wg.Done()</span><br><span class="line">        }()</span><br><span class="line">    }</span><br><span class="line">    wg.Wait()</span><br><span class="line">    t.Log(counter)</span><br><span class="line">    tTime := time.Now().UnixNano()</span><br><span class="line">    fmt.Println(<span class="string">"time: "</span>, (tTime - nowTime))</span><br><span class="line">}</span><br><span class="line">=== RUN   TestMutCounter</span><br><span class="line">time:  <span class="number">2151931</span></span><br><span class="line">--- PASS: TestMutCounter (<span class="number">0.00</span>s)</span><br><span class="line">    share_test.<span class="keyword">go</span>:<span class="number">48</span>: <span class="number">5000</span></span><br><span class="line">PASS</span><br></pre></td></tr></tbody></table></figure>

<p>互斥写锁 <code>Mutex</code> 同步协程 同步数据 解决并发问题</p>
<p>能不用锁就别用锁 - 性能</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"sync"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> total <span class="keyword">int</span></span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"><span class="keyword">var</span> lock sync.Mutex</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Mutex</span><span class="params">()</span></span> {</span><br><span class="line">    lock.Lock()</span><br><span class="line">    <span class="keyword">defer</span> lock.Unlock()</span><br><span class="line">    <span class="comment">// 你的代码</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">add</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">defer</span> wg.Done()</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i&lt;<span class="number">100000</span>; i++ {</span><br><span class="line">        lock.Lock() <span class="comment">// 先把门锁上</span></span><br><span class="line">        total = total + <span class="number">1</span></span><br><span class="line">        <span class="comment">//1. 从 total 取出值</span></span><br><span class="line">        <span class="comment">//2. 将 total+1</span></span><br><span class="line">        <span class="comment">//3. 将 total+1 的计算结果放入到total中</span></span><br><span class="line">        lock.Unlock() <span class="comment">// 放开锁，直接加defer 会报错？</span></span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sub</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">defer</span> wg.Done()</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i&lt;<span class="number">100000</span>; i++ {</span><br><span class="line">        lock.Lock() <span class="comment">// 先把门锁上</span></span><br><span class="line">        total = total - <span class="number">1</span></span><br><span class="line">        lock.Unlock() <span class="comment">// 放开锁</span></span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>{</span><br><span class="line">    wg.Add(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">go</span> add()</span><br><span class="line">    <span class="keyword">go</span> sub()</span><br><span class="line">    wg.Wait()</span><br><span class="line">    fmt.Println(total) <span class="comment">// 0</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>绝大多数的web系统来说 都是读多写少<br>有1w个人同时读数据库 A读的时候 B能读吗？ 为什么要加锁呢 一定要加锁 写和读上面加同一把锁<br>并发严重下降， B读了一个数据 不会对C读数据产生影响吗？ 一定是写和读之间造成的<br>读写锁 <code>RWLock</code> 尽量用，读之间不会产生影响，写和读之间才会产生影响<br>• 尽量用 defer 来释放锁，防止panic没有释放锁</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"sync"</span></span><br><span class="line">    <span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"><span class="keyword">var</span> rwLock sync.RWMutex</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RwMutex</span><span class="params">()</span></span>  {</span><br><span class="line">    <span class="comment">// 加读锁</span></span><br><span class="line">    rwLock.RLock()</span><br><span class="line">    <span class="keyword">defer</span> rwLock.RUnlock()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 也可以加写锁</span></span><br><span class="line">    rwLock.Lock()</span><br><span class="line">    <span class="keyword">defer</span> rwLock.Unlock()</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">read</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">defer</span> wg.Done()</span><br><span class="line">    rwLock.RLock()</span><br><span class="line">    fmt.Println(<span class="string">"开始读取数据"</span>)</span><br><span class="line">    time.Sleep(time.Second * <span class="number">10</span>)</span><br><span class="line">    <span class="comment">// time.Sleep(time.Second)</span></span><br><span class="line">    fmt.Println(<span class="string">"读取成功"</span>)</span><br><span class="line">    rwLock.RUnlock()</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    wg.Add(<span class="number">6</span>)</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">5</span>; i++ {</span><br><span class="line">        <span class="keyword">go</span> read()</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    wg.Wait()</span><br><span class="line">}</span><br><span class="line">-</span><br><span class="line">开始读取数据</span><br><span class="line">开始读取数据</span><br><span class="line">开始读取数据</span><br><span class="line">开始读取数据</span><br><span class="line">开始读取数据</span><br><span class="line">等了<span class="number">10</span>秒钟再打印下面的</span><br><span class="line">读取成功</span><br><span class="line">读取成功</span><br><span class="line">读取成功</span><br><span class="line">读取成功</span><br><span class="line">读取成功</span><br><span class="line">fatal error: all goroutines are asleep - deadlock! 因为<span class="number">6</span>个协程实际上只有<span class="number">5</span>个</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"sync"</span></span><br><span class="line">    <span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"><span class="keyword">var</span> rwLock sync.RWMutex</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">read</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">defer</span> wg.Done()</span><br><span class="line">    rwLock.RLock()</span><br><span class="line">    fmt.Println(<span class="string">"开始读取数据"</span>)</span><br><span class="line">    time.Sleep(time.Second)</span><br><span class="line">    fmt.Println(<span class="string">"读取成功"</span>)</span><br><span class="line">    rwLock.RUnlock()</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">write</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">defer</span> wg.Done()</span><br><span class="line">    rwLock.Lock() <span class="comment">// 没有wLock</span></span><br><span class="line">    fmt.Println(<span class="string">"开始修改数据"</span>)</span><br><span class="line">    time.Sleep(time.Second * <span class="number">10</span>)</span><br><span class="line">    fmt.Println(<span class="string">"修改成功"</span>)</span><br><span class="line">    rwLock.Unlock()</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    wg.Add(<span class="number">6</span>)</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">5</span>; i++ {</span><br><span class="line">        <span class="keyword">go</span> read()</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">1</span>; i++ {</span><br><span class="line">        <span class="keyword">go</span> write()</span><br><span class="line">    }</span><br><span class="line">    wg.Wait()</span><br><span class="line">}</span><br><span class="line">---</span><br><span class="line">开始读取数据</span><br><span class="line">读取成功</span><br><span class="line">开始修改数据</span><br><span class="line">等了<span class="number">10</span>秒钟再打印下面的</span><br><span class="line">修改成功</span><br><span class="line">开始读取数据</span><br><span class="line">开始读取数据</span><br><span class="line">开始读取数据</span><br><span class="line">开始读取数据</span><br><span class="line">读取成功</span><br><span class="line">读取成功</span><br><span class="line">读取成功</span><br><span class="line">读取成功</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">write</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">defer</span> wg.Done()</span><br><span class="line">    rwLock.Lock() <span class="comment">// 没有wLock</span></span><br><span class="line">    fmt.Println(<span class="string">"开始修改数据"</span>)</span><br><span class="line">    time.Sleep(time.Second * <span class="number">10</span>)</span><br><span class="line">    fmt.Println(<span class="string">"修改成功"</span>)</span><br><span class="line">    rwLock.Unlock()</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    wg.Add(<span class="number">10</span>)</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">5</span>; i++ {</span><br><span class="line">        <span class="keyword">go</span> read()</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">5</span>; i++ {</span><br><span class="line">        <span class="keyword">go</span> write()</span><br><span class="line">    }</span><br><span class="line">    wg.Wait()</span><br><span class="line">    fmt.Println(total)</span><br><span class="line">}</span><br><span class="line">---</span><br><span class="line">开始读取数据</span><br><span class="line">开始读取数据</span><br><span class="line">读取成功</span><br><span class="line">读取成功</span><br><span class="line">开始修改数据</span><br><span class="line">修改成功</span><br><span class="line">开始读取数据</span><br><span class="line">开始读取数据</span><br><span class="line">开始读取数据</span><br><span class="line">读取成功</span><br><span class="line">读取成功</span><br><span class="line">读取成功</span><br><span class="line">开始修改数据</span><br><span class="line">修改成功</span><br><span class="line">开始修改数据</span><br><span class="line">修改成功</span><br><span class="line">开始修改数据</span><br><span class="line">修改成功</span><br><span class="line">开始修改数据</span><br><span class="line">修改成功</span><br></pre></td></tr></tbody></table></figure>

<p>锁不可重入：lock 之后，即便是同一个线程(goroutine)，也无法再次加锁（写递归函数要小心）</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 不可重入例子</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Failed1</span><span class="params">()</span></span>  {</span><br><span class="line">    mutex.Lock()</span><br><span class="line">    <span class="keyword">defer</span> mutex.Unlock()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这一句会死锁</span></span><br><span class="line">    <span class="comment">// 但是如果你只有一个goroutine，那么这一个会导致程序崩溃</span></span><br><span class="line">    mutex.Lock()</span><br><span class="line">    <span class="keyword">defer</span> mutex.Unlock()</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>• 锁不可升级：加了读锁之后，如果试图加写锁，锁不升级</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 不可升级</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Failed2</span><span class="params">()</span></span>  {</span><br><span class="line">    rwMutex.RLock()</span><br><span class="line">    <span class="keyword">defer</span> rwMutex.RUnlock()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这一句会死锁</span></span><br><span class="line">    <span class="comment">// 但是如果你只有一个goroutine，那么这一个会导致程序崩溃</span></span><br><span class="line">    mutex.Lock()</span><br><span class="line">    <span class="keyword">defer</span> mutex.Unlock()</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="子协程异常退出"><a href="#子协程异常退出" class="headerlink" title="子协程异常退出"></a>子协程异常退出</h4><p>在使用子协程时一定要特别注意保护好每个子协程，确保它们正常安全的运行。因为子协程的异常退出会将异常传播到主协程，直接会导致主协程也跟着挂掉，然后整个程序就崩溃了。</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    fmt.Println(<span class="string">"run in main goroutine"</span>)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">        fmt.Println(<span class="string">"run in child goroutine"</span>)</span><br><span class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">            fmt.Println(<span class="string">"run in grand child goroutine"</span>)</span><br><span class="line">            <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">                fmt.Println(<span class="string">"run in grand grand child goroutine"</span>)</span><br><span class="line">                <span class="built_in">panic</span>(<span class="string">"wtf"</span>)</span><br><span class="line">            }()</span><br><span class="line">        }()</span><br><span class="line">    }()</span><br><span class="line">    time.Sleep(time.Second)</span><br><span class="line">    fmt.Println(<span class="string">"main goroutine will quit"</span>)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">---------</span><br><span class="line">run in main goroutine</span><br><span class="line">run in child goroutine</span><br><span class="line">run in grand child goroutine</span><br><span class="line">run in grand grand child goroutine</span><br><span class="line"><span class="built_in">panic</span>: wtf</span><br><span class="line"></span><br><span class="line">goroutine <span class="number">34</span> [running]:</span><br><span class="line">main.main.func1<span class="number">.1</span><span class="number">.1</span>()</span><br><span class="line">    /Users/qianwp/<span class="keyword">go</span>/src/github.com/pyloque/practice/main.<span class="keyword">go</span>:<span class="number">14</span> +<span class="number">0x79</span></span><br><span class="line">created by main.main.func1<span class="number">.1</span></span><br><span class="line">    /Users/qianwp/<span class="keyword">go</span>/src/github.com/pyloque/practice/main.<span class="keyword">go</span>:<span class="number">12</span> +<span class="number">0x75</span></span><br><span class="line">exit status <span class="number">2</span></span><br></pre></td></tr></tbody></table></figure>

<p>我们看到主协程最后一句打印语句没能运行就挂掉了，主协程在异常退出时会打印堆栈信息。从堆栈信息中可以了解到是哪行代码引发了程序崩溃。</p>
<p>为了保护子协程的安全，通常我们会在协程的入口函数开头增加 <code>recover()</code> 语句来恢复协程内部发生的异常，阻断它传播到主协程导致程序崩溃。<code>recover</code> 语句必须写在 <code>defer</code> 语句里面。</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">  <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">if</span> err := <span class="built_in">recover</span>(); err != <span class="literal">nil</span> {</span><br><span class="line">      <span class="comment">// log error</span></span><br><span class="line">    }</span><br><span class="line">  }()</span><br><span class="line">  <span class="comment">// do something</span></span><br><span class="line">}()</span><br></pre></td></tr></tbody></table></figure>

<h4 id="协程死循环"><a href="#协程死循环" class="headerlink" title="协程死循环"></a>协程死循环</h4><p>前面我们通过 <code>recover()</code> 函数可以防止个别协程的崩溃波及整体进程。但是如果有个别协程死循环了会导致其它协程饥饿得到不运行么？下面我们来做一个实验</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">    fmt.Println(<span class="string">"run in main goroutine"</span>)</span><br><span class="line">    n := <span class="number">7</span></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; n; i++ {</span><br><span class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">            fmt.Println(<span class="string">"dead loop goroutine start"</span>)</span><br><span class="line">            <span class="keyword">for</span> {</span><br><span class="line">            } <span class="comment">// 死循环</span></span><br><span class="line">        }()</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">for</span> {</span><br><span class="line">        time.Sleep(time.Second)</span><br><span class="line">        fmt.Println(<span class="string">"main goroutine running"</span>)</span><br><span class="line">    }</span><br><span class="line">---</span><br><span class="line">run in main goroutine</span><br><span class="line">dead loop goroutine start</span><br><span class="line">dead loop goroutine start</span><br><span class="line">dead loop goroutine start</span><br><span class="line">dead loop goroutine start</span><br><span class="line">dead loop goroutine start</span><br><span class="line">dead loop goroutine start</span><br><span class="line">dead loop goroutine start</span><br><span class="line">main goroutine running</span><br><span class="line">main goroutine running</span><br><span class="line">main goroutine running</span><br><span class="line">main goroutine running</span><br><span class="line">main goroutine running</span><br><span class="line">main goroutine running</span><br><span class="line">main goroutine running</span><br><span class="line">...</span><br></pre></td></tr></tbody></table></figure>

<p>通过调整上面代码中的变量 n 的值可以发现一个有趣的现象，当 n 值大于 7 时，主协程将没有机会得到运行，而如果 n 值为 7、2、1，主协程依然可以每秒输出一次。要解释这个现象就必须深入了解协程的运行原理 cpu逻辑核心数量  我选8也能打印主协程？</p>
<h4 id="协程的本质"><a href="#协程的本质" class="headerlink" title="协程的本质"></a>协程的本质</h4><p>一个进程内部可以运行多个线程，而每个线程又可以运行很多协程。<br>线程要负责对协程进行调度，保证每个协程都有机会得到执行。<br>当一个协程睡眠时，它要将线程的运行权让给其它的协程来运行，而不能持续霸占这个线程。<br>同一个线程内部最多只会有一个协程正在运行。</p>
<p>线程的调度是由操作系统负责的，调度算法运行在内核态，而协程的调用是由 Go 语言的运行时负责的，调度算法运行在用户态。</p>
<p>协程可以简化为三个状态，运行态、就绪态和休眠态。<br>同一个线程中最多只会存在一个处于运行态的协程，<br>就绪态的协程是指那些具备了运行能力但是还没有得到运行机会的协程，它们随时会被调度到运行态，<br>休眠态的协程还不具备运行能力，它们是在等待某些条件的发生，比如 IO 操作的完成、睡眠时间的结束等。</p>
<p>操作系统对线程的调度是抢占式的，也就是说单个线程的死循环不会影响其它线程的执行，每个线程的连续运行受到时间片的限制。</p>
<p>Go 语言运行时对协程的调度并不是抢占式的。如果单个协程通过死循环霸占了线程的执行权，那这个线程就没有机会去运行其它协程了，你可以说这个线程假死了。不过一个进程内部往往有多个线程，假死了一个线程没事，全部假死了才会导致整个进程卡死。</p>
<p>每个线程都会包含多个就绪态的协程形成了一个就绪队列，如果这个线程因为某个别协程死循环导致假死，那这个队列上所有的就绪态协程是不是就没有机会得到运行了呢？Go 语言运行时调度器采用了 work-stealing 算法，当某个线程空闲时，也就是该线程上所有的协程都在休眠（或者一个协程都没有），它就会去其它线程的就绪队列上去偷一些协程来运行。也就是说这些线程会主动找活干，在正常情况下，运行时会尽量平均分配工作任务。</p>
<h3 id="设置线程数"><a href="#设置线程数" class="headerlink" title="设置线程数"></a>设置线程数</h3><p>默认情况下，Go 运行时会将线程数会被设置为机器 CPU 逻辑核心数。同时它内置的 <code>runtime</code> 包提供了 <code>GOMAXPROCS(n int)</code> 函数允许我们动态调整线程数，注意这个函数名字是全大写，Go 语言的设计者就是这么任性，该函数会返回修改前的线程数，如果参数 n &lt;=0 ，就不会产生修改效果，等价于读操作。线程数不是协程数，改的越大，越能承受更多的死循环</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"runtime"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="comment">// 读取默认的线程数</span></span><br><span class="line">    fmt.Println(runtime.GOMAXPROCS(<span class="number">0</span>)) <span class="comment">// 8</span></span><br><span class="line">    <span class="comment">// 设置线程数为 10</span></span><br><span class="line">    runtime.GOMAXPROCS(<span class="number">10</span>)</span><br><span class="line">    <span class="comment">// 读取当前的线程数</span></span><br><span class="line">    fmt.Println(runtime.GOMAXPROCS(<span class="number">0</span>)) <span class="comment">// 10</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>获取当前的协程数量可以使用 runtime 包提供的 <code>NumGoroutine()</code> 方法</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"runtime"</span></span><br><span class="line">    <span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    fmt.Println(runtime.NumGoroutine()) <span class="comment">// 1</span></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ {</span><br><span class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">            <span class="keyword">for</span> {</span><br><span class="line">                time.Sleep(time.Second)</span><br><span class="line">            }</span><br><span class="line">        }()</span><br><span class="line">    }</span><br><span class="line">    fmt.Println(runtime.NumGoroutine()) <span class="comment">// 11</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">var</span> a [<span class="number">10</span>]<span class="keyword">int</span></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ {</span><br><span class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(i <span class="keyword">int</span>)</span></span> {</span><br><span class="line">            <span class="keyword">for</span> {</span><br><span class="line">                a[i]++            <span class="comment">// 中间没有机会进行协程之间的切换，会被一个协程抢掉，这个协程不主动交出控制权的话，它就始终在这个协程里面</span></span><br><span class="line">            }</span><br><span class="line">        }(i)</span><br><span class="line">    }</span><br><span class="line">    time.Sleep(time.Millisecond)</span><br><span class="line">    fmt.Println(a)</span><br><span class="line">    <span class="comment">// [10694344 6434193 10546265 8131522 8812068 8852472 10570023 0 0 3704848]</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"runtime"</span></span><br><span class="line">    <span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">var</span> a [<span class="number">10</span>]<span class="keyword">int</span></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ {</span><br><span class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(i <span class="keyword">int</span>)</span></span> {</span><br><span class="line">            <span class="keyword">for</span> {</span><br><span class="line">                a[i]++            <span class="comment">// 中间没有机会进行协程之间的切换，会被一个协程抢掉，这个协程不主动交出控制权的话，它就始终在这个协程里面</span></span><br><span class="line">                runtime.Gosched() <span class="comment">// 手动交出控制权，别的也有机会运行，总有机会又调度给自己</span></span><br><span class="line">            }</span><br><span class="line">        }(i)</span><br><span class="line">    }</span><br><span class="line">    time.Sleep(time.Millisecond)</span><br><span class="line">    fmt.Println(a)</span><br><span class="line">    <span class="comment">//[8696348 8301481 9040898 1115475 0 7329666 5930928 10650591 0 9584546]</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">var</span> a [<span class="number">10</span>]<span class="keyword">int</span></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ {</span><br><span class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">            <span class="keyword">for</span> {</span><br><span class="line">                a[i]++            <span class="comment">// 中间没有机会进行协程之间的切换，会被一个协程抢掉，这个协程不主动交出控制权的话，它就始终在这个协程里面</span></span><br><span class="line">                runtime.Gosched() <span class="comment">// 手动交出控制权，别的也有机会运行，总有机会又调度给自己</span></span><br><span class="line">            }</span><br><span class="line">        }()</span><br><span class="line">    }</span><br><span class="line">    time.Sleep(time.Millisecond)</span><br><span class="line">    fmt.Println(a)</span><br><span class="line">    <span class="comment">//panic: runtime error: index out of range [10] with length 10</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<hr>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> atomicInt <span class="keyword">int</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *atomicInt)</span> <span class="title">get</span><span class="params">()</span> <span class="title">int</span></span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">int</span>(*a)</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *atomicInt)</span> <span class="title">increment</span><span class="params">()</span></span> {</span><br><span class="line">    *a++</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">var</span> a atomicInt</span><br><span class="line">    a.increment()</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">        a.increment()</span><br><span class="line">    }()</span><br><span class="line">    fmt.Println(a) <span class="comment">// 1 协程来不及运行</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> atomicInt <span class="keyword">int</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *atomicInt)</span> <span class="title">get</span><span class="params">()</span> <span class="title">int</span></span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">int</span>(*a)</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *atomicInt)</span> <span class="title">increment</span><span class="params">()</span></span> {</span><br><span class="line">    *a++</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">var</span> a atomicInt</span><br><span class="line">    a.increment()</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">        a.increment()</span><br><span class="line">    }()</span><br><span class="line">    time.Sleep(time.Millisecond)</span><br><span class="line">    fmt.Println(a) <span class="comment">// 2</span></span><br><span class="line">}</span><br><span class="line">----</span><br><span class="line"><span class="keyword">go</span> run -race <span class="number">3.</span><span class="keyword">go</span></span><br><span class="line">==================</span><br><span class="line">WARNING: DATA RACE竞争</span><br><span class="line">Read at <span class="number">0x00c0000ac078</span> by main goroutine:</span><br><span class="line">  main.main()</span><br><span class="line">      C:/Users/rose/<span class="keyword">go</span>/src/learngo/lang/channel/<span class="number">3</span>/<span class="number">3.</span><span class="keyword">go</span>:<span class="number">24</span> +<span class="number">0xee</span></span><br><span class="line"></span><br><span class="line">Previous write at <span class="number">0x00c0000ac078</span> by goroutine <span class="number">7</span>:</span><br><span class="line">  main.(*atomicInt).increment()</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"sync"</span></span><br><span class="line">    <span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> atomicInt <span class="keyword">struct</span> {</span><br><span class="line">    value <span class="keyword">int</span></span><br><span class="line">    lock sync.Mutex</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *atomicInt)</span> <span class="title">get</span><span class="params">()</span> <span class="title">int</span></span>{</span><br><span class="line">    a.lock.Lock()</span><br><span class="line">    <span class="keyword">defer</span> a.lock.Unlock()</span><br><span class="line">    <span class="keyword">return</span> a.value</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *atomicInt)</span> <span class="title">increment</span><span class="params">()</span></span> {</span><br><span class="line">    a.lock.Lock()</span><br><span class="line">    <span class="keyword">defer</span> a.lock.Unlock() <span class="comment">//defer的正确用法</span></span><br><span class="line">    a.value++</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">var</span> a atomicInt</span><br><span class="line">    a.increment()</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">        a.increment()</span><br><span class="line">    }()</span><br><span class="line">    time.Sleep(time.Millisecond)</span><br><span class="line">    fmt.Println(a.get()) <span class="comment">// 2</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 如果要在一段代码端同步，那就变成一个匿名函数就好了，出这块代码区释放，代码区对a.value进行保护</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *atomicInt)</span> <span class="title">increment</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">        a.lock.Lock()</span><br><span class="line">        <span class="keyword">defer</span> a.lock.Unlock() <span class="comment">//defer的只控制这个匿名函数体</span></span><br><span class="line">        <span class="comment">//............</span></span><br><span class="line">        a.value++</span><br><span class="line">        <span class="comment">//.........</span></span><br><span class="line">    }()</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">var</span> a atomicInt</span><br><span class="line">    a.increment()</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">        a.increment()</span><br><span class="line">    }()</span><br><span class="line">    time.Sleep(time.Millisecond)</span><br><span class="line">    fmt.Println(a.get()) <span class="comment">// 2</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<hr>
<p><code>sync.Map</code>并发安全 map<br>• key 和 value 类型都是<code>interface{}</code>。意味着你要搞各种类型断言</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">m := sync.Map{}</span><br><span class="line">m.Store(<span class="string">"cat"</span>, <span class="string">"Tom"</span>)</span><br><span class="line">m.Store(<span class="string">"mouse"</span>, <span class="string">"Jerry"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这里重新读取出来的，就是</span></span><br><span class="line">val, ok := m.Load(<span class="string">"cat"</span>)</span><br><span class="line"><span class="keyword">if</span> ok {</span><br><span class="line">    fmt.Println(<span class="built_in">len</span>(val.(<span class="keyword">string</span>))) <span class="comment">// 3</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><code>sync.Once</code>：只执行一次，一般用来解决一些初始化的需求</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> once sync.Once</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这个方法，不管调用几次，只会输出一次</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">PrintOnce</span><span class="params">()</span></span> {</span><br><span class="line">    once.Do(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">        fmt.Println(<span class="string">"只输出一次"</span>)</span><br><span class="line">    })</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    PrintOnce()</span><br><span class="line">    PrintOnce()</span><br><span class="line">    PrintOnce()</span><br><span class="line">}</span><br><span class="line">----</span><br><span class="line">只输出一次</span><br></pre></td></tr></tbody></table></figure>

<h4 id="sync-Pool"><a href="#sync-Pool" class="headerlink" title="sync.Pool"></a><code>sync.Pool</code></h4><ol>
<li>优先从自己的缓存里面返回数据；</li>
<li>如果不够了，就创建一个新的，使用传入的New 回调；</li>
<li>在 GC 的时候，sync.Pool 会被清空</li>
</ol>
<p>sync.Pool 的缺陷：</p>
<ol>
<li>没有超时机制</li>
<li>无法限制内存使用量</li>
<li>GC 全部清掉</li>
</ol>
<p>sync.Pool 的一般使用步骤（以user为例）</p>
<ol>
<li>定义 user 结构体</li>
<li>为 user 加上 Reset 方法。该方法用于重置对象，<br>接收器是指针；</li>
<li>定义一个 sync.Pool</li>
<li>调用 Get 方法</li>
<li>使用defer 保证放回去 pool</li>
<li>重置 user</li>
<li>执行业务逻辑</li>
</ol>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> user <span class="keyword">struct</span> {</span><br><span class="line">    Name <span class="keyword">string</span></span><br><span class="line">    Email <span class="keyword">string</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 一般来说，复用对象都要求我们取出来之后，</span></span><br><span class="line"><span class="comment">// 重置里面的字段</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *user)</span> <span class="title">Reset</span><span class="params">(name <span class="keyword">string</span>, email <span class="keyword">string</span>)</span></span>  {</span><br><span class="line">    u.Email = email</span><br><span class="line">    u.Name = name</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    pool := sync.Pool{</span><br><span class="line">        New: <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">interface</span></span>{}{</span><br><span class="line">            <span class="keyword">return</span> &amp;user{}</span><br><span class="line">    }}</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get 返回的是 interface{}，所以需要类型断言</span></span><br><span class="line">    u := pool.Get().(*user)</span><br><span class="line">    <span class="comment">// defer 还回去</span></span><br><span class="line">    <span class="keyword">defer</span> pool.Put(u)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 紧接着重置 u 这个对象</span></span><br><span class="line">    u.Reset(<span class="string">"Tom"</span>, <span class="string">"my_email@qq.com"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 下边就是使用 u 来完成你的业务逻辑</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/08/20/go-de-channel/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/08/20/go-de-channel/" class="post-title-link" itemprop="url">go的channel</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-08-19 16:21:41" itemprop="dateCreated datePublished" datetime="2021-08-19T16:21:41Z">2021-08-19</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-09-24 10:18:52" itemprop="dateModified" datetime="2021-09-24T10:18:52Z">2021-09-24</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>协程都是独立运行的，他们之间没有通信。</p>
<p>不同的并行协程之间交流的方式有两种，一种是通过共享变量，但是不建议这么做。<br>另一种是通过队列。Go 语言鼓励使用先入先出(FIFO)的队列的形式来交流，它单独为协程之间的队列数据交流定制了特殊的语法类型 —— channle通道，可以通过它来进行goroutine之间的通信，可以避免共享内存的坑。通道是并发安全、用来传递数据的的数据结构，它类似于内存消息队列，允许很多的协程并发对通道进行读写。接收的数据和发送的数据的顺序是一致的。</p>
<p>通过它并发核心单元就可以发送或者接收数据进行通讯(communication)</p>
<p>channel的通信保证了同步性。<br>同一时间只有一个协程可以访问数据，所以不会出现数据竞争，设计时就是这样的。</p>
<p>如果把协程比喻成小岛，那通道就是岛屿之间的交流桥梁管道，数据搭乘通道从一个协程流转到另一个协程。</p>
<p>通道是协程的输入和输出。<br>作为协程的输出，通道是一个容器，它可以容纳数据。<br>作为协程的输入，通道是一个生产者，它可以向协程提供数据。<br>通道作为容器是有限定大小的，满了就写不进去，空了就读不出来。</p>
<p>通道可用于两个 goroutine 之间通过传递一个指定类型的值来同步运行和通讯。<br>一个 goroutine 可以向另一 goroutine 定向发送消息。通道一般作为不同的协程交流的媒介，在同一个协程里它也是可以使用的。<br>channel 本身还需关联了一个类型，channel 可以发送数据的类型，限定进入通道的数据的类型。<br>例如: 发送 int 类型消息的 channel 写作 <code>chan int</code> 。函数也可以类型。</p>
<p>四种通道类型</p>
<p>Channel三种类型的定义。格式如下：</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ChannelType = ( <span class="string">"chan"</span> | <span class="string">"chan"</span> <span class="string">"&lt;-"</span> | <span class="string">"&lt;-"</span> <span class="string">"chan"</span> ) ElementType .</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>单向通道 一次只能读写一个元素。<br>操作符是箭头 <code>&lt;-</code> 用于指定通道的方向，发送或接收。(箭头的指向就是数据的流向)</li>
</ul>
<p>把箭头 <code>&lt;-</code> 写在通道变量的右边就是写通道，<br>只发送的channel，只能向channel写数据</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> chan4 <span class="keyword">chan</span> &lt;-<span class="keyword">int</span></span><br><span class="line"></span><br><span class="line">chan4 := <span class="built_in">make</span>(<span class="keyword">chan</span> &lt;-<span class="keyword">int</span>)</span><br></pre></td></tr></tbody></table></figure>

<p>把箭头写在通道变量 chan 的左边就是读通道。<br>只接收的channel，只能从channel读取数据</p>
<p>receive 操作符<br><code>&lt;- ch</code>用来从channel ch中接收数据，这个表达式会一直被block，直到有数据可以接收。</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> chan4 &lt;-<span class="keyword">chan</span> <span class="keyword">int</span></span><br><span class="line"></span><br><span class="line">chan4 := <span class="built_in">make</span>(&lt;-<span class="keyword">chan</span> <span class="keyword">int</span>) <span class="comment">//初始化</span></span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>如果没有指定方向，那么是双向通道，既可以接收数据，也可以发送数据。</li>
</ul>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">chan</span> T          <span class="comment">// 可以接收和发送类型为 T 的数据</span></span><br><span class="line"><span class="keyword">chan</span>&lt;- <span class="keyword">float64</span>  <span class="comment">// 只可以用来发送 float64 类型的数据给channel</span></span><br><span class="line">&lt;-<span class="keyword">chan</span> <span class="keyword">int</span>      <span class="comment">// 只可以从channel接收 int 类型的数据</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> msg = <span class="built_in">make</span>(<span class="keyword">chan</span>&lt;- <span class="keyword">int</span>, <span class="number">10</span>)</span><br><span class="line">msg &lt;- <span class="number">1</span></span><br><span class="line">msg &lt;- <span class="number">1</span></span><br><span class="line">data := &lt;-msg <span class="comment">// invalid operation: &lt;-msg (receive from send-only type chan&lt;- int)</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> msg = <span class="built_in">make</span>(&lt;-<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">10</span>)</span><br><span class="line">msg &lt;- <span class="number">1</span> <span class="comment">// invalid operation: msg &lt;- 1 (send to receive-only type &lt;-chan int)</span></span><br></pre></td></tr></tbody></table></figure>


<p><code>&lt;-</code>总是优先和最左边的类型结合。(The <code>&lt;-</code> operator associates with the leftmost chan possible)</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">chan</span>&lt;- <span class="keyword">chan</span> <span class="keyword">int</span>    <span class="comment">// 等价 chan&lt;- (chan int)</span></span><br><span class="line"><span class="keyword">chan</span>&lt;- &lt;-<span class="keyword">chan</span> <span class="keyword">int</span>  <span class="comment">// 等价 chan&lt;- (&lt;-chan int)</span></span><br><span class="line">&lt;-<span class="keyword">chan</span> &lt;-<span class="keyword">chan</span> <span class="keyword">int</span>  <span class="comment">// 等价 &lt;-chan (&lt;-chan int)</span></span><br><span class="line"><span class="keyword">chan</span> (&lt;-<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>总结：make 初始化三种类型: slice, map和channel<br>像 map 和 slice 数据类型一样, channel必须先创建再使用:</li>
<li>channel是引用类型，和其他引用类型一样，channel 的空值为 <code>nil</code> ，使用 <code>==</code> 可以对类型相同的 channel 进行比较，只有指向相同对象或同为 nil 时，才返回 true。</li>
</ul>
<p>操作    值为 nil 的 channel    被关闭的 channel    正常的 channel<br>close    panic                 panic             成功关闭<br>c&lt;-    无select永远阻塞，有select不会阻塞                 panic            阻塞或成功发送<br>&lt;-c    永远阻塞                 永远不阻塞         阻塞或成功接收</p>
<ul>
<li>必须通过make初始化的，否则会出现永久阻塞的现象。</li>
</ul>
<p><code>make</code>的第一个参数需要是关键字chan，之后跟着允许限定通道可以容纳交换的数据类型</p>
<p><code>make</code>初始化Channel的第二个参数指定缓存的大小、容量：<code>ch := make(chan int, 100)</code>。</p>
<p>容量(capacity)代表Channel容纳的最多的元素的数量，</p>
<h3 id="无（非）缓冲型通道"><a href="#无（非）缓冲型通道" class="headerlink" title="无（非）缓冲型通道"></a>无（非）缓冲型通道</h3><p>没有设置容量，或者容量设置为0，</p>
<p>缺省情况下，不管是存消息还是取消息，都会挂起当前goroutine，发送和接收会一直阻塞着，除非另外一端已经准备好。只有sender和receiver都准备好了后它们的通讯(communication)才会发生。<br>发送端发送数据写操作会阻塞直到有其它协程接收方来从当前通道中读取当前通道接收数据。<br>无缓冲区的channel永远不会存数据，只负责数据的流通。</p>
<p>总是处于既满又空的状态。<br>这种方式可以用来在gororutine中进行同步，而不必使用显示的锁或者条件变量。</p>
<p>通道空了，读操作就会阻塞，协程也会进入睡眠，直到有其它协程写通道装进了数据才会被唤醒。如果有多个协程的读操作阻塞了，一个写操作也只会唤醒一个协程。</p>
<p>从无缓冲channel取数据，必须要有数据流进来才可以，否则当前协程阻塞<br>数据流入无缓冲channel，如果没有其他goroutine来拿走这个数据，那么当前协程阻塞<br>注意：<br>同步的channel不能只在一个协程中发送和接收，因为会被永远阻塞，数据不能到接收方那里。</p>
<h3 id="有缓存"><a href="#有缓存" class="headerlink" title="有缓存"></a>有缓存</h3><p>有可能不发生阻塞，发送方则会阻塞直到发送的值被拷贝到缓冲区内；并且缓存未满，则send会被执行不会阻塞；<br>如果缓冲区已满。接收方在有值可以接收之前会一直阻塞。<br>send写操作就会阻塞，协程就会进入休眠，直到有其它协程某个接收方读通道挪出了空间，协程才会被唤醒。如果有多个协程的写操作都阻塞了，一个读操作只会唤醒一个协程。</p>
<p>带缓冲区的通道允许发送端的数据发送和接收端的数据获取处于异步状态，就是说发送端发送的数据可以放在缓冲区里面，可以等待接收端去获取数据，而不是立刻需要接收端去获取数据。</p>
<p>在 Go 语言里不存在无界通道，每个通道都是有限定最大容量的，缓冲区的大小是有限的，所以还是必须有接收端来接收数据的，否则缓冲区一满，数据发送端就无法再发送数据了。</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SendStmt = Channel <span class="string">"&lt;-"</span> Expression .</span><br><span class="line">Channel = Expression .</span><br></pre></td></tr></tbody></table></figure>

<p>通道作为容器，它可以像切片一样，使用 <code>cap()</code> 和 <code>len()</code> 全局函数获得通道的容量和当前内部的元素个数。</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">var</span> ch <span class="keyword">chan</span> <span class="keyword">int</span> = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">4</span>)</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">cap</span>(ch); i++ {</span><br><span class="line">        ch &lt;- i <span class="comment">// 写通道</span></span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">for</span> <span class="built_in">len</span>(ch) &gt; <span class="number">0</span> {</span><br><span class="line">        <span class="keyword">var</span> value <span class="keyword">int</span> = &lt;-ch <span class="comment">// 读通道</span></span><br><span class="line">        fmt.Println(value)</span><br><span class="line">    }</span><br><span class="line">---</span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br></pre></td></tr></tbody></table></figure>

<p>在通讯(communication)开始前channel和expression必须先求值出来(evaluated)，比如下面的(3+4)先计算出7然后再发送给channel。</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line"><span class="keyword">defer</span> <span class="built_in">close</span>(c)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> { c &lt;- <span class="number">3</span> + <span class="number">4</span> }()</span><br><span class="line">i := &lt;-c</span><br><span class="line">fmt.Println(i) <span class="comment">// 7</span></span><br></pre></td></tr></tbody></table></figure>

<p>send被执行前(proceed)通讯(communication)一直被阻塞着。</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> msg <span class="keyword">chan</span> <span class="keyword">int</span> <span class="comment">// 申明</span></span><br><span class="line"><span class="keyword">if</span> msg != <span class="literal">nil</span> {</span><br><span class="line">    fmt.Println(<span class="string">"not nil"</span>)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">msg = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>) <span class="comment">// 初始化不带缓冲区的整型通道</span></span><br><span class="line">msg &lt;- <span class="number">1</span> <span class="comment">// 发送值 1 到通道 msg // fatal error: all goroutines are asleep - deadlock! 没有缓冲的channel 在没有启动一个接收者之前，放数据到msg中的时候会阻塞的，阻塞之前会获取一把锁，这把锁是要等到数据被接收之后释放，但是没有接收者就没法释放锁</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> msg1 = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">1</span>)</span><br><span class="line">msg1 &lt;- <span class="number">1</span> <span class="comment">// 发送值 1 到通道 msg</span></span><br><span class="line">msg1 &lt;- <span class="number">2</span> <span class="comment">// 发送值 2 到通道 msg fatal error: all goroutines are asleep - deadlock!</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>{</span><br><span class="line">    msg := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span>{</span><br><span class="line">        <span class="comment">// 取数据: 将箭头右边的值放到左边</span></span><br><span class="line">        data := &lt;- msg <span class="comment">//  从通道 msg 接收数据，并将数据赋值给 data</span></span><br><span class="line">        fmt.Println(data) <span class="comment">// </span></span><br><span class="line">    }()</span><br><span class="line">    msg &lt;- <span class="number">1</span> <span class="comment">// 发送值 1 到通道 msg</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义了一个可以存储整数类型的带缓冲通道</span></span><br><span class="line"><span class="keyword">var</span> msg1 = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">1</span>) <span class="comment">// 初始化 缓冲区大小为1的整型通道</span></span><br><span class="line">msg1 &lt;- <span class="number">1</span> <span class="comment">// 1 放入 msg 这个 channel 中</span></span><br><span class="line">data1 := &lt;- msg1 <span class="comment">// 将箭头右边的值放到左边，从 msg 这个 channel 取数据放到 data</span></span><br><span class="line">fmt.Println(data1) <span class="comment">// 1</span></span><br><span class="line">fmt.Println(&lt;-msg1) <span class="comment">// fatal error: all goroutines are asleep - deadlock!</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">2</span>) <span class="comment">// 初始化  缓冲区大小为2</span></span><br><span class="line"><span class="comment">// 因为 ch 是带缓冲的通道，我们可以同时发送两个数据</span></span><br><span class="line"><span class="comment">// 而不用立刻需要去同步读取数据</span></span><br><span class="line">ch &lt;- <span class="number">1</span></span><br><span class="line">ch &lt;- <span class="number">2</span></span><br><span class="line"><span class="comment">// 获取这两个数据</span></span><br><span class="line">fmt.Println(&lt;-ch) <span class="comment">// 1</span></span><br><span class="line">fmt.Println(&lt;-ch) <span class="comment">// 2</span></span><br><span class="line">fmt.Println(&lt;-ch) <span class="comment">// fatal error: all goroutines are asleep - deadlock!</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">``</span><span class="string">`</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">`</span><span class="string">``</span><span class="keyword">go</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">``</span><span class="string">`</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">`</span><span class="string">``</span><span class="keyword">go</span></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"math/rand"</span></span><br><span class="line">    <span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">send</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> {</span><br><span class="line">    <span class="keyword">for</span> {</span><br><span class="line">        <span class="keyword">var</span> value = rand.Intn(<span class="number">100</span>) <span class="comment">// 0到n之间的整数</span></span><br><span class="line">        ch &lt;- value</span><br><span class="line">        fmt.Printf(<span class="string">"send %d\n"</span>, value)</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">recv</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> {</span><br><span class="line">    <span class="keyword">for</span> {</span><br><span class="line">        value := &lt;-ch</span><br><span class="line">        fmt.Printf(<span class="string">"recv %d\n"</span>, value)</span><br><span class="line">        time.Sleep(time.Second)</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">var</span> ch = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">1</span>)</span><br><span class="line">    <span class="comment">// 子协程循环读</span></span><br><span class="line">    <span class="keyword">go</span> recv(ch)</span><br><span class="line">    <span class="comment">// 主协程循环写</span></span><br><span class="line">    send(ch)</span><br><span class="line">}</span><br><span class="line">---</span><br><span class="line">send <span class="number">81</span></span><br><span class="line">send <span class="number">87</span></span><br><span class="line">recv <span class="number">81</span></span><br><span class="line">recv <span class="number">87</span></span><br><span class="line">send <span class="number">47</span></span><br><span class="line">recv <span class="number">47</span></span><br><span class="line">send <span class="number">59</span></span><br><span class="line">recv <span class="number">59</span></span><br><span class="line">send <span class="number">81</span></span><br><span class="line">recv <span class="number">81</span></span><br><span class="line">send <span class="number">18</span></span><br><span class="line">recv <span class="number">18</span></span><br></pre></td></tr></tbody></table></figure>

<p>没有缓冲 但channel中有数据 写就会被阻塞，但消费了 还能在写入</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// chan_test.go</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"testing"</span></span><br><span class="line">    <span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestService</span><span class="params">(t *testing.T)</span></span> {</span><br><span class="line">    dataCh := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line">    <span class="keyword">go</span> production(dataCh)</span><br><span class="line">    <span class="keyword">go</span> consume(dataCh)</span><br><span class="line">    time.Sleep(time.Second * <span class="number">3</span>)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生产者</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">production</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> {</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++ {</span><br><span class="line">        ch &lt;- i</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 消费者</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">consume</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> {</span><br><span class="line">    <span class="keyword">for</span> {</span><br><span class="line">        <span class="keyword">select</span> {</span><br><span class="line">        <span class="keyword">case</span> data := &lt;-ch:</span><br><span class="line">            fmt.Println(data)</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line">---</span><br><span class="line">=== RUN   TestService</span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line">...</span><br><span class="line"><span class="number">997</span></span><br><span class="line"><span class="number">998</span></span><br><span class="line"><span class="number">999</span></span><br><span class="line">--- PASS: TestService (<span class="number">3.00</span>s)</span><br><span class="line">PASS</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ichan = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">3</span>)</span><br><span class="line"><span class="keyword">var</span> str <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">f</span><span class="params">()</span></span> {</span><br><span class="line">    str = <span class="string">"hello world"</span></span><br><span class="line">    ichan &lt;- <span class="number">0</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">go</span> f()</span><br><span class="line">    &lt;-ichan  <span class="comment">//这里有值，下面才会运行</span></span><br><span class="line">    fmt.Println(str) <span class="comment">// hello world</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">    chan1 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">3</span>)</span><br><span class="line">    quit := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>) <span class="comment">// 阻塞主进程，防止未处理完的子协程</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">        <span class="keyword">for</span> d := <span class="keyword">range</span> chan1 { <span class="comment">// 如果data的缓冲区为空，这个协程会一直阻塞，除非被channel被close</span></span><br><span class="line">            fmt.Println(d)</span><br><span class="line">        }</span><br><span class="line">        quit &lt;- <span class="literal">true</span></span><br><span class="line">    }()</span><br><span class="line"></span><br><span class="line">    chan1 &lt;- <span class="number">1</span></span><br><span class="line">    chan1 &lt;- <span class="number">2</span></span><br><span class="line">    chan1 &lt;- <span class="number">3</span></span><br><span class="line">    chan1 &lt;- <span class="number">4</span></span><br><span class="line">    chan1 &lt;- <span class="number">5</span></span><br><span class="line">    <span class="built_in">close</span>(chan1) <span class="comment">// 用完需要关闭，否则goroutine会被死锁，因为上面用range，它是不等到信道关闭是不会结束读取的</span></span><br><span class="line">    &lt;-quit       <span class="comment">// 解除阻塞</span></span><br><span class="line">---</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="number">5</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"sync"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup <span class="comment">// 使用计数来等待指定事件完成。</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>{</span><br><span class="line">    <span class="keyword">var</span> msg = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">1</span>)</span><br><span class="line">    msg &lt;- <span class="number">1</span></span><br><span class="line">    msg &lt;- <span class="number">2</span> <span class="comment">// fatal error: all goroutines are asleep - deadlock!</span></span><br><span class="line">    wg.Add(<span class="number">1</span>) <span class="comment">// 增加计数值</span></span><br><span class="line">    <span class="keyword">go</span> consume(msg) <span class="comment">// 通过启动协程消费channel</span></span><br><span class="line">    <span class="comment">// Wait() 阻塞等待所有的写通道协程结束，待计数值变成零，Wait() 才会返回</span></span><br><span class="line">    wg.Wait()</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">consume</span><span class="params">(queue <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span>{</span><br><span class="line">    <span class="keyword">defer</span> wg.Done() <span class="comment">// 计数值减一</span></span><br><span class="line">    data := &lt;- queue</span><br><span class="line">    fmt.Println(data)</span><br><span class="line">}</span><br><span class="line">---</span><br><span class="line">fatal error: all goroutines are asleep - deadlock!</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"sync"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>{</span><br><span class="line">    <span class="keyword">var</span> msg = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">1</span>)</span><br><span class="line">    msg &lt;- <span class="number">1</span></span><br><span class="line">    wg.Add(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">go</span> consume(msg)</span><br><span class="line">    msg &lt;- <span class="number">2</span></span><br><span class="line">    wg.Wait()</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">consume</span><span class="params">(queue <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span>{</span><br><span class="line">    <span class="keyword">defer</span> wg.Done()</span><br><span class="line">    data := &lt;- queue</span><br><span class="line">    fmt.Println(data)</span><br><span class="line">}</span><br><span class="line">---</span><br><span class="line"><span class="number">1</span></span><br></pre></td></tr></tbody></table></figure>

<p>happens-before 特性</p>
<p>无缓冲时，接收 happens-before 发送<br>任何情况下，发送 happens-before 接收<br>close happens-before 接收</p>
<h3 id="通过for-range获取channel的数据"><a href="#通过for-range获取channel的数据" class="headerlink" title="通过for range获取channel的数据"></a>通过for range获取channel的数据</h3><p>除了可以遍历数组、切片、字典，还可以遍历通道，取代箭头操作符。<br>当通道空了，循环会暂停阻塞，<br>当通道关闭时，阻塞停止，循环也跟着结束了。<br>当循环结束时，我们就知道通道已经关闭了。</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">        time.Sleep(<span class="number">1</span> * time.Hour)</span><br><span class="line">    }()</span><br><span class="line">    c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">        <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i = i + <span class="number">1</span> {</span><br><span class="line">            c &lt;- i</span><br><span class="line">        }</span><br><span class="line">        <span class="built_in">close</span>(c)</span><br><span class="line">    }()</span><br><span class="line">    <span class="keyword">for</span> i := <span class="keyword">range</span> c {</span><br><span class="line">        fmt.Println(i)</span><br><span class="line">    }</span><br><span class="line">    fmt.Println(<span class="string">"Finished"</span>)</span><br><span class="line">}</span><br><span class="line">---</span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">6</span></span><br><span class="line"><span class="number">7</span></span><br><span class="line"><span class="number">8</span></span><br><span class="line"><span class="number">9</span></span><br><span class="line">Finished</span><br></pre></td></tr></tbody></table></figure>

<p><code>range c</code>遍历读取到的迭代值为Channel中发送的值，它会一直迭代直到channel被关闭。上面的例子中如果把<code>close(c)</code>注释掉，程序会一直阻塞在 <code>for …… range</code> 那一行</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">var</span> msg = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">1</span>)</span><br><span class="line">    msg &lt;- <span class="number">1</span></span><br><span class="line">    wg.Add(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">go</span> consume(msg)</span><br><span class="line">    msg &lt;- <span class="number">2</span></span><br><span class="line">    wg.Wait()</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">consume</span><span class="params">(queue <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> {</span><br><span class="line">    <span class="keyword">defer</span> wg.Done()</span><br><span class="line">    <span class="keyword">for</span> data := <span class="keyword">range</span> queue {</span><br><span class="line">        fmt.Println(data)</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line">---</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span> 为什么会打印<span class="number">2</span>，因为<span class="number">2</span>发送的msg，执行<span class="keyword">for</span>循环的第二轮，打印完<span class="number">2</span>关闭</span><br><span class="line">fatal error: all goroutines are asleep - deadlock!执行<span class="keyword">for</span>循环的第三轮，从空的通道循环</span><br></pre></td></tr></tbody></table></figure>

<h3 id="关闭"><a href="#关闭" class="headerlink" title="关闭"></a>关闭</h3><p>内建的close方法关闭Channel。<br>通道如果没有显式关闭，当它不再被程序使用的时候，会自动关闭被垃圾回收掉。<br>不过优雅的程序应该将通道看成资源，显式关闭每个不再使用的资源是一种良好的习惯。<br>你可以在多个goroutine从/往 一个channel 中 receive/send 数据，不必考虑额外的同步措施。</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">var</span> msg = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">1</span>)</span><br><span class="line">    msg &lt;- <span class="number">1</span></span><br><span class="line">    wg.Add(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">go</span> consume(msg)</span><br><span class="line">    msg &lt;- <span class="number">2</span></span><br><span class="line">    <span class="built_in">close</span>(msg) <span class="comment">// 让for循环正常结束，不报错</span></span><br><span class="line">    wg.Wait()</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">consume</span><span class="params">(queue <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> {</span><br><span class="line">    <span class="keyword">defer</span> wg.Done()</span><br><span class="line">    <span class="keyword">for</span> data := <span class="keyword">range</span> queue {</span><br><span class="line">        fmt.Println(data)</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line">---</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>channel关闭后sender的receiver操作。</p>
<p>往一个已经被close关闭的channel中继续发送写数据会导致 <code>panic: send on closed channel</code>。</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">    time.Sleep(time.Hour)</span><br><span class="line">}()</span><br><span class="line">c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">10</span>)</span><br><span class="line">c &lt;- <span class="number">1</span></span><br><span class="line">c &lt;- <span class="number">2</span></span><br><span class="line"><span class="built_in">close</span>(c)</span><br><span class="line">c &lt;- <span class="number">3</span> <span class="comment">// panic: send on closed channel</span></span><br></pre></td></tr></tbody></table></figure>


<p>已经关闭的channel，<br>读取一个已经关闭的无缓冲通道会立即返回通道类型的「零值」<br>读取一个已经关闭的有缓存的能够继续接收读取已发送的数据不会被阻塞、不会产生 <code>panic</code>，且能读出 channel 中还未被读取的消息，直到已发送的数据接收读取完为止后，再读取立即返回channel中具体类型的零值(zero value)。</p>
<p>如果通道里的元素是整型的，读操作是不能通过返回值来确定通道是否关闭的。<br>关闭 channel 会产生一个广播机制，所有向 channel 读取消息的 goroutine 都会收到消息</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ch = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">5</span>)</span><br><span class="line">ch &lt;- <span class="number">1</span></span><br><span class="line">ch &lt;- <span class="number">2</span></span><br><span class="line">ch &lt;- <span class="number">3</span></span><br><span class="line">ch &lt;- <span class="number">4</span></span><br><span class="line"><span class="built_in">close</span>(ch)</span><br><span class="line">fmt.Println(&lt;-ch) <span class="comment">// 1</span></span><br><span class="line">fmt.Println(&lt;-ch) <span class="comment">// 2</span></span><br><span class="line">value := &lt;-ch</span><br><span class="line">fmt.Println(value) <span class="comment">// 3</span></span><br><span class="line">value = &lt;-ch</span><br><span class="line">fmt.Println(value) <span class="comment">// 4</span></span><br><span class="line">value = &lt;-ch</span><br><span class="line">fmt.Println(value) <span class="comment">// 0</span></span><br><span class="line">fmt.Println(&lt;-ch) <span class="comment">// 0</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">    c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">10</span>)</span><br><span class="line">    c &lt;- <span class="number">1</span></span><br><span class="line">    c &lt;- <span class="number">2</span></span><br><span class="line">    <span class="keyword">for</span> i := <span class="keyword">range</span> c {</span><br><span class="line">        fmt.Println(i)</span><br><span class="line">    }</span><br><span class="line">--</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line">fatal error: all goroutines are asleep - deadlock!</span><br></pre></td></tr></tbody></table></figure>

<p>通道关闭，依然可以读取数据，<br>通过<code>range</code>读取，channel关闭后for循环直到数据读取完为止，自动跳出不报错：</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">    c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">10</span>)</span><br><span class="line">    c &lt;- <span class="number">1</span></span><br><span class="line">    c &lt;- <span class="number">2</span></span><br><span class="line">    <span class="built_in">close</span>(c)</span><br><span class="line">    <span class="keyword">for</span> i := <span class="keyword">range</span> c {</span><br><span class="line">        fmt.Println(i)</span><br><span class="line">    }</span><br><span class="line">---</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br></pre></td></tr></tbody></table></figure>


<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"time"</span></span><br><span class="line">    <span class="string">"sync"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">var</span> msg = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">1</span>)</span><br><span class="line">    msg &lt;- <span class="number">1</span></span><br><span class="line">    wg.Add(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">go</span> consume(msg)</span><br><span class="line">    msg &lt;- <span class="number">2</span></span><br><span class="line">    <span class="built_in">close</span>(msg)</span><br><span class="line">    wg.Wait()</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">consume</span><span class="params">(queue <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> {</span><br><span class="line">    <span class="keyword">defer</span> wg.Done()</span><br><span class="line">    <span class="keyword">for</span> data := <span class="keyword">range</span> queue {</span><br><span class="line">        fmt.Println(data)</span><br><span class="line">        time.Sleep(time.Second) <span class="comment">// 睡眠1秒钟后，2发送给msg，通道关闭，依然可以读取数据，直到数据读取完为止</span></span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line">--</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br></pre></td></tr></tbody></table></figure>


<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">fibonacci</span><span class="params">(n <span class="keyword">int</span>, c <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> {</span><br><span class="line">        x, y := <span class="number">0</span>, <span class="number">1</span></span><br><span class="line">        <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; n; i++ {</span><br><span class="line">                c &lt;- x</span><br><span class="line">                x, y = y, x+y</span><br><span class="line">        }</span><br><span class="line">        <span class="built_in">close</span>(c)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">        c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">10</span>)</span><br><span class="line">        <span class="keyword">go</span> fibonacci(<span class="built_in">cap</span>(c), c)</span><br><span class="line">        <span class="comment">// range 函数遍历每个从通道接收到的数据，因为 c 在发送完 10 个</span></span><br><span class="line">        <span class="comment">// 数据之后就关闭了通道，所以这里我们 range 函数在接收到 10 个数据</span></span><br><span class="line">        <span class="comment">// 之后就结束了。如果上面的 c 通道不关闭，那么 range 函数就不</span></span><br><span class="line">        <span class="comment">// 会结束，从而在接收第 11 个数据的时候就阻塞了。</span></span><br><span class="line">        <span class="keyword">for</span> i := <span class="keyword">range</span> c {</span><br><span class="line">                fmt.Println(i)</span><br><span class="line">        }</span><br><span class="line">}</span><br><span class="line">---</span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">8</span></span><br><span class="line"><span class="number">13</span></span><br><span class="line"><span class="number">21</span></span><br><span class="line"><span class="number">34</span></span><br></pre></td></tr></tbody></table></figure>

<p>channel的 receive支持 multi-valued assignment<br>语句可以将值赋值给一个或者两个变量。<br>用一个额外的返回参数来检查channel是否关闭。判断值是零值还是正常读取的值<br>如果OK 是false，表明接收的x是产生的零值，这个channel被关闭了或者为空。</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">x, ok := &lt;-ch</span><br><span class="line">x, ok = &lt;-ch</span><br><span class="line"><span class="keyword">var</span> x, ok = &lt;-ch</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">10</span>)</span><br><span class="line"><span class="built_in">close</span>(c)</span><br><span class="line">i, ok := &lt;-c</span><br><span class="line">fmt.Printf(<span class="string">"%d, %t"</span>, i, ok) <span class="comment">// 0, false</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">consume</span><span class="params">(queue <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> {</span><br><span class="line">    <span class="keyword">defer</span> wg.Done()</span><br><span class="line">    <span class="keyword">for</span> {</span><br><span class="line">        data, ok := &lt;-queue</span><br><span class="line">        fmt.Println(data, ok)</span><br><span class="line">        time.Sleep(time.Second)</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line">---</span><br><span class="line"><span class="number">1</span> <span class="literal">true</span></span><br><span class="line"><span class="number">2</span> <span class="literal">true</span></span><br><span class="line"><span class="number">0</span> <span class="literal">false</span></span><br><span class="line"><span class="number">0</span> <span class="literal">false</span></span><br><span class="line"><span class="number">0</span> <span class="literal">false</span></span><br><span class="line">...</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">consume</span><span class="params">(queue <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> {</span><br><span class="line">    <span class="keyword">defer</span> wg.Done()</span><br><span class="line">    <span class="keyword">for</span> {</span><br><span class="line">        data, ok := &lt;-queue</span><br><span class="line">        <span class="keyword">if</span> !ok {</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        }</span><br><span class="line">        fmt.Println(data)</span><br><span class="line">        time.Sleep(time.Second)</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">var</span> msg = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">1</span>)</span><br><span class="line">    msg &lt;- <span class="number">1</span></span><br><span class="line">    wg.Add(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">go</span> consume(msg)</span><br><span class="line">    msg &lt;- <span class="number">2</span></span><br><span class="line">    <span class="built_in">close</span>(msg)</span><br><span class="line">    wg.Wait()</span><br><span class="line">}</span><br><span class="line">---</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="无缓存空间"><a href="#无缓存空间" class="headerlink" title="无缓存空间"></a>无缓存空间</h3><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">channelWithCache</span><span class="params">()</span></span>  {</span><br><span class="line">    ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">        ch &lt;- <span class="string">"Hello, first msg from channel"</span></span><br><span class="line">        time.Sleep(time.Second)</span><br><span class="line">        ch &lt;- <span class="string">"Hello, second msg from channel"</span></span><br><span class="line">    }()</span><br><span class="line"></span><br><span class="line">    time.Sleep(<span class="number">2</span> * time.Second)</span><br><span class="line">    msg := &lt;- ch</span><br><span class="line">    fmt.Println(time.Now().String() + msg)</span><br><span class="line">    msg = &lt;- ch</span><br><span class="line">    fmt.Println(time.Now().String() + msg)</span><br><span class="line">    <span class="comment">// 因为前面我们先睡了2秒，所以其实会有一个已经在缓冲了</span></span><br><span class="line">    <span class="comment">// 当我们尝试输出的时候，这个输出间隔就会明显小于1秒</span></span><br><span class="line">    <span class="comment">// 我电脑上的几次实验，差距都在1ms以内</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">channelWithoutCache</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="comment">// 不带缓冲</span></span><br><span class="line">    ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">        time.Sleep(time.Second)</span><br><span class="line">        ch &lt;- <span class="string">"Hello, msg from channel"</span></span><br><span class="line">    }()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里比较容易写成 msg &lt;- ch，编译会报错</span></span><br><span class="line">    msg := &lt;- ch</span><br><span class="line">    fmt.Println(msg)</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    channelWithoutCache()</span><br><span class="line">    channelWithCache()</span><br><span class="line">    <span class="comment">// Hello, msg from channel</span></span><br><span class="line">    <span class="comment">// 2021-09-21 10:48:50.5593955 +0800 CST m=+3.023493701Hello, first msg from channel</span></span><br><span class="line">    <span class="comment">// 2021-09-21 10:48:50.5849771 +0800 CST m=+3.049075301Hello, second msg from channel</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">    Channel := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>, <span class="number">10</span>)</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ {</span><br><span class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(i <span class="keyword">int</span>)</span></span> {</span><br><span class="line">            fmt.Println(i)</span><br><span class="line">            time.Sleep(time.Second)</span><br><span class="line">            Channel &lt;- <span class="literal">true</span></span><br><span class="line">        }(i)</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">for</span> j := <span class="number">0</span>; j &lt; <span class="number">10</span>; j++ {</span><br><span class="line">        &lt;-Channel</span><br><span class="line">    }</span><br><span class="line">    <span class="built_in">close</span>(Channel)</span><br><span class="line">----</span><br><span class="line"><span class="number">9</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="number">7</span></span><br><span class="line"><span class="number">8</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">6</span></span><br><span class="line"><span class="number">5</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">    chan1 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>) <span class="comment">// 无缓存</span></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">        <span class="keyword">for</span> {</span><br><span class="line">            n := &lt;-chan1 <span class="comment">// 闭包，引用了chan1</span></span><br><span class="line">            fmt.Println(n)</span><br><span class="line">        }</span><br><span class="line">    }()</span><br><span class="line">    chan1 &lt;- <span class="number">1</span> <span class="comment">// 发送要放在接收协程跑起来后面，因为无缓存发送后会阻塞等待接收</span></span><br><span class="line">    chan1 &lt;- <span class="number">2</span></span><br><span class="line">    chan1 &lt;- <span class="number">3</span></span><br><span class="line">----</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line">没有打印<span class="number">3</span>，来不及打印主协程挂了</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">    chan1 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>) <span class="comment">// 无缓存</span></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">        <span class="keyword">for</span> {</span><br><span class="line">            n := &lt;-chan1 <span class="comment">// 闭包，引用了chan1</span></span><br><span class="line">            fmt.Println(n)</span><br><span class="line">        }</span><br><span class="line">    }()</span><br><span class="line">    chan1 &lt;- <span class="number">1</span> <span class="comment">// 发送要放在接收协程跑起来后面，因为无缓存发送后会阻塞等待接收</span></span><br><span class="line">    chan1 &lt;- <span class="number">2</span></span><br><span class="line">    chan1 &lt;- <span class="number">3</span></span><br><span class="line">    time.Sleep(time.Millisecond)</span><br><span class="line">----</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">worker</span><span class="params">(c <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> {</span><br><span class="line">    <span class="keyword">for</span> {</span><br><span class="line">        fmt.Println(&lt;-c) <span class="comment">// 不能写chan1 会undefined: chan1，worker函数用不了</span></span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    chan1 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>) <span class="comment">// 无缓存</span></span><br><span class="line">    <span class="keyword">go</span> worker(chan1)</span><br><span class="line">    chan1 &lt;- <span class="number">1</span> <span class="comment">// 发送要放在接收协程跑起来后面，因为无缓存发送后会阻塞等待接收</span></span><br><span class="line">    chan1 &lt;- <span class="number">2</span></span><br><span class="line">    chan1 &lt;- <span class="number">3</span></span><br><span class="line">    time.Sleep(time.Millisecond)</span><br><span class="line">}</span><br><span class="line">----</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">worker</span><span class="params">(id <span class="keyword">int</span>, c <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> {</span><br><span class="line">    <span class="keyword">for</span> {</span><br><span class="line">        fmt.Printf(<span class="string">"Worker %d received %d\n"</span>, id, &lt;-c)</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    chan1 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>) <span class="comment">// 无缓存</span></span><br><span class="line">    <span class="keyword">go</span> worker(<span class="number">0</span>, chan1)</span><br><span class="line">    chan1 &lt;- <span class="number">1</span> <span class="comment">// 发送要放在接收协程跑起来后面，因为无缓存发送后会阻塞等待接收</span></span><br><span class="line">    chan1 &lt;- <span class="number">2</span></span><br><span class="line">    chan1 &lt;- <span class="number">3</span></span><br><span class="line">    time.Sleep(time.Millisecond)</span><br><span class="line">}</span><br><span class="line">----</span><br><span class="line">Worker <span class="number">0</span> received <span class="number">1</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">2</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">3</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">worker</span><span class="params">(id <span class="keyword">int</span>, c <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> {</span><br><span class="line">    <span class="keyword">for</span> {</span><br><span class="line">        fmt.Printf(<span class="string">"Worker %d received %c\n"</span>, id, &lt;-c)</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">var</span> channels [<span class="number">10</span>]<span class="keyword">chan</span> <span class="keyword">int</span> <span class="comment">// 通道作为数组的类型</span></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ {</span><br><span class="line">        channels[i] = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>) <span class="comment">// 无缓存</span></span><br><span class="line">        <span class="keyword">go</span> worker(i, channels[i])</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ {</span><br><span class="line">        channels[i] &lt;- <span class="string">'a'</span> + i</span><br><span class="line">    }</span><br><span class="line">    time.Sleep(time.Millisecond)</span><br><span class="line">}</span><br><span class="line">----</span><br><span class="line">Worker <span class="number">0</span> received a</span><br><span class="line">Worker <span class="number">4</span> received e</span><br><span class="line">Worker <span class="number">1</span> received b</span><br><span class="line">Worker <span class="number">2</span> received c</span><br><span class="line">Worker <span class="number">3</span> received d</span><br><span class="line">Worker <span class="number">6</span> received g</span><br><span class="line">Worker <span class="number">5</span> received f</span><br><span class="line">Worker <span class="number">7</span> received h</span><br><span class="line">Worker <span class="number">8</span> received i</span><br><span class="line">Worker <span class="number">9</span> received j</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">worker</span><span class="params">(id <span class="keyword">int</span>, c <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> {</span><br><span class="line">    <span class="keyword">for</span> {</span><br><span class="line">        fmt.Printf(<span class="string">"Worker %d received %c\n"</span>, id, &lt;-c)</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">var</span> channels [<span class="number">10</span>]<span class="keyword">chan</span> <span class="keyword">int</span> <span class="comment">// 通道作为数组的类型</span></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ {</span><br><span class="line">        channels[i] = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>) <span class="comment">// 无缓存</span></span><br><span class="line">        <span class="keyword">go</span> worker(i, channels[i])</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ {</span><br><span class="line">        channels[i] &lt;- <span class="string">'a'</span> + i</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ {</span><br><span class="line">        channels[i] &lt;- <span class="string">'A'</span> + i</span><br><span class="line">    }</span><br><span class="line">    time.Sleep(time.Millisecond)</span><br><span class="line">}</span><br><span class="line">----</span><br><span class="line">Worker <span class="number">3</span> received d</span><br><span class="line">Worker <span class="number">2</span> received c</span><br><span class="line">Worker <span class="number">0</span> received a</span><br><span class="line">Worker <span class="number">0</span> received A</span><br><span class="line">Worker <span class="number">9</span> received j</span><br><span class="line">Worker <span class="number">4</span> received e</span><br><span class="line">Worker <span class="number">5</span> received f</span><br><span class="line">Worker <span class="number">6</span> received g</span><br><span class="line">Worker <span class="number">7</span> received h</span><br><span class="line">Worker <span class="number">8</span> received i</span><br><span class="line">Worker <span class="number">1</span> received b</span><br><span class="line">Worker <span class="number">1</span> received B</span><br><span class="line">Worker <span class="number">5</span> received F</span><br><span class="line">Worker <span class="number">2</span> received C</span><br><span class="line">Worker <span class="number">6</span> received G</span><br><span class="line">Worker <span class="number">7</span> received H</span><br><span class="line">Worker <span class="number">3</span> received D</span><br><span class="line">Worker <span class="number">4</span> received E</span><br><span class="line">Worker <span class="number">8</span> received I</span><br><span class="line">Worker <span class="number">9</span> received J</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">    chan1 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>) <span class="comment">// 无缓存</span></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">        <span class="keyword">for</span> d := <span class="keyword">range</span> chan1 {</span><br><span class="line">            fmt.Println(d)</span><br><span class="line">        }</span><br><span class="line">    }()</span><br><span class="line">    chan1 &lt;- <span class="number">1</span> <span class="comment">// 发送要放在接收协程跑起来后面，因为无缓存发送后会阻塞等待接收</span></span><br><span class="line">    chan1 &lt;- <span class="number">2</span></span><br><span class="line">    chan1 &lt;- <span class="number">3</span></span><br><span class="line">    <span class="built_in">close</span>(chan1)</span><br><span class="line">---</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">createWorker</span><span class="params">(id <span class="keyword">int</span>)</span> <span class="title">chan</span> <span class="title">int</span></span> { <span class="comment">// 双向通道作为函数返回值</span></span><br><span class="line">    c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> { <span class="comment">// 协程里面处理通道，不然worker函数会没返回通道，新协程会阻塞</span></span><br><span class="line">        <span class="keyword">for</span> {</span><br><span class="line">            fmt.Printf(<span class="string">"Worker %d received %c\n"</span>, id, &lt;-c)</span><br><span class="line">        }</span><br><span class="line">    }()</span><br><span class="line">    <span class="keyword">return</span> c</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">var</span> channels [<span class="number">10</span>]<span class="keyword">chan</span> <span class="keyword">int</span> <span class="comment">// 通道作为数组的类型</span></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ {</span><br><span class="line">        channels[i] = createWorker(i)</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ {</span><br><span class="line">        channels[i] &lt;- <span class="string">'a'</span> + i</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ {</span><br><span class="line">        channels[i] &lt;- <span class="string">'A'</span> + i</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    time.Sleep(time.Millisecond)</span><br><span class="line">}</span><br><span class="line">---</span><br><span class="line">Worker <span class="number">6</span> received g</span><br><span class="line">Worker <span class="number">7</span> received h</span><br><span class="line">Worker <span class="number">8</span> received i</span><br><span class="line">Worker <span class="number">5</span> received f</span><br><span class="line">Worker <span class="number">2</span> received c</span><br><span class="line">Worker <span class="number">9</span> received j</span><br><span class="line">Worker <span class="number">0</span> received a</span><br><span class="line">Worker <span class="number">0</span> received A</span><br><span class="line">Worker <span class="number">4</span> received e</span><br><span class="line">Worker <span class="number">3</span> received d</span><br><span class="line">Worker <span class="number">1</span> received b</span><br><span class="line">Worker <span class="number">1</span> received B</span><br><span class="line">Worker <span class="number">9</span> received J</span><br><span class="line">Worker <span class="number">2</span> received C</span><br><span class="line">Worker <span class="number">3</span> received D</span><br><span class="line">Worker <span class="number">4</span> received E</span><br><span class="line">Worker <span class="number">5</span> received F</span><br><span class="line">Worker <span class="number">6</span> received G</span><br><span class="line">Worker <span class="number">7</span> received H</span><br><span class="line">Worker <span class="number">8</span> received I</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">worker</span><span class="params">(id <span class="keyword">int</span>, c <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> {</span><br><span class="line">    <span class="keyword">for</span> {</span><br><span class="line">        fmt.Printf(<span class="string">"Worker %d received %c\n"</span>,id, &lt;-c)</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">bufferedChannel</span><span class="params">()</span></span> {</span><br><span class="line">    c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">3</span>) <span class="comment">// 有缓存</span></span><br><span class="line">    <span class="keyword">go</span> worker(<span class="number">0</span>, c)</span><br><span class="line">    c &lt;- <span class="string">'a'</span></span><br><span class="line">    c &lt;- <span class="string">'b'</span></span><br><span class="line">    c &lt;- <span class="string">'c'</span></span><br><span class="line">    c &lt;- <span class="string">'d'</span></span><br><span class="line">    time.Sleep(time.Millisecond)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    bufferedChannel()</span><br><span class="line">}</span><br><span class="line">----</span><br><span class="line">Worker <span class="number">0</span> received a</span><br><span class="line">Worker <span class="number">0</span> received b</span><br><span class="line">Worker <span class="number">0</span> received c</span><br><span class="line">Worker <span class="number">0</span> received d</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">worker</span><span class="params">(id <span class="keyword">int</span>, c <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> {</span><br><span class="line">    <span class="keyword">for</span> n := <span class="keyword">range</span> c {</span><br><span class="line">        fmt.Printf(<span class="string">"Worker %d received %c\n"</span>, id, n)</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">bufferedChannel</span><span class="params">()</span></span> {</span><br><span class="line">    c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">3</span>)</span><br><span class="line">    <span class="keyword">go</span> worker(<span class="number">0</span>, c)</span><br><span class="line">    c &lt;- <span class="string">'a'</span></span><br><span class="line">    c &lt;- <span class="string">'b'</span></span><br><span class="line">    c &lt;- <span class="string">'c'</span></span><br><span class="line">    c &lt;- <span class="string">'d'</span></span><br><span class="line">    time.Sleep(time.Millisecond)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    bufferedChannel()</span><br><span class="line">}</span><br><span class="line">----</span><br><span class="line">Worker <span class="number">0</span> received a</span><br><span class="line">Worker <span class="number">0</span> received b</span><br><span class="line">Worker <span class="number">0</span> received c</span><br><span class="line">Worker <span class="number">0</span> received d</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">worker</span><span class="params">(id <span class="keyword">int</span>, c <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> {</span><br><span class="line">    <span class="keyword">for</span> {</span><br><span class="line">        fmt.Printf(<span class="string">"Worker %d received %d\n"</span>, id, &lt;-c)</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">channelClose</span><span class="params">()</span></span> {</span><br><span class="line">    c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line">    <span class="keyword">go</span> worker(<span class="number">0</span>, c)</span><br><span class="line">    c &lt;- <span class="string">'a'</span></span><br><span class="line">    c &lt;- <span class="string">'b'</span></span><br><span class="line">    c &lt;- <span class="string">'c'</span></span><br><span class="line">    c &lt;- <span class="string">'d'</span></span><br><span class="line">    <span class="built_in">close</span>(c)</span><br><span class="line">    time.Sleep(time.Millisecond)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    channelClose()</span><br><span class="line">}</span><br><span class="line">----</span><br><span class="line">Worker <span class="number">0</span> received <span class="number">97</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">98</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">99</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">100</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">0</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">0</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">0</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">0</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">0</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">0</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">0</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">0</span></span><br><span class="line">...</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">worker</span><span class="params">(id <span class="keyword">int</span>, c <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> {</span><br><span class="line">    <span class="keyword">for</span> {</span><br><span class="line">        n, ok := &lt;-c</span><br><span class="line">        <span class="keyword">if</span> !ok {</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        }</span><br><span class="line">        fmt.Printf(<span class="string">"Worker %d received %d\n"</span>, id, n)</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">channelClose</span><span class="params">()</span></span> {</span><br><span class="line">    c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line">    <span class="keyword">go</span> worker(<span class="number">0</span>, c)</span><br><span class="line">    c &lt;- <span class="string">'a'</span></span><br><span class="line">    c &lt;- <span class="string">'b'</span></span><br><span class="line">    c &lt;- <span class="string">'c'</span></span><br><span class="line">    c &lt;- <span class="string">'d'</span></span><br><span class="line">    <span class="built_in">close</span>(c)</span><br><span class="line">    time.Sleep(time.Millisecond)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    channelClose()</span><br><span class="line">}</span><br><span class="line">----</span><br><span class="line">Worker <span class="number">0</span> received <span class="number">97</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">98</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">99</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">100</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">worker</span><span class="params">(id <span class="keyword">int</span>, c <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> {</span><br><span class="line">    <span class="keyword">for</span> n := <span class="keyword">range</span> c {</span><br><span class="line">        fmt.Printf(<span class="string">"Worker %d received %c\n"</span>, id, n)</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">channelClose</span><span class="params">()</span></span> {</span><br><span class="line">    c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line">    <span class="keyword">go</span> worker(<span class="number">0</span>, c)</span><br><span class="line">    c &lt;- <span class="string">'a'</span></span><br><span class="line">    c &lt;- <span class="string">'b'</span></span><br><span class="line">    c &lt;- <span class="string">'c'</span></span><br><span class="line">    c &lt;- <span class="string">'d'</span></span><br><span class="line">    <span class="built_in">close</span>(c)</span><br><span class="line">    time.Sleep(time.Millisecond)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    channelClose()</span><br><span class="line">}</span><br><span class="line">----</span><br><span class="line">Worker <span class="number">0</span> received <span class="number">97</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">98</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">99</span></span><br><span class="line">Worker <span class="number">0</span> received <span class="number">100</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">var</span> msg = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>) <span class="comment">// 无缓存</span></span><br><span class="line">    wg.Add(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">go</span> consume(msg)</span><br><span class="line">    msg &lt;- <span class="number">1</span> <span class="comment">// 发送要放在接收协程跑起来后面，因为无缓存发送后会阻塞等待接收</span></span><br><span class="line">    wg.Wait()</span><br><span class="line">----</span><br><span class="line"><span class="number">1</span></span><br><span class="line">fatal error: all goroutines are asleep - deadlock! 不关闭通道consume遍历空通道阻塞</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">var</span> msg = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line">    wg.Add(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">go</span> consume(msg)</span><br><span class="line">    msg &lt;- <span class="number">1</span> <span class="comment">// 发送要放在接收协程跑起来后面，因为无缓存发送后会阻塞等待接收</span></span><br><span class="line">    <span class="built_in">close</span>(msg)</span><br><span class="line">    wg.Wait()</span><br><span class="line">}</span><br><span class="line">----</span><br><span class="line"><span class="number">1</span></span><br></pre></td></tr></tbody></table></figure>

<p>如官方的例子中通过两个 goroutine 来计算数字之和，在 goroutine 完成计算后，它会计算两个结果的和</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sum</span><span class="params">(s []<span class="keyword">int</span>, c <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> {</span><br><span class="line">    sum := <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> _, v := <span class="keyword">range</span> s {</span><br><span class="line">        sum += v</span><br><span class="line">    }</span><br><span class="line">    c &lt;- sum <span class="comment">// send sum to c 把 sum 发送到通道 c</span></span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    s := []<span class="keyword">int</span>{<span class="number">7</span>, <span class="number">2</span>, <span class="number">8</span>, <span class="number">-9</span>, <span class="number">4</span>, <span class="number">0</span>}</span><br><span class="line">    c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line">    <span class="keyword">go</span> sum(s[:<span class="built_in">len</span>(s)/<span class="number">2</span>], c)</span><br><span class="line">    <span class="keyword">go</span> sum(s[<span class="built_in">len</span>(s)/<span class="number">2</span>:], c)</span><br><span class="line">    x, y := &lt;-c, &lt;-c <span class="comment">// receive from c 从通道 c 中接收 一直处于阻塞状态，直至计算结果发送到channel中。</span></span><br><span class="line">    fmt.Println(x, y, x+y) <span class="comment">// -5 17 12</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="同步"><a href="#同步" class="headerlink" title="同步"></a>同步</h3><p>channel可以用在goroutine之间的同步。<br>下面的例子中main goroutine通过done channel等待worker完成任务。<br>worker做完任务后只需往channel发送一个数据就可以通知main goroutine任务完成。</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">worker</span><span class="params">(done <span class="keyword">chan</span> <span class="keyword">bool</span>)</span></span> {</span><br><span class="line">    time.Sleep(time.Second)</span><br><span class="line">    <span class="comment">// 通知任务已完成</span></span><br><span class="line">    done &lt;- <span class="literal">true</span></span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    done := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">go</span> worker(done)</span><br><span class="line">    <span class="comment">// 等待任务完成</span></span><br><span class="line">    &lt;-done</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="通道写安全"><a href="#通道写安全" class="headerlink" title="通道写安全"></a>通道写安全</h4><p>上面提到向一个已经关闭的通道执行写操作会抛出异常，这意味着我们在写通道时一定要确保通道没有被关闭。</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">send</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> {</span><br><span class="line">    i := <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> {</span><br><span class="line">        i++</span><br><span class="line">        ch &lt;- i</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">recv</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> {</span><br><span class="line">    value := &lt;-ch</span><br><span class="line">    fmt.Println(value)</span><br><span class="line">    value = &lt;-ch</span><br><span class="line">    fmt.Println(value)</span><br><span class="line">    <span class="built_in">close</span>(ch)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">var</span> ch = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">4</span>)</span><br><span class="line">    <span class="keyword">go</span> recv(ch)</span><br><span class="line">    send(ch)</span><br><span class="line">}</span><br><span class="line">---------</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="built_in">panic</span>: send on closed channel</span><br></pre></td></tr></tbody></table></figure>

<p>那如何确保呢？Go 语言并不存在一个内置函数可以判断出通道是否已经被关闭。即使存在这样一个函数，当你判断时通道没有关闭，并不意味着当你往通道里写数据时它就一定没有被关闭，并发环境下，它是可能被其它协程随时关闭的。</p>
<p>确保通道写安全的最好方式是由负责写通道的协程自己来关闭通道，读通道的协程不要去关闭通道。</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">send</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> {</span><br><span class="line">    ch &lt;- <span class="number">1</span></span><br><span class="line">    ch &lt;- <span class="number">2</span></span><br><span class="line">    ch &lt;- <span class="number">3</span></span><br><span class="line">    ch &lt;- <span class="number">4</span></span><br><span class="line">    <span class="built_in">close</span>(ch)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">recv</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> {</span><br><span class="line">    <span class="keyword">for</span> v := <span class="keyword">range</span> ch {</span><br><span class="line">        fmt.Println(v)</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">var</span> ch = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">go</span> send(ch)</span><br><span class="line">    recv(ch)</span><br><span class="line">}</span><br><span class="line">---</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">4</span></span><br></pre></td></tr></tbody></table></figure>

<p>这个方法确实可以解决单写多读的场景，可要是遇上了多写单读的场合该怎么办呢？任意一个读写通道的协程都不可以随意关闭通道，否则会导致其它写通道协程抛出异常。这时候就必须让其它不相干的协程来干这件事，这个协程需要等待所有的写通道协程都结束运行后才能关闭通道。那其它协程要如何才能知道所有的写通道已经结束运行了呢？这个就需要使用到内置 <code>sync</code> 包提供的 <code>WaitGroup</code> 对象，它使用计数来等待指定事件完成。</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"time"</span></span><br><span class="line">    <span class="string">"sync"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">send</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">int</span>, wg *sync.WaitGroup)</span></span> {</span><br><span class="line">    <span class="keyword">defer</span> wg.Done() <span class="comment">// 计数值减一</span></span><br><span class="line">    i := <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i &lt; <span class="number">4</span> {</span><br><span class="line">        i++</span><br><span class="line">        ch &lt;- i</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">recv</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> {</span><br><span class="line">    <span class="keyword">for</span> v := <span class="keyword">range</span> ch {</span><br><span class="line">        fmt.Println(v)</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">var</span> ch = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">4</span>)</span><br><span class="line">    <span class="keyword">var</span> wg = <span class="built_in">new</span>(sync.WaitGroup)</span><br><span class="line">    wg.Add(<span class="number">2</span>)       <span class="comment">// 增加计数值</span></span><br><span class="line">    <span class="keyword">go</span> send(ch, wg) <span class="comment">// 写</span></span><br><span class="line">    <span class="keyword">go</span> send(ch, wg) <span class="comment">// 写</span></span><br><span class="line">    <span class="keyword">go</span> recv(ch)</span><br><span class="line">    <span class="comment">// Wait() 阻塞等待所有的写通道协程结束，待计数值变成零，Wait() 才会返回</span></span><br><span class="line">    wg.Wait()</span><br><span class="line">    <span class="comment">// 关闭通道</span></span><br><span class="line">    <span class="built_in">close</span>(ch)</span><br><span class="line">    time.Sleep(time.Second)</span><br><span class="line">}</span><br><span class="line">----</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">4</span></span><br></pre></td></tr></tbody></table></figure>


<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"sync"</span></span><br><span class="line">    <span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">var</span> msg = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line">    wg.Add(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">go</span> consume(msg)</span><br><span class="line">    msg &lt;- <span class="number">1</span></span><br><span class="line">    fmt.Println(<span class="string">"等待返回值"</span>)</span><br><span class="line">    fmt.Println(&lt;-msg)</span><br><span class="line">    <span class="built_in">close</span>(msg)</span><br><span class="line">    wg.Wait()</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">consume</span><span class="params">(queue <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> {</span><br><span class="line">    <span class="keyword">defer</span> wg.Done()</span><br><span class="line">    <span class="keyword">for</span> {</span><br><span class="line">        data, ok := &lt;-queue</span><br><span class="line">        <span class="keyword">if</span> !ok {</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        }</span><br><span class="line">        fmt.Println(data)</span><br><span class="line">        time.Sleep(time.Second)</span><br><span class="line">        queue &lt;- <span class="number">2</span></span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line">---</span><br><span class="line"><span class="number">1</span></span><br><span class="line">等待返回值</span><br><span class="line"><span class="number">2</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"sync"</span></span><br><span class="line">    <span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">var</span> msg = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">10</span>)</span><br><span class="line">    wg.Add(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">go</span> consume(msg) <span class="comment">// 双向的通道可以转换为单向的通道</span></span><br><span class="line">    msg &lt;- <span class="number">1</span></span><br><span class="line">    <span class="built_in">close</span>(msg)</span><br><span class="line">    wg.Wait()</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">consume</span><span class="params">(queue &lt;-<span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> {</span><br><span class="line">    <span class="keyword">defer</span> wg.Done()</span><br><span class="line">    <span class="keyword">for</span> {</span><br><span class="line">        data, ok := &lt;-queue</span><br><span class="line">        <span class="keyword">if</span> !ok {</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        }</span><br><span class="line">        fmt.Println(data)</span><br><span class="line">        time.Sleep(time.Second)</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line">----</span><br><span class="line"><span class="number">1</span></span><br></pre></td></tr></tbody></table></figure>


<h4 id="使用Channel等待任务结束"><a href="#使用Channel等待任务结束" class="headerlink" title="使用Channel等待任务结束"></a>使用Channel等待任务结束</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">type</span> worker <span class="keyword">struct</span> {</span><br><span class="line">    in   <span class="keyword">chan</span> <span class="keyword">int</span></span><br><span class="line">    done <span class="keyword">chan</span> <span class="keyword">bool</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">doWork</span><span class="params">(id <span class="keyword">int</span>, c <span class="keyword">chan</span> <span class="keyword">int</span>, done <span class="keyword">chan</span> <span class="keyword">bool</span>)</span></span> {</span><br><span class="line">    <span class="keyword">for</span> n := <span class="keyword">range</span> c {</span><br><span class="line">        fmt.Printf(<span class="string">"Worker %d received %c\n"</span>, id, n)</span><br><span class="line">        done &lt;- <span class="literal">true</span></span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">createWorker</span><span class="params">(id <span class="keyword">int</span>)</span> <span class="title">worker</span></span> {</span><br><span class="line">    w := worker{</span><br><span class="line">        in: <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>), <span class="comment">// 无缓存</span></span><br><span class="line">        done: <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>), <span class="comment">// 无缓存</span></span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">go</span> doWork(id, w.in, w.done)</span><br><span class="line">    <span class="keyword">return</span> w</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">chanDemo</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">var</span> workers [<span class="number">10</span>]worker</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ {</span><br><span class="line">        workers[i] = createWorker(i)</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ {</span><br><span class="line">        workers[i].in &lt;- <span class="string">'a'</span> + i</span><br><span class="line">        &lt;- workers[i].done <span class="comment">// 如果done没有数据 这里会阻塞</span></span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ {</span><br><span class="line">        workers[i].in &lt;- <span class="string">'A'</span> + i</span><br><span class="line">        &lt;- workers[i].done <span class="comment">// 如果done没有数据 这里会阻塞</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    time.Sleep(time.Millisecond) <span class="comment">// 去掉sleep</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    chanDemo()</span><br><span class="line">}</span><br><span class="line">----</span><br><span class="line">Worker <span class="number">0</span> received a</span><br><span class="line">Worker <span class="number">1</span> received b</span><br><span class="line">Worker <span class="number">2</span> received c</span><br><span class="line">Worker <span class="number">3</span> received d</span><br><span class="line">Worker <span class="number">4</span> received e</span><br><span class="line">Worker <span class="number">5</span> received f</span><br><span class="line">Worker <span class="number">6</span> received g</span><br><span class="line">Worker <span class="number">7</span> received h</span><br><span class="line">Worker <span class="number">8</span> received i</span><br><span class="line">Worker <span class="number">9</span> received j</span><br><span class="line">Worker <span class="number">0</span> received A</span><br><span class="line">Worker <span class="number">1</span> received B</span><br><span class="line">Worker <span class="number">2</span> received C</span><br><span class="line">Worker <span class="number">3</span> received D</span><br><span class="line">Worker <span class="number">4</span> received E</span><br><span class="line">Worker <span class="number">5</span> received F</span><br><span class="line">Worker <span class="number">6</span> received G</span><br><span class="line">Worker <span class="number">7</span> received H</span><br><span class="line">Worker <span class="number">8</span> received I</span><br><span class="line">Worker <span class="number">9</span> received J</span><br></pre></td></tr></tbody></table></figure>

<p>缺点：顺序打印，不如不用</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> worker <span class="keyword">struct</span> {</span><br><span class="line">    in   <span class="keyword">chan</span> <span class="keyword">int</span></span><br><span class="line">    done <span class="keyword">chan</span> <span class="keyword">bool</span> <span class="comment">// done用于接收，这样来替换 time.Sleep(time.Millisecond)</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">doWork</span><span class="params">(id <span class="keyword">int</span>, c <span class="keyword">chan</span> <span class="keyword">int</span>, done <span class="keyword">chan</span> <span class="keyword">bool</span>)</span></span> {</span><br><span class="line">    <span class="keyword">for</span> n := <span class="keyword">range</span> c {</span><br><span class="line">        fmt.Printf(<span class="string">"Worker %d received %c\n"</span>, id, n)</span><br><span class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">            done &lt;- <span class="literal">true</span></span><br><span class="line">        }()</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">createWorker</span><span class="params">(id <span class="keyword">int</span>)</span> <span class="title">worker</span></span> {</span><br><span class="line">    w := worker{</span><br><span class="line">        in: <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>), <span class="comment">// 无缓存</span></span><br><span class="line">        done: <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>), <span class="comment">// 无缓存</span></span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">go</span> doWork(id, w.in, w.done)</span><br><span class="line">    <span class="keyword">return</span> w</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">chanDemo</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">var</span> workers [<span class="number">10</span>]worker</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ {</span><br><span class="line">        workers[i] = createWorker(i)</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i, worker := <span class="keyword">range</span> workers {</span><br><span class="line">        worker.in &lt;- <span class="string">'a'</span> + i</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">for</span> i, worker := <span class="keyword">range</span> workers {</span><br><span class="line">        worker.in &lt;- <span class="string">'A'</span> + i</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">for</span> _, worker := <span class="keyword">range</span> workers {</span><br><span class="line">        &lt;-worker.done</span><br><span class="line">        &lt;-worker.done</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// time.Sleep(time.Millisecond) // 去掉sleep</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    chanDemo()</span><br><span class="line">}</span><br><span class="line">----</span><br><span class="line">Worker <span class="number">5</span> received f</span><br><span class="line">Worker <span class="number">0</span> received a</span><br><span class="line">Worker <span class="number">2</span> received c</span><br><span class="line">Worker <span class="number">1</span> received b</span><br><span class="line">Worker <span class="number">3</span> received d</span><br><span class="line">Worker <span class="number">4</span> received e</span><br><span class="line">Worker <span class="number">8</span> received i</span><br><span class="line">Worker <span class="number">6</span> received g</span><br><span class="line">Worker <span class="number">6</span> received G</span><br><span class="line">Worker <span class="number">7</span> received h</span><br><span class="line">Worker <span class="number">9</span> received j</span><br><span class="line">Worker <span class="number">2</span> received C</span><br><span class="line">Worker <span class="number">9</span> received J</span><br><span class="line">Worker <span class="number">0</span> received A</span><br><span class="line">Worker <span class="number">1</span> received B</span><br><span class="line">Worker <span class="number">8</span> received I</span><br><span class="line">Worker <span class="number">5</span> received F</span><br><span class="line">Worker <span class="number">7</span> received H</span><br><span class="line">Worker <span class="number">3</span> received D</span><br><span class="line">Worker <span class="number">4</span> received E</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="comment">// "time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> worker <span class="keyword">struct</span> {</span><br><span class="line">    in   <span class="keyword">chan</span> <span class="keyword">int</span></span><br><span class="line">    done <span class="keyword">chan</span> <span class="keyword">bool</span></span><br><span class="line">    <span class="comment">// done func()</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">doWork</span><span class="params">(id <span class="keyword">int</span>, c <span class="keyword">chan</span> <span class="keyword">int</span>, done <span class="keyword">chan</span> <span class="keyword">bool</span>)</span></span> {</span><br><span class="line">    <span class="keyword">for</span> n := <span class="keyword">range</span> c {</span><br><span class="line">        fmt.Printf(<span class="string">"Worker %d received %c\n"</span>, id, n)</span><br><span class="line">        done &lt;- <span class="literal">true</span></span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">createWorker</span><span class="params">(id <span class="keyword">int</span>)</span> <span class="title">worker</span></span> {</span><br><span class="line">    w := worker{</span><br><span class="line">        in: <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>), <span class="comment">// 无缓存</span></span><br><span class="line">        done: <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>), <span class="comment">// 无缓存</span></span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">go</span> doWork(id, w.in, w.done)</span><br><span class="line">    <span class="keyword">return</span> w</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">chanDemo</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">var</span> workers [<span class="number">10</span>]worker</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ {</span><br><span class="line">        workers[i] = createWorker(i)</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i, worker := <span class="keyword">range</span> workers {</span><br><span class="line">        worker.in &lt;- <span class="string">'a'</span> + i</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">for</span> _, worker := <span class="keyword">range</span> workers {</span><br><span class="line">        &lt;-worker.done</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">for</span> i, worker := <span class="keyword">range</span> workers {</span><br><span class="line">        worker.in &lt;- <span class="string">'A'</span> + i</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">for</span> _, worker := <span class="keyword">range</span> workers {</span><br><span class="line">        &lt;-worker.done</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// time.Sleep(time.Millisecond) // 去掉sleep</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    chanDemo()</span><br><span class="line">}</span><br><span class="line">----</span><br><span class="line">Worker <span class="number">6</span> received g</span><br><span class="line">Worker <span class="number">1</span> received b</span><br><span class="line">Worker <span class="number">7</span> received h</span><br><span class="line">Worker <span class="number">0</span> received a</span><br><span class="line">Worker <span class="number">4</span> received e</span><br><span class="line">Worker <span class="number">9</span> received j</span><br><span class="line">Worker <span class="number">5</span> received f</span><br><span class="line">Worker <span class="number">8</span> received i</span><br><span class="line">Worker <span class="number">2</span> received c</span><br><span class="line">Worker <span class="number">3</span> received d</span><br><span class="line">Worker <span class="number">3</span> received D</span><br><span class="line">Worker <span class="number">4</span> received E</span><br><span class="line">Worker <span class="number">5</span> received F</span><br><span class="line">Worker <span class="number">6</span> received G</span><br><span class="line">Worker <span class="number">7</span> received H</span><br><span class="line">Worker <span class="number">8</span> received I</span><br><span class="line">Worker <span class="number">9</span> received J</span><br><span class="line">Worker <span class="number">0</span> received A</span><br><span class="line">Worker <span class="number">1</span> received B</span><br><span class="line">Worker <span class="number">2</span> received C</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"sync"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> worker <span class="keyword">struct</span> {</span><br><span class="line">    in   <span class="keyword">chan</span> <span class="keyword">int</span></span><br><span class="line">    <span class="comment">// done chan bool</span></span><br><span class="line">    wg *sync.WaitGroup <span class="comment">// 指针才能使用同一个wg</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">doWork</span><span class="params">(id <span class="keyword">int</span>, c <span class="keyword">chan</span> <span class="keyword">int</span>, wg *sync.WaitGroup)</span></span> {</span><br><span class="line">    <span class="keyword">for</span> n := <span class="keyword">range</span> c {</span><br><span class="line">        fmt.Printf(<span class="string">"Worker %d received %c\n"</span>, id, n)</span><br><span class="line">        wg.Done()</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">createWorker</span><span class="params">(id <span class="keyword">int</span>, wg *sync.WaitGroup)</span> <span class="title">worker</span></span> {</span><br><span class="line">    w := worker{</span><br><span class="line">        in: <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>), <span class="comment">// 无缓存</span></span><br><span class="line">        wg: wg, <span class="comment">// 无缓存</span></span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">go</span> doWork(id, w.in, wg)</span><br><span class="line">    <span class="keyword">return</span> w</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">chanDemo</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> workers [<span class="number">10</span>]worker</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ {</span><br><span class="line">        workers[i] = createWorker(i, &amp;wg) <span class="comment">// 所有的要用同一个wg 所以传指针</span></span><br><span class="line">    }</span><br><span class="line">    wg.Add(<span class="number">20</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i, worker := <span class="keyword">range</span> workers {</span><br><span class="line">        worker.in &lt;- <span class="string">'a'</span> + i</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">for</span> i, worker := <span class="keyword">range</span> workers {</span><br><span class="line">        worker.in &lt;- <span class="string">'A'</span> + i</span><br><span class="line">    }</span><br><span class="line">    wg.Wait()</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    chanDemo()</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">----</span><br><span class="line">Worker <span class="number">6</span> received g</span><br><span class="line">Worker <span class="number">1</span> received b</span><br><span class="line">Worker <span class="number">0</span> received a</span><br><span class="line">Worker <span class="number">3</span> received d</span><br><span class="line">Worker <span class="number">2</span> received c</span><br><span class="line">Worker <span class="number">4</span> received e</span><br><span class="line">Worker <span class="number">3</span> received D</span><br><span class="line">Worker <span class="number">4</span> received E</span><br><span class="line">Worker <span class="number">8</span> received i</span><br><span class="line">Worker <span class="number">7</span> received h</span><br><span class="line">Worker <span class="number">0</span> received A</span><br><span class="line">Worker <span class="number">1</span> received B</span><br><span class="line">Worker <span class="number">2</span> received C</span><br><span class="line">Worker <span class="number">9</span> received j</span><br><span class="line">Worker <span class="number">5</span> received f</span><br><span class="line">Worker <span class="number">5</span> received F</span><br><span class="line">Worker <span class="number">9</span> received J</span><br><span class="line">Worker <span class="number">6</span> received G</span><br><span class="line">Worker <span class="number">8</span> received I</span><br><span class="line">Worker <span class="number">7</span> received H</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"sync"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">doWork</span><span class="params">(id <span class="keyword">int</span>, w worker)</span></span> {</span><br><span class="line">    <span class="keyword">for</span> n := <span class="keyword">range</span> w.in {</span><br><span class="line">        fmt.Printf(<span class="string">"Worker %d received %c\n"</span>, id, n)</span><br><span class="line">        w.done()</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> worker <span class="keyword">struct</span> {</span><br><span class="line">    in   <span class="keyword">chan</span> <span class="keyword">int</span></span><br><span class="line">    done <span class="function"><span class="keyword">func</span><span class="params">()</span></span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">createWorker</span><span class="params">(id <span class="keyword">int</span>, wg *sync.WaitGroup)</span> <span class="title">worker</span></span> {</span><br><span class="line">    w := worker{</span><br><span class="line">        in: <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>),</span><br><span class="line">        done: <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">            wg.Done()</span><br><span class="line">        },</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">go</span> doWork(id, w)</span><br><span class="line">    <span class="keyword">return</span> w</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">chanDemo</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> workers [<span class="number">10</span>]worker</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ {</span><br><span class="line">        workers[i] = createWorker(i, &amp;wg)</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    wg.Add(<span class="number">20</span>)</span><br><span class="line">    <span class="keyword">for</span> i, worker := <span class="keyword">range</span> workers {</span><br><span class="line">        worker.in &lt;- <span class="string">'a'</span> + i</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">for</span> i, worker := <span class="keyword">range</span> workers {</span><br><span class="line">        worker.in &lt;- <span class="string">'A'</span> + i</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    wg.Wait()</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    chanDemo()</span><br><span class="line">}</span><br><span class="line">----</span><br><span class="line">Worker <span class="number">7</span> received h</span><br><span class="line">Worker <span class="number">3</span> received d</span><br><span class="line">Worker <span class="number">4</span> received e</span><br><span class="line">Worker <span class="number">2</span> received c</span><br><span class="line">Worker <span class="number">1</span> received b</span><br><span class="line">Worker <span class="number">6</span> received g</span><br><span class="line">Worker <span class="number">8</span> received i</span><br><span class="line">Worker <span class="number">9</span> received j</span><br><span class="line">Worker <span class="number">0</span> received a</span><br><span class="line">Worker <span class="number">0</span> received A</span><br><span class="line">Worker <span class="number">4</span> received E</span><br><span class="line">Worker <span class="number">5</span> received f</span><br><span class="line">Worker <span class="number">5</span> received F</span><br><span class="line">Worker <span class="number">9</span> received J</span><br><span class="line">Worker <span class="number">1</span> received B</span><br><span class="line">Worker <span class="number">2</span> received C</span><br><span class="line">Worker <span class="number">3</span> received D</span><br><span class="line">Worker <span class="number">6</span> received G</span><br><span class="line">Worker <span class="number">7</span> received H</span><br><span class="line">Worker <span class="number">8</span> received I</span><br></pre></td></tr></tbody></table></figure>

<p>通道内部结构<br>Go 语言的通道内部结构是一个循环数组，通过读写偏移量来控制元素发送和接受。它为了保证线程安全，内部会有一个全局锁来控制并发。对于发送和接受操作都会有一个队列来容纳处于阻塞状态的协程。</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> hchan <span class="keyword">struct</span> {</span><br><span class="line">    qcount <span class="keyword">uint</span>  <span class="comment">// 通道有效元素个数</span></span><br><span class="line">    dataqsize <span class="keyword">uint</span>   <span class="comment">// 通道容量，循环数组总长度</span></span><br><span class="line">    buf unsafe.Pointer <span class="comment">// 数组地址</span></span><br><span class="line">    elemsize <span class="keyword">uint16</span> <span class="comment">// 内部元素的大小</span></span><br><span class="line">    closed <span class="keyword">uint32</span> <span class="comment">// 是否已关闭 0或者1</span></span><br><span class="line">    elemtype *_type <span class="comment">// 内部元素类型信息</span></span><br><span class="line">    sendx <span class="keyword">uint</span> <span class="comment">// 循环数组的写偏移量</span></span><br><span class="line">    recvx <span class="keyword">uint</span> <span class="comment">// 循环数组的读偏移量</span></span><br><span class="line">    recvq waitq <span class="comment">// 阻塞在读操作上的协程队列</span></span><br><span class="line">    sendq waitq <span class="comment">// 阻塞在写操作上的协程队列</span></span><br><span class="line"></span><br><span class="line">    lock mutex <span class="comment">// 全局锁</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>队列在本质上是使用共享变量加锁的方式来实现的，共享变量才是并行交流的本质。</p>
<p>请不要认为 Go 语言的通道很神奇，Go 语言只是对通道设计了一套便于使用的语法糖，让这套数据结构显的平易近人。它在内部实现上和其它语言的并发队列大同小异。</p>
<hr>
<h3 id="并发编程模式"><a href="#并发编程模式" class="headerlink" title="并发编程模式"></a>并发编程模式</h3><h4 id="生成器"><a href="#生成器" class="headerlink" title="生成器"></a>生成器</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"math/rand"</span></span><br><span class="line">    <span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">msgGen</span><span class="params">()</span> <span class="title">chan</span> <span class="title">string</span></span> {</span><br><span class="line">    c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">        i := <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> {</span><br><span class="line">            time.Sleep(time.Duration(rand.Intn(<span class="number">2000</span>)) * time.Millisecond)</span><br><span class="line">            <span class="comment">// Sprintf 不会打印，把想要打印的结果作为一个字符串返回</span></span><br><span class="line">            c &lt;- fmt.Sprintf(<span class="string">"message %d"</span>, i)</span><br><span class="line">            i++</span><br><span class="line">        }</span><br><span class="line">    }()</span><br><span class="line">    <span class="keyword">return</span> c</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    m := msgGen()</span><br><span class="line">    <span class="keyword">for</span> {</span><br><span class="line">        fmt.Println(&lt;-m)</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line">----</span><br><span class="line">message <span class="number">0</span></span><br><span class="line">message <span class="number">1</span></span><br><span class="line">message <span class="number">2</span></span><br><span class="line">message <span class="number">3</span></span><br><span class="line">message <span class="number">4</span></span><br><span class="line">message <span class="number">5</span></span><br><span class="line">message <span class="number">6</span></span><br><span class="line">...</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"math/rand"</span></span><br><span class="line">    <span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">msgGen</span><span class="params">()</span> <span class="title">chan</span> <span class="title">string</span></span> {</span><br><span class="line">    c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">        i := <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> {</span><br><span class="line">            time.Sleep(time.Duration(rand.Intn(<span class="number">2000</span>)) * time.Millisecond)</span><br><span class="line">            <span class="comment">// Sprintf 不会打印，把想要打印的结果作为一个字符串返回</span></span><br><span class="line">            c &lt;- fmt.Sprintf(<span class="string">"message %d"</span>, i)</span><br><span class="line">            i++</span><br><span class="line">        }</span><br><span class="line">    }()</span><br><span class="line">    <span class="keyword">return</span> c</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    m1 := msgGen()</span><br><span class="line">    m2 := msgGen()</span><br><span class="line">    <span class="keyword">for</span> {</span><br><span class="line">        fmt.Println(&lt;-m1)</span><br><span class="line">        fmt.Println(&lt;-m2)</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line">----</span><br><span class="line">message <span class="number">0</span></span><br><span class="line">message <span class="number">0</span></span><br><span class="line">message <span class="number">1</span></span><br><span class="line">message <span class="number">1</span></span><br><span class="line">message <span class="number">2</span></span><br><span class="line">message <span class="number">2</span></span><br><span class="line">message <span class="number">3</span></span><br><span class="line">message <span class="number">3</span></span><br><span class="line">message <span class="number">4</span></span><br><span class="line">message <span class="number">4</span></span><br><span class="line">message <span class="number">5</span></span><br><span class="line">message <span class="number">5</span></span><br><span class="line">message <span class="number">6</span></span><br><span class="line">message <span class="number">6</span></span><br><span class="line">...</span><br><span class="line">等第一个服务生成一个结果后，第二个服务生成结果后再运行第一个服务，交替进行</span><br></pre></td></tr></tbody></table></figure>

<p>服务/任务</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">msgGen</span><span class="params">(name <span class="keyword">string</span>)</span> <span class="title">chan</span> <span class="title">string</span></span> {</span><br><span class="line">    c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">        i := <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> {</span><br><span class="line">            time.Sleep(time.Duration(rand.Intn(<span class="number">2000</span>)) * time.Millisecond)</span><br><span class="line">            <span class="comment">// Sprintf 不会打印，把想要打印的结果作为一个字符串返回</span></span><br><span class="line">            c &lt;- fmt.Sprintf(<span class="string">"service %s: message %d"</span>, name, i)</span><br><span class="line">            i++</span><br><span class="line">        }</span><br><span class="line">    }()</span><br><span class="line">    <span class="keyword">return</span> c</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    m1 := msgGen(<span class="string">"service1"</span>)</span><br><span class="line">    m2 := msgGen(<span class="string">"service2"</span>)</span><br><span class="line">    <span class="keyword">for</span> {</span><br><span class="line">        fmt.Println(&lt;-m1)</span><br><span class="line">        fmt.Println(&lt;-m2)</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line">----</span><br><span class="line">service service1: message <span class="number">0</span></span><br><span class="line">service service2: message <span class="number">0</span></span><br><span class="line">service service1: message <span class="number">1</span></span><br><span class="line">service service2: message <span class="number">1</span></span><br><span class="line">service service1: message <span class="number">2</span></span><br><span class="line">service service2: message <span class="number">2</span></span><br><span class="line">service service1: message <span class="number">3</span></span><br><span class="line">service service2: message <span class="number">3</span></span><br><span class="line">service service1: message <span class="number">4</span></span><br><span class="line">service service2: message <span class="number">4</span></span><br><span class="line">service service1: message <span class="number">5</span></span><br><span class="line">service service2: message <span class="number">5</span></span><br><span class="line">...</span><br><span class="line">等第一个服务生成一个结果后，第二个服务生成结果后再运行第一个服务，交替进行</span><br></pre></td></tr></tbody></table></figure>

<p>同时等待多个服务：两种方法</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">msgGen</span><span class="params">(name <span class="keyword">string</span>)</span> <span class="title">chan</span> <span class="title">string</span></span> {</span><br><span class="line">    c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">        i := <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> {</span><br><span class="line">            time.Sleep(time.Duration(rand.Intn(<span class="number">2000</span>)) * time.Millisecond)</span><br><span class="line">            <span class="comment">// Sprintf 不会打印，把想要打印的结果作为一个字符串返回</span></span><br><span class="line">            c &lt;- fmt.Sprintf(<span class="string">"service %s: message %d"</span>, name, i)</span><br><span class="line">            i++</span><br><span class="line">        }</span><br><span class="line">    }()</span><br><span class="line">    <span class="keyword">return</span> c</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 两个通道哪个协程先发数据给第三个通道c，c里面就是谁</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">fanIn</span><span class="params">(c1, c2 <span class="keyword">chan</span> <span class="keyword">string</span>)</span> <span class="title">chan</span> <span class="title">string</span></span> {</span><br><span class="line">    c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>) <span class="comment">// 无缓存</span></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">        <span class="keyword">for</span> {</span><br><span class="line">            c &lt;- &lt;-c1 <span class="comment">// c1取出数据来发送给c</span></span><br><span class="line">        }</span><br><span class="line">    }()</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">        <span class="keyword">for</span> {</span><br><span class="line">            c &lt;- &lt;-c2 <span class="comment">// c2取出数据来发送给c</span></span><br><span class="line">        }</span><br><span class="line">    }()</span><br><span class="line">    <span class="keyword">return</span> c</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="comment">// 两个channel服务句柄，发给第三个channel，用第三个统一接收数据</span></span><br><span class="line">    m1 := msgGen(<span class="string">"service1"</span>)</span><br><span class="line">    m2 := msgGen(<span class="string">"service2"</span>)</span><br><span class="line">    m := fanIn(m1, m2)</span><br><span class="line">    <span class="keyword">for</span> {</span><br><span class="line">        fmt.Println(&lt;-m)</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line">----</span><br><span class="line">service service1: message <span class="number">0</span></span><br><span class="line">service service2: message <span class="number">0</span></span><br><span class="line">service service1: message <span class="number">1</span></span><br><span class="line">service service2: message <span class="number">1</span></span><br><span class="line">service service1: message <span class="number">2</span></span><br><span class="line">service service1: message <span class="number">3</span></span><br><span class="line">service service1: message <span class="number">4</span></span><br><span class="line">service service2: message <span class="number">2</span></span><br><span class="line">service service1: message <span class="number">5</span></span><br><span class="line">service service1: message <span class="number">6</span></span><br><span class="line">service service2: message <span class="number">3</span></span><br><span class="line">service service1: message <span class="number">7</span></span><br><span class="line">...</span><br><span class="line">第一个服务和第二个服务并发执行，不交替</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">fanInBySelect</span><span class="params">(c1, c2 <span class="keyword">chan</span> <span class="keyword">string</span>)</span> <span class="title">chan</span> <span class="title">string</span></span> {</span><br><span class="line">    c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> { <span class="comment">// 在确定通道个数参数的情况下 select实现只开一个协程</span></span><br><span class="line">        <span class="keyword">for</span> {</span><br><span class="line">            <span class="keyword">select</span> {</span><br><span class="line">            <span class="keyword">case</span> m := &lt;-c1:</span><br><span class="line">                c &lt;- m</span><br><span class="line">            <span class="keyword">case</span> m := &lt;-c2:</span><br><span class="line">                c &lt;- m</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }()</span><br><span class="line">    <span class="keyword">return</span> c</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    m1 := msgGen(<span class="string">"service1"</span>)</span><br><span class="line">    m2 := msgGen(<span class="string">"service2"</span>)</span><br><span class="line">    m := fanInBySelect(m1, m2)</span><br><span class="line">    <span class="keyword">for</span> {</span><br><span class="line">        fmt.Println(&lt;-m)</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line">---</span><br><span class="line">service service1: message <span class="number">0</span></span><br><span class="line">service service2: message <span class="number">0</span></span><br><span class="line">service service1: message <span class="number">1</span></span><br><span class="line">service service2: message <span class="number">1</span></span><br><span class="line">service service1: message <span class="number">2</span></span><br><span class="line">service service1: message <span class="number">3</span></span><br><span class="line">service service1: message <span class="number">4</span></span><br><span class="line">service service2: message <span class="number">2</span></span><br><span class="line">service service1: message <span class="number">5</span></span><br><span class="line">service service1: message <span class="number">6</span></span><br><span class="line">service service2: message <span class="number">3</span></span><br><span class="line">...</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">fanIn</span><span class="params">(chs ...<span class="keyword">chan</span> <span class="keyword">string</span>)</span> <span class="title">chan</span> <span class="title">string</span></span> {</span><br><span class="line">    c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>)</span><br><span class="line">    <span class="keyword">for</span> _, ch := <span class="keyword">range</span> chs { <span class="comment">// 对每一个通道都开一个协程</span></span><br><span class="line">        <span class="comment">// 第一次循环得到的ch后还没来得及在go协程发送和接收，go协程运行在for当前循环之后运行，第二次循环得到的ch又再次赋值给ch，ch全局只有1份，循环走完第二轮之后，ch一直就是第二轮循环的的通道ch2，接下来所有的go func都从c2取数据，生成</span></span><br><span class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">            <span class="keyword">for</span> {</span><br><span class="line">                c &lt;- &lt;-ch</span><br><span class="line">            }</span><br><span class="line">        }()</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> c</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    m1 := msgGen(<span class="string">"service1"</span>)</span><br><span class="line">    m2 := msgGen(<span class="string">"service2"</span>)</span><br><span class="line">    m := fanIn(m1, m2)</span><br><span class="line">    <span class="keyword">for</span> {</span><br><span class="line">        fmt.Println(&lt;-m)</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line">----</span><br><span class="line">service service2: message <span class="number">0</span></span><br><span class="line">service service2: message <span class="number">1</span></span><br><span class="line">service service2: message <span class="number">2</span></span><br><span class="line">service service2: message <span class="number">3</span></span><br><span class="line">service service2: message <span class="number">4</span></span><br><span class="line">service service2: message <span class="number">5</span></span><br><span class="line">service service2: message <span class="number">6</span></span><br><span class="line">service service2: message <span class="number">7</span></span><br><span class="line">...</span><br><span class="line">没有service1</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">fanIn</span><span class="params">(chs ...<span class="keyword">chan</span> <span class="keyword">string</span>)</span> <span class="title">chan</span> <span class="title">string</span></span> {</span><br><span class="line">    c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>)</span><br><span class="line">    <span class="keyword">for</span> _, ch := <span class="keyword">range</span> chs { <span class="comment">// 对每一个通道都开一个协程</span></span><br><span class="line">        chCopy := ch <span class="comment">// chCopy作用域在花括号里面，有几次循环几个通道就会有几个chCopy，</span></span><br><span class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">            <span class="keyword">for</span> {</span><br><span class="line">                c &lt;- &lt;-chCopy</span><br><span class="line">            }</span><br><span class="line">        }()</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> c</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    m1 := msgGen(<span class="string">"service1"</span>)</span><br><span class="line">    m2 := msgGen(<span class="string">"service2"</span>)</span><br><span class="line">    m := fanIn(m1, m2)</span><br><span class="line">    <span class="keyword">for</span> {</span><br><span class="line">        fmt.Println(&lt;-m)</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line">----</span><br><span class="line">service service1: message <span class="number">0</span></span><br><span class="line">service service2: message <span class="number">0</span></span><br><span class="line">service service1: message <span class="number">1</span></span><br><span class="line">service service2: message <span class="number">1</span></span><br><span class="line">service service1: message <span class="number">2</span></span><br><span class="line">service service1: message <span class="number">3</span></span><br><span class="line">service service1: message <span class="number">4</span></span><br><span class="line">service service2: message <span class="number">2</span></span><br><span class="line">service service1: message <span class="number">5</span></span><br><span class="line">service service1: message <span class="number">6</span></span><br><span class="line">service service2: message <span class="number">3</span></span><br><span class="line">...</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">fanIn</span><span class="params">(chs ...<span class="keyword">chan</span> <span class="keyword">string</span>)</span> <span class="title">chan</span> <span class="title">string</span></span> {</span><br><span class="line">    c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>)</span><br><span class="line">    <span class="keyword">for</span> _, ch := <span class="keyword">range</span> chs { <span class="comment">// 对每一个通道都开一个协程</span></span><br><span class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(in <span class="keyword">chan</span> <span class="keyword">string</span>)</span></span> {</span><br><span class="line">            <span class="keyword">for</span> {</span><br><span class="line">                c &lt;- &lt;-in</span><br><span class="line">            }</span><br><span class="line">        }(ch) <span class="comment">// 值传递</span></span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> c</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    m1 := msgGen(<span class="string">"service1"</span>)</span><br><span class="line">    m2 := msgGen(<span class="string">"service2"</span>)</span><br><span class="line">    m := fanIn(m1, m2)</span><br><span class="line">    <span class="keyword">for</span> {</span><br><span class="line">        fmt.Println(&lt;-m)</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line">----</span><br><span class="line">service service1: message <span class="number">0</span></span><br><span class="line">service service2: message <span class="number">0</span></span><br><span class="line">service service1: message <span class="number">1</span></span><br><span class="line">service service2: message <span class="number">1</span></span><br><span class="line">service service1: message <span class="number">2</span></span><br><span class="line">service service1: message <span class="number">3</span></span><br><span class="line">service service1: message <span class="number">4</span></span><br><span class="line">service service2: message <span class="number">2</span></span><br><span class="line">service service1: message <span class="number">5</span></span><br><span class="line">service service1: message <span class="number">6</span></span><br><span class="line">service service2: message <span class="number">3</span></span><br><span class="line">-----</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    m1 := msgGen(<span class="string">"service1"</span>)</span><br><span class="line">    m2 := msgGen(<span class="string">"service2"</span>)</span><br><span class="line">    m3 := msgGen(<span class="string">"service3"</span>)</span><br><span class="line">    <span class="comment">//m := fanIn(m1, m2)</span></span><br><span class="line">    m := fanIn(m1, m2, m3)</span><br><span class="line">    <span class="keyword">for</span> {</span><br><span class="line">        fmt.Println(&lt;-m)</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line">service service1: message <span class="number">0</span></span><br><span class="line">service service1: message <span class="number">1</span></span><br><span class="line">service service1: message <span class="number">2</span></span><br><span class="line">service service1: message <span class="number">3</span></span><br><span class="line">service service3: message <span class="number">0</span></span><br><span class="line">service service2: message <span class="number">0</span></span><br><span class="line">service service1: message <span class="number">4</span></span><br><span class="line">service service2: message <span class="number">1</span></span><br><span class="line">service service3: message <span class="number">1</span></span><br><span class="line">service service3: message <span class="number">2</span></span><br><span class="line">service service2: message <span class="number">2</span></span><br><span class="line">service service3: message <span class="number">3</span></span><br><span class="line">service service1: message <span class="number">5</span></span><br><span class="line">service service3: message <span class="number">4</span></span><br><span class="line">service service2: message <span class="number">3</span></span><br><span class="line">service service1: message <span class="number">6</span></span><br><span class="line">service service3: message <span class="number">5</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="并发任务的控制"><a href="#并发任务的控制" class="headerlink" title="并发任务的控制"></a>并发任务的控制</h3><p>非阻塞等待</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">nonBlockingWait</span><span class="params">(c <span class="keyword">chan</span> <span class="keyword">string</span>)</span><span class="params">(<span class="keyword">string</span>, <span class="keyword">bool</span>)</span></span>{</span><br><span class="line">    <span class="keyword">select</span> {</span><br><span class="line">    <span class="keyword">case</span> m := &lt;-c:</span><br><span class="line">        <span class="keyword">return</span> m, <span class="literal">true</span></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span>, <span class="literal">false</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    m1 := msgGen(<span class="string">"service1"</span>)</span><br><span class="line">    m2 := msgGen(<span class="string">"service2"</span>)</span><br><span class="line">    <span class="keyword">for</span> {</span><br><span class="line">        fmt.Println(&lt;-m1)</span><br><span class="line">        <span class="keyword">if</span> m, ok := nonBlockingWait(m2); ok {</span><br><span class="line">            fmt.Println(m)</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            fmt.Println(<span class="string">"no message from service2"</span>)</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line">---</span><br><span class="line">service service1: message <span class="number">0</span></span><br><span class="line">service service2: message <span class="number">0</span></span><br><span class="line">service service1: message <span class="number">1</span></span><br><span class="line">service service2: message <span class="number">1</span></span><br><span class="line">service service1: message <span class="number">2</span></span><br><span class="line">no message from service2</span><br><span class="line">service service1: message <span class="number">3</span></span><br><span class="line">no message from service2</span><br><span class="line">service service1: message <span class="number">4</span></span><br><span class="line">no message from service2</span><br><span class="line">service service1: message <span class="number">5</span></span><br><span class="line">service service2: message <span class="number">2</span></span><br><span class="line">service service1: message <span class="number">6</span></span><br><span class="line">...</span><br></pre></td></tr></tbody></table></figure>

<p>超时机制</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">timeoutWait</span><span class="params">(c <span class="keyword">chan</span> <span class="keyword">string</span>, timeout time.Duration)</span> <span class="params">(<span class="keyword">string</span>, <span class="keyword">bool</span>)</span></span> {</span><br><span class="line">    <span class="keyword">select</span> {</span><br><span class="line">    <span class="keyword">case</span> m := &lt;-c:</span><br><span class="line">        <span class="keyword">return</span> m, <span class="literal">true</span></span><br><span class="line">    <span class="keyword">case</span> &lt;-time.After(timeout): <span class="comment">// 超过时间还等不到</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span>, <span class="literal">false</span></span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    m := msgGen(<span class="string">"service1"</span>)</span><br><span class="line">    <span class="keyword">for</span> {</span><br><span class="line">        <span class="keyword">if</span> m, ok := timeoutWait(m, <span class="number">2</span>*time.Second); ok {</span><br><span class="line">            fmt.Println(m)</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            fmt.Println(<span class="string">"timeout"</span>)</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line">----</span><br><span class="line">service service1: message <span class="number">0</span></span><br><span class="line">service service1: message <span class="number">1</span></span><br><span class="line">service service1: message <span class="number">2</span></span><br><span class="line">service service1: message <span class="number">3</span></span><br><span class="line">service service1: message <span class="number">4</span></span><br><span class="line">service service1: message <span class="number">5</span></span><br><span class="line">service service1: message <span class="number">6</span></span><br><span class="line">...</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">msgGen</span><span class="params">(name <span class="keyword">string</span>)</span> <span class="title">chan</span> <span class="title">string</span></span> {</span><br><span class="line">    c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">        i := <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> {</span><br><span class="line">            time.Sleep(time.Duration(rand.Intn(<span class="number">5000</span>)) * time.Millisecond) <span class="comment">// 2000 改成 5000</span></span><br><span class="line">            <span class="comment">// Sprintf 不会打印，把想要打印的结果作为一个字符串返回</span></span><br><span class="line">            c &lt;- fmt.Sprintf(<span class="string">"service %s: message %d"</span>, name, i)</span><br><span class="line">            i++</span><br><span class="line">        }</span><br><span class="line">    }()</span><br><span class="line">    <span class="keyword">return</span> c</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    m := msgGen(<span class="string">"service1"</span>)</span><br><span class="line">    <span class="keyword">for</span> {</span><br><span class="line">        <span class="keyword">if</span> m, ok := timeoutWait(m, <span class="number">2</span>*time.Second); ok {</span><br><span class="line">            fmt.Println(m)</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            fmt.Println(<span class="string">"timeout"</span>)</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line">----</span><br><span class="line">timeout</span><br><span class="line">service service1: message <span class="number">0</span></span><br><span class="line">timeout</span><br><span class="line">service service1: message <span class="number">1</span></span><br><span class="line">service service1: message <span class="number">2</span></span><br><span class="line">timeout</span><br><span class="line">timeout</span><br><span class="line">service service1: message <span class="number">3</span></span><br><span class="line">timeout</span><br><span class="line">...</span><br></pre></td></tr></tbody></table></figure>

<p>任务中断/退出</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    m := msgGen(<span class="string">"service1"</span>)</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">5</span>; i++ { <span class="comment">// 只循环5次</span></span><br><span class="line">        <span class="keyword">if</span> m, ok := timeoutWait(m, time.Second); ok {</span><br><span class="line">            fmt.Println(m)</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            fmt.Println(<span class="string">"timeout"</span>)</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line">----</span><br><span class="line">timeout</span><br><span class="line">timeout</span><br><span class="line">timeout</span><br><span class="line">service service1: message <span class="number">0</span></span><br><span class="line">timeout</span><br><span class="line"><span class="number">5</span>秒钟后结束了，main结束协程也结束</span><br></pre></td></tr></tbody></table></figure>

<p>优雅退出</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">msgGen</span><span class="params">(name <span class="keyword">string</span>, done <span class="keyword">chan</span> <span class="keyword">struct</span>{})</span> <span class="title">chan</span> <span class="title">string</span></span> {</span><br><span class="line">    c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">        i := <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> {</span><br><span class="line">            <span class="keyword">select</span> {</span><br><span class="line">            <span class="keyword">case</span> &lt;-time.After(time.Duration(rand.Intn(<span class="number">5000</span>)) * time.Millisecond):</span><br><span class="line">                <span class="comment">// 如果5秒钟之后还没有收到done，就产生一个数据</span></span><br><span class="line">                c &lt;- fmt.Sprintf(<span class="string">"service %s: message %d"</span>, name, i)</span><br><span class="line">            <span class="keyword">case</span> &lt;-done: <span class="comment">// 5秒钟之内收到了done</span></span><br><span class="line">                fmt.Println(<span class="string">"cleaning up"</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="comment">// 主动退出</span></span><br><span class="line">            }</span><br><span class="line">            i++</span><br><span class="line">        }</span><br><span class="line">    }()</span><br><span class="line">    <span class="keyword">return</span> c</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    done := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>{})</span><br><span class="line">    m := msgGen(<span class="string">"service1"</span>, done)</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">5</span>; i++ {</span><br><span class="line">        <span class="keyword">if</span> m, ok := timeoutWait(m, time.Second); ok {</span><br><span class="line">            fmt.Println(m)</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            fmt.Println(<span class="string">"timeout"</span>)</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    done &lt;- <span class="keyword">struct</span>{}{}      <span class="comment">// 第一个{}是结构的定义，第二个{}是结构的初始化</span></span><br><span class="line">    time.Sleep(time.Second) <span class="comment">// 送了struct{}{}给通道done，主协程不挂而是休息，给协程足够的时间清理退出</span></span><br><span class="line">}</span><br><span class="line">----</span><br><span class="line">timeout</span><br><span class="line">timeout</span><br><span class="line">timeout</span><br><span class="line">service service1: message <span class="number">0</span></span><br><span class="line">timeout</span><br><span class="line">cleaning up</span><br></pre></td></tr></tbody></table></figure>


<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">msgGen</span><span class="params">(name <span class="keyword">string</span>, done <span class="keyword">chan</span> <span class="keyword">struct</span>{})</span> <span class="title">chan</span> <span class="title">string</span></span> {</span><br><span class="line">    c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">        i := <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> {</span><br><span class="line">            <span class="keyword">select</span> {</span><br><span class="line">            <span class="keyword">case</span> &lt;-time.After(time.Duration(rand.Intn(<span class="number">5000</span>)) * time.Millisecond):</span><br><span class="line">                <span class="comment">// 如果5秒钟之后还没有收到done，就产生一个数据</span></span><br><span class="line">                c &lt;- fmt.Sprintf(<span class="string">"service %s: message %d"</span>, name, i)</span><br><span class="line">            <span class="keyword">case</span> &lt;-done: <span class="comment">// 5秒钟之内收到了done</span></span><br><span class="line">                fmt.Println(<span class="string">"cleaning up"</span>)</span><br><span class="line">                time.Sleep(<span class="number">2</span> * time.Second)</span><br><span class="line">                fmt.Println(<span class="string">"cleaning done"</span>)</span><br><span class="line">                done &lt;- <span class="keyword">struct</span>{}{} <span class="comment">// done可以发</span></span><br><span class="line">                <span class="keyword">return</span> <span class="comment">// 主动退出</span></span><br><span class="line">            }</span><br><span class="line">            i++</span><br><span class="line">        }</span><br><span class="line">    }()</span><br><span class="line">    <span class="keyword">return</span> c</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    done := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>{})</span><br><span class="line">    m := msgGen(<span class="string">"service1"</span>, done)</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">5</span>; i++ {</span><br><span class="line">        <span class="keyword">if</span> m, ok := timeoutWait(m, time.Second); ok {</span><br><span class="line">            fmt.Println(m)</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            fmt.Println(<span class="string">"timeout"</span>)</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    done &lt;- <span class="keyword">struct</span>{}{} <span class="comment">// 第一个{}是结构的定义，第二个{}是结构的初始化</span></span><br><span class="line">    &lt;-done             <span class="comment">// 收到才退出</span></span><br><span class="line">}</span><br><span class="line">----</span><br><span class="line">timeout</span><br><span class="line">timeout</span><br><span class="line">timeout</span><br><span class="line">service service1: message <span class="number">0</span></span><br><span class="line">timeout</span><br><span class="line">cleaning up</span><br><span class="line">cleaning done</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="comment">//接受任务</span></span><br><span class="line">    taskChannel := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">20</span>)</span><br><span class="line">    <span class="comment">//处理任务</span></span><br><span class="line">    resChannel := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">20</span>)</span><br><span class="line">    <span class="comment">//关闭任务</span></span><br><span class="line">    closeChannel := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>, <span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">        <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ {</span><br><span class="line">            taskChannel &lt;- i</span><br><span class="line">        }</span><br><span class="line">        <span class="built_in">close</span>(taskChannel) <span class="comment">// 关掉也可以接收</span></span><br><span class="line">    }()</span><br><span class="line"></span><br><span class="line">    <span class="comment">//处理任务</span></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">5</span>; i++ {</span><br><span class="line">        <span class="keyword">go</span> Task(taskChannel, resChannel, closeChannel)</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">        <span class="comment">//当接收到5个值以后，说明5个任务都执行完成了</span></span><br><span class="line">        <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">5</span>; i++ {</span><br><span class="line">            &lt;-closeChannel</span><br><span class="line">        }</span><br><span class="line">        <span class="built_in">close</span>(resChannel)</span><br><span class="line">        <span class="built_in">close</span>(closeChannel) </span><br><span class="line">    }()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 假如获取不完，一直在 for循环channel时，当resChannel关闭以后会退出循环</span></span><br><span class="line">    <span class="keyword">for</span> r := <span class="keyword">range</span> resChannel {</span><br><span class="line">        fmt.Println(<span class="string">"res:"</span>, r)</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Task</span><span class="params">(taskChannel <span class="keyword">chan</span> <span class="keyword">int</span>, resChannel <span class="keyword">chan</span> <span class="keyword">int</span>, closeChannel <span class="keyword">chan</span> <span class="keyword">bool</span>)</span></span> {</span><br><span class="line">    <span class="keyword">for</span> t := <span class="keyword">range</span> taskChannel {</span><br><span class="line">        resChannel &lt;- t</span><br><span class="line">    }</span><br><span class="line">    closeChannel &lt;- <span class="literal">true</span></span><br><span class="line">}</span><br><span class="line">----</span><br><span class="line">res: <span class="number">0</span></span><br><span class="line">res: <span class="number">1</span></span><br><span class="line">res: <span class="number">2</span></span><br><span class="line">res: <span class="number">3</span></span><br><span class="line">res: <span class="number">4</span></span><br><span class="line">res: <span class="number">5</span></span><br><span class="line">res: <span class="number">6</span></span><br><span class="line">res: <span class="number">7</span></span><br><span class="line">res: <span class="number">8</span></span><br><span class="line">res: <span class="number">9</span></span><br></pre></td></tr></tbody></table></figure>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/36/">36</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">外心人D</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  




  





</body>
</html>
