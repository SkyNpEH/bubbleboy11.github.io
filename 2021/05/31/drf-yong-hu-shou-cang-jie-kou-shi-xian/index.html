<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.0.2">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<meta name="hexo-config" content="{&quot;hostname&quot;:&quot;bubbleboy11.github.io&quot;,&quot;root&quot;:&quot;/&quot;,&quot;images&quot;:&quot;/images&quot;,&quot;scheme&quot;:&quot;Muse&quot;,&quot;version&quot;:&quot;8.3.0&quot;,&quot;exturl&quot;:false,&quot;sidebar&quot;:{&quot;position&quot;:&quot;left&quot;,&quot;display&quot;:&quot;post&quot;,&quot;padding&quot;:18,&quot;offset&quot;:12},&quot;copycode&quot;:true,&quot;bookmark&quot;:{&quot;enable&quot;:false,&quot;color&quot;:&quot;#222&quot;,&quot;save&quot;:&quot;auto&quot;},&quot;fancybox&quot;:false,&quot;mediumzoom&quot;:false,&quot;lazyload&quot;:false,&quot;pangu&quot;:false,&quot;comments&quot;:{&quot;style&quot;:&quot;tabs&quot;,&quot;active&quot;:null,&quot;storage&quot;:true,&quot;lazyload&quot;:false,&quot;nav&quot;:null},&quot;motion&quot;:{&quot;enable&quot;:true,&quot;async&quot;:false,&quot;transition&quot;:{&quot;post_block&quot;:&quot;fadeIn&quot;,&quot;post_header&quot;:&quot;fadeInDown&quot;,&quot;post_body&quot;:&quot;fadeInDown&quot;,&quot;coll_header&quot;:&quot;fadeInLeft&quot;,&quot;sidebar&quot;:&quot;fadeInUp&quot;}},&quot;prism&quot;:false,&quot;i18n&quot;:{&quot;placeholder&quot;:&quot;搜索...&quot;,&quot;empty&quot;:&quot;没有找到任何搜索结果：${query}&quot;,&quot;hits_time&quot;:&quot;找到 ${hits} 个搜索结果（用时 ${time} 毫秒）&quot;,&quot;hits&quot;:&quot;找到 ${hits} 个搜索结果&quot;}}">
<meta name="description" content="用户点击收藏会创建一条收藏数据，用户再次点击一次，应该删除该条数据因为在UserFavSerializer中使用的是ModelSerializer，类似于Django的ModelForm，它需要满足model中配置的条件，因为model中配置了unique_together &#x3D; [&#39;user&#39;, &#39;goods&#39;]，当提交的数据不满足就会抛出上图的异常。 user_operation&#x2F;models.">
<meta property="og:type" content="article">
<meta property="og:title" content="drf用户收藏接口实现">
<meta property="og:url" content="https://bubbleboy11.github.io/2021/05/31/drf-yong-hu-shou-cang-jie-kou-shi-xian/index.html">
<meta property="og:site_name" content="外心人D的博客">
<meta property="og:description" content="用户点击收藏会创建一条收藏数据，用户再次点击一次，应该删除该条数据因为在UserFavSerializer中使用的是ModelSerializer，类似于Django的ModelForm，它需要满足model中配置的条件，因为model中配置了unique_together &#x3D; [&#39;user&#39;, &#39;goods&#39;]，当提交的数据不满足就会抛出上图的异常。 user_operation&#x2F;models.">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://bubbleboy11.github.io/2021/05/31/drf-yong-hu-shou-cang-jie-kou-shi-xian/1.png">
<meta property="og:image" content="https://bubbleboy11.github.io/2021/05/31/drf-yong-hu-shou-cang-jie-kou-shi-xian/2.png">
<meta property="og:image" content="https://bubbleboy11.github.io/2021/05/31/drf-yong-hu-shou-cang-jie-kou-shi-xian/3.png">
<meta property="og:image" content="https://bubbleboy11.github.io/2021/05/31/drf-yong-hu-shou-cang-jie-kou-shi-xian/4.png">
<meta property="og:image" content="https://bubbleboy11.github.io/2021/05/31/drf-yong-hu-shou-cang-jie-kou-shi-xian/5.png">
<meta property="og:image" content="https://bubbleboy11.github.io/2021/05/31/drf-yong-hu-shou-cang-jie-kou-shi-xian/6.png">
<meta property="og:image" content="https://bubbleboy11.github.io/2021/05/31/drf-yong-hu-shou-cang-jie-kou-shi-xian/7.png">
<meta property="article:published_time" content="2021-05-30T16:21:41.000Z">
<meta property="article:modified_time" content="2021-06-04T08:00:15.620Z">
<meta property="article:author" content="外心人D">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://bubbleboy11.github.io/2021/05/31/drf-yong-hu-shou-cang-jie-kou-shi-xian/1.png">


<link rel="canonical" href="https://bubbleboy11.github.io/2021/05/31/drf-yong-hu-shou-cang-jie-kou-shi-xian/">



<meta name="hexo-config-page" content="{&quot;sidebar&quot;:&quot;&quot;,&quot;isHome&quot;:false,&quot;isPost&quot;:true,&quot;lang&quot;:&quot;zh-CN&quot;}">
<meta name="hexo-config-calendar" content="">
<script data-pjax src="/js/load-config.js"></script>
  <title>drf用户收藏接口实现 | 外心人D的博客</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="外心人D的博客" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism.css" type="text/css"></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">外心人D的博客</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#Advanced-field-defaults"><span class="nav-text">Advanced field defaults</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#CurrentUserDefault"><span class="nav-text">CurrentUserDefault</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">外心人D</p>
  <div class="site-description" itemprop="description">本博客大多内容为慕课和网上博客，并非原创</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">260</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">24</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">40</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/05/31/drf-yong-hu-shou-cang-jie-kou-shi-xian/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          drf用户收藏接口实现
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-05-30 16:21:41" itemprop="dateCreated datePublished" datetime="2021-05-30T16:21:41Z">2021-05-30</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-06-04 08:00:15" itemprop="dateModified" datetime="2021-06-04T08:00:15Z">2021-06-04</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/django/" itemprop="url" rel="index"><span itemprop="name">django</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>用户点击收藏会创建一条收藏数据，用户再次点击一次，应该删除该条数据<br>因为在<code>UserFavSerializer</code>中使用的是<code>ModelSerializer</code>，类似于Django的<code>ModelForm</code>，它需要满足model中配置的条件，因为model中配置了<code>unique_together = ['user', 'goods']</code>，当提交的数据不满足就会抛出上图的异常。</p>
<p><code>user_operation/models.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserFav</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    <span class="string">'''用户收藏'''</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        <span class="comment"># 联合唯一验证，当数据已存在时，数据库就会抛出异常</span></span><br><span class="line">        unique_together = (<span class="string">'user'</span>, <span class="string">'goods'</span>)</span><br></pre></td></tr></tbody></table></figure>

<p>添加指定商品和当前用户到收藏，所以需要获取当前用户<br><a target="_blank" rel="noopener" href="https://www.django-rest-framework.org/api-guide/validators/#advanced-field-defaults">https://www.django-rest-framework.org/api-guide/validators/#advanced-field-defaults</a></p>
<h3 id="Advanced-field-defaults"><a href="#Advanced-field-defaults" class="headerlink" title="Advanced field defaults"></a>Advanced field defaults</h3><p>Validators that are applied across multiple fields in the serializer can sometimes require a field input that should not be provided by the API client, but that is available as input to the validator.<br>在序列化器中跨多个字段应用的验证器有时可能需要一个字段输入，这个字段不应该由API客户机提供，但是可以作为验证器的输入。</p>
<p>Two patterns that you may want to use for this sort of validation include:<br>可能想要使用两种模式来进行这种验证:</p>
<ul>
<li><p>Using <code>HiddenField</code>. This field will be present in <code>validated_data</code> but will not be used in the serializer output representation.<br>使用<code>HiddenField</code>。隐藏字段，该字段将出现在<code>validated_data</code>中，但序列化输出时不会显示出来</p>
</li>
<li><p>Using a standard field with <code>read_only=True</code>, but that also includes a <code>default=…</code> argument. This field will be used in the serializer output representation, but cannot be set directly by the user.<br>使用带有<code>read_only=True</code>的标准字段，但该字段也包含一个<code>default=…</code>参数。此字段将在序列化器输出表示中使用，但不能由用户直接设置。</p>
</li>
</ul>
<p>REST framework includes a couple of defaults that may be useful in this context.REST框架包含一些缺省值，这些缺省值在此上下文中可能很有用。</p>
<h4 id="CurrentUserDefault"><a href="#CurrentUserDefault" class="headerlink" title="CurrentUserDefault"></a><code>CurrentUserDefault</code></h4><p>A default class that can be used to represent the current user. In order to use this, the ‘request’ must have been provided as part of the context dictionary when instantiating the serializer.<br>可用于表示当前用户的默认类。为了使用它，在实例化序列化器时，request必须作为上下文字典的一部分提供</p>
<p><code>user_operation/serializers.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"><span class="keyword">from</span> rest_framework.validators <span class="keyword">import</span> UniqueTogetherValidator</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> UserFav</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserFavSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="string">"""序列化用户收藏数据"""</span></span><br><span class="line">    <span class="comment"># 获取当前登录用户，不可以选择其他用户</span></span><br><span class="line">    user = serializers.HiddenField(default=serializers.CurrentUserDefault())</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = UserFav</span><br><span class="line">        <span class="comment"># 收藏的时候需要返回商品的id，因为取消收藏的时候必须知道商品的id是多少</span></span><br><span class="line">        fields = [<span class="string">'id'</span>, <span class="string">'user'</span>, <span class="string">'goods'</span>]</span><br><span class="line">        <span class="comment"># UserFav items belong to a parent list, and have an ordering defined by the 'position' field.</span></span><br><span class="line">        <span class="comment"># No two items in a given list may share the same position.</span></span><br><span class="line">        <span class="comment"># UserFav项目属于父列表，并且有一个由“position”字段定义的顺序。给定列表中的任何两项不得共享同一位置。</span></span><br><span class="line">        validators = [  <span class="comment"># validate实现唯一联合，同一用户对同一商品只能收藏一次</span></span><br><span class="line">            UniqueTogetherValidator(</span><br><span class="line">                queryset=UserFav.objects.filter(is_delete=<span class="literal">False</span>),</span><br><span class="line">                fields=[<span class="string">'user'</span>, <span class="string">'goods'</span>],</span><br><span class="line">                message=<span class="string">'请勿重复收藏'</span>  <span class="comment"># message的信息可以自定义</span></span><br><span class="line">            )</span><br><span class="line">        ]</span><br></pre></td></tr></tbody></table></figure>

<p><code>user_operation/views.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> viewsets, mixins</span><br><span class="line"><span class="keyword">from</span> rest_framework.authentication <span class="keyword">import</span> SessionAuthentication</span><br><span class="line"><span class="keyword">from</span> rest_framework.permissions <span class="keyword">import</span> IsAuthenticated</span><br><span class="line"><span class="keyword">from</span> rest_framework_simplejwt.authentication <span class="keyword">import</span> JWTAuthentication</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> utils.permissions <span class="keyword">import</span> IsOwnerOrReadOnly</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> UserFav</span><br><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> UserFavSerializer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserFavViewSet</span>(<span class="params">mixins.CreateModelMixin, mixins.ListModelMixin, mixins.RetrieveModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                     mixins.DestroyModelMixin, viewsets.GenericViewSet</span>):</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    list:</span></span><br><span class="line"><span class="string">        用户收藏列表</span></span><br><span class="line"><span class="string">    create:</span></span><br><span class="line"><span class="string">        创建添加一条收藏记录</span></span><br><span class="line"><span class="string">    retrieve:</span></span><br><span class="line"><span class="string">        用户收藏详情</span></span><br><span class="line"><span class="string">    destroy:</span></span><br><span class="line"><span class="string">        删除用户收藏</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    queryset = UserFav.objects.filter(is_delete=<span class="literal">False</span>)</span><br><span class="line">    <span class="comment"># IsAuthenticated：必须登录用户；IsOwnerOrReadOnly：必须是当前登录的用户</span></span><br><span class="line">    permission_classes = [IsAuthenticated, IsOwnerOrReadOnly]</span><br><span class="line">    serializer_class = UserFavSerializer</span><br><span class="line">    authentication_classes = [JWTAuthentication, SessionAuthentication]</span><br><span class="line">    <span class="comment"># 在详细页面时，搜索goods_id来确认该商品有没有被收藏，</span></span><br><span class="line">    lookup_field = <span class="string">'goods_id'</span></span><br><span class="line">    <span class="comment"># 在数据接口中传入商品id并根据该字段进行查询queryset对象，默认为pk，即主键</span></span><br><span class="line">    <span class="comment"># 而不再是根据UserFav的主键id进行查找，就到了自己设置查询使用字段的目的</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_queryset</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># 只能查看当前登录用户的收藏，不会获取所有用户的收藏</span></span><br><span class="line">        <span class="keyword">return</span> UserFav.objects.filter(user=self.request.user, is_delete=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_serializer_class</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">'''动态设置序列化'''</span></span><br><span class="line">        <span class="keyword">if</span> self.action == <span class="string">'list'</span>:</span><br><span class="line">            <span class="keyword">return</span> UserFavDetailSerializer</span><br><span class="line">        <span class="keyword">elif</span> self.action == <span class="string">'create'</span>:</span><br><span class="line">            <span class="keyword">return</span> UserFavSerializer</span><br><span class="line">        <span class="keyword">return</span> UserFavSerializer</span><br></pre></td></tr></tbody></table></figure>

<p><code>url.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> user_operation.views <span class="keyword">import</span> UserFavViewSet</span><br><span class="line"></span><br><span class="line">router.register(<span class="string">'userfavs'</span>, UserFavViewSet)</span><br></pre></td></tr></tbody></table></figure>

<p>查看已收藏列表<br><img src="/2021/05/31/drf-yong-hu-shou-cang-jie-kou-shi-xian/1.png" alt="description"></p>
<p>选中一个商品，点击POST，这时候会向后台提交一个数据<br><img src="/2021/05/31/drf-yong-hu-shou-cang-jie-kou-shi-xian/2.png" alt="description"><br><img src="/2021/05/31/drf-yong-hu-shou-cang-jie-kou-shi-xian/3.png" alt="description"></p>
<p>查看一个已收藏详情<br><img src="/2021/05/31/drf-yong-hu-shou-cang-jie-kou-shi-xian/4.png" alt="description"></p>
<p>当某个商品已经存在收藏时再重复添加收藏，在两个及以上字段联合验证失败时返回错误信息的关键字段，前端在接收后可以进行相应处理<code>non_field_errors</code>，会提示自定义提示“请勿重复收藏”<br><img src="/2021/05/31/drf-yong-hu-shou-cang-jie-kou-shi-xian/5.png" alt="description"></p>
<p><code>utils/permissions.py</code>把官网的实例，直接复制过来就可以了，把其中的<code>owner</code>改为<code>user</code><br>同时需要自定义权限来判断要删除的收藏记录对用的用户是否是当前的用户。</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> permissions</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IsOwnerOrReadOnly</span>(<span class="params">permissions.BasePermission</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Object-level permission to only allow owners of an object to edit it.</span></span><br><span class="line"><span class="string">    Assumes the model instance has an `owner` attribute.</span></span><br><span class="line"><span class="string">    对象级别的权限，仅允许对象的所有者对其进行编辑</span></span><br><span class="line"><span class="string">    自定义所有者权限</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">has_object_permission</span>(<span class="params">self, request, view, obj</span>):</span></span><br><span class="line">        <span class="comment"># Read permissions are allowed to any request,</span></span><br><span class="line">        <span class="comment"># so we'll always allow GET, HEAD or OPTIONS requests.</span></span><br><span class="line">        <span class="keyword">if</span> request.method <span class="keyword">in</span> permissions.SAFE_METHODS:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Instance must have an attribute named `owner`.</span></span><br><span class="line">        <span class="comment"># obj相当于数据库中的model，这里要把owner改为我们数据库中的user</span></span><br><span class="line">        <span class="keyword">return</span> obj.user == request.user</span><br></pre></td></tr></tbody></table></figure>

<p>取消收藏前 <code>user_operation_userfav</code></p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">+<span class="comment">------------------+------------------+--------------------+</span></span><br><span class="line">| id  | add_time  | is_delete  | goods_id     | user_id  |</span><br><span class="line">+<span class="comment">------------------------------------------+---------------+-</span></span><br><span class="line">| 1   | 2021-05-31 15:31:54.767265  |  0 |   1 |   1      |</span><br><span class="line">| 2   | 2021-05-31 16:11:07.655320  |  0 |   4 |   1      |</span><br><span class="line">| 3   | 2021-05-31 16:11:22.720074  |  0 |  10 |   6      |</span><br><span class="line">| 8   | 2021-05-31 22:30:30.567272  |  0 |   2 |   1      |</span><br><span class="line">+<span class="comment">------------------------------------------+---------------+-</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></tbody></table></figure>

<p>取消收藏，例如取消商品goods_id=10</p>
<p><img src="/2021/05/31/drf-yong-hu-shou-cang-jie-kou-shi-xian/6.png" alt="description"><br><img src="/2021/05/31/drf-yong-hu-shou-cang-jie-kou-shi-xian/7.png" alt="description"></p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">+<span class="comment">------------------+------------------+--------------------+</span></span><br><span class="line">| id    | add_time  | is_delete  | goods_id     | user_id  |</span><br><span class="line">+<span class="comment">------------------------------------------+---------------+-</span></span><br><span class="line">| 1 | 2021-05-31 15:31:54.767265 |  0 |       1 | 1        |</span><br><span class="line">| 2 | 2021-05-31 16:11:07.655320 |  0 |       4 | 1        |</span><br><span class="line">| 8 | 2021-05-31 22:30:30.567272 |  0 |       2 | 1        |</span><br><span class="line">+<span class="comment">------------------------------------------+---------------+-</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></tbody></table></figure>

<p>第一次DELETE请求时返回信息204，说明删除成功，第二次再执行则返回未找到，再次印证删除成功。</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/05/31/drf-yong-hu-zhu-ce-he-biao-dan-deng-lu-token/" rel="prev" title="drf用户注册和表单登录token">
                  <i class="fa fa-chevron-left"></i> drf用户注册和表单登录token
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2021/05/31/beego/" rel="next" title="beego">
                  beego <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>





<script src="/js/comments.js"></script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">外心人D</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
