<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.0.2">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"bubbleboy11.github.io","root":"/","images":"/images","scheme":"Muse","version":"8.6.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>
<meta name="description" content="Node仿知乎RESTful API开发设计RESTful 架构REST全称是 Representational State Transfer，中文意思是 表述性状态转移。 它首次出现在2000年Roy Fielding的博士论文中，Roy Fielding是HTTP规范的主要编写者之一。 他在论文中提到：”我这篇文章的写作目的，就是想在符合架构原理的前提下，理解和评估以网络为基础的应用软件的架构">
<meta property="og:type" content="article">
<meta property="og:title" content="外心人D的博客">
<meta property="og:url" content="https://bubbleboy11.github.io/2021/04/26/node.js-restfui-api/index.html">
<meta property="og:site_name" content="外心人D的博客">
<meta property="og:description" content="Node仿知乎RESTful API开发设计RESTful 架构REST全称是 Representational State Transfer，中文意思是 表述性状态转移。 它首次出现在2000年Roy Fielding的博士论文中，Roy Fielding是HTTP规范的主要编写者之一。 他在论文中提到：”我这篇文章的写作目的，就是想在符合架构原理的前提下，理解和评估以网络为基础的应用软件的架构">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-04-26T02:59:48.802Z">
<meta property="article:modified_time" content="2021-04-26T03:58:10.794Z">
<meta property="article:author" content="外心人D">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://bubbleboy11.github.io/2021/04/26/node.js-restfui-api/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://bubbleboy11.github.io/2021/04/26/node.js-restfui-api/","path":"2021/04/26/node.js-restfui-api/","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title> | 外心人D的博客</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="外心人D的博客" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism.css" type="text/css"></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">外心人D的博客</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#Node%E4%BB%BF%E7%9F%A5%E4%B9%8ERESTful-API%E5%BC%80%E5%8F%91%E8%AE%BE%E8%AE%A1"><span class="nav-text">Node仿知乎RESTful API开发设计</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#RESTful-%E6%9E%B6%E6%9E%84"><span class="nav-text">RESTful 架构</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#RESTful-%E5%85%AD%E5%A4%A7%E9%99%90%E5%88%B6"><span class="nav-text">RESTful 六大限制</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%BB%9F%E4%B8%80%E6%8E%A5%E5%8F%A3%E7%9A%84%E9%99%90%E5%88%B6"><span class="nav-text">统一接口的限制</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#RESTful-API"><span class="nav-text">RESTful API</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Koa2"><span class="nav-text">Koa2</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-text">项目初始化</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Koa%E4%B8%AD%E9%97%B4%E4%BB%B6%E4%B8%8E%E6%B4%8B%E8%91%B1%E6%A8%A1%E5%9E%8B"><span class="nav-text">Koa中间件与洋葱模型</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#koa-bodyparser%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="nav-text">koa-bodyparser中间件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#koa-router-%E8%B7%AF%E7%94%B1"><span class="nav-text">koa-router 路由</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86"><span class="nav-text">错误处理</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-koa-parameter-%E6%A0%A1%E9%AA%8C%E5%8F%82%E6%95%B0"><span class="nav-text">使用 koa-parameter 校验参数</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#MongoDB"><span class="nav-text">MongoDB</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Mongoose"><span class="nav-text">Mongoose</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#App"><span class="nav-text">App</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#controllers%E6%8E%A7%E5%88%B6%E5%99%A8"><span class="nav-text">controllers控制器</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#routes%E8%B7%AF%E7%94%B1"><span class="nav-text">routes路由</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81%E4%B8%8E%E6%8E%88%E6%9D%83"><span class="nav-text">用户认证与授权</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Session"><span class="nav-text">Session</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#JWT"><span class="nav-text">JWT</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#koa-jwt-%E5%AE%9E%E7%8E%B0%E8%AE%A4%E8%AF%81%E4%B8%8E%E6%8E%88%E6%9D%83"><span class="nav-text">koa-jwt 实现认证与授权</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0"><span class="nav-text">图片上传</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#koa-body"><span class="nav-text">koa-body</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#koa-static"><span class="nav-text">koa-static</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-overview">
            <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">外心人D</p>
  <div class="site-description" itemprop="description">本博客大多内容为慕课和网上博客，并非原创</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">341</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">22</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">39</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



          </div>
        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/04/26/node.js-restfui-api/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2021-04-26 02:59:48 / 修改时间：03:58:10" itemprop="dateCreated datePublished" datetime="2021-04-26T02:59:48Z">2021-04-26</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h3 id="Node仿知乎RESTful-API开发设计"><a href="#Node仿知乎RESTful-API开发设计" class="headerlink" title="Node仿知乎RESTful API开发设计"></a>Node仿知乎RESTful API开发设计</h3><h4 id="RESTful-架构"><a href="#RESTful-架构" class="headerlink" title="RESTful 架构"></a>RESTful 架构</h4><p><code>REST</code>全称是 <code>Representational State Transfer</code>，中文意思是 <code>表述性状态转移</code>。 它首次出现在2000年Roy Fielding的博士论文中，Roy Fielding是HTTP规范的主要编写者之一。 他在论文中提到：”我这篇文章的写作目的，就是想在符合架构原理的前提下，理解和评估以网络为基础的应用软件的架构设计，得到一个功能强、性能好、适宜通信的架构。**<code>REST指的是一组架构约束条件和原则。" 如果一个架构符合REST的约束条件和原则，我们就称它为RESTful架构。</code>**</p>
<ul>
<li><strong>Representational：数据的表现形式（JSON、XML…..）</strong></li>
<li><strong>State: 当前状态或者数据</strong></li>
<li><strong>Transfer: 数据传输</strong></li>
</ul>
<h5 id="RESTful-六大限制"><a href="#RESTful-六大限制" class="headerlink" title="RESTful 六大限制"></a>RESTful 六大限制</h5><ol>
<li><p><strong>客户-服务器（Client-Server）</strong></p>
<ul>
<li>关注点分离</li>
<li>服务端专注数据存储，提高了简单性</li>
<li>前端专注用户界面，提升了可移植性</li>
</ul>
</li>
<li><p><strong>无状态（StateLess）</strong></p>
<ul>
<li>所有会话信息都保存在客户端</li>
<li>每次请求必须包括所有信息，不能依赖上下文信息</li>
<li>服务端不用保存会话信息，提升简单性、可靠性、可见性（软件工程中接口之间透明程度）</li>
</ul>
</li>
<li><p><strong>缓存（Cache）</strong></p>
<ul>
<li>所有服务端响应都要被表示为可缓存（缓存在客户端（浏览器））或不可缓存</li>
<li>减少前后端交互，提升性能</li>
</ul>
</li>
<li><p><strong>统一接口（Uniform Interface）</strong></p>
<ul>
<li>接口设计尽可能统一通用，提升了简单性、可见性</li>
<li>遵循接口规范，接口与实现解耦，使前后端可以独立开发迭代</li>
</ul>
</li>
<li><p><strong>分层系统（Layered System）</strong></p>
<ul>
<li>每层只知道相邻的一层，后面隐藏的就不知道了</li>
<li>客户端不知道是和代理还是真实服务器通信</li>
<li>其它层：安全层、负载均衡、缓存层等</li>
</ul>
</li>
<li><p><strong>按需代码（Code-On-Demand）（可选）</strong></p>
<ul>
<li>客户端可以下载运行服务端传来的数据（比如JS）</li>
<li>通过减少一些功能，简化了客户端</li>
</ul>
</li>
</ol>
<h5 id="统一接口的限制"><a href="#统一接口的限制" class="headerlink" title="统一接口的限制"></a>统一接口的限制</h5><ol>
<li><p><strong>资源的标识</strong></p>
<ul>
<li>基于“资源”，数据也好、服务也好，是任意可以命名的事物，在RESTFul设计里一切都是资源。</li>
<li>每个资源可以通过<code>URI</code>（统一资源标识符）被唯一的标识  例如 <code>https://api.z.cn/v1/product/recent?page=3&amp;size=20</code></li>
</ul>
</li>
<li><p><strong>通过表述来操作资源</strong></p>
<ul>
<li>通过表述<code>Representation</code> 操作资源，比如<code>JSON</code>、<code>XML</code>等</li>
<li>客户端不能直接操作（比如<code>SQL</code>）服务端资源</li>
<li>客户端应该通过表述（比如<code>JSON</code>）来操作资源</li>
</ul>
</li>
<li><p><strong>自描述消息</strong></p>
<ul>
<li>每个消息（请求或响应）必须提供足够的信息让接受者理解</li>
<li>消息：如媒体类型（<code>application/json、application/xml</code>）</li>
<li>消息：如HTTP方法： <code>GET、POST、DELETE</code></li>
<li>是否缓存： <code>Cache-Control</code></li>
</ul>
</li>
<li><p><strong>超媒体作为应用状态引擎</strong></p>
<ul>
<li>超媒体： 带文字的链接</li>
<li>应用转态：一个网页</li>
<li>引擎：驱动、跳转</li>
<li>合起来就是：点击链接跳转到另一个网页</li>
</ul>
</li>
</ol>
<h5 id="RESTful-API"><a href="#RESTful-API" class="headerlink" title="RESTful API"></a>RESTful API</h5><p>符合REST架构风格的<strong>API</strong>就是 <strong>RESTful API</strong></p>
<p>应该包含三方面：</p>
<ol>
<li>基本的URL 如 <code>https://api.z.cn/v1/product/recent?page=3&amp;size=20</code></li>
<li>标准的HTTP方法，如<code>GET、POST、PUT、DELETE等</code></li>
<li>传输的数据媒体类型，如<code>JSON、XML</code></li>
</ol>
<h4 id="Koa2"><a href="#Koa2" class="headerlink" title="Koa2"></a>Koa2</h4><h5 id="项目初始化"><a href="#项目初始化" class="headerlink" title="项目初始化"></a>项目初始化</h5><ol>
<li><p>安装下载 Koa： <code>npm i koa --save</code></p>
</li>
<li><p>设置自动重启 <strong><code>nodemon</code></strong> ：<code>npm i nodemon --save-dev</code>（<code>-dev</code> 是指只在开发阶段适用）</p>
<p> 在<code>package.json</code>里设置启动方式，再 <code>npm start</code> 启动</p>
 <figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"scripts"</span>: {</span><br><span class="line">    <span class="string">"start"</span>: <span class="string">"nodemon index.js"</span></span><br><span class="line">},</span><br></pre></td></tr></tbody></table></figure>


<h5 id="Koa中间件与洋葱模型"><a href="#Koa中间件与洋葱模型" class="headerlink" title="Koa中间件与洋葱模型"></a>Koa中间件与洋葱模型</h5><blockquote>
<p><strong>当一个中间件调用 <code>next()</code> 则该函数暂停并将控制传递给定义的下一个中间件。当在下游没有更多的中间件执行后，堆栈将展开并且每个中间件恢复执行其上游行为。</strong></p>
</blockquote>
 <figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> app.use(async (ctx, next) =&gt; {</span><br><span class="line">    console.log(<span class="number">1</span>)  // 当执行打印 <span class="number">1</span> 后，调用 next() ,执行下一个中间件，打印 <span class="number">3</span></span><br><span class="line">    <span class="keyword">await</span> next()</span><br><span class="line">    console.log(<span class="number">2</span>)</span><br><span class="line">    console.log(ctx.lastVal) // 通过挂载在ctx，可以取到最后中间件的结果</span><br><span class="line"> })</span><br><span class="line"></span><br><span class="line"> app.use(async (ctx, next) =&gt; {</span><br><span class="line">    console.log(<span class="number">3</span>)</span><br><span class="line">    <span class="keyword">await</span> next()</span><br><span class="line">    console.log(<span class="number">4</span>)</span><br><span class="line"> })</span><br><span class="line"></span><br><span class="line">app.use(async (ctx, next) =&gt; {</span><br><span class="line">    console.log(<span class="number">5</span>)</span><br><span class="line">    ctx.lastVal = <span class="string">"ctx挂载"</span></span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure>

</li>
</ol>
<p>打印顺序为： 1 3 5 4 2 ctx挂载</p>
<p><strong><code>koa-compose：koa-compose则是将 koa/koa-router 各个中间件合并执行，结合 next() 形成一种串行机制，并且是支持异步，这样就形成了洋葱式模型</code></strong></p>
<h5 id="koa-bodyparser中间件"><a href="#koa-bodyparser中间件" class="headerlink" title="koa-bodyparser中间件"></a>koa-bodyparser中间件</h5><p><strong>koa-bodyparser中间件</strong> 是 koa2用来<code>post</code>提交数据的中间件</p>
<ol>
<li><p>下载 <code>npm&nbsp;install&nbsp;koa-bodyparser@2&nbsp;--save</code><br> 引入并挂载配置中间件</p>
 <figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">const bodyParser = require(<span class="string">'koa-bodyparser'</span>)</span><br><span class="line"></span><br><span class="line">app.use(bodyParser())</span><br></pre></td></tr></tbody></table></figure></li>
<li><p>读取<code>post</code>数据 对象格式 <code>ctx.request.body</code></p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">router.post('/doAdd',async (ctx) =&gt;{</span><br><span class="line">    console.log(ctx.request.body)</span><br><span class="line">})  </span><br></pre></td></tr></tbody></table></figure>

<h5 id="koa-router-路由"><a href="#koa-router-路由" class="headerlink" title="koa-router 路由"></a>koa-router 路由</h5></li>
<li><p>下载<code>npm i koa-router --save</code></p>
<p> 引入并挂载</p>
 <figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">const Router = require(<span class="string">"koa-router"</span>)</span><br><span class="line">const router = new Router()</span><br><span class="line"></span><br><span class="line">router.get("/users", (ctx) =&gt; {</span><br><span class="line">    ctx.body = <span class="string">"用户列表页面"</span></span><br><span class="line">})</span><br><span class="line">router.get("/users/:id", ctx =&gt; {</span><br><span class="line">    ctx.body = `当前${ctx.params.id}用户`</span><br><span class="line">})</span><br><span class="line"></span><br><span class="line">app.use(router.routes())</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>路由前缀</p>
<p> 使用路由前缀 <code>prefix</code> 的好处是，当路由前缀需要更改时，直接更改前缀即     可，简洁便利。<br> 如：</p>
 <figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">const userRouter = new Router({ prefix: <span class="string">"/users"</span> })</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">userRouter.get("/", (ctx) =&gt; {</span><br><span class="line">    ctx.body = <span class="string">"用户列表页面"</span></span><br><span class="line">})</span><br><span class="line">userRouter.get("/:id", ctx =&gt; {</span><br><span class="line">    ctx.body = `当前${ctx.params.id}用户`</span><br><span class="line">})</span><br><span class="line"></span><br><span class="line">app.use(userRouter.routes())</span><br></pre></td></tr></tbody></table></figure>
<h5 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h5></li>
</ol>
<p><strong>错误处理</strong> 是指 <code>编程语言或计算机硬件里的一种机制，处理软件或信息系统中出现的异常状况。</code><br>而<code>异常状况</code>又分为：</p>
<ol>
<li>运行错误，返回500</li>
<li>逻辑错误，如找不到（404）、先决条件失败（412）、无法处理的实体（参数格式不对，422）等</li>
</ol>
<p>为保证程序健壮性。防止程序挂掉；告诉用户错误信息；便于开发者调试，需要错误处理。</p>
<p><strong>错误处理中间件：koa-json-error</strong></p>
<ol>
<li><p>安装 <code>npm i koa-json-error --save</code></p>
</li>
<li><p>设置区分生产环境与开发环境： 安装 <code>npm i cross-env --save-dev</code></p>
<p> 在 <strong>package.json</strong> 中设置</p>
 <figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"scripts"</span>:&nbsp;{</span><br><span class="line">    <span class="string">"start"</span>:&nbsp;<span class="string">"cross-env&nbsp;NODE_ENV=production&nbsp;node&nbsp;app"</span>,</span><br><span class="line">    <span class="string">"dev"</span>:&nbsp;<span class="string">"nodemon&nbsp;app"</span></span><br><span class="line">},</span><br></pre></td></tr></tbody></table></figure></li>
<li><p>修改配置使其在生产环境下禁用错误堆栈 <strong>stack</strong> 的返回</p>
 <figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">const&nbsp;jsonError&nbsp;=&nbsp;require(<span class="string">'koa-json-error'</span>)</span><br><span class="line"></span><br><span class="line">app.use(jsonError({</span><br><span class="line">    postFormat:&nbsp;(e,&nbsp;{&nbsp;stack,&nbsp;...rest&nbsp;})&nbsp;=&gt; process.env.NODE_ENV&nbsp;===&nbsp;'production'&nbsp;?&nbsp;rest&nbsp;:&nbsp;{&nbsp;stack,&nbsp;...rest&nbsp;}</span><br><span class="line">}))</span><br></pre></td></tr></tbody></table></figure>
<p> 为使所有请求接口使用错误处理，<code>app.use(jsonError())</code>需放置在前面。</p>
</li>
</ol>
<h5 id="使用-koa-parameter-校验参数"><a href="#使用-koa-parameter-校验参数" class="headerlink" title="使用 koa-parameter 校验参数"></a>使用 koa-parameter 校验参数</h5><ol>
<li>安装 <strong>npm i koa-parameter –save</strong></li>
<li>导入并使用 <figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">const&nbsp;parameter&nbsp;=&nbsp;require(<span class="string">'koa-parameter'</span>)</span><br><span class="line"></span><br><span class="line">// 由于需要在发出请求后进行校验参数，所以校验中间件放在请求之后</span><br><span class="line"></span><br><span class="line">app.use(bodyParser())</span><br><span class="line">app.use(parameter(app))</span><br></pre></td></tr></tbody></table></figure>
</li>
<li>在具体路由中写校验规则，如 users 创建用户接口 <figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ctx.verifyParams({</span><br><span class="line">    name:&nbsp;{&nbsp;type:&nbsp;<span class="string">'string'</span>,&nbsp;required:&nbsp;true&nbsp;},</span><br><span class="line">    age:&nbsp;{&nbsp;type:&nbsp;<span class="string">'number'</span>,&nbsp;required:&nbsp;false&nbsp;}</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>
<h4 id="MongoDB"><a href="#MongoDB" class="headerlink" title="MongoDB"></a>MongoDB</h4></li>
</ol>
<h5 id="Mongoose"><a href="#Mongoose" class="headerlink" title="Mongoose"></a>Mongoose</h5><p><strong>Mongoose</strong>是一个开源的封装好的实现 <code>Node</code> 和 <code>MongoDB</code> 数据通讯的数据建模库。</p>
<ol>
<li><p>安转 <code>npm i mongoose --seve</code> 安装 <code>glob</code>导入所有的 <code>schema</code>: <code>npm i glob --save</code></p>
</li>
<li><p>连接 <strong>Mongoose</strong></p>
<p> 在根目录下创建 <code>database</code> 文件夹，用来存放和数据库操作有关的文件。在 <code>database</code> 文件夹下，建立一个<code>init.js</code> 文件，用来作数据库的连接和一些初始化的事情。</p>
<p> 使用 <code>promise</code> ，确保成功连接数据库，需要对意外处理和逻辑处理。让程序增加健壮性。</p>
 <figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">const&nbsp;mongoose&nbsp;=&nbsp;require("mongoose")</span><br><span class="line">const&nbsp;glob&nbsp;=&nbsp;require("glob")</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 设置  mongoose.set('useFindAndModify',&nbsp;false) 使 mongoose数据库查询与删除不报异常</span><br><span class="line"> *&nbsp;允许使用&nbsp;*&nbsp;符号，来写一个glob规则</span><br><span class="line"> *&nbsp;resolve：将一系列路径或路径段解析为绝对路径</span><br><span class="line"> */</span><br><span class="line"> </span><br><span class="line">mongoose.set('useFindAndModify',&nbsp;false)</span><br><span class="line">const&nbsp;{&nbsp;resolve&nbsp;}&nbsp;=&nbsp;require("path")</span><br><span class="line"></span><br><span class="line">//&nbsp;引入所有定义的schema</span><br><span class="line">exports.initSchemas&nbsp;=&nbsp;()&nbsp;=&gt;&nbsp;{</span><br><span class="line">    glob.sync(resolve(__dirname,&nbsp;"./schema/",&nbsp;"**/*.js")).forEach(require)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">exports.connect&nbsp;=&nbsp;()&nbsp;=&gt;&nbsp;{</span><br><span class="line">    //&nbsp;连接数据库</span><br><span class="line">    mongoose.connect(db)</span><br><span class="line">    let&nbsp;maxConnectTimes&nbsp;=&nbsp;0</span><br><span class="line">    return&nbsp;new&nbsp;Promise((resolve,&nbsp;reject)&nbsp;=&gt;&nbsp;{</span><br><span class="line">        //&nbsp;数据库连接事件监听</span><br><span class="line">        mongoose.connection.on("disconnected",&nbsp;err&nbsp;=&gt;&nbsp;{</span><br><span class="line">            console.log("数据库断开")</span><br><span class="line">            if&nbsp;(maxConnectTimes&nbsp;&lt;&nbsp;3)&nbsp;{</span><br><span class="line">                maxConnectTimes++</span><br><span class="line">                mongoose.connect(db)</span><br><span class="line">            }&nbsp;else&nbsp;{</span><br><span class="line">                reject(err)</span><br><span class="line">                throw&nbsp;new&nbsp;Error("数据库断开")</span><br><span class="line">            }</span><br><span class="line">        })</span><br><span class="line">        //&nbsp;数据库连接错误</span><br><span class="line">        mongoose.connection.on("error",&nbsp;err&nbsp;=&gt;&nbsp;{</span><br><span class="line">            console.log("数据库错误")</span><br><span class="line">            if&nbsp;(maxConnectTimes&nbsp;&lt;&nbsp;3)&nbsp;{</span><br><span class="line">                maxConnectTimes++</span><br><span class="line">                mongoose.connect(db)</span><br><span class="line">            }&nbsp;else&nbsp;{</span><br><span class="line">                reject(err)</span><br><span class="line">                throw&nbsp;new&nbsp;Error("数据库错误")</span><br><span class="line">            }</span><br><span class="line">        })</span><br><span class="line">        //&nbsp;数据库连接打开时，只需要连接一次once</span><br><span class="line">        mongoose.connection.once("open",&nbsp;()&nbsp;=&gt;&nbsp;{</span><br><span class="line">            console.log('MongoDB&nbsp;Connected&nbsp;successfully!')</span><br><span class="line">            resolve()</span><br><span class="line">        })</span><br><span class="line">    })</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
<li></li>
</ol>
<h4 id="App"><a href="#App" class="headerlink" title="App"></a>App</h4><p>一个规范有序的目录更富有表现性与逻辑性，让人耳目一新，简单上手。所有文件是以 <code>app</code>为根路径。</p>
<pre><code>&lt;!--hexoPostRenderEscape:&lt;figure class="highlight awk"&gt;&lt;table&gt;&lt;tr&gt;&lt;td class="gutter"&gt;&lt;pre&gt;&lt;span class="line"&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;13&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class="code"&gt;&lt;pre&gt;&lt;span class="line"&gt;├── routes  &lt;span class="regexp"&gt;//&lt;/span&gt; 路由&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;├──── index.js  &lt;span class="regexp"&gt;//&lt;/span&gt; 路由导入文件&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;├──── home.js  &lt;span class="regexp"&gt;//&lt;/span&gt; home路由&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;├──── users.js  &lt;span class="regexp"&gt;//&lt;/span&gt;  用户路由&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;├── controllers &lt;span class="regexp"&gt;//&lt;/span&gt; 控制器&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;├──── home.js  &lt;span class="regexp"&gt;//&lt;/span&gt; home&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;├──── users.js  &lt;span class="regexp"&gt;//&lt;/span&gt;  users控制器&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;├── database &lt;span class="regexp"&gt;//&lt;/span&gt; 数据库&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;├──── init.js  &lt;span class="regexp"&gt;//&lt;/span&gt;  数据库连接设置文件&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;├──── schema  &lt;span class="regexp"&gt;//&lt;/span&gt; schema&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;├───── Users.js  &lt;span class="regexp"&gt;//&lt;/span&gt;  用户数据库&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;├── public  &lt;span class="regexp"&gt;//&lt;/span&gt;  公共文件&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;├──── upload  &lt;span class="regexp"&gt;//&lt;/span&gt;  图片上传目录&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;:hexoPostRenderEscape--&gt;
</code></pre>
<h5 id="controllers控制器"><a href="#controllers控制器" class="headerlink" title="controllers控制器"></a>controllers控制器</h5><p><strong>Controller控制器</strong>，是MVC中的部分C，此处的控制器主要负责功能处理部分：</p>
<pre><code>1. 收集、验证请求参数并绑定到命令对象；
2. 处理业务，并将业务模块返回给路由。
</code></pre>
<ol>
<li><p>users.js控制器</p>
 <figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">const&nbsp;db&nbsp;=&nbsp;[{&nbsp;name:&nbsp;<span class="string">"lx"</span>&nbsp;}]</span><br><span class="line"></span><br><span class="line">class&nbsp;UsersControl&nbsp;{</span><br><span class="line">    find(ctx)&nbsp;{</span><br><span class="line">        ctx.body&nbsp;=&nbsp;db</span><br><span class="line">    }</span><br><span class="line">    findById(ctx)&nbsp;{</span><br><span class="line">        ctx.body&nbsp;=&nbsp;db[ctx.params.id&nbsp;*&nbsp;<span class="number">1</span>]</span><br><span class="line">    }</span><br><span class="line">    create(ctx)&nbsp;{</span><br><span class="line">        db.push(ctx.request.body)</span><br><span class="line">        ctx.body&nbsp;=&nbsp;ctx.request.body</span><br><span class="line">    }</span><br><span class="line">    update(ctx)&nbsp;{</span><br><span class="line">        db[ctx.params.id&nbsp;*&nbsp;<span class="number">1</span>]&nbsp;=&nbsp;ctx.request.body</span><br><span class="line">        ctx.body&nbsp;=&nbsp;ctx.request.body</span><br><span class="line">    }</span><br><span class="line">    delete(ctx)&nbsp;{</span><br><span class="line">        db.splice(ctx.params.id&nbsp;*&nbsp;<span class="number">1</span>,&nbsp;<span class="number">1</span>)</span><br><span class="line">        ctx.status&nbsp;=&nbsp;<span class="number">204</span></span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">module.exports&nbsp;=&nbsp;new&nbsp;UsersControl()</span><br></pre></td></tr></tbody></table></figure>


</li>
</ol>
<h5 id="routes路由"><a href="#routes路由" class="headerlink" title="routes路由"></a>routes路由</h5><p>将每个功能模块拆分为一个个独立的路由，有助于使代码结构易懂。其中，最重要的是 **<code>路由导入文件index.js</code>**， 它将所有的路由通过脚本引入，不需要一个个的引入，减少代码，使其上档次~。</p>
<ol>
<li><p><strong>index.js</strong></p>
 <figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">const&nbsp;fs&nbsp;=&nbsp;require(<span class="string">"fs"</span>)</span><br><span class="line"></span><br><span class="line">module.exports&nbsp;=&nbsp;(res)&nbsp;=&gt;&nbsp;{</span><br><span class="line">    fs.readdirSync(__dirname).forEach(file&nbsp;=&gt;&nbsp;{</span><br><span class="line">        <span class="keyword">if</span>&nbsp;(file&nbsp;===&nbsp;<span class="string">"index.js"</span>)&nbsp;<span class="keyword">return</span></span><br><span class="line">        const&nbsp;route&nbsp;=&nbsp;require(`./${file}`)</span><br><span class="line">        res.use(route.routes()).use(route.allowedMethods())&nbsp;</span><br><span class="line">    })</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p> **<code>allowedMethods</code>**， 顾名思义，就是当前接口允许运行的<code>method</code>。比如，一个提供数据接的接口，设置为 <code>GET</code>， 当客户端发送 <code>POST</code>请求时就会返回错误信息。</p>
<p> 然后在 <code>index.js</code> 中导入并注册。</p>
 <figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">const&nbsp;router&nbsp;=&nbsp;require(<span class="string">'./routes'</span>)</span><br><span class="line"></span><br><span class="line">router(app)</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>业务路由（如user.js）</p>
<p> 每个业务路由都需导入 <strong>Koa-router ：</strong>  <code>const&nbsp;Router&nbsp;=&nbsp;require("koa-router")</code></p>
<p> 添加路由前缀，方便更改和复用：<code>const&nbsp;router&nbsp;=&nbsp;new&nbsp;Router({&nbsp;prefix:&nbsp;"/users"&nbsp;})</code></p>
<p> 在业务路由中导入相对应的控制器，即可完成对业务控制器的融洽结合，完成其具体业务功能：</p>
 <figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">const&nbsp;{&nbsp;find,&nbsp;findById,&nbsp;create,&nbsp;update,&nbsp;delete:&nbsp;<span class="keyword">del</span>&nbsp;}&nbsp;=&nbsp;require(<span class="string">"../controllers/users"</span>)</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">"/"</span>,&nbsp;find)</span><br><span class="line">router.post(<span class="string">"/"</span>,&nbsp;create)</span><br><span class="line">router.get(<span class="string">"/:id"</span>,&nbsp;findById)</span><br><span class="line">router.put(<span class="string">"/:id"</span>,&nbsp;update)</span><br><span class="line">router.delete(<span class="string">"/:id"</span>,&nbsp;<span class="keyword">del</span>)</span><br><span class="line"></span><br><span class="line">module.exports&nbsp;=&nbsp;router</span><br></pre></td></tr></tbody></table></figure>

</li>
</ol>
<h4 id="用户认证与授权"><a href="#用户认证与授权" class="headerlink" title="用户认证与授权"></a>用户认证与授权</h4><h5 id="Session"><a href="#Session" class="headerlink" title="Session"></a>Session</h5><ol>
<li><p>相比<code>JWT</code>，最大的优势就在于可以主动清除 <code>session</code>。</p>
</li>
<li><p><code>session</code>保存在服务器端，相对较为安全。</p>
</li>
<li><p>结合<code>cookie</code>使用，较为灵活，兼容性较好。但是在跨域场景表现不好。</p>
<h5 id="JWT"><a href="#JWT" class="headerlink" title="JWT"></a>JWT</h5></li>
</ol>
<p><strong><code>JWT</code></strong> 的构成</p>
<p>根据官网的定义，JSON Web Token（以下简称 JWT）是一套开放的标准（RFC 7519），它定义了一套简洁（compact）且 URL 安全（URL-safe）的方案，以安全地在客户端和服务器之间传输 JSON 格式的信息。</p>
<ol>
<li><p>头部（Header）</p>
<ul>
<li>typ（类型）：token的类型，这里固定位为 <code>JWT</code></li>
<li>alg（算法）：使用的hash算法，例如：HMAC SHA256 或者 RSA</li>
</ul>
</li>
<li><p>有效载荷（Payload）</p>
<ul>
<li>存储需要传递的信息。如用户ID、用户名等。</li>
<li>元数据。如过期时间、发布人等。</li>
<li>与Header不同，Payload可以加密。</li>
</ul>
</li>
<li><p>签名（Signature）</p>
<ul>
<li>对Header和Payload部分进行签名</li>
<li>保证Token在传输的过程中没有被篡改或者损坏。</li>
</ul>
</li>
</ol>
<h5 id="koa-jwt-实现认证与授权"><a href="#koa-jwt-实现认证与授权" class="headerlink" title="koa-jwt 实现认证与授权"></a>koa-jwt 实现认证与授权</h5><ol>
<li><p><code>npm install koa-jwt --save</code> 下载</p>
</li>
<li><p>使用中间件保护接口，实现认证</p>
 <figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">const&nbsp;jwt&nbsp;=&nbsp;require(<span class="string">"koa-jwt"</span>)</span><br><span class="line"></span><br><span class="line">引入秘钥</span><br><span class="line">const&nbsp;{&nbsp;secret&nbsp;}&nbsp;=&nbsp;require(<span class="string">"../config"</span>)</span><br><span class="line"></span><br><span class="line">const&nbsp;auth&nbsp;=&nbsp;jwt({&nbsp;secret&nbsp;});</span><br><span class="line"></span><br><span class="line">实现认证</span><br><span class="line"></span><br><span class="line">router.delete(<span class="string">"/:id"</span>,&nbsp;auth,&nbsp;checkOwner,&nbsp;<span class="keyword">del</span>)</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>使用中间件获取用户信息</p>
</li>
</ol>
<h4 id="图片上传"><a href="#图片上传" class="headerlink" title="图片上传"></a>图片上传</h4><h5 id="koa-body"><a href="#koa-body" class="headerlink" title="koa-body"></a>koa-body</h5><p>之前使用 <code>koa2</code> 的时候，处理 <code>post</code> 请求使用的是&nbsp;<code>koa-bodyparser</code>，同时如果是<code>图片上传</code>使用的是&nbsp;<code>koa-multer</code>。</p>
<p>但是这两者可以通过&nbsp;<code>koa-body</code>&nbsp;代替，<strong>并且只是用&nbsp;koa-body&nbsp;即可</strong>。<a target="_blank" rel="noopener" href="http://www.ptbird.cn/koa-body.html">koa-body文档</a></p>
<ol>
<li><p>安装<code>npm i koa-body --save</code></p>
</li>
<li><p>全局设置</p>
 <figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">const koaBody = require(<span class="string">'koa-body'</span>)</span><br><span class="line">const&nbsp;path&nbsp;=&nbsp;require(<span class="string">"path"</span>)</span><br><span class="line"></span><br><span class="line">const app = new koa()</span><br><span class="line"></span><br><span class="line">app.use(koaBody({</span><br><span class="line">    multipart:&nbsp;true,&nbsp;//&nbsp;支持文件上传</span><br><span class="line">    formidable:&nbsp;{</span><br><span class="line">        uploadDir:&nbsp;path.join(__dirname,&nbsp;<span class="string">"/public/uploads"</span>),&nbsp;&nbsp;&nbsp;//&nbsp;上传文件目录</span><br><span class="line">        keepExtensions:&nbsp;true,&nbsp;//&nbsp;保留扩展名</span><br><span class="line">        maxFieldsSize:&nbsp;<span class="number">2</span>&nbsp;*&nbsp;<span class="number">1024</span>&nbsp;*&nbsp;<span class="number">1024</span>,&nbsp;//&nbsp;文件上传大小</span><br><span class="line">        onFileBegin:&nbsp;(name,&nbsp;file)&nbsp;=&gt;&nbsp;{&nbsp;//&nbsp;文件上传前的设置</span><br><span class="line">        },</span><br><span class="line">    }</span><br><span class="line">}))</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>图片上传路由</p>
 <figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">class&nbsp;HomeControl&nbsp;{</span><br><span class="line">    upload(ctx)&nbsp;{</span><br><span class="line">        const&nbsp;file&nbsp;=&nbsp;ctx.request.files.file</span><br><span class="line">        /**</span><br><span class="line">         *&nbsp;获取上传文件信息&nbsp;ctx.request.files</span><br><span class="line">         *&nbsp;&nbsp;size&nbsp;&nbsp;&nbsp;&nbsp;文件大小</span><br><span class="line">            path&nbsp;&nbsp;&nbsp;&nbsp;文件上传后的目录</span><br><span class="line">            name&nbsp;&nbsp;&nbsp;&nbsp;文件的原始名称</span><br><span class="line">            type&nbsp;&nbsp;&nbsp;&nbsp;文件类型</span><br><span class="line">         *&nbsp;</span><br><span class="line">         */</span><br><span class="line">        ctx.body&nbsp;=&nbsp;{&nbsp;path:&nbsp;file.path&nbsp;}</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line">module.exports&nbsp;=&nbsp;new&nbsp;HomeControl()</span><br></pre></td></tr></tbody></table></figure>
<h5 id="koa-static"><a href="#koa-static" class="headerlink" title="koa-static"></a>koa-static</h5></li>
</ol>
<p>使用<code>koa-static</code>生成图片链接</p>
<ol>
<li><p>安装<code>npm i koa-static --save</code></p>
</li>
<li><p>设置静态文件目录</p>
 <figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">const&nbsp;koaStatic&nbsp;=&nbsp;require(<span class="string">"koa-static"</span>)</span><br><span class="line"></span><br><span class="line">app.use(koaStatic(path.join(__dirname,&nbsp;<span class="string">"public"</span>)))</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>生成图片链接</p>
<pre class=" language-python"><code class="language-python">upload<span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token operator">&amp;</span>nbsp<span class="token punctuation">;</span><span class="token punctuation">{</span>
    const<span class="token operator">&amp;</span>nbsp<span class="token punctuation">;</span>file<span class="token operator">&amp;</span>nbsp<span class="token punctuation">;</span><span class="token operator">=</span><span class="token operator">&amp;</span>nbsp<span class="token punctuation">;</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>files<span class="token punctuation">.</span>file
    const<span class="token operator">&amp;</span>nbsp<span class="token punctuation">;</span>basename<span class="token operator">&amp;</span>nbsp<span class="token punctuation">;</span><span class="token operator">=</span><span class="token operator">&amp;</span>nbsp<span class="token punctuation">;</span>path<span class="token punctuation">.</span>basename<span class="token punctuation">(</span>file<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token operator">&amp;</span>nbsp<span class="token punctuation">;</span><span class="token operator">//</span><span class="token operator">&amp;</span>nbsp<span class="token punctuation">;</span>解析图片相对路径
    <span class="token operator">//</span><span class="token operator">&amp;</span>nbsp<span class="token punctuation">;</span>ctx<span class="token punctuation">.</span>origin<span class="token operator">&amp;</span>nbsp<span class="token punctuation">;</span>域名
    ctx<span class="token punctuation">.</span>body<span class="token operator">&amp;</span>nbsp<span class="token punctuation">;</span><span class="token operator">=</span><span class="token operator">&amp;</span>nbsp<span class="token punctuation">;</span><span class="token punctuation">{</span><span class="token operator">&amp;</span>nbsp<span class="token punctuation">;</span>url<span class="token punctuation">:</span><span class="token operator">&amp;</span>nbsp<span class="token punctuation">;</span>`$<span class="token punctuation">{</span>ctx<span class="token punctuation">.</span>origin<span class="token punctuation">}</span><span class="token operator">/</span>uploads<span class="token operator">/</span>$<span class="token punctuation">{</span>basename<span class="token punctuation">}</span>`<span class="token operator">&amp;</span>nbsp<span class="token punctuation">;</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</li>
</ol>
<p>12.4</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/04/26/linux-an-zhuang-mysql/" rel="prev" title="linux安装mysql">
                  <i class="fa fa-chevron-left"></i> linux安装mysql
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2021/05/01/django-web-ui-ce-shi/" rel="next" title="django web ui测试">
                  django web ui测试 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">外心人D</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  




  





</body>
</html>
