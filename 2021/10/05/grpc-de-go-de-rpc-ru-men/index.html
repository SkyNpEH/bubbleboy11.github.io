<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.0.2">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"bubbleboy11.github.io","root":"/","images":"/images","scheme":"Muse","version":"8.6.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>
<meta name="description" content="https:&#x2F;&#x2F;chai2010.cn&#x2F;advanced-go-programming-book&#x2F;ch4-rpc&#x2F;ch4-01-rpc-intro.html RPC版”Hello, World”Go语言的RPC包的路径为net&#x2F;rpc，也就是放在了net包目录下面。因此我们可以猜测该RPC包是建立在net包基础之上的。在第一章“Hello, World”革命一节最后，我们基于http实现了一个打印">
<meta property="og:type" content="article">
<meta property="og:title" content="grpc的go的rpc入门">
<meta property="og:url" content="https://bubbleboy11.github.io/2021/10/05/grpc-de-go-de-rpc-ru-men/index.html">
<meta property="og:site_name" content="外心人D的博客">
<meta property="og:description" content="https:&#x2F;&#x2F;chai2010.cn&#x2F;advanced-go-programming-book&#x2F;ch4-rpc&#x2F;ch4-01-rpc-intro.html RPC版”Hello, World”Go语言的RPC包的路径为net&#x2F;rpc，也就是放在了net包目录下面。因此我们可以猜测该RPC包是建立在net包基础之上的。在第一章“Hello, World”革命一节最后，我们基于http实现了一个打印">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-10-04T16:21:41.000Z">
<meta property="article:modified_time" content="2021-10-19T10:29:04.419Z">
<meta property="article:author" content="外心人D">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://bubbleboy11.github.io/2021/10/05/grpc-de-go-de-rpc-ru-men/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://bubbleboy11.github.io/2021/10/05/grpc-de-go-de-rpc-ru-men/","path":"2021/10/05/grpc-de-go-de-rpc-ru-men/","title":"grpc的go的rpc入门"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>grpc的go的rpc入门 | 外心人D的博客</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="外心人D的博客" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism.css" type="text/css"></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">外心人D的博客</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#RPC%E7%89%88%E2%80%9DHello-World%E2%80%9D"><span class="nav-text">RPC版”Hello, World”</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9B%B4%E5%AE%89%E5%85%A8%E7%9A%84RPC%E6%8E%A5%E5%8F%A3"><span class="nav-text">更安全的RPC接口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B7%A8%E8%AF%AD%E8%A8%80%E7%9A%84RPC"><span class="nav-text">跨语言的RPC</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Http%E4%B8%8A%E7%9A%84RPC"><span class="nav-text">Http上的RPC</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B5%8C%E5%A5%97%E7%9A%84message%E5%AF%B9%E8%B1%A1-%E5%A4%8D%E5%90%88%E7%B1%BB%E5%9E%8B"><span class="nav-text">嵌套的message对象 复合类型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#protobuf%E4%B8%AD%E7%9A%84-enum-%E6%9E%9A%E4%B8%BE%E7%B1%BB%E5%9E%8B"><span class="nav-text">protobuf中的 enum 枚举类型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#protobuf%E4%B8%AD%E7%9A%84-map-%E6%9E%9A%E4%B8%BE%E7%B1%BB%E5%9E%8B"><span class="nav-text">protobuf中的 map 枚举类型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#protobuf%E5%86%85%E7%BD%AE%E7%9A%84timestamp%E7%B1%BB%E5%9E%8B"><span class="nav-text">protobuf内置的timestamp类型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%AF%E9%80%89%E5%AD%97%E6%AE%B5"><span class="nav-text">可选字段</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9A%E4%B9%89%E4%B8%80%E4%B8%AA%E6%9C%8D%E5%8A%A1%EF%BC%8C%E5%90%8C%E6%97%B6%E7%94%A8%E5%91%BD%E4%BB%A4%E7%94%9F%E6%88%90go%E4%BB%A3%E7%A0%81"><span class="nav-text">定义一个服务，同时用命令生成go代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#grpcgateway"><span class="nav-text">grpcgateway</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#grpc%E9%85%8D%E5%90%88asyncio%E4%BD%BF%E7%94%A8-23-58"><span class="nav-text">grpc配合asyncio使用 (23:58)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#grpc%E7%9A%84metadata%E6%9C%BA%E5%88%B6-go-21-35"><span class="nav-text">grpc的metadata机制-go (21:35)</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-overview">
            <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">外心人D</p>
  <div class="site-description" itemprop="description">本博客大多内容为慕课和网上博客，并非原创</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">363</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">22</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">39</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



          </div>
        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/10/05/grpc-de-go-de-rpc-ru-men/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          grpc的go的rpc入门
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-10-04 16:21:41" itemprop="dateCreated datePublished" datetime="2021-10-04T16:21:41Z">2021-10-04</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-10-19 10:29:04" itemprop="dateModified" datetime="2021-10-19T10:29:04Z">2021-10-19</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p><a target="_blank" rel="noopener" href="https://chai2010.cn/advanced-go-programming-book/ch4-rpc/ch4-01-rpc-intro.html">https://chai2010.cn/advanced-go-programming-book/ch4-rpc/ch4-01-rpc-intro.html</a></p>
<h3 id="RPC版”Hello-World”"><a href="#RPC版”Hello-World”" class="headerlink" title="RPC版”Hello, World”"></a>RPC版”Hello, World”</h3><p>Go语言的RPC包的路径为net/rpc，也就是放在了net包目录下面。因此我们可以猜测该RPC包是建立在net包基础之上的。在第一章“Hello, World”革命一节最后，我们基于http实现了一个打印例子。下面我们尝试基于rpc实现一个类似的例子。</p>
<p>我们先构造一个HelloService类型，其中的Hello方法用于实现打印功能</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> HelloService <span class="keyword">struct</span> {}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *HelloService)</span> <span class="title">Hello</span><span class="params">(request <span class="keyword">string</span>, reply *<span class="keyword">string</span>)</span> <span class="title">error</span></span> {</span><br><span class="line">    *reply = <span class="string">"hello "</span>+ request</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>其中Hello方法必须满足<strong>Go语言的RPC规则：方法只能有两个可序列化的参数，其中第二个参数是指针类型，并且返回一个error类型，同时必须是公开的方法</strong>。</p>
<p>然后就可以将HelloService类型的对象注册为一个RPC服务：</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="comment">//2. 注册处理逻辑 handler</span></span><br><span class="line">    rpc.RegisterName(<span class="string">"HelloService"</span>, <span class="built_in">new</span>(HelloService))</span><br><span class="line">    <span class="comment">// rpc.RegisterName("HelloService", &amp;HelloService{})</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//1. 实例化一个server</span></span><br><span class="line">    listener, err := net.Listen(<span class="string">"tcp"</span>, <span class="string">":1234"</span>) <span class="comment">// 省略127.0.0.1</span></span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">        log.Fatal(<span class="string">"ListenTCP error:"</span>, err)</span><br><span class="line">        <span class="comment">// panic("监听端口失败")</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3. 启动服务</span></span><br><span class="line">    conn, err := listener.Accept()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">        log.Fatal(<span class="string">"Accept error:"</span>, err) <span class="comment">// 当一个新的连接进来的时候</span></span><br><span class="line">        <span class="comment">// panic("建立链接失败")</span></span><br><span class="line">    }</span><br><span class="line">    rpc.ServeConn(conn)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>其中<code>rpc.Register</code>函数调用会将对象类型中所有满足RPC规则的对象方法注册为RPC函数，所有注册的方法会放在“HelloService”服务空间之下。然后我们建立一个唯一的TCP链接，并且通过<code>rpc.ServeConn</code>函数在该TCP链接上为对方提供RPC服务。</p>
<p>下面是客户端请求HelloService服务的代码：</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"net/rpc"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="comment">//1. 建立连接</span></span><br><span class="line">    client, err := rpc.Dial(<span class="string">"tcp"</span>, <span class="string">"localhost:1234"</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">        log.Fatal(<span class="string">"dialing:"</span>, err)</span><br><span class="line">        <span class="comment">// panic("连接失败")</span></span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">var</span> reply <span class="keyword">string</span> <span class="comment">//string有默认值</span></span><br><span class="line">    err = client.Call(<span class="string">"HelloService.Hello"</span>, <span class="string">"hello"</span>, &amp;reply)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">        log.Fatal(err)</span><br><span class="line">        <span class="comment">// panic("调用失败")</span></span><br><span class="line">    }</span><br><span class="line">    fmt.Println(reply)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>首先是通过<code>rpc.Dial</code>拨号RPC服务，然后通过<code>client.Call</code>调用具体的RPC方法。在调用<code>client.Call</code>时，第一个参数是用点号链接的RPC服务名字和方法名字，第二和第三个参数分别我们定义RPC方法的两个参数。</p>
<p>先运行服务端，再运行客户端，执行结果</p>
<figure class="highlight avrasm"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">hello:</span>hello</span><br></pre></td></tr></tbody></table></figure>

<h3 id="更安全的RPC接口"><a href="#更安全的RPC接口" class="headerlink" title="更安全的RPC接口"></a>更安全的RPC接口</h3><p>在涉及RPC的应用中，作为开发人员一般至少有三种角色：首先是服务端实现RPC方法的开发人员，其次是客户端调用RPC方法的人员，最后也是最重要的是制定服务端和客户端RPC接口规范的设计人员。在前面的例子中我们为了简化将以上几种角色的工作全部放到了一起，虽然看似实现简单，但是不利于后期的维护和工作的切割。</p>
<p>新建handler/handler.go文件内容如下： 为什么要新建一个文件？ - 解耦</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> hanlder</span><br><span class="line"></span><br><span class="line"><span class="comment">// 解决 serviceName 统一和名称冲突的问题</span></span><br><span class="line"><span class="comment">//   a. server端和client端如何统一serviceName</span></span><br><span class="line"><span class="comment">//   b. 多个server的包中serviceName同名的问题</span></span><br><span class="line"><span class="keyword">const</span> HelloServiceName = <span class="string">"handler/HelloService"</span></span><br><span class="line"><span class="comment">// const HelloServiceName = "path/to/pkg.HelloService"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 继续屏蔽 HelloServiceName 和 Hello 函数名称</span></span><br><span class="line"><span class="comment">// 关心的是 NewHelloService 这个结构体中的方法而不是名字</span></span><br><span class="line"><span class="keyword">type</span> NewHelloService <span class="keyword">struct</span>{}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *NewHelloService)</span> <span class="title">Hello</span><span class="params">(request <span class="keyword">string</span>, reply *<span class="keyword">string</span>)</span> <span class="title">error</span></span> {</span><br><span class="line">    <span class="comment">//返回值是通过修改reply的值</span></span><br><span class="line">    *reply = <span class="string">"hello, "</span> + request</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>如果要重构 HelloService 服务，第一步需要明确服务的名字和接口：</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> server_proxy</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"OldPackageTest/new_helloworld/hanlder"</span></span><br><span class="line">    <span class="string">"net/rpc"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> HelloServicer <span class="keyword">interface</span> {</span><br><span class="line">    Hello(request <span class="keyword">string</span>, reply *<span class="keyword">string</span>) error</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">//如果做到解耦 - 我们关系的是函数 鸭子类型</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RegisterHelloService</span><span class="params">(srv HelloServicer)</span> <span class="title">error</span></span> { <span class="comment">// 用接口不用导入结构体，增强解耦</span></span><br><span class="line">    <span class="keyword">return</span> rpc.RegisterName(hanlder.HelloServiceName, srv)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>我们将RPC服务的接口规范分为三个部分：首先是服务的名字，然后是服务要实现的详细方法列表，最后是注册该类型服务的函数。为了避免名字冲突，我们在RPC服务的名字中增加了包路径前缀（这个是RPC服务抽象的包路径，并非完全等价Go语言的包路径）。RegisterHelloService注册服务时，编译器会要求传入的对象满足HelloServiceInterface接口。</p>
<p>在定义了RPC服务接口规范之后，客户端就可以根据规范编写RPC调用的代码了：</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="comment">// 1. 建立连接</span></span><br><span class="line">    client, err := rpc.Dial(<span class="string">"tcp"</span>, <span class="string">"localhost:1234"</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">        log.Fatal(<span class="string">"dialing:"</span>, err)</span><br><span class="line">        <span class="comment">// panic("连接失败")</span></span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">var</span> reply <span class="keyword">string</span> <span class="comment">//string有默认值</span></span><br><span class="line">    err = client.Call(hanlder.HelloServiceName+<span class="string">".Hello"</span>, <span class="string">"hello"</span>, &amp;reply)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">        log.Fatal(err)</span><br><span class="line">    }</span><br><span class="line">    fmt.Println(reply)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>其中唯一的变化是client.Call的第一个参数用<code>HelloServiceName+".Hello"</code>代替了<code>"HelloService.Hello"</code>。然而通过client.Call函数调用RPC方法依然比较繁琐，同时参数的类型依然无法得到编译器提供的安全保障。</p>
<p>为了简化客户端用户调用RPC函数，我们在可以在接口规范部分增加对客户端的简单包装：</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> client_proxy</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"OldPackageTest/new_helloworld/hanlder"</span></span><br><span class="line">    <span class="string">"net/rpc"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> HelloServiceStub <span class="keyword">struct</span> {</span><br><span class="line">    *rpc.Client</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">//在go语言中没有类、对象 就意味着没有初始化方法</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewHelloServiceClient</span><span class="params">(protcol, address <span class="keyword">string</span>)</span> <span class="title">HelloServiceStub</span></span> {</span><br><span class="line">    conn, err := rpc.Dial(protcol, address)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">        <span class="comment">// panic("connect error!")</span></span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> HelloServiceStub{Client: conn}</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *HelloServiceStub)</span> <span class="title">Hello</span><span class="params">(request <span class="keyword">string</span>, reply *<span class="keyword">string</span>)</span> <span class="title">error</span></span> {</span><br><span class="line">    err := c.Call(hanlder.HelloServiceName+<span class="string">".Hello"</span>, request, reply)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>我们在接口规范中针对客户端新增加了HelloServiceClient类型，该类型也必须满足HelloServiceInterface接口，这样客户端用户就可以直接通过接口对应的方法调用RPC函数。同时提供了一个DialHelloService方法，直接拨号HelloService服务。</p>
<p>基于新的客户端接口，我们可以简化客户端用户的代码：</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"OldPackageTest/new_helloworld/client_proxy"</span></span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="comment">// 封装后，像本地调用函数一样</span></span><br><span class="line">    <span class="comment">//1. 建立连接</span></span><br><span class="line">    client, err := client_proxy.NewHelloServiceClient(<span class="string">"tcp"</span>, <span class="string">"localhost:1234"</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">        log.Fatal(<span class="string">"dialing:"</span>, err)</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1. 只想写业务逻辑 不想关注每个函数的名称</span></span><br><span class="line">    <span class="comment">// 客户端部分</span></span><br><span class="line">    <span class="keyword">var</span> reply <span class="keyword">string</span> <span class="comment">//string有默认值</span></span><br><span class="line">    err := client.Hello(<span class="string">"hello"</span>, &amp;reply)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">        log.Fatal(err)</span><br><span class="line">        <span class="comment">// panic("调用失败")</span></span><br><span class="line">    }</span><br><span class="line">    fmt.Println(reply)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>现在客户端用户不用再担心RPC方法名字或参数类型不匹配等低级错误的发生。</p>
<p>最后是基于RPC接口规范编写真实的服务端代码：</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"OldPackageTest/new_helloworld/hanlder"</span></span><br><span class="line">    <span class="string">"OldPackageTest/new_helloworld/server_proxy"</span></span><br><span class="line">    <span class="string">"net"</span></span><br><span class="line">    <span class="string">"net/rpc"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 业务逻辑</span></span><br><span class="line"><span class="keyword">type</span> HelloService <span class="keyword">struct</span>{}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *HelloService)</span> <span class="title">Hello</span><span class="params">(request <span class="keyword">string</span>, reply *<span class="keyword">string</span>)</span> <span class="title">error</span></span> {</span><br><span class="line">    <span class="comment">//返回值是通过修改reply的值</span></span><br><span class="line">    *reply = <span class="string">"hello, "</span> + request</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="comment">//1. 实例化一个server</span></span><br><span class="line">    listener, err := net.Listen(<span class="string">"tcp"</span>, <span class="string">":1234"</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">        log.Fatal(<span class="string">"ListenTCP error:"</span>, err)</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//2. 注册处理逻辑 handler</span></span><br><span class="line">    server_proxy.RegisterHelloService(&amp;hanlder.NewHelloService{})</span><br><span class="line">    <span class="comment">// server_proxy.RegisterHelloService(new(hanlder.NewHelloService))</span></span><br><span class="line">    <span class="comment">//3. 启动服务</span></span><br><span class="line">    <span class="keyword">for</span> {</span><br><span class="line">        conn, err := listener.Accept() <span class="comment">//当一个新的连接进来的时候</span></span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">            log.Fatal(<span class="string">"Accept error:"</span>, err)</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">go</span> rpc.ServeConn(conn)</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>在新的RPC服务端实现中，我们用RegisterHelloService函数来注册函数，这样不仅可以避免命名服务名称的工作，同时也保证了传入的服务对象满足了RPC接口的定义。最后我们新的服务改为支持多个TCP链接，然后为每个TCP链接提供RPC服务。</p>
<h3 id="跨语言的RPC"><a href="#跨语言的RPC" class="headerlink" title="跨语言的RPC"></a>跨语言的RPC</h3><p>标准库的RPC默认采用Go语言特有的gob编码，因此从其它语言调用Go语言实现的RPC服务将比较困难。在互联网的微服务时代，每个RPC以及服务的使用者都可能采用不同的编程语言，因此跨语言是互联网时代RPC的一个首要条件。得益于RPC的框架设计，Go语言的RPC其实也是很容易实现跨语言支持的。</p>
<p>Go语言的RPC框架有两个比较有特色的设计：一个是RPC数据打包时可以通过插件实现自定义的编码和解码；另一个是RPC建立在抽象的<code>io.ReadWriteCloser</code>接口之上的，我们可以将RPC架设在不同的通讯协议之上。这里我们将尝试通过官方自带的<code>net/rpc/jsonrpc</code>扩展实现一个跨语言的RPC。</p>
<p>首先是基于json编码重新实现RPC服务：</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"net"</span></span><br><span class="line">    <span class="string">"net/rpc"</span></span><br><span class="line">    <span class="string">"net/rpc/jsonrpc"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> HelloService <span class="keyword">struct</span>{}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *HelloService)</span> <span class="title">Hello</span><span class="params">(request <span class="keyword">string</span>, reply *<span class="keyword">string</span>)</span> <span class="title">error</span></span> {</span><br><span class="line">    <span class="comment">//返回值是通过修改reply的值</span></span><br><span class="line">    *reply = <span class="string">"hello, "</span> + request</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="comment">//1. 实例化一个server</span></span><br><span class="line">    listener, err := net.Listen(<span class="string">"tcp"</span>, <span class="string">":1234"</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">        log.Fatal(<span class="string">"ListenTCP error:"</span>, err)</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//2. 注册处理逻辑 handler</span></span><br><span class="line">    rpc.RegisterName(<span class="string">"HelloService"</span>, &amp;HelloService{})</span><br><span class="line">    <span class="comment">// rpc.RegisterName("HelloService", new(HelloService))</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//3. 启动服务</span></span><br><span class="line">    <span class="keyword">for</span> { <span class="comment">// 死循环，运行完不退出</span></span><br><span class="line">        conn, err := listener.Accept() <span class="comment">//当一个新的连接进来的时候，</span></span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">            log.Fatal(<span class="string">"Accept error:"</span>, err)</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">go</span> rpc.ServeCodec(jsonrpc.NewServerCodec(conn)) <span class="comment">// 并发</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>代码中最大的变化是用<code>rpc.ServeCodec</code>函数替代了<code>rpc.ServeConn</code>函数，传入的参数是针对服务端的json编解码器。</p>
<p>然后是实现json版本的客户端：</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"net"</span></span><br><span class="line">    <span class="string">"net/rpc/jsonrpc"</span></span><br><span class="line"></span><br><span class="line">    <span class="string">"net/rpc"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="comment">//1. 建立连接</span></span><br><span class="line">    conn, err := net.Dial(<span class="string">"tcp"</span>, <span class="string">"localhost:1234"</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">        log.Fatal(<span class="string">"ListenTCP error:"</span>, err)</span><br><span class="line">        <span class="comment">// panic("连接失败")</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    client := rpc.NewClientWithCodec(jsonrpc.NewClientCodec(conn))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> reply <span class="keyword">string</span> <span class="comment">//string有默认值</span></span><br><span class="line">    err = client.Call(<span class="string">"HelloService.Hello"</span>, <span class="string">"hello"</span>, &amp;reply)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">        log.Fatal(err)</span><br><span class="line">        <span class="comment">// panic("调用失败")</span></span><br><span class="line">    }</span><br><span class="line">    fmt.Println(reply)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>先手工调用net.Dial函数建立TCP链接，然后基于该链接建立针对客户端的json编解码器。</p>
<p>在确保客户端可以正常调用RPC服务的方法之后，我们用一个普通的TCP服务代替Go语言版本的RPC服务，这样可以查看客户端调用时发送的数据格式。比如通过nc命令<code>nc -l 1234</code>在同样的端口启动一个TCP服务。然后再次执行一次RPC调用将会发现nc输出了以下的信息：</p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">{<span class="attr">"method"</span>:<span class="string">"HelloService.Hello"</span>,<span class="attr">"params"</span>:[<span class="string">"hello"</span>],<span class="attr">"id"</span>:<span class="number">0</span>}</span><br></pre></td></tr></tbody></table></figure>

<p>这是一个json编码的数据，其中method部分对应要调用的rpc服务和方法组合成的名字，params部分的第一个元素为参数，id是由调用端维护的一个唯一的调用编号。</p>
<p>请求的json数据对象在内部对应两个结构体：客户端是clientRequest，服务端是serverRequest。<br>clientRequest和serverRequest结构体的内容基本是一致的：</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> clientRequest <span class="keyword">struct</span> {</span><br><span class="line">    Method <span class="keyword">string</span>         <span class="string">`json:"method"`</span></span><br><span class="line">    Params [<span class="number">1</span>]<span class="keyword">interface</span>{} <span class="string">`json:"params"`</span></span><br><span class="line">    Id     <span class="keyword">uint64</span>         <span class="string">`json:"id"`</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> serverRequest <span class="keyword">struct</span> {</span><br><span class="line">    Method <span class="keyword">string</span>           <span class="string">`json:"method"`</span></span><br><span class="line">    Params *json.RawMessage <span class="string">`json:"params"`</span></span><br><span class="line">    Id     *json.RawMessage <span class="string">`json:"id"`</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>在获取到RPC调用对应的json数据后，我们可以通过直接向架设了RPC服务的TCP服务器发送json数据模拟RPC方法调用：</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> -e <span class="string">'{"method":"HelloService.Hello","params":["hello"],"id":1}'</span> | nc localhost 1234</span></span><br></pre></td></tr></tbody></table></figure>

<p>返回的结果也是一个json格式的数据：</p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">{<span class="attr">"id"</span>:<span class="number">1</span>,<span class="attr">"result"</span>:<span class="string">"hello:hello"</span>,<span class="attr">"error"</span>:<span class="literal">null</span>}</span><br></pre></td></tr></tbody></table></figure>

<p>其中id对应输入的id参数，result为返回的结果，error部分在出问题时表示错误信息。对于顺序调用来说，id不是必须的。但是Go语言的RPC框架支持异步调用，当返回结果的顺序和调用的顺序不一致时，可以通过id来识别对应的调用。</p>
<p>返回的json数据也是对应内部的两个结构体：客户端是clientResponse，服务端是serverResponse。两个结构体的内容同样也是类似的：</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> clientResponse <span class="keyword">struct</span> {</span><br><span class="line">    Id     <span class="keyword">uint64</span>           <span class="string">`json:"id"`</span></span><br><span class="line">    Result *json.RawMessage <span class="string">`json:"result"`</span></span><br><span class="line">    Error  <span class="keyword">interface</span>{}      <span class="string">`json:"error"`</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> serverResponse <span class="keyword">struct</span> {</span><br><span class="line">    Id     *json.RawMessage <span class="string">`json:"id"`</span></span><br><span class="line">    Result <span class="keyword">interface</span>{}      <span class="string">`json:"result"`</span></span><br><span class="line">    Error  <span class="keyword">interface</span>{}      <span class="string">`json:"error"`</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>因此无论采用何种语言，只要遵循同样的json结构，以同样的流程就可以和Go语言编写的RPC服务进行通信。这样我们就实现了跨语言的RPC。</p>
<p>python客户端</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JSONClient</span>(<span class="params">object</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, addr</span>):</span></span><br><span class="line">        self.socket = socket.create_connection(addr)</span><br><span class="line">        self.id_counter = itertools.count()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__del__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.socket.close()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">call</span>(<span class="params">self, name, *params</span>):</span></span><br><span class="line">        request = dict(id=next(self.id_counter),</span><br><span class="line">                    params=list(params),</span><br><span class="line">                    method=name)</span><br><span class="line">        self.socket.sendall(json.dumps(request).encode())</span><br><span class="line"></span><br><span class="line">        <span class="comment"># This must loop if resp is bigger than 4K</span></span><br><span class="line">        response = self.socket.recv(<span class="number">4096</span>)</span><br><span class="line">        response = json.loads(response.decode())</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> response.get(<span class="string">'id'</span>) != request.get(<span class="string">'id'</span>):</span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">"expected id=%s, received id=%s: %s"</span></span><br><span class="line">                            %(request.get(<span class="string">'id'</span>), response.get(<span class="string">'id'</span>),</span><br><span class="line">                              response.get(<span class="string">'error'</span>)))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> response.get(<span class="string">'error'</span>) <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">raise</span> Exception(response.get(<span class="string">'error'</span>))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> response.get(<span class="string">'result'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">close</span>(<span class="params">self</span>):</span></span><br><span class="line">    self._socket.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    rpc = JSONClient((<span class="string">"localhost"</span>, <span class="number">1234</span>))</span><br><span class="line">    args = <span class="string">"hello"</span></span><br><span class="line">    print(rpc.call(<span class="string">"HelloService.Hello"</span>, args))</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># go_json_rpc_client</span></span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">request = {</span><br><span class="line">    <span class="string">"id"</span>:<span class="number">0</span>,</span><br><span class="line">    <span class="string">"params"</span>:[<span class="string">"bobby"</span>],</span><br><span class="line">    <span class="string">"method"</span>: <span class="string">"HelloService.Hello"</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">client = socket.create_connection((<span class="string">"localhost"</span>, <span class="number">1234</span>))</span><br><span class="line">client.sendall(json.dumps(request).encode())</span><br><span class="line"></span><br><span class="line"><span class="comment">#获取服务器返回的数据</span></span><br><span class="line">This must loop <span class="keyword">if</span> resp <span class="keyword">is</span> bigger than <span class="number">4</span>K</span><br><span class="line">rsp = client.recv(<span class="number">1024</span>)</span><br><span class="line">rsp = client.recv(<span class="number">4096</span>)</span><br><span class="line">rsp = json.loads(rsp.decode())</span><br><span class="line"></span><br><span class="line">print(rsp)  <span class="comment"># {'id': 0, 'result': 'hello, bobby', 'error': None}</span></span><br><span class="line">print(rsp[<span class="string">"result"</span>])  <span class="comment"># hello, bobby</span></span><br><span class="line">client.close() <span class="comment">#关闭这个链接</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">request = {</span><br><span class="line">    <span class="string">"id"</span>:<span class="number">0</span>,</span><br><span class="line">    <span class="string">"params"</span>:[<span class="string">"bobby"</span>],</span><br><span class="line">    <span class="string">"method"</span>: <span class="string">"HelloService.Hello"</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">rsp = requests.post(<span class="string">"http://localhost:1234/jsonrpc"</span>, json=request)</span><br><span class="line">print(rsp.text)  <span class="comment"># {"id":0,"result":"hello, bobby","error":null}</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="Http上的RPC"><a href="#Http上的RPC" class="headerlink" title="Http上的RPC"></a>Http上的RPC</h3><p>替换rpc的传输协议为http</p>
<p>Go语言内在的RPC框架已经支持在Http协议上提供RPC服务。但是框架的http服务同样采用了内置的gob协议，并且没有提供采用其它协议的接口，因此从其它语言依然无法访问的。在前面的例子中，我们已经实现了在TCP协议之上运行jsonrpc服务，并且通过nc命令行工具成功实现了RPC方法调用。现在我们尝试在http协议上提供jsonrpc服务。</p>
<p>新的RPC服务其实是一个类似REST规范的接口，接收请求并采用相应处理流程：</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"io"</span></span><br><span class="line">    <span class="string">"net/http"</span></span><br><span class="line">    <span class="string">"net/rpc"</span></span><br><span class="line">    <span class="string">"net/rpc/jsonrpc"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> HelloService <span class="keyword">struct</span>{}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *HelloService)</span> <span class="title">Hello</span><span class="params">(request <span class="keyword">string</span>, reply *<span class="keyword">string</span>)</span> <span class="title">error</span></span> {</span><br><span class="line">    <span class="comment">//返回值是通过修改reply的值</span></span><br><span class="line">    *reply = <span class="string">"hello, "</span> + request</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="comment">//1. 实例化一个server</span></span><br><span class="line">    rpc.RegisterName(<span class="string">"HelloService"</span>, &amp;HelloService{})</span><br><span class="line">    http.HandleFunc(<span class="string">"/jsonrpc"</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> {</span><br><span class="line">        <span class="keyword">var</span> conn io.ReadWriteCloser = <span class="keyword">struct</span> {</span><br><span class="line">            io.Writer</span><br><span class="line">            io.ReadCloser</span><br><span class="line">        }{</span><br><span class="line">            ReadCloser: r.Body,</span><br><span class="line">            Writer:     w,</span><br><span class="line">        }</span><br><span class="line">        rpc.ServeRequest(jsonrpc.NewServerCodec(conn))</span><br><span class="line">    })</span><br><span class="line">    http.ListenAndServe(<span class="string">":1234"</span>, <span class="literal">nil</span>)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>RPC的服务架设在“/jsonrpc”路径，在处理函数中基于http.ResponseWriter和http.Request类型的参数构造一个io.ReadWriteCloser类型的conn通道。然后基于conn构建针对服务端的json编码解码器。最后通过rpc.ServeRequest函数为每次请求处理一次RPC方法调用。</p>
<p>模拟一次RPC调用的过程就是向该链接发送一个json字符串：</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> curl localhost:1234/jsonrpc -X POST \</span></span><br><span class="line">    --data '{"method":"HelloService.Hello","params":["hello"],"id":0}'</span><br></pre></td></tr></tbody></table></figure>

<p>返回的结果依然是json字符串：</p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">{<span class="attr">"id"</span>:<span class="number">0</span>,<span class="attr">"result"</span>:<span class="string">"hello:hello"</span>,<span class="attr">"error"</span>:<span class="literal">null</span>}</span><br></pre></td></tr></tbody></table></figure>

<p>这样就可以很方便地从不同语言中访问RPC服务了。</p>
<p>option go_package 设置 package 名称 和生成的文件路径<br><code>".;proto"</code> 生成在当前路径，<br><code>"coolcar/auth/api/gen/v1;authpb"</code><br><code>coolcar/auth/api/gen/v1;</code> 定义生成的go文件存放 package 目录路径，<br><code>authpb</code>：表示生成的go文件包的名字</p>
<p>proto文件名称为：trip.proto<br>两者名字前缀最好要一致。</p>
<p>option java_package</p>
<p>这个选项我们在 Python 中是不需要的，但是在 Go 里面是需要的（如果没有的话也不会报错，但是会抛警告，然后生成的文件的包名就是 proto 文件的名字）。当时我们是通过这个选项指定的包名，但其实这个选项的设置是比较灵活的，我们还可以自己指定生成文件的目录。</p>
<p><code>option go_package = "../../common/stream/proto/v1";</code></p>
<p>如果改成上面这种方式的话，那么会把生成的文件放在执行命令的目录下的 common/stream/protobuf/v1 中，并且包名是 v1。如果目录不存在的话，会自动创建。并且这个选项对 Python 是无任何影响的，所以一个针对于 Go 的 proto 文件，拿给 Python 也是完全可以使用的。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">syntax = "proto3";</span><br><span class="line">package coolcar;</span><br><span class="line">option go_package = "coolcar/proto/gen/go;trippb";</span><br><span class="line"></span><br><span class="line">message Trip {</span><br><span class="line">  string start = 1;</span><br><span class="line">  string end = 2;</span><br><span class="line">  int64 duration_sec = 3;</span><br><span class="line">  int64 fee_cent = 4;</span><br><span class="line">  TripStatus status = 8;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight jboss-cli"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> car/proto</span><br><span class="line">protoc -I . <span class="params">--go_out=paths=source_relative</span><span class="function">:gen</span>/go trip.proto</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Trip <span class="keyword">struct</span> {</span><br><span class="line">    state         protoimpl.MessageState</span><br><span class="line">    sizeCache     protoimpl.SizeCache</span><br><span class="line">    unknownFields protoimpl.UnknownFields</span><br><span class="line"></span><br><span class="line">    Start         <span class="keyword">string</span>      <span class="string">`protobuf:"bytes,1,opt,name=start,proto3" json:"start,omitempty"`</span></span><br><span class="line">    End           <span class="keyword">string</span>      <span class="string">`protobuf:"bytes,2,opt,name=end,proto3" json:"end,omitempty"`</span></span><br><span class="line">    DurationSec   <span class="keyword">int64</span>       <span class="string">`protobuf:"varint,3,opt,name=duration_sec,json=durationSec,proto3" json:"duration_sec,omitempty"`</span></span><br><span class="line">    FeeCent       <span class="keyword">int64</span>       <span class="string">`protobuf:"varint,4,opt,name=fee_cent,json=feeCent,proto3" json:"fee_cent,omitempty"`</span></span><br><span class="line">    Status        TripStatus  <span class="string">`protobuf:"varint,8,opt,name=status,proto3,enum=coolcar.TripStatus" json:"status,omitempty"`</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>如果message中的数据类型是int64，那么在转成json时会变成字符串，这是因为int64的长度过大<br>，如果使用int32那么转成json时，数据类型则会是数字类型。<br>字段名 duration_sec ，生成go代码时会使用驼峰规则</p>
<p>import trippb “coolcar/proto/gen/go”</p>
<p>与proto中的定义对应起来：option go_package=”coolcar/proto/gen/go;trippb”;</p>
<p>包名称为:trippb</p>
<p>包路径为：coolcar/proto/gen/go</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    trippb <span class="string">"OldPackageTest/car/proto/gen/go"</span></span><br><span class="line">    <span class="string">"encoding/json"</span></span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line">    <span class="string">"google.golang.org/protobuf/proto"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="comment">//1、模拟微服务和微服务之间通过gRPC传递二进制流来互相通信</span></span><br><span class="line">    trip := trippb.Trip{</span><br><span class="line">        Start:       <span class="string">"abc"</span>,</span><br><span class="line">        End:         <span class="string">"def"</span>,</span><br><span class="line">        DurationSec: <span class="number">3600</span>,</span><br><span class="line">        FeeCent:     <span class="number">10000</span>,</span><br><span class="line">    }</span><br><span class="line">    fmt.Println(&amp;trip)</span><br><span class="line">    <span class="comment">//start:"abc"  end:"def"  duration_sec:3600  fee_cent:10000</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//将数据转换为二进制bianma数据，并打印出来（模拟向客户端发送数据）</span></span><br><span class="line">    b, err := proto.Marshal(&amp;trip)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    }</span><br><span class="line">    fmt.Printf(<span class="string">"%X\n"</span>, b)</span><br><span class="line">    <span class="comment">//0A03616263120364656618901C20904E</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//将二进制数据解码回来（模拟从客户端接收数据并解析成可以使用的数据格式）</span></span><br><span class="line">    <span class="keyword">var</span> trip2 trippb.Trip</span><br><span class="line">    err = proto.Unmarshal(b, &amp;trip2)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    }</span><br><span class="line">    fmt.Println(&amp;trip2)</span><br><span class="line">    <span class="comment">//start:"abc"  end:"def"  duration_sec:3600  fee_cent:10000</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//2、模拟发送json数据给小程序端，因为pg.go 中结构体有json标签</span></span><br><span class="line">    c, err := json.Marshal(&amp;trip2)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    }</span><br><span class="line">    fmt.Printf(<span class="string">"%s\n"</span>, c)</span><br><span class="line">    <span class="comment">//{"start":"abc","end":"def","duration_sec":3600,"fee_cent":10000}</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<p>protobuf的基本类型和默认值 (15:41)<br>当proto文件不同步的时候容易出现的问题 (12:28)</p>
<p>proto文件中引入其他的proto文件 (10:20)</p>
<p>比如我们要定义多个服务，这些服务都有一个相同的方法，比如：调用 Ping，返回字符串 Pong，那么我们可以把这些公共的写在一个单独的文件中，然后去导入它。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// 文件名 common.proto</span><br><span class="line">syntax = "proto3";</span><br><span class="line"></span><br><span class="line">// 我们调用 Ping 是不需要传递参数的，但是 proto 文件要求我们必须定义</span><br><span class="line">// 所以我们定义一个空的消息体即可，就叫 Empty</span><br><span class="line">message Empty {}</span><br><span class="line"></span><br><span class="line">message Pong {</span><br><span class="line">  string result = 1;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>我们在其它的 proto 文件（hello.proto）导入它：</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">"proto3"</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">"common.proto"</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">"google/protobuf/empty.proto"</span>;  <span class="comment">// 导入内置的 proto 文件</span></span><br><span class="line">option go_package = <span class="string">".;yoyoyo"</span>;  <span class="comment">// 对 Python 无影响</span></span><br><span class="line"></span><br><span class="line">message HelloRequest {</span><br><span class="line">  <span class="built_in">string</span> name = <span class="number">1</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">message HelloResponse {</span><br><span class="line">  <span class="built_in">string</span> message = <span class="number">1</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">service Hello {</span><br><span class="line">  <span class="function">rpc <span class="title">SayHello</span> <span class="params">(HelloRequest)</span> <span class="title">returns</span> <span class="params">(HelloResponse)</span> </span>{}</span><br><span class="line">  <span class="function">rpc <span class="title">Ping</span><span class="params">(google.protobuf.Empty)</span> <span class="title">returns</span> <span class="params">(Pong)</span></span>;</span><br><span class="line">}</span><br><span class="line"><span class="comment">// 注意到 google.protobuf.Empty 是我们从内置的 proto 文件中导入的，Pong 我们定义在 common.proto 文件中</span></span><br><span class="line"><span class="comment">// 但是我们将它们所在的文件都 import 进来了，所以可以直接使用</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight protobuf"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">"proto3"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">option</span> go_package = <span class="string">"./;proto"</span>;</span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">Pong</span></span>{</span><br><span class="line">  <span class="built_in">string</span> id = <span class="number">1</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="嵌套的message对象-复合类型"><a href="#嵌套的message对象-复合类型" class="headerlink" title="嵌套的message对象 复合类型"></a>嵌套的message对象 复合类型</h4><p>建立三个message，同时包含复合类型（Location）和枚举类型（TripStatus）以及repeated重复类型<br>proto中的double类型转换为golang的float64,枚举类型转换为int32</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">syntax = "proto3";</span><br><span class="line">package coolcar;</span><br><span class="line">option go_package = "coolcar/proto/gen/go;trippb";</span><br><span class="line"></span><br><span class="line">message Location {</span><br><span class="line">  double latitude = 1;</span><br><span class="line">  double longitude = 2;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">enum TripStatus {</span><br><span class="line">  TS_NOT_SPECIFIED = 0;</span><br><span class="line">  NOT_STARTED = 1;</span><br><span class="line">  IN_PROGRESS = 2;</span><br><span class="line">  FINISHED = 3;</span><br><span class="line">  PAID = 4;</span><br><span class="line">}</span><br><span class="line">message Trip {</span><br><span class="line">  string start = 1;</span><br><span class="line">  string end = 2;</span><br><span class="line">  Location start_pos = 5;</span><br><span class="line">  Location end_pos = 6;</span><br><span class="line">  repeated Location path_locations = 7;</span><br><span class="line">  int64 duration_sec = 3;</span><br><span class="line">  int64 fee_cent = 4;</span><br><span class="line">  TripStatus status = 8;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>v2版本和v1命令不一样</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd car/proto</span><br><span class="line">protoc -I . --go_out=paths=source_relative:gen/go trip.proto</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Trip <span class="keyword">struct</span> {</span><br><span class="line">    state         protoimpl.MessageState</span><br><span class="line">    sizeCache     protoimpl.SizeCache</span><br><span class="line">    unknownFields protoimpl.UnknownFields</span><br><span class="line"></span><br><span class="line">    Start         <span class="keyword">string</span>      <span class="string">`protobuf:"bytes,1,opt,name=start,proto3" json:"start,omitempty"`</span></span><br><span class="line">    End           <span class="keyword">string</span>      <span class="string">`protobuf:"bytes,2,opt,name=end,proto3" json:"end,omitempty"`</span></span><br><span class="line">    StartPos      *Location   <span class="string">`protobuf:"bytes,5,opt,name=start_pos,json=startPos,proto3" json:"start_pos,omitempty"`</span></span><br><span class="line">    EndPos        *Location   <span class="string">`protobuf:"bytes,6,opt,name=end_pos,json=endPos,proto3" json:"end_pos,omitempty"`</span></span><br><span class="line">    PathLocations []*Location <span class="string">`protobuf:"bytes,7,rep,name=path_locations,json=pathLocations,proto3" json:"path_locations,omitempty"`</span></span><br><span class="line">    DurationSec   <span class="keyword">int64</span>       <span class="string">`protobuf:"varint,3,opt,name=duration_sec,json=durationSec,proto3" json:"duration_sec,omitempty"`</span></span><br><span class="line">    FeeCent       <span class="keyword">int64</span>       <span class="string">`protobuf:"varint,4,opt,name=fee_cent,json=feeCent,proto3" json:"fee_cent,omitempty"`</span></span><br><span class="line">    Status        TripStatus  <span class="string">`protobuf:"varint,8,opt,name=status,proto3,enum=coolcar.TripStatus" json:"status,omitempty"`</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Location <span class="keyword">struct</span> {</span><br><span class="line">    state         protoimpl.MessageState</span><br><span class="line">    sizeCache     protoimpl.SizeCache</span><br><span class="line">    unknownFields protoimpl.UnknownFields</span><br><span class="line"></span><br><span class="line">    Latitude  <span class="keyword">float64</span> <span class="string">`protobuf:"fixed64,1,opt,name=latitude,proto3" json:"latitude,omitempty"`</span></span><br><span class="line">    Longitude <span class="keyword">float64</span> <span class="string">`protobuf:"fixed64,2,opt,name=longitude,proto3" json:"longitude,omitempty"`</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> TripStatus <span class="keyword">int32</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    TripStatus_TS_NOT_SPECIFIED TripStatus = <span class="number">0</span></span><br><span class="line">    TripStatus_NOT_STARTED      TripStatus = <span class="number">1</span></span><br><span class="line">    TripStatus_IN_PROGRESS      TripStatus = <span class="number">2</span></span><br><span class="line">    TripStatus_FINISHED         TripStatus = <span class="number">3</span></span><br><span class="line">    TripStatus_PAID             TripStatus = <span class="number">4</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Enum value maps for TripStatus.</span></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">    TripStatus_name = <span class="keyword">map</span>[<span class="keyword">int32</span>]<span class="keyword">string</span>{</span><br><span class="line">        <span class="number">0</span>: <span class="string">"TS_NOT_SPECIFIED"</span>,</span><br><span class="line">        <span class="number">1</span>: <span class="string">"NOT_STARTED"</span>,</span><br><span class="line">        <span class="number">2</span>: <span class="string">"IN_PROGRESS"</span>,</span><br><span class="line">        <span class="number">3</span>: <span class="string">"FINISHED"</span>,</span><br><span class="line">        <span class="number">4</span>: <span class="string">"PAID"</span>,</span><br><span class="line">    }</span><br><span class="line">    TripStatus_value = <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">int32</span>{</span><br><span class="line">        <span class="string">"TS_NOT_SPECIFIED"</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="string">"NOT_STARTED"</span>:      <span class="number">1</span>,</span><br><span class="line">        <span class="string">"IN_PROGRESS"</span>:      <span class="number">2</span>,</span><br><span class="line">        <span class="string">"FINISHED"</span>:         <span class="number">3</span>,</span><br><span class="line">        <span class="string">"PAID"</span>:             <span class="number">4</span>,</span><br><span class="line">    }</span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure>

<p>复合类型为指针类型，repeated类型转换为指针切片。复合类型编译成go之后的数据类型是一个切片</p>
<p>不是字段的值是1，编号一定要相同，第一个字段是xx，第二个字段是xx，通过编号映射而不是变量名称和定义顺序</p>
<h4 id="protobuf中的-enum-枚举类型"><a href="#protobuf中的-enum-枚举类型" class="headerlink" title="protobuf中的 enum 枚举类型"></a>protobuf中的 enum 枚举类型</h4><p>字段都大写，枚举类型编译成go代码之后就变成了几个常量</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    trippb <span class="string">"OldPackageTest/car/proto/gen/go"</span></span><br><span class="line">    <span class="string">"encoding/json"</span></span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line">    <span class="string">"google.golang.org/protobuf/proto"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="comment">//1、模拟微服务和微服务之间通过gRPC传递二进制流来互相通信</span></span><br><span class="line">    trip := trippb.Trip{</span><br><span class="line">        Start:       <span class="string">"abc"</span>,</span><br><span class="line">        End:         <span class="string">"def"</span>,</span><br><span class="line">        DurationSec: <span class="number">3600</span>,</span><br><span class="line">        FeeCent:     <span class="number">10000</span>,</span><br><span class="line"></span><br><span class="line">        StartPos:&amp;trippb.Location{ <span class="comment">//必须为取地址</span></span><br><span class="line">            Latitude:<span class="number">30</span>,</span><br><span class="line">            Longitude:<span class="number">120</span>,</span><br><span class="line">        },</span><br><span class="line">        EndPos:&amp;trippb.Location{</span><br><span class="line">            Latitude:<span class="number">35</span>,</span><br><span class="line">            Longitude:<span class="number">115</span>,</span><br><span class="line">        },</span><br><span class="line"></span><br><span class="line">        PathLocations:[]*trippb.Location{ <span class="comment">//指针切片</span></span><br><span class="line">            {</span><br><span class="line">                Latitude:<span class="number">31</span>,</span><br><span class="line">                Longitude:<span class="number">119</span>,</span><br><span class="line">            },</span><br><span class="line">            {</span><br><span class="line">                Latitude:<span class="number">32</span>,</span><br><span class="line">                Longitude:<span class="number">118</span>,</span><br><span class="line">            },</span><br><span class="line">        },</span><br><span class="line">        Status:trippb.TripStatus_IN_PROGRESS, <span class="comment">// 枚举对应常量</span></span><br><span class="line">    }</span><br><span class="line">    fmt.Println(&amp;trip)</span><br><span class="line">    <span class="comment">//start:"abc" end:"def" start_pos:{latitude:30 longitude:120} end_pos:{latitude:35 longitude:115} path_locations:{latitude:31 longitude:119} path_locations:{latitude:32 longitude:118} duration_sec:3600 fee_cent:10000 status:IN_PROGRESS</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//将数据转换为二进制bianma数据，并打印出来（模拟向客户端发送数据）</span></span><br><span class="line">    b, err := proto.Marshal(&amp;trip)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    }</span><br><span class="line">    fmt.Printf(<span class="string">"%X\n"</span>, b)</span><br><span class="line">    <span class="comment">//0A03616263120364656618901C20904E2A12090000000000003E40110000000000005E403212090000000000804140110000000000C05C403A12090000000000003F40110000000000C05D403A12090000000000004040110000000000805D404002</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//将二进制数据解码回来（模拟从客户端接收数据并解析成可以使用的数据格式）</span></span><br><span class="line">    <span class="keyword">var</span> trip2 trippb.Trip</span><br><span class="line">    err = proto.Unmarshal(b, &amp;trip2)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    }</span><br><span class="line">    fmt.Println(&amp;trip2)</span><br><span class="line">    <span class="comment">// start:"abc" end:"def" start_pos:{latitude:30 longitude:120} end_pos:{latitude:35 longitude:115} path_locations:{latitude:31 longitude:119} path_locations:{latitude:32 longitude:118} duration_sec:3600 fee_cent:10000 status:IN_PROGRESS</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//2、模拟发送json数据给小程序端，因为pg.go 中结构体有json标签</span></span><br><span class="line">    c, err := json.Marshal(&amp;trip2)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    }</span><br><span class="line">    fmt.Printf(<span class="string">"%s\n"</span>, c)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"start"</span>: <span class="string">"abc"</span>,</span><br><span class="line">  <span class="attr">"end"</span>: <span class="string">"def"</span>,</span><br><span class="line">  <span class="attr">"start_pos"</span>: {</span><br><span class="line">    <span class="attr">"latitude"</span>: <span class="number">30</span>,</span><br><span class="line">    <span class="attr">"longitude"</span>: <span class="number">120</span></span><br><span class="line">  },</span><br><span class="line">  <span class="attr">"end_pos"</span>: {</span><br><span class="line">    <span class="attr">"latitude"</span>: <span class="number">35</span>,</span><br><span class="line">    <span class="attr">"longitude"</span>: <span class="number">115</span></span><br><span class="line">  },</span><br><span class="line">  <span class="attr">"path_locations"</span>: [</span><br><span class="line">    {</span><br><span class="line">      <span class="attr">"latitude"</span>: <span class="number">31</span>,</span><br><span class="line">      <span class="attr">"longitude"</span>: <span class="number">119</span></span><br><span class="line">    },</span><br><span class="line">    {</span><br><span class="line">      <span class="attr">"latitude"</span>: <span class="number">32</span>,</span><br><span class="line">      <span class="attr">"longitude"</span>: <span class="number">118</span></span><br><span class="line">    }</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"duration_sec"</span>: <span class="number">3600</span>,</span><br><span class="line">  <span class="attr">"fee_cent"</span>: <span class="number">10000</span>,</span><br><span class="line">  <span class="attr">"status"</span>: <span class="number">2</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight protobuf"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">Gender</span></span>{</span><br><span class="line">    MALE = <span class="number">0</span>;</span><br><span class="line">    FEMALE = <span class="number">1</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">HelloRequest</span> </span>{</span><br><span class="line">    Gender g = <span class="number">3</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>


<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rsp, _ := client.SayHello(context.Background(), &amp;proto_bak.HelloRequest{</span><br><span class="line">    G:    proto_bak.Gender_MALE,</span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure>

<h4 id="protobuf中的-map-枚举类型"><a href="#protobuf中的-map-枚举类型" class="headerlink" title="protobuf中的 map 枚举类型"></a>protobuf中的 map 枚举类型</h4><figure class="highlight protobuf"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">HelloRequest</span> </span>{</span><br><span class="line">    map&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt; mp = <span class="number">4</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>


<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">rsp, _ := client.SayHello(context.Background(), &amp;proto_bak.HelloRequest{</span><br><span class="line">    Mp: <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>{</span><br><span class="line">        <span class="string">"name"</span>:    <span class="string">"bobby"</span>,</span><br><span class="line">        <span class="string">"company"</span>: <span class="string">"慕课网"</span>,</span><br><span class="line">    },</span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure>

<h4 id="protobuf内置的timestamp类型"><a href="#protobuf内置的timestamp类型" class="headerlink" title="protobuf内置的timestamp类型"></a>protobuf内置的timestamp类型</h4><figure class="highlight protobuf"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">"google/protobuf/timestamp.proto"</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">HelloRequest</span> </span>{</span><br><span class="line">    google.protobuf.Timestamp addTime = <span class="number">5</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rsp, _ := client.SayHello(context.Background(), &amp;proto_bak.HelloRequest{</span><br><span class="line">    AddTime: timestamppb.New(time.Now()),</span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure>

<h4 id="可选字段"><a href="#可选字段" class="headerlink" title="可选字段"></a>可选字段</h4><p>ProtoBuf的所有字段都是可选的，每个字段都可以选择不填，不填的话他的值就是零（0/false/“”）</p>
<p>因为所有字段都是可选则，所以一个字段的值填零（数据类型的默认值，如int64的默认值0）和不填，结果是一样的。就是pb 文件的 json 标签的 <code>emitempty</code></p>
<p>所以使用proto定义一个bool类型的字段时要特别小心，有很大的风险</p>
<h3 id="定义一个服务，同时用命令生成go代码"><a href="#定义一个服务，同时用命令生成go代码" class="headerlink" title="定义一个服务，同时用命令生成go代码"></a>定义一个服务，同时用命令生成go代码</h3><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">message GetTripRequest {</span><br><span class="line">  string id = 1;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">message GetTripResponse{</span><br><span class="line">  string id = 1;</span><br><span class="line">  Trip   trip = 2;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">//定义服务</span><br><span class="line">service TripService {</span><br><span class="line">  //定义服务接口GetTrip，接收参数为 GetTripRequest，返回为GetTripResponse</span><br><span class="line">  rpc GetTrip (GetTripRequest) returns (GetTripResponse);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><a target="_blank" rel="noopener" href="https://grpc.io/docs/languages/go/quickstart/#regenerate-grpc-code">https://grpc.io/docs/languages/go/quickstart/#regenerate-grpc-code</a></p>
<p>Regenerate gRPC code<br>Before you can use the new service method, you need to recompile the updated .proto file.</p>
<p>While still in the <code>examples/helloworld</code> directory, run the following command:</p>
<figure class="highlight routeros"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">protoc <span class="attribute">--go_out</span>=. <span class="attribute">--go_opt</span>=paths=source_relative \</span><br><span class="line">    <span class="attribute">--go-grpc_out</span>=. <span class="attribute">--go-grpc_opt</span>=paths=source_relative \</span><br><span class="line">    helloworld/helloworld.proto</span><br></pre></td></tr></tbody></table></figure>

<p>This will regenerate the <code>helloworld/helloworld.pb.go</code> and <code>helloworld/helloworld_grpc.pb.go</code> files, which contain:</p>
<ul>
<li>Code for populating, serializing, and retrieving <code>HelloRequest</code> and <code>HelloReply</code> message types.</li>
<li>Generated client and server code.</li>
</ul>
<p>在<code>server/proto/</code>目录下执行命令改成:&nbsp;</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">protoc --go_out=. --go_opt=paths=source_relative --go-grpc_out=. --go-grpc_opt=paths=source_relative trip.proto</span><br><span class="line"></span><br><span class="line">protoc --go_out=paths=source_relative:gen/go --go-grpc_out=. --go-grpc_opt=paths=source_relative trip.proto​</span><br><span class="line"></span><br><span class="line">指定路径</span><br><span class="line">protoc --go_out=./gen/go --go_opt=paths=source_relative --go-grpc_out=./gen/go --go-grpc_opt=paths=source_relative trip.proto</span><br></pre></td></tr></tbody></table></figure>

<p>pb描述和rpc方法之前旧版生成是在一个文件中，新版本命令分别生成了2个文件pb和方法已经分离<br><code>protoc --go_out=. --go_opt=paths=source_relative .\proto\trip.proto</code>生成了message对应的的trip.pb.go文件，示例如下</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> TripStatus <span class="keyword">int32</span></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">  TripStatus_IS_NOT_SPECIFIED TripStatus = <span class="number">0</span></span><br><span class="line">  TripStatus_NOT_START        TripStatus = <span class="number">1</span></span><br><span class="line">  TripStatus_IN_PROGRESS      TripStatus = <span class="number">2</span></span><br><span class="line">  TripStatus_FINISHED         TripStatus = <span class="number">3</span></span><br><span class="line">  TripStatus_PAID             TripStatus = <span class="number">4</span></span><br><span class="line">  TripStatus_OVER             TripStatus = <span class="number">5</span></span><br><span class="line">)</span><br><span class="line"><span class="comment">// Enum value maps for TripStatus.</span></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">  TripStatus_name = <span class="keyword">map</span>[<span class="keyword">int32</span>]<span class="keyword">string</span>{</span><br><span class="line">    <span class="number">0</span>: <span class="string">"IS_NOT_SPECIFIED"</span>,</span><br><span class="line">    <span class="number">1</span>: <span class="string">"NOT_STARTED"</span>,</span><br><span class="line">    <span class="number">2</span>: <span class="string">"IN_PROGRESS"</span>,</span><br><span class="line">    <span class="number">3</span>: <span class="string">"FINISHED"</span>,</span><br><span class="line">    <span class="number">4</span>: <span class="string">"PAID"</span>,</span><br><span class="line">    <span class="number">5</span>: <span class="string">"OVER"</span>,</span><br><span class="line">  }</span><br><span class="line">  TripStatus_value = <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">int32</span>{</span><br><span class="line">    <span class="string">"IS_NOT_SPECIFIED"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">"NOT_STARTED"</span>:        <span class="number">1</span>,</span><br><span class="line">    <span class="string">"IN_PROGRESS"</span>:      <span class="number">2</span>,</span><br><span class="line">    <span class="string">"FINISHED"</span>:         <span class="number">3</span>,</span><br><span class="line">    <span class="string">"PAID"</span>:             <span class="number">4</span>,</span><br><span class="line">    <span class="string">"OVER"</span>:             <span class="number">5</span>,</span><br><span class="line">  }</span><br><span class="line">)</span><br><span class="line"><span class="keyword">type</span> Location <span class="keyword">struct</span> {</span><br><span class="line">    state         protoimpl.MessageState</span><br><span class="line">    sizeCache     protoimpl.SizeCache</span><br><span class="line">    unknownFields protoimpl.UnknownFields</span><br><span class="line"></span><br><span class="line">    Latitude  <span class="keyword">float64</span> <span class="string">`protobuf:"fixed64,1,opt,name=latitude,proto3" json:"latitude,omitempty"`</span></span><br><span class="line">    Longitude <span class="keyword">float64</span> <span class="string">`protobuf:"fixed64,2,opt,name=longitude,proto3" json:"longitude,omitempty"`</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><code>protoc --go-grpc_out=. --go-grpc_opt=paths=source_relative .\proto\trip.proto</code>生成了service对应的trip_grpc.pb.go文件，<br>里面分别定义了TripServiceServer和TripServiceClient两个interface，分别对应服务端和客户端</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// TripServiceClient is the client API for TripService service.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// For semantics around ctx use and closing/ending streaming RPCs, please refer to https://pkg.go.dev/google.golang.org/grpc/?tab=doc#ClientConn.NewStream.</span></span><br><span class="line"><span class="keyword">type</span> TripServiceClient <span class="keyword">interface</span> {</span><br><span class="line">    <span class="comment">//定义服务接口GetTrip，接收参数为 GetTripRequest，返回为GetTripResponse</span></span><br><span class="line">    GetTrip(ctx context.Context, in *GetTripRequest, opts ...grpc.CallOption) (*GetTripResponse, error)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// TripServiceServer is the server API for TripService service.</span></span><br><span class="line"><span class="comment">// All implementations must embed UnimplementedTripServiceServer</span></span><br><span class="line"><span class="comment">// for forward compatibility</span></span><br><span class="line"><span class="keyword">type</span> TripServiceServer <span class="keyword">interface</span> {</span><br><span class="line">    <span class="comment">//定义服务接口GetTrip，接收参数为 GetTripRequest，返回为GetTripResponse</span></span><br><span class="line">    GetTrip(context.Context, *GetTripRequest) (*GetTripResponse, error)</span><br><span class="line">    mustEmbedUnimplementedTripServiceServer()</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>旧版</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">protoc -I . --go_out=plugins=grpc,paths=source_relative:gen/go trip.proto</span><br></pre></td></tr></tbody></table></figure>

<p><code>need method: GetTrip(context.Context, *GetTripRequest) (*Trip, error)</code></p>
<p><code>have method: GetTrip(c context.Context, req *trippb.GetTripRequest) (*trippb.GetTripResponse, error)</code></p>
<p>也就是说，GetTrip在proto里定义的是返回Trip，而我们在代码里返回的是GetTripResponse。<br>这边的确我在设计的时候就有反复，两种做法都是可以的，最终我的做法是返回Trip。</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    trippb <span class="string">"OldPackageTest/car/proto/gen/go"</span></span><br><span class="line">    <span class="string">"context"</span></span><br><span class="line">    <span class="comment">//trippb "coolcar/proto/gen/go"</span></span><br><span class="line">    <span class="comment">//trip "OldPackageTest/car/tripservice"</span></span><br><span class="line">    <span class="string">"log"</span></span><br><span class="line">    <span class="string">"net"</span></span><br><span class="line"></span><br><span class="line">    <span class="string">"google.golang.org/grpc"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Server <span class="keyword">struct</span>{</span><br><span class="line">    <span class="comment">// 把 trippb.UnimplementedTripServiceServer 结构体组合(继承)到自己定义的结构体中</span></span><br><span class="line">    trippb.UnimplementedTripServiceServer <span class="comment">// 实现了 trippb.TripServiceServer 接口</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实现GetTrip接口</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(*Server)</span> <span class="title">GetTrip</span><span class="params">(c context.Context, req *trippb.GetTripRequest)</span> <span class="params">(*trippb.GetTripResponse, error)</span></span> {</span><br><span class="line">    <span class="keyword">return</span> &amp;trippb.GetTripResponse{</span><br><span class="line">        Id: req.Id,</span><br><span class="line">        Trip: &amp;trippb.Trip{</span><br><span class="line">            Start:       <span class="string">"abc"</span>,</span><br><span class="line">            End:         <span class="string">"def"</span>,</span><br><span class="line">            DurationSec: <span class="number">3600</span>,</span><br><span class="line">            FeeCent:     <span class="number">10000</span>,</span><br><span class="line">            StartPos: &amp;trippb.Location{</span><br><span class="line">                Latitude:  <span class="number">30</span>,</span><br><span class="line">                Longitude: <span class="number">120</span>,</span><br><span class="line">            },</span><br><span class="line">            EndPos: &amp;trippb.Location{</span><br><span class="line">                Latitude:  <span class="number">35</span>,</span><br><span class="line">                Longitude: <span class="number">120</span>,</span><br><span class="line">            },</span><br><span class="line">            PathLocations: []*trippb.Location{</span><br><span class="line">                {</span><br><span class="line">                    Latitude:  <span class="number">35</span>,</span><br><span class="line">                    Longitude: <span class="number">120</span>,</span><br><span class="line">                },</span><br><span class="line">                {</span><br><span class="line">                    Latitude:  <span class="number">35</span>,</span><br><span class="line">                    Longitude: <span class="number">120</span>,</span><br><span class="line">                },</span><br><span class="line">            },</span><br><span class="line">            Status: trippb.TripStatus_IN_PROGRESS,</span><br><span class="line">        },</span><br><span class="line">    }, <span class="literal">nil</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">//该代码只是用来判断服务是否都实现</span></span><br><span class="line"><span class="keyword">var</span> _ tripPb.TripServiceServer = &amp;Server{}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    lis, err := net.Listen(<span class="string">"tcp"</span>, <span class="string">":8081"</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">        log.Fatalf(<span class="string">"failed to listen: %v"</span>, err) <span class="comment">// 输出完程序就退出</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    s := grpc.NewServer()</span><br><span class="line">    trippb.RegisterTripServiceServer(s, &amp;Server{})</span><br><span class="line">    log.Fatal(s.Serve(lis))</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>


<p>客户端</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    trippb <span class="string">"OldPackageTest/car/proto/gen/go"</span></span><br><span class="line">    <span class="string">"context"</span></span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"log"</span></span><br><span class="line"></span><br><span class="line">    <span class="string">"google.golang.org/grpc"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    conn, err := grpc.Dial(<span class="string">"localhost:8081"</span>, grpc.WithInsecure())</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">        log.Fatalf(<span class="string">"cannot connect server: %v"</span>, err)</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    tsClient := trippb.NewTripServiceClient(conn)</span><br><span class="line">    r, err := tsClient.GetTrip(context.Background(), &amp;trippb.GetTripRequest{</span><br><span class="line">        Id: <span class="string">"trip456,hello"</span>,</span><br><span class="line">    })</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">        log.Fatalf(<span class="string">"cannot call GetTrip: %v"</span>, err)</span><br><span class="line">    }</span><br><span class="line">    fmt.Println(r)</span><br><span class="line">}</span><br><span class="line">---</span><br><span class="line">id:<span class="string">"trip456,hello"</span> trip:{start:<span class="string">"abc"</span> end:<span class="string">"def"</span> start_pos:{latitude:<span class="number">30</span> longitude:<span class="number">120</span>} end_pos:{latitude:<span class="number">35</span> longitude:<span class="number">120</span>} path_locations:{latitude:<span class="number">35</span> longitude:<span class="number">120</span>} path_locations:{latitude:<span class="number">35</span> longitude:<span class="number">120</span>} duration_sec:<span class="number">3600</span> fee_cent:<span class="number">10000</span> status:IN_PROGRESS}</span><br></pre></td></tr></tbody></table></figure>

<p>client发送了一个值为<code>trip456,hello</code>的id个服务端，服务器原样返回给客户端了</p>
<h3 id="grpcgateway"><a href="#grpcgateway" class="headerlink" title="grpcgateway"></a>grpcgateway</h3><p>使用 http/json 来访问grpc<br>用GRPC Gateway暴露REST接口</p>
<p>/protp/trip.yaml</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">type:</span> <span class="string">google.api.Service</span></span><br><span class="line"><span class="attr">config_version:</span> <span class="number">3</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">http:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">selector:</span> <span class="string">coolcar.TripService.GetTrip</span> <span class="comment"># proto 文件 package.service.func</span></span><br><span class="line">      <span class="attr">get:</span> <span class="string">/trip/{id}</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> xxx/proto</span><br><span class="line">protoc --go_out=plugins=grpc,paths=source_relative:gen/go trip.proto</span><br><span class="line">protoc --grpc-gateway_out=paths=source_relative,grpc_api_configuration=trip.yaml:gen/go trip.proto</span><br></pre></td></tr></tbody></table></figure>

<p>会在gen/go中多一个trip.pb.gw.go文件</p>
<p>服务端</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    trippb <span class="string">"OldPackageTest/car/proto/gen/go"</span></span><br><span class="line">    <span class="string">"context"</span></span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"github.com/grpc-ecosystem/grpc-gateway/v2/runtime"</span></span><br><span class="line">    <span class="string">"net/http"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//trippb "coolcar/proto/gen/go"</span></span><br><span class="line">    <span class="comment">//trip "OldPackageTest/car/tripservice"</span></span><br><span class="line">    <span class="string">"log"</span></span><br><span class="line">    <span class="string">"net"</span></span><br><span class="line"></span><br><span class="line">    <span class="string">"google.golang.org/grpc"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Server <span class="keyword">struct</span>{</span><br><span class="line">    <span class="comment">// 把 trippb.UnimplementedTripServiceServer 结构体组合(继承)到自己定义的结构体中</span></span><br><span class="line">    trippb.UnimplementedTripServiceServer <span class="comment">// 实现了 trippb.TripServiceServer 接口</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(*Server)</span> <span class="title">GetTrip</span><span class="params">(c context.Context, req *trippb.GetTripRequest)</span> <span class="params">(*trippb.GetTripResponse, error)</span></span> {</span><br><span class="line">    <span class="keyword">return</span> &amp;trippb.GetTripResponse{</span><br><span class="line">        Id: req.Id,</span><br><span class="line">        Trip: &amp;trippb.Trip{</span><br><span class="line">            Start:       <span class="string">"abc"</span>,</span><br><span class="line">            End:         <span class="string">"def"</span>,</span><br><span class="line">            DurationSec: <span class="number">3600</span>,</span><br><span class="line">            FeeCent:     <span class="number">10000</span>,</span><br><span class="line">            StartPos: &amp;trippb.Location{</span><br><span class="line">                Latitude:  <span class="number">30</span>,</span><br><span class="line">                Longitude: <span class="number">120</span>,</span><br><span class="line">            },</span><br><span class="line">            EndPos: &amp;trippb.Location{</span><br><span class="line">                Latitude:  <span class="number">35</span>,</span><br><span class="line">                Longitude: <span class="number">120</span>,</span><br><span class="line">            },</span><br><span class="line">            PathLocations: []*trippb.Location{</span><br><span class="line">                {</span><br><span class="line">                    Latitude:  <span class="number">35</span>,</span><br><span class="line">                    Longitude: <span class="number">120</span>,</span><br><span class="line">                },</span><br><span class="line">                {</span><br><span class="line">                    Latitude:  <span class="number">35</span>,</span><br><span class="line">                    Longitude: <span class="number">120</span>,</span><br><span class="line">                },</span><br><span class="line">            },</span><br><span class="line">            Status: trippb.TripStatus_IN_PROGRESS,</span><br><span class="line">        },</span><br><span class="line">    }, <span class="literal">nil</span></span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    log.SetFlags(log.Lshortfile)</span><br><span class="line">    fmt.Println(<span class="string">"service is runing"</span>)</span><br><span class="line">    <span class="keyword">go</span> startGRPCGateway()</span><br><span class="line"></span><br><span class="line">    lis, err := net.Listen(<span class="string">"tcp"</span>, <span class="string">":8081"</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">        log.Fatalf(<span class="string">"failed to listen: %v"</span>, err) <span class="comment">// 输出完程序就退出</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    s := grpc.NewServer()</span><br><span class="line">    trippb.RegisterTripServiceServer(s, &amp;Server{})</span><br><span class="line">    log.Fatal(s.Serve(lis))</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">startGRPCGateway</span><span class="params">()</span></span> {</span><br><span class="line">    c := context.Background()</span><br><span class="line">    c, cancel := context.WithCancel(c)</span><br><span class="line">    <span class="keyword">defer</span> cancel()</span><br><span class="line"></span><br><span class="line">    mux := runtime.NewServeMux()</span><br><span class="line">    err := trippb.RegisterTripServiceHandlerFromEndpoint(</span><br><span class="line">        c,</span><br><span class="line">        mux,</span><br><span class="line">        <span class="string">"localhost:8081"</span>,</span><br><span class="line">        []grpc.DialOption{grpc.WithInsecure()},</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">        log.Fatalf(<span class="string">"cannot start grpc gateway: %v"</span>, err)</span><br><span class="line">    }</span><br><span class="line">    err = http.ListenAndServe(<span class="string">":8080"</span>, mux)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">        log.Fatalf(<span class="string">"cannot listen and server: %v"</span>, err)</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>运行客户端</p>
<p>可以在浏览器输入 <a target="_blank" rel="noopener" href="http://localhost:8080/trip/123">http://localhost:8080/trip/123</a>或者用curl 命令</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">curl http://localhost:8080/trip/123</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">StatusCode        : 200</span><br><span class="line">StatusDescription : OK</span><br><span class="line">Content           : {"id":"123", "trip":{"start":"abc", "end":"def", "startPos":{"latitude":30, "longitude":120}, "endPos":{"latitude":35, "longitude":120}, "path</span><br><span class="line">                    Locations":[{"latitude":35, "longitude":120}, {"latitude":...</span><br><span class="line">RawContent        : HTTP/1.1 200 OK</span><br><span class="line">                    Grpc-Metadata-Content-Type: application/grpc</span><br><span class="line">                    Content-Length: 288</span><br><span class="line">                    Content-Type: application/json</span><br><span class="line">                    Date: Tue, 19 Oct 2021 09:24:43 GMT</span><br><span class="line"></span><br><span class="line">                    {"id":"123", "trip":{"start":"abc", "end":"de...</span><br><span class="line">Forms             : {}</span><br><span class="line">Headers           : {[Grpc-Metadata-Content-Type, application/grpc], [Content-Length, 288], [Content-Type, application/json], [Date, Tue, 19 Oct 2021 09:24:43 GMT</span><br><span class="line">                    ]}</span><br><span class="line">Images            : {}</span><br><span class="line">InputFields       : {}</span><br><span class="line">Links             : {}</span><br><span class="line">ParsedHtml        : mshtml.HTMLDocumentClass</span><br><span class="line">RawContentLength  : 288</span><br></pre></td></tr></tbody></table></figure>

<h4 id="grpc配合asyncio使用-23-58"><a href="#grpc配合asyncio使用-23-58" class="headerlink" title="grpc配合asyncio使用 (23:58)"></a>grpc配合asyncio使用 (23:58)</h4><p>client 终端输出</p>
<figure class="highlight ebnf"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">hello bobby</span></span><br></pre></td></tr></tbody></table></figure>

<p>server 终端输出</p>
<figure class="highlight asciidoc"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">get metadata error</span><br><span class="line"><span class="meta">[bobby]</span></span><br><span class="line">0 bobby</span><br><span class="line"></span><br><span class="line"><span class="meta">:authority [127.0.0.1:50051]</span></span><br><span class="line"><span class="meta">content-type</span> [application/grpc]</span><br><span class="line">user-agent [grpc-go/1.41.0]</span><br><span class="line">name [bobby]</span><br><span class="line">pasword [imooc]</span><br></pre></td></tr></tbody></table></figure>

<h4 id="grpc的metadata机制-go-21-35"><a href="#grpc的metadata机制-go-21-35" class="headerlink" title="grpc的metadata机制-go (21:35)"></a>grpc的metadata机制-go (21:35)</h4><p>python操作metada (10:05)<br>grpc拦截器 - go (21:18)<br>python实现grpc的拦截器 (11:56)<br>通过拦截器和metadata实现grpc的auth认证 (17:50)<br>grpc的验证器 (32:11)<br>grpc中的错误处理 (25:31)<br>grpc的超时机制 (07:10)</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/10/02/go-bian-yi/" rel="prev" title="Go 进程的启动过程、调度循环和GPM">
                  <i class="fa fa-chevron-left"></i> Go 进程的启动过程、调度循环和GPM
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2021/10/07/windows-sheng-cheng-xiang-mu-mu-lu-jie-gou/" rel="next" title="Windows生成项目目录结构">
                  Windows生成项目目录结构 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">外心人D</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  




  





</body>
</html>
