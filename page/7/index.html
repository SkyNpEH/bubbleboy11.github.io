<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.0.2">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"bubbleboy11.github.io","root":"/","images":"/images","scheme":"Muse","version":"8.6.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>
<meta name="description" content="本博客大多内容为慕课和网上博客，并非原创">
<meta property="og:type" content="website">
<meta property="og:title" content="外心人D的博客">
<meta property="og:url" content="https://bubbleboy11.github.io/page/7/index.html">
<meta property="og:site_name" content="外心人D的博客">
<meta property="og:description" content="本博客大多内容为慕课和网上博客，并非原创">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="外心人D">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://bubbleboy11.github.io/page/7/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/7/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>外心人D的博客</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="外心人D的博客" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism.css" type="text/css"></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">外心人D的博客</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-overview">
            <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">外心人D</p>
  <div class="site-description" itemprop="description">本博客大多内容为慕课和网上博客，并非原创</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">341</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">24</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">40</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



          </div>
        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/06/10/drf-gou-wu-che/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/06/10/drf-gou-wu-che/" class="post-title-link" itemprop="url">drf购物车</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-06-09 16:21:41" itemprop="dateCreated datePublished" datetime="2021-06-09T16:21:41Z">2021-06-09</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-06-17 07:28:50" itemprop="dateModified" datetime="2021-06-17T07:28:50Z">2021-06-17</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/django/" itemprop="url" rel="index"><span itemprop="name">django</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>商品详情页添加商品到购物车，就可以把商品加入到数据库【创建】。<br>对于购物车已存在的商品，如果将商品重复加入购物车，或者减少商品数量，就将它的数量进行加减【更新】。<br>购物车也支持对商品进行删除【删除】，以及列表展示【查询】。</p>
<p>综上，购物车就需要用到mixins中的所有功能。</p>
<p>修改购物车数量功能实现</p>
<p>如果用户对某个商品添加到购物车，之后再对该商品进行重复添加，再向购物车添加同一个商品，不希望得到验证说这个商品已经存在，而是希望在当前数量上加1，那么是需要将购物车中的数据进行修改，也就是当前用户的购物车中的每一种商品都是唯一的，那么修改一下models，为其增加联合唯一的限定。</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ShoppingCart</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    购物车</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    user = models.ForeignKey(User, verbose_name=<span class="string">'用户'</span>, help_text=<span class="string">'用户'</span>, on_delete=models.CASCADE, related_name=<span class="string">'shopping_carts'</span>)</span><br><span class="line">    goods = models.ForeignKey(Goods, verbose_name=<span class="string">'商品'</span>, help_text=<span class="string">'商品'</span>, on_delete=models.CASCADE)</span><br><span class="line">    nums = models.IntegerField(default=<span class="number">0</span>, verbose_name=<span class="string">'购买数量'</span>, help_text=<span class="string">'购买数量'</span>)</span><br><span class="line">    add_time = models.DateTimeField(auto_now_add=<span class="literal">True</span>, verbose_name=<span class="string">'添加时间'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        verbose_name_plural = verbose_name = <span class="string">'购物车'</span></span><br><span class="line">        unique_together = [<span class="string">'user'</span>, <span class="string">'goods'</span>]  <span class="comment"># 用户和商品联合唯一</span></span><br></pre></td></tr></tbody></table></figure>

<p>如果使用的是<code>serializers.ModelSerializer</code>，<br>模型中定义了<code>unique_together = ['user', 'goods']</code>，进行validate时就会抛出异常，<br>就算是重写<code>def create(self, validated_data)</code>方法也是无效的，因为在进行该方法前，就已经进行了validate。<br><code>ShoppingCartViewSet</code>继承的是<code>viewsets.ModelViewSet</code>，在这里面有个<code>mixins.CreateModelMixin</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CreateModelMixin</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Create a model instance.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        serializer = self.get_serializer(data=request.data)</span><br><span class="line">        serializer.is_valid(raise_exception=<span class="literal">True</span>)</span><br><span class="line">        self.perform_create(serializer)</span><br><span class="line">        headers = self.get_success_headers(serializer.data)</span><br><span class="line">        <span class="keyword">return</span> Response(serializer.data, status=status.HTTP_201_CREATED, headers=headers)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">perform_create</span>(<span class="params">self, serializer</span>):</span></span><br><span class="line">        serializer.save()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_success_headers</span>(<span class="params">self, data</span>):</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> {<span class="string">'Location'</span>: str(data[api_settings.URL_FIELD_NAME])}</span><br><span class="line">        <span class="keyword">except</span> (TypeError, KeyError):</span><br><span class="line">            <span class="keyword">return</span> {}</span><br></pre></td></tr></tbody></table></figure>

<p>这个<code>CreateModelMixin</code>在<code>create</code>的时候首先会调用<code>serializer.is_valid(raise_exception=True)</code>，<br>接下来会调用<code>self.perform_create(serializer)</code>执行数据保存<code>serializer.save()</code>，<br>因为在<code>ModelSerializer</code>中的<code>create()</code>方法会因为插入数据时重复而验证不通过导致抛出异常，无法继续执行，所以是无法保存成功的。</p>
<p>当然，我们也可以重写<code>CreateModelMixin</code>中的<code>create</code>的方法，就可以控制该方法的所有步骤。<br>如果不用<code>serializer</code>，那么它的验证功能就享受不到了，不用<code>serializer</code>做，就需要在views中去完成；另外生成文档的时候，字段是从<code>serializer</code>中取得，如果不用那么文档的功能就缺失了。</p>
<p>在定义序列化的<code>ShoppingCartSerializer</code>继承自<code>Serializer</code>而不能继承自<code>ModelSerializer</code>，自己来做validate，自己重写<code>create()</code>实现<code>save</code>功能，</p>
<p>用户在添加购物车时，也就是在数据库中添加一条记录。还要分为两种情况，<br>当购物车数据库中没有这个商品时，执行添加；<br>当已存在该商品时，执行数量更新。</p>
<p><code>validated_data</code>也就是上方定义的字段传过来之前已经处理好的数据，例如，<code>nums</code>如果数量为负数，那么该数据到不了<code>create()</code>方法。</p>
<p>而Serializer又继承自<code>BaseSerializer</code>，<code>BaseSerializer</code>中声明了<code>update(instance, validated_data)</code>方法但是直接抛出异常，</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 源码：rest_framework.serializers.BaseSerializer#update</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">update</span>(<span class="params">self, instance, validated_data</span>):</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError(<span class="string">'`update()` must be implemented.'</span>)</span><br></pre></td></tr></tbody></table></figure>

<p>并且Serializer中并未重写<code>update()</code>方法，因此如果在<code>ShoppingCartSerializer</code>中不重写该方法会导致在修改购物车详情时会抛出上面的异常，如果继承自<code>ModelSerializer</code>则有该方法不需要重写，在<code>ShoppingCartSerializer</code>中重写<code>update(instance, validated_data)</code>方法</p>
<p><code>trade/serializer.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> ShoppingCart</span><br><span class="line"><span class="keyword">from</span> goods.models <span class="keyword">import</span> Goods</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ShoppingCartSerializer</span>(<span class="params">serializers.Serializer</span>):</span></span><br><span class="line">    <span class="comment"># 表示user为隐藏字段，默认为获取当前登录用</span></span><br><span class="line">    user = serializers.HiddenField(default=serializers.CurrentUserDefault())</span><br><span class="line">    nums = serializers.IntegerField(required=<span class="literal">True</span>, min_value=<span class="number">1</span>, label=<span class="string">'数量'</span>,</span><br><span class="line">                                    error_messages={</span><br><span class="line">                                        <span class="string">'required'</span>: <span class="string">'请选择商品数量'</span>,</span><br><span class="line">                                        <span class="string">'min_value'</span>: <span class="string">'商品数量至少为1'</span></span><br><span class="line">                                    })</span><br><span class="line">    <span class="comment"># 这里是继承Serializer，必须指定queryset对象，如果继承ModelSerializer则不需要指定</span></span><br><span class="line">    <span class="comment"># goods是一个外键，可以通过这方法获取goods object中所有的值</span></span><br><span class="line">    goods = serializers.PrimaryKeyRelatedField(required=<span class="literal">True</span>, queryset=Goods.objects.filter(is_delete=<span class="literal">False</span>))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">self, validated_data</span>):</span></span><br><span class="line">        <span class="string">'''</span></span><br><span class="line"><span class="string">        反序列化保存数据</span></span><br><span class="line"><span class="string">        :param validated_data:上方定义的字段传过来之前已经验证过的dict类型数据</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        '''</span></span><br><span class="line">        <span class="comment"># 获取当前用户</span></span><br><span class="line">        <span class="comment"># view中:self.request.user；</span></span><br><span class="line">        <span class="comment"># serizlizer中:self.context["request"].user</span></span><br><span class="line">        user = self.context[<span class="string">'request'</span>].user</span><br><span class="line">        nums = validated_data[<span class="string">'nums'</span>]</span><br><span class="line">        goods = validated_data[<span class="string">'goods'</span>]</span><br><span class="line">        existed = ShoppingCart.objects.filter(is_delete=<span class="literal">False</span>, user=user, goods=goods)</span><br><span class="line">        <span class="keyword">if</span> existed:  <span class="comment"># 如果购物车中有记录</span></span><br><span class="line">            existed = existed[<span class="number">0</span>]</span><br><span class="line">            existed.nums += nums</span><br><span class="line">            existed.save()  <span class="comment"># queryset结果集的save方法</span></span><br><span class="line">        <span class="keyword">else</span>:  <span class="comment"># 如果购物车车没有记录，添加到购物车</span></span><br><span class="line">            existed = ShoppingCart.objects.create(**validated_data)</span><br><span class="line">        <span class="keyword">return</span> existed</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">update</span>(<span class="params">self, instance, validated_data</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        修改购物车商品数量</span></span><br><span class="line"><span class="string">        :param instance: 要更新的对象实例</span></span><br><span class="line"><span class="string">        :param validated_data: </span></span><br><span class="line"><span class="string">        :return: </span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        instance.nums = validated_data[<span class="string">'nums'</span>]</span><br><span class="line">        instance.save()  <span class="comment"># 模型类对象的save方法</span></span><br><span class="line">        <span class="keyword">return</span> instance</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ShoppingCartListSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="comment"># 购物车中除了有商品的id，但要显示商品的图片、名称、单价等信息。</span></span><br><span class="line">    goods = GoodsSerializer(many=<span class="literal">False</span>)  <span class="comment"># 一个购物车对应一个商品，默认many=False，也就是可以不写</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = ShoppingCart</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br></pre></td></tr></tbody></table></figure>

<p><code>apps/trade/views.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> viewsets</span><br><span class="line"><span class="keyword">from</span> rest_framework.permissions <span class="keyword">import</span> IsAuthenticated</span><br><span class="line"><span class="keyword">from</span> rest_framework_simplejwt.authentication <span class="keyword">import</span> JWTAuthentication</span><br><span class="line"><span class="keyword">from</span> rest_framework.authentication <span class="keyword">import</span> SessionAuthentication</span><br><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> ShopCartSerializer</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> ShoppingCart</span><br><span class="line"><span class="keyword">from</span> utils.permissions <span class="keyword">import</span> IsOwnerOrReadOnly</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ShoppingCartViewSet</span>(<span class="params">viewsets.ModelViewSet</span>):</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    list:</span></span><br><span class="line"><span class="string">        获取购物车列表</span></span><br><span class="line"><span class="string">    create:</span></span><br><span class="line"><span class="string">        添加商品到购物车</span></span><br><span class="line"><span class="string">    update:</span></span><br><span class="line"><span class="string">        更新购物车商品数量</span></span><br><span class="line"><span class="string">    delete:</span></span><br><span class="line"><span class="string">        从购物车中删除商品</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    queryset = ShoppingCart.objects.filter(is_delete=<span class="literal">False</span>)</span><br><span class="line">    permission_classes = [IsAuthenticated, IsOwnerOrReadOnly]  <span class="comment"># 用户必须登录才能访问</span></span><br><span class="line">    authentication_classes = [JWTAuthentication, SessionAuthentication]  <span class="comment"># 配置登录认证：支持JWT认证和DRF基本认证</span></span><br><span class="line">    <span class="comment"># serializer_class = ShoppingCartSerializer  # 使用get_serializer_class()，这个就不需要了</span></span><br><span class="line">    lookup_field = <span class="string">'goods_id'</span>  <span class="comment"># 单个模型实例的对象查找的模型字段，即查询单一数据库对象时使用的条件字段，默认为pk，即主键，并根据该字段进行查询就可以获取到该记录。</span></span><br><span class="line">    <span class="comment"># 不再是根据ShoppingCart的主键id进行查找，</span></span><br><span class="line">    <span class="comment"># 由于每个用户的购物车商品都是唯一的，</span></span><br><span class="line">    <span class="comment"># 在数据接口中直接传入商品id</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_serializer_class</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.action == <span class="string">'list'</span>:</span><br><span class="line">            <span class="comment"># 当获取购物车列表时，使用ModelSerializer，可以显示购物车商品详情</span></span><br><span class="line">            <span class="keyword">return</span> ShoppingCartListSerializer</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> ShoppingCartSerializer</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_queryset</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># 只能显示当前用户的购物车列表</span></span><br><span class="line">        <span class="keyword">return</span> ShoppingCart.objects.filter(user=self.request.user, is_delete=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">perform_create</span>(<span class="params">self, serializer</span>):</span></span><br><span class="line">        <span class="string">'''创建购物车更新库存量'''</span></span><br><span class="line">        shop_cart = serializer.save()</span><br><span class="line">        goods = shop_cart.goods</span><br><span class="line">        goods.goods_num -= shop_cart.nums</span><br><span class="line">        goods.save()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">perform_destroy</span>(<span class="params">self, instance</span>):</span></span><br><span class="line">        <span class="string">'''删除购物车更新库存量'''</span></span><br><span class="line">        goods = instance.goods</span><br><span class="line">        goods.goods_num += instance.nums</span><br><span class="line">        goods.save()</span><br><span class="line">        instance.delete()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">perform_update</span>(<span class="params">self, serializer</span>):</span></span><br><span class="line">        <span class="string">'''修改购物车更新库存量'''</span></span><br><span class="line">        existed_record = ShoppingCart.objects.filter(is_delete=<span class="literal">False</span>).get(id=serializer.instance.id)</span><br><span class="line">        existed_nums = existed_record.nums</span><br><span class="line">        saved_record = serializer.save()</span><br><span class="line">        nums = saved_record.nums - existed_nums</span><br><span class="line">        goods = saved_record.goods</span><br><span class="line">        goods.goods_num -= nums</span><br><span class="line">        goods.save()</span><br></pre></td></tr></tbody></table></figure>

<p><code>url.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">router.register(<span class="string">'shopcarts'</span>, ShoppingCartViewSet)</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/06/10/drf-gou-wu-che/0.jpeg" alt="description"><br><img src="/2021/06/10/drf-gou-wu-che/1.png" alt="description"><br><img src="/2021/06/10/drf-gou-wu-che/2.png" alt="description"><br><img src="/2021/06/10/drf-gou-wu-che/3.png" alt="description"><br><img src="/2021/06/10/drf-gou-wu-che/4.png" alt="description"><br><img src="/2021/06/10/drf-gou-wu-che/5.png" alt="description"><br><img src="/2021/06/10/drf-gou-wu-che/6.png" alt="description"></p>
<h2 id="商品库存数量"><a href="#商品库存数量" class="headerlink" title="商品库存数量"></a>商品库存数量</h2><p>商品库存数量的行为：</p>
<ul>
<li>新增商品到购物车</li>
<li>修改购物车数量</li>
<li>删除购物车记录</li>
<li>订单取消，库存增加</li>
</ul>
<p>新增商品到购物车重写<code>CreateModelMixin</code>类的<code>perform_create(serializer)</code>方法，<br>修改购物车数量重写<code>UpdateModelMixin</code>类的<code>perform_update(serializer)</code>方法，<br>删除购物车记录重写<code>DestroyModelMixin</code>类的<code>perform_destroy(instance)</code>方法，如下：</p>
<p><code>trade/views.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ShoppingCartViewSet</span>(<span class="params">viewsets.ModelViewSet</span>):</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    list:</span></span><br><span class="line"><span class="string">        获取购物车列表</span></span><br><span class="line"><span class="string">    create:</span></span><br><span class="line"><span class="string">        添加商品到购物车</span></span><br><span class="line"><span class="string">    update:</span></span><br><span class="line"><span class="string">        更新购物车商品数量</span></span><br><span class="line"><span class="string">    delete:</span></span><br><span class="line"><span class="string">        从购物车中删除商品</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    queryset = ShoppingCart.objects.filter(is_delete=<span class="literal">False</span>)</span><br><span class="line">    permission_classes = [IsAuthenticated, IsOwnerOrReadOnly]  <span class="comment"># 用户必须登录才能访问</span></span><br><span class="line">    authentication_classes = [JWTAuthentication, SessionAuthentication]  <span class="comment"># 配置登录认证：支持JWT认证和DRF基本认证</span></span><br><span class="line">    <span class="comment"># serializer_class = ShoppingCartSerializer  # 使用get_serializer_class()，这个就不需要了</span></span><br><span class="line">    lookup_field = <span class="string">'goods_id'</span>  <span class="comment"># 单个模型实例的对象查找的模型字段，即查询单一数据库对象时使用的条件字段，默认为pk，即主键</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 不再是根据ShoppingCart的主键id进行查找，</span></span><br><span class="line">    <span class="comment"># 在数据接口中就可以直接传入商品id并根据该字段进行查询</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_serializer_class</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.action == <span class="string">'list'</span>:</span><br><span class="line">            <span class="comment"># 当获取购物车列表时，使用ModelSerializer，可以显示购物车商品详情</span></span><br><span class="line">            <span class="keyword">return</span> ShoppingCartListSerializer</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> ShoppingCartSerializer</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_queryset</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># 只能显示当前用户的购物车列表</span></span><br><span class="line">        <span class="keyword">return</span> ShoppingCart.objects.filter(user=self.request.user, is_delete=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">perform_create</span>(<span class="params">self, serializer</span>):</span></span><br><span class="line">        <span class="string">'''添加到购物车，库存量减少'''</span></span><br><span class="line">        shop_cart = serializer.save()</span><br><span class="line">        goods = shop_cart.goods</span><br><span class="line">        goods.goods_num -= shop_cart.nums</span><br><span class="line">        goods.save()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">perform_destroy</span>(<span class="params">self, instance</span>):</span></span><br><span class="line">        <span class="string">'''删除购物车，库存量增加'''</span></span><br><span class="line">        goods = instance.goods</span><br><span class="line">        goods.goods_num += instance.nums</span><br><span class="line">        goods.save()</span><br><span class="line">        instance.delete()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">perform_update</span>(<span class="params">self, serializer</span>):</span></span><br><span class="line">        <span class="string">'''修改购物车更新库存量'''</span></span><br><span class="line">        existed_record = ShoppingCart.objects.filter(is_delete=<span class="literal">False</span>).get(id=serializer.instance.id)</span><br><span class="line">        <span class="comment"># 获取购物车中该商品修改之前的库存数量</span></span><br><span class="line">        existed_nums = existed_record.nums</span><br><span class="line">        saved_record = serializer.save()</span><br><span class="line">        <span class="comment"># 现在的数量减去以前的数量</span></span><br><span class="line">        diff_nums = saved_record.nums - existed_nums</span><br><span class="line">        goods = saved_record.goods</span><br><span class="line">        <span class="comment"># 得到商品对象，更改库存量</span></span><br><span class="line">        goods.goods_num -= diff_nums</span><br><span class="line">        goods.save()</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/06/10/drf-gou-wu-che/7.png" alt="description"><br>添加3个到购物车<br><img src="/2021/06/10/drf-gou-wu-che/8.png" alt="description"><br><img src="/2021/06/10/drf-gou-wu-che/9.png" alt="description"><br><img src="/2021/06/10/drf-gou-wu-che/10.png" alt="description"><br>修改购物车中的数量</p>
<p>从购物车删除该商品<br>库存量恢复到10<br><img src="/2021/06/10/drf-gou-wu-che/11.png" alt="description"></p>
<p>用户下单后，将购物车中的商品放到订单商品中。订单一旦取消，商品并未返回购物车，所以，需要将库存数量修改。</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderInfoViewSet</span>(<span class="params">mixins.CreateModelMixin, mixins.ListModelMixin, mixins.RetrieveModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                       mixins.DestroyModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                       viewsets.GenericViewSet</span>):</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    订单管理，不能修改，不需要继承自UpdateModelMixin</span></span><br><span class="line"><span class="string">    list:</span></span><br><span class="line"><span class="string">        订单列表</span></span><br><span class="line"><span class="string">    retrieve:</span></span><br><span class="line"><span class="string">        订单详情</span></span><br><span class="line"><span class="string">    delete:</span></span><br><span class="line"><span class="string">        删除订单</span></span><br><span class="line"><span class="string">    create:</span></span><br><span class="line"><span class="string">        新增订单</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    queryset = OrderInfo.objects.all()</span><br><span class="line">    permission_classes = [IsAuthenticated, IsOwnerOrReadOnly]  <span class="comment"># 用户必须登录才能访问</span></span><br><span class="line">    authentication_classes = [JWTAuthentication, SessionAuthentication]  <span class="comment"># 配置登录认证：支持JWT认证和DRF基本认证</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># serializer_class = OrderListSerializer</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_queryset</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> OrderInfo.objects.filter(user=self.request.user, is_delete=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_serializer_class</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.action == <span class="string">'retrieve'</span>:</span><br><span class="line">            <span class="keyword">return</span> OrderDetailSerializer</span><br><span class="line">        <span class="keyword">return</span> OrderListSerializer</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">perform_destroy</span>(<span class="params">self, instance</span>):</span></span><br><span class="line">        <span class="comment"># 取消（删除）商品库存量增加</span></span><br><span class="line">        <span class="keyword">for</span> order_goods <span class="keyword">in</span> instance.goods.all():</span><br><span class="line">            goods = order_goods.goods</span><br><span class="line">            <span class="comment"># 获取订单商品的数量，修改库存量</span></span><br><span class="line">            goods.goods_num += order_goods.goods_num</span><br><span class="line">            goods.save()</span><br><span class="line">        instance.delete()</span><br></pre></td></tr></tbody></table></figure>

<h2 id="商品销量"><a href="#商品销量" class="headerlink" title="商品销量"></a>商品销量</h2><p>只有在支付成功后才会更新</p>
<p><code>trade/views.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AliPayView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    通知验证 支付宝的返回</span></span><br><span class="line"><span class="string">    get:</span></span><br><span class="line"><span class="string">        处理支付宝return_url请求</span></span><br><span class="line"><span class="string">    post:</span></span><br><span class="line"><span class="string">        处理支付宝notify_url请求</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        处理支付宝的notify_url 验签处理订单状态</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="comment"># 请求参数（假设是POST请求）中包括订单号、支付流水号、交易金额和签名</span></span><br><span class="line">        data = dict(request.POST.items())</span><br><span class="line">        <span class="comment"># 把sign pop掉，文档有说明</span></span><br><span class="line">        signature = data.pop(<span class="string">"sign"</span>, <span class="literal">None</span>)</span><br><span class="line">        <span class="comment"># 调用验证操作</span></span><br><span class="line">        success = self.alipay.verify(data, signature)</span><br><span class="line">        order_sn = data.get(<span class="string">'out_trade_no'</span>, <span class="literal">None</span>)  <span class="comment"># 原支付请求的商户订单号</span></span><br><span class="line">        trade_status = self.alipay.api_alipay_trade_query(out_trade_no=order_sn).get(<span class="string">"trade_status"</span>, <span class="literal">None</span>)</span><br><span class="line">        <span class="keyword">if</span> success <span class="keyword">and</span> trade_status <span class="keyword">in</span> (<span class="string">"TRADE_SUCCESS"</span>, <span class="string">"TRADE_FINISHED"</span>):</span><br><span class="line">            trade_no = data.get(<span class="string">'trade_no'</span>, <span class="literal">None</span>)  <span class="comment"># 支付宝交易凭证号</span></span><br><span class="line">            <span class="comment"># 订单商品</span></span><br><span class="line">            existed_orders = OrderInfo.objects.filter(order_sn=order_sn, is_delete=<span class="literal">False</span>)</span><br><span class="line">            print(len(existed_orders))</span><br><span class="line">            <span class="keyword">if</span> existed_orders:</span><br><span class="line">                <span class="keyword">for</span> order <span class="keyword">in</span> existed_orders:</span><br><span class="line">                    order_goods = order.goods.all()</span><br><span class="line">                    <span class="comment"># 商品销量增加订单中数值</span></span><br><span class="line">                    <span class="keyword">for</span> order_good <span class="keyword">in</span> order_goods:</span><br><span class="line">                        <span class="comment"># 获取订单中商品</span></span><br><span class="line">                        goods = order_good.goods</span><br><span class="line">                        <span class="comment"># 销量根据订单商品数量增加增加</span></span><br><span class="line">                        goods.sold_num += order_good.goods_num</span><br><span class="line">                        goods.save()</span><br><span class="line">                    <span class="comment"># 更新数据库订单状态</span></span><br><span class="line">                    order.pay_status = trade_status</span><br><span class="line">                    order.trade_no = trade_no</span><br><span class="line">                    order.pay_time = datetime.now()</span><br><span class="line">                    order.save()</span><br><span class="line">                response = HttpResponseRedirect(<span class="string">'http://127.0.0.1:8080/#/app/home/member/order'</span>)</span><br><span class="line">                response.set_cookie(<span class="string">'nextPath'</span>, <span class="string">'pay'</span>, max_age=<span class="number">2</span>)</span><br><span class="line">                print(<span class="string">'cookie'</span>, response.cookies)</span><br><span class="line">                <span class="keyword">return</span> response</span><br><span class="line">        <span class="keyword">return</span> HttpResponseRedirect(<span class="string">'http://127.0.0.1:8080/#/app/shoppingcart/cart'</span>)</span><br></pre></td></tr></tbody></table></figure>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/06/07/pycharm-shang-chuan-wen-jian-dao-linux/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/06/07/pycharm-shang-chuan-wen-jian-dao-linux/" class="post-title-link" itemprop="url">pycharm上传文件到linux</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-06-06 16:21:41" itemprop="dateCreated datePublished" datetime="2021-06-06T16:21:41Z">2021-06-06</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-06-10 05:43:46" itemprop="dateModified" datetime="2021-06-10T05:43:46Z">2021-06-10</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/django/" itemprop="url" rel="index"><span itemprop="name">django</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>pycharm Tools-Deployment-configuration- SFTP</p>
<p>最下面的Web server root URL是该项目在部署后的链接，点击open可打开该项目。Root path是指定自动上传到linux服务器的路径，这里就选择测试主机的/root目录。</p>
<p>选择要上传的目录或文件，出现高亮，Tools-Deployment</p>
<p>传递映射路径的是相对路径，不是把文件传到根路径，保持原来的目录结构，会创建所在的文件夹<br>可以upload到服务器，download到本地，sync同步</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-0-9-centos ~]<span class="comment"># cd /root/project/mxshop_srvs/</span></span><br><span class="line">[root@VM-0-9-centos mxshop_srvs]<span class="comment"># ls</span></span><br><span class="line">order_srv</span><br><span class="line">[root@VM-0-9-centos mxshop_srvs]<span class="comment"># cd order_srv/</span></span><br><span class="line">[root@VM-0-9-centos order_srv]<span class="comment"># ls</span></span><br><span class="line">install.zip</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-0-9-centos order_srv]<span class="comment"># unzip install.zip</span></span><br><span class="line">Archive:  install.zip</span><br><span class="line">  inflating: install/README.md</span><br><span class="line">   creating: install/conf/</span><br><span class="line">  inflating: install/conf/broker.conf</span><br><span class="line">  inflating: install/docker-compose.yml</span><br><span class="line">[root@VM-0-9-centos order_srv]<span class="comment"># ls</span></span><br><span class="line">install  install.zip</span><br><span class="line">[root@VM-0-9-centos order_srv]<span class="comment"># cd install/</span></span><br><span class="line">[root@VM-0-9-centos install]<span class="comment"># ls</span></span><br><span class="line">conf  docker-compose.yml  README.md</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/06/07/pycharm-shang-chuan-wen-jian-dao-linux/1.png" alt="description"></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/06/05/drf-fan-xu-lie-hua-yan-zheng/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/06/05/drf-fan-xu-lie-hua-yan-zheng/" class="post-title-link" itemprop="url">drf反序列化验证</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-06-04 16:21:41" itemprop="dateCreated datePublished" datetime="2021-06-04T16:21:41Z">2021-06-04</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-07-29 08:13:34" itemprop="dateModified" datetime="2021-07-29T08:13:34Z">2021-07-29</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/django/" itemprop="url" rel="index"><span itemprop="name">django</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ul>
<li>验证处理：反序列化，前端post传递过来的dict类型数据放在<code>request.data</code> 的时候，要把他转换成模型类实例进行保存到数据表，对前端提交的数据进行验证</li>
</ul>
<h3 id="字段选项验证"><a href="#字段选项验证" class="headerlink" title="字段选项验证"></a>字段选项验证</h3><p>在定义序列化器时，指明每个字段的序列化类型和选项参数，本身就是一种验证行为。<br><code>required</code>、<code>max_length</code>、<code>min_length</code> <code>allow_blank</code>是否允许为空<br><code>trim_whitespace</code>是否截断空白字符<br><code>max_value</code> 最小值<br><code>min_value</code> 最大值等验证方式，<br><code>default</code></p>
<h3 id="在序列化器或字段类上编写自定义显式验证方法，"><a href="#在序列化器或字段类上编写自定义显式验证方法，" class="headerlink" title="在序列化器或字段类上编写自定义显式验证方法，"></a>在序列化器或字段类上编写自定义显式验证方法，</h3><ul>
<li><p>自定义单一字段验证，函数名必须：<code>validate_&lt;field_name&gt;</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">validate_code</span>(<span class="params">self, code</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    自定义单一字段验证，函数名必须：validate + _ + 验证字段名</span></span><br><span class="line"><span class="string">    验证验证码</span></span><br><span class="line"><span class="string">    形参名随便写</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># 用户以post方式提交注册信息，前端post的数据都保存在initial_data里面</span></span><br><span class="line">    <span class="comment"># username就是用户注册的手机号，</span></span><br><span class="line">    <span class="comment"># 验证码按添加时间倒序排序，为了后面验证过期，错误等</span></span><br><span class="line">    verify_records = VerifyCode.objects.filter(mobile=self.initial_data[<span class="string">"username"</span>]).order_by(<span class="string">"-add_time"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> verify_records:  <span class="comment"># 验证验证码是否存在</span></span><br><span class="line">        <span class="comment"># 最近的一个验证码</span></span><br><span class="line">        last_record = verify_records[<span class="number">0</span>]</span><br><span class="line">        <span class="comment"># 获取5分钟以前的时间</span></span><br><span class="line">        five_mintes_ago = datetime.now() - timedelta(hours=<span class="number">0</span>, minutes=<span class="number">5</span>, seconds=<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">if</span> five_mintes_ago &gt; last_record.add_time:</span><br><span class="line">            <span class="keyword">raise</span> serializers.ValidationError(<span class="string">"验证码过期"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> last_record.code != code:</span><br><span class="line">            <span class="keyword">raise</span> serializers.ValidationError(<span class="string">"验证码错误"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> serializers.ValidationError(<span class="string">"验证码错误"</span>)</span><br><span class="line">    <span class="keyword">return</span> code</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>多个字段同时验证，函数名必须：<code>validate(self, attrs):</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">validate</span>(<span class="params">self, attrs</span>):</span></span><br><span class="line">  <span class="string">"""</span></span><br><span class="line"><span class="string">  多个字段验证，函数名必须：validate</span></span><br><span class="line"><span class="string">  :param attrs: 所有字段验证合法之后返回的所有字段的dict，形参名随便写</span></span><br><span class="line"><span class="string">  :return:</span></span><br><span class="line"><span class="string">  """</span></span><br><span class="line">  <span class="comment"># 人为设定前端传递到后端的手机号数据变量名为username而非mobile</span></span><br><span class="line">  <span class="comment"># 把`username`的值赋值给`mobile`的值。</span></span><br><span class="line">  attrs[<span class="string">"mobile"</span>] = attrs[<span class="string">"username"</span>]</span><br><span class="line">  <span class="comment"># code字段只是为了验证临时生成的、不需要保存到用户数据表中，因此在验证之后需要删除</span></span><br><span class="line">  <span class="keyword">del</span> attrs[<span class="string">"code"</span>]</span><br><span class="line">  <span class="keyword">return</span> attrs</span><br></pre></td></tr></tbody></table></figure>

</li>
</ul>
<h3 id="在视图中验证"><a href="#在视图中验证" class="headerlink" title="在视图中验证"></a>在视图中验证</h3><p>生成序列化器对象，<code>serializer=UserDetailSerializer()</code>或者<code>get_serializer_class</code>的<code>return get_serializer_class</code><br>调用<code>serializer.is_valid()</code>验证成功返回True，否则返回False。<br>在验证失败时抛出异常serializers.ValidationError，可以通过传递raise_exception=True参数开启，REST framework接收到此异常，会向前端返回HTTP 400 Bad Request响应。<br>调用<code>serializer.errors</code> 查看验证状态信息，如果验证成功，返回一个空字典，失败，返回一个有字段和字段的错误的字典<br>调用<code>serializer.validated_data</code>获取验证后的字段dict类型数据</p>
<p>We now use single-step object creation, like so:</p>
<ol>
<li>Validating the data makes the cleaned data available as <code>serializer.validated_data</code>.</li>
<li>Calling <code>serializer.save()</code> then saves and returns the new object instance.</li>
</ol>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Modelviewset</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserViewSet</span>(<span class="params">CreateModelMixin</span>):</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    create:</span></span><br><span class="line"><span class="string">        创建添加一用户，用户注册成功携带token登录</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    queryset = User.objects.filter(is_delete=<span class="literal">False</span>)</span><br><span class="line">    <span class="comment"># serializer_class = UserSerializer  # 改用get_serializer_class</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="string">"""注册后自动登录需要携带token"""</span></span><br><span class="line">        serializer = self.get_serializer(data=request.data)</span><br><span class="line">        serializer.is_valid(raise_exception=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_serializer_class</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        动态选择用哪个序列化方式</span></span><br><span class="line"><span class="string">        1.UserSerializer（用户注册），只返回username和mobile，会员中心页面需要显示更多字段，</span></span><br><span class="line"><span class="string">        所以要创建一个UserDetailSerializer</span></span><br><span class="line"><span class="string">        2.问题又来了，如果注册的使用userdetailSerializer，又会导致验证失败，所以需要动态的使用serializer</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> self.action == <span class="string">"retrieve"</span>:</span><br><span class="line">            <span class="keyword">return</span> UserDetailSerializer</span><br><span class="line">        <span class="keyword">elif</span> self.action == <span class="string">"create"</span>:</span><br><span class="line">            <span class="keyword">return</span> UserSerializer</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> UserDetailSerializer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># view</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Books</span>(<span class="params">View</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        <span class="comment"># 1、获取前端数据</span></span><br><span class="line">        data = request.body.decode()</span><br><span class="line">        data_dict = json.loads(data)</span><br><span class="line">        <span class="comment"># 2、验证数据</span></span><br><span class="line">        ser = BookSerialzier(data=data_dict)</span><br><span class="line">        ser.is_valid()  <span class="comment"># 验证方法</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="DRF还提供了专业的验证器validators"><a href="#DRF还提供了专业的验证器validators" class="headerlink" title="DRF还提供了专业的验证器validators"></a>DRF还提供了专业的验证器<code>validators</code></h3><p><a target="_blank" rel="noopener" href="https://www.django-rest-framework.org/api-guide/validators/">https://www.django-rest-framework.org/api-guide/validators/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.django-rest-framework.org/api-guide/validators/#uniquevalidator">https://www.django-rest-framework.org/api-guide/validators/#uniquevalidator</a></p>
<p>Validation in REST framework</p>
<p>Validation in Django REST framework serializers is handled a little differently to how validation works in Django’s ModelForm class.</p>
<p>With ModelForm the validation is performed partially on the form, and partially on the model instance. With REST framework the validation is performed entirely on the serializer class. This is advantageous for the following reasons:</p>
<p>It introduces a proper separation of concerns, making your code behavior more obvious.<br>It is easy to switch between using shortcut ModelSerializer classes and using explicit Serializer classes. Any validation behavior being used for ModelSerializer is simple to replicate.<br>Printing the repr of a serializer instance will show you exactly what validation rules it applies. There’s no extra hidden validation behavior being called on the model instance.<br>When you’re using ModelSerializer all of this is handled automatically for you. If you want to drop down to using Serializer classes instead, then you need to define the validation rules explicitly.</p>
<ul>
<li><p><code>UniqueValidator</code><br>This validator can be used to enforce the <code>unique=True</code> constraint on model fields. It takes a single required argument, and an optional <code>messages</code> argument:对模型字段强制<code>unique=True</code>约束。它接受一个必需的参数和一个可选的消息参数:</p>
<ul>
<li><p><code>queryset</code> required - This is the queryset against which uniqueness should be enforced.必须的，这是应该强制惟一性的queryset</p>
</li>
<li><p><code>message</code> - The error message that should be used when validation fails.验证失败时应该使用的错误消息。</p>
</li>
<li><p><code>lookup</code> - The lookup used to find an existing instance with the value being validated. Defaults to ‘exact’.<br>用于查找正在验证值的现有实例。默认为“精确”。</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.validators <span class="keyword">import</span> UniqueValidator</span><br><span class="line"></span><br><span class="line">slug = SlugField(</span><br><span class="line">    max_length=<span class="number">100</span>,</span><br><span class="line">    validators=[UniqueValidator(queryset=BlogPost.objects.all())]</span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
</li>
<li><p><code>UniqueTogetherValidator</code><br>This validator can be used to enforce <code>unique_together</code> constraints on model instances. 验证器可用于对模型实例强制<code>unique_together</code>约束。<br>It has two required arguments, and a single optional <code>messages</code> argument:它有两个必需的参数和一个可选的消息参数:</p>
<ul>
<li><p><code>queryset</code> required - This is the queryset against which uniqueness should be enforced.强制惟一性的queryset</p>
</li>
<li><p><code>fields</code> required - A list or tuple of field names which should make a unique set. These must exist as fields on the serializer class.段名的列表或元组，应该构成一个惟一的集合。这些字段必须作为字段存在于序列化器类中。</p>
</li>
<li><p><code>message</code> - The error message that should be used when validation fails.验证失败时应该使用的错误消息</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.validators <span class="keyword">import</span> UniqueTogetherValidator</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExampleSerializer</span>(<span class="params">serializers.Serializer</span>):</span></span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        <span class="comment"># ToDo items belong to a parent list, and have an ordering defined</span></span><br><span class="line">        <span class="comment"># by the 'position' field. No two items in a given list may share the same position.</span></span><br><span class="line">        validators = [</span><br><span class="line">            UniqueTogetherValidator(</span><br><span class="line">                queryset=ToDoItem.objects.all(),</span><br><span class="line">                fields=[<span class="string">'list'</span>, <span class="string">'position'</span>]</span><br><span class="line">            )</span><br><span class="line">        ]</span><br></pre></td></tr></tbody></table></figure>

</li>
</ul>
</li>
</ul>
<p>Note: The <code>UniqueTogetherValidator</code> class always imposes an implicit constraint that all the fields it applies to are always treated as required. Fields with <code>default</code> values are an exception to this as they always supply a value even when omitted from user input.<br>注意：<code>UniqueTogetherValidation</code>类总是施加一个隐式的约束，它所应用的所有字段总是按需要处理。具有默认值的字段是一个例外，因为它们总是提供一个值，即使在用户输入中省略了这个值。</p>
<p>以上<code>validators</code>不是作用域某个字段之上了，需要写在<code>Meta</code>中，因为<code>UniqueTogetherValidator</code>是作用域两个或两个字段以上的，不是针对一个字段，所以需要写在这。</p>
<ul>
<li><code>UniqueForDateValidator</code></li>
</ul>
<h3 id="Advanced-field-defaults"><a href="#Advanced-field-defaults" class="headerlink" title="Advanced field defaults"></a><code>Advanced field defaults</code></h3><p><a target="_blank" rel="noopener" href="https://www.django-rest-framework.org/api-guide/validators/#advanced-field-defaults">https://www.django-rest-framework.org/api-guide/validators/#advanced-field-defaults</a></p>
<p>Validators that are applied across multiple fields in the serializer can sometimes require a field input that should not be provided by the API client, but that is available as input to the validator.<br>在序列化器中跨多个字段应用的验证器有时可能需要一个字段输入，这个字段不应该由API客户机提供，但是可以作为验证器的输入。</p>
<p>Two patterns that you may want to use for this sort of validation include:<br>可能想要使用两种模式来进行这种验证:</p>
<ul>
<li><p>Using <code>HiddenField</code>. This field will be present in <code>validated_data</code> but will not be used in the serializer output representation.<br>使用<code>HiddenField</code>隐藏字段，该字段将出现在<code>validated_data</code>中，但序列化输出时不会显示出来</p>
</li>
<li><p>Using a standard field with <code>read_only=True</code>, but that also includes a <code>default=…</code> argument. This field will be used in the serializer output representation, but cannot be set directly by the user.<br>使用带有<code>read_only=True</code>的标准字段，但该字段也包含一个<code>default=…</code>参数。此字段将在序列化器输出表示中使用，但不能由用户直接设置。</p>
</li>
</ul>
<p>REST framework includes a couple of defaults that may be useful in this context.REST框架包含一些缺省值，这些缺省值在此上下文中可能很有用。</p>
<h4 id="CurrentUserDefault"><a href="#CurrentUserDefault" class="headerlink" title="CurrentUserDefault"></a><code>CurrentUserDefault</code></h4><p>A default class that can be used to represent the current user. In order to use this,<br>the ‘request’ must have been provided as part of the context dictionary when instantiating the serializer.<br>可用于表示当前用户的默认类。为了使用它，在实例化序列化器时，request必须作为上下文字典的一部分提供</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookInfoSerializer</span>(<span class="params">serializers.Serializer</span>):</span></span><br><span class="line">    <span class="string">"""图书数据序列化器"""</span></span><br><span class="line">    id = serializers.IntegerField(label=<span class="string">'ID'</span>, read_only=<span class="literal">True</span>)</span><br><span class="line">    btitle = serializers.CharField(label=<span class="string">'名称'</span>, max_length=<span class="number">20</span>)</span><br><span class="line">    bpub_date = serializers.DateField(label=<span class="string">'发布日期'</span>, required=<span class="literal">False</span>)</span><br><span class="line">    bread = serializers.IntegerField(label=<span class="string">'阅读量'</span>, required=<span class="literal">False</span>)</span><br><span class="line">    bcomment = serializers.IntegerField(label=<span class="string">'评论量'</span>, required=<span class="literal">False</span>)</span><br><span class="line">    image = serializers.ImageField(label=<span class="string">'图片'</span>, required=<span class="literal">False</span>)</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> booktest.serializers <span class="keyword">import</span> BookInfoSerializer</span><br><span class="line">data = {<span class="string">'bpub_date'</span>: <span class="number">123</span>}</span><br><span class="line">serializer = BookInfoSerializer(data=data)</span><br><span class="line">serializer.is_valid()  <span class="comment"># 返回False</span></span><br><span class="line">serializer.errors</span><br><span class="line"><span class="comment"># {'btitle': [ErrorDetail(string='This field is required.', code='required')], 'bpub_date': [ErrorDetail(string='Date has wrong format. Use one of these formats instead: YYYY[-MM[-DD]].', code='invalid')]}</span></span><br><span class="line">serializer.validated_data  <span class="comment"># {}</span></span><br><span class="line"></span><br><span class="line">data = {<span class="string">'btitle'</span>: <span class="string">'python'</span>}</span><br><span class="line">serializer = BookInfoSerializer(data=data)</span><br><span class="line">serializer.is_valid()  <span class="comment"># True</span></span><br><span class="line">serializer.errors  <span class="comment"># {}</span></span><br><span class="line">serializer.validated_data  <span class="comment">#  OrderedDict([('btitle', 'python')])</span></span><br></pre></td></tr></tbody></table></figure><script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/05/31/beego/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/31/beego/" class="post-title-link" itemprop="url">beego</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-05-30 16:21:41" itemprop="dateCreated datePublished" datetime="2021-05-30T16:21:41Z">2021-05-30</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-07-08 05:53:15" itemprop="dateModified" datetime="2021-07-08T05:53:15Z">2021-07-08</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/beego/" itemprop="url" rel="index"><span itemprop="name">beego</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>不要用clash的terminal</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">go get -u github.com/beego/beego/v2</span><br><span class="line">go get -u github.com/beego/bee/v2</span><br><span class="line">bee version</span><br></pre></td></tr></tbody></table></figure>

<p>Bee主要命令<br><code>bee new project_name</code>新建一个 Web 项目</p>
<p>bee工具创建的项目结构<br>conf  : 保存了项目的一些配置信息<br>controllers : 保存MVC中的控制器<br>models : 保存MVC中的模型<br>views 保存MVC中的视图<br>routers : 保存了项目的路由<br>static : 保存了项目中的静态资源 images .css .js<br>tests : 保存测试用例<br>main.go : 项目的入口文件</p>
<p><code>bee api apiproject</code>创建 API 应用的，和 Web 项目相比，少了 static 和 views 目录，多了一个 test 模块，用来做单元测试的</p>
<p><code>bee run</code> 运行监控 beego 的项目</p>
<p><code>bee pack</code> 发布应用的时候打包，会把项目打包成 zip 包，这样我们部署的时候直接把打包之后的项目上传，解压就可以部署</p>
<p>注意：<code>bee pack -be GOOS=linux</code><br>MAC下打的包是不能再linux执行的，需要制定参数</p>
<h3 id="Beego项目的执行流程"><a href="#Beego项目的执行流程" class="headerlink" title="Beego项目的执行流程"></a>Beego项目的执行流程</h3><p>5.1客户端发起请求<br><a target="_blank" rel="noopener" href="http://127.0.0.1:8080/">http://127.0.0.1:8080/</a><br>5.2执行项目的路由相关代码, 找到处理对应请求的控制器<br>beego.Router(“/“, &amp;controllers.MainController{})<br>5.3执行控制器对应的方法<br>默认会根据请求类型找到对应的请求方法Get/Post方法<br>5.4在对应的方法中处理业务逻辑, 返回对应的界面<br>c.TplName = “index.tpl” // 返回对应的界面<br>5.5客户端显示对应的界面</p>
<p>先把入门看了<br><a target="_blank" rel="noopener" href="https://beego.me/quickstart">https://beego.me/quickstart</a></p>
<p>命令行进行编译并执行</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"github.com/beego/beego/v2/server/web"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> MainController <span class="keyword">struct</span> {</span><br><span class="line">    web.Controller</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(this *MainController)</span> <span class="title">Get</span><span class="params">()</span></span> {</span><br><span class="line">    this.Ctx.WriteString(<span class="string">"hello world"</span>)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    web.Router(<span class="string">"/"</span>, &amp;MainController{})</span><br><span class="line">    web.Run()</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ go build -o hello hello.go</span><br><span class="line">$ ./hello</span><br></pre></td></tr></tbody></table></figure>

<ol>
<li><p>首先我们导入了包 <code>github.com/beego/beego/v2/server/web</code>。我们知道 Go 语言里面被导入的包会按照<strong>深度优先</strong>的顺序去执行导入包的初始化（变量和 init 函数，更多详情），beego 包中会初始化一个 BeeAPP 的应用和一些参数。</p>
</li>
<li><p>定义 Controller，这里我们定义了一个 <code>struct</code> 为 M<code>ainController</code>，充分利用了 Go 语言的组合的概念，匿名包含了 <code>web.Controller</code>，这样我们的 <code>MainController</code> 就拥有了 <code>web.Controller</code> 的所有方法。</p>
</li>
<li><p>定义 RESTful 方法，通过匿名组合之后，其实目前的 <code>MainController</code> 已经拥有了 <code>Get</code>、<code>Post</code>、<code>Delete</code>、<code>Put</code> 等方法，这些方法是分别用来对应用户请求的 Method 函数，<br>如果用户发起的是 POST 请求，那么就执行 Post 函数。<br>所以这里我们定义了 <code>MainController</code> 的 <code>Get</code> 方法用来重写继承的 <code>Get</code> 函数，这样当用户发起 GET 请求的时候就会执行该函数。</p>
</li>
<li><p>定义 <code>main</code> 函数，所有的 Go 应用程序和 C 语言一样都是 main 函数作为入口，所以我们这里定义了我们应用的入口。</p>
</li>
<li><p>Router 注册路由，路由就是告诉 beego，当用户来请求的时候，该如何去调用相应的 Controller，这里我们注册了请求 <code>/</code> 的时候，请求到 <code>MainController</code>。这里我们需要知道，Router 函数的两个参数函数，第一个是路径，第二个是 Controller 的指针。</p>
</li>
<li><p>Run 应用，最后一步就是把在步骤 1 中初始化的 BeeApp 开启起来，其实就是内部监听了 8080 端口：Go 默认情况会监听你本机所有的 IP 上面的 8080 端口。</p>
</li>
</ol>
<p><code>URLMapping</code> 新增加的函数，用户如果没有进行注册，那么就会通过反射来执行对应的函数，如果注册了就会通过 interface 来进行执行函数，性能上面会提升很多</p>
<h3 id="路由设置"><a href="#路由设置" class="headerlink" title="路由设置"></a>路由设置</h3><p>v1是<code>beego.Router</code><br>v2是<code>web.Router</code></p>
<p>有两种方式：</p>
<h4 id="在router-go中配置"><a href="#在router-go中配置" class="headerlink" title="在router.go中配置"></a>在<code>router.go</code>中配置</h4><p><code>default.go</code></p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 浏览器输出Hello World</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *MainController)</span> <span class="title">GetHello</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        title <span class="keyword">string</span></span><br><span class="line">    )</span><br><span class="line">    title = <span class="string">"Hello world"</span></span><br><span class="line">    c.Ctx.WriteString(title)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><code>router.go</code></p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> {</span><br><span class="line">    web.Router(<span class="string">"/hello"</span>, &amp;controllers.MainController{}, <span class="string">"get:GetHello"</span>)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/05/31/beego/1.png" alt="description"></p>
<h4 id="在router-go中include引入，直接在函数上方配置规则"><a href="#在router-go中include引入，直接在函数上方配置规则" class="headerlink" title="在router.go中include引入，直接在函数上方配置规则"></a>在<code>router.go</code>中<code>include</code>引入，直接在函数上方配置规则</h4><p><code>demo.go</code></p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 输出Hello World!</span></span><br><span class="line"><span class="comment">// @router /demo/hello [get]</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(this *DemoController)</span> <span class="title">GetHello</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        title <span class="keyword">string</span></span><br><span class="line">    )</span><br><span class="line">    title = <span class="string">"Hello World!"</span></span><br><span class="line">    this.Ctx.WriteString(title)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><code>router.go</code>注册路由</p>
<p>controller 的 method 方法上面须有 router 注释（// @router），</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> {</span><br><span class="line">    web.Include(&amp;controllers.DemoController{})</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/05/31/beego/2.png" alt="description"></p>
<h3 id="MVC模式"><a href="#MVC模式" class="headerlink" title="MVC模式"></a>MVC模式</h3><p>在目录下有 controllers models views 文件夹分别存放controller文件，model文件和模板文件。<br>后面项目中用到的文件都会分别在这三个文件夹中</p>
<p>过滤器，<br>进行安全验证，访问用户中心的时候，<br>进行是否登录的判断可以在过滤器中，<br>也可以实现屏蔽IP的功能，<br>屏蔽黑名单的功能等等，对项目有整体的规则时，<br>都可以在过滤器中实现，不用在每个函数中来实现了</p>
<p>过滤器是通过<code>beego.insertfilter(pattern string, positon int, filter FilterFunc, skip ...bool)</code>函数来实现的</p>
<p><code>router.go</code></p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="comment">// 这里是屏蔽规则，包含demo/的url都走过滤规则屏蔽；</span></span><br><span class="line">    <span class="comment">// 第二个参数是BeforeRouter，在寻找加载路由之前</span></span><br><span class="line">    <span class="comment">// 第三个参数是要执行的函数名。</span></span><br><span class="line">    <span class="keyword">var</span> FilterDemo = <span class="function"><span class="keyword">func</span><span class="params">(ctx *context.Context)</span></span> {</span><br><span class="line">        <span class="keyword">var</span> (</span><br><span class="line">            title <span class="keyword">string</span></span><br><span class="line">        )</span><br><span class="line">        title = <span class="string">"禁止访问"</span></span><br><span class="line">        ctx.WriteString(title)</span><br><span class="line">    }</span><br><span class="line">    web.InsertFilter(<span class="string">"/demo/*"</span>, web.BeforeRouter, FilterDemo)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/05/31/beego/3.png" alt="description"></p>
<h3 id="配置信息"><a href="#配置信息" class="headerlink" title="配置信息"></a>配置信息</h3><p>beego提供了专门配置文件，配置信息定义在conf文件夹中的app.conf</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">appname = fyouku // 项目名称</span><br><span class="line">httpport = 8098  // 访问端口号</span><br><span class="line">runmode = dev    // 运行环境，下面会根据运行环境加载不同配置</span><br><span class="line"></span><br><span class="line">[dev]  // 开发环境</span><br><span class="line">apiurl = http://127.0.0.1:8099</span><br><span class="line">microApi = http://127.0.0.1:8085</span><br><span class="line">defaultdb = root:123456@(127.0.0.1:3306)/fyouku?charset=utf8</span><br><span class="line">redisdb = 127.0.0.1:6379</span><br><span class="line">rabbitmq = amqp://guest:guest@127.0.0.1:5672/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[prod]  // 线上环境</span><br><span class="line">apiurl = http://127.0.0.1:8099</span><br><span class="line">microApi = http://127.0.0.1:8085</span><br><span class="line">defaultdb = root:123456@(127.0.0.1:3306)/fyouku?charset=utf8</span><br><span class="line">redisdb = 127.0.0.1:6379</span><br><span class="line">rabbitmq = amqp://guest:guest@127.0.0.1:5672/</span><br></pre></td></tr></tbody></table></figure>

<p>静态文件</p>
<p>项目中的css、js、img文件都是怎样访问的，bee new创建的项目中有static文件夹，这是beego默认注册的静态文件处理目录</p>
<figure class="highlight actionscript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">├── <span class="keyword">static</span></span><br><span class="line">    │   ├── css</span><br><span class="line">    │   ├── img</span><br><span class="line">    │   └── js</span><br></pre></td></tr></tbody></table></figure>
<p>访问地址为：<a target="_blank" rel="noopener" href="http://127.0.0.1:8080/static/js/fyouku.js">http://127.0.0.1:8080/static/js/fyouku.js</a></p>
<p>也可以通过下面命令来自定义目录</p>
<figure class="highlight less"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">beego</span><span class="selector-class">.SetStaticPath</span>(<span class="string">"/down1"</span>, <span class="string">"download1"</span>)</span><br></pre></td></tr></tbody></table></figure>

<p>view语法</p>
<ul>
<li>统一使用 作为左右标签</li>
<li><code>.</code> 访问当前位置的上下文</li>
<li><code>$</code> 引用当前模板根级的上下文</li>
<li><code>$var</code> 访问创建的变量</li>
</ul>
<p>判断语句 <code>if ... else ... end</code></p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">{{if eq .IsEmail 1}}</span><br><span class="line">    &lt;a class="email" href="mailto:{{.Email}}"&gt;{{.Email}}&lt;/a&gt;</span><br><span class="line">{{else}}</span><br><span class="line">    &lt;a class="email" href="#"&gt;不允许访问Email&lt;/a&gt;</span><br><span class="line">{{end}}</span><br></pre></td></tr></tbody></table></figure>

<p>循环语句 range</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">{{range $index,$value := .Pages}}</span><br><span class="line">    {{$index}} - {{$value.Num}} of {{$.Website}}</span><br><span class="line">    &lt;br&gt;</span><br><span class="line">{{end}}</span><br></pre></td></tr></tbody></table></figure>

<p>载入其它模板</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">{{template "head.html" .}}</span><br></pre></td></tr></tbody></table></figure>

<p>指定首页的模板</p>
<p><code>controllers/default.go</code></p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *MainController)</span> <span class="title">Get</span><span class="params">()</span></span> {</span><br><span class="line">    c.Data[<span class="string">"Website"</span>] = <span class="string">"beego.me"</span></span><br><span class="line">    c.Data[<span class="string">"Email"</span>] = <span class="string">"astaxie@gmail.com"</span></span><br><span class="line">    c.Data[<span class="string">"IsEmail"</span>] = <span class="number">1</span></span><br><span class="line">    c.TplName = <span class="string">"index.tpl"</span></span><br><span class="line">    pages := []<span class="keyword">struct</span> {</span><br><span class="line">        Num <span class="keyword">int</span></span><br><span class="line">    }{{<span class="number">10</span>}, {<span class="number">20</span>}, {<span class="number">30</span>}}</span><br><span class="line">    c.Data[<span class="string">"Pages"</span>] = pages</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><code>views/footer.tpl</code></p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;footer&gt;</span><br><span class="line">  &lt;div class="author"&gt;</span><br><span class="line">    demo Official website:</span><br><span class="line">    &lt;a href="http://{{.Website}}"&gt;{{.Website}}&lt;/a&gt; /</span><br><span class="line">    Contact me:</span><br><span class="line">    {{if eq .IsEmail 1}}</span><br><span class="line">      &lt;a class="email" href="mailto:{{.Email}}"&gt;{{.Email}}&lt;/a&gt;</span><br><span class="line">    {{else}}</span><br><span class="line">          &lt;a class="email" href="mailto:{{.Email}}"&gt;禁止显示&lt;/a&gt;</span><br><span class="line">    {{end}}</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/footer&gt;</span><br></pre></td></tr></tbody></table></figure>

<p><code>views/index.tpl</code></p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">  &lt;header&gt;</span><br><span class="line">    &lt;h1 class="logo"&gt;Welcome to Beego&lt;/h1&gt;</span><br><span class="line">    &lt;div class="description"&gt;</span><br><span class="line">      Beego is a simple &amp; powerful Go web framework which is inspired by tornado and sinatra.</span><br><span class="line">      {{range $index, $value := .Pages}}</span><br><span class="line">      &lt;br&gt;</span><br><span class="line">      {{$index}} - {{$value.Num}} of {{$.Website}}</span><br><span class="line">      {{end}}</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/header&gt;</span><br><span class="line">{{template "footer.tpl" .}}</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/05/31/beego/4.png" alt="description"></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/05/31/drf-yong-hu-shou-cang-jie-kou-shi-xian/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/31/drf-yong-hu-shou-cang-jie-kou-shi-xian/" class="post-title-link" itemprop="url">drf用户收藏接口实现</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-05-30 16:21:41" itemprop="dateCreated datePublished" datetime="2021-05-30T16:21:41Z">2021-05-30</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-06-16 15:11:07" itemprop="dateModified" datetime="2021-06-16T15:11:07Z">2021-06-16</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/django/" itemprop="url" rel="index"><span itemprop="name">django</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>用户点击收藏会创建一条收藏数据，用户再次点击一次，应该删除该条数据<br>设置user与good唯一索引验证：</p>
<p>法一<br>因为在<code>UserFavSerializer</code>中使用的是<code>ModelSerializer</code>，类似于Django的<code>ModelForm</code>，它需要满足model中配置的条件，model中配置了<code>unique_together = ['user', 'goods']</code>，当提交的数据不满足就会抛出异常。</p>
<p><code>user_operation/models.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserFav</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    <span class="string">'''用户收藏'''</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        <span class="comment"># 联合唯一验证，当数据已存在时，数据库就会抛出异常</span></span><br><span class="line">        unique_together = (<span class="string">'user'</span>, <span class="string">'goods'</span>)</span><br></pre></td></tr></tbody></table></figure>

<p>法二：<br>序列化验证器<code>UniqueTogetherValidator</code></p>
<p>添加指定商品和当前用户到收藏，所以需要获取当前用户<br><code>Advanced field defaults</code>的<code>CurrentUserDefault</code></p>
<p>A default class that can be used to represent the current user. In order to use this,<br>the ‘request’ must have been provided as part of the context dictionary when instantiating the serializer.<br>可用于表示当前用户的默认类。为了使用它，在实例化序列化器时，request必须作为上下文字典的一部分提供</p>
<p><code>user_operation/serializers.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"><span class="keyword">from</span> rest_framework.validators <span class="keyword">import</span> UniqueTogetherValidator</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> UserFav</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserFavSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="string">"""序列化用户收藏数据"""</span></span><br><span class="line">    <span class="comment"># 获取当前登录用户，不可以选择其他用户</span></span><br><span class="line">    user = serializers.HiddenField(default=serializers.CurrentUserDefault())</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = UserFav</span><br><span class="line">        <span class="comment"># 收藏的时候需要返回商品的id，因为取消收藏的时候必须知道商品的id是多少</span></span><br><span class="line">        fields = [<span class="string">'id'</span>, <span class="string">'user'</span>, <span class="string">'goods'</span>]</span><br><span class="line">        <span class="comment"># UserFav items belong to a parent list, and have an ordering defined by the 'position' field.</span></span><br><span class="line">        <span class="comment"># No two items in a given list may share the same position.</span></span><br><span class="line">        <span class="comment"># UserFav项目属于父列表，并且有一个由“position”字段定义的顺序。给定列表中的任何两项不得共享同一位置。</span></span><br><span class="line">        validators = [  <span class="comment"># validate实现唯一联合，同一用户对同一商品只能收藏一次</span></span><br><span class="line">            UniqueTogetherValidator(</span><br><span class="line">                queryset=UserFav.objects.filter(is_delete=<span class="literal">False</span>),</span><br><span class="line">                fields=[<span class="string">'user'</span>, <span class="string">'goods'</span>],</span><br><span class="line">                message=<span class="string">'请勿重复收藏'</span>  <span class="comment"># message的信息可以自定义</span></span><br><span class="line">            )</span><br><span class="line">        ]</span><br></pre></td></tr></tbody></table></figure>

<p>以上<code>validators</code>不是作用域某个字段之上了，需要写在<code>Meta</code>中，因为<code>UniqueTogetherValidator</code>是作用域两个或两个字段以上的，不是针对一个字段，所以需要写在这。</p>
<p>按照商品的<code>id</code>显示收藏详情。可用性高，用户进入商品详情页，用户要去查询这个商品有没有被收藏，<br>在数据接口url中传入商品 goods_id去查询，<br>如果有记录，则页面就显示已收藏的信息，如果没被记录，表明商品没被收藏。<br>而不再是根据默认的UserFav收藏表的主键id进行查找，实现自己设置查询使用字段进行查询queryset对象</p>
<p><code>lookup_field</code>字段是在<code>get_queryset(self)</code>筛选过滤之后的结果进行查找，也就是过滤当前登录用户，保证了唯一性，所以不会出错。对于同一个商品，可能会被很多人收藏，但并不会造成查询出错，因为模型定义了商品和用户构成了联合唯一，过滤当前登录用户则对应的收藏商品唯一</p>
<p><code>user_operation/views.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> viewsets, mixins</span><br><span class="line"><span class="keyword">from</span> rest_framework.authentication <span class="keyword">import</span> SessionAuthentication</span><br><span class="line"><span class="keyword">from</span> rest_framework.permissions <span class="keyword">import</span> IsAuthenticated</span><br><span class="line"><span class="keyword">from</span> rest_framework_simplejwt.authentication <span class="keyword">import</span> JWTAuthentication</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> utils.permissions <span class="keyword">import</span> IsOwnerOrReadOnly</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> UserFav</span><br><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> UserFavSerializer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserFavViewSet</span>(<span class="params">mixins.CreateModelMixin, mixins.ListModelMixin, mixins.RetrieveModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                     mixins.DestroyModelMixin, viewsets.GenericViewSet</span>):</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    list:</span></span><br><span class="line"><span class="string">        用户收藏列表</span></span><br><span class="line"><span class="string">    create:</span></span><br><span class="line"><span class="string">        创建添加一条收藏记录</span></span><br><span class="line"><span class="string">    retrieve:</span></span><br><span class="line"><span class="string">        根据ID查询到用户收藏详情</span></span><br><span class="line"><span class="string">    destroy:</span></span><br><span class="line"><span class="string">        删除用户收藏</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    queryset = UserFav.objects.filter(is_delete=<span class="literal">False</span>)</span><br><span class="line">    <span class="comment"># IsAuthenticated：必须登录用户；IsOwnerOrReadOnly：必须是当前登录的用户</span></span><br><span class="line">    permission_classes = [IsAuthenticated, IsOwnerOrReadOnly]</span><br><span class="line">    serializer_class = UserFavSerializer</span><br><span class="line">    authentication_classes = [JWTAuthentication, SessionAuthentication]</span><br><span class="line">    lookup_field = <span class="string">'goods_id'</span>  <span class="comment"># 传入商品 goods_id去查询，而不再是根据默认的UserFav收藏表的主键id进行查找</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_queryset</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">"""只能查看当前登录用户的收藏，不会获取所有用户的收藏"""</span></span><br><span class="line">        <span class="keyword">return</span> UserFav.objects.filter(user=self.request.user, is_delete=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_serializer_class</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">'''动态设置序列化'''</span></span><br><span class="line">        <span class="keyword">if</span> self.action == <span class="string">'list'</span>:</span><br><span class="line">            <span class="keyword">return</span> UserFavDetailSerializer</span><br><span class="line">        <span class="keyword">elif</span> self.action == <span class="string">'create'</span>:</span><br><span class="line">            <span class="keyword">return</span> UserFavSerializer</span><br><span class="line">        <span class="keyword">return</span> UserFavSerializer</span><br></pre></td></tr></tbody></table></figure>

<p><code>url.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> user_operation.views <span class="keyword">import</span> UserFavViewSet</span><br><span class="line"></span><br><span class="line">router.register(<span class="string">'userfavs'</span>, UserFavViewSet)</span><br></pre></td></tr></tbody></table></figure>

<p>查看已收藏列表<br><img src="/2021/05/31/drf-yong-hu-shou-cang-jie-kou-shi-xian/1.png" alt="description"></p>
<p>选中一个商品，点击POST，这时候会向后台提交一个数据<br><img src="/2021/05/31/drf-yong-hu-shou-cang-jie-kou-shi-xian/2.png" alt="description"><br><img src="/2021/05/31/drf-yong-hu-shou-cang-jie-kou-shi-xian/3.png" alt="description"></p>
<p>查看一个已收藏详情<br><img src="/2021/05/31/drf-yong-hu-shou-cang-jie-kou-shi-xian/4.png" alt="description"></p>
<p>当某个商品已经存在收藏时再重复添加收藏，在两个及以上字段联合验证失败时返回错误信息的关键字段，前端在接收后可以进行相应处理<code>non_field_errors</code>，会提示自定义提示“请勿重复收藏”<br><img src="/2021/05/31/drf-yong-hu-shou-cang-jie-kou-shi-xian/5.png" alt="description"></p>
<p><code>non_field_errors</code>表示不能指定某一个字段的错误，而是多个字段造成的错误。可以在前端判断，如果出现<code>non_field_errors</code>字段，则表示整体的错误，不需要写在某个表单下面提示。</p>
<p>取消收藏前 <code>user_operation_userfav</code></p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">+<span class="comment">------------------+------------------+--------------------+</span></span><br><span class="line">| id  | add_time         | is_delete       | goods_id | user_id |</span><br><span class="line">+<span class="comment">------------------------------------------+---------------+-</span></span><br><span class="line">| 1   | 2021-05-31 15:31:54.767265  |  0   |   1   |   1      |</span><br><span class="line">| 2   | 2021-05-31 16:11:07.655320  |  0   |   4   |   1      |</span><br><span class="line">| 3   | 2021-05-31 16:11:22.720074  |  0   |  10   |   6      |</span><br><span class="line">| 8   | 2021-05-31 22:30:30.567272  |  0   |   2   |   1      |</span><br><span class="line">+<span class="comment">------------------------------------------+---------------+-</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></tbody></table></figure>

<p>取消收藏，例如取消商品goods_id=10</p>
<p><img src="/2021/05/31/drf-yong-hu-shou-cang-jie-kou-shi-xian/6.png" alt="description"><br><img src="/2021/05/31/drf-yong-hu-shou-cang-jie-kou-shi-xian/7.png" alt="description"></p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">+<span class="comment">------------------+------------------+--------------------+</span></span><br><span class="line">| id  | add_time          | is_delete    | goods_id | user_id |</span><br><span class="line">+<span class="comment">------------------------------------------+---------------+-</span></span><br><span class="line">| 1 | 2021-05-31 15:31:54.767265 |  0    |       1 | 1        |</span><br><span class="line">| 2 | 2021-05-31 16:11:07.655320 |  0    |       4 | 1        |</span><br><span class="line">| 8 | 2021-05-31 22:30:30.567272 |  0    |       2 | 1        |</span><br><span class="line">+<span class="comment">------------------------------------------+---------------+-</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></tbody></table></figure>

<p>第一次DELETE请求时返回信息204，说明删除成功，第二次再执行则返回未找到，再次印证删除成功。</p>
<p><img src="/2021/05/31/drf-yong-hu-shou-cang-jie-kou-shi-xian/8.png" alt="description"><br><img src="/2021/05/31/drf-yong-hu-shou-cang-jie-kou-shi-xian/9.png" alt="description"></p>
<h3 id="用户收藏商品详情"><a href="#用户收藏商品详情" class="headerlink" title="用户收藏商品详情"></a>用户收藏商品详情</h3><p>在前面已经写好了用户收藏和取消收藏商品的功能，访问 <a target="_blank" rel="noopener" href="http://127.0.0.1:8000/userfavs/">http://127.0.0.1:8000/userfavs/</a> 即可看到，但收藏的商品只显示了商品的id</p>
<p>显示商品的具体信息，首先还得做序列化。直接使用商品已做好的序列化类，也可以自己写，只显示所需要的信息。</p>
<p><code>user_operation/serializer.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> goods.serializers <span class="keyword">import</span> GoodsSerializer</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserFavDetailSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    用户收藏详情</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    <span class="comment"># 通过商品id而不是收藏表id获取收藏的商品，需要嵌套商品的序列化</span></span><br><span class="line">    goods = GoodsSerializer()</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = UserFav</span><br><span class="line">        fields = [<span class="string">'id'</span>, <span class="string">'goods'</span>]</span><br></pre></td></tr></tbody></table></figure>

<p>收藏商品和显示用户已收藏的商品使用了不同的序列化类，则也需要用到动态Serializer<br><code>user_operation/views.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> viewsets</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> mixins</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> UserFav</span><br><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> UserFavSerializer, UserFavDetailSerializer</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserFavViewSet</span>(<span class="params">mixins.CreateModelMixin, mixins.ListModelMixin, mixins.RetrieveModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                     mixins.DestroyModelMixin, viewsets.GenericViewSet</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    list:获取用户收藏商品列表</span></span><br><span class="line"><span class="string">    create:</span></span><br><span class="line"><span class="string">        添加一条用户收藏商品</span></span><br><span class="line"><span class="string">    retrieve:</span></span><br><span class="line"><span class="string">        根据商品ID获取用户收藏详情</span></span><br><span class="line"><span class="string">    destroy:</span></span><br><span class="line"><span class="string">        删除用户收藏商品</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    queryset = UserFav.objects.filter(is_delete=<span class="literal">False</span>)</span><br><span class="line">    <span class="comment"># IsAuthenticated：必须登录用户；IsOwnerOrReadOnly：必须是当前登录的用户</span></span><br><span class="line">    permission_classes = [IsAuthenticated, IsOwnerOrReadOnly]</span><br><span class="line">    authentication_classes = [JWTAuthentication, SessionAuthentication]</span><br><span class="line">    lookup_field = <span class="string">'goods_id'</span>  <span class="comment"># 单个模型实例的对象查找的模型字段，即查询单一数据库对象时使用的条件字段，默认为pk，即主键</span></span><br><span class="line">    <span class="comment"># 这样在数据接口中就可以直接传入商品id并根据该字段进行查询，</span></span><br><span class="line">    <span class="comment"># 而不再是根据UserFav的主键id进行查找，就到了自己设置查询使用字段的目的，可用性更高。</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_queryset</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># 只能查看当前登录用户的收藏，不会获取所有用户的收藏</span></span><br><span class="line">        <span class="keyword">return</span> UserFav.objects.filter(user=self.request.user, is_delete=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_serializer_class</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">'''不同的action使用不同的序列化'''</span></span><br><span class="line">        <span class="keyword">if</span> self.action == <span class="string">'list'</span>:</span><br><span class="line">            <span class="keyword">return</span> UserFavDetailSerializer</span><br><span class="line">        <span class="keyword">elif</span> self.action == <span class="string">'create'</span>:</span><br><span class="line">            <span class="keyword">return</span> UserFavSerializer</span><br><span class="line">        <span class="keyword">return</span> UserFavSerializer</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/05/31/drf-yong-hu-shou-cang-jie-kou-shi-xian/10.png" alt="description"><br><img src="/2021/05/31/drf-yong-hu-shou-cang-jie-kou-shi-xian/11.jpeg" alt="description"></p>
<h2 id="商品收藏数"><a href="#商品收藏数" class="headerlink" title="商品收藏数"></a>商品收藏数</h2><p>法一</p>
<p><code>user_operation/view.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserFavViewSet</span>(<span class="params">mixins.CreateModelMixin, mixins.ListModelMixin, mixins.RetrieveModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                     mixins.DestroyModelMixin, viewsets.GenericViewSet</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    list:获取用户收藏商品列表</span></span><br><span class="line"><span class="string">    create:</span></span><br><span class="line"><span class="string">        添加一条用户收藏商品</span></span><br><span class="line"><span class="string">    retrieve:</span></span><br><span class="line"><span class="string">        根据商品ID获取用户收藏详情</span></span><br><span class="line"><span class="string">    destroy:</span></span><br><span class="line"><span class="string">        删除用户收藏商品</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    queryset = UserFav.objects.filter(is_delete=<span class="literal">False</span>)</span><br><span class="line">    <span class="comment"># IsAuthenticated：必须登录用户；IsOwnerOrReadOnly：必须是当前登录的用户</span></span><br><span class="line">    permission_classes = [IsAuthenticated, IsOwnerOrReadOnly]</span><br><span class="line">    <span class="comment"># serializer_class = UserFavSerializer</span></span><br><span class="line">    authentication_classes = [JWTAuthentication, SessionAuthentication]</span><br><span class="line">    lookup_field = <span class="string">'goods_id'</span>  <span class="comment"># 单个模型实例的对象查找的模型字段，即查询单一数据库对象时使用的条件字段，默认为pk，即主键</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 这样在数据接口中就可以直接传入商品id并根据该字段进行查询，</span></span><br><span class="line">    <span class="comment"># 而不再是根据UserFav的主键id进行查找，就到了自己设置查询使用字段的目的，可用性更高。</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_queryset</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># 只能查看当前登录用户的收藏，不会获取所有用户的收藏</span></span><br><span class="line">        <span class="keyword">return</span> UserFav.objects.filter(user=self.request.user, is_delete=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_serializer_class</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">'''不同的action使用不同的序列化'''</span></span><br><span class="line">        <span class="keyword">if</span> self.action == <span class="string">'list'</span>:</span><br><span class="line">            <span class="keyword">return</span> UserFavDetailSerializer</span><br><span class="line">        <span class="keyword">elif</span> self.action == <span class="string">'create'</span>:</span><br><span class="line">            <span class="keyword">return</span> UserFavSerializer</span><br><span class="line">        <span class="keyword">return</span> UserFavSerializer</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 使用信号实现，该处代码不需要了</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">perform_create</span>(<span class="params">self, serializer</span>):</span></span><br><span class="line">        <span class="comment"># 重写实现添加收藏商品，商品收藏数+1</span></span><br><span class="line">        <span class="comment"># 序列化保存，然后将它赋值给一个实例，也就是UserFav(models.Model)对象</span></span><br><span class="line">        instance = serializer.save()</span><br><span class="line">        <span class="comment"># 这里instance相当于UserFav model，通过它找到goods获取其中的商品</span></span><br><span class="line">        goods = instance.goods</span><br><span class="line">        <span class="comment"># 商品收藏数+1</span></span><br><span class="line">        goods.fav_num += <span class="number">1</span></span><br><span class="line">        goods.save()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">perform_destroy</span>(<span class="params">self, instance</span>):</span></span><br><span class="line">        <span class="comment"># 删除收藏商品，商品收藏数-1</span></span><br><span class="line">        goods = instance.goods</span><br><span class="line">        <span class="comment"># 商品收藏数-1</span></span><br><span class="line">        goods.fav_num -= <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> goods.fav_num &lt; <span class="number">0</span>:</span><br><span class="line">            goods.fav_num = <span class="number">0</span></span><br><span class="line">        goods.save()</span><br><span class="line">        instance.delete()</span><br></pre></td></tr></tbody></table></figure>

<p>法二 收藏注释掉上方的<code>perform_create(self, serializer)</code>和<code>perform_destroy(self, instance)</code></p>
<p><code>django.db.models.signals.pre_delete</code><br>在模型的 <code>delete()</code> 方法和查询集的 <code>delete()</code> 方法开始时发送。</p>
<p>用此信号发送的参数：</p>
<p><code>sender</code>模型类<br><code>instance</code>实际被删除的实例。<br><code>using</code>正在使用的数据库别名。</p>
<p>post_delete<br><code>django.db.models.signals.post_delete</code><br>就像 <code>pre_delete</code> 一样，但在模型的 <code>delete()</code> 方法和查询集的 <code>delete()</code> 方法结束时发送。</p>
<p>用此信号发送的参数：</p>
<p><code>sender</code>模型类<br><code>instance</code>实际被删除的实例。<br>请注意，该对象将不再在数据库中，所以要非常小心地处理这个实例。<br><code>using</code>正在使用的数据库别名。</p>
<p><code>user_operation/signals.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db.models.signals <span class="keyword">import</span> post_save, post_delete</span><br><span class="line"><span class="keyword">from</span> django.dispatch <span class="keyword">import</span> receiver</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> UserFav</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># post_save:接收信号的方式</span></span><br><span class="line"><span class="comment"># sender: 接收信号的model</span></span><br><span class="line"><span class="meta">@receiver(post_save, sender=UserFav)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_userfav</span>(<span class="params">sender, instance=None, created=False, **kwargs</span>):</span></span><br><span class="line">    <span class="keyword">if</span> created:</span><br><span class="line">        goods = instance.goods</span><br><span class="line">        goods.fav_num += <span class="number">1</span></span><br><span class="line">        goods.save()</span><br><span class="line"></span><br><span class="line"><span class="comment"># post_delete指定信号触发类型，</span></span><br><span class="line"><span class="comment"># sender指定到具体对象</span></span><br><span class="line"><span class="meta">@receiver(post_delete, sender=UserFav)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_userfav</span>(<span class="params">sender, instance=None, created=False, **kwargs</span>):</span></span><br><span class="line">    <span class="comment"># instance表示被删除的对象</span></span><br><span class="line">    goods = instance.goods</span><br><span class="line">    goods.fav_num -= <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> goods.fav_num &lt; <span class="number">0</span>:</span><br><span class="line">        goods.fav_num = <span class="number">0</span></span><br><span class="line">    goods.save()</span><br></pre></td></tr></tbody></table></figure>

<p><code>user_operation/apps.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.apps <span class="keyword">import</span> AppConfig</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserOperationConfig</span>(<span class="params">AppConfig</span>):</span></span><br><span class="line">    name = <span class="string">'user_operation'</span></span><br><span class="line">    verbose_name = <span class="string">'用户操作模块'</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">ready</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">"""在子类中重写此方法，以便在Django启动时运行代码"""</span></span><br><span class="line">        <span class="keyword">import</span> user_operation.signals</span><br></pre></td></tr></tbody></table></figure>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/05/31/drf-yong-hu-zhu-ce-he-biao-dan-deng-lu-token/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/31/drf-yong-hu-zhu-ce-he-biao-dan-deng-lu-token/" class="post-title-link" itemprop="url">drf用户注册和表单登录token</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-05-30 16:21:41" itemprop="dateCreated datePublished" datetime="2021-05-30T16:21:41Z">2021-05-30</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-06-17 07:10:41" itemprop="dateModified" datetime="2021-06-17T07:10:41Z">2021-06-17</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/django/" itemprop="url" rel="index"><span itemprop="name">django</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>注册接口成功</p>
<ol>
<li><p>正常返回，能浏览器代开对应路由，点击注册，弹框提示注册成功不点击确定，<br>F12开发者调试模式-localstore 有本地存储username token cart_count数据，<br>或者通过postman查看有没有生成token</p>
</li>
<li><p>服务器数据库生成数据</p>
</li>
</ol>
<h2 id="登录返回token"><a href="#登录返回token" class="headerlink" title="登录返回token"></a>登录返回token</h2><figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework_simplejwt.views <span class="keyword">import</span> (</span><br><span class="line">    TokenObtainPairView,</span><br><span class="line">    TokenRefreshView,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    <span class="comment"># simple jwt 认证接口</span></span><br><span class="line">    <span class="comment"># TokenObtainPairView是simple jwt的内置类</span></span><br><span class="line">    path(<span class="string">'api/token/'</span>, TokenObtainPairView.as_view(), name=<span class="string">'token_obtain_pair'</span>),</span><br><span class="line">    path(<span class="string">'api/token/refresh/'</span>, TokenRefreshView.as_view(), name=<span class="string">'token_refresh'</span>),</span><br><span class="line">    path(<span class="string">'login/'</span>, TokenObtainPairView.as_view(), name=<span class="string">'token_obtain_pair'</span>),</span><br><span class="line">]</span><br></pre></td></tr></tbody></table></figure>

<p>现在就可以登录了<br><img src="/2021/05/31/drf-yong-hu-zhu-ce-he-biao-dan-deng-lu-token/1.png" alt="description"><br><img src="/2021/05/31/drf-yong-hu-zhu-ce-he-biao-dan-deng-lu-token/2.png" alt="description"></p>
<p><img src="/2021/05/31/drf-yong-hu-zhu-ce-he-biao-dan-deng-lu-token/3.png" alt="description"><br><img src="/2021/05/31/drf-yong-hu-zhu-ce-he-biao-dan-deng-lu-token/10.png" alt="description"><br><img src="/2021/05/31/drf-yong-hu-zhu-ce-he-biao-dan-deng-lu-token/4.png" alt="description"></p>
<p><code>token</code> 和 <code>access</code> 是一样的，这里是为了前端获取方便换了个名字<br>返回了三个值：</p>
<p>refresh：刷新token，当前端token过期需要刷新token的时候就可以访问前边说的<code>api/token/refresh</code>url，<br>参数是原来的<code>refresh</code>的值。</p>
<p>access：这个就是<code>token</code>但是框架里叫做<code>access</code>。</p>
<p><code>apps\users\serializers.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyTokenObtainPairSerializer</span>(<span class="params">TokenObtainPairSerializer</span>):</span></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_token</span>(<span class="params">cls, user</span>):</span></span><br><span class="line">        token = super().get_token(user)</span><br><span class="line">        token[<span class="string">'name'</span>] = user.username  <span class="comment"># 因为程序可能运行在集群上，这里不写也可以</span></span><br><span class="line">        <span class="keyword">return</span> token</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate</span>(<span class="params">self, attrs</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        登录返回token和refresh</span></span><br><span class="line"><span class="string">        :param attrs:</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        data = super().validate(attrs)</span><br><span class="line">        <span class="comment"># access：这个就是`token`但是框架里叫做`access`</span></span><br><span class="line">        data[<span class="string">'token'</span>] = str(data[<span class="string">"access"</span>])  <span class="comment"># 给access新命名了一个值，方便前端获取：</span></span><br><span class="line">        <span class="keyword">return</span> data</span><br></pre></td></tr></tbody></table></figure>

<p><code>apps\users\views.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyTokenObtainPairView</span>(<span class="params">TokenObtainPairView</span>):</span></span><br><span class="line">    serializer_class = MyTokenObtainPairSerializer</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework_simplejwt.views <span class="keyword">import</span> (</span><br><span class="line">    TokenObtainPairView,</span><br><span class="line">    TokenRefreshView,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    <span class="comment"># simple jwt 认证接口</span></span><br><span class="line">    <span class="comment"># path('login/', TokenObtainPairView.as_view(), name='token_obtain_pair'),</span></span><br><span class="line">    path(<span class="string">'login/'</span>, MyTokenObtainPairView.as_view(), name=<span class="string">'token_obtain_pair'</span>),</span><br><span class="line">]</span><br></pre></td></tr></tbody></table></figure>

<h3 id="增加手机号登录验证功能"><a href="#增加手机号登录验证功能" class="headerlink" title="增加手机号登录验证功能"></a>增加手机号登录验证功能</h3><p>drf jwt默认验证的是username和password</p>
<p><code>apps\users\views.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib.auth <span class="keyword">import</span> get_user_model</span><br><span class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> Q</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth.backends <span class="keyword">import</span> ModelBackend</span><br><span class="line"></span><br><span class="line">User = get_user_model()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CustomBackend</span>(<span class="params">ModelBackend</span>):</span></span><br><span class="line">    <span class="string">"""自定义用户登录，可以使用用户名和手机登录，重写authenticate方法"""</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">authenticate</span>(<span class="params">self, request, username=None, password=None, **kwargs</span>):</span></span><br><span class="line">        <span class="comment"># print(request.data) 参考请求的其他数据</span></span><br><span class="line">        <span class="comment"># print(request.data['demo']) 比如说key是demo的数据用来做你要的数据校验</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 用户名和手机都能登录，没有做邮箱验证功能</span></span><br><span class="line">            user = User.objects.get(</span><br><span class="line">                Q(username=username) | Q(mobile=username))</span><br><span class="line">            <span class="keyword">if</span> user.check_password(password) <span class="keyword">and</span> user.is_delete != <span class="literal">True</span>:</span><br><span class="line">                <span class="keyword">return</span> user</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CustomBackend</span>(<span class="params">ModelBackend</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">authenticate</span>(<span class="params">self, request, username=None, password=None, **kwargs</span>):</span></span><br><span class="line">        <span class="comment"># print(request.data) 参考请求的其他数据</span></span><br><span class="line">        <span class="comment"># print(request.data['demo']) 比如说key是demo的数据用来做你要的数据校验</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                user = Users.objects.get(Q(username=username) | Q(mobile=username))</span><br><span class="line">            <span class="keyword">except</span> Exception:</span><br><span class="line">                <span class="keyword">raise</span> serializers.ValidationError({<span class="string">''</span>: <span class="string">'账号没有注册'</span>})</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> user.check_password(password):</span><br><span class="line">                <span class="keyword">return</span> user</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># 如果不想密码登录也可以验证码在这里写</span></span><br><span class="line">                <span class="comment"># 这里做验证码的操作</span></span><br><span class="line">                <span class="keyword">raise</span> serializers.ValidationError({<span class="string">''</span>: <span class="string">'密码错误'</span>})</span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">raise</span> e</span><br></pre></td></tr></tbody></table></figure>

<p><code>settings.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AUTHENTICATION_BACKENDS = (<span class="string">'users.views.CustomBackend'</span>,)  <span class="comment"># 指定认证后台</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="用户序列化user-serializer和验证器validator"><a href="#用户序列化user-serializer和验证器validator" class="headerlink" title="用户序列化user serializer和验证器validator"></a>用户序列化user serializer和验证器validator</h2><p><strong>注册就是将用户的数据POST到用户数据库，所以继承<code>CreateModelMixin</code></strong></p>
<p>用户注册需要填写手机号，验证码和密码，对应3个字段，需要定义视图并验证。<br>在Django中username字段为必填字段，DRF序列化只需要验证username满足即可，<br>将 UserProfile 中mobile字段作为username 使得username的手机号验证通过后，将手机号填入mobile中<br>设置可为空<code>blank=True, null=True</code>，如果不这样设置，后端做验证的时候就会提示mobile这个字段必填。</p>
<p>之前创建的admin用户没有设置mobile字段，现在设定一个手机号也可以登录<br>将传入的username字段的内容直接填充到mobile中<br>这个Serializer中直接继承<code>ModelSerializer</code>，</p>
<p>模型<code>UserProfile</code>中没有<code>code</code>字段，<br>在验证时为了判断验证码的正误而加入<code>code</code>这个字段，用于验证验证码是否正确，更新或创建实例反序列化包含自定义<code>code</code>字段，序列化时找不到<code>code</code>字段会出错，需要将字段的<code>write_only</code>设置<code>True</code>确保序列化表示形式时不包括该字段</p>
<p><code>users/serializers.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.validators <span class="keyword">import</span> UniqueValidator</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="string">'''用户注册序列化'''</span></span><br><span class="line">    code = serializers.CharField(required=<span class="literal">True</span>, write_only=<span class="literal">True</span>, max_length=<span class="number">4</span>, min_length=<span class="number">4</span>, label=<span class="string">'验证码'</span>,</span><br><span class="line">                                 error_messages={</span><br><span class="line">                                     <span class="string">"blank"</span>: <span class="string">"请输入验证码"</span>,</span><br><span class="line">                                     <span class="string">"required"</span>: <span class="string">"请输入验证码"</span>,</span><br><span class="line">                                     <span class="string">"max_length"</span>: <span class="string">"请输入4位验证码"</span>,</span><br><span class="line">                                     <span class="string">"min_length"</span>: <span class="string">"请输入4位验证码"</span></span><br><span class="line">                                 },</span><br><span class="line">                                 help_text=<span class="string">"验证码"</span>)</span><br><span class="line">    <span class="comment"># 验证用户名是否存在，如果已存在，则提示message中的内容</span></span><br><span class="line">    username = serializers.CharField(label=<span class="string">"用户名"</span>, help_text=<span class="string">"用户名"</span>, required=<span class="literal">True</span>, allow_blank=<span class="literal">False</span>,</span><br><span class="line">                                     validators=[</span><br><span class="line">                                         UniqueValidator(queryset=User.objects.filter(is_delete=<span class="literal">False</span>), message=<span class="string">"用户已经存在"</span>)])</span><br><span class="line">    <span class="comment"># 输入密码的时候不显示明文，注册成功不返回让password字段，也就是序列化时不包含该字段</span></span><br><span class="line">    password = serializers.CharField(</span><br><span class="line">        style={<span class="string">'input_type'</span>: <span class="string">'password'</span>}, label=<span class="string">"密码"</span>, write_only=<span class="literal">True</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate_code</span>(<span class="params">self, code</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        自定义单一字段验证，函数名必须：validate + _ + 验证字段名</span></span><br><span class="line"><span class="string">        验证验证码</span></span><br><span class="line"><span class="string">        形参名随便写</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="comment"># 用户以post方式提交注册信息，前端post的数据都保存在initial_data里面</span></span><br><span class="line">        <span class="comment"># username就是用户注册的手机号，</span></span><br><span class="line">        <span class="comment"># 验证码按添加时间倒序排序，为了后面验证过期，错误等</span></span><br><span class="line">        verify_records = VerifyCode.objects.filter(mobile=self.initial_data[<span class="string">"username"</span>]).order_by(<span class="string">"-add_time"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> verify_records:  <span class="comment"># 验证验证码是否存在</span></span><br><span class="line">            <span class="comment"># 最近的一个验证码</span></span><br><span class="line">            last_record = verify_records[<span class="number">0</span>]</span><br><span class="line">            <span class="comment"># 获取5分钟以前的时间</span></span><br><span class="line">            five_mintes_ago = datetime.now() - timedelta(hours=<span class="number">0</span>, minutes=<span class="number">5</span>, seconds=<span class="number">0</span>)</span><br><span class="line">            <span class="keyword">if</span> five_mintes_ago &gt; last_record.add_time:</span><br><span class="line">                <span class="keyword">raise</span> serializers.ValidationError(<span class="string">"验证码过期"</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> last_record.code != code:</span><br><span class="line">                <span class="keyword">raise</span> serializers.ValidationError(<span class="string">"验证码错误"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> serializers.ValidationError(<span class="string">"验证码错误"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate</span>(<span class="params">self, attrs</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        多个字段验证，函数名必须：validate</span></span><br><span class="line"><span class="string">        :param attrs: 所有字段验证合法之后返回的所有字段的dict，形参名随便写</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="comment"># 人为设定前端传递到后端的手机号数据变量名为username而非mobile</span></span><br><span class="line">        <span class="comment"># 把`username`的值赋值给`mobile`的值。</span></span><br><span class="line">        attrs[<span class="string">"mobile"</span>] = attrs[<span class="string">"username"</span>]</span><br><span class="line">        <span class="comment"># code字段只是为了验证临时生成的、不需要保存到用户数据表中，因此在验证之后需要删除</span></span><br><span class="line">        <span class="keyword">del</span> attrs[<span class="string">"code"</span>]</span><br><span class="line">        <span class="keyword">return</span> attrs</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = User</span><br><span class="line">        fields = (<span class="string">'username'</span>, <span class="string">'code'</span>, <span class="string">'mobile'</span>, <span class="string">'password'</span>)</span><br></pre></td></tr></tbody></table></figure>

<p><code>users/views.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserViewSet</span>(<span class="params">CreateModelMixin, RetrieveModelMixin, UpdateModelMixin, viewsets.GenericViewSet</span>):</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    list:用户列表</span></span><br><span class="line"><span class="string">    create:</span></span><br><span class="line"><span class="string">        创建添加一用户，用户注册成功携带token登录</span></span><br><span class="line"><span class="string">    retrieve:</span></span><br><span class="line"><span class="string">        根据ID查询到用户详情</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    serializer_class = UserSerializer</span><br><span class="line">    queryset = User.objects.filter(is_delete=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="string">"""注册后自动登录需要携带token"""</span></span><br><span class="line">        serializer = self.get_serializer(data=request.data)</span><br><span class="line">        serializer.is_valid(raise_exception=<span class="literal">True</span>)</span><br><span class="line">        user = self.perform_create(serializer)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 添加自己的逻辑，手动生成token</span></span><br><span class="line">        refresh = RefreshToken.for_user(user)</span><br><span class="line"></span><br><span class="line">        tokens_for_user = {</span><br><span class="line">            <span class="string">'refresh'</span>: str(refresh),</span><br><span class="line">            <span class="comment"># 'access': str(refresh.access_token),  # 默认是</span></span><br><span class="line">            <span class="comment"># 数据定制化</span></span><br><span class="line">            <span class="string">'token'</span>: str(refresh.access_token),  <span class="comment"># 前端是token</span></span><br><span class="line">            <span class="string">'username'</span>: user.username,  <span class="comment"># 由于前端也需要传入username，需要将其加上。cookie.setCookie('name', response.data.username, 7);</span></span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        headers = self.get_success_headers(serializer.data)</span><br><span class="line">        <span class="keyword">return</span> Response(tokens_for_user, status=status.HTTP_201_CREATED, headers=headers)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">perform_create</span>(<span class="params">self, serializer</span>):</span></span><br><span class="line">        <span class="keyword">return</span> serializer.save()</span><br></pre></td></tr></tbody></table></figure>

<p><code>CreateModelMixin</code>源码</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CreateModelMixin</span>(<span class="params">object</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Create a model instance.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        serializer = self.get_serializer(data=request.data)</span><br><span class="line">        serializer.is_valid(raise_exception=<span class="literal">True</span>)</span><br><span class="line">        self.perform_create(serializer)</span><br><span class="line">        headers = self.get_success_headers(serializer.data)</span><br><span class="line">        <span class="keyword">return</span> Response(serializer.data, status=status.HTTP_201_CREATED, headers=headers)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">perform_create</span>(<span class="params">self, serializer</span>):</span></span><br><span class="line">        serializer.save()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_success_headers</span>(<span class="params">self, data</span>):</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> {<span class="string">'Location'</span>: str(data[api_settings.URL_FIELD_NAME])}</span><br><span class="line">        <span class="keyword">except</span> (TypeError, KeyError):</span><br><span class="line">            <span class="keyword">return</span> {}</span><br></pre></td></tr></tbody></table></figure>

<p>在生成<code>token</code>之前，<code>self.perform_create(serializer)</code>这个函数，他只是调用了<code>serializer.save()</code>，<br>因为要生成用户的token之前，必须要拿到user，所以这个函数也需要被重载。<br>原函数中只是调用<code>.save()</code>，并没有返回。实际上<code>serializer.save()</code>中的<code>serializer</code>就是<code>UserSerializer</code>中<code>model</code>的对象。<br>重载它，把它返回，才能得到user对象。</p>
<h3 id="新建用户，密码在数据库加密保存而不是明文存储"><a href="#新建用户，密码在数据库加密保存而不是明文存储" class="headerlink" title="新建用户，密码在数据库加密保存而不是明文存储"></a>新建用户，密码在数据库加密保存而不是明文存储</h3><p>法一：重载Create方法</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="string">'''用户注册序列化'''</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">self, validated_data</span>):</span></span><br><span class="line">        <span class="string">"""重载Create方法实现密码在数据库加密反序列化保存而不是明文存储"""</span></span><br><span class="line">        user = super(UserSerializer, self).create(validated_data=validated_data)</span><br><span class="line">        <span class="comment"># UserProfile--&gt;AbstractUser--&gt;AbstractBaseUser中有个set_password(self, raw_password)方法</span></span><br><span class="line">        user.set_password(validated_data[<span class="string">"password"</span>])  <span class="comment"># user.set_password(validated_data['password'])  # 取出password密码，进行加密后保存</span></span><br><span class="line">        user.save()  <span class="comment"># 模型类对象的save方法</span></span><br><span class="line">        <span class="keyword">return</span> user</span><br></pre></td></tr></tbody></table></figure>

<p>法二：同时创建Token<br>信号<br>[<a target="_blank" rel="noopener" href="https://docs.djangoproject.com/en/3.2/ref/signals/]">https://docs.djangoproject.com/en/3.2/ref/signals/]</a><br>其中一类信号是模型信号，django.db.models.signals模块定义了模型系统发送的一组信号，对模型进行操作后，Django会发出全局信号，捕捉到之后可以加入需要的业务逻辑，具体包括pre_init、post_init、pre_save和post_save等，这里我们使用post_save信号实现密码设置。</p>
<p><code>apps/users/signals.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib.auth <span class="keyword">import</span> get_user_model</span><br><span class="line"><span class="keyword">from</span> django.db.models.signals <span class="keyword">import</span> post_save</span><br><span class="line"><span class="keyword">from</span> django.dispatch <span class="keyword">import</span> receiver</span><br><span class="line"><span class="keyword">from</span> rest_framework.authtoken.models <span class="keyword">import</span> Token</span><br><span class="line"></span><br><span class="line">User = get_user_model()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@receiver(post_save, sender=User)</span></span><br><span class="line"><span class="comment"># post_save:接收信号的方式</span></span><br><span class="line"><span class="comment"># sender: 接收User这个Model传递过来的信号</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_user</span>(<span class="params">sender, instance=None, created=False, **kwargs</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    在传过来后，它需要确认是否是created新建数据，</span></span><br><span class="line"><span class="string">    如果是新建数据，才进行密码加密。</span></span><br><span class="line"><span class="string">    因为如果是update更新的时候也会传递post_save信号。</span></span><br><span class="line"><span class="string">    使用信号，代码分离性较强。</span></span><br><span class="line"><span class="string">    :param sender:</span></span><br><span class="line"><span class="string">    :param instance: 相当于user</span></span><br><span class="line"><span class="string">    :param created:是否新建，因为update的时候也会进行post_save</span></span><br><span class="line"><span class="string">    :param kwargs:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">if</span> created:</span><br><span class="line">        password = instance.password  <span class="comment"># instance指的就是创建的用户对象</span></span><br><span class="line">        instance.set_password(password)</span><br><span class="line">        instance.save()</span><br><span class="line">        <span class="comment"># Token.objects.create(user=instance)  # 用jwt而不是token</span></span><br></pre></td></tr></tbody></table></figure>

<p><code>users/apps.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.apps <span class="keyword">import</span> AppConfig</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UsersConfig</span>(<span class="params">AppConfig</span>):</span></span><br><span class="line">    default_auto_field = <span class="string">'django.db.models.BigAutoField'</span></span><br><span class="line">    name = <span class="string">'users'</span></span><br><span class="line">    verbose_name = <span class="string">"用户管理"</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">ready</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">import</span> users.signals</span><br></pre></td></tr></tbody></table></figure>

<p><code>url.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> users.views <span class="keyword">import</span> UserViewSet</span><br><span class="line"></span><br><span class="line">router.register(<span class="string">'users'</span>, UserViewset)</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/05/31/drf-yong-hu-zhu-ce-he-biao-dan-deng-lu-token/5.png" alt="description"><br><img src="/2021/05/31/drf-yong-hu-zhu-ce-he-biao-dan-deng-lu-token/6.png" alt="description"></p>
<p>token：这个是在序列化文件中给access新命名了一个值，<code>token</code> 和 <code>access</code> 是一样的，这里是为了前端获取方便换了个名字</p>
<p>测试接口</p>
<ul>
<li>输入已经存在的用户名</li>
<li>不输入验证码<br><img src="/2021/05/31/drf-yong-hu-zhu-ce-he-biao-dan-deng-lu-token/7.png" alt="description"></li>
</ul>
<p><img src="/2021/05/31/drf-yong-hu-zhu-ce-he-biao-dan-deng-lu-token/8.png" alt="description"><br><img src="/2021/05/31/drf-yong-hu-zhu-ce-he-biao-dan-deng-lu-token/11.png" alt="description"></p>
<ul>
<li>注册成功，返回注册信息，前端跳转到首页<br><img src="/2021/05/31/drf-yong-hu-zhu-ce-he-biao-dan-deng-lu-token/9.png" alt="description"><br><img src="/2021/05/31/drf-yong-hu-zhu-ce-he-biao-dan-deng-lu-token/12.png" alt="description"></li>
</ul>
<p>simple jwt获取token源码</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TokenObtainPairSerializer</span>(<span class="params">TokenObtainSerializer</span>):</span></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_token</span>(<span class="params">cls, user</span>):</span></span><br><span class="line">        <span class="keyword">return</span> RefreshToken.for_user(user)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate</span>(<span class="params">self, attrs</span>):</span></span><br><span class="line">        data = super().validate(attrs)</span><br><span class="line"></span><br><span class="line">        refresh = self.get_token(self.user)</span><br><span class="line"></span><br><span class="line">        data[<span class="string">'refresh'</span>] = str(refresh)</span><br><span class="line">        data[<span class="string">'access'</span>] = str(refresh.access_token)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> api_settings.UPDATE_LAST_LOGIN:</span><br><span class="line">            update_last_login(<span class="literal">None</span>, self.user)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> data</span><br></pre></td></tr></tbody></table></figure>

<h3 id="获取用户详细信息"><a href="#获取用户详细信息" class="headerlink" title="获取用户详细信息"></a>获取用户详细信息</h3><p>用户个人信息修改，因为手机号是验证过的，不能随便改<br>在会员中心页面，想要获取个人信息，只需在UserViewset中多继承一个类：<code>mixins.RetrieveModelMixin</code></p>
<p>在用户注册时，因为用户还没有账号，会执行<code>create(request, *args, **kwargs)</code>和<code>perform_create(serializer)</code>方法，<br>因此这些方法应该对所有用户开放，不进行验证；<br>而在用户注册之后，修改用户信息需要先获取用户信息，此时执行<code>get_object()</code>方法，因此需要对该方法进行权限验证。<br>所以不能采用原来的权限验证方法，即<code>permission_classes = [IsAuthenticated]</code>，而是需要动态设置权限，即重写<code>get_permissions()</code>方法；<br>除此之外，因为之前定义的用户序列化<code>UserSerializer</code>是针对用户注册功能的，虽然定义了<code>('username', 'mobile', 'code', 'password')</code>多个序列化字段，<br>但其中有两个配置了<code>write_only=True</code>属性，序列化将不会包括该字段。<br>而此时需要获取用户信息，包括name、gender、birthday、email等，<br>因此需要重新定义一个序列化类<code>UserDetailSerializer</code>，并且对于用户注册和获取信息，<br><code>UserViewSet</code>也需要实现动态设置序列化，即重写<code>get_serializer_class()</code>方法。</p>
<p><code>users/serializers.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserDetailSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="string">"""用户详情序列化"""</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = User</span><br><span class="line">        fields = (<span class="string">"name"</span>, <span class="string">"gender"</span>, <span class="string">"birthday"</span>, <span class="string">"email"</span>, <span class="string">"mobile"</span>)</span><br></pre></td></tr></tbody></table></figure>

<p>用户在进个人中心的时候，用户并不知道这个id，也就无法拼凑users/id/的url。<br>action只有使用了viewsets的好处，判断当前的动作是什么，例如POST、GET等。这里面的action的值对应mixins中的各种类方法名称</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserViewSet</span>(<span class="params">CreateModelMixin, RetrieveModelMixin, viewsets.GenericViewSet</span>):</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    list:用户列表</span></span><br><span class="line"><span class="string">    retrieve:</span></span><br><span class="line"><span class="string">        根据ID查询到用户详情</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    queryset = User.objects.filter(is_delete=<span class="literal">False</span>)</span><br><span class="line">    <span class="comment"># serializer_class = UserSerializer  # 改用get_serializer_class</span></span><br><span class="line">    <span class="comment"># permissions = [IsAuthenticated]  # 改用get_permissions</span></span><br><span class="line">    authentication_classes = [JWTAuthentication, SessionAuthentication]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_permissions</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        动态设置不同的action动作拥有不同的权限列表</span></span><br><span class="line"><span class="string">        1.用户注册的时候不应该有权限限制</span></span><br><span class="line"><span class="string">        2.当想获取用户详情信息的时候，必须登录才行</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> self.action == <span class="string">"retrieve"</span>:</span><br><span class="line">            <span class="keyword">return</span> [IsAuthenticated()]  <span class="comment"># 一定要加()表明返回它的实例</span></span><br><span class="line">        <span class="keyword">elif</span> self.action == <span class="string">"create"</span>:</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_serializer_class</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        动态设置不同的action动作拥有不同的序列化方式</span></span><br><span class="line"><span class="string">        1.UserSerializer（用户注册），只返回username和mobile，会员中心页面需要显示更多字段，</span></span><br><span class="line"><span class="string">        2.如果注册的使用创建一个UserDetailSerializer，又会导致验证失败，所以需要动态的使用serializer</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> self.action == <span class="string">"retrieve"</span>:</span><br><span class="line">            <span class="keyword">return</span> UserDetailSerializer  <span class="comment"># 返回类名，不需要实例化</span></span><br><span class="line">        <span class="keyword">elif</span> self.action == <span class="string">"create"</span>:</span><br><span class="line">            <span class="keyword">return</span> UserSerializer</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> UserDetailSerializer</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_object</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        Returns the object the view is displaying.返回视图显示的对象</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        You may want to override this if you need to provide non-standard</span></span><br><span class="line"><span class="string">        queryset lookups. 如果需要提供非标准的查询集查找，则可能需要重写此项</span></span><br><span class="line"><span class="string">        重写get_object方法，</span></span><br><span class="line"><span class="string">        继承了Retrieve获取用户详情和和DestroyModelMixin，</span></span><br><span class="line"><span class="string">        不管url传递id为多少，都只返回当前登录的用户</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">return</span> self.request.user</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/05/31/drf-yong-hu-zhu-ce-he-biao-dan-deng-lu-token/13.png" alt="description"><br><img src="/2021/05/31/drf-yong-hu-zhu-ce-he-biao-dan-deng-lu-token/14.png" alt="description"><br><img src="/2021/05/31/drf-yong-hu-zhu-ce-he-biao-dan-deng-lu-token/15.png" alt="description"><br><img src="/2021/05/31/drf-yong-hu-zhu-ce-he-biao-dan-deng-lu-token/16.png" alt="description"><br><img src="/2021/05/31/drf-yong-hu-zhu-ce-he-biao-dan-deng-lu-token/17.png" alt="description"></p>
<h3 id="用户个人信息修改"><a href="#用户个人信息修改" class="headerlink" title="用户个人信息修改"></a>用户个人信息修改</h3><p>在个人中心中可以修改姓名、出生日期、性别和电子邮件地址等，在修改之前，需要显示用户信息，所以需要定义获取用户信息的接口，并且需要进行权限验证，<br>只需要多添加一个继承<code>mixins.UpdateModelMixin</code>就可以了</p>
<p>url也不需要去配置，接受PUT（更新）、PATCH（部分更新）操作。</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserViewset</span>(<span class="params">UpdateModelMixin, viewsets.GenericViewSet</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    update:</span></span><br><span class="line"><span class="string">        用户个人信息修改</span></span><br><span class="line"><span class="string">    """</span></span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/05/31/drf-yong-hu-zhu-ce-he-biao-dan-deng-lu-token/17.png" alt="description"></p>
<hr>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings  <span class="comment"># 不要用相对导入的方式导入配置文件</span></span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> JsonResponse</span><br><span class="line"><span class="keyword">from</span> .model <span class="keyword">import</span> UserProfile</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_token</span>(<span class="params">username, expire=<span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span></span>):</span></span><br><span class="line">    <span class="string">"""生成 token，有效期一天"""</span></span><br><span class="line">    <span class="keyword">import</span> jwt</span><br><span class="line">    now = time.time()</span><br><span class="line">    key = settings.SECRET_KEY</span><br><span class="line">    payload = {<span class="string">'username'</span>: username, <span class="string">'exp'</span>: int(now + expire)}</span><br><span class="line">    token = jwt.encode(payload, key, algorithm=<span class="string">'HS256'</span>)  <span class="comment"># 生成str类型</span></span><br><span class="line">    <span class="keyword">return</span> token</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="string">"""注册用户"""</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</span><br><span class="line">        <span class="comment"># 获取前端数据</span></span><br><span class="line">        data = request.body</span><br><span class="line">        json_obj = json.loads(data)</span><br><span class="line">        username = json_obj[<span class="string">'username'</span>]</span><br><span class="line">        email = json_obj[<span class="string">'email'</span>]</span><br><span class="line">        password = json_obj[<span class="string">'password'</span>]</span><br><span class="line">        phone = json_obj[<span class="string">'phone'</span>]</span><br><span class="line">        <span class="keyword">if</span> len(password) &lt; <span class="number">6</span>:</span><br><span class="line">            result = {<span class="string">'code'</span>: <span class="number">10100</span>, <span class="string">'error'</span>: <span class="string">'Password lenth is wrong'</span>}</span><br><span class="line">            <span class="keyword">return</span> JsonResponse(result)</span><br><span class="line">        <span class="comment"># 用户名是否可用；已注册的话给个错误返回</span></span><br><span class="line">        old_user = UserProfile.objects.filter()</span><br><span class="line">        <span class="keyword">if</span> old_user:</span><br><span class="line">            result = {<span class="string">'code'</span>: <span class="number">10101</span>, <span class="string">'error'</span>: <span class="string">'Your name is already existed'</span>}</span><br><span class="line">            <span class="keyword">return</span> JsonResponse(result)</span><br><span class="line">        <span class="comment"># 创建用户也避免同时注册相同名字，密码用md5</span></span><br><span class="line">        m = hashlib.md5()</span><br><span class="line">        m.update(password.encode())  <span class="comment"># 参数为bytes</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            user = UserProfile.objects.create(username=username, password=m.hexdigest(), email=email, phone=phone)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            result = {<span class="string">'code'</span>: <span class="number">10102</span>, <span class="string">'error'</span>: <span class="string">'Your name is used'</span>}</span><br><span class="line">            <span class="keyword">return</span> JsonResponse(result)</span><br><span class="line">        <span class="comment"># 用jwt签发token有效期1天, token里面存放username: xxxx</span></span><br><span class="line">        token = generate_token(username)</span><br><span class="line">        <span class="keyword">return</span> JsonResponse({<span class="string">'code'</span>: <span class="number">200</span>, <span class="string">'username'</span>: username, <span class="string">'data'</span>: {<span class="string">'token'</span>: token}, <span class="string">'cart_count'</span>: <span class="number">0</span>})</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="string">"""登录验证"""</span></span><br><span class="line">    <span class="keyword">if</span> request.method != <span class="string">'POST'</span>:</span><br><span class="line">        result = {<span class="string">'code'</span>: <span class="number">10200</span>, <span class="string">'error'</span>: <span class="string">'Please send POST`s request'</span>}</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(result)</span><br><span class="line">    <span class="comment"># 获取前端数据</span></span><br><span class="line">    json_str = request.body</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> json_str:</span><br><span class="line">        result = {<span class="string">'code'</span>: <span class="number">10201</span>, <span class="string">'error'</span>: <span class="string">'Please give me data'</span>}</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(result)</span><br><span class="line"></span><br><span class="line">    json_obj = json.loads(json_str)  <span class="comment"># 转换为dict</span></span><br><span class="line"></span><br><span class="line">    username = json_obj.get(<span class="string">'username'</span>)</span><br><span class="line">    password = json_obj.get(<span class="string">'password'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> username:  <span class="comment"># 没有输入用户名提交</span></span><br><span class="line">        result = {<span class="string">'code'</span>: <span class="number">10202</span>, <span class="string">'error'</span>: <span class="string">'Please give me username'</span>}</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(result)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> password:  <span class="comment"># 没有输入密码提交</span></span><br><span class="line">        result = {<span class="string">'code'</span>: <span class="number">10203</span>, <span class="string">'error'</span>: <span class="string">'Please give me password'</span>}</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(result)</span><br><span class="line"></span><br><span class="line">    user = UserProfile.objects.filter(username=username)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> user:  <span class="comment"># 不存在的用户名提交</span></span><br><span class="line">        result = {<span class="string">'code'</span>: <span class="number">10204</span>, <span class="string">'error'</span>: <span class="string">'The username or password is wrong'</span>}</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(result)</span><br><span class="line"></span><br><span class="line">    user = user[<span class="number">0</span>]  <span class="comment"># user存在只有一个，因为加了unique唯一约束</span></span><br><span class="line">    <span class="comment"># 对比密码</span></span><br><span class="line">    p_m = hashlib.md5()  <span class="comment"># 生成md5对象</span></span><br><span class="line">    p_m.update(password.encode())</span><br><span class="line">    <span class="keyword">if</span> p_m.hexdigest() != user.password:</span><br><span class="line">        result = {<span class="string">'code'</span>: <span class="number">10205</span>, <span class="string">'error'</span>: <span class="string">'The username or password is wrong'</span>}</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(result)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 生成token</span></span><br><span class="line">    token = generate_token(username)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> JsonResponse({<span class="string">'code'</span>: <span class="number">200</span>, <span class="string">'username'</span>: username, <span class="string">'data'</span>: {<span class="string">'token'</span>: token}, <span class="string">'cart_count'</span>: <span class="number">0</span>})</span><br></pre></td></tr></tbody></table></figure>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/05/29/django-jie-ru-pian-yun-wang-duan-xin-yan-zheng-dan-tiao-fa-song/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/29/django-jie-ru-pian-yun-wang-duan-xin-yan-zheng-dan-tiao-fa-song/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-05-29 04:22:45" itemprop="dateCreated datePublished" datetime="2021-05-29T04:22:45Z">2021-05-29</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-06-17 02:20:01" itemprop="dateModified" datetime="2021-06-17T02:20:01Z">2021-06-17</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>django 接入片云片网</p>
<h2 id="云片网单条发送短信"><a href="#云片网单条发送短信" class="headerlink" title="云片网单条发送短信"></a>云片网单条发送短信</h2><p>在注册页面输入手机号发送验证码，后端需要有相应的接口来发送验证码，在成功和失败后需要进行相应的操作。<br>发送短信验证码需要使用第三方服务，可以使用云片网、阿里妈妈等平台的短信验证码服务，这里选择云片网。</p>
<p><a target="_blank" rel="noopener" href="https://www.yunpian.com/doc/zh_CN/domestic/single_send.html">https://www.yunpian.com/doc/zh_CN/domestic/single_send.html</a><br><a target="_blank" rel="noopener" href="https://www.yunpian.com/official/document/sms/zh_cn/domestic_single_send">https://www.yunpian.com/official/document/sms/zh_cn/domestic_single_send</a></p>
<p>（1）注册</p>
<p> “开发认证”–&gt;&gt;“签名管理”–&gt;&gt;“模板管理”<br>申请自己的签名和模板</p>
<p>在系统设置里面加入IP白名单，测试就用本地ip，部署的时候一定要换成服务器的ip</p>
<p>（2）发送验证码<br>请求参数中必传参数为apikey、mobile和text。</p>
<p>apps下新建<code>utils</code>包。再新建 <code>apps/utils/yunpian.py</code>，代码如下：</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">YunPian</span>(<span class="params">object</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, api_key</span>):</span></span><br><span class="line">        self.api_key = api_key</span><br><span class="line">        self.single_send_url = <span class="string">"https://sms.yunpian.com/v2/sms/single_send.json"</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">send_sms</span>(<span class="params">self, code, mobile</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        调用短信服务商API发送短信验证码</span></span><br><span class="line"><span class="string">        :param code: 验证码</span></span><br><span class="line"><span class="string">        :param mobile: 手机号码</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        parmas = {</span><br><span class="line">            <span class="string">"apikey"</span>: self.api_key,</span><br><span class="line">            <span class="string">"mobile"</span>: mobile,</span><br><span class="line">            <span class="comment"># 这个text的值要跟你模板内容一模一样</span></span><br><span class="line">            <span class="string">"text"</span>: <span class="string">"【慕雪生鲜超市】您的验证码是{code}。如非本人操作，请忽略本短信"</span>.format(code=code)</span><br><span class="line">        }</span><br><span class="line">        <span class="comment"># 发送post请求  请求的地址self.single_send_url  发送的数据data=params</span></span><br><span class="line">        response = requests.post(self.single_send_url, data=parmas)</span><br><span class="line">        <span class="comment"># response.text是json数据，把json数据转换成字典</span></span><br><span class="line">        re_dict = json.loads(response.text)</span><br><span class="line">        <span class="keyword">return</span> re_dict</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="comment"># 例如：9b11127a9701975c734b8aee81ee3526</span></span><br><span class="line">    yun_pian = YunPian(<span class="string">"2e87d17327d4be01608f7c6da23ecea2"</span>)  <span class="comment"># 改为你自己的apikey</span></span><br><span class="line">    yun_pian.send_sms(<span class="string">"2021"</span>, <span class="string">"13312345678"</span>)  <span class="comment"># 改为你自己的手机号</span></span><br></pre></td></tr></tbody></table></figure>

<p>运行该文件，打印：</p>
<figure class="highlight 1c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">{'code': <span class="number">0</span>, 'msg': '发送成功', 'count': <span class="number">1</span>, 'fee': <span class="number">0.05</span>, 'unit': 'RMB', 'mobile': '<span class="number">1331234567</span>8', 'sid': <span class="number">56592475448</span>}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="drf实现发送短信验证码接口"><a href="#drf实现发送短信验证码接口" class="headerlink" title="drf实现发送短信验证码接口"></a>drf实现发送短信验证码接口</h2><p>在发送短信验证码前需要进行验证，包括</p>
<ul>
<li>手机号是否合法</li>
<li>是否被注册</li>
<li>注册验证码发送频率</li>
</ul>
<p><code>settings.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 手机号码正则表达式</span></span><br><span class="line">REGEX_MOBILE = <span class="string">"^1[358]\d{9}$|^147\d{8}$|^176\d{8}$"</span></span><br></pre></td></tr></tbody></table></figure>

<p><code>users/serializers.py</code>中进行验证</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, timedelta</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth <span class="keyword">import</span> get_user_model</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings  <span class="comment"># 不要用相对导入的方式导入配置文件</span></span><br><span class="line"><span class="keyword">from</span> users.models <span class="keyword">import</span> VerifyCode</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SmsSerializer</span>(<span class="params">serializers.Serializer</span>):</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    短信验证码序列化</span></span><br><span class="line"><span class="string">    不用ModelSerializer原因：发送验证码只需要提交手机号码</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    mobile = serializers.CharField(max_length=<span class="number">11</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate_mobile</span>(<span class="params">self, mobile</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        自定义单一字段验证，函数名必须：validate + _ + 验证字段名</span></span><br><span class="line"><span class="string">        手机号码验证</span></span><br><span class="line"><span class="string">        形参名随便写</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 验证手机是否注册</span></span><br><span class="line">        <span class="keyword">if</span> User.objects.filter(mobile=mobile).count():</span><br><span class="line">            <span class="keyword">raise</span> serializers.ValidationError(<span class="string">"用户已经存在"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 验证手机号码是否合法</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> re.match(settings.REGEX_MOBILE, mobile):</span><br><span class="line">            <span class="keyword">raise</span> serializers.ValidationError(<span class="string">"手机号格式有误，请重新输入"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 验证码发送频率 60s内只能发送一次</span></span><br><span class="line">        one_mintes_ago = datetime.now() - timedelta(hours=<span class="number">0</span>, minutes=<span class="number">1</span>, seconds=<span class="number">0</span>)  <span class="comment"># 获取一分钟以前的时间</span></span><br><span class="line">        <span class="keyword">if</span> VerifyCode.objects.filter(add_time__gt=one_mintes_ago, mobile=mobile).count():</span><br><span class="line">            <span class="comment"># 如果添加时间大于一分钟以前的时间，则在这一分钟内已经发过短信，不允许再次发送</span></span><br><span class="line">            <span class="keyword">raise</span> serializers.ValidationError(<span class="string">"距离上一次发送未超过60s"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> mobile</span><br></pre></td></tr></tbody></table></figure>

<p>APIKEY加到<code>settings.py</code>里面</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 云片网APIKEY</span></span><br><span class="line">APIKEY = <span class="string">"xxxxx327d4be01608xxxxxxxxxx"</span></span><br></pre></td></tr></tbody></table></figure>

<p><code>apps/users/views.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.mixins <span class="keyword">import</span> CreateModelMixin</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> viewsets</span><br><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> SmsSerializer</span><br><span class="line"><span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> status</span><br><span class="line"><span class="keyword">from</span> utils.yunpian <span class="keyword">import</span> YunPian</span><br><span class="line"><span class="keyword">from</span> MxShop.settings <span class="keyword">import</span> APIKEY</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> choice</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> VerifyCode</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SmsCodeViewSet</span>(<span class="params">CreateModelMixin, viewsets.GenericViewSet</span>):</span></span><br><span class="line">    <span class="string">'''手机验证码'''</span></span><br><span class="line">    queryset = VerifyCode.objects.all()</span><br><span class="line">    serializer_class = SmsSerializer</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">generate_code</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">"""生成四位数字的验证码"""</span></span><br><span class="line">        seeds = <span class="string">"1234567890"</span></span><br><span class="line">        random_str = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">            random_str.append(choice(seeds))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span>.join(random_str)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="string">"""重写CreateModelMixin的create. Create a model instance."""</span></span><br><span class="line">        serializer = self.get_serializer(data=request.data)</span><br><span class="line">        <span class="comment"># 验证合法，出错就会抛出异常，由DRF捕捉返回400状态码，便于在前端查看。</span></span><br><span class="line">        serializer.is_valid(raise_exception=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">        mobile = serializer.validated_data[<span class="string">"mobile"</span>]  <span class="comment"># 直接取mobile，上方无异常，那么mobile字段肯定是有的</span></span><br><span class="line"></span><br><span class="line">        yun_pian = YunPian(APIKEY)</span><br><span class="line">        <span class="comment"># 生成验证码</span></span><br><span class="line">        code = self.generate_code()</span><br><span class="line"></span><br><span class="line">        sms_status = yun_pian.send_sms(code=code, mobile=mobile)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> sms_status[<span class="string">"code"</span>] != <span class="number">0</span>:  <span class="comment"># 云片发送短信成功返回0</span></span><br><span class="line">            <span class="keyword">return</span> Response({</span><br><span class="line">                <span class="string">"mobile"</span>: sms_status[<span class="string">"msg"</span>]</span><br><span class="line">            }, status=status.HTTP_400_BAD_REQUEST)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            code_record = VerifyCode(code=code, mobile=mobile)  <span class="comment"># 短信发送成功之后创建数据</span></span><br><span class="line">            code_record.save()  <span class="comment"># 保存到数据库</span></span><br><span class="line">            <span class="keyword">return</span> Response({</span><br><span class="line">                <span class="string">"mobile"</span>: mobile</span><br><span class="line">            }, status=status.HTTP_201_CREATED)</span><br></pre></td></tr></tbody></table></figure>

<p><code>CreateModelMixin</code>源码</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CreateModelMixin</span>(<span class="params">object</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Create a model instance.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        serializer = self.get_serializer(data=request.data)</span><br><span class="line">        serializer.is_valid(raise_exception=<span class="literal">True</span>)</span><br><span class="line">        self.perform_create(serializer)</span><br><span class="line">        headers = self.get_success_headers(serializer.data)</span><br><span class="line">        <span class="keyword">return</span> Response(serializer.data, status=status.HTTP_201_CREATED, headers=headers)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">perform_create</span>(<span class="params">self, serializer</span>):</span></span><br><span class="line">        serializer.save()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_success_headers</span>(<span class="params">self, data</span>):</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> {<span class="string">'Location'</span>: str(data[api_settings.URL_FIELD_NAME])}</span><br><span class="line">        <span class="keyword">except</span> (TypeError, KeyError):</span><br><span class="line">            <span class="keyword">return</span> {}</span><br></pre></td></tr></tbody></table></figure>

<p><code>apps/utils/yunpian.py</code>，代码如下：</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> mx_shop.settings <span class="keyword">import</span> APIKEY</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">YunPian</span>(<span class="params">object</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, api_key</span>):</span></span><br><span class="line">        self.api_key = api_key</span><br><span class="line">        self.single_send_url = <span class="string">"https://sms.yunpian.com/v2/sms/single_send.json"</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">send_sms</span>(<span class="params">self, code, mobile</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        发送验证码</span></span><br><span class="line"><span class="string">        :param code: 验证码</span></span><br><span class="line"><span class="string">        :param mobile: 手机号码</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        parmas = {</span><br><span class="line">            <span class="string">"apikey"</span>: self.api_key,</span><br><span class="line">            <span class="string">"mobile"</span>: mobile,</span><br><span class="line">            <span class="comment"># 这个text的值要跟你模板内容一模一样</span></span><br><span class="line">            <span class="string">"text"</span>: <span class="string">"【慕雪生鲜超市】您的验证码是{code}。如非本人操作，请忽略本短信"</span>.format(code=code)</span><br><span class="line">        }</span><br><span class="line">        <span class="comment"># 发送post请求  请求的地址self.single_send_url  发送的数据data=params</span></span><br><span class="line">        response = requests.post(self.single_send_url, data=parmas)</span><br><span class="line">        <span class="comment"># response.text是json数据，把json数据转换成字典</span></span><br><span class="line">        re_dict = json.loads(response.text)</span><br><span class="line">        <span class="keyword">return</span> re_dict</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="comment"># 例如：9b11127a9701975c734b8aee81ee3526</span></span><br><span class="line">    yun_pian = YunPian(APIKEY)  <span class="comment"># 改为你自己的apikey</span></span><br><span class="line">    yun_pian.send_sms(<span class="string">"2021"</span>, <span class="string">"13312345678"</span>)  <span class="comment"># 改为你自己的手机号</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> users.views <span class="keyword">import</span> SmsCodeViewSet</span><br><span class="line"></span><br><span class="line">router = DefaultRouter()  <span class="comment"># 生成一个实例对象</span></span><br><span class="line"><span class="comment"># 配置短信验证码的路由</span></span><br><span class="line">router.register(<span class="string">'codes'</span>, SmsCodeViewSet)</span><br></pre></td></tr></tbody></table></figure>

<p>开始验证</p>
<p>输入不合法的手机号<br><img src="/2021/05/29/django-jie-ru-pian-yun-wang-duan-xin-yan-zheng-dan-tiao-fa-song/1.png" alt="description"></p>
<p> 输入合法的手机号<br><img src="/2021/05/29/django-jie-ru-pian-yun-wang-duan-xin-yan-zheng-dan-tiao-fa-song/2.png" alt="description"><br>返回输入的手机号码，并受到短信验证码，同时在数据库中也会保存该验证码的内容。</p>
<p>此时查看数据库，可以看到刚刚保存的验证码如下：</p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">+<span class="comment">----+------+-------------+----------------------------+-----------+</span></span><br><span class="line">| id | code | mobile      | add_time                   | is_delete |</span><br><span class="line">+<span class="comment">----+------+-------------+----------------------------+-----------+</span></span><br><span class="line">|  1 | 4745 | 13311111111 | 2020-07-28 17:10:38.142213 |         0 |</span><br><span class="line">+<span class="comment">----+------+-------------+----------------------------+-----------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></tbody></table></figure>

<p>测试注册接口自己添加验证码数据</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/05/29/drf-simplejwt/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/29/drf-simplejwt/" class="post-title-link" itemprop="url">drf-simplejwt</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-05-28 16:21:41" itemprop="dateCreated datePublished" datetime="2021-05-28T16:21:41Z">2021-05-28</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-06-07 06:55:46" itemprop="dateModified" datetime="2021-06-07T06:55:46Z">2021-06-07</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/django/" itemprop="url" rel="index"><span itemprop="name">django</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>JSON Web Token Authentication<br>JSON Web Token is a fairly new standard which can be used for token-based authentication. Unlike the built-in TokenAuthentication scheme, JWT Authentication doesn’t need to use a database to validate a token. A package for JWT authentication is djangorestframework-simplejwt which provides some features as well as a pluggable token blacklist app.</p>
</blockquote>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install djangorestframework-simplejwt</span><br></pre></td></tr></tbody></table></figure>

<p>Some of Simple JWT’s behavior can be customized through settings variables in <code>settings.py</code>:</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">REST_FRAMEWORK = {</span><br><span class="line">    <span class="string">'DEFAULT_AUTHENTICATION_CLASSES'</span>: [</span><br><span class="line">        <span class="comment"># 'rest_framework_simplejwt.authentication.JWTAuthentication',</span></span><br><span class="line">    ],</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment"># JWT自定义配置</span></span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> timedelta</span><br><span class="line">SIMPLE_JWT = {</span><br><span class="line">    <span class="string">'ACCESS_TOKEN_LIFETIME'</span>: timedelta(days=<span class="number">1</span>),  <span class="comment"># 设置token过期时间</span></span><br><span class="line">    <span class="string">'REFRESH_TOKEN_LIFETIME'</span>: timedelta(days=<span class="number">1</span>),  <span class="comment"># 这个时间段内刷新JWT可以保持登录状态</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>token认证最好是放在view里面去配置局部JWTAuthentication认证，不要配置在全局变量中，如果再前端请求中，每一个request都加入token，这个token恰好过期了，那么用户在访问category、goods这种公开数据时，就会抛异常，连商品的列表页都访问不了了。</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> permissions</span><br><span class="line"><span class="keyword">from</span> rest_framework_simplejwt <span class="keyword">import</span> authentication</span><br><span class="line"><span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> APIView</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    permission_classes = [permissions.IsAuthenticated]</span><br><span class="line">    authentication_classes = [authentication.JWTAuthentication]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="keyword">return</span> Response(<span class="string">'ok'</span>)</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework_simplejwt.views <span class="keyword">import</span> (</span><br><span class="line">    TokenObtainPairView,</span><br><span class="line">    TokenRefreshView,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">'api/auth/token/obtain/'</span>, TokenObtainPairView.as_view()),  <span class="comment"># 不需要添加的内容</span></span><br><span class="line">    path(<span class="string">'api/auth/token/refresh/'</span>, TokenRefreshView.as_view()),  <span class="comment"># 不需要添加的内容</span></span><br><span class="line">    path(<span class="string">'api/test/'</span>, TestView.as_view()),  <span class="comment"># 添加测试views的路由</span></span><br><span class="line">]</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/05/29/drf-simplejwt/1.png" alt="description"></p>
<p>使用返回的<code>access</code> 这个就是<code>token</code>但是框架里叫做<code>access</code>，验证受保护视图的身份验证。</p>
<p>验证格式为：<code>Authorization: Bearer [access对应的值]</code> 不再是<code>Token</code></p>
<p>当这个短暂的access token过期时，可以使用较长时间的refresh token获得另一个accesstoken。<br>页面上测试使用这个access请求，同样在list函数中打上断点。进入调试状态。</p>
<p>refresh：当前端token过期需要刷新token的时候就可以访问<a href="api/token/refresh">api/token/refresh</a>，<br>表单参数就是refresh的值。将refresh的值传入后POST提交得到新的access</p>
<p><img src="/2021/05/29/drf-simplejwt/2.png" alt="description"></p>
<h3 id="手动为用户创建令牌"><a href="#手动为用户创建令牌" class="headerlink" title="手动为用户创建令牌"></a>手动为用户创建令牌</h3><p><a target="_blank" rel="noopener" href="https://django-rest-framework-simplejwt.readthedocs.io/en/latest/creating_tokens_manually.html">https://django-rest-framework-simplejwt.readthedocs.io/en/latest/creating_tokens_manually.html</a><br>Sometimes, you may wish to manually create a token for a user. This could be done as follows:</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework_simplejwt.tokens <span class="keyword">import</span> RefreshToken</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_tokens_for_user</span>(<span class="params">user</span>):</span></span><br><span class="line">    refresh = RefreshToken.for_user(user)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> {</span><br><span class="line">        <span class="string">'refresh'</span>: str(refresh),</span><br><span class="line">        <span class="string">'access'</span>: str(refresh.access_token),</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure>

<p>The above function <code>get_tokens_for_user</code> will return the serialized representations of new refresh and access tokens for the given user.<br>In general, a token for any subclass of <code>rest_framework_simplejwt.tokens.Token</code> can be created in this way.</p>
<p><code>get_tokens_for_user</code>将返回给定用户的新<code>refresh</code>和<code>access tokens</code>的序列化表示。<br>通常，<code>rest_framework_simplejwt.token</code>的任何子类的令牌。可以用这种方式创建令牌。</p>
<p>自定义djangorestframework-simplejwt</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework_simplejwt.serializers <span class="keyword">import</span> TokenObtainPairSerializer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyTokenObtainPairSerializer</span>(<span class="params">TokenObtainPairSerializer</span>):</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    token验证</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate</span>(<span class="params">self, attrs</span>):</span></span><br><span class="line">        data = super().validate(attrs)</span><br><span class="line"></span><br><span class="line">        refresh = self.get_token(self.user)</span><br><span class="line"></span><br><span class="line">        data[<span class="string">'refresh'</span>] = str(refresh)</span><br><span class="line">        data[<span class="string">'access'</span>] = str(refresh.access_token)</span><br><span class="line">        data[<span class="string">'username'</span>] = self.user.username <span class="comment">#这个是你的自定义返回的</span></span><br><span class="line">        data[<span class="string">'user_id'</span>] = self.user.id <span class="comment">#这个是你的自定义返回的</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> data</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework_simplejwt.views <span class="keyword">import</span> TokenViewBase</span><br><span class="line"><span class="keyword">from</span> rest_framework_simplejwt.serializers <span class="keyword">import</span> TokenRefreshSerializer</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyTokenObtainPairView</span>(<span class="params">TokenObtainPairView</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    自定义得到token username: 账号或者密码 password: 密码或者验证码</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    serializer_class = MyTokenObtainPairSerializer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyTokenRefreshView</span>(<span class="params">TokenViewBase</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    自定义刷新token refresh: 刷新token的元素</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    serializer_class = TokenRefreshSerializer</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">'api/test/'</span>, MyTokenObtainPairView.as_view()),  <span class="comment"># 添加测试views的路由</span></span><br><span class="line">]</span><br></pre></td></tr></tbody></table></figure>


<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">    <span class="attr">"msg"</span>: <span class="string">"success"</span>,</span><br><span class="line">    <span class="attr">"code"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"data"</span>: {</span><br><span class="line">        <span class="attr">"refresh"</span>: <span class="string">"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ0b2tlbl90eXBlIjoicmVmcmVzaCIsImV4cCI6MTU4NjMxMjYyOSwianRpIjoiZWUzNTQxNmIzMDZjNDIyY2EyOWFiOGQ5NjhlNjc3ZWYiLCJ1c2VyX2lkIjoxfQ.th5AfYNsd9UK3zL9LEhnDRNrd37Ut8ucl-G9VzYlCHI"</span>,</span><br><span class="line">        <span class="attr">"access"</span>: <span class="string">"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ0b2tlbl90eXBlIjoiYWNjZXNzIiwiZXhwIjoxNTg1NjIxNDI5LCJqdGkiOiJlYmI3ZDdmOTBlNzU0OTNkYjM4NTNiNTJkYzA0Yjk3NiIsInVzZXJfaWQiOjF9.WeoTxQ2rG0BOl9ji6KO3yfLm83kcsHV1drFDxGxAvGA"</span>,</span><br><span class="line">        <span class="attr">"username"</span>: <span class="string">"hahn"</span>,</span><br><span class="line">        <span class="attr">"user_id"</span>: <span class="number">1</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>刷新token</p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">    <span class="attr">"msg"</span>: <span class="string">"success"</span>,</span><br><span class="line">    <span class="attr">"code"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"data"</span>: {</span><br><span class="line">        <span class="attr">"access"</span>: <span class="string">"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ0b2tlbl90eXBlIjoiYWNjZXNzIiwiZXhwIjoxNTg1NjIxNTIyLCJqdGkiOiI4MzcyN2UwYWVhMDU0MWYyYmE1ODljOWY5NTMzYjE2OSIsInVzZXJfaWQiOjF9.NTo1YKFl9tvcCYQVmBWLz0rhRL8044qT65jbe7okeG0"</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>jwt解码</p>
<p>源码</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TokenVerifySerializer</span>(<span class="params">serializers.Serializer</span>):</span></span><br><span class="line">    token = serializers.CharField()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate</span>(<span class="params">self, attrs</span>):</span></span><br><span class="line">        UntypedToken(attrs[<span class="string">'token'</span>])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> {}</span><br></pre></td></tr></tbody></table></figure>

<p>根据token返回对于的数据</p>
<p><code>serializers.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework_simplejwt.serializers <span class="keyword">import</span> TokenVerifySerializer</span><br><span class="line"><span class="keyword">from</span> jwt <span class="keyword">import</span> decode</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyTokenVerifySerializer</span>(<span class="params">TokenVerifySerializer</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    token验证</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate</span>(<span class="params">self, attrs</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        attrs['token']: 是请求的token</span></span><br><span class="line"><span class="string">        settings.SECRET_KEY: setting.py默认的key 除非在配置文件中修改了</span></span><br><span class="line"><span class="string">        algorithms: 加密的方法</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        decoded_data = decode(attrs[<span class="string">'token'</span>], settings.SECRET_KEY, algorithms=[<span class="string">"HS256"</span>])</span><br><span class="line">        <span class="keyword">return</span> decoded_data</span><br></pre></td></tr></tbody></table></figure>

<p><code>views.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework_simplejwt.views <span class="keyword">import</span> TokenObtainPairView, TokenViewBase</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyTokenVerifyView</span>(<span class="params">TokenViewBase</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    验证token得到用户信息 token: 验证的token</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    serializer_class = MyTokenVerifySerializer</span><br></pre></td></tr></tbody></table></figure>

<p>返回的数据<br>user_id就是你的用户ID</p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">    <span class="attr">"msg"</span>: <span class="string">"success"</span>,</span><br><span class="line">    <span class="attr">"status"</span>: <span class="number">200</span>,</span><br><span class="line">    <span class="attr">"data"</span>: {</span><br><span class="line">        <span class="attr">"token_type"</span>: <span class="string">"access"</span>,</span><br><span class="line">        <span class="attr">"exp"</span>: <span class="number">1585710741</span>,</span><br><span class="line">        <span class="attr">"jti"</span>: <span class="string">"97b42a6570d84108bf09701a60fbf5c1"</span>,</span><br><span class="line">        <span class="attr">"user_id"</span>: <span class="number">1</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="djangorestframework-simplejwt退出登录"><a href="#djangorestframework-simplejwt退出登录" class="headerlink" title="djangorestframework-simplejwt退出登录"></a>djangorestframework-simplejwt退出登录</h3><p>JWT是不带退出内置的办法的<br>JWT退出登录很多方法<br>我这里是使用Django-redis库、用redis管理JWT的状态。用用户作为key保存token。</p>
<p><code>setting.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># redis配置</span></span><br><span class="line">CACHES = {</span><br><span class="line">    <span class="string">"default"</span>: {</span><br><span class="line">        <span class="string">"BACKEND"</span>: <span class="string">"django_redis.cache.RedisCache"</span>,</span><br><span class="line">        <span class="string">"LOCATION"</span>: <span class="string">"redis://127.0.0.1:6379"</span>,</span><br><span class="line">        <span class="string">"OPTIONS"</span>: {</span><br><span class="line">            <span class="string">"CLIENT_CLASS"</span>: <span class="string">"django_redis.client.DefaultClient"</span>,</span><br><span class="line">            <span class="string">"PASSWORD"</span>: <span class="string">""</span>,</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment"># redis缓存时间</span></span><br><span class="line">REDIS_TIMEOUT = <span class="number">60</span>*<span class="number">60</span>*<span class="number">24</span>*<span class="number">7</span></span><br></pre></td></tr></tbody></table></figure>

<p>保存redis缓存</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.core.cache <span class="keyword">import</span> cache</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 设置redis缓存</span></span><br><span class="line">        <span class="comment"># redis_key你的key</span></span><br><span class="line">        <span class="comment"># token token</span></span><br><span class="line">        <span class="comment"># REDIS_TIMEOUT 保存的数据</span></span><br><span class="line">        cache.set(redis_key, token, REDIS_TIMEOUT)</span><br></pre></td></tr></tbody></table></figure>

<p>清除redis缓存<br>我这里是把value变成空了、方便判断</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置redis缓存</span></span><br><span class="line"><span class="comment"># redis_key你的key</span></span><br><span class="line"><span class="comment"># REDIS_TIMEOUT 保存的数据</span></span><br><span class="line">cache.set(redis_key,<span class="string">''</span>, REDIS_TIMEOUT)</span><br></pre></td></tr></tbody></table></figure>

<p>查看redis缓存</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 解码token得到user_id</span></span><br><span class="line">decoded_data = jwt_decode(token algorithms=[<span class="string">"HS256"</span>])</span><br><span class="line"><span class="comment"># redis_key 你设置的redis的key</span></span><br><span class="line">results = cache.get(redis_key)</span><br><span class="line"><span class="comment"># 判断、写自己的业务逻辑</span></span><br></pre></td></tr></tbody></table></figure>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/05/24/pyjwt/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/24/pyjwt/" class="post-title-link" itemprop="url">drf认证和权限</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-05-23 16:21:41" itemprop="dateCreated datePublished" datetime="2021-05-23T16:21:41Z">2021-05-23</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-06-12 04:46:31" itemprop="dateModified" datetime="2021-06-12T04:46:31Z">2021-06-12</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/django/" itemprop="url" rel="index"><span itemprop="name">django</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前后端分离下-微信小程序-app的用户登录"><a href="#前后端分离下-微信小程序-app的用户登录" class="headerlink" title="前后端分离下/微信小程序/app的用户登录"></a>前后端分离下/微信小程序/app的用户登录</h1><p>HTTP是无状态的，一次请求结束连接断开，下次服务器再收到请求，它就不知道这个请求是哪个用户发过来的。<br>但是对于一个Web应用而言，它是需要有状态管理的，这样才能让服务器知道HTTP请求来自哪个用户，从而判断是否允许该用户请求以及为用户提供更好的服务，这个过程就是常说的<strong>会话管理</strong>。</p>
<p>之前我们做会话管理（用户跟踪）的方法是：用户登录成功后，在服务器端通过一个session对象保存用户相关数据，然后把session对象的ID写入浏览器的cookie中；<br>下一次请求时，HTTP请求头中携带cookie的数据，<br>服务器从HTTP请求头读取cookie中的sessionid，根据这个标识符找到对应的session对象，这样就能够获取到之前保存在session中的用户数据。</p>
<p>REST架构是最适合互联网应用的架构，它强调了HTTP的无状态性，这样才能保证应用的水平扩展能力（当并发访问量增加时，可以通过增加新的服务器节点来为系统扩容）。<br>基于session实现用户跟踪的方式需要服务器保存session对象在内存中，每个用户经过我们的应用认证之后，我们的应用都要在服务端做一次记录，以方便用户下次请求的鉴别，而随着认证用户和多个客户端的增多，在做水平扩展增加新的服务器节点时，需要复制和同步session对象，服务端的开销会明显增大</p>
<ol>
<li>相比<code>JWT</code>，最大的优势就在于可以主动清除 <code>session</code>。</li>
<li><code>session</code>保存在服务器端，相对较为安全。</li>
<li>结合<code>cookie</code>使用，较为灵活，兼容性较好。但是在跨域场景表现不好。<br>cookie是用来前后端传输来做用户识别的，cookie如果被截获，用户就会很容易受到跨站请求伪造的攻击。</li>
</ol>
<p>解决这个问题有两种方案，<br>一种是架设缓存服务器（如Redis），让多个服务器节点共享缓存服务并将session对象直接置于缓存服务器中；<br>当用户对其他的接口访问时，必须携带这个token，接着服务器判断这个token是否存在与redis中，来判断用户是否已经登陆或者是否有相应的权限</p>
<p>另一种方式放弃基于session的用户跟踪，使用<strong>基于token令牌的用户跟踪</strong>。<br>传统的token是某个用户登录成功之后，服务器生成一个随机token给用户保存，并且服务器(数据库或缓存)保留同一份token，以后用户再来访问时需携带 token，服务端接收到 token 之后，去数据库或缓存中进行校验 token 的是否超时、是否合法</p>
<p>基于token的用户跟踪具体流程如下：</p>
<ol>
<li>用户使用用户名密码来请求服务器，服务器进行验证用户的信息，如果登录成功，服务器为用户加密生成一个字符串（token）令牌发给作客户端作为请求的一个身份标识，<br>该令牌中通常包含了用户标识、过期时间等信息而且需要加密并生成指纹（避免伪造或篡改令牌），</li>
<li>前端获取到服务器返回的token，保存在浏览器本地存储（可以保存在<code>localStorage</code>或<code>sessionStorage</code>中，对于使用Vue.js的前端项目来说，还可以通过Vuex进行状态管理）；</li>
<li>对于使用了前端路由的项目来说，前端每次路由跳转，可以先判断<code>localStroage</code>中有无token，如果没有则跳转到登录页；通过js取出本地数据按需使用这个数据，</li>
<li>以后每次请求后端数据接口，客户端只需在HTTP请求头里携带token来请求数据，无需再次带上用户名和密码。服务端后端接口判断请求头有无token，如果没有token以及token是无效的或过期的，服务器统一返回401；</li>
<li>如果前端收到HTTP响应状态码401，则重定向到登录页面。</li>
</ol>
<p>在很多项目案例中，需要实现账户的功能，客户端所有的功能都基于用户已登陆的前提下才可以使用。<br>这就要求每次客户端像服务器请求数据时都要验证账户是否正确，<br>如果正确则按正常方式返回数据，如果错误则进行拦截并返回错误信息。<br>但是当客户端频繁向服务器请求数据的话，每次服务器都要频繁地查询数据库。<br>而Token正是为了减轻服务器的压力，减少频繁的查询数据库，使服务器更加健壮。并取代传统使用session的方法来进行验证。</p>
<p>相比于sesssion保存在服务器，JWT是不用保存的。<br>这样的话服务器不需要保存用户状态，从而可以很容易的做到水平扩展。</p>
<p>生成token的方法很多，其中一种比较成熟的解决方案是使用JSON Web Token。</p>
<h2 id="JWT概述"><a href="#JWT概述" class="headerlink" title="JWT概述"></a>JWT概述</h2><p>官网<a target="_blank" rel="noopener" href="https://jwt.io/">https://jwt.io/</a> 根据前2个部分和右小叫的key，计算第三部分的signature，和自己生成的对比<br>JSON Web Token JWT，它是一种开放标准（RFC 7519）。<br>它定义了一套简洁紧凑（compact）且 URL 安全（URL-safe）的方案，<br>以安全地在客户端和服务器网络应用环境之间传输 JSON 格式的信息。<br>JWT的声明一般被用来在身份提供者和服务提供者间传递被认证的用户身份信息，以便于从资源服务器获取资源，也可以增加一些额外的其它业务逻辑所必须的声明信息，该token也可直接被用于认证，也可被加密<br>随着RESTful架构前后端分离、分布式站点的单点登录（SSO）场景的项目使用JWT作为用户身份认证的方式。</p>
<p><img src="/2021/05/24/pyjwt/json-web-token.png"></p>
<ol>
<li><p>头部</p>
 <figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"alg"</span>: <span class="string">"HS256"</span>,</span><br><span class="line">  <span class="attr">"typ"</span>: <span class="string">"JWT"</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p> <code>alg</code>属性表示签名的hash算法，默认是HMAC SHA256（简写成<code>HS256</code>）<br> <code>typ</code>属性表示这个令牌的类型，为大写的<code>JWT</code>。<br> 该部分数据需要转换成json串并用base64编码</p>
</li>
<li><p>载荷<br>用来存放实际需要传递的数据。<br>格式为字典-此部分分为公有声明和私有声明</p>
</li>
</ol>
<p>公共声明：JWT提供了内置关键字用于描述常见的问题<br>用户根据自己需求按需添加key，<br>JWT官方文档中规定了7个可选的字段 常见公共声明如下<br>    - iss：Issuer签发人<br>    - exp：Expiration过期时间，按当地时间确定，所以设置时要使用utc时间。<br>    - sub：jwt所面向的用户<br>    - aud：Audience受众接收者，分为web端、Android、iOS端<br>    - nbf：生效时间，当前时间在nbf里的定义时间之前，则Token不被接受<br>    - iat：Issued At签发时间<br>    - jti：编号，唯一身份标识，主要用来作为一次性token,从而回避重放攻击。</p>
<p>我们可以根据业务需要添加自定义的字段，如下所示。<br>第一部分是一个Json对象，称为payload可以存储一些不敏感的有效的信息，<br>例如用户名，过期时间等等所有你想要传递的信息，<br>不建议添加密码等敏感信息，因为该部分在客户端可解密</p>
<p>在“用户鉴权”方法中，解析token完成后要利用这个username来查找并返回用户信息给用户。<br>这里的data声明是自定义需要传递的信息，</p>
<p>公共声明和私有声明均在同一个字典中<br>转成json串并用base64加密</p>
<pre><code>&lt;!--hexoPostRenderEscape:&lt;figure class="highlight json"&gt;&lt;table&gt;&lt;tr&gt;&lt;td class="gutter"&gt;&lt;pre&gt;&lt;span class="line"&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class="code"&gt;&lt;pre&gt;&lt;span class="line"&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;  &lt;span class="attr"&gt;&amp;quot;sub&amp;quot;&lt;/span&gt;: &lt;span class="string"&gt;&amp;quot;1234567890&amp;quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;  &lt;span class="attr"&gt;&amp;quot;nickname&amp;quot;&lt;/span&gt;: &lt;span class="string"&gt;&amp;quot;jackfrued&amp;quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;  &lt;span class="attr"&gt;&amp;quot;role&amp;quot;&lt;/span&gt;: &lt;span class="string"&gt;&amp;quot;admin&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;:hexoPostRenderEscape--&gt;
</code></pre>
<p>其中第一部分Header和第二部分Payload只是对原始输入的信息转成了base64编码，</p>
<ol start="3">
<li>签名<ul>
<li>保证Token在传输的过程中没有被篡改或者损坏<br>实现签名首先需要读取配置文件中的SECRET_KEY配置变量，<br>这个秘钥your-256-bit-secret主要用在下文Signature签名中，服务端用来校验Token合法性，<br>这个密钥只有服务器才知道，不能泄露给用户。</li>
</ul>
</li>
</ol>
<p>签名规则如下:<br>根据header头部的alg算法（默认是<code>HS256</code>） 以下用HS256为例，按照下面的公式产生签名。</p>
<pre><code>&lt;!--hexoPostRenderEscape:&lt;figure class="highlight python"&gt;&lt;table&gt;&lt;tr&gt;&lt;td class="gutter"&gt;&lt;pre&gt;&lt;span class="line"&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class="code"&gt;&lt;pre&gt;&lt;span class="line"&gt;HS256(base64Encode(header) + &lt;span class="string"&gt;&amp;#x27;.&amp;#x27;&lt;/span&gt; + base64Encode(payload), secret_key)&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;HS256(自定义的key, base64后的 header + &lt;span class="string"&gt;&amp;quot;.&amp;quot;&lt;/span&gt; + base64后的payload)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;:hexoPostRenderEscape--&gt;
</code></pre>
<p>解释：用自定义的key,对base64后的 header+”+”.”+base64后的payload进行hmac计算</p>
<p>JWT生成的Token相当于是三个JSON对象经过编码后，<br>把头部、载荷、签名三个部分用两个点<code>.</code>拼接成一个字符串，如下图所示。</p>
<pre><code>&lt;!--hexoPostRenderEscape:&lt;figure class="highlight python"&gt;&lt;table&gt;&lt;tr&gt;&lt;td class="gutter"&gt;&lt;pre&gt;&lt;span class="line"&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class="code"&gt;&lt;pre&gt;&lt;span class="line"&gt;base64Encode(header) + &lt;span class="string"&gt;&amp;#x27;.&amp;#x27;&lt;/span&gt; + base64Encode(payload) + &lt;span class="string"&gt;&amp;#x27;.&amp;#x27;&lt;/span&gt; + base64Encode(sign)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;:hexoPostRenderEscape--&gt;
</code></pre>
<h4 id="JWT的优缺点"><a href="#JWT的优缺点" class="headerlink" title="JWT的优缺点"></a>JWT的优缺点</h4><p>使用JWT的优点非常明显，包括：</p>
<ol>
<li>更容易实现水平扩展，因为令牌保存在浏览器中，服务器不需要做状态管理。</li>
<li>更容易防范CSRF攻击，因为在请求头中添加<code>localStorage</code>或<code>sessionStorage</code>中的token必须靠JavaScript代码完成，而不是自动添加到请求头中的。</li>
<li>可以防伪造和篡改，因为JWT有签名，伪造和篡改的令牌无法通过签名验证，会被认定是无效的令牌。<br>体积小，因而传输速度快<br>传输方式多样，可以通过URL/POST参数/HTTP头部等方式传输<br>严格的结构化。它自身（在 payload 中）就包含了所有与用户相关的验证消息，如用户可访问路由、访问有效期等信息，服务器无需再去连接数据库验证信息的有效性，并且 payload 支持为你的应用而定制化。<br>支持跨域验证，可以应用于单点登录。<br>jwt 默认是不加密，但也是可以加密的。生成原始 Token 以后，可以用密钥再加密一次。<br>jwt在不加密的情况下，不能将涉密信息写入jwt</li>
</ol>
<p>当然，任何技术不可能只有优点没有缺点，JWT也有诸多缺点，大家需要在使用的时候引起注意，具体包括：</p>
<ol>
<li>可能会遭受到XSS攻击（跨站脚本攻击），通过注入恶意脚本执行JavaScript代码获取到用户令牌。</li>
<li>在令牌过期之前，无法作废已经颁发的令牌，要解决这个问题，还需要额外的中间层和代码来辅助。</li>
<li>JWT是用户的身份令牌，一旦泄露，任何人都可以获得该用户的所有权限。为了降低令牌被盗用后产生的风险，JWT的有效期应该设置得比较短。对于一些比较重要的权限，使用时应通过其他方式再次对用户进行认证，例如短信验证码等。</li>
</ol>
<p>与session共享机制的对比<br>代码侵入，在每个服务上必须有存取session鉴权判断的代码；<br>不安全，虽然redis等可以很方便的进行分布式部署，假若session服务器挂掉，系统便完全无法使用，不满足分布式系统中的高可用；<br>内存无法控制，若用户访问量激增极可能冲破内存，对内存要求高；<br>与之相反这些正是JWT的优势所在：</p>
<p>无代码侵入 ，只需要配置一个认证服务，其他服务可以无需关注权限，并可以提高到API网关进行权限拦截；<br>JWT不依赖session，对内存无要求，大量的访问也从容应对，不易产生硬件瓶颈；<br>可以在JWT中存储角色等信息，减少数据库查询或无需查询；</p>
<p>1、首先，前端通过Web表单将自己的用户名和密码发送到后端的接口。这一过程一般是一个HTTP POST请求。建议的方式是通过SSL加密的传输（https协议），从而避免敏感信息被嗅探。<br>2、后端校验用户名和密码成功后，把用户的相关信息(比如用户id)以及过期时间等其他信息作为JWT Payload（负载），将其与头部分别进行Base64编码拼接后签名，形成一个JWT。形成的JWT就是一个形同lll.zzz.xxx的字符串。<br>3、后端将JWT字符串作为登录成功的返回结果返回给客户端前端。客户端前端将返回的结果保存在localStorage或sessionStorage上，退出登录时前端删除保存的JWT即可。<br>4、前端以后在每次请求时将JWT放入HTTP Header中的Authorization位。(解决XSS和XSRF问题)<br>5、服务器在接收到需要登录的API请求候，检查是否存在，若存在对这个 token进行解密验证有效性。,然后获取过期时间和用户信息(比如用户id) ，检查签名是否正确；检查Token是否过期；检查Token的接收方是否是自己（可选）。<br>6、验证通过后后端使用JWT中包含的用户信息进行其他逻辑操作，返回相应结果。</p>
<p>JWT无法被破解的关键，是在其第三部分签名里的哈希加密中的Signature<br>由于哈希加密是无法直接解密的，所以jwt实际上只是重复使用加密的过程进行验证而已。</p>
<h3 id="使用PyJWT"><a href="#使用PyJWT" class="headerlink" title="使用PyJWT"></a>使用PyJWT</h3><p>用于编码和解码JSON Web令牌（JWT）</p>
<p>在Python代码中，可以使用三方库<code>PyJWT</code>生成和验证JWT，下面是安装<code>PyJWT</code>的命令。</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install pyjwt</span><br></pre></td></tr></tbody></table></figure>

<h4 id="利用PyJWT生成令牌Token"><a href="#利用PyJWT生成令牌Token" class="headerlink" title="利用PyJWT生成令牌Token"></a>利用PyJWT生成令牌Token</h4><p><code>jwt.encode(payload=payload, key=key, algorithms='HS256', headers=headers)</code></p>
<ul>
<li><code>payload</code>:具体内容自己添加，分为公有声明和私有声明，字典类型</li>
<li><code>key</code>:自定义的加密key，字符串str类型</li>
<li><code>algorithm</code>:使用的加密算法[HS256, RSA256] str字符串</li>
<li><code>headers</code>:，字典类型</li>
<li>返回值为token串 新版本返回类型：str字节,1.7版本是byte</li>
</ul>
<h4 id="解密并校验Token"><a href="#解密并校验Token" class="headerlink" title="解密并校验Token"></a>解密并校验Token</h4><ul>
<li><code>jwt.decode(jwt, key, algorithms='HS256')</code></li>
<li><code>jwt</code>: str,</li>
<li><code>key</code>: str = “”, 秘钥和生成token的秘钥一样</li>
<li><code>algorithms</code>: List[str] = None,</li>
<li>返回值payload明文 返回类型：dict</li>
</ul>
<p>dic 有官方指定的 key，程序在解密的时候会根据 key 的 Value 判断是否合法。这些 key 有：<br><code>issuer</code>: 发布者，若encode payload中添加 ‘iss’ 字段，则可针对该字段校验 参数类型：str，若iss校验失败，则抛出<code>jwt.exceptions.InvalidIssuerError: Invalid issuer</code><br><code>audience</code>：签发的受众群体，若encode payload中添加’aud’字段，则可针对该字段校验 参数类型：str<br>若aud校验失败，则抛出<code>jwt.exceptions.InvalidAudienceError: Invalid audience</code></p>
<ol>
<li>比对从token中取出的key对应的值，和各种请求中传来的值</li>
<li><code>exp</code>：在生成 token 时，可以设置该 token 的有效时间，检查到exp字段，且token过期，则抛出<code>jwt.ExpiredSignatureError</code><br>若encode得时候 payload中添加了exp字段;<br>则exp字段得值需为 当前时间戳+此token得有效期时间，<br>例如希望token 300秒后过期 {‘exp’: time.time() + 300};<br>在执行decode时，</li>
</ol>
<p><code>nbf</code>：它指的是该 token 的生效时间，如果使用但是没到生效时间则抛出：<br><code>jwt.exceptions.ImmatureSignatureError: The token is not yet valid (nbf)</code></p>
<p>iat：token 的开始时间，如果当前时间在开始时间之前则抛出<br><code>jwt.exceptions.InvalidIssuedAtError: Issued At claim (iat) cannot be in the future.</code></p>
<p><code>setting.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># SECURITY WARNING: keep the secret key used in production secret!</span></span><br><span class="line">SECRET_KEY = <span class="string">'django-insecure-ko!(dd)glepzzin%r%l--jbvg3=xm%v1fmx=uj1=6l#er06rgg'</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> jwt</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings  <span class="comment"># 不要用相对导入的方式导入配置文件</span></span><br><span class="line"></span><br><span class="line">headers = {  <span class="comment"># 默认内容</span></span><br><span class="line">    <span class="string">'typ'</span>: <span class="string">'jwt'</span>,</span><br><span class="line">    <span class="string">'alg'</span>: <span class="string">'HS256'</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">payload = {</span><br><span class="line">    <span class="comment"># 设置过期时间要设置 UTC 时间 因为内部检查使用的也是 UTC 时间</span></span><br><span class="line">    <span class="comment"># Expiration time will be compared to the current UTC time</span></span><br><span class="line">    <span class="comment"># (as given by timegm(datetime.utcnow().utctimetuple())),</span></span><br><span class="line">    <span class="comment"># so be sure to use a UTC timestamp or datetime in encoding</span></span><br><span class="line">    <span class="string">'exp'</span>:</span><br><span class="line">        datetime.datetime.utcnow() +</span><br><span class="line">        datetime.timedelta(days=<span class="number">1</span>, minutes=<span class="number">5</span>, seconds=<span class="number">10</span>),</span><br><span class="line">    <span class="string">'iat'</span>:</span><br><span class="line">        datetime.datetime.utcnow(),  <span class="comment"># 开始时间</span></span><br><span class="line">    <span class="string">'iss'</span>:</span><br><span class="line">        <span class="string">'Ashe'</span>,  <span class="comment"># 签名</span></span><br><span class="line">    <span class="string">'data'</span>: {  <span class="comment"># 自定义的数据，一般存放该用户id和开始时间</span></span><br><span class="line">        <span class="string">'userid'</span>: <span class="number">10001</span>,  <span class="comment"># 'id':user_id,</span></span><br><span class="line">        <span class="string">'username'</span>: <span class="string">'Jack'</span>,</span><br><span class="line">        <span class="comment"># 'login_time': login_time</span></span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment"># key = settings.SECRET_KEY  # 这个可以自定义密钥，为了方便直接使用Django的密钥</span></span><br><span class="line">key = <span class="string">'123'</span></span><br><span class="line"></span><br><span class="line">encoded_jwt = jwt.encode(payload=payload, key=key, algorithm=<span class="string">'HS256'</span>, headers=headers)</span><br><span class="line">print(encoded_jwt)  <span class="comment"># 查看生成的Token</span></span><br><span class="line"><span class="comment"># b'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VybmFtZSI6Ilx1OGZkMFx1N2VmNFx1NTQ5Nlx1NTU2MVx1NTQyNyIsInNpdGUiOiJodHRwczovL29wcy1jb2ZmZWUuY24ifQ.fIpSXy476r9F9i7GhdYFNkd-2Ndz8uKLgJPcd84BkJ4'</span></span><br><span class="line">print(type(encoded_jwt))  <span class="comment"># &lt;class 'str'&gt;</span></span><br><span class="line"></span><br><span class="line">verified_payload = jwt.decode(encoded_jwt, key=key, issuer=<span class="string">'Ashe'</span>, algorithms=[<span class="string">'HS256'</span>])</span><br><span class="line">print(verified_payload)</span><br><span class="line"><span class="comment"># {'exp': 1622044499, 'iat': 1621957789, 'iss': 'Ashe', 'data': {'userid': 10001, 'username': 'Jack'}}</span></span><br><span class="line">print(type(verified_payload))  <span class="comment"># &lt;class 'dict'&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="用base64对Header和Payload进行解码得到相应的信息"><a href="#用base64对Header和Payload进行解码得到相应的信息" class="headerlink" title="用base64对Header和Payload进行解码得到相应的信息"></a>用base64对Header和Payload进行解码得到相应的信息</h4><figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 部分源码</span></span><br><span class="line">signing_input, crypto_segment = jwt.rsplit(<span class="string">b"."</span>, <span class="number">1</span>)</span><br><span class="line">header_segment, payload_segment = signing_input.split(<span class="string">b"."</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        segments.append(base64url_encode(json_header))  <span class="comment"># 通过</span></span><br><span class="line">        segments.append(base64url_encode(payload))  <span class="comment">#</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Segments</span></span><br><span class="line">        signing_input = <span class="string">b"."</span>.join(segments)  <span class="comment"># 用点拼接</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            alg_obj = self._algorithms[algorithm]</span><br><span class="line">            key = alg_obj.prepare_key(key)</span><br><span class="line">            signature = alg_obj.sign(signing_input, key)</span><br><span class="line">        segments.append(base64url_encode(signature))</span><br></pre></td></tr></tbody></table></figure>

<p>将token分割成 <code>header_segment</code> 、<code>payload_segment</code> 、<code>crypto_segment</code> 三部分</p>
<ul>
<li>对第一部分 header_segment 进行 base64url 解密，得到 header</li>
<li>对第二部分 payload_segment 进行 base64url 解密，得到 payload</li>
<li>对第三部分 crypto_segment 进行 <code>base64url</code> 解密，得到 signature，针对 signature 部分数据进行合法性校验<ul>
<li>拼接前两段密文，即：<code>signing_input</code></li>
<li>从第一段明文中获取加密算法，默认：HS256</li>
<li>使用算法+盐 对 <code>signing_input</code> 进行加密，将得到的结果和 <code>signature</code> 密文进行比较</li>
</ul>
</li>
</ul>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> base64</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>base64.b64decode(<span class="string">'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9'</span>)</span><br><span class="line"><span class="string">b'{"typ":"JWT","alg":"HS256"}'</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>base64.b64decode(<span class="string">"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VybmFtZSI6ImFkbWluIiwic2l0ZSI6Imh0dHA6Ly9zdWliaWFuLnN0YXJtZW93LmNuIn0=="</span>)</span><br><span class="line"><span class="string">b'{"typ":"JWT","alg":"HS256"}{"username":"admin","site":"http://testdomain.starmeow.cn"}'</span></span><br></pre></td></tr></tbody></table></figure>
<p>加<code>==</code>：如果要base64编码的二进制数据不是3的倍数，最后会剩下1个或2个字节怎么办？此时，需在原数据后面添加1个或2个零值字节，使其字节数是3的倍数。<br>然后，在编码后的字符串后面添加1个或2个等号“=”，表示所添加的零值字节数。解码的时候，会自动去掉。<br>第二部分主要存放有效信息，由于这里用的是可逆的base64 编码，所以第二部分的数据实际上是明文的。应该避免在这里存放不能公开的隐私信息。</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>base64.b64decode(<span class="string">"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VybmFtZSI6ImFkbWluIiwic2l0ZSI6Imh0dHA6Ly9zdWliaWFuLnN0YXJtZW93LmNuIn0.5CzNoZ2aWyNYYnImrJvGJuLZlJbUeCVTg-_PFq_XF7o=="</span>)</span><br><span class="line"><span class="string">b'{"typ":"JWT","alg":"HS256"}{"username":"admin","site":"http://testdomain.starmeow.cn"}9\x0b3hgf\x96\xc8\xd6\x18\x9c\x89\xab&amp;\xf1\x89\xb8\xb6e%\xb5\x1e\tT\xe0&lt;Z\x97\x17\xba'</span></span><br></pre></td></tr></tbody></table></figure>
<p>三部分一起解码，可以看到最后一部分被加密了无法查看</p>
<p>校验jwt规则<br>​1，解析header, 确认alg<br>2，签名校验 - 根据传过来的header和payload按 alg指明的算法进行签名，将签名结果和传过来的sign进行对比，若对比一致，则校验通过<br>3，获取payload自定义内容，有exp,则校验过期时间</p>
<p>服务端在有秘钥的情况下可以直接对JWT生成的Token进行解密，解密成功说明Token正确，且数据没有被篡改</p>
<p>当然我们前文说了JWT并没有对数据进行加密，如果没有secret_key也可以直接获取到Payload里边的数据，只是缺少了签名算法无法验证数据是否准确，pyjwt也提供了直接获取Payload数据的方法</p>
<p>如果不清楚JWT具体的使用方式，可以先看看第55天的内容，里面提供了完整的投票项目代码的地址。</p>
<p>从<code>django.contrib.auth.get_user_model</code>去<code>setting</code>中找<code>AUTH_USER_MODEL</code>，源码</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_user_model</span>():</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Return the User model that is active in this project.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> django_apps.get_model(settings.AUTH_USER_MODEL, require_ready=<span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">except</span> ValueError:</span><br><span class="line">        <span class="keyword">raise</span> ImproperlyConfigured(<span class="string">"AUTH_USER_MODEL must be of the form 'app_label.model_name'"</span>)</span><br><span class="line">    <span class="keyword">except</span> LookupError:</span><br><span class="line">        <span class="keyword">raise</span> ImproperlyConfigured(</span><br><span class="line">            <span class="string">"AUTH_USER_MODEL refers to model '%s' that has not been installed"</span> % settings.AUTH_USER_MODEL</span><br><span class="line">        )</span><br></pre></td></tr></tbody></table></figure>

<hr>
<p>django 案例</p>
<p>在用户登录成功之后，生成token并返回，用户再次来访问时需携带token。<br>从token中取出用户名并从数据库中取出该用户对象</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_user_id</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="comment"># 取token</span></span><br><span class="line">    token = request.META.get(<span class="string">'HTTP_AUTHORIZATION'</span>)</span><br><span class="line">    <span class="comment"># 若没取出token，则用户未登录</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> token:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 若token不对，返回一个none</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        res = jwt.decode(token, TOKEN_KEY, algorithms=<span class="string">'HS256'</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 如果没报错，拿出username</span></span><br><span class="line">    username = res[<span class="string">'username'</span>]</span><br><span class="line">    <span class="comment"># 从数据库中取出用户对象</span></span><br><span class="line">    users = UserProfile.objects.filter(username=username)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> users:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    user = users[<span class="number">0</span>]</span><br></pre></td></tr></tbody></table></figure>

<hr>
<p>封装获取 token 函数</p>
<p><code>views.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> jwt</span><br><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings  <span class="comment"># 不要用相对导入的方式导入配置文件</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_token</span>(<span class="params">username, expire=<span class="number">3600</span> * <span class="number">24</span></span>):</span></span><br><span class="line">    <span class="string">"""生成 token，有效期一天"""</span></span><br><span class="line">    <span class="keyword">import</span> jwt</span><br><span class="line">    now = time.time()</span><br><span class="line">    key = settings.SECRET_KEY</span><br><span class="line">    payload = {<span class="string">'username'</span>: username, <span class="string">'exp'</span>: int(now + expire)}</span><br><span class="line">    <span class="keyword">return</span> jwt.encode(payload, key, algorithm=<span class="string">'HS256'</span>)</span><br></pre></td></tr></tbody></table></figure>

<p>封装校验 token 函数</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> jwt</span><br><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings  <span class="comment"># 不要用相对导入的方式导入配置文件</span></span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> JsonResponse</span><br><span class="line"><span class="keyword">from</span> user.models <span class="keyword">import</span> User</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># token 验证装饰器</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login_check</span>(<span class="params">func</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span>(<span class="params">request, *args, **kwargs</span>):</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 取token</span></span><br><span class="line">        token = request.META.get(<span class="string">'HTTP_AUTHORIZATION'</span>)</span><br><span class="line">        <span class="comment"># 没有 token，则用户未登录</span></span><br><span class="line">        <span class="keyword">if</span> token <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            result = {<span class="string">'code'</span>: <span class="number">403</span>, <span class="string">'error'</span>: <span class="string">u'用户未登录 - 没有权限！'</span>}</span><br><span class="line">            <span class="keyword">return</span> JsonResponse(result)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            res = jwt.decode(token,</span><br><span class="line">                             settings.LIZI_TOKEN_KEY,</span><br><span class="line">                             algorithms=<span class="string">'HS256'</span>)</span><br><span class="line">        <span class="comment"># 若token不对，</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            print(<span class="string">'jwt error {}'</span>.format(e))</span><br><span class="line">            result = {<span class="string">'code'</span>: <span class="number">403</span>, <span class="string">'msg'</span>: <span class="string">u'用户未登录!'</span>}</span><br><span class="line">            <span class="keyword">return</span> JsonResponse(result)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 如果没报错，拿出username</span></span><br><span class="line">        username = res[<span class="string">'username'</span>]</span><br><span class="line">        user = User.objects.get(username=username)</span><br><span class="line">        <span class="comment"># user 挂载 request 上，以便后面方法可以直接取出用户</span></span><br><span class="line">        request.myuser = user</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> func(request, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br></pre></td></tr></tbody></table></figure>

<hr>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_token</span>(<span class="params">username, password</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">  生成jwt</span></span><br><span class="line"><span class="string">  :param payload: dict 载荷</span></span><br><span class="line"><span class="string">  :param expiry: datetime 有效期</span></span><br><span class="line"><span class="string">  :param JWT_KEY: 密钥</span></span><br><span class="line"><span class="string">  :return: jwt</span></span><br><span class="line"><span class="string">   """</span></span><br><span class="line">    payload = {</span><br><span class="line">        <span class="string">"iat"</span>: int(time.time()),</span><br><span class="line">        <span class="string">"exp"</span>: int(time.time()) + <span class="number">3600</span> * <span class="number">12</span>,</span><br><span class="line">        <span class="string">"password"</span>: password,</span><br><span class="line">        <span class="string">"username"</span>: username,</span><br><span class="line">    }</span><br><span class="line">    token = jwt.encode(payload, JWT_KEY, algorithm=<span class="string">'HS256'</span>)</span><br><span class="line">    <span class="keyword">return</span> token.decode()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">verify</span>(<span class="params">token, db</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">  :param token: jwt</span></span><br><span class="line"><span class="string">  :param JWT_KEY: 密钥</span></span><br><span class="line"><span class="string">  :return: dict: payload</span></span><br><span class="line"><span class="string">  """</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        payload = jwt.decode(token, JWT_KEY, algorithm=[<span class="string">'HS256'</span>])</span><br><span class="line">        user = db.query(User).filter(</span><br><span class="line">            User.account == payload[<span class="string">'username'</span>]).first()</span><br><span class="line">        <span class="keyword">if</span> user == <span class="literal">None</span>:</span><br><span class="line">            msg = <span class="string">'用户不存在'</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span>, msg</span><br><span class="line">        <span class="keyword">if</span> user.status == <span class="number">1</span>:</span><br><span class="line">            msg = <span class="string">'用户被禁用'</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span>, msg</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span>, user</span><br><span class="line">    <span class="keyword">except</span> jwt.PyJWTError:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span>, <span class="string">'Token异常！'</span></span><br></pre></td></tr></tbody></table></figure>

<hr>
<p>此示例在django的中间件中对token进行校验，内部编写了两个中间件来支持用户通过两种方式传递token。</p>
<p>Postman-Header-Authorization请求头</p>
<p>Django要兼容session认证的方式，还需要同时支持JWT，并且两种验证需要共用同一套权限系统，该如何处理呢？我们可以参考Django的解决方案：<br>装饰器，例如用来检查用户是否登录的login_required和用来检查用户是否有权限的permission_required两个装饰器，<br>我们可以自己实现一个装饰器，检查用户的认证模式，同时认证完成后验证用户是否有权限操作</p>
<p>于是一个auth_permission_required的装饰器产生了：</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings  <span class="comment"># 不要用相对导入的方式导入配置文件</span></span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> JsonResponse</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth <span class="keyword">import</span> get_user_model</span><br><span class="line"><span class="keyword">from</span> django.core.exceptions <span class="keyword">import</span> PermissionDenied</span><br><span class="line"></span><br><span class="line">UserModel = get_user_model()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">auth_permission_required</span>(<span class="params">perm</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">decorator</span>(<span class="params">view_func</span>):</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">_wrapped_view</span>(<span class="params">request, *args, **kwargs</span>):</span></span><br><span class="line">            <span class="comment"># 格式化权限</span></span><br><span class="line">            perms = (perm, ) <span class="keyword">if</span> isinstance(perm, str) <span class="keyword">else</span> perm</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> request.user.is_authenticated:</span><br><span class="line">                <span class="comment"># 正常登录用户判断是否有权限</span></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> request.user.has_perms(perms):</span><br><span class="line">                    <span class="keyword">raise</span> PermissionDenied</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    auth = request.META.get(<span class="string">'HTTP_AUTHORIZATION'</span>).split()</span><br><span class="line">                <span class="keyword">except</span> AttributeError:</span><br><span class="line">                    <span class="keyword">return</span> JsonResponse({</span><br><span class="line">                        <span class="string">"code"</span>: <span class="number">401</span>,</span><br><span class="line">                        <span class="string">"message"</span>: <span class="string">"No authenticate header"</span></span><br><span class="line">                    })</span><br><span class="line"></span><br><span class="line">                <span class="comment"># 用户通过API获取数据验证流程</span></span><br><span class="line">                <span class="keyword">if</span> auth[<span class="number">0</span>].lower() == <span class="string">'token'</span>:</span><br><span class="line">                    <span class="keyword">try</span>:</span><br><span class="line">                        dict = jwt.decode(auth[<span class="number">1</span>],</span><br><span class="line">                                          settings.SECRET_KEY,</span><br><span class="line">                                          algorithms=[<span class="string">'HS256'</span>])</span><br><span class="line">                        username = dict.get(<span class="string">'data'</span>).get(<span class="string">'username'</span>)</span><br><span class="line">                    <span class="keyword">except</span> jwt.ExpiredSignatureError:</span><br><span class="line">                        <span class="keyword">return</span> JsonResponse({</span><br><span class="line">                            <span class="string">"status_code"</span>: <span class="number">401</span>,</span><br><span class="line">                            <span class="string">"message"</span>: <span class="string">"Token expired"</span></span><br><span class="line">                        })</span><br><span class="line">                    <span class="keyword">except</span> jwt.InvalidTokenError:</span><br><span class="line">                        <span class="keyword">return</span> JsonResponse({</span><br><span class="line">                            <span class="string">"status_code"</span>: <span class="number">401</span>,</span><br><span class="line">                            <span class="string">"message"</span>: <span class="string">"Invalid token"</span></span><br><span class="line">                        })</span><br><span class="line">                    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                        <span class="keyword">return</span> JsonResponse({</span><br><span class="line">                            <span class="string">"status_code"</span>:</span><br><span class="line">                            <span class="number">401</span>,</span><br><span class="line">                            <span class="string">"message"</span>:</span><br><span class="line">                            <span class="string">"Can not get user object"</span></span><br><span class="line">                        })</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">try</span>:</span><br><span class="line">                        user = UserModel.objects.get(username=username)</span><br><span class="line">                    <span class="keyword">except</span> UserModel.DoesNotExist:</span><br><span class="line">                        <span class="keyword">return</span> JsonResponse({</span><br><span class="line">                            <span class="string">"status_code"</span>: <span class="number">401</span>,</span><br><span class="line">                            <span class="string">"message"</span>: <span class="string">"User Does not exist"</span></span><br><span class="line">                        })</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">not</span> user.is_active:</span><br><span class="line">                        <span class="keyword">return</span> JsonResponse({</span><br><span class="line">                            <span class="string">"status_code"</span>:</span><br><span class="line">                            <span class="number">401</span>,</span><br><span class="line">                            <span class="string">"message"</span>:</span><br><span class="line">                            <span class="string">"User inactive or deleted"</span></span><br><span class="line">                        })</span><br><span class="line"></span><br><span class="line">                    <span class="comment"># Token登录的用户判断是否有权限</span></span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">not</span> user.has_perms(perms):</span><br><span class="line">                        <span class="keyword">return</span> JsonResponse({</span><br><span class="line">                            <span class="string">"status_code"</span>: <span class="number">403</span>,</span><br><span class="line">                            <span class="string">"message"</span>: <span class="string">"PermissionDenied"</span></span><br><span class="line">                        })</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">return</span> JsonResponse({</span><br><span class="line">                        <span class="string">"status_code"</span>: <span class="number">401</span>,</span><br><span class="line">                        <span class="string">"message"</span>: <span class="string">"Not support auth type"</span></span><br><span class="line">                    })</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> view_func(request, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> _wrapped_view</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> decorator</span><br></pre></td></tr></tbody></table></figure>

<p>在view使用时就可以用这个装饰器来代替原本的login_required和permission_required装饰器了</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@auth_permission_required('account.select_user')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">user</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'GET'</span>:</span><br><span class="line">        _jsondata = {<span class="string">"user"</span>: <span class="string">"ops-coffee"</span>, <span class="string">"site"</span>: <span class="string">"https://ops-coffee.cn"</span>}</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> JsonResponse({<span class="string">"state"</span>: <span class="number">1</span>, <span class="string">"message"</span>: _jsondata})</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> JsonResponse({</span><br><span class="line">            <span class="string">"state"</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="string">"message"</span>: <span class="string">"Request method 'POST' not supported"</span></span><br><span class="line">        })</span><br></pre></td></tr></tbody></table></figure>

<p>需要一个生成用户Token的方法，通过给User model添加一个token的静态方法来处理</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>(<span class="params">AbstractBaseUser, PermissionsMixin</span>):</span></span><br><span class="line">    create_time = models.DateTimeField(auto_now_add=<span class="literal">True</span>, verbose_name=<span class="string">'创建时间'</span>)</span><br><span class="line">    update_time = models.DateTimeField(auto_now=<span class="literal">True</span>, verbose_name=<span class="string">'更新时间'</span>)</span><br><span class="line">    username = models.EmailField(max_length=<span class="number">255</span>,</span><br><span class="line">                                 unique=<span class="literal">True</span>,</span><br><span class="line">                                 verbose_name=<span class="string">'用户名'</span>)</span><br><span class="line">    fullname = models.CharField(max_length=<span class="number">64</span>, null=<span class="literal">True</span>, verbose_name=<span class="string">'中文名'</span>)</span><br><span class="line">    phonenumber = models.CharField(max_length=<span class="number">16</span>,</span><br><span class="line">                                   null=<span class="literal">True</span>,</span><br><span class="line">                                   unique=<span class="literal">True</span>,</span><br><span class="line">                                   verbose_name=<span class="string">'电话'</span>)</span><br><span class="line">    is_active = models.BooleanField(default=<span class="literal">True</span>, verbose_name=<span class="string">'激活状态'</span>)</span><br><span class="line"></span><br><span class="line">    objects = UserManager()</span><br><span class="line"></span><br><span class="line">    USERNAME_FIELD = <span class="string">'username'</span></span><br><span class="line">    REQUIRED_FIELDS = []</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.username</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">token</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self._generate_jwt_token()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_generate_jwt_token</span>(<span class="params">self</span>):</span></span><br><span class="line">        token = jwt.encode(</span><br><span class="line">            {</span><br><span class="line">                <span class="string">'exp'</span>: datetime.utcnow() + timedelta(days=<span class="number">1</span>),</span><br><span class="line">                <span class="string">'iat'</span>: datetime.utcnow(),</span><br><span class="line">                <span class="string">'data'</span>: {</span><br><span class="line">                    <span class="string">'username'</span>: self.username</span><br><span class="line">                }</span><br><span class="line">            },</span><br><span class="line">            settings.SECRET_KEY,</span><br><span class="line">            algorithm=<span class="string">'HS256'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> token.decode(<span class="string">'utf-8'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        default_permissions = ()</span><br><span class="line"></span><br><span class="line">        permissions = (</span><br><span class="line">            (<span class="string">"select_user"</span>, <span class="string">"查看用户"</span>),</span><br><span class="line">            (<span class="string">"change_user"</span>, <span class="string">"修改用户"</span>),</span><br><span class="line">            (<span class="string">"delete_user"</span>, <span class="string">"删除用户"</span>),</span><br><span class="line">        )</span><br></pre></td></tr></tbody></table></figure>

<p>直接通过用户对象来生成Token：</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> accounts.models <span class="keyword">import</span> User</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>u = User.objects.get(username=<span class="string">'admin@ops-coffee.cn'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>u.token</span><br><span class="line"><span class="string">'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJleHAiOjE1NDgyMjg3NzksImlhdCI6MTU0ODE0MjM3OSwiZGF0YSI6eyJ1c2VybmFtZSI6ImFkbWluQDE2My5jb20ifX0.akZNU7t_z2kwPxDJjmc-QxtNdICK0yhnwWmKxqqXKLw'</span></span><br></pre></td></tr></tbody></table></figure>

<p>生成的Token给到客户端，客户端就可以拿这个Token进行鉴权了</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> requests</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>token = <span class="string">'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJleHAiOjE1NDgyMjg4MzgsImlhdCI6MTU0ODE0MjQzOCwiZGF0YSI6eyJ1c2VybmFtZSI6ImFkbWluQDE2My5jb20ifX0.oKc0SafgksMT9ZIhTACupUlz49Q5kI4oJA-B8-GHqLA'</span></span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>r = requests.get(<span class="string">'http://localhost/api/user'</span>, headers={<span class="string">'Authorization'</span>: <span class="string">'Token '</span>+token})</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>r.json()</span><br><span class="line">{<span class="string">'username'</span>: <span class="string">'admin@ops-coffee.cn'</span>, <span class="string">'fullname'</span>: <span class="string">'运维咖啡吧'</span>, <span class="string">'is_active'</span>: <span class="literal">True</span>}</span><br></pre></td></tr></tbody></table></figure>

<p>这样一个auth_permission_required方法就可以搞定上边的全部需求</p>
<hr>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> datetime, jwt, time</span><br><span class="line"><span class="keyword">from</span> app.dao.userDao <span class="keyword">import</span> UserDao</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> jsonify</span><br><span class="line"><span class="keyword">from</span> .. <span class="keyword">import</span> common</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Auth</span>():</span></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">encode_auth_token</span>(<span class="params">user_id, login_time</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        生成认证Token</span></span><br><span class="line"><span class="string">        :param user_id: int</span></span><br><span class="line"><span class="string">        :param login_time: int(timestamp)</span></span><br><span class="line"><span class="string">        :return: string</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            payload = {</span><br><span class="line">                <span class="string">'exp'</span>: datetime.datetime.utcnow() + datetime.timedelta(days=<span class="number">0</span>, seconds=<span class="number">10</span>),</span><br><span class="line">                <span class="string">'iat'</span>: datetime.datetime.utcnow(),</span><br><span class="line">                <span class="string">'iss'</span>: <span class="string">'ken'</span>,</span><br><span class="line">                <span class="string">'data'</span>: {</span><br><span class="line">                    <span class="string">'id'</span>:user_id,</span><br><span class="line">                    <span class="string">'login_time'</span>: login_time</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">return</span> jwt.encode(</span><br><span class="line">                payload,</span><br><span class="line">                <span class="string">'secret'</span>,</span><br><span class="line">                algorithm=<span class="string">'HS256'</span></span><br><span class="line">            )</span><br><span class="line">        <span class="keyword">except</span> Exception  <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> e</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">decode_auth_token</span>(<span class="params">auth_token</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        验证Token</span></span><br><span class="line"><span class="string">        :param auth_token:</span></span><br><span class="line"><span class="string">        :return: integer|string</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            payload = jwt.decode(auth_token, <span class="string">'secret'</span>, options= {<span class="string">'verify_exp'</span>:<span class="literal">False</span>})</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">'data'</span> <span class="keyword">in</span> payload <span class="keyword">and</span> <span class="string">'id'</span> <span class="keyword">in</span> payload[<span class="string">'data'</span>]):</span><br><span class="line">                <span class="keyword">return</span> payload</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">raise</span> jwt.InvalidTokenError</span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> jwt.ExpiredSignatureError:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"Token过期"</span></span><br><span class="line">        <span class="keyword">except</span> jwt.InvalidTokenError:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"无效的Token"</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">authenticate</span>(<span class="params">self, username, password</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        用户登录，登录成功返回token，写将登录时间写入数据库；登录失败返回失败原因</span></span><br><span class="line"><span class="string">        根据用户名/密码，到DB中进行校验，如果是合法的用户名/密码，调用encode_auth_token生成token返回；username加入到token的payload中。</span></span><br><span class="line"><span class="string">        :param password:</span></span><br><span class="line"><span class="string">        :return: json</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        userDao = UserDao()</span><br><span class="line">        user = userDao.search(username)</span><br><span class="line">        <span class="keyword">if</span> (user <span class="keyword">is</span> <span class="literal">None</span>):</span><br><span class="line">            <span class="keyword">return</span> jsonify(common.falseReturn(<span class="string">''</span>, <span class="string">'找不到用户'</span>))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> (user.password == password):</span><br><span class="line">                login_time = int(time.time())</span><br><span class="line">                token = self.encode_auth_token(user.username, login_time)</span><br><span class="line">                <span class="keyword">return</span> jsonify(common.trueReturn(token.decode(), <span class="string">'登陆成功'</span>))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> jsonify(common.falseReturn(<span class="string">''</span>, <span class="string">'密码不正确'</span>))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">identify</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        用户鉴权，用户的请求需要携带token信息，这个函数对request进行校验，调用decode_auth_token完成的校验。</span></span><br><span class="line"><span class="string">        :return: list</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        auth_header = request.headers.get(<span class="string">'Authorization'</span>)</span><br><span class="line">        <span class="keyword">if</span> (auth_header):</span><br><span class="line">            auth_tokenArr = auth_header.split(<span class="string">" "</span>)</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">not</span> auth_tokenArr <span class="keyword">or</span> auth_tokenArr[<span class="number">0</span>]!= <span class="string">'jwt'</span> <span class="keyword">or</span> len(auth_tokenArr) != <span class="number">2</span> ):</span><br><span class="line">                result = common.falseReturn(<span class="string">''</span>,<span class="string">'请传递正确的验证头信息'</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                auth_token = auth_tokenArr[<span class="number">1</span>]</span><br><span class="line">                payload = self.decode_auth_token(auth_token)</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> isinstance(payload, str):</span><br><span class="line">                    userDao = UserDao()</span><br><span class="line">                    user = userDao.search(payload[<span class="string">'data'</span>][<span class="string">'id'</span>])</span><br><span class="line">                    <span class="keyword">if</span> (user <span class="keyword">is</span> <span class="literal">None</span>):</span><br><span class="line">                        result = common.falseReturn(<span class="string">''</span>, <span class="string">'找不到该用户信息'</span>)</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        result = common.trueReturn(<span class="string">''</span>, <span class="string">'请求成功'</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    result = common.falseReturn(<span class="string">''</span>, payload)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            result = common.falseReturn(<span class="string">''</span>,<span class="string">'没有提供认证token'</span>)</span><br><span class="line">        <span class="keyword">return</span> result</span><br></pre></td></tr></tbody></table></figure>

<p>拦截所有的请求，都进行token校验</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.before_request</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">before_request</span>():</span></span><br><span class="line">    Auth.identify(Auth,request )</span><br></pre></td></tr></tbody></table></figure>

<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/05/22/zhuang-shi-qi-yu-zhi-shu/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/22/zhuang-shi-qi-yu-zhi-shu/" class="post-title-link" itemprop="url">python装饰器与质数</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2021-05-21 16:21:41 / 修改时间：16:04:42" itemprop="dateCreated datePublished" datetime="2021-05-21T16:21:41Z">2021-05-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 结构混乱</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_prime</span>(<span class="params">num</span>):</span></span><br><span class="line">    <span class="keyword">if</span> num &lt; <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">elif</span> num == <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>, num):</span><br><span class="line">            <span class="keyword">if</span> num % i == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">prime_nums</span>():</span></span><br><span class="line">    t1 = time.time()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>, <span class="number">10</span>):</span><br><span class="line">        <span class="keyword">if</span> is_prime(i):</span><br><span class="line">            print(i)</span><br><span class="line">    t2 = time.time()</span><br><span class="line">    print(t2 - t1)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">prime_nums()</span><br><span class="line"><span class="comment"># 2</span></span><br><span class="line"><span class="comment"># 3</span></span><br><span class="line"><span class="comment"># 5</span></span><br><span class="line"><span class="comment"># 7</span></span><br><span class="line"><span class="comment"># 0.0</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">display_time</span>(<span class="params">func</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span>():</span></span><br><span class="line">        t1 = time.time()</span><br><span class="line">        func()</span><br><span class="line">        t2 = time.time()</span><br><span class="line">        print(t2 - t1)</span><br><span class="line">        print(<span class="string">'%s executed in %.4f s'</span> % (func.__name__, float(t2 - t1)))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_Prime</span>(<span class="params">num</span>):</span></span><br><span class="line">    <span class="keyword">if</span> num &lt; <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">elif</span> num == <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>, num):</span><br><span class="line">            <span class="keyword">if</span> num % i == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@display_time  # find_Prime=display_time(find_Prime)</span></span><br><span class="line"><span class="comment"># 相当于偷梁换柱了，我们后面再调用的时候实际上调用的是display_time</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_Prime</span>():</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>, <span class="number">10</span>):</span><br><span class="line">        <span class="keyword">if</span> is_Prime(i):</span><br><span class="line">            print(i)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">find_Prime()</span><br><span class="line"><span class="comment"># 2</span></span><br><span class="line"><span class="comment"># 3</span></span><br><span class="line"><span class="comment"># 5</span></span><br><span class="line"><span class="comment"># 7</span></span><br><span class="line"><span class="comment"># 0.0009953975677490234</span></span><br><span class="line"><span class="comment"># find_Prime executed in 0.0010 s</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/local/bin/python3</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">display_time</span>(<span class="params">func</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span>():</span></span><br><span class="line">        t1 = time.time()</span><br><span class="line">        result = func()</span><br><span class="line">        t2 = time.time()</span><br><span class="line">        print(<span class="string">'Total time: {:.4f} s'</span>.format(t2 - t1))</span><br><span class="line">        print(<span class="string">'%s executed in %.4f s'</span> % (func.__name__, float(t2 - t1)))</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_Prime</span>(<span class="params">num</span>):</span></span><br><span class="line">    <span class="keyword">if</span> num &lt; <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">elif</span> num == <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>, num):</span><br><span class="line">            <span class="keyword">if</span> num % i == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@display_time  # find_Prime = display_time(find_Prime)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_Prime</span>():</span></span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>, <span class="number">10</span>):</span><br><span class="line">        <span class="keyword">if</span> is_Prime(i):</span><br><span class="line">            count += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> count</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">count = find_Prime()</span><br><span class="line">print(count)</span><br><span class="line"><span class="comment"># Total time: 0.0000 s</span></span><br><span class="line"><span class="comment"># find_Prime executed in 0.0000 s</span></span><br><span class="line"><span class="comment"># 4</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/local/bin/python3</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">display_time</span>(<span class="params">func</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span>(<span class="params">*args</span>):</span></span><br><span class="line">        t1 = time.time()</span><br><span class="line">        result = func(*args)</span><br><span class="line">        t2 = time.time()</span><br><span class="line">        print(<span class="string">'Total time: {:.4f} s'</span>.format(t2 - t1))</span><br><span class="line">        print(<span class="string">'%s executed in %.4f s'</span> % (func.__name__, float(t2 - t1)))</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_Prime</span>(<span class="params">num</span>):</span></span><br><span class="line">    <span class="keyword">if</span> num &lt; <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">elif</span> num == <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>, num):</span><br><span class="line">            <span class="keyword">if</span> num % i == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@display_time  # find_Prime = display_time(find_Prime)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_Prime</span>(<span class="params">maxnum</span>):</span></span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>, maxnum):</span><br><span class="line">        <span class="keyword">if</span> is_Prime(i):</span><br><span class="line">            count += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> count</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">count = find_Prime(<span class="number">100</span>)</span><br><span class="line">print(count)</span><br><span class="line"><span class="comment"># Total time: 0.0010 s</span></span><br><span class="line"><span class="comment"># find_Prime executed in 0.0010 s</span></span><br><span class="line"><span class="comment"># 25</span></span><br></pre></td></tr></tbody></table></figure>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/6/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><span class="page-number current">7</span><a class="page-number" href="/page/8/">8</a><span class="space">&hellip;</span><a class="page-number" href="/page/35/">35</a><a class="extend next" rel="next" href="/page/8/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">外心人D</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  




  





</body>
</html>
