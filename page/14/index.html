<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.0.2">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"bubbleboy11.github.io","root":"/","images":"/images","scheme":"Muse","version":"8.6.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>
<meta name="description" content="本博客大多内容为慕课和网上博客，并非原创">
<meta property="og:type" content="website">
<meta property="og:title" content="外心人D的博客">
<meta property="og:url" content="https://bubbleboy11.github.io/page/14/index.html">
<meta property="og:site_name" content="外心人D的博客">
<meta property="og:description" content="本博客大多内容为慕课和网上博客，并非原创">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="外心人D">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://bubbleboy11.github.io/page/14/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/14/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>外心人D的博客</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="外心人D的博客" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism.css" type="text/css"></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">外心人D的博客</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-overview">
            <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">外心人D</p>
  <div class="site-description" itemprop="description">本博客大多内容为慕课和网上博客，并非原创</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">362</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">22</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">39</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



          </div>
        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/04/19/linux-fang-huo-qiang-fu-wu-pei-zhi/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/04/19/linux-fang-huo-qiang-fu-wu-pei-zhi/" class="post-title-link" itemprop="url">linux 防火墙 服务配置</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-04-18 17:46:44" itemprop="dateCreated datePublished" datetime="2021-04-18T17:46:44Z">2021-04-18</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-06-25 05:23:09" itemprop="dateModified" datetime="2021-06-25T05:23:09Z">2021-06-25</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" itemprop="url" rel="index"><span itemprop="name">操作系统</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>防火墙选择让请求通过，从而保证网络安全性。</p>
<p>在linux下配置</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">systemctl start firewalld.service</span><br><span class="line">systemctl stop firewalld.service</span><br><span class="line">systemctl restart firewalld.service</span><br><span class="line"></span><br><span class="line">firewall-cmd start 启动</span><br><span class="line">firewall-cmd stop 关闭</span><br><span class="line">firewall-cmd restart 重启</span><br><span class="line"></span><br><span class="line">firewall-cmd --version</span><br><span class="line">firewall-cmd --<span class="built_in">help</span></span><br><span class="line">firewall-cmd --state  查看防火墙状态</span><br></pre></td></tr></tbody></table></figure>

<p>端口管理 </p>
<p>开放端口 设置是一个范围，删除必须是一个范围</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --zone=public --add-port=3306/tcp --permanent</span><br><span class="line">firewall-cmd --zone=public --add-port=3306-3307/tcp --permanent</span><br><span class="line">firewall-cmd --add-port=3306/tcp --permanent</span><br><span class="line">firewall-cmd --add-port=8080-8085/tcp --permanent</span><br><span class="line">firewall-cmd --add-port=8000/tcp --permanent</span><br><span class="line">firewall-cmd --add-port=80/tcp --permanent</span><br></pre></td></tr></tbody></table></figure>

<p>查询端口是否开放</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --query-port=3306/tcp</span><br><span class="line">firewall-cmd --query-port=8000/tcp</span><br><span class="line">firewall-cmd --query-port=80/tcp</span><br></pre></td></tr></tbody></table></figure>

<p>查看开发的端口</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --list-ports --permanent</span><br></pre></td></tr></tbody></table></figure>

<p>移除3306端口</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --remove-port=3307/tcp --permanent</span><br><span class="line">firewall-cmd --remove-port=8080-8085/tcp --permanent</span><br></pre></td></tr></tbody></table></figure>

<p>重启防火墙（修改配置后要重启加载设置）</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --reload</span><br></pre></td></tr></tbody></table></figure>

<p>firewall-cmd –get-zones（查看所有区域）<br>firewall-cmd –get-default-zone（查看默认区域）<br>firewall-cmd –list-all  显示目前的设定<br>firewall-cmd –list-all-zone（查看所有区域配置信息）</p>
<p>查询服务：firewall-cmd –zone=public（默认为此）–query-service=ssh<br>删除服务：firewall-cmd –zone=public（默认为此）–remove-service=ssh<br>添加服务：firewall-cmd –add-service=ssh<br>列出服务（service）：<br>firewall-cmd –list-services<br>firewall-cmd –list-services  –permanent 查看哪些程序使用互联网</p>
<p>sudo firewall-cmd –zone=public –permanent –add-port=4369/tcp –add-port=25672/tcp –add-port=5671-5672/tcp –add-port=15672/tcp –add-port=61613-61614/tcp –add-port=1883/tcp –add-port=8883/tcp<br>sudo firewall-cmd –reload</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/04/19/web-xiang-mu-bu-shu/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/04/19/web-xiang-mu-bu-shu/" class="post-title-link" itemprop="url">web项目部署</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-04-18 17:46:44" itemprop="dateCreated datePublished" datetime="2021-04-18T17:46:44Z">2021-04-18</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-07-20 11:34:16" itemprop="dateModified" datetime="2021-07-20T11:34:16Z">2021-07-20</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/django/" itemprop="url" rel="index"><span itemprop="name">django</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>常见的部署方式</p>
<ul>
<li>nginx + gunicorn</li>
<li>nginx + uwsgi</li>
<li>docker</li>
</ul>
<h2 id="Web服务器nginx"><a href="#Web服务器nginx" class="headerlink" title="Web服务器nginx"></a>Web服务器nginx</h2><p>原理<br>静态文件(js/css/img) &lt;–&gt; nginx &lt;–&gt; 磁盘<br>动态请求  &lt;–&gt; nginx &lt;–&gt;  wsgi</p>
<p>yum安装nginx(和源码安装的安装命令和路径不一样)<br>安装必备软件</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install yum-utils</span><br><span class="line"><span class="built_in">cd</span> /etc/yum.repos.d/</span><br><span class="line">vim nginx.repo</span><br></pre></td></tr></tbody></table></figure>

<p>进入交互模式 按i，复制下面内容</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[nginx-stable]</span><br><span class="line">name=nginx stable repo</span><br><span class="line">baseurl=http://nginx.org/packages/centos/$releasever/$basearch/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=1</span><br><span class="line">gpgkey=https://nginx.org/keys/nginx_signing.key</span><br><span class="line">module_hotfixes=true</span><br><span class="line"></span><br><span class="line">[nginx-mainline]</span><br><span class="line">name=nginx mainline repo</span><br><span class="line">baseurl=http://nginx.org/packages/mainline/centos/$releasever/$basearch/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=0</span><br><span class="line">gpgkey=https://nginx.org/keys/nginx_signing.key</span><br><span class="line">module_hotfixes=true</span><br></pre></td></tr></tbody></table></figure>

<p>Esc :wq</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo yum-config-manager --<span class="built_in">enable</span> nginx-mainline</span><br><span class="line">sudo yum install nginx</span><br><span class="line">nginx</span><br><span class="line">ps -ef | grep nginx</span><br></pre></td></tr></tbody></table></figure>

<p>浏览器输入 <code>http:公网IP</code><br><a target="_blank" rel="noopener" href="http://nginx.org/en/linux_packages.html"></a></p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-0-9-centos ~]<span class="comment"># cd /etc/nginx/</span></span><br><span class="line">[root@VM-0-9-centos nginx]<span class="comment"># ls</span></span><br><span class="line">conf.d  fastcgi_params  mime.types  modules  nginx.conf  scgi_params  uwsgi_params</span><br><span class="line">[root@VM-0-9-centos nginx]<span class="comment"># vim nginx.conf </span></span><br><span class="line">[root@VM-0-9-centos nginx]<span class="comment"># cd conf.d/</span></span><br><span class="line">[root@VM-0-9-centos conf.d]<span class="comment"># ls</span></span><br><span class="line">default.conf</span><br><span class="line">[root@VM-0-9-centos conf.d]<span class="comment"># vim default.conf </span></span><br><span class="line">/usr/share/nginx/html</span><br></pre></td></tr></tbody></table></figure>

<h2 id="部署Vue-js"><a href="#部署Vue-js" class="headerlink" title="部署Vue.js"></a>部署Vue.js</h2><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> apiHost = <span class="string">'/api'</span></span><br></pre></td></tr></tbody></table></figure>

<p>当是<code>/api</code>开头，nginx把它转发给wsgi对应的内容进行处理，就会处理django的内容</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm run build</span><br></pre></td></tr></tbody></table></figure>

<p>把写好的代码组件、相关引用构建成一个生产使用的代码，里面的js进行压缩，css经过提取，vue项目打包后，在工程目录下出现一个dist文件夹，包括的静态文件和项目的请求IP都打入包内，如果后台服务改动，这时你的前端文件，又要重新编译打包，<br>压缩成zip文件上传到这台服务器<code>/mnt/www/trip-mobile/dist</code>，可以用ftp文件上传或者scp命令 <code>scp ./dist.zip root@8.129.38.87:/mnt/www/trip-mobile</code></p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-0-9-centos ~]<span class="comment"># cd /</span></span><br><span class="line">[root@VM-0-9-centos /]<span class="comment"># cd /mnt/</span></span><br><span class="line">[root@VM-0-9-centos mnt]<span class="comment"># mkdir www</span></span><br><span class="line">[root@VM-0-9-centos mnt]<span class="comment"># cd www/</span></span><br><span class="line">[root@VM-0-9-centos www]<span class="comment"># mkdir trip-mobile</span></span><br><span class="line">[root@VM-0-9-centos www]<span class="comment"># cd trip-mobile</span></span><br><span class="line">[root@VM-0-9-centos www]<span class="comment"># unzip dist.zip</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="配置ngix"><a href="#配置ngix" class="headerlink" title="配置ngix"></a>配置ngix</h2><p>linux通常会禁止绑定使用1024以下的端口，除非在root用户权限。<br>很多人在使用gunicorn时试图将其绑定到80或者443端口，发现无效。<br>如果想绑定到这些端口，常见的有如下的几种方法：</p>
<ul>
<li>使用Nginx代理转发。</li>
<li>sudo启动gunicorn。</li>
</ul>
<p>把Nginx服务器的默认路径改成我们项目所在的路径。<br>如果你的vue工程用的路由是history模式，需要将客户端发来的url重定向到默认的index.html，才能正常访问。否则只能看到主页。刷新或点击其他页面都会404。</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/nginx/conf.d/</span><br><span class="line">vim default.conf</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">server {</span><br><span class="line">    # 1.监听 80 端口</span><br><span class="line">    listen       80;</span><br><span class="line"></span><br><span class="line">    # 2.这是你部署的IP，你服务器的公网IP 可以localhost或者具体的ip号码</span><br><span class="line">    server_name  localhost;</span><br><span class="line"></span><br><span class="line">    # 3.这里配置前端打包文件的映射路径</span><br><span class="line">    root /usr/local/nginx/html;</span><br><span class="line"></span><br><span class="line"># root后面的地址是前端项目文件上传的路径 \路径配置指向静态文件的文件夹, 这样会直接访问该文件夹下的index.html文件的..</span><br><span class="line">location / {</span><br><span class="line">    root   /mnt/www/trip-mobile/dist;</span><br><span class="line">    index  index.html index.htm;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"># 解决跨域问题，将需要代理的后端地址写在 proxy_pass 后面</span><br><span class="line"># 将所有的 http://localhost/api/ 请求，转发到 http://127.0.0.1:8000/api/</span><br><span class="line">location ^~/api/ {</span><br><span class="line">    proxy_pass http://127.0.0.1:8000/;</span><br><span class="line">    add_header X-Slave $upstream_addr;</span><br><span class="line">    proxy_redirect     off;</span><br><span class="line">    proxy_set_header   Host             $host;</span><br><span class="line">    proxy_set_header   X-Real-IP        $remote_addr;</span><br><span class="line">    proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">location ^~/admin {</span><br><span class="line">    proxy_pass http://127.0.0.1:8000/admin;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">location ^~/master {</span><br><span class="line">    proxy_pass http://127.0.0.1:8000/master;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">location ^~/static {</span><br><span class="line">    alias /mnt/www/trip/static;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight css"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">Esc</span> + <span class="selector-pseudo">:wq</span></span><br></pre></td></tr></tbody></table></figure>

<p>如果需要配置多个vue项目，只需添加多个 server 配置即可。</p>
<p>测试语法和配置是否正常</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx -t</span><br></pre></td></tr></tbody></table></figure>

<p>重启</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx -s reload</span><br></pre></td></tr></tbody></table></figure>

<p>Nginx后可能发现访问不到Nginx主页，至少我第一次没成功，这是因为防火墙配置的问题。<br>我测试的时候装的是CentOS7下执行以下命令打开80端口。</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --zone=public --add-port=80/tcp --permanent</span><br></pre></td></tr></tbody></table></figure>

<p>浏览器输入服务器IP和配置的端口 <a target="_blank" rel="noopener" href="http://81.69.41.250/">http://81.69.41.250:80/</a>  可以打开页面，但是只有前端页面没有后台数据，<br><a target="_blank" rel="noopener" href="http://81.69.41.250/admin">http://81.69.41.250/admin</a> 打开admin后台管理<br><a target="_blank" rel="noopener" href="http://81.69.41.250/master">http://81.69.41.250/master</a> 打开echart可视化</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /mnt/www/trip/trip/settings.py</span><br></pre></td></tr></tbody></table></figure>

<p><code>trip\settings.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># MEDIA_URL = 'http://localhost:8080'</span></span><br><span class="line">MEDIA_URL = <span class="string">'http://81.69.41.250/'</span></span><br><span class="line"></span><br><span class="line">ALLOWED_HOSTS = [<span class="string">'81.69.41.250'</span>, <span class="string">'127.0.0.1'</span>]</span><br><span class="line">STATIC_ROOT = os.path.join(BASE_DIR, <span class="string">'static'</span>)</span><br><span class="line"><span class="comment"># STATICFILES_DIRS = [</span></span><br><span class="line"><span class="comment">#     os.path.join(BASE_DIR, "static")</span></span><br><span class="line"><span class="comment"># ]</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /mnt/www/trip/</span><br><span class="line">python manage.py collectstatic</span><br></pre></td></tr></tbody></table></figure>

<p>收集完后要改回来</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ALLOWED_HOSTS = [<span class="string">'81.69.41.250'</span>, <span class="string">'127.0.0.1'</span>]</span><br><span class="line"><span class="comment"># STATIC_ROOT = os.path.join(BASE_DIR, 'static')</span></span><br><span class="line">STATICFILES_DIRS = [</span><br><span class="line">    os.path.join(BASE_DIR, <span class="string">"static"</span>)</span><br><span class="line">]</span><br></pre></td></tr></tbody></table></figure>

<p>新建 <code>trip.ini</code></p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-0-9-centos www]<span class="comment"># vim trip.ini</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight ini"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[uwsgi]</span></span><br><span class="line"><span class="attr">socket</span> = <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">9090</span></span><br><span class="line"><span class="attr">master</span> = <span class="number">1</span></span><br><span class="line"><span class="attr">processes</span> = <span class="number">1</span></span><br><span class="line"><span class="attr">pidfile</span> = /var/run/trip.pid</span><br><span class="line"><span class="attr">daemonize</span> = /var/log/uwsgi/trip.log</span><br><span class="line"><span class="attr">module</span>= trip.wsgi:application</span><br><span class="line"><span class="attr">chdir</span> = /mnt/www/trip</span><br><span class="line"><span class="attr">listen</span> = <span class="number">100</span></span><br><span class="line"><span class="attr">buffer-size</span> = <span class="number">32768</span></span><br><span class="line"><span class="attr">max-requests</span> = <span class="number">200</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-0-9-centos www]<span class="comment"># mkdir -p /var/log/uwsgi/</span></span><br><span class="line">[root@VM-0-9-centos www]<span class="comment"># uwsgi --ini trip.ini</span></span><br><span class="line">[uWSGI] getting INI configuration from trip.ini</span><br><span class="line">[root@VM-0-9-centos www]<span class="comment"># ps -ef|grep uwsgi</span></span><br><span class="line">root     17716     1  2 13:55 ?        00:00:00 uwsgi --ini trip.ini</span><br><span class="line">root     17722 17716  0 13:55 ?        00:00:00 uwsgi --ini trip.ini</span><br><span class="line">root     17806 28919  0 13:55 pts/7    00:00:00 grep --color=auto uwsgi</span><br></pre></td></tr></tbody></table></figure>

<p>python代码发生变化，重启uwsgi，使用 <code>kill -9 进程ID</code> 命令来杀掉主进程，子进程会随之结束</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-0-9-centos www]<span class="comment"># kill -HUP 17716</span></span><br><span class="line">[root@VM-0-9-centos www]<span class="comment"># ps -ef|grep uwsgi</span></span><br><span class="line">root     17716     1  0 13:55 ?        00:00:00 /usr/<span class="built_in">local</span>/bin/uwsgi --ini trip.ini</span><br><span class="line">root     18454 17716  0 13:58 ?        00:00:00 /usr/<span class="built_in">local</span>/bin/uwsgi --ini trip.ini</span><br><span class="line">root     18460 28919  0 13:58 pts/7    00:00:00 grep --color=auto uwsgi</span><br></pre></td></tr></tbody></table></figure>

<p>动态的接口分发到uwsgi上处理</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-0-9-centos www]<span class="comment"># cd /etc</span></span><br><span class="line">[root@VM-0-9-centos etc]<span class="comment"># cd nginx/</span></span><br><span class="line">[root@VM-0-9-centos nginx]<span class="comment"># cd conf.d/</span></span><br><span class="line">[root@VM-0-9-centos conf.d]<span class="comment"># ls</span></span><br><span class="line">default.conf  default.conf.bak</span><br><span class="line">[root@VM-0-9-centos conf.d]<span class="comment"># cp default.conf django.conf</span></span><br><span class="line">[root@VM-0-9-centos conf.d]<span class="comment"># vim d</span></span><br><span class="line">default.conf      default.conf.bak  django.conf</span><br><span class="line">[root@VM-0-9-centos conf.d]<span class="comment"># vim django.conf</span></span><br></pre></td></tr></tbody></table></figure>

<p>location 的内容</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">    location / {</span><br><span class="line">      uwsgi_pass 127.0.0.1:9090;</span><br><span class="line">      uwsgi_param UWSGI_SCRIPT trip.wsgi;</span><br><span class="line">      include uwsgi_params;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">    location ^~/static {</span><br><span class="line">        alias /mnt/www/trip/static;</span><br><span class="line">    }</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-0-9-centos conf.d]<span class="comment"># nginx -t</span></span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf <span class="built_in">test</span> is successful</span><br><span class="line"></span><br><span class="line">[root@VM-0-9-centos conf.d]<span class="comment"># systemctl stop firewalld.service</span></span><br></pre></td></tr></tbody></table></figure>

<p>把静态文件移动到django项目</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-0-9-centos trip-mobile]<span class="comment"># cd dist/</span></span><br><span class="line">[root@VM-0-9-centos dist]<span class="comment"># ls</span></span><br><span class="line">css  favicon.ico  index.html  js  static</span><br><span class="line">[root@VM-0-9-centos dist]<span class="comment"># cd static/</span></span><br><span class="line">[root@VM-0-9-centos static]<span class="comment"># ls</span></span><br><span class="line">home  mine  qrcode.png  sight</span><br><span class="line">[root@VM-0-9-centos static]<span class="comment"># cp qrcode.png /mnt/www/trip/static/</span></span><br><span class="line">[root@VM-0-9-centos static]<span class="comment"># cp -r home /mnt/www/trip/static/</span></span><br><span class="line">[root@VM-0-9-centos static]<span class="comment"># cp -r mine/ /mnt/www/trip/static/</span></span><br><span class="line">[root@VM-0-9-centos static]<span class="comment"># cp -r sight/ /mnt/www/trip/static/</span></span><br></pre></td></tr></tbody></table></figure>

<p>远程调试</p>
<p>setting-Add Python Interpreter- SSH Interpreter</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/04/19/drf-parser/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/04/19/drf-parser/" class="post-title-link" itemprop="url">drf Parser</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-04-18 17:46:44" itemprop="dateCreated datePublished" datetime="2021-04-18T17:46:44Z">2021-04-18</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-06-16 07:35:01" itemprop="dateModified" datetime="2021-06-16T07:35:01Z">2021-06-16</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/django/" itemprop="url" rel="index"><span itemprop="name">django</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>为什么DRF支持这么轻松的上传文件？</p>
<p>在DRF Api <a target="_blank" rel="noopener" href="https://www.django-rest-framework.org/api-guide/parsers/#multipartparser">https://www.django-rest-framework.org/api-guide/parsers/#multipartparser</a></p>
<p>MultiPartParser<br>Parses multipart HTML form content, which supports file uploads. Both <code>request.data</code> will be populated with a <code>QueryDict</code>.<br>解析多部分HTML表单内容，支持文件上传。<code>request.data</code> 都将被一个 <code>QueryDict</code>填充。</p>
<p>You will typically want to use both <code>FormParser</code> and <code>MultiPartParser</code> together in order to fully support HTML form data.你通常会同时使用<code>FormParser</code>和<code>MultiPartParser</code>两者，以便完全支持HTML表单数据。</p>
<p><strong>.media_type</strong>: <code>multipart/form-data</code></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/04/19/go-chang-liang/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/04/19/go-chang-liang/" class="post-title-link" itemprop="url">go常量</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-04-18 17:46:44" itemprop="dateCreated datePublished" datetime="2021-04-18T17:46:44Z">2021-04-18</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-08-03 11:13:28" itemprop="dateModified" datetime="2021-08-03T11:13:28Z">2021-08-03</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="常量"><a href="#常量" class="headerlink" title="常量"></a>常量</h2><ul>
<li>一个简单值的标识符</li>
<li>在编译的时候确定的值，在程序运行时，不会被修改的量。</li>
</ul>
<p>常量均需使用全部大写字母组成，并使用下划线分词，如果首字母大写可读性</p>
<p>显式类型定义： <code>const A string = "abc"</code><br>隐式类型定义： <code>const A = "abc"</code> <code>const APP_VER = "1.0"</code></p>
<p>如果是枚举类型的常量，需要先创建相应类型</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Scheme <span class="keyword">string</span></span><br><span class="line">​</span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    HTTP  Scheme = <span class="string">"http"</span></span><br><span class="line">    HTTPS Scheme = <span class="string">"https"</span></span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure>

<p>显示指定类型的时候，必须确保常量左右值类型一致，需要时可做显示类型转换。<br>这与变量就不一样了，变量是可以是不同的类型值</p>
<ul>
<li><p>常量中的数据类型只可以是布尔型、数字型（整数型、浮点型和复数）和字符串型</p>
</li>
<li><p>不曾使用的常量，在编译的时候，是不会报错的</p>
</li>
</ul>
<p>作用<br>全局唯一，编译期就已经确定的值，提高程序执行效率</p>
<h2 id="常量引入-应用场景"><a href="#常量引入-应用场景" class="headerlink" title="常量引入 应用场景"></a>常量引入 应用场景</h2><ul>
<li>当程序中需要引入一个在整个程序运行期，数据不发生改变时，使用常量</li>
<li>枚举数据</li>
</ul>
<h3 id="Go-语言预定义常量"><a href="#Go-语言预定义常量" class="headerlink" title="Go 语言预定义常量"></a>Go 语言预定义常量</h3><ul>
<li>true</li>
<li>false</li>
<li>iota</li>
</ul>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">   <span class="keyword">const</span> LENGTH <span class="keyword">int</span> = <span class="number">10</span></span><br><span class="line">   <span class="keyword">const</span> WIDTH <span class="keyword">int</span> = <span class="number">5</span></span><br><span class="line">   <span class="keyword">var</span> area <span class="keyword">int</span></span><br><span class="line">   <span class="keyword">const</span> a, b, c = <span class="number">1</span>, <span class="literal">false</span>, <span class="string">"str"</span> <span class="comment">// 多重赋值 不指定类型</span></span><br><span class="line"></span><br><span class="line">   area = LENGTH * WIDTH</span><br><span class="line">   fmt.Printf(<span class="string">"面积为 : %d"</span>, area)</span><br><span class="line">   fmt.Println(a, b, c)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>常量可以作为枚举，常量组</p>
<ul>
<li>常量组中如不指定类型和初始化值，该类型和值和上一行非空常量的表达式(值和类型)相同</li>
</ul>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">const</span> (</span><br><span class="line">        x <span class="keyword">int</span> = <span class="number">16</span></span><br><span class="line">        y</span><br><span class="line">        s = <span class="string">"abc"</span></span><br><span class="line">        z</span><br><span class="line">        u</span><br><span class="line">    )</span><br><span class="line">    fmt.Println(x, y, s, z) <span class="comment">// 16 16 abc abc</span></span><br><span class="line">    fmt.Printf(<span class="string">"%T,%v\n"</span>, y, y)  <span class="comment">// int,16</span></span><br><span class="line">    fmt.Printf(<span class="string">"%T,%v\n"</span>, z, z)  <span class="comment">// string,abc</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="iota"><a href="#iota" class="headerlink" title="iota"></a>iota</h3><ul>
<li>是希腊字母中第9个字母：Ι, ι，英文释义为极小值</li>
<li>特殊常量，可以认为是一个可以被编译器修改的常量，常量计数器</li>
<li>iota只能在常量组中是使用</li>
<li>使用iota能简化定义，在定义枚举时很有用。</li>
<li>不同的const定义块互相不干扰</li>
<li>没有表达式的常量定义复用上一行上的一个常量的的表达式</li>
<li>每个 <code>const</code> 出现时，都会让 iota 初始化重置为0.</li>
<li>iota代表的是这里的行数，从第一行开始，iota从0逐行加一<br>每当 iota 在新的一行被使用时，它的值都会自动加 1</li>
</ul>
<p>如果中断iota自增，则必须显式恢复。且后续自增值按行序递增</p>
<p>自增默认是int类型，可以自行进行显示指定类型</p>
<p>数字常量不会分配存储空间，无须像变量那样通过内存寻址来取值，因此无法获取地址</p>
<p>源码</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// iota is a predeclared identifier representing the untyped integer ordinal</span></span><br><span class="line"><span class="comment">// number of the current const specification in a (usually parenthesized)</span></span><br><span class="line"><span class="comment">// const declaration. It is zero-indexed.</span></span><br><span class="line"><span class="keyword">const</span> <span class="literal">iota</span> = <span class="number">0</span> <span class="comment">// Untyped int.</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    a    = <span class="literal">iota</span>       <span class="comment">// iota  = 0</span></span><br><span class="line">    b                 <span class="comment">// iota = 1 每一行iota加一</span></span><br><span class="line">    c                 <span class="comment">// iota = 2 每一行iota加一</span></span><br><span class="line">    d    = <span class="string">"ha"</span>       <span class="comment">//独立值，d = "ha" iota += 1 = 3</span></span><br><span class="line">    e                 <span class="comment">// e = "ha"   iota += 1 = 4</span></span><br><span class="line">    f    = <span class="number">100</span>        <span class="comment">// f = 100 iota +=1 = 5</span></span><br><span class="line">    g                 <span class="comment">// g = 100  iota += 6</span></span><br><span class="line">    h    = <span class="literal">iota</span>       <span class="comment">// iota += 7,恢复计数</span></span><br><span class="line">    i                 <span class="comment">// iota += 8</span></span><br><span class="line">    j, k = <span class="literal">iota</span>, <span class="literal">iota</span> <span class="comment">//  iota += 9</span></span><br><span class="line">)</span><br><span class="line">fmt.Println(a, b, c, d, e, f, g, h, i, j, k)</span><br><span class="line"><span class="comment">// 0 1 2 ha ha 100 100 7 8 9 9</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    b = <span class="number">1</span> &lt;&lt; (<span class="number">10</span> * <span class="literal">iota</span>)</span><br><span class="line">    kb</span><br><span class="line">    mb</span><br><span class="line">    gb</span><br><span class="line">    tb</span><br><span class="line">    pb</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">fmt.Println(b, kb, mb, gb, tb, pb)</span><br><span class="line"><span class="comment">// 1 1024 1048576 1073741824 1099511627776</span></span><br></pre></td></tr></tbody></table></figure>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/04/19/django-dan-biao-de-zeng-shan-gai-cha/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/04/19/django-dan-biao-de-zeng-shan-gai-cha/" class="post-title-link" itemprop="url">Django单表的增删改查</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-04-18 17:46:44" itemprop="dateCreated datePublished" datetime="2021-04-18T17:46:44Z">2021-04-18</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-07-11 11:12:07" itemprop="dateModified" datetime="2021-07-11T11:12:07Z">2021-07-11</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/django/" itemprop="url" rel="index"><span itemprop="name">django</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 教师表</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Teacher</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">name = models.CharField(max_length=<span class="number">35</span>)</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        db_table = ‘teacher’</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加教师</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">addteacher</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="comment"># 添加的方式有多种结合postman测试添加</span></span><br><span class="line">    name = request.POST.get(<span class="string">'name'</span>,<span class="string">''</span>)</span><br><span class="line">    flag = <span class="literal">False</span></span><br><span class="line">    <span class="comment"># try捕获异常</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        tea = Teacher(name=name)</span><br><span class="line">        tea.save()</span><br><span class="line">        <span class="keyword">if</span> tea:</span><br><span class="line">            flag = <span class="literal">True</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">if</span> flag:</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">'OK'</span>)</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">'fail'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">admins</span>(<span class="params">request</span>):</span></span><br><span class="line">    tea = Teacher.objects.all()</span><br><span class="line">    <span class="keyword">return</span> render(request,<span class="string">'index.html'</span>,locals())</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update</span>(<span class="params">request,uid</span>):</span></span><br><span class="line">    tea = Teacher.objects.get(id=uid)</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</span><br><span class="line">        id = request.POST.get(<span class="string">'id'</span>)</span><br><span class="line">        name = request.POST.get(<span class="string">'name'</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            teacher = Teacher.objects.filter(id=id).update(name=name)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">return</span> render(request,<span class="string">'update.html'</span>,locals())</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dec</span>(<span class="params">request</span>):</span></span><br><span class="line">    id = request.GET.get(<span class="string">'id'</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        Teacher.objects.filter(id=id).delete()</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">'OK'</span>)</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">```</span><br><span class="line"></span><br><span class="line">```py</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></tbody></table></figure><script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/04/19/go-yi-lai-guan-li/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/04/19/go-yi-lai-guan-li/" class="post-title-link" itemprop="url">go依赖管理</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-04-18 17:46:44" itemprop="dateCreated datePublished" datetime="2021-04-18T17:46:44Z">2021-04-18</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-07-11 03:25:51" itemprop="dateModified" datetime="2021-07-11T03:25:51Z">2021-07-11</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>GOPATH以及目录结构<br>GOPATH 环境变量<br>默认在~/go(Unix, Linux), %USERPROFILE%\go(Windows)<br>官方推荐：所有项目和第三方库都放在同一个 GOPATH 下<br>也可以将每个项目放在不同的 GOPATH</p>
<p>以 Mac 为例(~/.bash_profile)</p>
<p>export GOPATH=/Users/alan/go<br>export PATH=”$GOPATH/bin:$PATH”</p>
<p>export GOPATH=/Users/alan/go<br>export PATH=”$GOPATH/bin:$PATH”</p>
<h3 id="go-modules是一个统一管理，用户不必关心目录结构"><a href="#go-modules是一个统一管理，用户不必关心目录结构" class="headerlink" title="go modules是一个统一管理，用户不必关心目录结构"></a>go modules是一个统一管理，用户不必关心目录结构</h3><p>go module 是Go语言从 1.11 版本之后官方推出的版本管理工具，并且从 Go1.13 版本开始，go module 成为了Go语言默认的依赖管理工具。</p>
<p>通过<code>GO111MODULE</code>环境变量来开启或者关闭<br>GO111MODULE=off 禁用 go module，编译时会从 GOPATH 和 vendor 文件夹中查找包。<br>GO111MODULE=on 启用 go module，编译时会忽略 GOPATH 和 vendor 文件夹，只根据 go.mod 下载依赖。<br>GO111MODULE=auto（默认值），当项目在 $GOPATH/src 目录之外，并且项目根目录有 go.mod 文件时，开启 go module。</p>
<p>◆ 使用module后,GOPATH不再用于解析。把下载的依赖储存在 $GOPATH/pkg/mod 中，也会把 go install 的结果放在 $GOPATH/bin</p>
<p>◆ 要用module ,第一步将项目从中移出去，在以后的开发中就没有必要在 GOPATH/src 中创建项目了，可以把需要统一维护的 repo 放到自己想要放置的任何一个文件夹下，在 Goland 中打开开关后，同样可以正常索引代码，并且还能够很好的管理项目依赖的第三方包信息。</p>
<p>在auto模式下，在$GOPATH/src路径下build时，默认使用vendor、GOPATH导入第三方包，而在GOPATH之外编译时，默认使用go.mod设置导入项目。我们知道vendor机制只有在GOPATH路径之下才起作用，到了GOPATH之外就没用了。</p>
<p>goland会自动生成一个 go.mod 文件</p>
<ul>
<li>来管理依赖,定义模块依赖</li>
<li>放在项目根目录</li>
<li>面向行,由指令+参数组成</li>
</ul>
<p>go.mod 主要指令<br>◆ module:定义当前引用模块和包路径<br>◆ require: 定义依赖的模块的最小版本<br>◆ exclude: 排除特定模块和版本的使用<br>◆ replace:模块源的替换 比方说远程的 module 拉不下来，可以用 replace 替换成另一个来源的 module 或本地的 module。</p>
<p>go.mod 命令<br>go.mod文件用go mod命令来创建和维护</p>
<p>◆ 命令格式</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go mod &lt;命令&gt; [可选参数]</span><br></pre></td></tr></tbody></table></figure>

<p>命令行生成<br>命令  作用<br>go mod download 下载依赖包模块到本地缓存 ，缓存路径是 $GOPATH/pkg/mod/cache<br>go mod edit 编辑 go.mod 文件<br>go mod graph 打印模块之间的依赖图<br>go mod init xxx(xxx 为module名称 可以自定义) 初始化当前文件夹，创建和初始化go.mod文件</p>
<p><code>go mod tidy</code> will also add requirements sums needed by all packages in the main module. It will also remove requirements and sums that aren’t needed anymore.<br>对于已存在项目进行module化,即可使用该命令 会添加依赖的包,移除go.mod未使用的依赖。执行后会生成go.sum文件(模块下载条目) 自动维护require包版本控制<br>go.sum 文件则是用来记录每个依赖包的版本及哈希值</p>
<p>go mod vendor 将依赖复制到 vendor 目录下<br>go mod verify 校验当前模块的依赖是否已经存储在本地下载的源代码缓存中，以及检查自从下载下来是否有修改，删除不需要的依赖、新增需要的依赖，这个操作不会改变依赖版本。<br>go mod why 解释为什么需要依赖<br>go build go tidy go verify 都会自动维护require包版本控制</p>
<p>go mod edit -require=golang.org/x/net@v0.0.0</p>
<p>手动加入被墙的包(原始包)，一定要记住版本号，实在不知道的话，就试试v0.0.0 版本可以通过执行go build 或者go tidy查看报错中版本号</p>
<p>go mod edit -replace=golang.org/x/net@v0.0.0=github.com/golang/net@latest</p>
<p>用新的包路径替换掉被墙的原始包，在这里新的包版本可以使用latest和master，这个有点人性了！</p>
<p>go mod edit -require 和 -replace 可以通过修改go.mod文件来做</p>
<h3 id="go-get命令下载更新指定版本的第三方扩展依赖包"><a href="#go-get命令下载更新指定版本的第三方扩展依赖包" class="headerlink" title="go get命令下载更新指定版本的第三方扩展依赖包"></a>go get命令下载更新指定版本的第三方扩展依赖包</h3><p>执行go get 命令，在下载依赖包的同时还可以指定依赖包的版本。<br>运行go get -u命令会将项目中的包升级到最新的次要版本或者修订版本；<br>运行go get -u=patch命令会将项目中的包升级到最新的修订版本；<br>运行go get [包名]@[版本号]命令会下载对应包的指定版本或者将对应包升级到指定的版本。<br>提示：go get [包名]@[版本号]命令中版本号可以是 x.y.z 的形式，例如 go get <a href="mailto:foo@v1.2.3">foo@v1.2.3</a>，也可以是 git 上的分支或 tag，例如 go get foo@master，保持最新请使用latest ,还可以是 git 提交时的哈希值，例如 go get foo@e3702bed2。它要求仓库必须用 v1.2.0 格式打 tag，像 v1.2 少个零都不行的，必须是语义化的、带 v 前缀的版本号。,</p>
<p>第一种：命令行拉取</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">go get -u xxx@版本号  # 拉取制定版本号</span><br><span class="line">go get -u xxx  #拉取最新版本</span><br><span class="line"></span><br><span class="line">go get -u go.uber.org/zap</span><br><span class="line">go get -u go.uber.org/zap@v1.11</span><br></pre></td></tr></tbody></table></figure>

<p>第二种：直接在代码里面写入import, 会直接帮你拉下来。</p>
<p>增加依赖:go get xxx 或者import然后get build或者点击快捷方式时自动生成依赖</p>
<p>导入外部包,一个或多个外部的包，<br><code>go get 远程的包名[@v...]</code> 从远程拉取代码以及相关的依赖库，自动完成安装与定义 ,支持github,bitbucket,google code,<br>-u 更新</p>
<p>内部做了两个步骤</p>
<ol>
<li>下载远程的源码包 $GOPATH/src</li>
<li>go install 安装    $GOPATH/pkg/跨平台文件名/包的路径/xxx.a新建一个包是新建一个文件夹，一般小写，在这个包中我们定义一个功能，只是简单的打印，</li>
</ol>
<p>安装git ,svn</p>
<p>项目迁移到go mod：</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">go build ./...</span><br><span class="line"></span><br><span class="line">go install ./... # 产生的结果在GOPATH目录下的bin目录</span><br></pre></td></tr></tbody></table></figure>

<p>incompatible<br>Module version numbering</p>
<p>一个 module 的版本由三个编号组成，Golang 认为第一个编号变更的时候是大型变更，所以需要新起一个 module。 比方说 v2.2.3 ，我们应该新建一个文件夹 v2，在其中新建一个 go.mod，然后新版本的代码都放在里面。 这样的好处是同一功能不同版本的代码都在同一代码仓库下。</p>
<p>在 Golang 引入 module 前，有一些仓库的 tag 的首位编号已经大于等于 2 ，对于这些没有迁移到 go.mod 的仓库，在作为包引入的时候，就会在我们的仓库下的 go.mod 中打上 +incompatible 标记。</p>
<p>require directive<br>A require directive declares a minimum required version of a given module dependency. 申明了所依赖 module 的最小版本。</p>
<p>indirect<br>An // indirect comment indicates that no package from the required module is directly imported by any package in the main module. The go command adds an indirect requirement when the selected version of a module is higher than what is already implied (transitively) by the main module’s other dependencies. That may occur because of an explicit upgrade (go get -u), removal of some other dependency that previously imposed the requirement (go mod tidy), or a dependency that imports a package without a corresponding requirement in its own go.mod file (such as a dependency that lacks a go.mod file altogether).</p>
<p>如果我们依赖的某个 module 所引用的包不是一个 module（即不包含 go.mod），或者我们用 go get -u 主动升级过非我们直接依赖的 module，那么都会用 indirect 去标记。</p>
<p><code>go clean -modcache</code> 清理本地缓存</p>
<h3 id="传统的-GOPATH-方案"><a href="#传统的-GOPATH-方案" class="headerlink" title="传统的 GOPATH 方案"></a>传统的 GOPATH 方案</h3><p>导致我所有的代码 repo 都在同一个gopath目录之下的src文件夹下，没办法很好的分组。<br>所有项目都在GOPATH目录下，这样会导致目录越来越大，几乎所有的github都镜像到GOPATH下</p>
<ol start="2">
<li>要记得设置GO111MODULE=off, 开始go modules要记得GO111MODULE=on</li>
</ol>
<p>先查找 gopath/src 或 goroot/src 目录之下的包是否有<br>其实就是不做包管理</p>
<p>能用go modules就用modules 不用去考虑以前的开发模式<br>即使你使用了以前的模式 也可以自动设置为现在的modules模式</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/04/19/go-bian-ma-gui-fan/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/04/19/go-bian-ma-gui-fan/" class="post-title-link" itemprop="url">Go编码规范</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-04-18 17:46:44" itemprop="dateCreated datePublished" datetime="2021-04-18T17:46:44Z">2021-04-18</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-07-11 03:39:43" itemprop="dateModified" datetime="2021-07-11T03:39:43Z">2021-07-11</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Go编码规范"><a href="#Go编码规范" class="headerlink" title="Go编码规范"></a>Go编码规范</h1><p>本文参考自<br>     <a target="_blank" rel="noopener" href="https://golang.org/doc/effective_go.html">Effective Go</a>.<br>     <a target="_blank" rel="noopener" href="https://github.com/golang/go/wiki/CodeReviewComments#initialisms">Golang Code Review</a></p>
<pre><code> 侵删。
</code></pre>
<ul>
<li><a href="#gofmt">Gofmt</a></li>
<li><a href="#%E6%B3%A8%E9%87%8A%E8%AF%AD%E5%8F%A5">注释语句</a></li>
<li><a href="#contexts">Contexts</a></li>
<li><a href="#goroutine-%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F">Goroutine 生命周期</a></li>
<li><a href="#%E6%8B%B7%E8%B4%9D">拷贝</a></li>
<li><a href="#%E4%BD%BF%E7%94%A8crypto-rand%E7%94%9F%E6%88%90%E9%9A%8F%E6%9C%BA%E5%80%BC">使用crypto rand生成随机值</a></li>
<li><a href="#%E7%A9%BA%E5%88%87%E7%89%87">空切片</a></li>
<li><a href="#panic">Panic</a></li>
<li><a href="#%E9%94%99%E8%AF%AF">错误</a></li>
<li><a href="#%E7%94%A8%E6%B3%95%E7%A4%BA%E4%BE%8B">用法示例</a></li>
<li><a href="#imports">Imports</a></li>
<li><a href="#%E6%8E%A5%E5%8F%A3">接口</a></li>
<li><a href="#%E5%8D%95%E8%A1%8C%E4%BB%A3%E7%A0%81%E9%95%BF%E5%BA%A6">单行代码长度</a></li>
<li><a href="#%E5%90%8D%E7%A7%B0">名称</a></li>
<li><a href="#%E4%BC%A0%E5%80%BC">传值</a></li>
<li><a href="#receiver">Receiver</a></li>
<li><a href="#%E5%90%8C%E6%AD%A5%E5%87%BD%E6%95%B0">同步函数</a></li>
<li><a href="#%E6%9C%89%E6%95%88%E6%B5%8B%E8%AF%95%E4%BF%A1%E6%81%AF">有效测试信息</a></li>
<li><a href="#%E5%87%BD%E6%95%B0">函数</a></li>
</ul>
<h2 id="Gofmt"><a href="#Gofmt" class="headerlink" title="Gofmt"></a>Gofmt</h2><p>  你可以在你的代码中运行 <a target="_blank" rel="noopener" href="https://golang.org/cmd/gofmt/">Gofmt</a> 以解决大多数代码格式问题。几乎所有的代码都使用 <code>gofmt</code>。如果使用<a target="_blank" rel="noopener" href="https://github.com/visualfc/liteide">liteide</a>编写Go代码时，使用ctrl+s即可调用gofmt。<br>  另一种方法是使用 <a target="_blank" rel="noopener" href="https://godoc.org/golang.org/x/tools/cmd/goimports">goimports</a>，它是 <code>gofmt</code>的超集，可根据需要添加（删除）行。</p>
<h2 id="注释语句"><a href="#注释语句" class="headerlink" title="注释语句"></a>注释语句</h2><p>  参考 [<a target="_blank" rel="noopener" href="https://golang.org/doc/effective_go.html#commentary]">https://golang.org/doc/effective_go.html#commentary]</a> </p>
<p>  所有导出的名称、函数声明、结构声明等都应该有注释  </p>
<p>  Go语言提供C风格的<code>/* */</code>块注释和C++风格的<code>//</code>行注释。</p>
<p>  包应该有一个包注释，对于多文件包，注释只需要出现在任意一个文件中。包注释应当提供整个包相关的信息。</p>
<p>  注释的句子应当具有完整性，这使得它们在提取到文档时能保持良好的格式。使用godoc时包注释将与声明一起提取，作为项目的解释性文本。这些注释的风格和内容决定了文档的质量。</p>
<p>  注释应当以描述的事物名称开头，以句点（或者 ! ? ）结束。</p>
<p>代码逻辑注释<br>对于一些关键位置的代码逻辑，或者局部较为复杂的逻辑，需要有相应的逻辑说明，方便其他开发者阅读该段代码，实例如下：</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 从 Redis 中批量读取属性，对于没有读取到的 id ， 记录到一个数组里面，准备从 DB 中读取</span></span><br><span class="line">xxxxx</span><br><span class="line">xxxxxxx</span><br><span class="line">xxxxxxx</span><br></pre></td></tr></tbody></table></figure>

<p>注释风格<br>统一使用中文注释，对于中英文字符之间严格使用空格分隔， 这个不仅仅是中文和英文之间，英文和中文标点之间也都要使用空格分隔，例如：</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 从 Redis 中批量读取属性，对于没有读取到的 id ， 记录到一个数组里面，准备从 DB 中读取</span></span><br></pre></td></tr></tbody></table></figure>

<p>上面 Redis 、 id 、 DB 和其他中文字符之间都是用了空格分隔。</p>
<p>建议全部使用单行注释<br>和代码的规范一样，单行注释不要过长，禁止超过 120 字符。</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Request represents a request to run a command.</span></span><br><span class="line"><span class="keyword">type</span> Request <span class="keyword">struct</span> { ...</span><br><span class="line"></span><br><span class="line"><span class="comment">// Encode writes the JSON encoding of req to w.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Encode</span><span class="params">(w io.Writer, req *Request)</span></span> { ...</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Package regexp implements a simple library for regular expressions.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">The syntax of the regular expressions accepted is:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    regexp:</span></span><br><span class="line"><span class="comment">        concatenation { '|' concatenation }</span></span><br><span class="line"><span class="comment">    concatenation:</span></span><br><span class="line"><span class="comment">        { closure }</span></span><br><span class="line"><span class="comment">    closure:</span></span><br><span class="line"><span class="comment">        term [ '*' | '+' | '?' ]</span></span><br><span class="line"><span class="comment">    term:</span></span><br><span class="line"><span class="comment">        '^'</span></span><br><span class="line"><span class="comment">        '$'</span></span><br><span class="line"><span class="comment">        '.'</span></span><br><span class="line"><span class="comment">        character</span></span><br><span class="line"><span class="comment">        '[' [ '^' ] character-ranges ']'</span></span><br><span class="line"><span class="comment">        '(' regexp ')'</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">package</span> regexp</span><br></pre></td></tr></tbody></table></figure>

<h3 id="包的注释"><a href="#包的注释" class="headerlink" title="包的注释"></a>包的注释</h3><p>与godoc呈现的所有注释一样，包的注释必须出现在package子句的旁边，且不带空行：</p>
<p>包注释<br>每个包都应该有一个包注释，一个位于package子句之前的块注释或行注释。包如果有多个go文件，只需要出现在一个go文件中（一般是和包同名的文件）即可。<br> 包注释应该包含下面基本信息(请严格按照这个顺序，简介，创建人，创建时间）</p>
<p>包的基本简介（包名，简介）<br>创建者，格式： 创建人： rtx 名<br>创建时间，格式：创建时间： yyyyMMdd<br>例如 util 包的注释示例如下</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// util 包， 该包包含了项目共用的一些常量，封装了项目中一些共用函数。</span></span><br><span class="line"><span class="comment">// 创建人： hanru</span></span><br><span class="line"><span class="comment">// 创建时间： 20190419</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Package math provides basic constants and mathematical functions.</span></span><br><span class="line"><span class="keyword">package</span> math</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Package template implements data-driven templates for generating textual</span></span><br><span class="line"><span class="comment">output such as HTML.</span></span><br><span class="line"><span class="comment">....</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">package</span> template</span><br></pre></td></tr></tbody></table></figure>

<p>对于main包的注释，很多种注释格式都是可以接受的，比如在目录<code>seedgen</code>中的 <code>package main</code>包，注释可以这下写:</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Binary seedgen ...</span></span><br><span class="line"><span class="keyword">package</span> main</span><br></pre></td></tr></tbody></table></figure>
<p>或</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Command seedgen ...</span></span><br><span class="line"><span class="keyword">package</span> main</span><br></pre></td></tr></tbody></table></figure>
<p>or</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Program seedgen ...</span></span><br><span class="line"><span class="keyword">package</span> main</span><br></pre></td></tr></tbody></table></figure>
<p>或</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The seedgen command ...</span></span><br><span class="line"><span class="keyword">package</span> main</span><br></pre></td></tr></tbody></table></figure>
<p>或</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The seedgen program ...</span></span><br><span class="line"><span class="keyword">package</span> main</span><br></pre></td></tr></tbody></table></figure>
<p>或</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Seedgen ..</span></span><br><span class="line"><span class="keyword">package</span> main</span><br></pre></td></tr></tbody></table></figure>
<p>请注意，以小写字母开头的句子不在包注释的可接受选项中，因为包是公开可见的，应当用合适的英语格式写成，包括将第一个词首字母大写。</p>
<p><a target="_blank" rel="noopener" href="https://golang.org/doc/effective_go.html#commentary">获取更多有关包注释的规范</a></p>
<h2 id="Contexts"><a href="#Contexts" class="headerlink" title="Contexts"></a>Contexts</h2><p>Go提供了<code>context</code>包来管理gorountine的生命周期。</p>
<p><code>context.Context</code>类型的值包括了跨API和进程边界的安全凭证，跟踪信息，结束时间和取消信号。</p>
<p>使用context包时请遵循以下规则：</p>
<ul>
<li><p>不要将 Contexts 放入结构体，context应该作为第一个参数传入。 不过也有例外，函数签名(method signature)必须与标准库或者第三方库中的接口相匹配</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">F</span><span class="params">(ctx context.Context, /* other arguments */)</span></span> {}</span><br></pre></td></tr></tbody></table></figure></li>
<li><p>即使函数允许，也不要传入nil的 Context。如果不知道用哪种 Context，可以使用context.TODO()</p>
</li>
<li><p>使用context的Value相关方法只应该用于在程序和接口中传递的和请求相关的元数据，不要用它来传递一些可选的参数</p>
</li>
<li><p>相同的 Context 可以传递给共享结束时间、取消信号、安全凭证和父进程追踪等信息的多个goroutine，Context 是并发安全的</p>
</li>
<li><p>从不做特定请求的函数可以使用 context.Background()，但即使您认为不需要，也可以在传递Context时使用错误(error)。如果您有充分的理由认为替代方案是错误的，那么只能直接使用context.Background()</p>
</li>
<li><p>不要在函数签名中创建Context类型或者使用Context以外的接口。</p>
</li>
</ul>
<p>官方使用context的例子：</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"context"</span></span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    d := time.Now().Add(<span class="number">50</span> * time.Millisecond)</span><br><span class="line">    ctx, cancel := context.WithDeadline(context.Background(), d)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Even though ctx will be expired, it is good practice to call its</span></span><br><span class="line">    <span class="comment">// cancelation function in any case. Failure to do so may keep the</span></span><br><span class="line">    <span class="comment">// context and its parent alive longer than necessary.</span></span><br><span class="line">    <span class="keyword">defer</span> cancel()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">select</span> {</span><br><span class="line">    <span class="keyword">case</span> &lt;-time.After(<span class="number">1</span> * time.Second):</span><br><span class="line">        fmt.Println(<span class="string">"overslept"</span>)</span><br><span class="line">    <span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">        fmt.Println(ctx.Err())</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="Goroutine-生命周期"><a href="#Goroutine-生命周期" class="headerlink" title="Goroutine 生命周期"></a>Goroutine 生命周期</h2><p>当你需要使用goruntines时，请确保它们什么时候/什么条件下退出。</p>
<p>Goroutines可能会因阻塞channel的send或者receives而泄露,即使被阻塞的通道无法访问，垃圾收集器也不会终止goroutine。</p>
<p>即使gorountine没有泄露，当不再需要它们时仍在继续运行会导致难以诊断的问题。即使在不需要结果后，修改正在使用的数据也会导致数据竞争。</p>
<p>尽量保证并发代码足够简单，使gorountine的生命周期更明显。如果难以做到，请记录gorountines退出的时间和原因。</p>
<h2 id="拷贝"><a href="#拷贝" class="headerlink" title="拷贝"></a>拷贝</h2><p>为了避免意外的别名(alias)，从另一个包复制结构时要小心。比如， <code>bytes.Buffer</code> 类型包含了 <code>[]byte</code> 切片类型，并且作为小字符串的优化，可被较小的字节数组引用。如果你拷贝了一个<code>Buffer</code>，拷贝中的切片可能会alias原始数组中的切片，从而导致后续的操作带来不可预测的结果。</p>
<p>通常来说，如果一个类型 <code>T</code>其方法与指针结构相关，那么请不要拷贝 <code>T</code>的值。</p>
<h2 id="使用crypto-rand生成随机值"><a href="#使用crypto-rand生成随机值" class="headerlink" title="使用crypto rand生成随机值"></a>使用crypto rand生成随机值</h2><p>请不要使用包 <code>math/rand</code> 来生成密钥，即使是一次性的。如果不提供种子，则密钥完全可以被预测到。就算用<code>time.Nanoseconds()</code>作为种子，也仅仅只有几个位上的差别。</p>
<p>使用<code>crypto/rand</code>‘s Reader作为代替。并且如果你需要生成文本，打印成16进制或者base64类型即可。</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"crypto/rand"</span></span><br><span class="line">    <span class="comment">// "encoding/base64"</span></span><br><span class="line">    <span class="comment">// "encoding/hex"</span></span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Key</span><span class="params">()</span> <span class="title">string</span></span> {</span><br><span class="line">    buf := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">16</span>)</span><br><span class="line">    _, err := rand.Read(buf)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">        <span class="built_in">panic</span>(err)  <span class="comment">// out of randomness, should never happen</span></span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> fmt.Sprintf(<span class="string">"%x"</span>, buf)</span><br><span class="line">    <span class="comment">// or hex.EncodeToString(buf)</span></span><br><span class="line">    <span class="comment">// or base64.StdEncoding.EncodeToString(buf)</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="空切片"><a href="#空切片" class="headerlink" title="空切片"></a>空切片</h2><p>当声明一个空切片时， 使用</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> t []<span class="keyword">string</span></span><br></pre></td></tr></tbody></table></figure>

<p>而不是</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">t := []<span class="keyword">string</span>{}</span><br></pre></td></tr></tbody></table></figure>

<p>前者声明了一个指向nil的切片，后者声明了一个 non-nil 且 len = 0的切片。虽然他们的功能是等价的：它们的 <code>len</code> 和<code>cap</code> 都是0，但nil切片应当作为首选方案。</p>
<p>请注意在有些情况下， non-nil 切片表现更好，比如当解码JSON对象时，nil切片解码为 <code>null</code>, non-nil 切片解码为 JSON 数组</p>
<p>在设计接口时，应当避免因nil切片和non-nil切片带来的不同表现，因为这可能会导致细微的编码错误。</p>
<p>有关nil的更多讨论，参考 <a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=ynoY2xz-F8s">Understanding Nil</a>.</p>
<h2 id="Panic"><a href="#Panic" class="headerlink" title="Panic"></a>Panic</h2><p>不要使用<code>panic</code>作为日常错误处理机制（除非你知道你在干什么），请使用<code>error</code>。</p>
<p>参考 <a target="_blank" rel="noopener" href="https://golang.org/doc/effective_go.html#panic">https://golang.org/doc/effective_go.html#panic</a>. </p>
<h2 id="错误"><a href="#错误" class="headerlink" title="错误"></a>错误</h2><h3 id="格式"><a href="#格式" class="headerlink" title="格式"></a>格式</h3><p>错误信息的字符串不应该大写（除非以专有名词或首字母缩略词开头）或以标点符号结尾，因为它们通常是在其他上下文后打印的。</p>
<p>使用  <code>fmt.Errorf("something bad")</code> 而不是 <code>fmt.Errorf("Something bad")</code> 。</p>
<h3 id="处理"><a href="#处理" class="headerlink" title="处理"></a>处理</h3><p>请不要使用<code>_</code>丢弃错误。如果一个函数返回一个错误，请检查错误，处理错误，必要情况下请panic。</p>
<p>标准库函数通常会向调用者返回某种错误指示，比如os.Open不仅在失败时返回一个nil指针，它还返回一个描述错误的错误值。如果不确保调用函数的成功返回，后续代码的行为将变得不可预测。</p>
<p>错误处理的原则就是不能丢弃任何有返回err的调用，<br>接收到错误，要么返回err，或者使用log记录下来<br>尽早return：一旦有错误发生，马上返回<br>尽量不要使用panic，除非你知道你在做什么<br>错误描述如果是英文必须为小写，不需要标点结尾<br>采用独立的错误流进行处理</p>
<p>参考 <a target="_blank" rel="noopener" href="https://golang.org/doc/effective_go.html#errors">https://golang.org/doc/effective_go.html#errors</a>.</p>
<h3 id="附带返回"><a href="#附带返回" class="headerlink" title="附带返回"></a>附带返回</h3><p>在C语言和类似语言中，函数常常返回 -1 或 null 值表示错误或者结果缺失。</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Lookup returns the value for key or "" if there is no mapping for key.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Lookup</span><span class="params">(key <span class="keyword">string</span>)</span> <span class="title">string</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Failing to check a for an in-band error value can lead to bugs:</span></span><br><span class="line">Parse(Lookup(key))  <span class="comment">// returns "parse failure for value" instead of "no value for key"</span></span><br></pre></td></tr></tbody></table></figure>

<p>Go语言对多个返回值的支持提供了更好的解决方案。<br>相比要求客户端特判返回值情况，函数应该在最后返回一个附加值以指示其他返回值是否有效。此返回值可能是一个error，或者在不需要解释时可以是bool。</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Lookup returns the value for key or ok=false if there is no mapping for key.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Lookup</span><span class="params">(key <span class="keyword">string</span>)</span> <span class="params">(value <span class="keyword">string</span>, ok <span class="keyword">bool</span>)</span></span></span><br></pre></td></tr></tbody></table></figure>
<p>这还可以防止调用者错误地使用结果:</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Parse(Lookup(key))  <span class="comment">// compile-time error</span></span><br></pre></td></tr></tbody></table></figure>

<p>鼓励编写更强大和可读性更强的代码:</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">value, ok := Lookup(key)</span><br><span class="line"><span class="keyword">if</span> !ok  {</span><br><span class="line">    <span class="keyword">return</span> fmt.Errorf(<span class="string">"no value for %q"</span>, key)</span><br><span class="line">}</span><br><span class="line"><span class="keyword">return</span> Parse(value)</span><br></pre></td></tr></tbody></table></figure>

<p>此规则适用于导出的函数，但对未导出的函数也很有用。<br>如 nil， “”， 0 和 -1 都可以作为函数的无效返回值。<br>一些标准库函数，比如包 “strings” 中的函数，返回值都会附带一个err.这极大地简化了花在字符串上的操作，代价是需要程序员花更多的功夫来处理err。</p>
<p>总而言之，通常情况下，Go代码应额外返回一个error值.</p>
<h3 id="缩进"><a href="#缩进" class="headerlink" title="缩进"></a>缩进</h3><p>尽量减少代码缩进，在获取错误后立即处理错误信息。这通常可以提高代码的可阅读性。</p>
<p>例如，不要写成：</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">    <span class="comment">// error handling</span></span><br><span class="line">} <span class="keyword">else</span> {</span><br><span class="line">    <span class="comment">// normal code</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>而应该写成：</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">    <span class="comment">// error handling</span></span><br><span class="line">    <span class="keyword">return</span> <span class="comment">// or continue, etc.</span></span><br><span class="line">}</span><br><span class="line"><span class="comment">// normal code</span></span><br></pre></td></tr></tbody></table></figure>

<p>如果<code>if</code>语句有初始化语句，比如：</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> x, err := f(); err != <span class="literal">nil</span> {</span><br><span class="line">    <span class="comment">// error handling</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">} <span class="keyword">else</span> {</span><br><span class="line">    <span class="comment">// use x</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>那么这可能需要将变量的声明另提一行：</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">x, err := f()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">    <span class="comment">// error handling</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">}</span><br><span class="line"><span class="comment">// use x</span></span><br></pre></td></tr></tbody></table></figure>
<h2 id="用法示例"><a href="#用法示例" class="headerlink" title="用法示例"></a>用法示例</h2><p>添加新的包时，请包含预期用法的示例。可以是一个可运行的例子或者演示完整调用的简单测试<br>参考 <a target="_blank" rel="noopener" href="https://blog.golang.org/examples">可测试示例函数</a></p>
<h2 id="Imports"><a href="#Imports" class="headerlink" title="Imports"></a>Imports</h2><h3 id="重命名、goimports"><a href="#重命名、goimports" class="headerlink" title="重命名、goimports"></a>重命名、goimports</h3><p>尽量避免导入包时的重命名，以避免名称冲突。如果发生名称冲突，尽量重命名本地或项目特定的包。</p>
<p>import在多行的情况下，goimports会自动帮你格式化，但是我们这里还是规范一下import的一些规范，如果你在一个文件里面引入了一个package，还是建议采用如下格式：</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure>

<p>如果你的包引入了三种类型的包，标准库包，程序内部包，第三方包，</p>
<p>导入包按名称分组，用空行隔开。</p>
<p>标准库包应始终位于第一组。</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"encoding/json"</span></span><br><span class="line">    <span class="string">"strings"</span></span><br><span class="line">​</span><br><span class="line">    <span class="string">"github.com/astaxie/beego"</span></span><br><span class="line">    <span class="string">"github.com/go-sql-driver/mysql"</span></span><br><span class="line"></span><br><span class="line">    <span class="string">"myproject/models"</span></span><br><span class="line">    <span class="string">"myproject/controller"</span></span><br><span class="line">    <span class="string">"myproject/utils"</span></span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure>

<p>有顺序的引入包，不同的类型采用空格分离，第一种实标准库，第二是项目包，第三是第三方包。</p>
<p>在项目中不要使用相对路径引入包：</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这是不好的导入</span></span><br><span class="line"><span class="keyword">import</span> “../net”</span><br><span class="line">​</span><br><span class="line"><span class="comment">// 这是正确的做法</span></span><br><span class="line"><span class="keyword">import</span> “github.com/repo/proj/src/net”</span><br></pre></td></tr></tbody></table></figure>

<p>但是如果是引入本项目中的其他包，最好使用相对路径。</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"hash/adler32"</span></span><br><span class="line">    <span class="string">"os"</span></span><br><span class="line"></span><br><span class="line">    <span class="string">"appengine/foo"</span></span><br><span class="line">    <span class="string">"appengine/user"</span></span><br><span class="line"></span><br><span class="line">        <span class="string">"github.com/foo/bar"</span></span><br><span class="line">    <span class="string">"rsc.io/goversion/version"</span></span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure>
<p>可以使用 <a target="_blank" rel="noopener" href="https://godoc.org/golang.org/x/tools/cmd/goimports">goimports</a> 来规范包的排序。</p>
<h3 id="Import-Dot"><a href="#Import-Dot" class="headerlink" title="Import Dot"></a>Import Dot</h3><p>使用 <code>import .</code> 来导入包在测试中很有用，但由于循环依赖性，它不能成为被测试包的一部分：</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> foo_test</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"bar/testutil"</span> <span class="comment">// also imports "foo"</span></span><br><span class="line">    . <span class="string">"foo"</span></span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure>
<p>在这种情况下，测试文件不能在包<code>foo</code>中，因为它使用了同样导入<code>foo</code>的包 <code>bar/testutil</code>，所以我们使用<code>import .</code>格式导入来让测试文件伪装成包foo的一部分，即使它并不是。除了这一情况，不要在你的程序中使用<code>import .</code>来导入包。它将使程序更难阅读，因为不清楚 Quux 这样的名称是在当前包中还是导入包中。</p>
<h2 id="接口"><a href="#接口" class="headerlink" title="接口"></a>接口</h2><p>Go语言接口类型通常属于包中的interface类型，而不是实现这些值的包。实现了接口的包应该返回具体的(通常是指针或者结构)类型：这样，新方法可以不需要大量重构就可以添加到实现中。</p>
<p>不要“为了模仿”而在API的实现端定义接口。<br>相反，设计的API应当能够使用公共的API来进行测试。</p>
<p>并且在使用之前不要定义接口：没有真实的例子之前，很难看出接口是否必需，更不要说它应该包含哪些方法。</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> consumer  <span class="comment">// consumer.go</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Thinger <span class="keyword">interface</span> { Thing() <span class="keyword">bool</span> }</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Foo</span><span class="params">(t Thinger)</span> <span class="title">string</span></span> { … }</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> consumer <span class="comment">// consumer_test.go</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> fakeThinger <span class="keyword">struct</span>{ … }</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t fakeThinger)</span> <span class="title">Thing</span><span class="params">()</span> <span class="title">bool</span></span> { … }</span><br><span class="line">…</span><br><span class="line"><span class="keyword">if</span> Foo(fakeThinger{…}) == <span class="string">"x"</span> { … }</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DO NOT DO IT!!!</span></span><br><span class="line"><span class="keyword">package</span> producer</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Thinger <span class="keyword">interface</span> { Thing() <span class="keyword">bool</span> }</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> defaultThinger <span class="keyword">struct</span>{ … }</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t defaultThinger)</span> <span class="title">Thing</span><span class="params">()</span> <span class="title">bool</span></span> { … }</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewThinger</span><span class="params">()</span> <span class="title">Thinger</span></span> { <span class="keyword">return</span> defaultThinger{ … } }</span><br></pre></td></tr></tbody></table></figure>

<p>取而代之的，可以直接使用原先的API接口，返回一个具体类型，让消费者模拟生产者的实现。</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> producer</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Thinger <span class="keyword">struct</span>{ … }</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t Thinger)</span> <span class="title">Thing</span><span class="params">()</span> <span class="title">bool</span></span> { … }</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewThinger</span><span class="params">()</span> <span class="title">Thinger</span></span> { <span class="keyword">return</span> Thinger{ … } }</span><br></pre></td></tr></tbody></table></figure>


<h2 id="单行代码长度"><a href="#单行代码长度" class="headerlink" title="单行代码长度"></a>单行代码长度</h2><p>Go代码中没有严格限制行的长度，但请避免使用不舒服的长行。同样，当一行长代码可读性还行时，不要添加换行符来增加行数。</p>
<p>较长的行似乎与较长的名称有关，所以请尽量避免长的名称。<br>实际上，这与关于函数应该有多长的建议完全相同。没有规则“函数不应该超过N行”，但肯定会有这么长的一个函数，并且这个函数也可以分解为多个小函数来实现相同的功能。</p>
<h2 id="名称"><a href="#名称" class="headerlink" title="名称"></a>名称</h2><p>如果要在其他包使用该名称，请大写首字母。</p>
<p>名称如果是首字母或首字母缩略词（例如 “URL” 或 “NATO”)，应当具有一致的大小写. 例如，”URL” 应写为 “URL” 或”url”，而不是 “Url”。</p>
<p>举个例子： ServerHTTP与ServerHttp，应当使用前者。<br>对于具有多个缩略单词的标识符，使用例如 “xmlHTTPRequest” 或 “XMLHTTPRequest”。<br>当”ID”是标识符的缩写时，此规则也同样适用，因此请写成 “appID” 而不是 “appId”。</p>
<h3 id="变量名"><a href="#变量名" class="headerlink" title="变量名"></a>变量名</h3><p>Go中变量名应尽量短。对于局部变量尤其如此，首选<code>c</code>作为<code>lineCount</code>,<code>i</code>作为<code>sliceIndex</code>。</p>
<p>基本规则：名称使用的地方距其声明的地方越远，则名称必须越具描述性。对一个方法receiver，一个或两个字母就足够了。循环索引或读取之类的常见变量可以使单个字母(<code>i r</code>)，更多不常见的事物和全局变量需要更具描述性的名称。</p>
<h3 id="包名"><a href="#包名" class="headerlink" title="包名"></a>包名</h3><p>包名应当简洁、清晰、意义深刻。按照惯例，包名应该由小写字母组成，不要使用下划线或混合大小写。</p>
<p>包中名称的所有引用都将会使用到包名，所以你可以省略包中名称的标识符。<br>例如，<code>chubby.ChubbyFile</code>，可以精简为<code>chubby.File</code>。</p>
<p>请注意避免使用无意义的包名称，如 util,common,misc,api,types和interfaces。</p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="http://golang.org/doc/effective_go.html#package-names">http://golang.org/doc/effective_go.html#package-names</a> </p>
<p><a target="_blank" rel="noopener" href="http://blog.golang.org/package-names">http://blog.golang.org/package-names</a> </p>
<h3 id="组合名"><a href="#组合名" class="headerlink" title="组合名"></a>组合名</h3><p>Go语言决定使用MixedCaps或mixedCaps来命名由多个单词组合的名称，而不是使用下划线来连接多个单词。即使它打破了其他语言的惯例。</p>
<p>例如，未导出的常量名为<code>maxLength</code> 而不是<code>MaxLength</code> 或 <code>MAX_LENGTH</code>。</p>
<h3 id="结果参数命名"><a href="#结果参数命名" class="headerlink" title="结果参数命名"></a>结果参数命名</h3><p>考虑下结果参数命名为下面这种情况时，godoc下的文档会是什么样子</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n *Node)</span> <span class="title">Parent1</span><span class="params">()</span> <span class="params">(node *Node)</span></span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n *Node)</span> <span class="title">Parent2</span><span class="params">()</span> <span class="params">(node *Node, err error)</span></span></span><br></pre></td></tr></tbody></table></figure>

<p>文档会念起来更拗口，推荐下面这种：</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n *Node)</span> <span class="title">Parent1</span><span class="params">()</span> *<span class="title">Node</span></span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n *Node)</span> <span class="title">Parent2</span><span class="params">()</span> <span class="params">(*Node, error)</span></span></span><br></pre></td></tr></tbody></table></figure>

<p>另一方面，如果函数返回值意义不明，给返回参数添加名称可能会很有用。</p>
<p>总之，尽量提高API可读性，比如：</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *Foo)</span> <span class="title">Location</span><span class="params">()</span> <span class="params">(<span class="keyword">float64</span>, <span class="keyword">float64</span>, error)</span></span></span><br></pre></td></tr></tbody></table></figure>
<p>更优的写法：</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Location returns f's latitude and longitude.</span></span><br><span class="line"><span class="comment">// Negative values mean south and west, respectively.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *Foo)</span> <span class="title">Location</span><span class="params">()</span> <span class="params">(lat, long <span class="keyword">float64</span>, err error)</span></span></span><br></pre></td></tr></tbody></table></figure>

<p>结论： 文档的清晰度比节约一两行代码更加重要。</p>
<p>最后，在某些情况下，如果您需要命名结果参数才能在defer中关闭变量的话，也是可以的。</p>
<h2 id="传值"><a href="#传值" class="headerlink" title="传值"></a>传值</h2><p>不要仅仅为了节省几个字节而传指针给函数。如果函数仅仅将其参数”x”作为<code>*x</code>使用，那么参数就不应该是指针。</p>
<p>常见的传指针的情况有：传递一个string的指针、指向接口值(<code>*io.Reader</code>)的指针;这两种情况下，值本身都是固定的，可以直接传递。</p>
<p>对于大型数据结构，或者是小型的可能增长的结构，请考虑传指针。</p>
<p>更多情况请见 <a href="#receiver-type">Receiver Type</a></p>
<h2 id="Receiver"><a href="#Receiver" class="headerlink" title="Receiver"></a>Receiver</h2><h3 id="名称-1"><a href="#名称-1" class="headerlink" title="名称"></a>名称</h3><p>方法receiver的名称应该反映其身份；通常，其类型的一个或两个字母缩写就足够了(例如”client”的”c”或”cl”)。请不要使用通用名称如”me”, “this” 或 “self”。请始终保持名称不变，如果你在一个地方命名receiver为 “c”，那么请不要在另一处叫其”cl”</p>
<h3 id="指针还是值"><a href="#指针还是值" class="headerlink" title="指针还是值"></a>指针还是值</h3><p>如果您不知道怎么决定，请使用指针。但有时候receiver为值也挺有用，这种通常是出于效率的原因，且值为小的不变结构或基本类型的值。</p>
<p>一些建议：</p>
<ul>
<li>请不要使用指针，如果满足receiver为map，func或者chan，或receiver为切片并且该方法不会重新分配切片</li>
<li>请不要使用指针，如果receiver是较小数组或结构体，没有可变的字段和指针，或者是一个简单的基本类型，int或者string</li>
<li>请使用指针，如果方法需要改变receiver</li>
<li>请使用指针，以避免被拷贝，如果receiver包含了sync.Mutex 或类似同步字段的结构</li>
<li>请使用指针，以提升效率，如果receiver是较大的数组或结构体</li>
<li>请使用指针，如果需要在方法中改变receiver的值</li>
<li>请使用指针，如果receiver是结构体，数组或切片这种成员是一个指向可变内容的指针</li>
<li>请使用指针，如果不清楚该如何选择</li>
</ul>
<h2 id="同步函数"><a href="#同步函数" class="headerlink" title="同步函数"></a>同步函数</h2><p>相比异步函数，应当首选同步函数 —— 直接返回结果或在返回之前完成任何回调或通道操作的函数。</p>
<p>同步函数使得gorountine在调用中本地化，更容易推断其生命周期并避免泄露和数据竞争。它们也更容易测试:调用者可以传递输入并检查输出，而无需轮询或同步。</p>
<p>如果调用者需要更多的并发，他们可以简单地在单独的gorountine中调用函数来实现。但在调用者端删除不必要的并发是非常困难甚至是不可能的。</p>
<h2 id="有效测试信息"><a href="#有效测试信息" class="headerlink" title="有效测试信息"></a>有效测试信息</h2><p>测试失败时应当返回有效的错误信息，说明错误在哪，输入是什么，输出时什么，期望输出是什么。<br>一个典型的测试条件形如：</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> got != tt.want {</span><br><span class="line">    t.Errorf(<span class="string">"Foo(%q) = %d; want %d"</span>, tt.in, got, tt.want) <span class="comment">// or Fatalf, if test can't test anything more past this point</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>请注意此处的命令是 <code>实际结果 != 预期结果</code>.一些测试框架鼓励程序员编写： 0 != x, “expected 0, got x”，go并不推荐。</p>
<p>在任何情况下，您有责任提供有用的错误信息，以便将来调试您的代码。</p>
<p>单元测试文件名命名规范为 example_test.go 测试用例的函数名称必须以 Test 开头，例如：TestExample 每个重要的函数都要首先编写测试用例，测试用例和正规代码一起提交方便进行回归测试</p>
<h2 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h2><ul>
<li>函数采用命名的多值返回，但请考虑 <a href="#%E7%BB%93%E6%9E%9C%E5%8F%82%E6%95%B0%E5%91%BD%E5%90%8D">结果参数命名</a></li>
<li>传入变量和返回变量以小写字母开头</li>
</ul>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">nextInt</span><span class="params">(b []<span class="keyword">byte</span>, pos <span class="keyword">int</span>)</span> <span class="params">(value, nextPos <span class="keyword">int</span>)</span></span> {</span><br><span class="line"><span class="comment">//</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>如果需要，请返回错误信息</li>
</ul>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/04/19/go-bian-ma-gui-fan-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/04/19/go-bian-ma-gui-fan-1/" class="post-title-link" itemprop="url">Go编码规范1</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-04-18 17:46:44" itemprop="dateCreated datePublished" datetime="2021-04-18T17:46:44Z">2021-04-18</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-07-21 03:44:04" itemprop="dateModified" datetime="2021-07-21T03:44:04Z">2021-07-21</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ul>
<li><a href="#%E4%BB%8B%E7%BB%8D">介绍</a></li>
<li><a href="#%E6%8C%87%E5%AF%BC%E5%8E%9F%E5%88%99">指导原则</a><ul>
<li><a href="#%E5%86%99%E5%87%BA%E5%A5%BD%E4%BB%A3%E7%A0%81%E7%9A%84%E5%9F%BA%E6%9C%AC%E5%8E%9F%E5%88%99">写出好代码的基本原则</a></li>
<li><a href="#%E6%8C%87%E5%90%91interface%E7%9A%84%E6%8C%87%E9%92%88">指向interface 的指针</a></li>
<li><a href="#interface%E5%90%88%E7%90%86%E6%80%A7%E9%AA%8C%E8%AF%81">Interface合理性验证</a></li>
<li><a href="#%E6%8E%A5%E6%94%B6%E5%99%A8(receiver)%E4%B8%8E%E6%8E%A5%E5%8F%A3">接收器(receiver)与接口</a></li>
<li><a href="#%E9%9B%B6%E5%80%BCMutex%E6%98%AF%E6%9C%89%E6%95%88%E7%9A%84">零值Mutex是有效的</a></li>
<li><a href="#%E5%9C%A8%E8%BE%B9%E7%95%8C%E5%A4%84%E6%8B%B7%E8%B4%9DSlices%E5%92%8CMaps">在边界处拷贝Slices和Maps</a></li>
<li><a href="#%E4%BD%BF%E7%94%A8defer%E9%87%8A%E6%94%BE%E8%B5%84%E6%BA%90">使用defer释放资源</a></li>
<li><a href="#Channel%E7%9A%84size%E8%A6%81%E4%B9%88%E6%98%AF1%EF%BC%8C%E8%A6%81%E4%B9%88%E6%98%AF%E6%97%A0%E7%BC%93%E5%86%B2%E7%9A%84">Channel的size要么是1，要么是无缓冲的</a></li>
<li><a href="#%E6%9E%9A%E4%B8%BE%E4%BB%8E1%E5%BC%80%E5%A7%8B">枚举从1开始</a></li>
<li><a href="#%E4%BD%BF%E7%94%A8time%E5%A4%84%E7%90%86%E6%97%B6%E9%97%B4">使用<code>"time"</code>处理时间</a></li>
<li><a href="#%E9%94%99%E8%AF%AF%E7%B1%BB%E5%9E%8B">错误类型</a></li>
<li><a href="#%E9%94%99%E8%AF%AF%E5%8C%85%E8%A3%85">错误包装</a></li>
<li><a href="#%E5%A4%84%E7%90%86%E7%B1%BB%E5%9E%8B%E6%96%AD%E8%A8%80%E5%A4%B1%E8%B4%A5">处理类型断言失败</a></li>
<li><a href="#%E4%B8%8D%E8%A6%81panic">不要panic</a></li>
<li><a href="#%E4%BD%BF%E7%94%A8go.uber.org/atomic">使用go.uber.org/atomic</a></li>
<li><a href="#%E9%81%BF%E5%85%8D%E5%8F%AF%E5%8F%98%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F">避免可变全局变量</a></li>
<li><a href="#%E9%81%BF%E5%85%8D%E5%9C%A8%E5%85%AC%E5%85%B1%E7%BB%93%E6%9E%84%E4%B8%AD%E5%B5%8C%E5%85%A5%E7%B1%BB%E5%9E%8B">避免在公共结构中嵌入类型</a></li>
</ul>
</li>
<li><a href="#%E6%80%A7%E8%83%BD">性能</a><ul>
<li><a href="#%E4%BC%98%E5%85%88%E4%BD%BF%E7%94%A8strconv%E8%80%8C%E4%B8%8D%E6%98%AFfmt">优先使用strconv而不是fmt</a></li>
<li><a href="#%E9%81%BF%E5%85%8D%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%88%B0%E5%AD%97%E8%8A%82%E7%9A%84%E8%BD%AC%E6%8D%A2">避免字符串到字节的转换</a></li>
<li><a href="#%E5%B0%BD%E9%87%8F%E5%88%9D%E5%A7%8B%E5%8C%96%E6%97%B6%E6%8C%87%E5%AE%9AMap%E5%AE%B9%E9%87%8F">尽量初始化时指定Map容量</a></li>
</ul>
</li>
<li><a href="#%E8%A7%84%E8%8C%83">规范</a><ul>
<li><a href="#%E9%A1%B9%E7%9B%AE%E5%91%BD%E5%90%8D%E8%A7%84%E8%8C%83">项目命名规范</a></li>
<li><a href="#%E6%BA%90%E7%A0%81%E6%96%87%E4%BB%B6%E8%A7%84%E8%8C%83">源码文件规范</a></li>
<li><a href="#%E5%90%88%E7%90%86%E4%BD%BF%E7%94%A8%E7%A9%BA%E6%A0%BC">合理使用空格</a></li>
<li><a href="#%E6%B3%A8%E9%87%8A">注释</a></li>
<li><a href="#%E7%9B%B8%E4%BC%BC%E7%9A%84%E5%A3%B0%E6%98%8E%E6%94%BE%E5%9C%A8%E4%B8%80%E7%BB%84">相似的声明放在一组</a></li>
<li><a href="#%E5%AF%BC%E5%85%A5%E5%88%86%E7%BB%84">导入分组</a></li>
<li><a href="#%E5%8C%85%E5%90%8D">包名</a></li>
<li><a href="#%E6%96%B9%E6%B3%95">方法</a></li>
<li><a href="#%E6%8D%A2%E8%A1%8C">换行</a></li>
<li><a href="#%E5%AF%BC%E5%85%A5%E5%88%AB%E5%90%8D">导入别名</a></li>
<li><a href="#%E5%87%BD%E6%95%B0%E5%88%86%E7%BB%84%E4%B8%8E%E9%A1%BA%E5%BA%8F">函数分组与顺序</a></li>
<li><a href="#%E5%87%8F%E5%B0%91%E5%B5%8C%E5%A5%97">减少嵌套</a></li>
<li><a href="#%E4%B8%8D%E5%BF%85%E8%A6%81%E7%9A%84else">不必要的else</a></li>
<li><a href="#%E9%A1%B6%E5%B1%82%E5%8F%98%E9%87%8F%E5%A3%B0%E6%98%8E">顶层变量声明</a></li>
<li><a href="#%E5%AF%B9%E4%BA%8E%E6%9C%AA%E5%AF%BC%E5%87%BA%E7%9A%84%E9%A1%B6%E5%B1%82%E5%B8%B8%E9%87%8F%E5%92%8C%E5%8F%98%E9%87%8F%EF%BC%8C%E4%BD%BF%E7%94%A8_%E4%BD%9C%E4%B8%BA%E5%89%8D%E7%BC%80">对于未导出的顶层常量和变量，使用_作为前缀</a></li>
<li><a href="#%E7%BB%93%E6%9E%84%E4%BD%93%E4%B8%AD%E7%9A%84%E5%B5%8C%E5%85%A5">结构体中的嵌入</a></li>
<li><a href="#%E4%BD%BF%E7%94%A8%E5%AD%97%E6%AE%B5%E5%90%8D%E5%88%9D%E5%A7%8B%E5%8C%96%E7%BB%93%E6%9E%84%E4%BD%93">使用字段名初始化结构体</a></li>
<li><a href="#%E6%9C%AC%E5%9C%B0%E5%8F%98%E9%87%8F%E5%A3%B0%E6%98%8E">本地变量声明</a></li>
<li><a href="#nil%E6%98%AF%E4%B8%80%E4%B8%AA%E6%9C%89%E6%95%88%E7%9A%84slice">nil是一个有效的slice</a></li>
<li><a href="#%E5%B0%8F%E5%8F%98%E9%87%8F%E4%BD%9C%E7%94%A8%E5%9F%9F">小变量作用域</a></li>
<li><a href="#%E9%81%BF%E5%85%8D%E5%8F%82%E6%95%B0%E8%AF%AD%E4%B9%89%E4%B8%8D%E6%98%8E%E7%A1%AE">避免参数语义不明确</a></li>
<li><a href="#%E4%BD%BF%E7%94%A8%E5%8E%9F%E5%A7%8B%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%AD%97%E9%9D%A2%E5%80%BC%EF%BC%8C%E9%81%BF%E5%85%8D%E8%BD%AC%E4%B9%89">使用原始字符串字面值，避免转义</a></li>
<li><a href="#%E5%88%9D%E5%A7%8B%E5%8C%96Struct%E5%BC%95%E7%94%A8">初始化Struct引用</a></li>
<li><a href="#%E5%88%9D%E5%A7%8B%E5%8C%96Maps">初始化Maps</a></li>
<li><a href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%A0%BC%E5%BC%8F%E5%8C%96">字符串格式化 </a></li>
<li><a href="#%E5%91%BD%E5%90%8DPrintf%E6%A0%B7%E5%BC%8F%E7%9A%84%E5%87%BD%E6%95%B0">命名Printf样式的函数</a></li>
<li><a href="#%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95">日志记录</a></li>
</ul>
</li>
<li><a href="#%E7%BC%96%E7%A8%8B%E6%A8%A1%E5%BC%8F">编程模式</a><ul>
<li><a href="#%E8%A1%A8%E9%A9%B1%E5%8A%A8%E6%B5%8B%E8%AF%95">表驱动测试</a></li>
<li><a href="#%E5%8A%9F%E8%83%BD%E9%80%89%E9%A1%B9">功能选项</a></li>
</ul>
</li>
</ul>
<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>样式是支配我们代码的惯例。术语<code>样式</code>有点用词不当，因为这些约定涵盖的范围不限于由<code>gofmt</code>替我们处理的源文件格式。本指南基于<code>Uber&nbsp;Golang开发规范</code>而制定，该指南最初由Prashant&nbsp;Varanasi和Simon&nbsp;Newton编写，目的是使一些同事能快速使用Golang。多年来，该指南已根据其他人的反馈进行了修改，其中许多是Golang的通用准则，而其他扩展准则依赖于下面外部的指南</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://golang.org/doc/effective_go.html">Effective Go</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/golang/go/wiki/CodeReviewComments">The Go common mistakes guide</a></li>
</ol>
<p>所有代码都应该通过<code>golint</code>和<code>go&nbsp;vet</code>的检查并无错误。我们建议您将IDE设置为</p>
<ul>
<li>保存时运行<code>goimports</code></li>
<li>&nbsp;运行<code>golint</code>&nbsp;和<code>go&nbsp;vet</code>检查错误</li>
<li>提交代码时勾选：<code>Go fmt</code>、<code>Rearrange code</code>、<code>Optimize imports</code>以及<code>Check TODO (Shwo All)</code></li>
<li>如果不习惯使用<code>Go fmt</code>可以使用IDE自带的代码格式化来完成</li>
<li>不同的语言在代码格式化上处理不同，比如Java则不建议使用代码格式化而是<strong>坚持自己写出来的代码就比格式化出来的代码要好</strong></li>
</ul>
<h2 id="指导原则"><a href="#指导原则" class="headerlink" title="指导原则"></a>指导原则</h2><h3 id="写出好代码的基本原则"><a href="#写出好代码的基本原则" class="headerlink" title="写出好代码的基本原则"></a>写出好代码的基本原则</h3><p><strong>好的代码就是一个艺术品</strong>，好的代码不管是借鉴开源代码还是在做Code Review时，都应该是赏心悦目的而不是读代码的时候时刻都在骂娘，如何写出好的代码，下面给出一些参考</p>
<ul>
<li><strong>规范不仅是文档，而是必须遵守的原则</strong>，任何一个人熟悉规范是一回事（因为规范没有任何技术含量），但是能不能写规范的代码又是另外一回事</li>
<li>如果你写代码的时候发现自己在给一个方法或者变量命名时，时刻在注意变量名或者方法是不是简单而有效，而不是一股脑的只顾写代码，什么都不想</li>
<li><a href="#%E4%B8%8D%E5%BF%85%E8%A6%81%E7%9A%84else">在考虑减少不必要的语句</a></li>
<li><a href="#%E7%9B%B8%E4%BC%BC%E7%9A%84%E5%A3%B0%E6%98%8E%E6%94%BE%E5%9C%A8%E4%B8%80%E7%BB%84">写代码如同写英文作文，讲究段落感，该留出段落的地方一定要空行；意义相近的声明一定要分组</a></li>
<li><strong>遵守规范并时刻强迫自己遵守规范</strong>，如果没有相应的规范，就遵守现有的事实标准。如Http的Header命名，你看浏览器默认发的Header命名即可（正确的应该是Xxxx-Yyyy而不是Xxxx_Yyyy）</li>
<li>培养自己手写代码的能力（在纸上写，而不是用IDE写），你和高级程序员之间差的就是手写代码的能力</li>
</ul>
<h3 id="指向interface的指针"><a href="#指向interface的指针" class="headerlink" title="指向interface的指针"></a>指向interface的指针</h3><p>您几乎不需要指向接口类型的指针。您应该将接口作为值进行传递，在这样的传递过程中，实质上传递的底层数据仍然可以是指针，接口实质上在底层用两个字段表示：</p>
<ol>
<li>一个指向某些特定类型信息的指针，您可以将其视为”type”</li>
<li>数据指针，如果存储的数据是指针，则直接存储。如果存储的数据是一个值，则存储指向该值的指针</li>
</ol>
<p>如果希望接口方法修改基础数据，则必须使用指针传递</p>
<h3 id="Interface合理性验证"><a href="#Interface合理性验证" class="headerlink" title="Interface合理性验证"></a>Interface合理性验证</h3><p>在编译时验证接口的符合性。这包括</p>
<ul>
<li>将实现特定接口所需的导出类型作为其API的一部分</li>
<li>导出或未导出的类型是实现同一接口的类型集合的一部分</li>
<li>其他违反接口的情况会破坏用户</li>
</ul>
<h4 id="反例"><a href="#反例" class="headerlink" title="反例"></a>反例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Handler <span class="keyword">struct</span> {</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h *Handler)</span> <span class="title">ServeHTTP</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  w http.ResponseWriter,</span></span></span><br><span class="line"><span class="function"><span class="params">  r *http.Request,</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span> {</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="正例"><a href="#正例" class="headerlink" title="正例"></a>正例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Handler <span class="keyword">struct</span> {</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">}</span><br><span class="line"><span class="keyword">var</span> _ http.Handler = (*Handler)(<span class="literal">nil</span>)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h *Handler)</span> <span class="title">ServeHTTP</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  w http.ResponseWriter,</span></span></span><br><span class="line"><span class="function"><span class="params">  r *http.Request,</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span> {</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>如果<code>*Handler</code>永远不会与<code>http.Handler</code>接口匹配,那么语句<code>var _ http.Handler = (*Handler)(nil)</code>将无法编译。赋值的右边应该是断言类型的零值。对于指针类型（如<code>*Handler</code>）、切片和映射，这是<code>nil</code>；对于结构类型，这是空结构</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> LogHandler <span class="keyword">struct</span> {</span><br><span class="line">  h   http.Handler</span><br><span class="line">  log *zap.Logger</span><br><span class="line">}</span><br><span class="line"><span class="keyword">var</span> _ http.Handler = LogHandler{}</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h LogHandler)</span> <span class="title">ServeHTTP</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  w http.ResponseWriter,</span></span></span><br><span class="line"><span class="function"><span class="params">  r *http.Request,</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span> {</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>


<h3 id="接收器-receiver-与接口"><a href="#接收器-receiver-与接口" class="headerlink" title="接收器(receiver)与接口"></a>接收器(receiver)与接口</h3><p>使用值接收器的方法既可以通过值调用，也可以通过指针调用</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> S <span class="keyword">struct</span> {</span><br><span class="line">  data <span class="keyword">string</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s S)</span> <span class="title">Read</span><span class="params">()</span> <span class="title">string</span></span> {</span><br><span class="line">  <span class="keyword">return</span> s.data</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *S)</span> <span class="title">Write</span><span class="params">(str <span class="keyword">string</span>)</span></span> {</span><br><span class="line">  s.data = str</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">sVals := <span class="keyword">map</span>[<span class="keyword">int</span>]S{<span class="number">1</span>: {<span class="string">"A"</span>}}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 你只能通过值调用 Read</span></span><br><span class="line">sVals[<span class="number">1</span>].Read()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这不能编译通过：</span></span><br><span class="line"><span class="comment">//  sVals[1].Write("test")</span></span><br><span class="line"></span><br><span class="line">sPtrs := <span class="keyword">map</span>[<span class="keyword">int</span>]*S{<span class="number">1</span>: {<span class="string">"A"</span>}}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过指针既可以调用 Read，也可以调用 Write 方法</span></span><br><span class="line">sPtrs[<span class="number">1</span>].Read()</span><br><span class="line">sPtrs[<span class="number">1</span>].Write(<span class="string">"test"</span>)</span><br></pre></td></tr></tbody></table></figure>

<p>同样，即使该方法具有值接收器，也可以通过指针来满足接口。</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> F <span class="keyword">interface</span> {</span><br><span class="line">  f()</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> S1 <span class="keyword">struct</span>{}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s S1)</span> <span class="title">f</span><span class="params">()</span></span> {}</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> S2 <span class="keyword">struct</span>{}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *S2)</span> <span class="title">f</span><span class="params">()</span></span> {}</span><br><span class="line"></span><br><span class="line">s1Val := S1{}</span><br><span class="line">s1Ptr := &amp;S1{}</span><br><span class="line">s2Val := S2{}</span><br><span class="line">s2Ptr := &amp;S2{}</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> i F</span><br><span class="line">i = s1Val</span><br><span class="line">i = s1Ptr</span><br><span class="line">i = s2Ptr</span><br><span class="line"></span><br><span class="line"><span class="comment">// 下面代码无法通过编译。因为s2Val 是一个值，而S2的f方法中没有使用值接收器</span></span><br><span class="line"><span class="comment">// i = s2Val</span></span><br></pre></td></tr></tbody></table></figure>

<p><a target="_blank" rel="noopener" href="https://golang.org/doc/effective_go.html">Effective Go</a> 中有一段关于 <a target="_blank" rel="noopener" href="https://golang.org/doc/effective_go.html#pointers_vs_values">pointers vs. values</a> 的精彩讲解</p>
<h3 id="零值Mutex是有效的"><a href="#零值Mutex是有效的" class="headerlink" title="零值Mutex是有效的"></a>零值Mutex是有效的</h3><p>零值<code>sync.Mutex</code>和<code>sync.RWMutex</code>是有效的。所以指向mutex的指针基本是不必要的</p>
<h4 id="反例-1"><a href="#反例-1" class="headerlink" title="反例"></a>反例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mu := <span class="built_in">new</span>(sync.Mutex)</span><br><span class="line">mu.Lock()</span><br></pre></td></tr></tbody></table></figure>

<h4 id="正例-1"><a href="#正例-1" class="headerlink" title="正例"></a>正例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mu sync.Mutex</span><br><span class="line">mu.Lock()</span><br></pre></td></tr></tbody></table></figure>

<p>如果你使用结构体指针，mutex可以非指针形式作为结构体的组成字段，或者更好的方式是直接嵌入到结构体中，如果是私有结构体类型或是要实现Mutex接口的类型，我们可以使用嵌入mutex的方法</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 为私有类型或需要实现互斥接口的类型嵌入</span></span><br><span class="line"><span class="keyword">type</span> smap <span class="keyword">struct</span> {</span><br><span class="line">  sync.Mutex <span class="comment">// only for unexported types（仅适用于非导出类型）</span></span><br><span class="line"></span><br><span class="line">  data <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newSMap</span><span class="params">()</span> *<span class="title">smap</span></span> {</span><br><span class="line">  <span class="keyword">return</span> &amp;smap{</span><br><span class="line">    data: <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>),</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *smap)</span> <span class="title">Get</span><span class="params">(k <span class="keyword">string</span>)</span> <span class="title">string</span></span> {</span><br><span class="line">  m.Lock()</span><br><span class="line">  <span class="keyword">defer</span> m.Unlock()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> m.data[k]</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 对于导出的类型，请使用专用字段</span></span><br><span class="line"><span class="keyword">type</span> SMap <span class="keyword">struct</span> {</span><br><span class="line">  mu sync.Mutex <span class="comment">// 对于导出类型，请使用私有锁</span></span><br><span class="line"></span><br><span class="line">  data <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewSMap</span><span class="params">()</span> *<span class="title">SMap</span></span> {</span><br><span class="line">  <span class="keyword">return</span> &amp;SMap{</span><br><span class="line">    data: <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>),</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *SMap)</span> <span class="title">Get</span><span class="params">(k <span class="keyword">string</span>)</span> <span class="title">string</span></span> {</span><br><span class="line">  m.mu.Lock()</span><br><span class="line">  <span class="keyword">defer</span> m.mu.Unlock()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> m.data[k]</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="在边界处拷贝Slices和Maps"><a href="#在边界处拷贝Slices和Maps" class="headerlink" title="在边界处拷贝Slices和Maps"></a>在边界处拷贝Slices和Maps</h3><p>Slices和Maps包含了指向底层数据的指针，因此在需要复制它们时要特别注意</p>
<h4 id="接收Slices和Maps"><a href="#接收Slices和Maps" class="headerlink" title="接收Slices和Maps"></a>接收Slices和Maps</h4><p>请记住，当map或slice作为函数参数传入时，如果您存储了对它们的引用，则用户可以对其进行修改</p>
<h4 id="反例-2"><a href="#反例-2" class="headerlink" title="反例"></a>反例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *Driver)</span> <span class="title">SetTrips</span><span class="params">(trips []Trip)</span></span> {</span><br><span class="line">  d.trips = trips</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">trips := ...</span><br><span class="line">d1.SetTrips(trips)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 你是要修改 d1.trips 吗？</span></span><br><span class="line">trips[<span class="number">0</span>] = ...</span><br></pre></td></tr></tbody></table></figure>

<h4 id="正例-2"><a href="#正例-2" class="headerlink" title="正例"></a>正例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *Driver)</span> <span class="title">SetTrips</span><span class="params">(trips []Trip)</span></span> {</span><br><span class="line">  d.trips = <span class="built_in">make</span>([]Trip, <span class="built_in">len</span>(trips))</span><br><span class="line">  <span class="built_in">copy</span>(d.trips, trips)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">trips := ...</span><br><span class="line">d1.SetTrips(trips)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这里我们修改 trips[0]，但不会影响到 d1.trips</span></span><br><span class="line">trips[<span class="number">0</span>] = ...</span><br></pre></td></tr></tbody></table></figure>







<h4 id="返回Slices或Maps"><a href="#返回Slices或Maps" class="headerlink" title="返回Slices或Maps"></a>返回Slices或Maps</h4><p>同样，请注意用户对暴露内部状态的map或slice的修改</p>
<h4 id="反例-3"><a href="#反例-3" class="headerlink" title="反例"></a>反例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Stats <span class="keyword">struct</span> {</span><br><span class="line">  mu sync.Mutex</span><br><span class="line"></span><br><span class="line">  counters <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">int</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// Snapshot 返回当前状态。</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Stats)</span> <span class="title">Snapshot</span><span class="params">()</span> <span class="title">map</span>[<span class="title">string</span>]<span class="title">int</span></span> {</span><br><span class="line">  s.mu.Lock()</span><br><span class="line">  <span class="keyword">defer</span> s.mu.Unlock()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> s.counters</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// snapshot 不再受互斥锁保护</span></span><br><span class="line"><span class="comment">// 因此对 snapshot 的任何访问都将受到数据竞争的影响</span></span><br><span class="line"><span class="comment">// 影响 stats.counters</span></span><br><span class="line">snapshot := stats.Snapshot()</span><br></pre></td></tr></tbody></table></figure>

<h4 id="正例-3"><a href="#正例-3" class="headerlink" title="正例"></a>正例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Stats <span class="keyword">struct</span> {</span><br><span class="line">  mu sync.Mutex</span><br><span class="line"></span><br><span class="line">  counters <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">int</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Stats)</span> <span class="title">Snapshot</span><span class="params">()</span> <span class="title">map</span>[<span class="title">string</span>]<span class="title">int</span></span> {</span><br><span class="line">  s.mu.Lock()</span><br><span class="line">  <span class="keyword">defer</span> s.mu.Unlock()</span><br><span class="line"></span><br><span class="line">  result := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">int</span>, <span class="built_in">len</span>(s.counters))</span><br><span class="line">  <span class="keyword">for</span> k, v := <span class="keyword">range</span> s.counters {</span><br><span class="line">    result[k] = v</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> result</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// snapshot 现在是一个拷贝</span></span><br><span class="line">snapshot := stats.Snapshot()</span><br></pre></td></tr></tbody></table></figure>

<h3 id="使用defer释放资源"><a href="#使用defer释放资源" class="headerlink" title="使用defer释放资源"></a>使用defer释放资源</h3><p>使用defer释放资源，诸如文件和锁</p>
<h4 id="反例-4"><a href="#反例-4" class="headerlink" title="反例"></a>反例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">p.Lock()</span><br><span class="line"><span class="keyword">if</span> p.count &lt; <span class="number">10</span> {</span><br><span class="line">  p.Unlock()</span><br><span class="line">  <span class="keyword">return</span> p.count</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">p.count++</span><br><span class="line">newCount := p.count</span><br><span class="line">p.Unlock()</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> newCount</span><br><span class="line"></span><br><span class="line"><span class="comment">// 当有多个 return 分支时，很容易遗忘 unlock</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="正例-4"><a href="#正例-4" class="headerlink" title="正例"></a>正例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">p.Lock()</span><br><span class="line"><span class="keyword">defer</span> p.Unlock()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> p.count &lt; <span class="number">10</span> {</span><br><span class="line">  <span class="keyword">return</span> p.count</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">p.count++</span><br><span class="line"><span class="keyword">return</span> p.count</span><br><span class="line"></span><br><span class="line"><span class="comment">// 更可读</span></span><br></pre></td></tr></tbody></table></figure>

<p>Defer的开销非常小，只有在您可以证明函数执行时间处于纳秒级的程度时，才应避免这样做。使用defer提升可读性是值得的，因为使用它们的成本微不足道。尤其适用于那些不仅仅是简单内存访问的较大的方法，在这些方法中其他计算的资源消耗远超过 <code>defer</code></p>
<h3 id="Channel的size要么是1，要么是无缓冲的"><a href="#Channel的size要么是1，要么是无缓冲的" class="headerlink" title="Channel的size要么是1，要么是无缓冲的"></a>Channel的size要么是1，要么是无缓冲的</h3><p>channel通常size 应为1或是无缓冲的。默认情况下，channel是无缓冲的，其size为零。任何其他尺寸都必须经过严格的审查。我们需要考虑如何确定大小，考虑是什么阻止了channel在高负载下和阻塞写时的写入，以及当这种情况发生时系统逻辑有哪些变化(翻译解释：按照原文意思是需要界定通道边界，竞态条件，以及逻辑上下文梳理)</p>
<h4 id="反例-5"><a href="#反例-5" class="headerlink" title="反例"></a>反例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 应该足以满足任何情况！</span></span><br><span class="line">c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">64</span>)</span><br></pre></td></tr></tbody></table></figure>

<h4 id="正例-5"><a href="#正例-5" class="headerlink" title="正例"></a>正例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 大小：1</span></span><br><span class="line">c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">1</span>) <span class="comment">// 或者</span></span><br><span class="line"><span class="comment">// 无缓冲 channel，大小为 0</span></span><br><span class="line">c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br></pre></td></tr></tbody></table></figure>

<h3 id="枚举从1开始"><a href="#枚举从1开始" class="headerlink" title="枚举从1开始"></a>枚举从1开始</h3><p>在Go中引入枚举的标准方法是声明一个自定义类型和一个使用了iota的const组。由于变量的默认值为0，因此通常应以非零值开头枚举</p>
<h4 id="反例-6"><a href="#反例-6" class="headerlink" title="反例"></a>反例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Operation <span class="keyword">int</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">  Add Operation = <span class="literal">iota</span></span><br><span class="line">  Subtract</span><br><span class="line">  Multiply</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Add=0, Subtract=1, Multiply=2</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="正例-6"><a href="#正例-6" class="headerlink" title="正例"></a>正例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Operation <span class="keyword">int</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">  Add Operation = <span class="literal">iota</span> + <span class="number">1</span></span><br><span class="line">  Subtract</span><br><span class="line">  Multiply</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Add=1, Subtract=2, Multiply=3</span></span><br></pre></td></tr></tbody></table></figure>

<p>在某些情况下，使用零值是有意义的（枚举从零开始），例如，<strong>当零值是理想的默认行为时</strong></p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> LogOutput <span class="keyword">int</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">  LogToStdout LogOutput = <span class="literal">iota</span></span><br><span class="line">  LogToFile</span><br><span class="line">  LogToRemote</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// LogToStdout=0, LogToFile=1, LogToRemote=2</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="使用time处理时间"><a href="#使用time处理时间" class="headerlink" title="使用time处理时间"></a>使用time处理时间</h3><p>时间处理很复杂。关于时间的错误假设通常包括以下几点</p>
<ol>
<li>一天有 24 小时</li>
<li>一小时有 60 分钟</li>
<li>一周有七天</li>
<li>一年 365 天</li>
<li><a target="_blank" rel="noopener" href="https://infiniteundo.com/post/25326999628/falsehoods-programmers-believe-about-time">还有更多</a></li>
</ol>
<p>例如，<em>1</em>表示在一个时间点上加上24小时并不总是产生一个新的日历日，因此，在处理时间时始终使用 <a target="_blank" rel="noopener" href="https://golang.org/pkg/time/"><code>"time"</code></a> 包，因为它有助于以更安全、更准确的方式处理这些不正确的假设</p>
<h4 id="使用time-Time表达瞬时时间"><a href="#使用time-Time表达瞬时时间" class="headerlink" title="使用time.Time表达瞬时时间"></a>使用<code>time.Time</code>表达瞬时时间</h4><p>在处理时间的瞬间时使用 <a target="_blank" rel="noopener" href="https://golang.org/pkg/time/#Time"><code>time.time</code></a>，在比较、添加或减去时间时使用<code>time.Time</code>中的方法</p>
<h4 id="反例-7"><a href="#反例-7" class="headerlink" title="反例"></a>反例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">isActive</span><span class="params">(now, start, stop <span class="keyword">int</span>)</span> <span class="title">bool</span></span> {</span><br><span class="line">  <span class="keyword">return</span> start &lt;= now &amp;&amp; now &lt; stop</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="正例-7"><a href="#正例-7" class="headerlink" title="正例"></a>正例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">isActive</span><span class="params">(now, start, stop time.Time)</span> <span class="title">bool</span></span> {</span><br><span class="line">  <span class="keyword">return</span> (start.Before(now) || start.Equal(now)) &amp;&amp; now.Before(stop)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="使用time-Duration表达时间段"><a href="#使用time-Duration表达时间段" class="headerlink" title="使用time.Duration表达时间段"></a>使用<code>time.Duration</code>表达时间段</h4><p>在处理时间段时使用 <a target="_blank" rel="noopener" href="https://golang.org/pkg/time/#Duration"><code>time.Duration</code></a></p>
<h4 id="反例-8"><a href="#反例-8" class="headerlink" title="反例"></a>反例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">poll</span><span class="params">(delay <span class="keyword">int</span>)</span></span> {</span><br><span class="line">  <span class="keyword">for</span> {</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    time.Sleep(time.Duration(delay) * time.Millisecond)</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line">poll(<span class="number">10</span>) <span class="comment">// 是几秒钟还是几毫秒?</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="正例-8"><a href="#正例-8" class="headerlink" title="正例"></a>正例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">poll</span><span class="params">(delay time.Duration)</span></span> {</span><br><span class="line">  <span class="keyword">for</span> {</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    time.Sleep(delay)</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line">poll(<span class="number">10</span>*time.Second)</span><br></pre></td></tr></tbody></table></figure>

<p>回到第一个例子，在一个时间瞬间加上 24 小时，我们用于添加时间的方法取决于意图。如果我们想要下一个日历日(当前天的下一天)的同一个时间点，我们应该使用 <a target="_blank" rel="noopener" href="https://golang.org/pkg/time/#Time.AddDate"><code>Time.AddDate</code></a>。但是，如果我们想保证某一时刻比前一时刻晚 24 小时，我们应该使用 <a target="_blank" rel="noopener" href="https://golang.org/pkg/time/#Time.Add"><code>Time.Add</code></a></p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">newDay := t.AddDate(<span class="number">0</span> <span class="comment">/* years */</span>, <span class="number">0</span>, <span class="comment">/* months */</span>, <span class="number">1</span> <span class="comment">/* days */</span>)</span><br><span class="line">maybeNewDay := t.Add(<span class="number">24</span> * time.Hour)</span><br></pre></td></tr></tbody></table></figure>

<h4 id="对外部系统使用time-Time和time-Duration"><a href="#对外部系统使用time-Time和time-Duration" class="headerlink" title="对外部系统使用time.Time和time.Duration"></a>对外部系统使用<code>time.Time</code>和<code>time.Duration</code></h4><p>尽可能在与外部系统的交互中使用<code>time.Duration</code>和<code>time.Time</code></p>
<ul>
<li>Command-line标志: <a target="_blank" rel="noopener" href="https://golang.org/pkg/flag/"><code>flag</code></a> 通过 <a target="_blank" rel="noopener" href="https://golang.org/pkg/time/#ParseDuration"><code>time.ParseDuration</code></a> 支持 <code>time.Duration</code></li>
<li>JSON: <a target="_blank" rel="noopener" href="https://golang.org/pkg/encoding/json/"><code>encoding/json</code></a> 通过其 <a target="_blank" rel="noopener" href="https://golang.org/pkg/time/#Time.UnmarshalJSON"><code>UnmarshalJSON</code> method</a> 方法支持将 <code>time.Time</code> 编码为 <a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc3339">RFC 3339</a> 字符串</li>
<li>SQL: <a target="_blank" rel="noopener" href="https://golang.org/pkg/database/sql/"><code>database/sql</code></a> 支持将 <code>DATETIME</code> 或 <code>TIMESTAMP</code> 列转换为 <code>time.Time</code>，如果底层驱动程序支持则返回</li>
<li>YAML: <a target="_blank" rel="noopener" href="https://godoc.org/gopkg.in/yaml.v2"><code>gopkg.in/yaml.v2</code></a> 支持将 <code>time.Time</code> 作为 <a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc3339">RFC 3339</a> 字符串，并通过 <a target="_blank" rel="noopener" href="https://golang.org/pkg/time/#ParseDuration"><code>time.ParseDuration</code></a> 支持 <code>time.Duration</code></li>
</ul>
<p>当不能在这些交互中使用<code>time.Duration</code> 时，请使用<code>int</code>或<code>float64</code>，并在字段名称中包含单位，例如，由于 <code>encoding/json</code> 不支持 <code>time.Duration</code>，因此该单位包含在字段的名称中</p>
<h4 id="反例-9"><a href="#反例-9" class="headerlink" title="反例"></a>反例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// {"interval": 2}</span></span><br><span class="line"><span class="keyword">type</span> Config <span class="keyword">struct</span> {</span><br><span class="line">  Interval <span class="keyword">int</span> <span class="string">`json:"interval"`</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="正例-9"><a href="#正例-9" class="headerlink" title="正例"></a>正例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// {"intervalMillis": 2000}</span></span><br><span class="line"><span class="keyword">type</span> Config <span class="keyword">struct</span> {</span><br><span class="line">  IntervalMillis <span class="keyword">int</span> <span class="string">`json:"intervalMillis"`</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>当在这些交互中不能使用<code>time.Time</code>时，除非达成一致，否则使用<code>string</code> 和<a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc3339">RFC 3339</a>中定义的格式时间戳。默认情况下，<a target="_blank" rel="noopener" href="https://golang.org/pkg/time/#Time.UnmarshalText"><code>Time.UnmarshalText</code></a>使用此格式，并可通过<a target="_blank" rel="noopener" href="https://golang.org/pkg/time/#RFC3339"><code>time.RFC3339</code></a>在<code>Time.Format</code>和<code>time.Parse</code>中使用</p>
<p>尽管这在实践中并不成问题，但请记住，<code>"time"</code>包不支持解析闰秒时间戳（<a target="_blank" rel="noopener" href="https://github.com/golang/go/issues/8728">8728</a>），也不在计算中考虑闰秒（<a target="_blank" rel="noopener" href="https://github.com/golang/go/issues/15190">15190</a>）。如果您比较两个时间瞬间，则差异将不包括这两个瞬间之间可能发生的闰秒</p>
<h3 id="错误类型"><a href="#错误类型" class="headerlink" title="错误类型"></a>错误类型</h3><p>Go 中有多种声明错误（Error) 的选项</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://golang.org/pkg/errors/#New"><code>errors.New</code></a> 对于简单静态字符串的错误</li>
<li><a target="_blank" rel="noopener" href="https://golang.org/pkg/fmt/#Errorf"><code>fmt.Errorf</code></a> 用于格式化的错误字符串</li>
<li>实现 <code>Error()</code> 方法的自定义类型</li>
<li>用<a target="_blank" rel="noopener" href="https://godoc.org/github.com/pkg/errors#Wrap"><code>"pkg/errors".Wrap</code></a>的Wrapped errors</li>
</ul>
<p>返回错误时，请考虑以下因素以确定最佳选择</p>
<ul>
<li>这是一个不需要额外信息的简单错误吗？如果是这样，<a target="_blank" rel="noopener" href="https://golang.org/pkg/errors/#New"><code>errors.New</code></a> 足够了</li>
<li>客户需要检测并处理此错误吗？如果是这样，则应使用自定义类型并实现该 <code>Error()</code> 方法</li>
<li>您是否正在传播下游函数返回的错误？如果是这样，请查看本文后面有关错误包装 <a href="#%E9%94%99%E8%AF%AF%E5%8C%85%E8%A3%85" title="Error-Wrapping">section on error wrapping</a> 部分的内容</li>
<li>否则 <a target="_blank" rel="noopener" href="https://golang.org/pkg/fmt/#Errorf"><code>fmt.Errorf</code></a> 就可以了</li>
</ul>
<p>如果客户端需要检测错误，并且您已使用创建了一个简单的错误<a target="_blank" rel="noopener" href="https://golang.org/pkg/errors/#New"><code>errors.New</code></a>，请使用一个错误变量。</p>
<h4 id="反例-10"><a href="#反例-10" class="headerlink" title="反例"></a>反例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// package foo</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Open</span><span class="params">()</span> <span class="title">error</span></span> {</span><br><span class="line">  <span class="keyword">return</span> errors.New(<span class="string">"could not open"</span>)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// package bar</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">use</span><span class="params">()</span></span> {</span><br><span class="line">  <span class="keyword">if</span> err := foo.Open(); err != <span class="literal">nil</span> {</span><br><span class="line">    <span class="keyword">if</span> err.Error() == <span class="string">"could not open"</span> {</span><br><span class="line">      <span class="comment">// handle</span></span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">      <span class="built_in">panic</span>(<span class="string">"unknown error"</span>)</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="正例-10"><a href="#正例-10" class="headerlink" title="正例"></a>正例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// package foo</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> ErrCouldNotOpen = errors.New(<span class="string">"could not open"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Open</span><span class="params">()</span> <span class="title">error</span></span> {</span><br><span class="line">  <span class="keyword">return</span> ErrCouldNotOpen</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// package bar</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err := foo.Open(); err != <span class="literal">nil</span> {</span><br><span class="line">  <span class="keyword">if</span> err == foo.ErrCouldNotOpen {</span><br><span class="line">    <span class="comment">// handle</span></span><br><span class="line">  } <span class="keyword">else</span> {</span><br><span class="line">    <span class="built_in">panic</span>(<span class="string">"unknown error"</span>)</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>如果您有可能需要客户端检测的错误，并且想向其中添加更多信息（例如，它不是静态字符串），则应使用自定义类型</p>
<h4 id="反例-11"><a href="#反例-11" class="headerlink" title="反例"></a>反例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">open</span><span class="params">(file <span class="keyword">string</span>)</span> <span class="title">error</span></span> {</span><br><span class="line">  <span class="keyword">return</span> fmt.Errorf(<span class="string">"file %q not found"</span>, file)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">use</span><span class="params">()</span></span> {</span><br><span class="line">  <span class="keyword">if</span> err := open(<span class="string">"testfile.txt"</span>); err != <span class="literal">nil</span> {</span><br><span class="line">    <span class="keyword">if</span> strings.Contains(err.Error(), <span class="string">"not found"</span>) {</span><br><span class="line">      <span class="comment">// handle</span></span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">      <span class="built_in">panic</span>(<span class="string">"unknown error"</span>)</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="正例-11"><a href="#正例-11" class="headerlink" title="正例"></a>正例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> errNotFound <span class="keyword">struct</span> {</span><br><span class="line">  file <span class="keyword">string</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e errNotFound)</span> <span class="title">Error</span><span class="params">()</span> <span class="title">string</span></span> {</span><br><span class="line">  <span class="keyword">return</span> fmt.Sprintf(<span class="string">"file %q not found"</span>, e.file)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">open</span><span class="params">(file <span class="keyword">string</span>)</span> <span class="title">error</span></span> {</span><br><span class="line">  <span class="keyword">return</span> errNotFound{file: file}</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">use</span><span class="params">()</span></span> {</span><br><span class="line">  <span class="keyword">if</span> err := open(<span class="string">"testfile.txt"</span>); err != <span class="literal">nil</span> {</span><br><span class="line">    <span class="keyword">if</span> _, ok := err.(errNotFound); ok {</span><br><span class="line">      <span class="comment">// handle</span></span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">      <span class="built_in">panic</span>(<span class="string">"unknown error"</span>)</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>直接导出自定义错误类型时要小心，因为它们已成为程序包公共API的一部分。最好公开匹配器功能以检查错误</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// package foo</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> errNotFound <span class="keyword">struct</span> {</span><br><span class="line">  file <span class="keyword">string</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e errNotFound)</span> <span class="title">Error</span><span class="params">()</span> <span class="title">string</span></span> {</span><br><span class="line">  <span class="keyword">return</span> fmt.Sprintf(<span class="string">"file %q not found"</span>, e.file)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">IsNotFoundError</span><span class="params">(err error)</span> <span class="title">bool</span></span> {</span><br><span class="line">  _, ok := err.(errNotFound)</span><br><span class="line">  <span class="keyword">return</span> ok</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Open</span><span class="params">(file <span class="keyword">string</span>)</span> <span class="title">error</span></span> {</span><br><span class="line">  <span class="keyword">return</span> errNotFound{file: file}</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// package bar</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err := foo.Open(<span class="string">"foo"</span>); err != <span class="literal">nil</span> {</span><br><span class="line">  <span class="keyword">if</span> foo.IsNotFoundError(err) {</span><br><span class="line">    <span class="comment">// handle</span></span><br><span class="line">  } <span class="keyword">else</span> {</span><br><span class="line">    <span class="built_in">panic</span>(<span class="string">"unknown error"</span>)</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="错误包装"><a href="#错误包装" class="headerlink" title="错误包装"></a>错误包装</h3><p>一个（函数/方法）调用失败时，有三种主要的错误传播方式</p>
<ul>
<li>如果没有要添加的其他上下文，并且您想要维护原始错误类型，则返回原始错误</li>
<li>添加上下文，使用<a target="_blank" rel="noopener" href="https://godoc.org/github.com/pkg/errors#Wrap"><code>"pkg/errors".Wrap</code></a> 以便错误消息提供更多上下文 ,<a target="_blank" rel="noopener" href="https://godoc.org/github.com/pkg/errors#Cause"><code>"pkg/errors".Cause</code></a> 可用于提取原始错误</li>
<li>如果调用者不需要检测或处理的特定错误情况，使用 <a target="_blank" rel="noopener" href="https://golang.org/pkg/fmt/#Errorf"><code>fmt.Errorf</code></a></li>
</ul>
<p>建议在可能的地方添加上下文，以使您获得诸如“调用服务 foo：连接被拒绝”之类的更有用的错误，而不是诸如“连接被拒绝”之类的模糊错误，在将上下文添加到返回的错误时，请避免使用“failed to”之类的短语来保持上下文简洁，这些短语会陈述明显的内容，并随着错误在堆栈中的渗透而逐渐堆积</p>
<h4 id="反例-12"><a href="#反例-12" class="headerlink" title="反例"></a>反例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">s, err := store.New()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">    <span class="keyword">return</span> fmt.Errorf(</span><br><span class="line">        <span class="string">"failed to create new store: %s"</span>, err)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// failed to x: failed to y: failed to create new store: the error</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="正例-12"><a href="#正例-12" class="headerlink" title="正例"></a>正例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">s, err := store.New()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">    <span class="keyword">return</span> fmt.Errorf(</span><br><span class="line">        <span class="string">"new store: %s"</span>, err)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// x: y: new store: the error</span></span><br></pre></td></tr></tbody></table></figure>

<p>但是，一旦将错误发送到另一个系统，就应该明确消息是错误消息（例如使用<code>err</code>标记，或在日志中以”Failed”为前缀），另请参见 <a target="_blank" rel="noopener" href="https://dave.cheney.net/2016/04/27/dont-just-check-errors-handle-them-gracefully">Don’t just check errors, handle them gracefully</a>，不要只是检查错误，要优雅地处理错误</p>
<h3 id="处理类型断言失败"><a href="#处理类型断言失败" class="headerlink" title="处理类型断言失败"></a>处理类型断言失败</h3><p><a target="_blank" rel="noopener" href="https://golang.org/ref/spec#Type_assertions">类型断言</a>的单个返回值形式针对不正确的类型将产生 panic。因此，请始终使用“comma ok”的惯用法</p>
<h4 id="反例-13"><a href="#反例-13" class="headerlink" title="反例"></a>反例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">t := i.(<span class="keyword">string</span>)</span><br></pre></td></tr></tbody></table></figure>

<h4 id="正例-13"><a href="#正例-13" class="headerlink" title="正例"></a>正例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">t, ok := i.(<span class="keyword">string</span>)</span><br><span class="line"><span class="keyword">if</span> !ok {</span><br><span class="line">  <span class="comment">// 优雅地处理错误</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="不要panic"><a href="#不要panic" class="headerlink" title="不要panic"></a>不要panic</h3><p>在生产环境中运行的代码必须避免出现panic。panic是<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Cascading_failure">cascading failures</a>级联失败的主要根源。如果发生错误，该函数必须返回错误，并允许调用方决定如何处理它</p>
<h4 id="反例-14"><a href="#反例-14" class="headerlink" title="反例"></a>反例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">foo</span><span class="params">(bar <span class="keyword">string</span>)</span></span> {</span><br><span class="line">  <span class="keyword">if</span> <span class="built_in">len</span>(bar) == <span class="number">0</span> {</span><br><span class="line">    <span class="built_in">panic</span>(<span class="string">"bar must not be empty"</span>)</span><br><span class="line">  }</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">  <span class="keyword">if</span> <span class="built_in">len</span>(os.Args) != <span class="number">2</span> {</span><br><span class="line">    fmt.Println(<span class="string">"USAGE: foo &lt;bar&gt;"</span>)</span><br><span class="line">    os.Exit(<span class="number">1</span>)</span><br><span class="line">  }</span><br><span class="line">  foo(os.Args[<span class="number">1</span>])</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="正例-14"><a href="#正例-14" class="headerlink" title="正例"></a>正例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">foo</span><span class="params">(bar <span class="keyword">string</span>)</span> <span class="title">error</span></span> {</span><br><span class="line">  <span class="keyword">if</span> <span class="built_in">len</span>(bar) == <span class="number">0</span> {</span><br><span class="line">    <span class="keyword">return</span> errors.New(<span class="string">"bar must not be empty"</span>)</span><br><span class="line">  }</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">  <span class="keyword">if</span> <span class="built_in">len</span>(os.Args) != <span class="number">2</span> {</span><br><span class="line">    fmt.Println(<span class="string">"USAGE: foo &lt;bar&gt;"</span>)</span><br><span class="line">    os.Exit(<span class="number">1</span>)</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">if</span> err := foo(os.Args[<span class="number">1</span>]); err != <span class="literal">nil</span> {</span><br><span class="line">    <span class="built_in">panic</span>(err)</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>panic/recover不是错误处理策略。仅当发生不可恢复的事情（例如nil引用）时，程序才必须panic。程序初始化是一个例外：程序启动时应使程序中止的不良情况可能会引起 panic</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> _statusTemplate = template.Must(template.New(<span class="string">"name"</span>).Parse(<span class="string">"_statusHTML"</span>))</span><br></pre></td></tr></tbody></table></figure>

<p>即使在测试代码中，也优先使用<code>t.Fatal</code>或者<code>t.FailNow</code>而不是panic来确保失败被标记</p>
<h4 id="反例-15"><a href="#反例-15" class="headerlink" title="反例"></a>反例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// func TestFoo(t *testing.T)</span></span><br><span class="line"></span><br><span class="line">f, err := ioutil.TempFile(<span class="string">""</span>, <span class="string">"test"</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">  <span class="built_in">panic</span>(<span class="string">"failed to set up test"</span>)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="正例-15"><a href="#正例-15" class="headerlink" title="正例"></a>正例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// func TestFoo(t *testing.T)</span></span><br><span class="line"></span><br><span class="line">f, err := ioutil.TempFile(<span class="string">""</span>, <span class="string">"test"</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">  t.Fatal(<span class="string">"failed to set up test"</span>)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="使用go-uber-org-atomic"><a href="#使用go-uber-org-atomic" class="headerlink" title="使用go.uber.org/atomic"></a>使用go.uber.org/atomic</h3><p>使用<a target="_blank" rel="noopener" href="https://golang.org/pkg/sync/atomic/">sync/atomic</a>包的原子操作对原始类型(<code>int32</code>, <code>int64</code>等）进行操作，因为很容易忘记使用原子操作来读取或修改变量，<a target="_blank" rel="noopener" href="https://godoc.org/go.uber.org/atomic">go.uber.org/atomic</a>通过隐藏基础类型为这些操作增加了类型安全性。此外，它包括一个方便的<code>atomic.Bool</code>类型</p>
<h4 id="反例-16"><a href="#反例-16" class="headerlink" title="反例"></a>反例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> foo <span class="keyword">struct</span> {</span><br><span class="line">  running <span class="keyword">int32</span>  <span class="comment">// atomic</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f* foo)</span> <span class="title">start</span><span class="params">()</span></span> {</span><br><span class="line">  <span class="keyword">if</span> atomic.SwapInt32(&amp;f.running, <span class="number">1</span>) == <span class="number">1</span> {</span><br><span class="line">     <span class="comment">// already running…</span></span><br><span class="line">     <span class="keyword">return</span></span><br><span class="line">  }</span><br><span class="line">  <span class="comment">// start the Foo</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *foo)</span> <span class="title">isRunning</span><span class="params">()</span> <span class="title">bool</span></span> {</span><br><span class="line">  <span class="keyword">return</span> f.running == <span class="number">1</span>  <span class="comment">// race!</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="正例-16"><a href="#正例-16" class="headerlink" title="正例"></a>正例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> foo <span class="keyword">struct</span> {</span><br><span class="line">  running atomic.Bool</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *foo)</span> <span class="title">start</span><span class="params">()</span></span> {</span><br><span class="line">  <span class="keyword">if</span> f.running.Swap(<span class="literal">true</span>) {</span><br><span class="line">     <span class="comment">// already running…</span></span><br><span class="line">     <span class="keyword">return</span></span><br><span class="line">  }</span><br><span class="line">  <span class="comment">// start the Foo</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *foo)</span> <span class="title">isRunning</span><span class="params">()</span> <span class="title">bool</span></span> {</span><br><span class="line">  <span class="keyword">return</span> f.running.Load()</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="避免可变全局变量"><a href="#避免可变全局变量" class="headerlink" title="避免可变全局变量"></a>避免可变全局变量</h3><p>使用选择依赖注入方式避免改变全局变量，既适用于函数指针又适用于其他值类型</p>
<h4 id="反例-17"><a href="#反例-17" class="headerlink" title="反例"></a>反例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// sign.go</span></span><br><span class="line"><span class="keyword">var</span> _timeNow = time.Now</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sign</span><span class="params">(msg <span class="keyword">string</span>)</span> <span class="title">string</span></span> {</span><br><span class="line">  now := _timeNow()</span><br><span class="line">  <span class="keyword">return</span> signWithTime(msg, now)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// sign_test.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestSign</span><span class="params">(t *testing.T)</span></span> {</span><br><span class="line">  oldTimeNow := _timeNow</span><br><span class="line">  _timeNow = <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">time</span>.<span class="title">Time</span></span> {</span><br><span class="line">    <span class="keyword">return</span> someFixedTime</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> { _timeNow = oldTimeNow }()</span><br><span class="line">  assert.Equal(t, want, sign(give))</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="正例-17"><a href="#正例-17" class="headerlink" title="正例"></a>正例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// sign.go</span></span><br><span class="line"><span class="keyword">type</span> signer <span class="keyword">struct</span> {</span><br><span class="line">  now <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">time</span>.<span class="title">Time</span></span></span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newSigner</span><span class="params">()</span> *<span class="title">signer</span></span> {</span><br><span class="line">  <span class="keyword">return</span> &amp;signer{</span><br><span class="line">    now: time.Now,</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *signer)</span> <span class="title">Sign</span><span class="params">(msg <span class="keyword">string</span>)</span> <span class="title">string</span></span> {</span><br><span class="line">  now := s.now()</span><br><span class="line">  <span class="keyword">return</span> signWithTime(msg, now)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// sign_test.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestSigner</span><span class="params">(t *testing.T)</span></span> {</span><br><span class="line">  s := newSigner()</span><br><span class="line">  s.now = <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">time</span>.<span class="title">Time</span></span> {</span><br><span class="line">    <span class="keyword">return</span> someFixedTime</span><br><span class="line">  }</span><br><span class="line">  assert.Equal(t, want, s.Sign(give))</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="避免在公共结构中嵌入类型"><a href="#避免在公共结构中嵌入类型" class="headerlink" title="避免在公共结构中嵌入类型"></a>避免在公共结构中嵌入类型</h3><p>这些嵌入的类型泄漏实现细节、禁止类型演化和模糊的文档。假设您使用共享的<code>AbstractList</code>实现了多种列表类型，请避免在具体的列表实现中嵌入<code>AbstractList</code>，相反，只需手动将方法写入具体的列表，该列表将委托给抽象列表</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> AbstractList <span class="keyword">struct</span> {}</span><br><span class="line"><span class="comment">// 添加将实体添加到列表中。</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *AbstractList)</span> <span class="title">Add</span><span class="params">(e Entity)</span></span> {</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">}</span><br><span class="line"><span class="comment">// 移除从列表中移除实体。</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *AbstractList)</span> <span class="title">Remove</span><span class="params">(e Entity)</span></span> {</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="反例-18"><a href="#反例-18" class="headerlink" title="反例"></a>反例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ConcreteList 是一个实体列表。</span></span><br><span class="line"><span class="keyword">type</span> ConcreteList <span class="keyword">struct</span> {</span><br><span class="line">  *AbstractList</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="正例-18"><a href="#正例-18" class="headerlink" title="正例"></a>正例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ConcreteList 是一个实体列表。</span></span><br><span class="line"><span class="keyword">type</span> ConcreteList <span class="keyword">struct</span> {</span><br><span class="line">  list *AbstractList</span><br><span class="line">}</span><br><span class="line"><span class="comment">// 添加将实体添加到列表中。</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *ConcreteList)</span> <span class="title">Add</span><span class="params">(e Entity)</span></span> {</span><br><span class="line">  <span class="keyword">return</span> l.list.Add(e)</span><br><span class="line">}</span><br><span class="line"><span class="comment">// 移除从列表中移除实体。</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *ConcreteList)</span> <span class="title">Remove</span><span class="params">(e Entity)</span></span> {</span><br><span class="line">  <span class="keyword">return</span> l.list.Remove(e)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>Go 允许<a target="_blank" rel="noopener" href="https://golang.org/doc/effective_go.html#embedding">类型嵌入</a>作为继承和组合之间的折衷，外部类型获取嵌入类型的方法的隐式副本。默认情况下，这些方法委托给嵌入实例的同一方法。</p>
<p>结构还获得与类型同名的字段。所以，如果嵌入的类型是public，那么字段是public。为了保持向后兼容性，外部类型的每个未来版本都必须保留嵌入类型。很少需要嵌入类型。这是一种方便，可以帮助您避免编写冗长的委托方法。即使嵌入兼容的抽象列表 <em>interface</em>，而不是结构体，这将为开发人员提供更大的灵活性来改变未来，但仍然泄露了具体列表使用抽象实现的细节</p>
<h4 id="反例-19"><a href="#反例-19" class="headerlink" title="反例"></a>反例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AbstractList 是各种实体列表的通用实现。</span></span><br><span class="line"><span class="keyword">type</span> AbstractList <span class="keyword">interface</span> {</span><br><span class="line">  Add(Entity)</span><br><span class="line">  Remove(Entity)</span><br><span class="line">}</span><br><span class="line"><span class="comment">// ConcreteList 是一个实体列表。</span></span><br><span class="line"><span class="keyword">type</span> ConcreteList <span class="keyword">struct</span> {</span><br><span class="line">  AbstractList</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="正例-19"><a href="#正例-19" class="headerlink" title="正例"></a>正例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ConcreteList 是一个实体列表。</span></span><br><span class="line"><span class="keyword">type</span> ConcreteList <span class="keyword">struct</span> {</span><br><span class="line">  list *AbstractList</span><br><span class="line">}</span><br><span class="line"><span class="comment">// 添加将实体添加到列表中。</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *ConcreteList)</span> <span class="title">Add</span><span class="params">(e Entity)</span></span> {</span><br><span class="line">  <span class="keyword">return</span> l.list.Add(e)</span><br><span class="line">}</span><br><span class="line"><span class="comment">// 移除从列表中移除实体。</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *ConcreteList)</span> <span class="title">Remove</span><span class="params">(e Entity)</span></span> {</span><br><span class="line">  <span class="keyword">return</span> l.list.Remove(e)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>无论是使用嵌入式结构还是使用嵌入式接口，嵌入式类型都会限制类型的演化</p>
<ul>
<li>向嵌入式接口添加方法是一个破坏性的改变。</li>
<li>删除嵌入类型是一个破坏性的改变。</li>
<li>即使使用满足相同接口的替代方法替换嵌入类型，也是一个破坏性的改变。</li>
</ul>
<p>尽管编写这些委托方法是乏味的，但是额外的工作隐藏了实现细节，留下了更多的更改机会，还消除了在文档中发现完整列表接口的间接性操作</p>
<h2 id="性能"><a href="#性能" class="headerlink" title="性能"></a>性能</h2><p>性能方面的特定准则只适用于高频场景</p>
<h3 id="优先使用strconv而不是fmt"><a href="#优先使用strconv而不是fmt" class="headerlink" title="优先使用strconv而不是fmt"></a>优先使用strconv而不是fmt</h3><p>将原语转换为字符串或从字符串转换时，<code>strconv</code>速度比<code>fmt</code>快</p>
<h4 id="反例-20"><a href="#反例-20" class="headerlink" title="反例"></a>反例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; b.N; i++ {</span><br><span class="line">  s := fmt.Sprint(rand.Int())</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// BenchmarkFmtSprint-4    143 ns/op    2 allocs/op</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="正例-20"><a href="#正例-20" class="headerlink" title="正例"></a>正例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; b.N; i++ {</span><br><span class="line">  s := strconv.Itoa(rand.Int())</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// BenchmarkStrconv-4    64.2 ns/op    1 allocs/op</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="避免字符串到字节的转换"><a href="#避免字符串到字节的转换" class="headerlink" title="避免字符串到字节的转换"></a>避免字符串到字节的转换</h3><p>不要反复从固定字符串创建字节slice。相反，请执行一次转换并捕获结果</p>
<h4 id="反例-21"><a href="#反例-21" class="headerlink" title="反例"></a>反例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; b.N; i++ {</span><br><span class="line">  w.Write([]<span class="keyword">byte</span>(<span class="string">"Hello world"</span>))</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// BenchmarkBad-4   50000000   22.2 ns/op</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="正例-21"><a href="#正例-21" class="headerlink" title="正例"></a>正例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">data := []<span class="keyword">byte</span>(<span class="string">"Hello world"</span>)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; b.N; i++ {</span><br><span class="line">  w.Write(data)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// BenchmarkGood-4  500000000   3.25 ns/op</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="尽量初始化时指定Map容量"><a href="#尽量初始化时指定Map容量" class="headerlink" title="尽量初始化时指定Map容量"></a>尽量初始化时指定Map容量</h3><p>在尽可能的情况下，在使用<code>make()</code>初始化的时候提供容量信息</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">make</span>(<span class="keyword">map</span>[T1]T2, hint)</span><br></pre></td></tr></tbody></table></figure>

<p>为<code>make()</code>提供容量信息（hint）尝试在初始化时调整map大小，这减少了在将元素添加到map时增长和分配的开销（<strong>想想这是为什么，不懂去看看map的resize算法你就明白了</strong>）。注意，map不能保证分配hint个容量。因此，即使提供了容量，添加元素仍然可以进行分配</p>
<h4 id="反例-22"><a href="#反例-22" class="headerlink" title="反例"></a>反例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">m := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]os.FileInfo)</span><br><span class="line"></span><br><span class="line">files, _ := ioutil.ReadDir(<span class="string">"./files"</span>)</span><br><span class="line"><span class="keyword">for</span> _, f := <span class="keyword">range</span> files {</span><br><span class="line">    m[f.Name()] = f</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// `m`是在没有大小提示的情况下创建的； 在运行时可能会有更多分配</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="正例-22"><a href="#正例-22" class="headerlink" title="正例"></a>正例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">files, _ := ioutil.ReadDir(<span class="string">"./files"</span>)</span><br><span class="line"></span><br><span class="line">m := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]os.FileInfo, <span class="built_in">len</span>(files))</span><br><span class="line"><span class="keyword">for</span> _, f := <span class="keyword">range</span> files {</span><br><span class="line">    m[f.Name()] = f</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// `m`是有大小提示创建的；在运行时可能会有更少的分配</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="规范"><a href="#规范" class="headerlink" title="规范"></a>规范</h2><h3 id="项目命名规范"><a href="#项目命名规范" class="headerlink" title="项目命名规范"></a>项目命名规范</h3><p>参考各个开源项目（<code>spring</code>、<code>apache</code>以及<code>google</code>）的命名规范</p>
<ul>
<li>项目名称使用使用小写字母</li>
<li>单词之间使用中划线<code>-</code>连接</li>
</ul>
<h3 id="源码文件规范"><a href="#源码文件规范" class="headerlink" title="源码文件规范"></a>源码文件规范</h3><p>对于源码文件，有如下参考</p>
<ul>
<li>全部使用小写字符</li>
<li>使用下划线<code>_</code>来连接各个单词</li>
<li><strong>每个源文件末尾留出一空白行</strong>（原因是在Linux/Unix等文本环境下可以很方便的跳到文件的末尾）</li>
</ul>
<p>源代码文件名<br>文件名称只是约定描述性的,并无任何编程含义</p>
<h3 id="合理使用空格"><a href="#合理使用空格" class="headerlink" title="合理使用空格"></a>合理使用空格</h3><p>合理的使用空格，能使代码更具有阅读性</p>
<ul>
<li>关键字后加空格</li>
<li>,号之后加空格</li>
<li>)和{之间加空格</li>
<li>注释//后加空格</li>
<li>=号两边加空格</li>
</ul>
<h3 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h3><p>注释能增强代码的可读性</p>
<ul>
<li><strong>禁止使用蹩脚英文注释</strong></li>
<li>不要为了注释而注释</li>
</ul>
<h4 id="反例-23"><a href="#反例-23" class="headerlink" title="反例"></a>反例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// call 这是方法调用</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">call</span><span class="params">()</span></span> {</span><br><span class="line">    fmt.Println(<span class="string">"call"</span>)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="正例-23"><a href="#正例-23" class="headerlink" title="正例"></a>正例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Upload 文件上传</span></span><br><span class="line"><span class="comment">// id 文件编号</span></span><br><span class="line"><span class="comment">// uploadType 上传类型</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Upload</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    id <span class="keyword">int64</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    uploadType UploadType,</span></span></span><br><span class="line"><span class="function"><span class="params">    key <span class="keyword">string</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    filename <span class="keyword">string</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    outputFilename <span class="keyword">string</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    name <span class="keyword">string</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">)</span> <span class="params">(err error)</span></span> {</span><br><span class="line">    log.WithFields(log.Fields{</span><br><span class="line">        <span class="string">"id"</span>:             id,</span><br><span class="line">        <span class="string">"filename"</span>:       filename,</span><br><span class="line">        <span class="string">"outputFilename"</span>: outputFilename,</span><br><span class="line">        <span class="string">"uploadType"</span>:     uploadType,</span><br><span class="line">        <span class="string">"key"</span>:            key,</span><br><span class="line">        <span class="string">"name"</span>:           name,</span><br><span class="line">    }).Info(<span class="string">"开始上传文件"</span>)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>注意空格<h4 id="反例-24"><a href="#反例-24" class="headerlink" title="反例"></a>反例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//GET方法</span></span><br><span class="line"><span class="keyword">const</span> MethodGET = <span class="string">"GET"</span></span><br></pre></td></tr></tbody></table></figure>

</li>
</ul>
<h4 id="正例-24"><a href="#正例-24" class="headerlink" title="正例"></a>正例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GET方法</span></span><br><span class="line"><span class="keyword">const</span> MethodGET = <span class="string">"GET"</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>Public（公开）的方法必须添加注释</li>
</ul>
<h3 id="变量名"><a href="#变量名" class="headerlink" title="变量名"></a>变量名</h3><p>给常量变量命名时，遵循以下原则</p>
<ul>
<li>使用驼峰命名</li>
<li>力求准确表达出变量的意思，<strong>不能使用无行业经验的单个字母命名的变量</strong></li>
<li>对于约定俗成的常量或者变量名，可以全部大写，比如GET、PUT、DELETE等</li>
<li>不能使用特殊符号如$、_等</li>
</ul>
<h4 id="反例-25"><a href="#反例-25" class="headerlink" title="反例"></a>反例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> a = <span class="string">"a"</span></span><br><span class="line"><span class="keyword">var</span>   b = <span class="string">"b"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> a_b = <span class="string">"a_b"</span></span><br><span class="line"><span class="keyword">var</span>   c_d = <span class="string">"c_d"</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="正例-25"><a href="#正例-25" class="headerlink" title="正例"></a>正例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> MethodGET   = <span class="string">"GET"</span></span><br><span class="line"><span class="keyword">var</span>   StudentName = <span class="string">"PUT"</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="包名"><a href="#包名" class="headerlink" title="包名"></a>包名</h3><p>当命名包时，请按下面规则选择一个名称</p>
<ul>
<li>全部小写，没有大写或下划线</li>
<li>大多数使用命名导入的情况下，不需要重命名</li>
<li>简短而简洁，请记住，在每个使用的地方都完整标识了该名称</li>
<li>不用复数，例如<code>net/url</code>，而不是<code>net/urls</code></li>
<li>不要用<code>common</code>、<code>util</code>、<code>shared</code>以及<code>lib</code>，这些是不好的，信息量不足的名称</li>
</ul>
<p>另请参阅[Package Names]和[Go 包样式指南]<br>  [Package Names]: <a target="_blank" rel="noopener" href="https://blog.golang.org/package-names">https://blog.golang.org/package-names</a><br>  [Go 包样式指南]: <a target="_blank" rel="noopener" href="https://rakyll.org/style-packages/">https://rakyll.org/style-packages/</a></p>
<h3 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h3><p>我们遵循Go社区关于使用[MixedCaps作为方法名]的约定。有一个例外，为了对相关的测试用例进行分组，函数名可能包含下划线，如：<code>TestMyFunction_WhatIsBeingTested</code><br>  [MixedCaps作为方法名]: <a target="_blank" rel="noopener" href="https://golang.org/doc/effective_go.html#mixed-caps">https://golang.org/doc/effective_go.html#mixed-caps</a></p>
<p>除此之外，方法还有如下限制</p>
<ul>
<li>方法体不能超过80行，如果超过需重构</li>
<li>和常量变量命名一致，不要图简单使用完全不相关的方法名(最极端的例子是方法名如<code>a</code> <code>b</code> <code>c</code>等)</li>
</ul>
<h4 id="反例-26"><a href="#反例-26" class="headerlink" title="反例"></a>反例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">f</span><span class="params">()</span></span> {</span><br><span class="line"><span class="comment">// 靠，f是干嘛的，鬼才知道</span></span><br><span class="line"><span class="comment">// 如果你的方法体过长，比如某公司一个方法6000多行代码，是的，你没看错，一个方法6000多行，而且还是知名公司</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="正例-26"><a href="#正例-26" class="headerlink" title="正例"></a>正例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">uploadFile</span><span class="params">()</span></span> {</span><br><span class="line"><span class="comment">// 一看就知道是上传文件的方法</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="换行"><a href="#换行" class="headerlink" title="换行"></a>换行</h3><h4 id="代码每行不超过140个字符（参看IDE里那根竖线，代码字符超过就要换行）"><a href="#代码每行不超过140个字符（参看IDE里那根竖线，代码字符超过就要换行）" class="headerlink" title="代码每行不超过140个字符（参看IDE里那根竖线，代码字符超过就要换行）"></a>代码每行不超过140个字符（参看IDE里那根竖线，代码字符超过就要换行）</h4><h5 id="反例-27"><a href="#反例-27" class="headerlink" title="反例"></a>反例</h5><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 方法签名超过了IDE的竖线，阅读代码时需使用滚动条</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">upload</span><span class="params">(id <span class="keyword">int64</span>, uploadType UploadType, key <span class="keyword">string</span>, filename <span class="keyword">string</span>, outputFilename <span class="keyword">string</span>, name <span class="keyword">string</span>)</span> <span class="params">(err error)</span></span> {</span><br><span class="line">  log.WithFields(log.Fields{</span><br><span class="line">    <span class="string">"id"</span>:             id,</span><br><span class="line">    <span class="string">"filename"</span>:       filename,</span><br><span class="line">    <span class="string">"outputFilename"</span>: outputFilename,</span><br><span class="line">    <span class="string">"uploadType"</span>:     uploadType,</span><br><span class="line">    <span class="string">"key"</span>:            key,</span><br><span class="line">    <span class="string">"name"</span>:           name,</span><br><span class="line">  }).Info(<span class="string">"开始上传文件"</span>)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5 id="正例-27"><a href="#正例-27" class="headerlink" title="正例"></a>正例</h5><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 尽量保持一行一个参数，原因是可以很方便的对参数进行详细解释（如果有必要的话）</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">upload</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  id <span class="keyword">int64</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  uploadType UploadType,</span></span></span><br><span class="line"><span class="function"><span class="params">  key <span class="keyword">string</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  filename <span class="keyword">string</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  outputFilename <span class="keyword">string</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  name <span class="keyword">string</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">)</span> <span class="params">(err error)</span></span> {</span><br><span class="line">  <span class="comment">// 方法调用也适用于换行</span></span><br><span class="line">  log.WithFields(log.Fields{</span><br><span class="line">    <span class="string">"id"</span>:             id,</span><br><span class="line">    <span class="string">"filename"</span>:       filename,</span><br><span class="line">    <span class="string">"outputFilename"</span>: outputFilename,</span><br><span class="line">    <span class="string">"uploadType"</span>:     uploadType,</span><br><span class="line">    <span class="string">"key"</span>:            key,</span><br><span class="line">    <span class="string">"name"</span>:           name,</span><br><span class="line">  }).Info(<span class="string">"开始上传文件"</span>)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>注意：如果意义相近，可以将实参或者形参放在一起成对出现（参看<a href="#%E5%86%99%E5%87%BA%E5%A5%BD%E4%BB%A3%E7%A0%81%E7%9A%84%E5%9F%BA%E6%9C%AC%E5%8E%9F%E5%88%99">写出好代码的基本原则</a>里面的代码要有段落感）</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">callMethod</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  username <span class="keyword">string</span>, password <span class="keyword">string</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  year <span class="keyword">int</span>, month <span class="keyword">int</span>, day <span class="keyword">int</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  hour <span class="keyword">int</span>, min <span class="keyword">int</span>, seconds <span class="keyword">int</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span> {</span><br><span class="line">  fmt.Println(<span class="string">"test"</span>)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">callMethod(</span><br><span class="line">  user.Username, user.Password, <span class="comment">// 用户名和密码意义相近，阅读代码的人一看就知道上下文</span></span><br><span class="line">  year, month, day, <span class="comment">// 月、日、年基本上一起出现</span></span><br><span class="line">  hour, min, seconds, <span class="comment">// 时、分、秒一样，基本上一起出现</span></span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure>

<h4 id="return之前加空行"><a href="#return之前加空行" class="headerlink" title="return之前加空行"></a>return之前加空行</h4><h5 id="反例-28"><a href="#反例-28" class="headerlink" title="反例"></a>反例</h5><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> client, success, err = cr.GetById(id); <span class="literal">nil</span> != err {</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">}</span><br><span class="line"><span class="keyword">if</span> !success {</span><br><span class="line">    err = model.ErrObjectNotExist</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5 id="正例-28"><a href="#正例-28" class="headerlink" title="正例"></a>正例</h5><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> client, success, err = cr.GetById(id); <span class="literal">nil</span> != err {</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">}</span><br><span class="line"><span class="keyword">if</span> !success {</span><br><span class="line">    err = model.ErrObjectNotExist</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加空行，保证代码逻辑清晰</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="导入别名"><a href="#导入别名" class="headerlink" title="导入别名"></a>导入别名</h3><p>如果程序包名称与导入路径的最后一个元素不匹配，则必须使用导入别名</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">"net/http"</span></span><br><span class="line"></span><br><span class="line">  client <span class="string">"example.com/client-go"</span></span><br><span class="line">  trace <span class="string">"example.com/trace/v2"</span></span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure>

<p>在所有其他情况下，除非导入之间有直接冲突，否则<strong>应避免导入别名</strong></p>
<h4 id="反例-29"><a href="#反例-29" class="headerlink" title="反例"></a>反例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">"fmt"</span></span><br><span class="line">  <span class="string">"os"</span></span><br><span class="line"></span><br><span class="line">  nettrace <span class="string">"golang.net/x/trace"</span></span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure>

<h4 id="正例-29"><a href="#正例-29" class="headerlink" title="正例"></a>正例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">"fmt"</span></span><br><span class="line">  <span class="string">"os"</span></span><br><span class="line">  <span class="string">"runtime/trace"</span></span><br><span class="line"></span><br><span class="line">  nettrace <span class="string">"golang.net/x/trace"</span></span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure>

<h3 id="相似的声明放在一组"><a href="#相似的声明放在一组" class="headerlink" title="相似的声明放在一组"></a>相似的声明放在一组</h3><p>Go 语言支持将相似的声明放在一个组内</p>
<h4 id="反例-30"><a href="#反例-30" class="headerlink" title="反例"></a>反例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">"a"</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">"b"</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="正例-30"><a href="#正例-30" class="headerlink" title="正例"></a>正例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">"a"</span></span><br><span class="line">  <span class="string">"b"</span></span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure>

<p>这同样适用于常量、变量和类型声明</p>
<h4 id="反例-31"><a href="#反例-31" class="headerlink" title="反例"></a>反例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">const</span> a = <span class="number">1</span></span><br><span class="line"><span class="keyword">const</span> b = <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> a = <span class="number">1</span></span><br><span class="line"><span class="keyword">var</span> b = <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Area <span class="keyword">float64</span></span><br><span class="line"><span class="keyword">type</span> Volume <span class="keyword">float64</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="正例-31"><a href="#正例-31" class="headerlink" title="正例"></a>正例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line">  a = <span class="number">1</span></span><br><span class="line">  b = <span class="number">2</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">  a = <span class="number">1</span></span><br><span class="line">  b = <span class="number">2</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> (</span><br><span class="line">  Area <span class="keyword">float64</span></span><br><span class="line">  Volume <span class="keyword">float64</span></span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure>

<p>仅将相关的声明放在一组。<strong>不要将不相关的声明放在一组</strong></p>
<h4 id="反例-32"><a href="#反例-32" class="headerlink" title="反例"></a>反例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Operation <span class="keyword">int</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">  Add Operation = <span class="literal">iota</span> + <span class="number">1</span></span><br><span class="line">  Subtract</span><br><span class="line">  Multiply</span><br><span class="line">  ENV_VAR = <span class="string">"MY_ENV"</span></span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure>

<h4 id="正例-32"><a href="#正例-32" class="headerlink" title="正例"></a>正例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Operation <span class="keyword">int</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">  Add Operation = <span class="literal">iota</span> + <span class="number">1</span></span><br><span class="line">  Subtract</span><br><span class="line">  Multiply</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ENV_VAR = <span class="string">"MY_ENV"</span></span><br></pre></td></tr></tbody></table></figure>


<p><strong>分组使用的位置没有限制</strong>，例如：你可以在函数内部使用它们</p>
<h4 id="反例-33"><a href="#反例-33" class="headerlink" title="反例"></a>反例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">f</span><span class="params">()</span> <span class="title">string</span></span> {</span><br><span class="line">  <span class="keyword">var</span> red = color.New(<span class="number">0xff0000</span>)</span><br><span class="line">  <span class="keyword">var</span> green = color.New(<span class="number">0x00ff00</span>)</span><br><span class="line">  <span class="keyword">var</span> blue = color.New(<span class="number">0x0000ff</span>)</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="正例-33"><a href="#正例-33" class="headerlink" title="正例"></a>正例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">f</span><span class="params">()</span> <span class="title">string</span></span> {</span><br><span class="line">  <span class="keyword">var</span> (</span><br><span class="line">    red   = color.New(<span class="number">0xff0000</span>)</span><br><span class="line">    green = color.New(<span class="number">0x00ff00</span>)</span><br><span class="line">    blue  = color.New(<span class="number">0x0000ff</span>)</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="导入分组"><a href="#导入分组" class="headerlink" title="导入分组"></a>导入分组</h3><p>导入应该分为两组</p>
<ul>
<li>标准库</li>
<li>其他库</li>
</ul>
<p>默认情况下，这是goimports应用的分组</p>
<h4 id="反例-34"><a href="#反例-34" class="headerlink" title="反例"></a>反例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">"fmt"</span></span><br><span class="line">  <span class="string">"os"</span></span><br><span class="line">  <span class="string">"go.uber.org/atomic"</span></span><br><span class="line">  <span class="string">"golang.org/x/sync/errgroup"</span></span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure>

<h4 id="正例-34"><a href="#正例-34" class="headerlink" title="正例"></a>正例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">`fmt`</span></span><br><span class="line">  <span class="string">`os`</span></span><br><span class="line"></span><br><span class="line">  <span class="string">`go.uber.org/atomic`</span></span><br><span class="line">  <span class="string">`golang.org/x/sync/errgroup`</span></span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure>

<p>注意：<strong>import语句使用``代替””</strong></p>
<h3 id="函数分组与顺序"><a href="#函数分组与顺序" class="headerlink" title="函数分组与顺序"></a>函数分组与顺序</h3><p>分组和顺序主要影响代码的逻辑性</p>
<ul>
<li>函数应按粗略的调用顺序排序</li>
<li>同一文件中的函数应按接收者分组</li>
<li>导出的函数应先出现在文件中，放在<code>struct</code>, <code>const</code>, <code>var</code>定义的后面</li>
<li>在定义类型之后，但在接收者的其余方法之前，可能会出现一个<code>newXYZ()</code>/<code>NewXYZ()</code></li>
<li>由于函数是按接收者分组的，因此普通工具函数应在文件末尾出现</li>
<li><strong>简单而有效的办法是，将这些交给IDE去完成（详见IDE的相关配置）</strong></li>
</ul>
<h4 id="反例-35"><a href="#反例-35" class="headerlink" title="反例"></a>反例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *something)</span> <span class="title">Cost</span><span class="params">()</span></span> {</span><br><span class="line">  <span class="keyword">return</span> calcCost(s.weights)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> something <span class="keyword">struct</span>{ ... }</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">calcCost</span><span class="params">(n []<span class="keyword">int</span>)</span> <span class="title">int</span></span> {...}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *something)</span> <span class="title">Stop</span><span class="params">()</span></span> {...}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newSomething</span><span class="params">()</span> *<span class="title">something</span></span> {</span><br><span class="line">    <span class="keyword">return</span> &amp;something{}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="正例-35"><a href="#正例-35" class="headerlink" title="正例"></a>正例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> something <span class="keyword">struct</span>{ ... }</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newSomething</span><span class="params">()</span> *<span class="title">something</span></span> {</span><br><span class="line">    <span class="keyword">return</span> &amp;something{}</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *something)</span> <span class="title">Cost</span><span class="params">()</span></span> {</span><br><span class="line">  <span class="keyword">return</span> calcCost(s.weights)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *something)</span> <span class="title">Stop</span><span class="params">()</span></span> {...}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">calcCost</span><span class="params">(n []<span class="keyword">int</span>)</span> <span class="title">int</span></span> {...}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="减少嵌套"><a href="#减少嵌套" class="headerlink" title="减少嵌套"></a>减少嵌套</h3><p>代码应通过尽可能先处理错误情况/特殊情况并尽早返回或继续循环来减少嵌套。减少嵌套多个级别的代码的代码量</p>
<h4 id="反例-36"><a href="#反例-36" class="headerlink" title="反例"></a>反例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> _, v := <span class="keyword">range</span> data {</span><br><span class="line">  <span class="keyword">if</span> v.F1 == <span class="number">1</span> {</span><br><span class="line">    v = process(v)</span><br><span class="line">    <span class="keyword">if</span> err := v.Call(); err == <span class="literal">nil</span> {</span><br><span class="line">      v.Send()</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">      <span class="keyword">return</span> err</span><br><span class="line">    }</span><br><span class="line">  } <span class="keyword">else</span> {</span><br><span class="line">    log.Printf(<span class="string">"Invalid v: %v"</span>, v)</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="正例-36"><a href="#正例-36" class="headerlink" title="正例"></a>正例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> _, v := <span class="keyword">range</span> data {</span><br><span class="line">  <span class="keyword">if</span> v.F1 != <span class="number">1</span> {</span><br><span class="line">    log.Printf(<span class="string">"Invalid v: %v"</span>, v)</span><br><span class="line">    <span class="keyword">continue</span></span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  v = process(v)</span><br><span class="line">  <span class="keyword">if</span> err := v.Call(); err != <span class="literal">nil</span> {</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">  }</span><br><span class="line">  v.Send()</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="不必要的else"><a href="#不必要的else" class="headerlink" title="不必要的else"></a>不必要的else</h3><p>如果在if的两个分支中都设置了变量，则可以将其替换为单个if</p>
<h4 id="反例-37"><a href="#反例-37" class="headerlink" title="反例"></a>反例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a <span class="keyword">int</span></span><br><span class="line"><span class="keyword">if</span> b {</span><br><span class="line">  a = <span class="number">100</span></span><br><span class="line">} <span class="keyword">else</span> {</span><br><span class="line">  a = <span class="number">10</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="正例-37"><a href="#正例-37" class="headerlink" title="正例"></a>正例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a := <span class="number">10</span></span><br><span class="line"><span class="keyword">if</span> b {</span><br><span class="line">  a = <span class="number">100</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="顶层变量声明"><a href="#顶层变量声明" class="headerlink" title="顶层变量声明"></a>顶层变量声明</h3><p>在顶层，使用标准<code>var</code>关键字。请勿指定类型，除非它与表达式的类型不同</p>
<h4 id="反例-38"><a href="#反例-38" class="headerlink" title="反例"></a>反例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> _s <span class="keyword">string</span> = F()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">F</span><span class="params">()</span> <span class="title">string</span></span> { <span class="keyword">return</span> <span class="string">"A"</span> }</span><br></pre></td></tr></tbody></table></figure>

<h4 id="正例-38"><a href="#正例-38" class="headerlink" title="正例"></a>正例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> _s = F()</span><br><span class="line"><span class="comment">// 由于F已经明确了返回一个字符串类型，因此我们没有必要显式指定_s的类型</span></span><br><span class="line"><span class="comment">// 还是那种类型</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">F</span><span class="params">()</span> <span class="title">string</span></span> { <span class="keyword">return</span> <span class="string">"A"</span> }</span><br></pre></td></tr></tbody></table></figure>

<p>如果表达式的类型与所需的类型不完全匹配，请指定类型</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> myError <span class="keyword">struct</span>{}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(myError)</span> <span class="title">Error</span><span class="params">()</span> <span class="title">string</span></span> { <span class="keyword">return</span> <span class="string">"error"</span> }</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">F</span><span class="params">()</span> <span class="title">myError</span></span> { <span class="keyword">return</span> myError{} }</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> _e error = F()</span><br><span class="line"><span class="comment">// F返回一个myError类型的实例，但是我们要error类型</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="对于未导出的顶层常量和变量，使用-作为前缀"><a href="#对于未导出的顶层常量和变量，使用-作为前缀" class="headerlink" title="对于未导出的顶层常量和变量，使用_作为前缀"></a>对于未导出的顶层常量和变量，使用_作为前缀</h3><p>在未导出的顶级<code>vars</code>和<code>consts</code>， 前面加上前缀_，以使它们在使用时明确表示它们是全局符号。例外：未导出的错误值，应以<code>err</code>开头。基本依据：顶级变量和常量具有包范围作用域，使用通用名称可能很容易在其他文件中意外使用错误的值</p>
<h4 id="反例-39"><a href="#反例-39" class="headerlink" title="反例"></a>反例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// foo.go</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">  defaultPort = <span class="number">8080</span></span><br><span class="line">  defaultUser = <span class="string">"user"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// bar.go</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Bar</span><span class="params">()</span></span> {</span><br><span class="line">  defaultPort := <span class="number">9090</span></span><br><span class="line">  ...</span><br><span class="line">  fmt.Println(<span class="string">"Default port"</span>, defaultPort)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// We will not see a compile error if the first line of</span></span><br><span class="line">  <span class="comment">// Bar() is deleted.</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="正例-39"><a href="#正例-39" class="headerlink" title="正例"></a>正例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// foo.go</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">  _defaultPort = <span class="number">8080</span></span><br><span class="line">  _defaultUser = <span class="string">"user"</span></span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure>

<h3 id="结构体中的嵌入"><a href="#结构体中的嵌入" class="headerlink" title="结构体中的嵌入"></a>结构体中的嵌入</h3><p>嵌入式类型（例如mutex）应位于结构体内的字段列表的顶部，并且必须有一个空行将嵌入式字段与常规字段分隔开（<strong>想想基本原则里面的代码要有段落感</strong>）</p>
<h4 id="反例-40"><a href="#反例-40" class="headerlink" title="反例"></a>反例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Client <span class="keyword">struct</span> {</span><br><span class="line">  version <span class="keyword">int</span></span><br><span class="line">  http.Client</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="正例-40"><a href="#正例-40" class="headerlink" title="正例"></a>正例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Client <span class="keyword">struct</span> {</span><br><span class="line">  http.Client</span><br><span class="line"></span><br><span class="line">  version <span class="keyword">int</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="使用字段名初始化结构体"><a href="#使用字段名初始化结构体" class="headerlink" title="使用字段名初始化结构体"></a>使用字段名初始化结构体</h3><p>初始化结构体时，几乎始终应该指定字段名称。现在由<a target="_blank" rel="noopener" href="https://golang.org/cmd/vet/"><code>go vet</code></a>强制执行</p>
<h4 id="反例-41"><a href="#反例-41" class="headerlink" title="反例"></a>反例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">k := User{<span class="string">"John"</span>, <span class="string">"Doe"</span>, <span class="literal">true</span>}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="正例-41"><a href="#正例-41" class="headerlink" title="正例"></a>正例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">k := User{</span><br><span class="line">    FirstName: <span class="string">"John"</span>,</span><br><span class="line">    LastName: <span class="string">"Doe"</span>,</span><br><span class="line">    Admin: <span class="literal">true</span>,</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>例外：如果有3个或更少的字段，则可以在测试表中省略字段名称</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">tests := []<span class="keyword">struct</span>{</span><br><span class="line">  op Operation</span><br><span class="line">  want <span class="keyword">string</span></span><br><span class="line">}{</span><br><span class="line">  {Add, <span class="string">"add"</span>},</span><br><span class="line">  {Subtract, <span class="string">"subtract"</span>},</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="本地变量声明"><a href="#本地变量声明" class="headerlink" title="本地变量声明"></a>本地变量声明</h3><p>如果将变量明确设置为某个值，则应使用短变量声明形式 (<code>:=</code>)</p>
<h4 id="反例-42"><a href="#反例-42" class="headerlink" title="反例"></a>反例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> s = <span class="string">"foo"</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="正例-42"><a href="#正例-42" class="headerlink" title="正例"></a>正例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">s := <span class="string">"foo"</span></span><br></pre></td></tr></tbody></table></figure>

<p>但是，在某些情况下，<code>var</code> 使用关键字时默认值会更清晰。例如，声明空切片</p>
<h4 id="反例-43"><a href="#反例-43" class="headerlink" title="反例"></a>反例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">f</span><span class="params">(list []<span class="keyword">int</span>)</span></span> {</span><br><span class="line">  filtered := []<span class="keyword">int</span>{}</span><br><span class="line">  <span class="keyword">for</span> _, v := <span class="keyword">range</span> list {</span><br><span class="line">    <span class="keyword">if</span> v &gt; <span class="number">10</span> {</span><br><span class="line">      filtered = <span class="built_in">append</span>(filtered, v)</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="正例-43"><a href="#正例-43" class="headerlink" title="正例"></a>正例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">f</span><span class="params">(list []<span class="keyword">int</span>)</span></span> {</span><br><span class="line">  <span class="keyword">var</span> filtered []<span class="keyword">int</span></span><br><span class="line">  <span class="keyword">for</span> _, v := <span class="keyword">range</span> list {</span><br><span class="line">    <span class="keyword">if</span> v &gt; <span class="number">10</span> {</span><br><span class="line">      filtered = <span class="built_in">append</span>(filtered, v)</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="nil是一个有效的slice"><a href="#nil是一个有效的slice" class="headerlink" title="nil是一个有效的slice"></a>nil是一个有效的slice</h3><p><code>nil</code>是一个有效的长度为0的 slice，这意味着</p>
<ul>
<li><p>您不应明确返回长度为零的切片。应该返回<code>nil</code>来代替</p>
<h4 id="反例-44"><a href="#反例-44" class="headerlink" title="反例"></a>反例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> x == <span class="string">""</span> {</span><br><span class="line">  <span class="keyword">return</span> []<span class="keyword">int</span>{}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="正例-44"><a href="#正例-44" class="headerlink" title="正例"></a>正例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> x == <span class="string">""</span> {</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>要检查切片是否为空，请始终使用<code>len(s) == 0</code>而非 <code>nil</code></p>
<h4 id="反例-45"><a href="#反例-45" class="headerlink" title="反例"></a>反例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">isEmpty</span><span class="params">(s []<span class="keyword">string</span>)</span> <span class="title">bool</span></span> {</span><br><span class="line">  <span class="keyword">return</span> s == <span class="literal">nil</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="正例-45"><a href="#正例-45" class="headerlink" title="正例"></a>正例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">isEmpty</span><span class="params">(s []<span class="keyword">string</span>)</span> <span class="title">bool</span></span> {</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">len</span>(s) == <span class="number">0</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>零值切片（用<code>var</code>声明的切片）可立即使用，无需调用<code>make()</code>创建</p>
<h4 id="反例-46"><a href="#反例-46" class="headerlink" title="反例"></a>反例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">nums := []<span class="keyword">int</span>{}</span><br><span class="line"><span class="comment">// or, nums := make([]int)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> add1 {</span><br><span class="line">  nums = <span class="built_in">append</span>(nums, <span class="number">1</span>)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> add2 {</span><br><span class="line">  nums = <span class="built_in">append</span>(nums, <span class="number">2</span>)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="正例-46"><a href="#正例-46" class="headerlink" title="正例"></a>正例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> nums []<span class="keyword">int</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> add1 {</span><br><span class="line">  nums = <span class="built_in">append</span>(nums, <span class="number">1</span>)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> add2 {</span><br><span class="line">  nums = <span class="built_in">append</span>(nums, <span class="number">2</span>)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

</li>
</ul>
<h3 id="小变量作用域"><a href="#小变量作用域" class="headerlink" title="小变量作用域"></a>小变量作用域</h3><p>如果有可能，尽量缩小变量作用范围。除非它与 <a href="#%E5%87%8F%E5%B0%91%E5%B5%8C%E5%A5%97">减少嵌套</a>的规则冲突</p>
<h4 id="反例-47"><a href="#反例-47" class="headerlink" title="反例"></a>反例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">err := ioutil.WriteFile(name, data, <span class="number">0644</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line"> <span class="keyword">return</span> err</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="正例-47"><a href="#正例-47" class="headerlink" title="正例"></a>正例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> err := ioutil.WriteFile(name, data, <span class="number">0644</span>); err != <span class="literal">nil</span> {</span><br><span class="line"> <span class="keyword">return</span> err</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>如果需要在if之外使用函数调用的结果，则不应尝试缩小范围</p>
<h4 id="反例-48"><a href="#反例-48" class="headerlink" title="反例"></a>反例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> data, err := ioutil.ReadFile(name); err == <span class="literal">nil</span> {</span><br><span class="line">  err = cfg.Decode(data)</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  fmt.Println(cfg)</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">} <span class="keyword">else</span> {</span><br><span class="line">  <span class="keyword">return</span> err</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="正例-48"><a href="#正例-48" class="headerlink" title="正例"></a>正例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">data, err := ioutil.ReadFile(name)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">   <span class="keyword">return</span> err</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err := cfg.Decode(data); err != <span class="literal">nil</span> {</span><br><span class="line">  <span class="keyword">return</span> err</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">fmt.Println(cfg)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="避免参数语义不明确"><a href="#避免参数语义不明确" class="headerlink" title="避免参数语义不明确"></a>避免参数语义不明确</h3><p>函数调用中的<code>意义不明确的参数</code>可能会损害可读性。当参数名称的含义不明显时，请为参数添加 C 样式注释 (<code>/* ... */</code>)</p>
<h4 id="反例-49"><a href="#反例-49" class="headerlink" title="反例"></a>反例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// func printInfo(name string, isLocal, done bool)</span></span><br><span class="line"></span><br><span class="line">printInfo(<span class="string">"foo"</span>, <span class="literal">true</span>, <span class="literal">true</span>)</span><br></pre></td></tr></tbody></table></figure>

<h4 id="正例-49"><a href="#正例-49" class="headerlink" title="正例"></a>正例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// func printInfo(name string, isLocal, done bool)</span></span><br><span class="line"></span><br><span class="line">printInfo(<span class="string">"foo"</span>, <span class="literal">true</span> <span class="comment">/* isLocal */</span>, <span class="literal">true</span> <span class="comment">/* done */</span>)</span><br></pre></td></tr></tbody></table></figure>

<p>对于上面的示例代码，还有一种更好的处理方式是将上面的<code>bool</code>类型换成自定义类型。将来，该参数可以支持不仅仅局限于两个状态（true/false）</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Region <span class="keyword">int</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">  UnknownRegion Region = <span class="literal">iota</span></span><br><span class="line">  Local</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Status <span class="keyword">int</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">  StatusReady Status= <span class="literal">iota</span> + <span class="number">1</span></span><br><span class="line">  StatusDone</span><br><span class="line">  <span class="comment">// Maybe we will have a StatusInProgress in the future.</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">printInfo</span><span class="params">(name <span class="keyword">string</span>, region Region, status Status)</span></span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="使用原始字符串字面值，避免转义"><a href="#使用原始字符串字面值，避免转义" class="headerlink" title="使用原始字符串字面值，避免转义"></a>使用原始字符串字面值，避免转义</h3><p>Go 支持使用 <a target="_blank" rel="noopener" href="https://golang.org/ref/spec#raw_string_lit">原始字符串字面值</a>，也就是” ` “来表示原生字符串，在需要转义的场景下，我们应该尽量使用这种方案来替换，可以跨越多行并包含引号。使用这些字符串可以避免更难阅读的手工转义的字符串</p>
<h4 id="反例-50"><a href="#反例-50" class="headerlink" title="反例"></a>反例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wantError := <span class="string">"unknown name:\"test\""</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="正例-50"><a href="#正例-50" class="headerlink" title="正例"></a>正例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wantError := <span class="string">`unknown error:"test"`</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="初始化Struct引用"><a href="#初始化Struct引用" class="headerlink" title="初始化Struct引用"></a>初始化Struct引用</h3><p>在初始化结构引用时，请使用<code>&amp;T{}</code>代替<code>new(T)</code>，以使其与结构体初始化一致</p>
<h4 id="反例-51"><a href="#反例-51" class="headerlink" title="反例"></a>反例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sval := T{Name: <span class="string">"foo"</span>}</span><br><span class="line"></span><br><span class="line">sptr := <span class="built_in">new</span>(T)</span><br><span class="line">sptr.Name = <span class="string">"bar"</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="正例-51"><a href="#正例-51" class="headerlink" title="正例"></a>正例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sval := T{Name: <span class="string">"foo"</span>}</span><br><span class="line"></span><br><span class="line">sptr := &amp;T{Name: <span class="string">"bar"</span>}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="初始化Maps"><a href="#初始化Maps" class="headerlink" title="初始化Maps"></a>初始化Maps</h3><p>对于空map请使用 <code>make(..)</code> 初始化， 并且map是通过编程方式填充的，这使得map初始化在表现上不同于声明，并且它还可以方便地在make后添加大小提示。</p>
<h4 id="反例-52"><a href="#反例-52" class="headerlink" title="反例"></a>反例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> (</span><br><span class="line">  <span class="comment">// m1 读写安全;</span></span><br><span class="line">  <span class="comment">// m2 在写入时会panic</span></span><br><span class="line">  m1 = <span class="keyword">map</span>[T1]T2{}</span><br><span class="line">  m2 <span class="keyword">map</span>[T1]T2</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 声明和初始化看起来非常相似的</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="正例-52"><a href="#正例-52" class="headerlink" title="正例"></a>正例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> (</span><br><span class="line">  <span class="comment">// m1 读写安全</span></span><br><span class="line">  <span class="comment">// m2 在写入时会panic</span></span><br><span class="line">  m1 = <span class="built_in">make</span>(<span class="keyword">map</span>[T1]T2)</span><br><span class="line">  m2 <span class="keyword">map</span>[T1]T2</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 声明和初始化看起来差别非常大</span></span><br></pre></td></tr></tbody></table></figure>

<p>在尽可能的情况下，请在初始化时提供map容量大小，详细请看 <a href="#%E5%B0%BD%E9%87%8F%E5%88%9D%E5%A7%8B%E5%8C%96%E6%97%B6%E6%8C%87%E5%AE%9A-Map-%E5%AE%B9%E9%87%8F">尽量初始化时指定 Map 容量</a>，另外，如果map包含固定的元素列表，则使用map literals(map 初始化列表) 初始化映射</p>
<h4 id="反例-53"><a href="#反例-53" class="headerlink" title="反例"></a>反例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">m := <span class="built_in">make</span>(<span class="keyword">map</span>[T1]T2, <span class="number">3</span>)</span><br><span class="line">m[k1] = v1</span><br><span class="line">m[k2] = v2</span><br><span class="line">m[k3] = v3</span><br></pre></td></tr></tbody></table></figure>

<h4 id="正例-53"><a href="#正例-53" class="headerlink" title="正例"></a>正例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">m := <span class="keyword">map</span>[T1]T2{</span><br><span class="line">  k1: v1,</span><br><span class="line">  k2: v2,</span><br><span class="line">  k3: v3,</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>基本准则是：在初始化时使用map初始化列表来添加一组固定的元素。否则使用<code>make</code>(如果可以，请尽量指定 map 容量)</p>
<h3 id="字符串格式化"><a href="#字符串格式化" class="headerlink" title="字符串格式化"></a>字符串格式化</h3><p>如果你在函数外声明<code>Printf</code>函数的格式字符串，请将其设置为<code>const</code>常量。这有助于<code>go vet</code>对格式字符串执行静态分析</p>
<h4 id="反例-54"><a href="#反例-54" class="headerlink" title="反例"></a>反例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">msg := <span class="string">"unexpected values %v, %v\n"</span></span><br><span class="line">fmt.Printf(msg, <span class="number">1</span>, <span class="number">2</span>)</span><br></pre></td></tr></tbody></table></figure>

<h4 id="正例-54"><a href="#正例-54" class="headerlink" title="正例"></a>正例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> msg = <span class="string">"unexpected values %v, %v\n"</span></span><br><span class="line">fmt.Printf(msg, <span class="number">1</span>, <span class="number">2</span>)</span><br></pre></td></tr></tbody></table></figure>

<h3 id="命名Printf样式的函数"><a href="#命名Printf样式的函数" class="headerlink" title="命名Printf样式的函数"></a>命名Printf样式的函数</h3><p>声明<code>Printf</code>函数时，请确保<code>go vet</code>可以检测到它并检查格式字符串，这意味着您应尽可能使用预定义的<code>Printf</code>函数名称。<code>go vet</code>将默认检查这些。有关更多信息，请参见<a target="_blank" rel="noopener" href="https://golang.org/cmd/vet/#hdr-Printf_family">Printf 系列</a></p>
<p>如果不能使用预定义的名称，请以f结束选择的名称：<code>Wrapf</code>，而不是<code>Wrap</code>。<code>go vet</code>可以要求检查特定的Printf样式名称，但名称必须以<code>f</code>结尾</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> go vet -printfuncs=wrapf,statusf</span></span><br></pre></td></tr></tbody></table></figure>

<p>另请参阅 <a target="_blank" rel="noopener" href="https://kuzminva.wordpress.com/2017/11/07/go-vet-printf-family-check/">go vet: Printf family check</a>.</p>
<h3 id="日志记录"><a href="#日志记录" class="headerlink" title="日志记录"></a>日志记录</h3><p>好的日志能在代码出Bug时帮助你很快的定位问题</p>
<ul>
<li><p>使用统一的日志框架记录日记，包括不限于（<code>logrus</code>、<code>zap</code>或者<code>zerolog</code>）</p>
</li>
<li><p><strong>记录日志一定要带上<code>上下文</code></strong></p>
<h4 id="反例-55"><a href="#反例-55" class="headerlink" title="反例"></a>反例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 假如代码出了Bug，除了上传这几个字外，你还能得到更有用的信息？</span></span><br><span class="line">log.Info(<span class="string">"开始上传文件"</span>)</span><br></pre></td></tr></tbody></table></figure>

<h4 id="正例-55"><a href="#正例-55" class="headerlink" title="正例"></a>正例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// 假如代码出了Bug，可以通过id, filename, uploadType, key, name等信息去Root Cause</span></span><br><span class="line"> log.WithFields(log.Fields{</span><br><span class="line">    <span class="string">"id"</span>:             id,</span><br><span class="line">    <span class="string">"filename"</span>:       filename,</span><br><span class="line">    <span class="string">"outputFilename"</span>: outputFilename,</span><br><span class="line">    <span class="string">"uploadType"</span>:     uploadType,</span><br><span class="line">    <span class="string">"key"</span>:            key,</span><br><span class="line">    <span class="string">"name"</span>:           name,</span><br><span class="line">}).Info(<span class="string">"开始上传文件"</span>)</span><br></pre></td></tr></tbody></table></figure></li>
<li><p>别把时间花在研究哪家的日志框架更好上，只要性能不是最差的就可以了。事实上，更好的办法是引入第三方的日志解决方案，程序只记录日志，日志的上传和分析交给第三方日志解决方案去处理吧</p>
</li>
<li><p>区分好日志级别(Debug, Info, Warn, Error等级别)，别乱用</p>
</li>
</ul>
<h2 id="编程模式"><a href="#编程模式" class="headerlink" title="编程模式"></a>编程模式</h2><h3 id="表驱动测试"><a href="#表驱动测试" class="headerlink" title="表驱动测试"></a>表驱动测试</h3><p>当测试逻辑是重复的时候，通过<a target="_blank" rel="noopener" href="https://blog.golang.org/subtests">subtests</a>使用table驱动的方式编写case代码看上去会更简洁</p>
<h4 id="反例-56"><a href="#反例-56" class="headerlink" title="反例"></a>反例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// func TestSplitHostPort(t *testing.T)</span></span><br><span class="line"></span><br><span class="line">host, port, err := net.SplitHostPort(<span class="string">"192.0.2.0:8000"</span>)</span><br><span class="line">require.NoError(t, err)</span><br><span class="line">assert.Equal(t, <span class="string">"192.0.2.0"</span>, host)</span><br><span class="line">assert.Equal(t, <span class="string">"8000"</span>, port)</span><br><span class="line"></span><br><span class="line">host, port, err = net.SplitHostPort(<span class="string">"192.0.2.0:http"</span>)</span><br><span class="line">require.NoError(t, err)</span><br><span class="line">assert.Equal(t, <span class="string">"192.0.2.0"</span>, host)</span><br><span class="line">assert.Equal(t, <span class="string">"http"</span>, port)</span><br><span class="line"></span><br><span class="line">host, port, err = net.SplitHostPort(<span class="string">":8000"</span>)</span><br><span class="line">require.NoError(t, err)</span><br><span class="line">assert.Equal(t, <span class="string">""</span>, host)</span><br><span class="line">assert.Equal(t, <span class="string">"8000"</span>, port)</span><br><span class="line"></span><br><span class="line">host, port, err = net.SplitHostPort(<span class="string">"1:8"</span>)</span><br><span class="line">require.NoError(t, err)</span><br><span class="line">assert.Equal(t, <span class="string">"1"</span>, host)</span><br><span class="line">assert.Equal(t, <span class="string">"8"</span>, port)</span><br></pre></td></tr></tbody></table></figure>

<h4 id="正例-56"><a href="#正例-56" class="headerlink" title="正例"></a>正例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// func TestSplitHostPort(t *testing.T)</span></span><br><span class="line"></span><br><span class="line">tests := []<span class="keyword">struct</span>{</span><br><span class="line">  give     <span class="keyword">string</span></span><br><span class="line">  wantHost <span class="keyword">string</span></span><br><span class="line">  wantPort <span class="keyword">string</span></span><br><span class="line">}{</span><br><span class="line">  {</span><br><span class="line">    give:     <span class="string">"192.0.2.0:8000"</span>,</span><br><span class="line">    wantHost: <span class="string">"192.0.2.0"</span>,</span><br><span class="line">    wantPort: <span class="string">"8000"</span>,</span><br><span class="line">  },</span><br><span class="line">  {</span><br><span class="line">    give:     <span class="string">"192.0.2.0:http"</span>,</span><br><span class="line">    wantHost: <span class="string">"192.0.2.0"</span>,</span><br><span class="line">    wantPort: <span class="string">"http"</span>,</span><br><span class="line">  },</span><br><span class="line">  {</span><br><span class="line">    give:     <span class="string">":8000"</span>,</span><br><span class="line">    wantHost: <span class="string">""</span>,</span><br><span class="line">    wantPort: <span class="string">"8000"</span>,</span><br><span class="line">  },</span><br><span class="line">  {</span><br><span class="line">    give:     <span class="string">"1:8"</span>,</span><br><span class="line">    wantHost: <span class="string">"1"</span>,</span><br><span class="line">    wantPort: <span class="string">"8"</span>,</span><br><span class="line">  },</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _, tt := <span class="keyword">range</span> tests {</span><br><span class="line">  t.Run(tt.give, <span class="function"><span class="keyword">func</span><span class="params">(t *testing.T)</span></span> {</span><br><span class="line">    host, port, err := net.SplitHostPort(tt.give)</span><br><span class="line">    require.NoError(t, err)</span><br><span class="line">    assert.Equal(t, tt.wantHost, host)</span><br><span class="line">    assert.Equal(t, tt.wantPort, port)</span><br><span class="line">  })</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>很明显，使用test table的方式在代码逻辑扩展的时候，比如新增test case，都会显得更加的清晰，我们遵循这样的约定：将结构体切片称为<code>tests</code>。 每个测试用例称为<code>tt</code>。此外，我们鼓励使用<code>give</code>和<code>want</code>前缀说明每个测试用例的输入和输出值</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">tests := []<span class="keyword">struct</span>{</span><br><span class="line">  give     <span class="keyword">string</span></span><br><span class="line">  wantHost <span class="keyword">string</span></span><br><span class="line">  wantPort <span class="keyword">string</span></span><br><span class="line">}{</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _, tt := <span class="keyword">range</span> tests {</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="功能选项"><a href="#功能选项" class="headerlink" title="功能选项"></a>功能选项</h3><p>功能选项是一种模式，您可以在其中声明一个不透明Option类型，该类型在某些内部结构中记录信息。您接受这些选项的可变编号，并根据内部结构上的选项记录的全部信息采取行动，将此模式用于您需要扩展的构造函数和其他公共 API 中的可选参数，尤其是在这些功能上已经具有三个或更多参数的情况下</p>
<h4 id="反例-57"><a href="#反例-57" class="headerlink" title="反例"></a>反例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// package db</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Open</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  addr <span class="keyword">string</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  cache <span class="keyword">bool</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  logger *zap.Logger</span></span></span><br><span class="line"><span class="function"><span class="params">)</span> <span class="params">(*Connection, error)</span></span> {</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 必须始终提供缓存和记录器参数，即使用户希望使用默认值</span></span><br><span class="line">db.Open(addr, db.DefaultCache, zap.NewNop())</span><br><span class="line">db.Open(addr, db.DefaultCache, log)</span><br><span class="line">db.Open(addr, <span class="literal">false</span> <span class="comment">/* cache */</span>, zap.NewNop())</span><br><span class="line">db.Open(addr, <span class="literal">false</span> <span class="comment">/* cache */</span>, log)</span><br></pre></td></tr></tbody></table></figure>

<h4 id="正例-57"><a href="#正例-57" class="headerlink" title="正例"></a>正例</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// package db</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Option <span class="keyword">interface</span> {</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithCache</span><span class="params">(c <span class="keyword">bool</span>)</span> <span class="title">Option</span></span> {</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithLogger</span><span class="params">(log *zap.Logger)</span> <span class="title">Option</span></span> {</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// Open creates a connection.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Open</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  addr <span class="keyword">string</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  opts ...Option,</span></span></span><br><span class="line"><span class="function"><span class="params">)</span> <span class="params">(*Connection, error)</span></span> {</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 只有在需要时才提供选项</span></span><br><span class="line">db.Open(addr)</span><br><span class="line">db.Open(addr, db.WithLogger(log))</span><br><span class="line">db.Open(addr, db.WithCache(<span class="literal">false</span>))</span><br><span class="line">db.Open(</span><br><span class="line">  addr,</span><br><span class="line">  db.WithCache(<span class="literal">false</span>),</span><br><span class="line">  db.WithLogger(log),</span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure>

<p>我们建议实现此模式的方法是使用一个<code>Option</code>接口，该接口保存一个未导出的方法，在一个未导出的<code>options</code>结构上记录选项</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> options <span class="keyword">struct</span> {</span><br><span class="line">  cache  <span class="keyword">bool</span></span><br><span class="line">  logger *zap.Logger</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Option <span class="keyword">interface</span> {</span><br><span class="line">  apply(*options)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> cacheOption <span class="keyword">bool</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c cacheOption)</span> <span class="title">apply</span><span class="params">(opts *options)</span></span> {</span><br><span class="line">  opts.cache = <span class="keyword">bool</span>(c)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithCache</span><span class="params">(c <span class="keyword">bool</span>)</span> <span class="title">Option</span></span> {</span><br><span class="line">  <span class="keyword">return</span> cacheOption(c)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> loggerOption <span class="keyword">struct</span> {</span><br><span class="line">  Log *zap.Logger</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l loggerOption)</span> <span class="title">apply</span><span class="params">(opts *options)</span></span> {</span><br><span class="line">  opts.logger = l.Log</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithLogger</span><span class="params">(log *zap.Logger)</span> <span class="title">Option</span></span> {</span><br><span class="line">  <span class="keyword">return</span> loggerOption{Log: log}</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// Open creates a connection.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Open</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  addr <span class="keyword">string</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  opts ...Option,</span></span></span><br><span class="line"><span class="function"><span class="params">)</span> <span class="params">(*Connection, error)</span></span> {</span><br><span class="line">  options := options{</span><br><span class="line">    cache:  defaultCache,</span><br><span class="line">    logger: zap.NewNop(),</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> _, o := <span class="keyword">range</span> opts {</span><br><span class="line">    o.apply(&amp;options)</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>注意: 还有一种使用闭包实现这个模式的方法，但是我们相信上面的模式为作者提供了更多的灵活性，并且更容易对用户进行调试和测试。特别是，在不可能进行比较的情况下它允许在测试和模拟中对选项进行比较。此外，它还允许选项实现其他接口，包括<code>fmt.Stringer</code>，允许用户读取选项的字符串表示形式</p>
<p>还可以参考下面资料</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://commandcenter.blogspot.com/2014/01/self-referential-functions-and-design.html">自引用功能和选项设计</a></li>
<li><a target="_blank" rel="noopener" href="https://dave.cheney.net/2014/10/17/functional-options-for-friendly-apis">友好的API的功能选项</a></li>
</ul>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/04/19/go-wen-dang/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/04/19/go-wen-dang/" class="post-title-link" itemprop="url">go基础</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-04-18 17:46:44" itemprop="dateCreated datePublished" datetime="2021-04-18T17:46:44Z">2021-04-18</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-09-11 03:34:47" itemprop="dateModified" datetime="2021-09-11T03:34:47Z">2021-09-11</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line">go help doc</span><br><span class="line">usage: go doc [doc flags] [package|[package.]symbol[.methodOrField]]</span><br><span class="line"></span><br><span class="line">Doc prints the documentation comments associated with the item identified by its</span><br><span class="line">arguments (a package, const, func, type, var, method, or struct field)</span><br><span class="line">followed by a one-line summary of each of the first-level items "under"</span><br><span class="line">that item (package-level declarations for a package, methods for a type,</span><br><span class="line">etc.).</span><br><span class="line"></span><br><span class="line">Doc accepts zero, one, or two arguments.</span><br><span class="line"></span><br><span class="line">Given no arguments, that is, when run as</span><br><span class="line"></span><br><span class="line">        go doc</span><br><span class="line"></span><br><span class="line">it prints the package documentation for the package in the current directory.</span><br><span class="line">If the package is a command (package main), the exported symbols of the package</span><br><span class="line">are elided from the presentation unless the -cmd flag is provided.    </span><br><span class="line"></span><br><span class="line">When run with one argument, the argument is treated as a Go-syntax-like</span><br><span class="line">representation of the item to be documented. What the argument selects depends</span><br><span class="line">on what is installed in GOROOT and GOPATH, as well as the form of the argument,</span><br><span class="line">which is schematically one of these:</span><br><span class="line"></span><br><span class="line">        go doc &lt;pkg&gt;</span><br><span class="line">        go doc &lt;sym&gt;[.&lt;methodOrField&gt;]</span><br><span class="line">        go doc [&lt;pkg&gt;.]&lt;sym&gt;[.&lt;methodOrField&gt;]</span><br><span class="line">        go doc [&lt;pkg&gt;.][&lt;sym&gt;.]&lt;methodOrField&gt;</span><br><span class="line"></span><br><span class="line">The first item in this list matched by the argument is the one whose documentation</span><br><span class="line">is printed. (See the examples below.) However, if the argument starts with a capital</span><br><span class="line">letter it is assumed to identify a symbol or method in the current directory.</span><br><span class="line"></span><br><span class="line">For packages, the order of scanning is determined lexically in breadth-first order.</span><br><span class="line">That is, the package presented is the one that matches the search and is nearest</span><br><span class="line">the root and lexically first at its level of the hierarchy. The GOROOT tree is</span><br><span class="line">always scanned in its entirety before GOPATH.</span><br><span class="line"></span><br><span class="line">If there is no package specified or matched, the package in the current</span><br><span class="line">directory is selected, so "go doc Foo" shows the documentation for symbol Foo in</span><br><span class="line">the current package.</span><br><span class="line"></span><br><span class="line">The package path must be either a qualified path or a proper suffix of a</span><br><span class="line">path. The go tool's usual package mechanism does not apply: package path</span><br><span class="line">elements like . and ... are not implemented by go doc.</span><br><span class="line"></span><br><span class="line">When run with two arguments, the first must be a full package path (not just a</span><br><span class="line">suffix), and the second is a symbol, or symbol with method or struct field.</span><br><span class="line">This is similar to the syntax accepted by godoc:</span><br><span class="line"></span><br><span class="line">        go doc &lt;pkg&gt; &lt;sym&gt;[.&lt;methodOrField&gt;]</span><br><span class="line"></span><br><span class="line">In all forms, when matching symbols, lower-case letters in the argument match</span><br><span class="line">either case but upper-case letters match exactly. This means that there may be</span><br><span class="line">multiple matches of a lower-case argument in a package if different symbols have</span><br><span class="line">different cases. If this occurs, documentation for all matches is printed.</span><br><span class="line"></span><br><span class="line">Examples:</span><br><span class="line">        go doc</span><br><span class="line">                Show documentation for current package.</span><br><span class="line">        go doc Foo</span><br><span class="line">                Show documentation for Foo in the current package.    </span><br><span class="line">                (Foo starts with a capital letter so it cannot match  </span><br><span class="line">                a package path.)</span><br><span class="line">        go doc encoding/json</span><br><span class="line">                Show documentation for the encoding/json package.     </span><br><span class="line">        go doc json</span><br><span class="line">                Shorthand for encoding/json.</span><br><span class="line">        go doc json.Number (or go doc json.number)</span><br><span class="line">                Show documentation and method summary for json.Number.</span><br><span class="line">        go doc json.Number.Int64 (or go doc json.number.int64)        </span><br><span class="line">                Show documentation for json.Number's Int64 method.    </span><br><span class="line">        go doc cmd/doc</span><br><span class="line">                Show package docs for the doc command.</span><br><span class="line">        go doc -cmd cmd/doc</span><br><span class="line">                Show package docs and exported symbols within the doc command.</span><br><span class="line">        go doc template.new</span><br><span class="line">                Show documentation for html/template's New function.  </span><br><span class="line">                (html/template is lexically before text/template)     </span><br><span class="line">        go doc text/template.new # One argument</span><br><span class="line">                Show documentation for text/template's New function.  </span><br><span class="line">        go doc text/template new # Two arguments</span><br><span class="line">                Show documentation for text/template's New function.  </span><br><span class="line"></span><br><span class="line">        At least in the current tree, these invocations all print the </span><br><span class="line">        documentation for json.Decoder's Decode method:</span><br><span class="line"></span><br><span class="line">        go doc json.Decoder.Decode</span><br><span class="line">        go doc json.decoder.decode</span><br><span class="line">        go doc json.decode</span><br><span class="line">        cd go/src/encoding/json; go doc decode</span><br><span class="line"></span><br><span class="line">Flags:</span><br><span class="line">        -all</span><br><span class="line">                Show all the documentation for the package.</span><br><span class="line">        -c</span><br><span class="line">                Respect case when matching symbols.</span><br><span class="line">        -cmd</span><br><span class="line">                Treat a command (package main) like a regular package.</span><br><span class="line">                Otherwise package main's exported symbols are hidden  </span><br><span class="line">                when showing the package's top-level documentation.   </span><br><span class="line">        -short</span><br><span class="line">                One-line representation for each symbol.</span><br><span class="line">        -src</span><br><span class="line">                Show the full source code for the symbol. This will   </span><br><span class="line">                display the full Go source of its declaration and     </span><br><span class="line">                definition, such as a function definition (including  </span><br><span class="line">                the body), type declaration or enclosing const        </span><br><span class="line">                block. The output may therefore include unexported    </span><br><span class="line">                details.</span><br><span class="line">        -u</span><br><span class="line">                Show documentation for unexported as well as exported </span><br><span class="line">                symbols, methods, and fields.</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\rose\go\src\learngo\lang\queue&gt; go doc</span><br><span class="line">package queue // import "imooc.com/ccmouse/learngo/lang/queue"</span><br><span class="line"></span><br><span class="line">type Queue []int</span><br><span class="line">PS C:\Users\rose\go\src\learngo\lang\queue&gt; go doc Queue</span><br><span class="line">package queue // import "."</span><br><span class="line"></span><br><span class="line">type Queue []int</span><br><span class="line">    A FIFO queue.</span><br><span class="line"></span><br><span class="line">func (q *Queue) IsEmpty() bool</span><br><span class="line">func (q *Queue) Pop() int</span><br><span class="line">func (q *Queue) Push(v int)</span><br><span class="line">PS C:\Users\rose\go\src\learngo\lang\queue&gt; </span><br></pre></td></tr></tbody></table></figure>


<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/04/17/ding-dan-zeng-chang-tong-ji-tu/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/04/17/ding-dan-zeng-chang-tong-ji-tu/" class="post-title-link" itemprop="url">订单增长统计图</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-04-17 08:39:20" itemprop="dateCreated datePublished" datetime="2021-04-17T08:39:20Z">2021-04-17</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-06-12 02:59:48" itemprop="dateModified" datetime="2021-06-12T02:59:48Z">2021-06-12</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%97%85%E6%B8%B8%E7%BD%91%E9%A1%B9%E7%9B%AE/" itemprop="url" rel="index"><span itemprop="name">旅游网项目</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>实现步骤</p>
<ul>
<li>配置URL规则、视图函数</li>
</ul>
<p><code>master\urls.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">urlpatterns = [</span><br><span class="line">    <span class="comment"># 统计报表</span></span><br><span class="line">    path(<span class="string">''</span>, views.index, name=<span class="string">'index'</span>),</span><br><span class="line">]</span><br></pre></td></tr></tbody></table></figure>

<p><code>master\views.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, timedelta</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.contrib.auth.decorators <span class="keyword">import</span> login_required</span><br><span class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> Sum, Q</span><br><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render</span><br><span class="line"><span class="keyword">from</span> django.utils.timezone <span class="keyword">import</span> now</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> accounts.models <span class="keyword">import</span> User, Profile</span><br><span class="line"><span class="keyword">from</span> order.choices <span class="keyword">import</span> OrderStatus</span><br><span class="line"><span class="keyword">from</span> order.models <span class="keyword">import</span> Order</span><br><span class="line"><span class="keyword">from</span> sight.models <span class="keyword">import</span> Sight, Comment</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_data_count</span>(<span class="params">start=None, end=None</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    实时统计数据</span></span><br><span class="line"><span class="string">    :param start: 开始时间</span></span><br><span class="line"><span class="string">    :param end: 结束时间</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    query = Q()</span><br><span class="line">    <span class="keyword">if</span> start:  <span class="comment"># created_at &gt;=start</span></span><br><span class="line">        query = query &amp; Q(created_at__gte=start)</span><br><span class="line">    <span class="keyword">if</span> end:  <span class="comment"># created_at &lt;= end</span></span><br><span class="line">        query = query &amp; Q(created_at__lte=end)</span><br><span class="line">    order_list = Order.objects.filter(status=OrderStatus.PAID).filter(query)</span><br><span class="line">    user_list = Profile.objects.select_related(<span class="string">'user'</span>).filter(</span><br><span class="line">        user__is_active=<span class="literal">True</span>).filter(query)</span><br><span class="line">    <span class="keyword">return</span> {</span><br><span class="line">        <span class="comment"># 销售额</span></span><br><span class="line">        <span class="string">'order_amount'</span>:</span><br><span class="line">        order_list.aggregate(amount=Sum(<span class="string">'buy_amount'</span>))[<span class="string">'amount'</span>],  <span class="comment"># 没有数据返回none</span></span><br><span class="line">        <span class="comment"># 订单数量</span></span><br><span class="line">        <span class="string">'order_count'</span>: order_list.count(),</span><br><span class="line">        <span class="comment"># 新增的用户数量</span></span><br><span class="line">        <span class="string">'user_add_count'</span>: user_list.count(),</span><br><span class="line">        <span class="comment"># 下单的用户数</span></span><br><span class="line">        <span class="string">'order_user_count'</span>: order_list.values(<span class="string">'user'</span>).distinct().count()</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_latest_order_stats</span>(<span class="params">days=<span class="number">7</span></span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    最近N日的订单统计</span></span><br><span class="line"><span class="string">    :param days: 天数</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    date_array, amount_array, count_arry = [], [], []</span><br><span class="line">    now_time = now()</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> range(days, <span class="number">0</span>, <span class="number">-1</span>):</span><br><span class="line">        <span class="comment"># 日期</span></span><br><span class="line">        calc_time = now_time + timedelta(hours=-x * <span class="number">24</span>)</span><br><span class="line">        date_array.append(<span class="string">'{}号'</span>.format(calc_time.day))</span><br><span class="line">        queryset = Order.objects.filter(status=OrderStatus.PAID,</span><br><span class="line">                                        created_at__date=calc_time.date())</span><br><span class="line">        result = queryset.aggregate(amount=Sum(<span class="string">'buy_amount'</span>),</span><br><span class="line">                                    count=Sum(<span class="string">'buy_count'</span>))</span><br><span class="line">        <span class="comment"># 订单金额</span></span><br><span class="line">        amount_array.append(result[<span class="string">'amount'</span>] <span class="keyword">or</span> <span class="number">0</span>)</span><br><span class="line">        <span class="comment"># 订单数量</span></span><br><span class="line">        count_arry.append(result[<span class="string">'count'</span>] <span class="keyword">or</span> <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> {<span class="string">'date'</span>: date_array, <span class="string">'amount'</span>: amount_array, <span class="string">'count'</span>: count_arry}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@login_required(login_url='/admin/login/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="string">""" 统计报表 """</span></span><br><span class="line">    <span class="comment"># 1. 数据统计</span></span><br><span class="line">    total_stats = {</span><br><span class="line">        <span class="string">'sight_count'</span>: Sight.objects.filter(is_valid=<span class="literal">True</span>).count(),</span><br><span class="line">        <span class="string">'comment_count'</span>: Comment.objects.filter(is_valid=<span class="literal">True</span>).count(),</span><br><span class="line">        <span class="string">'user_count'</span>: User.objects.filter(is_active=<span class="literal">True</span>).count(),</span><br><span class="line">        <span class="string">'order_count'</span>: Order.objects.filter(status=OrderStatus.PAID).count(),</span><br><span class="line">    }</span><br><span class="line">    <span class="comment"># 2. 今日实时数据</span></span><br><span class="line">    now_time = now()</span><br><span class="line">    now_stats = get_data_count(</span><br><span class="line">        start=datetime(now_time.year, now_time.month, now_time.day))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 3. 昨天的数据</span></span><br><span class="line">    yesterday = now_time + timedelta(hours=<span class="number">-24</span>)</span><br><span class="line">    yesterday_stats = get_data_count(start=datetime(yesterday.year,</span><br><span class="line">                                                    yesterday.month,</span><br><span class="line">                                                    yesterday.day),</span><br><span class="line">                                     end=datetime(now_time.year,</span><br><span class="line">                                                  now_time.month,</span><br><span class="line">                                                  now_time.day))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 4. 数据走势</span></span><br><span class="line">    latest_stats = get_latest_order_stats()</span><br><span class="line">    <span class="keyword">return</span> render(</span><br><span class="line">        request, <span class="string">'master/index.html'</span>, {</span><br><span class="line">            <span class="string">'total_stats'</span>: total_stats,</span><br><span class="line">            <span class="string">'now_stats'</span>: now_stats,</span><br><span class="line">            <span class="string">'yesterday_stats'</span>: yesterday_stats,</span><br><span class="line">            <span class="string">'latest_stats'</span>: latest_stats</span><br><span class="line">        })</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="string">"""  echarts的使用 """</span></span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'master/test.html'</span>)</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">C:\django\trip&gt;python manage.py shell</span><br><span class="line">Python 3.8.0 (tags/v3.8.0:fa919fd, Oct 14 2019, 19:37:50) [MSC v.1916 64 bit (AMD64)] on win32</span><br><span class="line">Type <span class="string">"help"</span>, <span class="string">"copyright"</span>, <span class="string">"credits"</span> or <span class="string">"license"</span> <span class="keyword">for</span> more information.</span><br><span class="line">(InteractiveConsole)</span><br><span class="line">&gt;&gt;&gt; from order.models import Order</span><br><span class="line">&gt;&gt;&gt; l1= Order.objects.all()</span><br><span class="line">&gt;&gt;&gt; l1.count()</span><br><span class="line">7</span><br><span class="line">&gt;&gt;&gt; l1</span><br><span class="line">&lt;QuerySet [&lt;Order: Order object (1)&gt;, &lt;Order: Order object (2)&gt;, &lt;Order: Order object (3)&gt;, &lt;Order: Order object (4)&gt;, &lt;Order: Order object (5)&gt;, &lt;Order: Order object (6)&gt;, &lt;Order: Order object (7)&gt;]&gt;</span><br><span class="line">&gt;&gt;&gt; t = l1.values(<span class="string">"user"</span>)</span><br><span class="line">&gt;&gt;&gt; t</span><br><span class="line">&lt;QuerySet [{<span class="string">'user'</span>: 4}, {<span class="string">'user'</span>: 4}, {<span class="string">'user'</span>: 5}, {<span class="string">'user'</span>: 5}, {<span class="string">'user'</span>: 5}, {<span class="string">'user'</span>: 5}, {<span class="string">'user'</span>: 5}]&gt;&gt;&gt;&gt; t.distinct()</span><br><span class="line">&lt;QuerySet [{<span class="string">'user'</span>: 4}, {<span class="string">'user'</span>: 5}]&gt;</span><br><span class="line">&gt;&gt;&gt; t.distinct().count()</span><br><span class="line">2</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>新建、配置自定义模块</li>
</ul>
<p><code>static\plugins</code>和<code>static\style</code></p>
<ul>
<li><p>准备数据、权限验证<br>如果没有登录，会跳转到django后台登录的地址<br><code>@login_required(login_url='/admin/login/')</code></p>
</li>
<li><p>界面填充</p>
</li>
</ul>
<p><img src="/2021/04/17/ding-dan-zeng-chang-tong-ji-tu/1.png" alt="description"></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/13/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/13/">13</a><span class="page-number current">14</span><a class="page-number" href="/page/15/">15</a><span class="space">&hellip;</span><a class="page-number" href="/page/37/">37</a><a class="extend next" rel="next" href="/page/15/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">外心人D</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  




  





</body>
</html>
