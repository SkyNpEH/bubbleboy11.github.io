<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.0.2">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<meta name="hexo-config" content="{&quot;hostname&quot;:&quot;bubbleboy11.github.io&quot;,&quot;root&quot;:&quot;/&quot;,&quot;images&quot;:&quot;/images&quot;,&quot;scheme&quot;:&quot;Muse&quot;,&quot;version&quot;:&quot;8.3.0&quot;,&quot;exturl&quot;:false,&quot;sidebar&quot;:{&quot;position&quot;:&quot;left&quot;,&quot;display&quot;:&quot;post&quot;,&quot;padding&quot;:18,&quot;offset&quot;:12},&quot;copycode&quot;:true,&quot;bookmark&quot;:{&quot;enable&quot;:false,&quot;color&quot;:&quot;#222&quot;,&quot;save&quot;:&quot;auto&quot;},&quot;fancybox&quot;:false,&quot;mediumzoom&quot;:false,&quot;lazyload&quot;:false,&quot;pangu&quot;:false,&quot;comments&quot;:{&quot;style&quot;:&quot;tabs&quot;,&quot;active&quot;:null,&quot;storage&quot;:true,&quot;lazyload&quot;:false,&quot;nav&quot;:null},&quot;motion&quot;:{&quot;enable&quot;:true,&quot;async&quot;:false,&quot;transition&quot;:{&quot;post_block&quot;:&quot;fadeIn&quot;,&quot;post_header&quot;:&quot;fadeInDown&quot;,&quot;post_body&quot;:&quot;fadeInDown&quot;,&quot;coll_header&quot;:&quot;fadeInLeft&quot;,&quot;sidebar&quot;:&quot;fadeInUp&quot;}},&quot;prism&quot;:false,&quot;i18n&quot;:{&quot;placeholder&quot;:&quot;搜索...&quot;,&quot;empty&quot;:&quot;没有找到任何搜索结果：${query}&quot;,&quot;hits_time&quot;:&quot;找到 ${hits} 个搜索结果（用时 ${time} 毫秒）&quot;,&quot;hits&quot;:&quot;找到 ${hits} 个搜索结果&quot;}}">
<meta name="description" content="本博客大多内容为慕课和网上博客，并非原创">
<meta property="og:type" content="website">
<meta property="og:title" content="外心人D的博客">
<meta property="og:url" content="https://bubbleboy11.github.io/page/3/index.html">
<meta property="og:site_name" content="外心人D的博客">
<meta property="og:description" content="本博客大多内容为慕课和网上博客，并非原创">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="外心人D">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://bubbleboy11.github.io/page/3/">



<meta name="hexo-config-page" content="{&quot;sidebar&quot;:&quot;&quot;,&quot;isHome&quot;:true,&quot;isPost&quot;:false,&quot;lang&quot;:&quot;zh-CN&quot;}">
<meta name="hexo-config-calendar" content="">
<script data-pjax src="/js/load-config.js"></script>
  <title>外心人D的博客</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="外心人D的博客" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism.css" type="text/css"></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">外心人D的博客</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">外心人D</p>
  <div class="site-description" itemprop="description">本博客大多内容为慕课和网上博客，并非原创</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">267</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">24</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">40</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/05/06/drf-shi-tu-viewsets-he-guo-lu-qi-shi-xian-zhan-shi-shang-pin-lie-biao-ye-he-xiang-qing/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/06/drf-shi-tu-viewsets-he-guo-lu-qi-shi-xian-zhan-shi-shang-pin-lie-biao-ye-he-xiang-qing/" class="post-title-link" itemprop="url">DRF视图viewsets和过滤器实现展示商品列表页和详情</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-05-05 16:21:41" itemprop="dateCreated datePublished" datetime="2021-05-05T16:21:41Z">2021-05-05</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-06-05 09:50:53" itemprop="dateModified" datetime="2021-06-05T09:50:53Z">2021-06-05</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/django/" itemprop="url" rel="index"><span itemprop="name">django</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>The default behavior of REST framework’s generic list views is to return the entire queryset for a model manager. Often you will want your API to restrict the items that are returned by the queryset.</p>
<p>The simplest way to filter the queryset of any view that subclasses <code>GenericAPIView</code> is to override the <code>.get_queryset()</code> method.</p>
<p>Overriding this method allows you to customize the queryset returned by the view in a number of different ways.</p>
<p>DRF配置</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">REST_FRAMEWORK = {</span><br><span class="line">    <span class="string">'DEFAULT_FILTER_BACKENDS'</span>: [<span class="string">'django_filters.rest_framework.DjangoFilterBackend'</span>]</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h1 id="viewsets实现展示商品列表页数据"><a href="#viewsets实现展示商品列表页数据" class="headerlink" title="viewsets实现展示商品列表页数据"></a>viewsets实现展示商品列表页数据</h1><p>点击某一个商品分类下面显示出商品详情，具体包括分类显示、价格筛选、分页和排序、显示商品数量、搜索<br>本项目可以看到，通过搜索和点击Tab页左侧显示的导航栏是不同的，其数据接口也不一样</p>
<p><code>goods/serializers.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GoodsSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="string">'''商品列表序列化'''</span></span><br><span class="line">    <span class="comment"># 关联对象嵌套序列化，返回当前类数据和关联模型类的数据</span></span><br><span class="line">    category = CategorySerializer()  <span class="comment"># 一对一</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Goods</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br></pre></td></tr></tbody></table></figure>

<p><code>apps/goods/views.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GoodsListViewSet</span>(<span class="params">mixins.ListModelMixin, viewsets.GenericViewSet</span>):</span></span><br><span class="line">    <span class="string">'''list: 商品列表页'''</span></span><br><span class="line">    queryset = Goods.objects.all()</span><br><span class="line">    serializer_class = GoodsSerializer</span><br><span class="line"></span><br><span class="line">    filter_backends = (DjangoFilterBackend,)</span><br><span class="line">    filter_fields = (<span class="string">'name'</span>,<span class="string">'shop_price'</span>)</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/05/06/drf-shi-tu-viewsets-he-guo-lu-qi-shi-xian-zhan-shi-shang-pin-lie-biao-ye-he-xiang-qing/9.png" alt="description"><br><img src="/2021/05/06/drf-shi-tu-viewsets-he-guo-lu-qi-shi-xian-zhan-shi-shang-pin-lie-biao-ye-he-xiang-qing/0.png" alt="description"></p>
<p>根据字段进行过滤，但是只能精确比配，对于字符串型字段不能模糊匹配，对于数值型字段也不能匹配区间，</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GoodsListViewSet</span>(<span class="params">mixins.ListModelMixin, viewsets.GenericViewSet</span>):</span></span><br><span class="line">    <span class="string">'''list: 商品列表页，并实现分页、搜索、过滤、排序'''</span></span><br><span class="line">    <span class="comment"># queryset = Goods.objects.all()  # 切换get_queryset方法</span></span><br><span class="line">    serializer_class = GoodsSerializer</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_queryset</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        This view should return a list of all the goods</span></span><br><span class="line"><span class="string">        for shop_price &gt;= price_min.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        queryset = Goods.objects.all()</span><br><span class="line">        price_min = self.request.query_params.get(<span class="string">'price_min'</span>, <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">if</span> price_min:</span><br><span class="line">            queryset = queryset.filter(shop_price__gt=int(price_min))  <span class="comment"># django的filter</span></span><br><span class="line">        <span class="keyword">return</span> queryset</span><br></pre></td></tr></tbody></table></figure>

<p><a target="_blank" rel="noopener" href="http://127.0.0.1:8000/goods/?price_min=200">http://127.0.0.1:8000/goods/?price_min=200</a>通过url传递参数实现过滤数据</p>
<h3 id="通过第三方包django-filters-的-DjangoFilterBackend类实现字段过滤（与后台管理系统表现相同）"><a href="#通过第三方包django-filters-的-DjangoFilterBackend类实现字段过滤（与后台管理系统表现相同）" class="headerlink" title="通过第三方包django_filters 的 DjangoFilterBackend类实现字段过滤（与后台管理系统表现相同）"></a>通过第三方包<code>django_filters</code> 的 <code>DjangoFilterBackend</code>类实现字段过滤（与后台管理系统表现相同）</h3><p><code>mxshop/settings.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">INSTALLED_APPS = [</span><br><span class="line">     <span class="string">'django_filters'</span>,</span><br><span class="line">]</span><br></pre></td></tr></tbody></table></figure>

<p>新建自定义 <code>goods/filters.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> django_filters</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Goods</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GoodsFilter</span>(<span class="params">django_filters.rest_framework.FilterSet</span>):</span></span><br><span class="line">    <span class="string">'''商品过滤类'''</span></span><br><span class="line">    <span class="comment"># 两个参数，field_name是要过滤的字段，lookup是执行的行为，‘小于等于本店价格’</span></span><br><span class="line">    pricemin = django_filters.NumberFilter(field_name=<span class="string">"market_price"</span>, lookup_expr=<span class="string">'gte'</span>)</span><br><span class="line">    pricemax = django_filters.NumberFilter(field_name=<span class="string">"market_price"</span>, lookup_expr=<span class="string">'lte'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Goods</span><br><span class="line">        fields = [<span class="string">'pricemin'</span>, <span class="string">'pricemax'</span>]</span><br></pre></td></tr></tbody></table></figure>

<p><code>apps/goods/views.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django_filters.rest_framework <span class="keyword">import</span> DjangoFilterBackend</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .filters <span class="keyword">import</span> GoodsFilter</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GoodsListViewSet</span>(<span class="params">mixins.ListModelMixin,viewsets.GenericViewSet</span>):</span></span><br><span class="line">    <span class="string">'商品列表页'</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 这里必须要定义一个默认的排序否则会报错</span></span><br><span class="line">    queryset = Goods.objects.all().order_by(<span class="string">'id'</span>)</span><br><span class="line">    serializer_class = GoodsSerializer</span><br><span class="line"></span><br><span class="line">    filter_backends = (DjangoFilterBackend, )</span><br><span class="line">    <span class="comment"># 设置filter的类为我们自定义的类</span></span><br><span class="line">    filter_class = GoodsFilter</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/05/06/drf-shi-tu-viewsets-he-guo-lu-qi-shi-xian-zhan-shi-shang-pin-lie-biao-ye-he-xiang-qing/1.png" alt="description"></p>
<h3 id="SearchFilter-类实现字段搜索"><a href="#SearchFilter-类实现字段搜索" class="headerlink" title="SearchFilter 类实现字段搜索"></a><code>SearchFilter</code> 类实现字段搜索</h3><p>新建自定义 <code>goods/filters.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Goods</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GoodsFilter</span>(<span class="params">django_filters.rest_framework.FilterSet</span>):</span></span><br><span class="line">    <span class="string">'''商品过滤类'''</span></span><br><span class="line">    <span class="comment"># 两个参数，field_name是要过滤的字段，lookup是执行的行为，‘小于等于本店价格’</span></span><br><span class="line">    name = django_filters.CharFilter(field_name=<span class="string">"name"</span>, lookup_expr=<span class="string">'contains'</span>)  <span class="comment"># 指定包含，默认是全部匹配</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Goods</span><br><span class="line">        fields = [<span class="string">'name'</span>]</span><br></pre></td></tr></tbody></table></figure>

<p><code>apps/goods/views.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> mixins, viewsets, filters</span><br><span class="line"><span class="keyword">from</span> django_filters.rest_framework <span class="keyword">import</span> DjangoFilterBackend</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .filters <span class="keyword">import</span> GoodsFilter</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GoodsListViewSet</span>(<span class="params">mixins.ListModelMixin,viewsets.GenericViewSet</span>):</span></span><br><span class="line">    <span class="string">'商品列表页'</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 这里必须要定义一个默认的排序否则会报错</span></span><br><span class="line">    queryset = Goods.objects.all().order_by(<span class="string">'id'</span>)</span><br><span class="line">    serializer_class = GoodsSerializer</span><br><span class="line"></span><br><span class="line">    filter_backends = (filters.SearchFilter, )</span><br><span class="line">    search_fields = [<span class="string">'name'</span>, <span class="string">'goods_brief'</span>, <span class="string">'goods_desc'</span>]</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/05/06/drf-shi-tu-viewsets-he-guo-lu-qi-shi-xian-zhan-shi-shang-pin-lie-biao-ye-he-xiang-qing/3.png" alt="description"></p>
<h3 id="drf-的-OrderingFilter-类实现字段排序"><a href="#drf-的-OrderingFilter-类实现字段排序" class="headerlink" title="drf 的 OrderingFilter 类实现字段排序"></a>drf 的 <code>OrderingFilter</code> 类实现字段排序</h3><p><code>apps/goods/views.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> mixins, viewsets, filters</span><br><span class="line"><span class="keyword">from</span> django_filters.rest_framework <span class="keyword">import</span> DjangoFilterBackend</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .filters <span class="keyword">import</span> GoodsFilter</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GoodsListViewSet</span>(<span class="params">mixins.ListModelMixin,viewsets.GenericViewSet</span>):</span></span><br><span class="line">    <span class="string">'商品列表页'</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 这里必须要定义一个默认的排序否则会报错</span></span><br><span class="line">    queryset = Goods.objects.all().order_by(<span class="string">'id'</span>)</span><br><span class="line">    serializer_class = GoodsSerializer</span><br><span class="line"></span><br><span class="line">    filter_backends = (filters.OrderingFilter, )</span><br><span class="line">    ordering_fields = [<span class="string">'sold_num'</span>, <span class="string">'shop_price'</span>]  <span class="comment"># 按销量或价格排序</span></span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/05/06/drf-shi-tu-viewsets-he-guo-lu-qi-shi-xian-zhan-shi-shang-pin-lie-biao-ye-he-xiang-qing/4.png" alt="description"><br><img src="/2021/05/06/drf-shi-tu-viewsets-he-guo-lu-qi-shi-xian-zhan-shi-shang-pin-lie-biao-ye-he-xiang-qing/5.png" alt="description"></p>
<p>新建自定义 <code>goods/filters.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> Q</span><br><span class="line"><span class="keyword">import</span> django_filters</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Goods</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GoodsFilter</span>(<span class="params">django_filters.rest_framework.FilterSet</span>):</span></span><br><span class="line">    <span class="string">'''商品过滤类'''</span></span><br><span class="line">    <span class="comment"># 两个参数，field_name是要过滤的字段，lookup是执行的行为，‘小于等于本店价格’</span></span><br><span class="line">    <span class="comment"># 价格区间过滤</span></span><br><span class="line">    pricemin = django_filters.NumberFilter(field_name=<span class="string">"market_price"</span>, lookup_expr=<span class="string">'gte'</span>, help_text=<span class="string">'最小价格'</span>)</span><br><span class="line">    pricemax = django_filters.NumberFilter(field_name=<span class="string">"market_price"</span>, lookup_expr=<span class="string">'lte'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 自定义过滤，过滤某个一级分类</span></span><br><span class="line">    top_category = django_filters.NumberFilter(method=<span class="string">'top_category_filter'</span>, help_text=<span class="string">'自定义过滤某个一级分类'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">top_category_filter</span>(<span class="params">self, queryset, name, value</span>):</span></span><br><span class="line">        <span class="string">'''</span></span><br><span class="line"><span class="string">        自定义过滤</span></span><br><span class="line"><span class="string">        不管当前点击的是一级分类二级分类还是三级分类，</span></span><br><span class="line"><span class="string">        需要传入参数：一级分类的id</span></span><br><span class="line"><span class="string">        在已有商品查询集基础上获取分类id，一级一级往上找，直到将三级类别找完</span></span><br><span class="line"><span class="string">        '''</span></span><br><span class="line">        <span class="keyword">return</span> queryset.filter(Q(category_id=value) | Q(category__parent_category_id=value) | Q(</span><br><span class="line">            category__parent_category__parent_category_id=value))</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Goods</span><br><span class="line">        fields = [<span class="string">'pricemin'</span>, <span class="string">'pricemax'</span>]</span><br></pre></td></tr></tbody></table></figure>

<h1 id="viewsets继承mixins-RetrieveModelMixin实现商品详情页"><a href="#viewsets继承mixins-RetrieveModelMixin实现商品详情页" class="headerlink" title="viewsets继承mixins.RetrieveModelMixin实现商品详情页"></a>viewsets继承<code>mixins.RetrieveModelMixin</code>实现商品详情页</h1><p>左侧有商品轮播图，右侧是商品的详情信息，包括商品名称、商品描述、是否包邮、市场价、本店价、销量、库存量、购物车按钮、收藏按钮，还包括富文本详情和热卖商品等。</p>
<p><code>apps/goods/views.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GoodsListViewSet</span>(<span class="params">mixins.RetrieveModelMixin, viewsets.GenericViewSet</span>):</span></span><br><span class="line">    <span class="string">'''retrieve:根据ID商品详情'''</span></span><br></pre></td></tr></tbody></table></figure>

<p><code>goods/serializers.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GoodsImageSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="string">'''商品图片'''</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = GoodsImage</span><br><span class="line">        fields = [<span class="string">'image'</span>, ]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GoodsSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="string">'''商品详情序列化'''</span></span><br><span class="line">    <span class="comment"># 关联对象嵌套序列化，返回当前类数据和关联模型类的数据</span></span><br><span class="line">    <span class="comment"># images是数据库中设置的related_name="images"，把商品图嵌套进来</span></span><br><span class="line">    images = GoodsImageSerializer(many=<span class="literal">True</span>)  <span class="comment"># 字段名和外键名称一样，一对多</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Goods</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/05/06/drf-shi-tu-viewsets-he-guo-lu-qi-shi-xian-zhan-shi-shang-pin-lie-biao-ye-he-xiang-qing/6.png" alt="description"><br>可以看到每个商品的轮播图字段都已经显示了，整个轮播图url都能拼凑好，指定商品id，可以看到该商品的详细信息，</p>
<h2 id="热卖商品接口实现"><a href="#热卖商品接口实现" class="headerlink" title="热卖商品接口实现"></a>热卖商品接口实现</h2><p>在商品详情页右侧有热卖商品，这要用到商品的<code>is_hot</code>字段，在商品的过滤类中增加一个<code>is_hot</code></p>
<p><code>goods/filters.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Goods</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GoodsFilter</span>(<span class="params">django_filters.rest_framework.FilterSet</span>):</span></span><br><span class="line">    <span class="string">'''商品过滤类'''</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Goods</span><br><span class="line">        fields = [<span class="string">'is_hot'</span>]</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/05/06/drf-shi-tu-viewsets-he-guo-lu-qi-shi-xian-zhan-shi-shang-pin-lie-biao-ye-he-xiang-qing/7.png" alt="description"><br><img src="/2021/05/06/drf-shi-tu-viewsets-he-guo-lu-qi-shi-xian-zhan-shi-shang-pin-lie-biao-ye-he-xiang-qing/8.png" alt="description"></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/05/05/xu-lie-hua/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/05/xu-lie-hua/" class="post-title-link" itemprop="url">序列化</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-05-04 16:21:41" itemprop="dateCreated datePublished" datetime="2021-05-04T16:21:41Z">2021-05-04</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-06-08 08:47:07" itemprop="dateModified" datetime="2021-06-08T08:47:07Z">2021-06-08</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/django/" itemprop="url" rel="index"><span itemprop="name">django</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>把查询集归为queryset或者模型类生成实例instance的django模型类数据转换成json/ xml / yaml，再传给前端js进行渲染<br>反序列化，前端post请求的body里面带有json数据，使用django的orm转换成新的模型类数据对象更新或保存到数据库里</p>
<p>django自带序列化功能，但是不完善<br>字段序列化定死的，要想重组的话非常麻烦<br>images保存的是一个相对路径，我们还需要补全路径，而这些drf自动补全完整路径</p>
<p><code>Python Console</code>是针对当前项目环境的console或者<code>python manage.py shell</code></p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.core <span class="keyword">import</span> serializers</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> course.models <span class="keyword">import</span> Course  <span class="comment"># 引入课程</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 第一个参数想要序列化后的类型</span></span><br><span class="line"><span class="comment"># 第二个参数是序列化模型类已有的所有字段对象</span></span><br><span class="line">serializers.serialize(<span class="string">'json'</span>, Course.objects.all())</span><br><span class="line"><span class="string">'[{"model": "course.course", "pk": 1, "fields": {"name": "django rest framework快速入门", "introduction": "API接口开发无需费时费力，本课程将从零开始引导同学们快速开发自己的RESTful API接口，从Django项目环境搭建、API接口生成数据、Postman接口测试到DRF认证方式的讲解，通过一个典型的课程信息接口（含增删改查），给同学们讲解完DRF中的序列化（serializers）、视图集（viewsets）、路由（routers）、认证（authentication）、权限（permission），为将来前后端分离项目的开发打下基础。", "teacher": 1, "price": "9.99", "created_at": "2021-05-04T22:35:31.439", "updated_at": "2021-05-04T22:35:31.439"}}]'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 序列号特定字段</span></span><br><span class="line">serializers.serialize(<span class="string">'json'</span>, Course.objects.all(), fields=(<span class="string">"name"</span>))</span><br><span class="line"><span class="string">'[{"model": "course.course", "pk": 1, "fields": {"name": "django rest framework快速入门"}}]'</span></span><br></pre></td></tr></tbody></table></figure>

<p><code>teacher</code>不是外键所关联的用户名称而是对应Teacher模型的主键id，<br>当然还可以显示teacher的具体信息，此时需要使用嵌套序列化，如下：</p>
<figure class="highlight pgsql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">```</span><br><span class="line"></span><br><span class="line">### 视图实现商品列表</span><br><span class="line"></span><br><span class="line">```py</span><br><span class="line"><span class="keyword">import</span> <span class="type">json</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.views.generic <span class="keyword">import</span> <span class="keyword">View</span></span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> JsonResponse</span><br><span class="line"><span class="keyword">from</span> django.core <span class="keyword">import</span> serializers</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> goods.models <span class="keyword">import</span> Goods</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> GoodsListView(<span class="keyword">View</span>):</span><br><span class="line">    def <span class="keyword">get</span>(self, request):</span><br><span class="line">        # 获取所有商品</span><br><span class="line">        goods = Goods.objects.<span class="keyword">all</span>()</span><br><span class="line"></span><br><span class="line">        # 通过serializers实现商品列表页</span><br><span class="line">        json_data = serializers.serialize(<span class="string">'json'</span>, goods)</span><br><span class="line"></span><br><span class="line">        # <span class="keyword">In</span> <span class="keyword">order</span> <span class="keyword">to</span> allow non-dict objects <span class="keyword">to</span> be serialized <span class="keyword">set</span> the safe parameter <span class="keyword">to</span> <span class="keyword">False</span>.</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(<span class="type">json</span>.loads(json_data), safe=<span class="keyword">False</span>)</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.views.generic <span class="keyword">import</span> View</span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse</span><br><span class="line"><span class="keyword">from</span> django.core <span class="keyword">import</span> serializers</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> goods.models <span class="keyword">import</span> Goods</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GoodsListView</span>(<span class="params">View</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        <span class="comment"># 获取所有商品</span></span><br><span class="line">        goods = Goods.objects.all()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 通过serializers实现商品列表页</span></span><br><span class="line">        json_data = serializers.serialize(<span class="string">'json'</span>, goods)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(json_data, content_type=<span class="string">'application/json'</span>)</span><br></pre></td></tr></tbody></table></figure>

<p>如何序列化模型类<br>在各个应用下面建一个<code>serializers.py</code><br>DRF中封装了<code>Serializer</code>类和<code>ModelSerializer</code>类用于实现序列化操作，<br>通过继承<code>Serializer</code>类或<code>ModelSerializer</code>类，<br>我们可以自定义序列化器，用于将对象处理成字典</p>
<p><code>ModelSerializer</code> 可以将字段转换成json，相比于 <code>Serializer</code>，它省去了模型所有字段的添加和处理数据方法的实现，自动完成与模型中相应字段的映射<br>写法和form表单类的建一个<code>form.py</code>类似，<code>modelform</code> 可以将字段转成html</p>
<h3 id="drf-的序列化作用"><a href="#drf-的序列化作用" class="headerlink" title="drf 的序列化作用"></a>drf 的序列化作用</h3><ul>
<li>验证处理：反序列化中，当前端传递过来的数据放在request.data的时候，要把他转换成模型类实例进行保存到数据表，对前端提交的数据进行验证</li>
<li>验证器的参数</li>
<li>同时序列化多个对象</li>
<li>序列化包含多条数据的查询集加上<code>many=True</code></li>
<li>序列化的过程添加上下文</li>
<li>无限的数据异常处理</li>
</ul>
<p>关系字段的外键字段序列化可以指定遍历的序列化深度<code>depth</code>，如果表结构有子表关联到父表，父表又关联到另外的父表，可以设置深度</p>
<p>字段|字段构造方式<br>BooleanField()<br>CharField(max_length=None, min_length=None, allow_blank=False, trim_whitespace=True)</p>
<p>选项参数|作用<br><code>max_length</code> |最大长度<br><code>min_lenght</code> 最小长度<br><code>allow_blank</code>是否允许为空<br><code>trim_whitespace</code>是否截断空白字符<br><code>max_value</code> 最小值<br><code>min_value</code> 最大值</p>
<p>Serializer fields 通用参数：<br><a target="_blank" rel="noopener" href="https://www.django-rest-framework.org/api-guide/fields/#core-arguments">https://www.django-rest-framework.org/api-guide/fields/#core-arguments</a></p>
<ul>
<li><code>read_only</code> fields are included in the API output, but should not be included in the input during create or update operations.<br>包含在API输出中，但在创建或更新操作期间不应包含在输入中，<br>Any <code>read_only</code> fields that are incorrectly included in the serializer input will be ignored.</li>
</ul>
<p>Set this to <code>True</code> to ensure that the field is used when serializing a representation, but is not used when creating or updating an instance during deserialization. 设置为True以确保序列化输出表示形式时使用该字段，而在反序列化期间创建或更新实例时不使用该字段。只返回而不提交</p>
<p>Defaults to False默认False</p>
<ul>
<li><code>write_only</code><br>Set this to <code>True</code> to ensure that the field may be used when updating or creating an instance, but is not included when serializing the representation. 以确保在更新或创建实例（反序列化输入）时可以使用该字段，但在序列化表示时不包括该字段<br>Defaults to <code>False</code> 默认False</li>
</ul>
<p><code>required</code> 表明该字段在反序列化时必须输入，默认True<br><code>default</code> 反序列化时使用的默认值<br><code>allow_null</code> 该字段是否允许传入None，默认False<br><code>validators</code>该字段使用的验证器<br><code>error_messages</code> 包含错误编号与错误信息的字典<br><code>label</code> 用于HTML展示API页面时，显示的字段名称<br><code>help_text</code> 用于HTML展示API页面时，显示的字段帮助提示信息<br><code>queryset</code> 用作反序列化时参数校验使用</p>
<p>视图函数创建Serializer对象的构造方法为：</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CourseSerializer(instance=course, data=request.data)</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>用于序列化时，将模型类对象传入<code>instance</code>，要序列化的查询集实例，要序列化的 <code>course</code> 是查询出来的实例，把<code>data</code>的数据序列化后保存或跟新到 <code>course</code> 这个对象里面，通过<code>data</code>属性可以获取序列化后的数据</li>
<li>用于反序列化时，将要被反序列化的数据传入<code>data</code>， POST GET BODY来的数据，<code>request.data</code> 是前端传递过来的数据 </li>
<li>还可通过context参数额外添加数据，可以通过Serializer对象的context属性获取。</li>
</ul>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">serializer = AccountSerializer(account, context={<span class="string">'request'</span>: request})</span><br></pre></td></tr></tbody></table></figure>

<h4 id="实现课程信息数据接口"><a href="#实现课程信息数据接口" class="headerlink" title="实现课程信息数据接口"></a>实现课程信息数据接口</h4><p><code>course/serializers.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django <span class="keyword">import</span> forms</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> User</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Course</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># form类这里用不到，只是对比类似的样子</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CourseForm</span>(<span class="params">forms.ModelForm</span>):</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Course</span><br><span class="line">        fields = (<span class="string">'name'</span>, <span class="string">'introduction'</span>, <span class="string">'teacher'</span>, <span class="string">'price'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = User  <span class="comment"># 序列化用户模型类</span></span><br><span class="line">        fields = <span class="string">'__all__'</span>  <span class="comment"># 所有字段</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CourseSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="comment"># teacher是外键关联到用户表，并不是新建过程中新建的一个用户，</span></span><br><span class="line">    <span class="comment"># 法一：详细显示外键老师信息，想得到对应的名字，可以把用户的名称序列化，和使用ORM查询外键关联查询一样，</span></span><br><span class="line">    teacher = serializers.ReadOnlyField(source=<span class="string">'teacher.username'</span>)  <span class="comment"># 序列化模型类中指定字段，外键字段，指定只读字段</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Course  <span class="comment"># 要序列化的模型课程类</span></span><br><span class="line">        <span class="comment"># exclude = ('id', )  # 排除字段</span></span><br><span class="line">        <span class="comment"># fields = ('id', 'name', 'introduction', 'teacher', 'price', 'created_at', 'updated_at')</span></span><br><span class="line">        fields = <span class="string">'__all__'</span>  <span class="comment"># 要序列化的模型字段，模型类所有字段</span></span><br><span class="line">        depth = <span class="number">2</span>  <span class="comment"># 深度</span></span><br></pre></td></tr></tbody></table></figure>

<p>上面的代码直接继承了<code>ModelSerializer</code>，<br>通过<code>Meta</code>类的<code>model</code>属性指定要序列化的模型以及<code>fields</code>属性指定需要序列化的模型字段，</p>
<p>在视图函数中使用该类来实现对<code>Course</code>模型的序列化。</p>
<p>法二</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TeacherSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Teacher  <span class="comment"># 序列化用户模型类</span></span><br><span class="line">        fields = <span class="string">'__all__'</span>  <span class="comment"># 所有字段</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CourseSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    teacher = TeacherSerializer()  <span class="comment"># 详细显示一对一外键老师信息，Serialzer还可以嵌套使用，覆盖外键字段</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Course  <span class="comment"># 要序列化的模型课程类</span></span><br><span class="line">        <span class="comment"># exclude = ('id', )  # 排除字段</span></span><br><span class="line">        <span class="comment"># fields = ('id', 'name', 'introduction', 'teacher', 'price', 'created_at', 'updated_at')</span></span><br><span class="line">        fields = <span class="string">'__all__'</span>  <span class="comment"># 要序列化的模型字段，模型类所有字段</span></span><br><span class="line">        depth = <span class="number">2</span>  <span class="comment"># 深度</span></span><br></pre></td></tr></tbody></table></figure>

<p>实现序列化结果带绝对和相对URL超链接的<code>HyperlinkedModelSerializer</code>的api，在<code>fields</code> 加上 <code>url</code>，不用用于FBV</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Course</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CourseSerializer</span>(<span class="params">serializers.HyperlinkedModelSerializer</span>):</span></span><br><span class="line">    teacher = serializers.ReadOnlyField(source=<span class="string">'teacher.username'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Course  <span class="comment"># 要序列化的模型课程类</span></span><br><span class="line">        <span class="comment"># url是默认值，可在settings.py中设置URL_FIELD_NAME使全局生效</span></span><br><span class="line">        fields = (<span class="string">'id'</span>, <span class="string">'url'</span>, <span class="string">'name'</span>, <span class="string">'introduction'</span>, <span class="string">'teacher'</span>, <span class="string">'price'</span>, <span class="string">'created_at'</span>, <span class="string">'updated_at'</span>)  <span class="comment"># 要序列化的模型字段</span></span><br><span class="line">        exclude = (<span class="string">'subject'</span>, )</span><br></pre></td></tr></tbody></table></figure>

<p>上面的代码直接继承了<code>HyperlinkedModelSerializer</code>，<br>通过<code>Meta</code>类的<code>model</code>属性指定要序列化的模型以及<code>fields</code>属性指定需要序列化的模型字段，<br>稍后我们就可以在视图函数中使用该类来实现对<code>Course</code>模型的序列化。</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@api_view(('GET', ))</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_teachers</span>(<span class="params">request: HttpRequest</span>) -&gt; HttpResponse:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        sno = int(request.GET.get(<span class="string">'sno'</span>))</span><br><span class="line">        subject = Subject.objects.only(<span class="string">'name'</span>).get(no=sno)</span><br><span class="line">        teachers = Teacher.objects.filter(subject=subject).defer(<span class="string">'subject'</span>).order_by(<span class="string">'no'</span>)</span><br><span class="line">        subject_seri = SubjectSimpleSerializer(subject)</span><br><span class="line">        teacher_seri = TeacherSerializer(teachers, many=<span class="literal">True</span>)  <span class="comment"># 一对多</span></span><br><span class="line">        <span class="keyword">return</span> Response({<span class="string">'subject'</span>: subject_seri.data, <span class="string">'teachers'</span>: teacher_seri.data})</span><br><span class="line">    <span class="keyword">except</span> (TypeError, ValueError, Subject.DoesNotExist):</span><br><span class="line">        <span class="keyword">return</span> Response(status=<span class="number">404</span>)</span><br></pre></td></tr></tbody></table></figure>

<h3 id="序列化使用"><a href="#序列化使用" class="headerlink" title="序列化使用"></a>序列化使用</h3><p>1 基本使用</p>
<p>1） 先查询出<strong>一个</strong>图书对象</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> booktest.models <span class="keyword">import</span> BookInfo</span><br><span class="line">book = BookInfo.objects.get(id=<span class="number">2</span>)</span><br></pre></td></tr></tbody></table></figure>

<p>2） 构造序列化器对象</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> booktest.serializers <span class="keyword">import</span> BookInfoSerializer</span><br><span class="line">serializer = BookInfoSerializer(book)</span><br></pre></td></tr></tbody></table></figure>

<p>3）获取序列化数据<br>通过<code>data</code>属性可以获取序列化后的数据</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">serializer.data</span><br><span class="line"><span class="comment"># {'id': 2, 'btitle': '天龙八部', 'bpub_date': '1986-07-24', 'bread': 36, 'bcomment': 40, 'image': None}</span></span><br></pre></td></tr></tbody></table></figure>

<p>4）如果要被序列化的是包含<strong>多条</strong>数据的查询集QuerySet，可以通过添加<code>many=True</code>参数补充说明</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">book_qs = BookInfo.objects.all()</span><br><span class="line">serializer = BookInfoSerializer(book_qs, many=<span class="literal">True</span>)</span><br><span class="line">serializer.data</span><br><span class="line"><span class="comment"># [OrderedDict([('id', 2), ('btitle', '天龙八部'), ('bpub_date', '1986-07-24'), ('bread', 36), ('bcomment', 40), ('image', N]), OrderedDict([('id', 3), ('btitle', '笑傲江湖'), ('bpub_date', '1995-12-24'), ('bread', 20), ('bcomment', 80), ('image'ne)]), OrderedDict([('id', 4), ('btitle', '雪山飞狐'), ('bpub_date', '1987-11-11'), ('bread', 58), ('bcomment', 24), ('ima None)]), OrderedDict([('id', 5), ('btitle', '西游记'), ('bpub_date', '1988-01-01'), ('bread', 10), ('bcomment', 10), ('im', 'booktest/xiyouji.png')])]</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="关联对象嵌套序列化，返回当前类数据和关联模型类的数据"><a href="#关联对象嵌套序列化，返回当前类数据和关联模型类的数据" class="headerlink" title="关联对象嵌套序列化，返回当前类数据和关联模型类的数据"></a>关联对象嵌套序列化，返回当前类数据和关联模型类的数据</h4><p>如果需要序列化的数据中包含有其他关联对象，则对关联对象数据的序列化需要指明。</p>
<ul>
<li><code>PrimaryKeyRelatedField</code> 此字段将被序列化为关联对象的主键，指明字段时需要包含read_only=True或者queryset参数：<br><code>heroinfo_set = serializers.PrimaryKeyRelatedField(read_only=True,many=True)</code></li>
</ul>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 多类</span></span><br><span class="line">hbook = serializers.PrimaryKeyRelatedField(label=<span class="string">'图书'</span>, read_only=<span class="literal">True</span>)</span><br><span class="line"><span class="comment"># 或</span></span><br><span class="line">hbook = serializers.PrimaryKeyRelatedField(label=<span class="string">'图书'</span>, queryset=BookInfo.objects.all())</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 一类</span></span><br><span class="line">heroinfo_set = serializers.PrimaryKeyRelatedField(label=<span class="string">'图书'</span>,read_only=<span class="literal">True</span>, many= <span class="literal">True</span>)</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li><code>StringRelatedField</code> 此字段将被序列化为关联对象的字符串表示方式，关联对象模型类的<code>__str__</code>方法值<br><code>heroinfo_set = serializers.StringRelatedField(read_only=True, many=True)</code></li>
</ul>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 多类</span></span><br><span class="line"> hbook = serializers.StringRelatedField(label=<span class="string">'图书'</span>)</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 一类</span></span><br><span class="line"> heroinfo_set = serializers.StringRelatedField(label=<span class="string">'图书'</span>,read_only=<span class="literal">True</span>, many=<span class="literal">True</span>)</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>在当前的序列化类指定实例化其关联对象序列化器类<br><code>heroinfo_set = HeroInfoSerialzier(many=True)</code></li>
</ul>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 多类</span></span><br><span class="line">hbook = BookInfoSerializer()</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 一类</span></span><br><span class="line">heroinfo_set = HeroInfoSerializer(label=<span class="string">'图书'</span>, many=<span class="literal">True</span>)</span><br></pre></td></tr></tbody></table></figure>

<p>使用效果</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> booktest.serializers <span class="keyword">import</span> HeroInfoSerializer</span><br><span class="line"><span class="keyword">from</span> booktest.models <span class="keyword">import</span> HeroInfo</span><br><span class="line">hero = HeroInfo.objects.get(id=<span class="number">6</span>)</span><br><span class="line">serializer = HeroInfoSerializer(hero)</span><br><span class="line">serializer.data</span><br><span class="line"><span class="comment"># {'id': 6, 'hname': '乔峰', 'hgender': 1, 'hcomment': '降龙十八掌', 'hbook': 2}</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GoodsImageSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="string">'''商品图片'''</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = GoodsImage</span><br><span class="line">        fields = [<span class="string">'image'</span>, ]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GoodsSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="string">'''商品详情序列化'''</span></span><br><span class="line">    <span class="comment"># 关联对象嵌套序列化，返回当前类数据和关联模型类的数据</span></span><br><span class="line">    category = CategorySerializer()  <span class="comment"># 一对一</span></span><br><span class="line">    <span class="comment"># images是数据库中设置的related_name="images"，把商品图嵌套进来</span></span><br><span class="line">    images = GoodsImageSerializer(many=<span class="literal">True</span>)  <span class="comment"># 一对多</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Goods</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br></pre></td></tr></tbody></table></figure><script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/05/05/zhuang-shi-qi/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/05/zhuang-shi-qi/" class="post-title-link" itemprop="url">python装饰器Decorator和java注解annotation</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-05-04 16:21:41" itemprop="dateCreated datePublished" datetime="2021-05-04T16:21:41Z">2021-05-04</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-05-21 16:01:12" itemprop="dateModified" datetime="2021-05-21T16:01:12Z">2021-05-21</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="装饰器"><a href="#装饰器" class="headerlink" title="装饰器"></a>装饰器</h1><ul>
<li>Python中一切皆对象，函数也是对象！</li>
</ul>
<h3 id="函数的这几个特性"><a href="#函数的这几个特性" class="headerlink" title="函数的这几个特性"></a>函数的这几个特性</h3><ul>
<li>可以赋值给其他变量；</li>
<li>可以作为参数传递给其他函数；</li>
<li>可以在内部定义一个函数；</li>
<li>可以当做返回值返回。</li>
</ul>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">f1</span>():</span></span><br><span class="line">    print(<span class="string">'This is a function1'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">f2</span>():</span></span><br><span class="line">    print(<span class="string">'This is a function2'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_current_time</span>(<span class="params">func</span>):</span></span><br><span class="line">    print(<span class="string">"-----"</span>)</span><br><span class="line">    print(time.time())</span><br><span class="line">    func()</span><br><span class="line">    print(<span class="string">"====="</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_spending_time</span>():</span></span><br><span class="line">    print(<span class="string">"*****"</span>)</span><br><span class="line">    print(time.time())</span><br><span class="line">    f1()</span><br><span class="line">    print(<span class="string">"&amp;&amp;&amp;&amp;&amp;"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">print_current_time(f1)</span><br><span class="line">print_current_time(f2)</span><br><span class="line">print_spending_time()</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight asciidoc"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">-----</span><br><span class="line">1620478462.2132251</span><br><span class="line">This is a function1</span><br><span class="line">=====</span><br><span class="line">-----</span><br><span class="line">1620478462.2141893</span><br><span class="line">This is a function2</span><br><span class="line">=====</span><br><span class="line">****<span class="strong">*</span></span><br><span class="line"><span class="strong">1620478462.2141893</span></span><br><span class="line"><span class="strong">This is a function1</span></span><br><span class="line"><span class="strong">&amp;&amp;&amp;&amp;&amp;</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="装饰器-1"><a href="#装饰器-1" class="headerlink" title="装饰器"></a>装饰器</h3><p>装饰器是接收函数作为参数，<br>并在内部定义了一个函数，在这个内部函数中实现了一些功能，并调用了传递进来的函数，<br>最后将内部函数(类)作为返回值返回。</p>
<p>应该先讲python里面函数嵌套，<br>然后再讲嵌套函数的调用，最后讲语法糖的执行过程。<br>装饰器的原理是callable的调用，<br>并且语法糖写一次就call一次，去一层嵌套，<br>这样就能理解为什么装饰器既可以通过函数去实现，也可以通过类去实现，可以叠加，可以带参数</p>
<p>优点</p>
<ul>
<li>在不对被装饰函数做任何修改的前提下，给被装饰函数扩展附加上一些装饰器功能。</li>
<li>不改变被装饰函数的调用方式。</li>
<li>一个函数可以使用多个装饰器  提高代码复用性、代码更加精简。<br>用 <code>@func</code> 使用装饰器需要定义在被装饰函数do_something的前面，<br>将被装饰函数<code>do_something</code>作为参数传递给 <code>func</code> 函数，然后将A函数的返回值重新f给f这个变量名，这就是@语法糖帮我们做的事情，概括来说就是 do_something=func(do_something)()。</li>
</ul>
<p>但是如果有多个函数需要添加开始运行和结束运行的提示功能，如果不用装饰器，那么就需要对每一个函数进行修改，则工作量和需要修改的代码量……用了装饰器之后，只需要在需要添加这一功能的函数前面添加@func就可以了。</p>
<p>Python代码是自上而下依次执行时可以调用上面定义的装饰器</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span>():</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">inner_func</span>():</span></span><br><span class="line">        print(<span class="string">'inner function'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> inner_func</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    fun1 = func()</span><br><span class="line">    fun1()</span><br><span class="line">    <span class="comment"># inner function</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">log</span>(<span class="params">func</span>):</span>  <span class="comment"># 定义一个装饰器，接收一个函数作为参数</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span>():</span></span><br><span class="line">        print(<span class="string">'start...'</span>)</span><br><span class="line">        func()</span><br><span class="line">        print(<span class="string">'end..'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span>():</span></span><br><span class="line">    print(<span class="string">'hello world'</span>)</span><br><span class="line">    print(<span class="string">"hello world"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    hello = log(hello)</span><br><span class="line">    hello()</span><br><span class="line"><span class="comment"># start...</span></span><br><span class="line"><span class="comment"># hello world</span></span><br><span class="line"><span class="comment"># hello world</span></span><br><span class="line"><span class="comment"># end..</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="装饰器无参数"><a href="#装饰器无参数" class="headerlink" title="装饰器无参数"></a>装饰器无参数</h3><h4 id="函数装饰器"><a href="#函数装饰器" class="headerlink" title="函数装饰器"></a>函数装饰器</h4><h5 id="被装饰的函数不带返回值"><a href="#被装饰的函数不带返回值" class="headerlink" title="被装饰的函数不带返回值"></a>被装饰的函数不带返回值</h5><figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">print(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">log</span>(<span class="params">func</span>):</span>  <span class="comment"># 定义一个装饰器，接收一个函数作为参数</span></span><br><span class="line">    print(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span>():</span></span><br><span class="line">        print(<span class="string">'start...'</span>)</span><br><span class="line">        func()</span><br><span class="line">        print(<span class="string">'end..'</span>)</span><br><span class="line"></span><br><span class="line">    print(<span class="number">3</span>)</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">print(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">log_in</span>(<span class="params">func</span>):</span></span><br><span class="line">    print(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper1</span>():</span></span><br><span class="line">        print(<span class="string">'begin...'</span>)</span><br><span class="line">        func()</span><br><span class="line">        print(<span class="string">'over..'</span>)</span><br><span class="line"></span><br><span class="line">    print(<span class="number">6</span>)</span><br><span class="line">    <span class="keyword">return</span> wrapper1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">print(<span class="number">7</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 两个装饰器</span></span><br><span class="line"><span class="meta">@log  # log(log_in(do_something))</span></span><br><span class="line"><span class="meta">@log_in  # log_in(do_something) 先执行获取返回值作为参数传递给`func`</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_something</span>():</span>  <span class="comment"># 没有返回值</span></span><br><span class="line">    print(<span class="string">'test ..'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    print(<span class="number">9</span>)</span><br><span class="line">    do_something()</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight gams"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="number">7</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">6</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">9</span></span><br><span class="line"><span class="function"><span class="title">start</span></span>...</span><br><span class="line"><span class="function"><span class="title">begin</span></span>...</span><br><span class="line"><span class="function"><span class="title">test</span></span> ..</span><br><span class="line"><span class="function"><span class="title">over</span></span>..</span><br><span class="line"><span class="function"><span class="title">end</span></span>..</span><br></pre></td></tr></tbody></table></figure>
<p>将 <code>do_something</code> 方法作为参数传递给 <code>log</code> 方法，<br>在 <code>log</code> 方法内部我们定义了一个 <code>wrapper</code> 方法，并在这个方法中添加了函数开始执行和结束执行的提示，<br>在 <code>log</code> 方法最后，我们将 <code>wrapper</code> 作为参数返回，<br>重新将 <code>log</code> 函数的返回值赋给了 <code>do_something</code></p>
<p>最后一行我们再次调用的 <code>do_something</code> 方法已经不再是最初的 <code>do_something</code> 函数，<br>而是 <code>log</code> 方法内定义的 <code>wrapper</code> 函数，<br>所以最后执行 <code>do_something</code> 函数时，会有函数开始执行和结束执行的提示功能，<br>而后面再调用 <code>do_something</code> 函数时，也都直接使用 <code>do_something()</code> 。</p>
<p>在上面代码中，我们同时用 <code>log</code> 和 <code>log_in</code> 两个装饰器来装饰 <code>do_something</code> ，从运行结果中可以看出，两个装饰器都发挥了作用。同时，为了方便大家理解，我们使用不带@符号的来使用两个装饰器装饰，两者运行结果是一样的，结合代码中的输出标记，我们来分析一下装饰器的执行过程：<br>开始运行后，1-&gt;4-&gt;7这几个过程我相信大家都是可以理解的，到了位置7后，遇到了<code>@</code>符号标识的装饰器，而且是多层的，两个@装饰器相当于 <code>log(log_in(do_something))</code> ，所以是先执行<code>log_in</code>函数获取返回值作为参数传递给<code>log</code>，所以有了7之后是5-&gt;6，<code>log_in</code> 函数返回值是 <code>wrapper1</code> 函数，这时候就相当于 <code>log(wrapper1)</code>，所以程序退出 <code>log_in</code> 函数后进入 <code>log</code> 函数，就有了2-&gt;3, 从 <code>func</code> 函数返回后，继续向下执行遇到位置8，然后就进入了主函数运行，所以是8-&gt;9，此时的函数是被装饰过的，本质已经是 <code>func</code> 函数返回的 <code>wrapper</code> 函数了，所以最终在主函数中执行 <code>do_something</code> 时执行的是 <code>wrapper</code> 方法，所以先输出了 <code>log</code> 装饰器的函数开始提示，然后才是 <code>log_in</code> 装饰器的计时开始提示。</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">timmer</span>(<span class="params">f</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">inner_func</span>():</span></span><br><span class="line">        start_time = time.time()</span><br><span class="line">        f()</span><br><span class="line">        end_time = time.time()</span><br><span class="line">        print(<span class="string">'{}函数运行消耗时间为：{}'</span>.format(f.__name__, end_time - start_time))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> inner_func</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@timmer</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_something</span>():</span></span><br><span class="line">    print(<span class="string">'do_something函数运行……'</span>)</span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    do_something()</span><br><span class="line"><span class="comment"># do_something函数运行……</span></span><br><span class="line"><span class="comment"># do_something函数运行消耗时间为：1.0039458274841309</span></span><br></pre></td></tr></tbody></table></figure>

<h5 id="被装饰的函数带返回值"><a href="#被装饰的函数带返回值" class="headerlink" title="被装饰的函数带返回值"></a>被装饰的函数带返回值</h5><p>被装饰的函数的返回值只需要通过装饰器内部定义的 <code>wrapper</code> 函数返回返回。<br>装饰器也是可以多层嵌套使用的，<br>一个函数可以通过是被多个装饰器所装饰，执行顺序是从下到上的优先顺序加载装饰：</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">log</span>(<span class="params">func</span>):</span>  <span class="comment"># 定义一个装饰器，接收一个函数作为参数</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span>():</span></span><br><span class="line">        print(<span class="string">'start...'</span>)</span><br><span class="line">        ret = func()  <span class="comment"># 内部函数返回值</span></span><br><span class="line">        print(<span class="string">'end..'</span>)</span><br><span class="line">        <span class="keyword">return</span> ret  <span class="comment"># 内部函数返回值</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">log_in</span>(<span class="params">func</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span>():</span></span><br><span class="line">        print(<span class="string">'开始进入...'</span>)</span><br><span class="line">        ret = func()  <span class="comment"># 内部函数返回值</span></span><br><span class="line">        print(<span class="string">'结束..'</span>)</span><br><span class="line">        <span class="keyword">return</span> ret  <span class="comment"># 内部函数返回值</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 两个装饰器</span></span><br><span class="line"><span class="meta">@log  # 原理是 do_something = log(hello)，传入一个func指向 do_something</span></span><br><span class="line"><span class="comment"># 我们后面再调用的时候实际上调用的是log，返回一个新的函数</span></span><br><span class="line"><span class="meta">@log_in  # 原理是 do_something = log_in(hello),func指向do_something</span></span><br><span class="line"><span class="comment"># 我们后面再调用的时候实际上调用的是log_in</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_something</span>():</span>  <span class="comment"># 没有返回值</span></span><br><span class="line">    print(<span class="string">'test ..'</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'被装饰器函数有返回值return value'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    ret = do_something()</span><br><span class="line">    <span class="comment"># start...</span></span><br><span class="line">    <span class="comment"># 开始进入...</span></span><br><span class="line">    <span class="comment"># test ..</span></span><br><span class="line">    <span class="comment"># 结束..</span></span><br><span class="line">    <span class="comment"># end..</span></span><br><span class="line">    print(ret)</span><br><span class="line">    <span class="comment"># 被装饰器函数有返回值return value</span></span><br></pre></td></tr></tbody></table></figure>
<p>被装饰后的 <code>do_something</code> 函数其实不再是最初的 <code>do_something</code> 函数，而是装饰器内部定义的 <code>wrapper</code> 函数，</p>
<h3 id="被装饰函数带参数"><a href="#被装饰函数带参数" class="headerlink" title="被装饰函数带参数"></a>被装饰函数带参数</h3><h4 id="函数装饰器-1"><a href="#函数装饰器-1" class="headerlink" title="函数装饰器"></a>函数装饰器</h4><p>以上面的装饰器 <code>log</code> 和被装饰函数 <code>do_something</code> 为例，<br>被装饰后的 <code>do_something</code> 函数已经不再是原来的 <code>do_something</code> 函数，<br>而是装饰器内部的 <code>wrapper</code> _ <code>log</code> 函数。<br>这句话我已经在上文中我已经不止提过一次，因为真的很重要。<br>如果被装饰的函数有参数（加入参数为<code>name</code>），我们还是通过 <code>do_something(name)</code> 的方式传递传输，<br>不过，既然我们最终调用的时候，通过 <code>do_something</code> 实质调用的 <code>wrapper</code> 函数，<br>那么在定义装饰器是，定义的 <code>wrapper</code> 接受和原函数一样的参数如</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span>(<span class="params">f</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span>(<span class="params">name</span>):</span>  <span class="comment"># 接受参数</span></span><br><span class="line">        print(<span class="string">'{} start……'</span>.format(f.__name__))</span><br><span class="line">        ret = f(name)  <span class="comment"># 接受参数</span></span><br><span class="line">        print(<span class="string">'{} end……'</span>.format(f.__name__))</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@func</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_something</span>(<span class="params">name</span>):</span></span><br><span class="line">    print(<span class="string">'Hi，{}！'</span>.format(name))</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'return value'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    ret = do_something(<span class="string">'ashe'</span>)</span><br><span class="line">    <span class="comment"># do_something start……</span></span><br><span class="line">    <span class="comment"># Hi，ashe！</span></span><br><span class="line">    <span class="comment"># do_something end……</span></span><br><span class="line">    print(ret)</span><br><span class="line">    <span class="comment"># return value</span></span><br></pre></td></tr></tbody></table></figure>

<p>一个装饰器可用于装饰千千万万个函数，则千千万万个函数参数情况可能各不相同，<br>有的没有参数，有的可能多个参数，甚至还有关键字参数，<br>对于这参数情况不同的函数，我们不可能为每个函数都写一个func装饰器，那怎么办呢？</p>
<p>Python中提供了<code>*args</code>， <code>**kwargs</code> 这种机制来接受任意位置的位置参数和关键字参数，<br>参数前面带<code>*</code>表示接受任意个数位置参数，接收到的所有位置参数存储在变量名为<code>args</code>的元组中，<br>带<code>**</code>表示接受任意个数的关键字参数，接收到的所有关键字参数以字典的形式参数在变量名为<code>kwargs</code>的字典中。</p>
<p>当我们知道被装饰器函数只有位置参数，但不知道有多少个位置参数是func装饰器可以这么写：</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span>(<span class="params">f</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span>(<span class="params">*name</span>):</span>  <span class="comment"># 接受位置参数，也就是*args</span></span><br><span class="line">        print(<span class="string">'{} start……'</span>.format(f.__name__))</span><br><span class="line">        ret = f(*name)  <span class="comment"># 接受位置参数</span></span><br><span class="line">        print(<span class="string">'{} end……'</span>.format(f.__name__))</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"><span class="meta">@func</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_something</span>(<span class="params">name</span>):</span></span><br><span class="line">    print(<span class="string">'hello {}!'</span>.format(name))</span><br><span class="line"></span><br><span class="line"><span class="meta">@func</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_something_2</span>(<span class="params">name_1, name_2</span>):</span></span><br><span class="line">    print(<span class="string">'hello {}!'</span>.format(name_1))</span><br><span class="line">    print(<span class="string">'hello {}!'</span>.format(name_2))</span><br><span class="line"></span><br><span class="line"><span class="meta">@func</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_something_3</span>(<span class="params">*name</span>):</span>  <span class="comment"># 接受*参数</span></span><br><span class="line">    <span class="keyword">for</span> n <span class="keyword">in</span> name:</span><br><span class="line">        print(<span class="string">'hello {}!'</span>.format(n))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    do_something(<span class="string">'ashe'</span>)</span><br><span class="line">    print(<span class="string">'-------------------------------'</span>)</span><br><span class="line">    do_something_2(<span class="string">'jack'</span>, <span class="string">'rose'</span>)</span><br><span class="line">    print(<span class="string">'-------------------------------'</span>)</span><br><span class="line">    do_something_3(<span class="string">'one'</span>, <span class="string">'two'</span>, <span class="string">'three'</span>, <span class="string">'four'</span>)</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">do_something</span> <span class="string">start……</span></span><br><span class="line"><span class="attr">hello</span> <span class="string">ashe!</span></span><br><span class="line"><span class="attr">do_something</span> <span class="string">end……</span></span><br><span class="line"><span class="attr">-------------------------------</span></span><br><span class="line"><span class="attr">do_something_2</span> <span class="string">start……</span></span><br><span class="line"><span class="attr">hello</span> <span class="string">jack!</span></span><br><span class="line"><span class="attr">hello</span> <span class="string">rose!</span></span><br><span class="line"><span class="attr">do_something_2</span> <span class="string">end……</span></span><br><span class="line"><span class="attr">-------------------------------</span></span><br><span class="line"><span class="attr">do_something_3</span> <span class="string">start……</span></span><br><span class="line"><span class="attr">hello</span> <span class="string">one!</span></span><br><span class="line"><span class="attr">hello</span> <span class="string">two!</span></span><br><span class="line"><span class="attr">hello</span> <span class="string">three!</span></span><br><span class="line"><span class="attr">hello</span> <span class="string">four!</span></span><br><span class="line"><span class="attr">do_something_3</span> <span class="string">end……</span></span><br></pre></td></tr></tbody></table></figure>
<p>上面例子定义 <code>func</code> 装饰器时，我们用 <code>*name</code> 来接受任意个数的位置参数，<br>可别以为只能用 <code>*args</code>，<code>args</code>只是一个变量名，只不过约定俗成，用的多一些，实际开发时你爱取啥名就用啥名，</p>
<p>当我们知道被装饰器函数只有关键字参数，却不知道参数个数时，可以 <code>func</code> 装饰器这么写：</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span>(<span class="params">f</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">inner_func</span>(<span class="params">**name</span>):</span>  <span class="comment"># 接受关键字参数，也就是**kwargs</span></span><br><span class="line">        print(<span class="string">'{} start……'</span>.format(f.__name__))</span><br><span class="line">        ret = f(**name)  <span class="comment"># 接受关键字参数，也就是**kwargs</span></span><br><span class="line">        print(<span class="string">'{} end……'</span>.format(f.__name__))</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> inner_func</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@func</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_something</span>(<span class="params">name=<span class="string">'None'</span></span>):</span></span><br><span class="line">    print(<span class="string">'hello {}！'</span>.format(name))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@func</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_something_2</span>(<span class="params">name_1=<span class="string">'None'</span>, name_2=<span class="string">'None'</span></span>):</span></span><br><span class="line">    print(<span class="string">'hello {}！'</span>.format(name_1))</span><br><span class="line">    print(<span class="string">'hello {}！'</span>.format(name_2))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@func</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_something_3</span>(<span class="params">**name</span>):</span>  <span class="comment"># 接受关键字参数，也就是**kwargs</span></span><br><span class="line">    <span class="keyword">for</span> n <span class="keyword">in</span> name.keys():</span><br><span class="line">        print(<span class="string">'hello {}！'</span>.format(name[n]))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    do_something(name=<span class="string">'ashe'</span>)</span><br><span class="line">    print(<span class="string">'-------------------------------'</span>)</span><br><span class="line">    do_something_2(name_1=<span class="string">'jack'</span>, name_2=<span class="string">'rose'</span>)</span><br><span class="line">    print(<span class="string">'-------------------------------'</span>)</span><br><span class="line">    do_something_3(name_1=<span class="string">'one'</span>, name_2=<span class="string">'two'</span>, name_3=<span class="string">'three'</span>, name_4=<span class="string">'four'</span>)</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">do_something</span> <span class="string">start……</span></span><br><span class="line"><span class="attr">hello</span> <span class="string">ashe！</span></span><br><span class="line"><span class="attr">do_something</span> <span class="string">end……</span></span><br><span class="line"><span class="attr">-------------------------------</span></span><br><span class="line"><span class="attr">do_something_2</span> <span class="string">start……</span></span><br><span class="line"><span class="attr">hello</span> <span class="string">jack！</span></span><br><span class="line"><span class="attr">hello</span> <span class="string">rose！</span></span><br><span class="line"><span class="attr">do_something_2</span> <span class="string">end……</span></span><br><span class="line"><span class="attr">-------------------------------</span></span><br><span class="line"><span class="attr">do_something_3</span> <span class="string">start……</span></span><br><span class="line"><span class="attr">hello</span> <span class="string">one！</span></span><br><span class="line"><span class="attr">hello</span> <span class="string">two！</span></span><br><span class="line"><span class="attr">hello</span> <span class="string">three！</span></span><br><span class="line"><span class="attr">hello</span> <span class="string">four！</span></span><br><span class="line"><span class="attr">do_something_3</span> <span class="string">end……</span></span><br></pre></td></tr></tbody></table></figure>

<p>事实上，大多数情况下，我们对被装饰函数是一无所知的——我们不知道有多少个位置参数、多少个关键字参数，甚至对有没有位置参数、关键字参数都不知道，这时候，我们就只能*args和**kwargs齐上阵了，装饰器就可以用于任意目标函数了.</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span>(<span class="params">f</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">inner_func</span>(<span class="params">*name1, **name2</span>):</span>  <span class="comment"># 接受位置*args和关键字参数**kwargs</span></span><br><span class="line">        print(<span class="string">'{} start……'</span>.format(f.__name__))</span><br><span class="line">        ret = f(*name1, **name2)  <span class="comment"># 接受位置*args和关键字参数**kwargs</span></span><br><span class="line">        print(<span class="string">'{} end……'</span>.format(f.__name__))</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> inner_func</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@func</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_something</span>(<span class="params">name</span>):</span></span><br><span class="line">    print(<span class="string">'hello {}！'</span>.format(name))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@func</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_something_2</span>(<span class="params">name_1, name_2=<span class="string">'None'</span></span>):</span></span><br><span class="line">    print(<span class="string">'hello {}！'</span>.format(name_1))</span><br><span class="line">    print(<span class="string">'hello {}！'</span>.format(name_2))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@func</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_something_3</span>(<span class="params">*name1, **name2</span>):</span>  <span class="comment"># 接受位置*args和关键字参数**kwargs</span></span><br><span class="line">    <span class="keyword">for</span> n <span class="keyword">in</span> name1:</span><br><span class="line">        print(<span class="string">'hello {}！'</span>.format(n))</span><br><span class="line">    <span class="keyword">for</span> n <span class="keyword">in</span> name2.keys():</span><br><span class="line">        print(<span class="string">'hello {}！'</span>.format(name2[n]))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    do_something(name=<span class="string">'ashe'</span>)</span><br><span class="line">    print(<span class="string">'-------------------------------'</span>)</span><br><span class="line">    do_something_2(name_1=<span class="string">'jack'</span>, name_2=<span class="string">'rose'</span>)</span><br><span class="line">    print(<span class="string">'-------------------------------'</span>)</span><br><span class="line">    do_something_3(<span class="string">'one'</span>, <span class="string">'two'</span>, <span class="string">'three'</span>, name_4=<span class="string">'four'</span>)</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">do_something</span> <span class="string">start……</span></span><br><span class="line"><span class="attr">hello</span> <span class="string">ashe！</span></span><br><span class="line"><span class="attr">do_something</span> <span class="string">end……</span></span><br><span class="line"><span class="attr">-------------------------------</span></span><br><span class="line"><span class="attr">do_something_2</span> <span class="string">start……</span></span><br><span class="line"><span class="attr">hello</span> <span class="string">jack！</span></span><br><span class="line"><span class="attr">hello</span> <span class="string">rose！</span></span><br><span class="line"><span class="attr">do_something_2</span> <span class="string">end……</span></span><br><span class="line"><span class="attr">-------------------------------</span></span><br><span class="line"><span class="attr">do_something_3</span> <span class="string">start……</span></span><br><span class="line"><span class="attr">hello</span> <span class="string">one！</span></span><br><span class="line"><span class="attr">hello</span> <span class="string">two！</span></span><br><span class="line"><span class="attr">hello</span> <span class="string">three！</span></span><br><span class="line"><span class="attr">hello</span> <span class="string">four！</span></span><br><span class="line"><span class="attr">do_something_3</span> <span class="string">end……</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">print(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span>(<span class="params">f</span>):</span></span><br><span class="line">    print(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">inner_func</span>(<span class="params">*name1, **name2</span>):</span></span><br><span class="line">        print(<span class="string">'{} start……'</span>.format(f.__name__))</span><br><span class="line">        f(*name1, **name2)</span><br><span class="line">        print(<span class="string">'{} end……'</span>.format(f.__name__))</span><br><span class="line"></span><br><span class="line">    print(<span class="number">3</span>)</span><br><span class="line">    <span class="keyword">return</span> inner_func</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">print(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">timmer</span>(<span class="params">f</span>):</span></span><br><span class="line">    print(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">inner_timmer</span>(<span class="params">*args, **kwargs</span>):</span></span><br><span class="line">        print(<span class="string">'start ……'</span>)</span><br><span class="line">        start_time = time.time()</span><br><span class="line">        f(*args, **kwargs)</span><br><span class="line">        end_time = time.time()</span><br><span class="line">        print(<span class="string">'end ……'</span>)</span><br><span class="line">        time_cost = end_time - start_time</span><br><span class="line">        print(<span class="string">'{}runtime：{}s'</span>.format(f.__name__, time_cost))</span><br><span class="line"></span><br><span class="line">    print(<span class="number">6</span>)</span><br><span class="line">    <span class="keyword">return</span> inner_timmer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">print(<span class="number">7</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@func  # func(timmer(do_something))</span></span><br><span class="line"><span class="meta">@timmer  # timmer(do_something)) 先执行获取返回值作为参数传递给`func`</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_something</span>(<span class="params">name</span>):</span></span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line">    print(<span class="string">'hi {}！'</span>.format(name))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">print(<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_something_2</span>(<span class="params">name</span>):</span></span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line">    print(<span class="string">'hello {}！'</span>.format(name))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    print(<span class="number">9</span>)</span><br><span class="line">    do_something(name=<span class="string">'ashe'</span>)</span><br><span class="line">    print(<span class="string">'-------------------------'</span>)</span><br><span class="line">    func(timmer(do_something_2))(name=<span class="string">'ashe'</span>)  <span class="comment"># 执行效果与上面使用了@符号的do_something一样</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight angelscript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="number">7</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">6</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">8</span></span><br><span class="line"><span class="number">9</span></span><br><span class="line">inner_timmer start……</span><br><span class="line">start ……</span><br><span class="line">hi ashe！</span><br><span class="line">end ……</span><br><span class="line">do_somethingruntime：<span class="number">1.010812520980835</span>s</span><br><span class="line">inner_timmer end……</span><br><span class="line">-------------------------</span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">6</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line">inner_timmer start……</span><br><span class="line">start ……</span><br><span class="line">hello ashe！</span><br><span class="line">end ……</span><br><span class="line">do_something_2runtime：<span class="number">1.0115690231323242</span>s</span><br><span class="line">inner_timmer end……</span><br></pre></td></tr></tbody></table></figure>

<p>在上面代码中，我们同时用 <code>func</code> 和 <code>timmer</code> 两个装饰器来装饰 <code>do_something</code> ，从运行结果中可以看出，两个装饰器都发挥了作用。同时，为了方便大家理解，我们使用不带@符号的来使用两个装饰器装饰，两者运行结果是一样的，结合代码中的输出标记，我们来分析一下装饰器的执行过程：<br>开始运行后，1-&gt;4-&gt;7这几个过程我相信大家都是可以理解的，到了位置7后，遇到了<code>@</code>符号标识的装饰器，而且是多层的，两个@装饰器相当于 <code>func(timmer(do_something))</code> ，所以是先执行<code>timmer</code>函数获取返回值作为参数传递给<code>func</code>，所以有了7之后是5-&gt;6，<code>timmer</code> 函数返回值是 <code>inner_timmer</code> 函数，这时候就相当于 <code>func(inner_timmer)</code>,所以程序退出 <code>timmer</code> 函数后进入 <code>func</code> 函数，就有了2-&gt;3, 从 <code>func</code> 函数返回后，继续向下执行遇到位置8，然后就进入了主函数运行，所以是8-&gt;9，此时的函数是被装饰过的，本质已经是 <code>func</code> 函数返回的 <code>inner_func</code> 函数了，所以最终在主函数中执行 <code>do_something</code> 时执行的是 <code>inner_func</code> 方法，所以先输出了 <code>func</code> 装饰器的函数开始提示，然后才是 <code>timmer</code> 装饰器的计时开始提示。</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">runtime</span>(<span class="params">function</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_now_time</span>():</span></span><br><span class="line">        print(time.time())</span><br><span class="line">        function()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> get_now_time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@runtime  # 原理是 run = runtime(run),function指向hrun</span></span><br><span class="line"><span class="comment"># 我们后面再调用的时候实际上调用的是runtime</span></span><br><span class="line"><span class="comment"># 对没有参数的函数进行修饰</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span>():</span></span><br><span class="line">    print(<span class="string">"run"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># run()</span></span><br><span class="line"><span class="comment"># 1620465298.2641926</span></span><br><span class="line"><span class="comment"># run</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">runtime1</span>(<span class="params">function</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_now_time</span>(<span class="params">*args</span>):</span></span><br><span class="line">        print(time.time())</span><br><span class="line">        function(*args)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> get_now_time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@runtime1  # 等价 runtime1(run1(num)),run1(num)</span></span><br><span class="line"><span class="comment"># 对有参数的函数进行修饰</span></span><br><span class="line"><span class="comment"># 我们后面再调用的时候实际上调用的是runtime1，有一个参数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run1</span>(<span class="params">i</span>):</span>  <span class="comment"># 接收参数</span></span><br><span class="line">    print(i)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># run1(1)  # 没有关键字</span></span><br><span class="line"><span class="comment"># 1620474262.3885152</span></span><br><span class="line"><span class="comment"># 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># run1(1, 2)</span></span><br><span class="line"><span class="comment"># 1620474262.3885152</span></span><br><span class="line"><span class="comment"># 1 2</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">runtime2</span>(<span class="params">function</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_now_time</span>(<span class="params">**kwargs</span>):</span></span><br><span class="line">        print(time.time())</span><br><span class="line">        function(**kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> get_now_time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@runtime2</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run2</span>(<span class="params">i</span>):</span>  <span class="comment"># TypeError: run2() got an unexpected keyword argument 'a'</span></span><br><span class="line">    print(i)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># run2(a="aaa")  # 关键字 run2()参数改为a才能run</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">runtime3</span>(<span class="params">function</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_now_time</span>(<span class="params">**kwargs</span>):</span></span><br><span class="line">        print(time.time())</span><br><span class="line">        function(**kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> get_now_time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@runtime3</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run3</span>(<span class="params">a</span>):</span></span><br><span class="line">    print(a)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># run3(a="aaa")  # 关键字参数</span></span><br><span class="line"><span class="comment"># 1620475923.927753</span></span><br><span class="line"><span class="comment"># aaa</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">runtime4</span>(<span class="params">function</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_now_time</span>(<span class="params">**kwargs</span>):</span></span><br><span class="line">        print(time.time())</span><br><span class="line">        function(**kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> get_now_time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@runtime4</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run4</span>(<span class="params">**kwargs</span>):</span></span><br><span class="line">    print(kwargs)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">run4(a=<span class="string">"aaa"</span>)  <span class="comment"># 关键字参数a</span></span><br><span class="line"><span class="comment"># 1620474662.7461288</span></span><br><span class="line"><span class="comment"># {'a': 'aaa'}</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">runtime5</span>(<span class="params">function</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_now_time</span>(<span class="params">name, **kwargs</span>):</span></span><br><span class="line">        print(time.time())</span><br><span class="line">        function(name, **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> get_now_time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@runtime5</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run5</span>(<span class="params">name, **kwargs</span>):</span></span><br><span class="line">    print(<span class="string">"名字=="</span>, name)</span><br><span class="line">    print(kwargs)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">run5(<span class="string">"ashe"</span>, a=<span class="string">"haha"</span>)  <span class="comment"># 混合参数，不指定名字和指定名字</span></span><br><span class="line"><span class="comment"># 1620477386.161594</span></span><br><span class="line"><span class="comment"># 名字== ashe</span></span><br><span class="line"><span class="comment"># {'a': 'haha'}</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">runtime6</span>(<span class="params">function</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_now_time</span>(<span class="params">*args, **kwargs</span>):</span></span><br><span class="line">        print(time.time())</span><br><span class="line">        function(*args, **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> get_now_time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@runtime6</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run6</span>(<span class="params">*args, **kwargs</span>):</span></span><br><span class="line">    print(<span class="string">"名字=="</span>, *args)</span><br><span class="line">    print(kwargs)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">run6(<span class="string">"ashe"</span>, a=<span class="string">"haha"</span>)  <span class="comment"># 混合参数，不指定名字和指定名字</span></span><br><span class="line"><span class="comment"># 1620477386.161594</span></span><br><span class="line"><span class="comment"># 名字== ashe</span></span><br><span class="line"><span class="comment"># {'a': 'haha'}</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设计一个decorator，它可作用于任何函数上，并打印该函数的执行时间：</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">metric</span>(<span class="params">fn</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wapper</span>(<span class="params">*args, **kw</span>):</span></span><br><span class="line">        start = time.time()</span><br><span class="line">        ret = fn(*args, **kw)</span><br><span class="line">        end = time.time()</span><br><span class="line">        print(<span class="string">'%s executed in %s ms'</span> % (fn.__name__, (end - start)))</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> wapper</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试</span></span><br><span class="line"><span class="meta">@metric  # fast = metric(fast)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fast</span>(<span class="params">x, y</span>):</span></span><br><span class="line">    time.sleep(<span class="number">0.0012</span>)</span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@metric  # slow = metric(slow)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">slow</span>(<span class="params">x, y, z</span>):</span></span><br><span class="line">    time.sleep(<span class="number">0.1234</span>)</span><br><span class="line">    <span class="keyword">return</span> x * y * z</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">f = fast(<span class="number">11</span>, <span class="number">22</span>)</span><br><span class="line">s = slow(<span class="number">11</span>, <span class="number">22</span>, <span class="number">33</span>)</span><br><span class="line"><span class="keyword">if</span> f != <span class="number">33</span>:</span><br><span class="line">    print(<span class="string">'测试失败!'</span>)</span><br><span class="line"><span class="keyword">elif</span> s != <span class="number">7986</span>:</span><br><span class="line">    print(<span class="string">'测试失败!'</span>)</span><br><span class="line"><span class="comment"># fast executed in 0.010969400405883789 ms</span></span><br><span class="line"><span class="comment"># slow executed in 0.1256706714630127 ms</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="装饰器本身带参数"><a href="#装饰器本身带参数" class="headerlink" title="装饰器本身带参数"></a>装饰器本身带参数</h3><p>我们上面写的装饰器都没有参数，或者说只有一个自带参数，也就是被装饰函数<code>f</code>。<br>其实，装饰器也是可以有其他参数的，这样的装饰器更加灵活。<br>我们通过实例来说明：现在我们要对上面的<code>func</code>装饰器进行改进，<br>需要做到灵活控制装饰器是用中文输出还是用英文输出，代码如下。</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">language</span>(<span class="params">lang=<span class="string">'Chinese'</span></span>):</span>  <span class="comment"># 这里带参数</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">func</span>(<span class="params">f</span>):</span>  <span class="comment"># 往里嵌套了一层</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">inner_func</span>(<span class="params">*name1, **name2</span>):</span></span><br><span class="line">            <span class="keyword">if</span> lang == <span class="string">'Chinese'</span>:</span><br><span class="line">                print(<span class="string">'{} start……'</span>.format(f.__name__))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                print(<span class="string">'The function of {} starts running…'</span>.format(f.__name__))</span><br><span class="line">            ret = f(*name1, **name2)</span><br><span class="line">            <span class="keyword">if</span> lang == <span class="string">'Chinese'</span>:</span><br><span class="line">                print(<span class="string">'{} end……'</span>.format(f.__name__))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                print(<span class="string">'The function of {} ends running…'</span>.format(f.__name__))</span><br><span class="line">            <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> inner_func</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> func</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@language('Chinese')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_something</span>(<span class="params">name</span>):</span></span><br><span class="line">    print(<span class="string">'hello {}！'</span>.format(name))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@language('English')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_something_2</span>(<span class="params">name</span>):</span></span><br><span class="line">    print(<span class="string">'hello {}！'</span>.format(name))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    do_something(name=<span class="string">'ashe'</span>)</span><br><span class="line">    print(<span class="string">'-------------------------'</span>)</span><br><span class="line">    do_something_2(name=<span class="string">'ashe'</span>)</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight livecodeserver"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">do_something <span class="built_in">start</span>……</span><br><span class="line">hello ashe！</span><br><span class="line">do_something <span class="keyword">end</span>……</span><br><span class="line"><span class="comment">-------------------------</span></span><br><span class="line">The <span class="function"><span class="keyword">function</span> <span class="title">of</span> <span class="title">do_something_2</span> <span class="title">starts</span> <span class="title">running</span>…</span></span><br><span class="line">hello ashe！</span><br><span class="line">The <span class="function"><span class="keyword">function</span> <span class="title">of</span> <span class="title">do_something_2</span> <span class="title">ends</span> <span class="title">running</span>…</span></span><br></pre></td></tr></tbody></table></figure>

<p>通过装饰器带参数的方式，我们只需要在定义被装饰函数时，指定装饰器参数，就可以灵活控制每个被装饰函数提示的语言。</p>
<p>当然，必须承认，装饰器带参数后，看起来更加复杂，需要多嵌套一层函数，由最外层的函数接受参数，里层函数才是真正的装饰器。使用装饰器时，会首先运行带参数的最外层函数，返回装饰器，这一步Python会自动帮我们完成。所以，带参数的装饰器甚至可以这么使用：</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">h = language(<span class="string">'Chinese'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@h</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_something</span>(<span class="params">name</span>):</span></span><br><span class="line">    print(<span class="string">'hello {}！'</span>.format(name))</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> functools</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">log</span>(<span class="params">fn1, *args</span>):</span></span><br><span class="line">    <span class="comment"># 如果是带参装饰器，则传入的fn1一定是装饰器括号内的参数，如字符串等，</span></span><br><span class="line">    <span class="comment"># 因此if下为两层函数，加上最外层的函数，与一般的带参装饰器的三层函数一样运行。</span></span><br><span class="line">    <span class="keyword">if</span> isinstance(fn1, str):</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">decorator</span>(<span class="params">fn</span>):</span></span><br><span class="line"><span class="meta">            @functools.wraps(fn)</span></span><br><span class="line">            <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span>(<span class="params">*args, **kw</span>):</span></span><br><span class="line">                print(<span class="string">'%s %s():'</span> % (fn1, fn.__name__))</span><br><span class="line">                fn(*args, **kw)</span><br><span class="line">                print(<span class="string">'end call %s'</span> % fn.__name__)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> decorator</span><br><span class="line">    <span class="comment"># 如果是不带参数的装饰器，那么最先被传入的fn1必定是函数，</span></span><br><span class="line">    <span class="comment"># 函数是不会被判断成字符串类型的，所以else下只有一层函数再加上最外层的函数，</span></span><br><span class="line">    <span class="comment"># 一共为两层函数，运行时与不带参的装饰器一样运行。</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line"></span><br><span class="line"><span class="meta">        @functools.wraps(fn1)</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span>(<span class="params">*args, **kw</span>):</span></span><br><span class="line">            print(<span class="string">'begin call %s():'</span> % fn1.__name__)</span><br><span class="line">            fn1(*args, **kw)</span><br><span class="line">            print(<span class="string">'end call %s'</span> % fn1.__name__)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@log  # now = wrapper(now)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">now</span>():</span></span><br><span class="line">    print(<span class="string">'2021-3-25'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">now()</span><br><span class="line"><span class="comment"># begin call now():</span></span><br><span class="line"><span class="comment"># 2021-3-25</span></span><br><span class="line"><span class="comment"># end call now</span></span><br><span class="line">print()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@log('execute')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">now2</span>():</span></span><br><span class="line">    print(<span class="string">'2021-5-08'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">now2()</span><br><span class="line"><span class="comment"># execute now2():</span></span><br><span class="line"><span class="comment"># 2021-5-08</span></span><br><span class="line"><span class="comment"># end call now2</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> functools</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logger</span>(<span class="params">text</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">decorator</span>(<span class="params">func</span>):</span></span><br><span class="line"><span class="meta">        @functools.wraps(func)</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span>(<span class="params">*args, **kw</span>):</span></span><br><span class="line">            print(<span class="string">'%s %s():'</span> % (text, func.__name__))</span><br><span class="line">            <span class="keyword">return</span> func(*args, **kw)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> decorator</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@logger('DEBUG')  # today = logger(DEBUG)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">today</span>():</span></span><br><span class="line">    print(<span class="string">'2015-3-25'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">today()</span><br><span class="line"><span class="comment"># DEBUG today():</span></span><br><span class="line"><span class="comment"># 2015-3-25</span></span><br><span class="line">print(today.__name__)</span><br><span class="line"><span class="comment"># today</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logging</span>(<span class="params">level</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">outwrapper</span>(<span class="params">func</span>):</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span>(<span class="params">*args, **kwargs</span>):</span></span><br><span class="line">            print(<span class="string">"[{0}]: enter {1}()"</span>.format(level, func.__name__))</span><br><span class="line">            <span class="keyword">return</span> func(*args, **kwargs)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> outwrapper</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@logging(level="INFO")</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span>(<span class="params">a, b, c</span>):</span></span><br><span class="line">    print(a, b, c)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">hello(<span class="string">"hello,"</span>, <span class="string">"good"</span>, <span class="string">"morning"</span>)</span><br><span class="line"><span class="comment"># [INFO]: enter hello()</span></span><br><span class="line"><span class="comment"># hello, good morning</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="类装饰器"><a href="#类装饰器" class="headerlink" title="类装饰器"></a>类装饰器</h3><p>如果A是函数，<code>A()</code>是直接调用函数，<br>当A是一个类时，<code>A()</code>表示调用<code>A</code>类的构造函数<code>__init__</code>实例化一个A类对象，<br>那么<code>A(f)</code>就表示将函数<code>f</code>作为参数传递给A类的构造方法<code>__init__</code>来构造一个A类实例对象，<br>如果使用了<code>@</code>符号，那么这种语法机制就还会在<code>A(f)</code>后面加一个括号变成<code>A(f)()</code>，这是什么鬼？执行一个类实例对象？<br>通过<code>A()()</code>执行一个类实例对象时，执行的是A类内部的<code>__call__</code>魔法方法来实现类的直接调用。</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>(<span class="params">object</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        print(<span class="string">'实例化一个A类对象'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span>(<span class="params">self, *args, **kwargs</span>):</span></span><br><span class="line">        print(<span class="string">'__call__方法被调用……'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    A()()</span><br><span class="line"><span class="comment"># 实例化一个A类对象</span></span><br><span class="line"><span class="comment"># __call__方法被调用……</span></span><br></pre></td></tr></tbody></table></figure>

<p>那么如果用A用作装饰器时，<code>@A</code>返回的就是A类内部定义的<code>__call__</code>方法，相当于函数装饰器<code>func</code>内的<code>wrapper</code>。</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>(<span class="params">object</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, f</span>):</span></span><br><span class="line">        print(<span class="string">'实例化一个A类对象……'</span>)</span><br><span class="line">        self.f = f</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span>(<span class="params">self, *args, **kwargs</span>):</span></span><br><span class="line">        print(<span class="string">'{} start……'</span>.format(self.f.__name__))</span><br><span class="line">        self.f(*args, **kwargs)</span><br><span class="line">        print(<span class="string">'{} end ……'</span>.format(self.f.__name__))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@A</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_something</span>(<span class="params">name</span>):</span></span><br><span class="line">    print(<span class="string">'hello {}！'</span>.format(name))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    do_something(<span class="string">'ashe'</span>)</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">实例化一个A类对象……</span></span><br><span class="line"><span class="attr">do_something</span> <span class="string">start……</span></span><br><span class="line"><span class="attr">hello</span> <span class="string">ashe！</span></span><br><span class="line"><span class="attr">do_something</span> <span class="string">end ……</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LogTime</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span>(<span class="params">self, func</span>):</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">_log</span>(<span class="params">*args, **kwargs</span>):</span></span><br><span class="line">            start_time = time.time()</span><br><span class="line">            res = func(*args, **kwargs)</span><br><span class="line">            stop_time = time.time()</span><br><span class="line">            print(<span class="string">'use time: {}'</span>.format(stop_time - start_time))</span><br><span class="line">            <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> _log</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@LogTime()  # 需要加括号实现一个装饰器的实例</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mysleep</span>():</span></span><br><span class="line">    print(<span class="string">'--'</span>)</span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysleep()</span><br><span class="line"><span class="comment"># --</span></span><br><span class="line"><span class="comment"># use time: 1.0117154121398926</span></span><br></pre></td></tr></tbody></table></figure>

<p>该类创建的实例对象也将成为一个可调用对象，如：<code>LogTime()</code>。<br>如果类中没有 <code>__call__</code> 方法，直接用类创建实例 <code>LogTime()</code> 会报错。</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Logging</span>(<span class="params">object</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, func</span>):</span></span><br><span class="line">        self.func = func</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span>(<span class="params">self, *args, **kwargs</span>):</span></span><br><span class="line">        print(<span class="string">"[DEBUG]: enter {}()"</span>.format(self.func.__name__))</span><br><span class="line">        <span class="keyword">return</span> self.func(*args, **kwargs)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Logging</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span>(<span class="params">a, b, c</span>):</span></span><br><span class="line">    print(a, b, c)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">hello(<span class="string">"hello,"</span>, <span class="string">"good"</span>, <span class="string">"morning"</span>)</span><br><span class="line"><span class="comment"># [DEBUG]: enter hello()</span></span><br><span class="line"><span class="comment"># hello, good morning</span></span><br></pre></td></tr></tbody></table></figure>
<p>该类创建的实例对象也将成为一个可调用对象,如：<code>Logging</code>。<br>如果类中没有 <code>__call__</code> 方法，直接用类创建实例 <code>Logging</code> 会报错。</p>
<h4 id="类装饰器比较方便实现装饰器参数"><a href="#类装饰器比较方便实现装饰器参数" class="headerlink" title="类装饰器比较方便实现装饰器参数"></a>类装饰器比较方便实现装饰器参数</h4><p>类装饰器的参数也可定是通过@A(t)的形式传递，这时候，因为@语法糖会自动加括号的原因，<br>结构就编程这样<code>A(t)()</code>，A(t)是类实例对象，A(t)()就是__call__方法，所以，<br>@语法糖会把被装饰函数f作为参数传递给__call__方法，被装饰函数的参数需要在__call__内部定义一个函数来接受。<br>也就是话说，定义类装饰器时，装饰器的参数通过__init__构造方法接收，被装饰函数的作为参数被__call__方法接收，</p>
<p>什么时候需要给装饰器增加参数，例如: 想控制装饰器本身的行为时候，就会通过不同参数去控制。</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>(<span class="params">object</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, t</span>):</span></span><br><span class="line">        print(<span class="string">'实例化一个A类对象……'</span>)</span><br><span class="line">        self.t = t</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span>(<span class="params">self, f</span>):</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">inner_A</span>(<span class="params">*args, **kwargs</span>):</span></span><br><span class="line">            print(<span class="string">'延迟{}秒后开始执行……'</span>.format(self.t))</span><br><span class="line">            time.sleep(self.t)</span><br><span class="line">            print(<span class="string">'{} start……'</span>.format(f.__name__))</span><br><span class="line">            f(*args, **kwargs)</span><br><span class="line">            print(<span class="string">'{} end……'</span>.format(f.__name__))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> inner_A</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@A(1)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_something</span>(<span class="params">name</span>):</span></span><br><span class="line">    print(<span class="string">'hello {}！'</span>.format(name))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    do_something(<span class="string">'ashe'</span>)</span><br><span class="line">实例化一个A类对象……</span><br><span class="line">延迟<span class="number">1</span>秒后开始执行……</span><br><span class="line">do_something start……</span><br><span class="line">hello ashe！</span><br><span class="line">do_something end……</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">logging</span>(<span class="params">object</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, level</span>):</span></span><br><span class="line">        self.level = level</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span>(<span class="params">self, func</span>):</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span>(<span class="params">*args, **kwargs</span>):</span></span><br><span class="line">            print(<span class="string">"[{0}]: enter {1}()"</span>.format(self.level, func.__name__))</span><br><span class="line">            <span class="keyword">return</span> func(*args, **kwargs)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@logging(level="TEST")</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span>(<span class="params">a, b, c</span>):</span></span><br><span class="line">    print(a, b, c)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">hello(<span class="string">"hello,"</span>, <span class="string">"good"</span>, <span class="string">"morning"</span>)</span><br><span class="line"><span class="comment"># [TEST]: enter hello()</span></span><br><span class="line"><span class="comment"># hello, good morning</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LogTimeParams</span>:</span></span><br><span class="line">    <span class="string">'''通过装饰器类的__init__传参数'''</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, use_int=False</span>):</span>  <span class="comment"># use_int使用布尔值，控制打印输出类型</span></span><br><span class="line">        self.use_int = use_int  <span class="comment"># 打印出来的时间是使用float值还是int值</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span>(<span class="params">self, func</span>):</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">_log</span>(<span class="params">*args, **kwargs</span>):</span></span><br><span class="line">            start_time = time.time()</span><br><span class="line">            res = func(*args, **kwargs)</span><br><span class="line">            stop_time = time.time()</span><br><span class="line">            <span class="keyword">if</span> self.use_int:  <span class="comment"># True为int类型值</span></span><br><span class="line">                print(<span class="string">'use time: {}'</span>.format(int(stop_time - start_time)))</span><br><span class="line">            <span class="keyword">else</span>:  <span class="comment"># False为float类型值</span></span><br><span class="line">                print(<span class="string">'use time: {}'</span>.format(stop_time - start_time))</span><br><span class="line">            <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> _log</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@LogTimeParams(True)  # 调用点给装饰器传入参数，</span></span><br><span class="line"><span class="comment"># True表示以 int类型输出，False表示以 float类型输出，</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mysleep</span>():</span></span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysleep()</span><br><span class="line"><span class="comment"># use time: 1</span></span><br></pre></td></tr></tbody></table></figure>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/05/03/shu-ju-qu-dong-zai-zi-dong-hua-ce-shi-zhong-de-ying-yong/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/03/shu-ju-qu-dong-zai-zi-dong-hua-ce-shi-zhong-de-ying-yong/" class="post-title-link" itemprop="url">数据驱动在自动化测试中的应用</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2021-05-02 17:46:44 / 修改时间：06:09:20" itemprop="dateCreated datePublished" datetime="2021-05-02T17:46:44Z">2021-05-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%97%85%E6%B8%B8%E7%BD%91%E9%A1%B9%E7%9B%AE/" itemprop="url" rel="index"><span itemprop="name">旅游网项目</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="数据驱动在自动化测试中的应用"><a href="#数据驱动在自动化测试中的应用" class="headerlink" title="数据驱动在自动化测试中的应用"></a>数据驱动在自动化测试中的应用</h1><h2 id="自动化测试模型介绍"><a href="#自动化测试模型介绍" class="headerlink" title="自动化测试模型介绍"></a>自动化测试模型介绍</h2><ul>
<li><p><code>线性</code>测试：每个测试脚本相对独立，一个脚本文件都是独立编写测试内容等，任何一个脚本都可以拿出来单独执行。开发和维护的成本很高</p>
</li>
<li><p><code>模块化驱动</code>测试：把重复的操作单独成立公关模块。如登陆模块，写好之后后续用例只需要调用对应模块即可。较好的解决了脚本重复问题。分为PageObject和分层模式。分层模式，设计思维从页面模式中抽离，做成业务化的思维，业务流程横跨多个界面只要是固化流程就好</p>
</li>
<li><p><code>数据驱动</code>测试：针对测试数据改变而影响数据驱动测试而提出的。就是将测试数据做成参数化。<br>不仅解决脚本重复的问题，还增加了可重用性和可维护性。<br>测试数据改的时不需要修改测试代码</p>
</li>
<li><p><code>关键字驱动</code>测试：市面的很多工具、平台等都是关键字模式。<br>将底层代码封装，给用户提供独立的图形界面。<br>减少编写代码，从而降低脚本的编写难度</p>
</li>
<li><p>数据驱动的应用</p>
</li>
</ul>
<p><code>traveltest（实战项目第七节后）\test_login_ddt.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> unittest</span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pages.first_page <span class="keyword">import</span> FirstPage</span><br><span class="line"><span class="keyword">from</span> pages.login_page <span class="keyword">import</span> LoginPage</span><br><span class="line"><span class="keyword">from</span> pages.order_page <span class="keyword">import</span> OrderPage</span><br><span class="line"><span class="keyword">from</span> ddt <span class="keyword">import</span> ddt, data</span><br><span class="line"><span class="keyword">from</span> xlrd <span class="keyword">import</span> open_workbook</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getExcelData</span>():</span></span><br><span class="line">    excelFile = open_workbook(<span class="string">"d:/data.xlsx"</span>)</span><br><span class="line">    <span class="comment"># 获取excel的工作簿</span></span><br><span class="line">    sheet = excelFile.sheet_by_index(<span class="number">0</span>)</span><br><span class="line">    <span class="comment"># 获取行数</span></span><br><span class="line">    rowNumber = sheet.nrows</span><br><span class="line">    dataList = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, rowNumber):  <span class="comment"># 第一行是表头，从第二行开始</span></span><br><span class="line">        dataList.append(sheet.row_values(i))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> dataList</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@ddt</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestTravel</span>(<span class="params">unittest.TestCase</span>):</span></span><br><span class="line">    <span class="comment"># 初始化操作 打开浏览器&amp;浏览器设置</span></span><br><span class="line">    <span class="comment"># 最终结束操作 关闭浏览器</span></span><br><span class="line">    <span class="comment"># 用例分为 登录、下单两个部分</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">setUp</span>(<span class="params">self</span>):</span>  <span class="comment"># self 每次重新打开浏览器</span></span><br><span class="line">        driver_path = <span class="string">'C:\\Users\\rose\\Downloads\\chromedriver.exe'</span></span><br><span class="line">        cls.dr = webdriver.Chrome(driver_path)</span><br><span class="line">        self.dr.maximize_window()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @data(*getExcelData())</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_login_ddt</span>(<span class="params">self, data</span>):</span></span><br><span class="line">        <span class="comment"># 初始化参数</span></span><br><span class="line">        username, password = tuple(data)</span><br><span class="line">        <span class="comment"># 初始化界面</span></span><br><span class="line">        first_page = FirstPage(driver=self.dr,</span><br><span class="line">                               path=<span class="string">"http://django.t.mukewang.com/#/"</span>)</span><br><span class="line">        login_page = LoginPage(driver=self.dr)</span><br><span class="line">        order_page = OrderPage(driver=self.dr)</span><br><span class="line">        <span class="comment"># 跳转登录</span></span><br><span class="line">        first_page.cross_to_login()</span><br><span class="line">        <span class="comment"># 登录</span></span><br><span class="line">        login_page.login(username, password)</span><br><span class="line">        sleep(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">tearDown</span>(<span class="params">self</span>):</span>  <span class="comment"># self 每次重新打开浏览器并关闭</span></span><br><span class="line">        self.dr.quit()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    unittest.main()</span><br></pre></td></tr></tbody></table></figure><script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/05/03/ce-shi-bao-gao-shi-zhan/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/03/ce-shi-bao-gao-shi-zhan/" class="post-title-link" itemprop="url">测试报告实战</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2021-05-02 17:46:44 / 修改时间：08:15:19" itemprop="dateCreated datePublished" datetime="2021-05-02T17:46:44Z">2021-05-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%97%85%E6%B8%B8%E7%BD%91%E9%A1%B9%E7%9B%AE/" itemprop="url" rel="index"><span itemprop="name">旅游网项目</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ul>
<li>通过<code>HTMLTESTRUNNER</code>生成测试报告</li>
</ul>
<p><code>traveltest（实战项目第七节后）\test_login_suite.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> unittest</span><br><span class="line"><span class="keyword">from</span> test_login_ddt <span class="keyword">import</span> TestTravel</span><br><span class="line"><span class="keyword">from</span> HTMLTestReportCN <span class="keyword">import</span> HTMLTestRunner</span><br><span class="line"><span class="keyword">from</span> xmlrunner <span class="keyword">import</span> xmlrunner</span><br><span class="line"></span><br><span class="line">suite = unittest.TestSuite()</span><br><span class="line">suite = unittest.TestLoader().loadTestsFromTestCase(TestTravel)</span><br><span class="line"></span><br><span class="line">f = open(<span class="string">"result.html"</span>, <span class="string">"wb"</span>)</span><br><span class="line">HTMLTestRunner(stream=f, title=<span class="string">"UI自动化测试报告"</span>, description=<span class="string">"风落测试"</span>).run(suite)</span><br><span class="line">xmlrunner.XMLTestRunner(verbosity=<span class="number">2</span>, output=<span class="string">'测试报告'</span>).run(suite)</span><br></pre></td></tr></tbody></table></figure><script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/05/02/pageobject-kuang-jia-she-ji/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/02/pageobject-kuang-jia-she-ji/" class="post-title-link" itemprop="url">PageObject框架设计</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-05-01 17:46:44" itemprop="dateCreated datePublished" datetime="2021-05-01T17:46:44Z">2021-05-01</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-05-27 05:12:04" itemprop="dateModified" datetime="2021-05-27T05:12:04Z">2021-05-27</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%97%85%E6%B8%B8%E7%BD%91%E9%A1%B9%E7%9B%AE/" itemprop="url" rel="index"><span itemprop="name">旅游网项目</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>了解并实现PageObeject自动化设计模式</p>
<ul>
<li>一种在测试自动化中变得流行的设计模式，使得自动化测试脚本的减少代码重复、更易读、减少维护成本<br>页面、操作、脚本、case 分开</li>
</ul>
<p>PO三层模式</p>
<h4 id="第一层"><a href="#第一层" class="headerlink" title="第一层"></a>第一层</h4><ul>
<li>对 Selenium进行二次封装，定义一个所有页面都继承的<code>BasePage</code></li>
<li>封装 Selenium基本方法例如:元素定位，元素等待，导航页面。</li>
<li>不需要全部封装，用到多少方法就封装多少方法。</li>
</ul>
<h4 id="第二层"><a href="#第二层" class="headerlink" title="第二层"></a>第二层</h4><ul>
<li>页面元素迸行分离，每个元素只定位一次，隔离定位，如果页面改变，只需要改变相应的元素定位。</li>
<li>业务逻辑分离或操作元素动作分离。</li>
</ul>
<h4 id="第三层"><a href="#第三层" class="headerlink" title="第三层"></a>第三层</h4><ul>
<li>使用单元测试unittest框架对业务逻辑进行测试</li>
</ul>
<p>PO设计模式的优点</p>
<ul>
<li>页面频繁变化，导致页面U元素频繁变动，元素定位改变。</li>
<li>传统线性自动化，多个用例脚本中需要反复的定位同一个元素。</li>
<li>修改元素定位时容易维护</li>
</ul>
<p><code>traveltest\pages\base_page.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BasePage</span>():</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    第一层 basepage层 定义一个所有页面都继承的page层</span></span><br><span class="line"><span class="string">    对selenium我们要使用的底层方法进行一次封装</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, driver, path=None</span>):</span></span><br><span class="line">        <span class="comment"># 为了方便编写，把driver初始化，后续改回来</span></span><br><span class="line">        driver_path = <span class="string">'C:\\Users\\rose\\Downloads\\msedgedriver.exe'</span></span><br><span class="line">        <span class="comment"># self.driver = webdriver.Edge(driver_path)</span></span><br><span class="line">        self.driver = driver</span><br><span class="line">        self.driver.implicitly_wait(<span class="number">10</span>)  <span class="comment"># 隐式等待10秒</span></span><br><span class="line">        self.load_page(path)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">load_page</span>(<span class="params">self, path=None</span>):</span></span><br><span class="line">        <span class="keyword">if</span> path:</span><br><span class="line">            self.driver.get(path)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">by_xpath</span>(<span class="params">self, xpath</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.driver.find_element_by_xpath(xpath)</span><br></pre></td></tr></tbody></table></figure>

<p><code>traveltest（实战项目第七节后）\pages\first_page.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> pages.base_page <span class="keyword">import</span> BasePage</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FirstPage</span>(<span class="params">BasePage</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    第二层</span></span><br><span class="line"><span class="string">    各个页面单独封装成层，页面的元素、操作、流程</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">direct_to_login</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># 跳转至登录页：点击 我的</span></span><br><span class="line">        <span class="keyword">return</span> self.by_xpath(<span class="string">"//*[@id='app']/div[1]/div[5]/div[3]"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">direct_to_product</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># 点击 首页</span></span><br><span class="line">        <span class="keyword">return</span> self.by_xpath(<span class="string">"//*[@id='app']/div[1]/div[5]/div[1]"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 方法流程</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cross_to_login</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.direct_to_login().click()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cross_to_product</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.direct_to_product().click()</span><br></pre></td></tr></tbody></table></figure>

<p><code>traveltest（实战项目第七节后）\pages\login_page.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> pages.base_page <span class="keyword">import</span> BasePage</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginPage</span>(<span class="params">BasePage</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    第二层</span></span><br><span class="line"><span class="string">    各个页面单独封装成层，页面的元素、操作、流程</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">login_username</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># 登录，输入用户名</span></span><br><span class="line">        <span class="keyword">return</span> self.by_xpath(</span><br><span class="line">            <span class="string">"//*[@id='app']/div[1]/form/div[1]/div[2]/div/input"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">login_pass</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># 登录，输入密码</span></span><br><span class="line">        <span class="keyword">return</span> self.by_xpath(</span><br><span class="line">            <span class="string">"//*[@id='app']/div[1]/form/div[2]/div[2]/div/input"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">login_button</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># 点击登录</span></span><br><span class="line">        <span class="keyword">return</span> self.by_xpath(<span class="string">"//*[@id='app']/div[1]/form/div[3]/button"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 登录</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">login</span>(<span class="params">self, username, password</span>):</span></span><br><span class="line">        self.login_username().send_keys(username)</span><br><span class="line">        self.login_pass().send_keys(password)</span><br><span class="line">        self.login_button().click()</span><br></pre></td></tr></tbody></table></figure>

<p><code>traveltest（实战项目第七节后）\pages\order_page.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> pages.base_page <span class="keyword">import</span> BasePage</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderPage</span>(<span class="params">BasePage</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    第二层</span></span><br><span class="line"><span class="string">    各个页面单独封装成层，页面的元素、操作、流程</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">product</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.by_xpath(<span class="string">"//*[@id='app']/div[1]/div[4]/div[2]/a[1]"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">ticket_book</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.by_xpath(<span class="string">"//*[@id='app']/div[1]/div[5]/div[2]/div[2]/a"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">book_date</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.by_xpath(</span><br><span class="line">            <span class="string">"//*[@id='app']/div[1]/form/div[1]/div[1]/div[2]/div/input"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">to_order</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.by_xpath(<span class="string">"//*[@id='app']/div[1]/form/div[4]/div/button"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pay_off</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.by_xpath(<span class="string">"//*[@id='app']/div[1]/form/div/div/button"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">confirm</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.by_xpath(<span class="string">"/html/body/div[5]/div[3]/button[2]"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 下单成功</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">place_order</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.product().click()</span><br><span class="line">        self.ticket_book().click()</span><br><span class="line">        self.book_date().send_keys(<span class="string">"2021-05-01"</span>)</span><br><span class="line">        self.to_order().click()</span><br><span class="line">        sleep(<span class="number">2</span>)</span><br><span class="line">        el = self.pay_off()</span><br><span class="line">        self.driver.execute_script(<span class="string">'arguments[0].click()'</span>, el)</span><br><span class="line">        sleep(<span class="number">2</span>)</span><br></pre></td></tr></tbody></table></figure>

<p><code>traveltest（实战项目第七节后）\test_travel_po.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> unittest</span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pages.first_page <span class="keyword">import</span> FirstPage</span><br><span class="line"><span class="keyword">from</span> pages.login_page <span class="keyword">import</span> LoginPage</span><br><span class="line"><span class="keyword">from</span> pages.order_page <span class="keyword">import</span> OrderPage</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestTravel</span>(<span class="params">unittest.TestCase</span>):</span></span><br><span class="line">    <span class="comment"># 初始化操作 打开浏览器&amp;浏览器设置</span></span><br><span class="line">    <span class="comment"># 最终结束操作 关闭浏览器</span></span><br><span class="line">    <span class="comment"># 第三层</span></span><br><span class="line">    <span class="comment"># 用例分为 登录、下单两个部分</span></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">setUpClass</span>(<span class="params">cls</span>):</span></span><br><span class="line">        <span class="comment"># driver_path = 'C:\\Users\\rose\\Downloads\\msedgedriver.exe'</span></span><br><span class="line">        driver_path = <span class="string">'C:\\Users\\rose\\Downloads\\chromedriver.exe'</span></span><br><span class="line">        <span class="comment"># cls.dr = webdriver.Edge(driver_path)</span></span><br><span class="line">        cls.dr = webdriver.Chrome(driver_path)</span><br><span class="line">        cls.dr.maximize_window()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_a_order</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># 初始化参数</span></span><br><span class="line">        username = <span class="string">'13500000001'</span></span><br><span class="line">        password = <span class="string">'Success@2020'</span></span><br><span class="line">        <span class="comment"># 初始化界面</span></span><br><span class="line">        first_page = FirstPage(driver=self.dr,</span><br><span class="line">                               path=<span class="string">"http://django.t.mukewang.com/#/"</span>)</span><br><span class="line">        login_page = LoginPage(driver=self.dr)</span><br><span class="line">        order_page = OrderPage(driver=self.dr)</span><br><span class="line">        <span class="comment"># 跳转登录</span></span><br><span class="line">        first_page.cross_to_login()</span><br><span class="line">        <span class="comment"># 登录</span></span><br><span class="line">        login_page.login(username, password)</span><br><span class="line">        <span class="comment"># 跳转至首页</span></span><br><span class="line">        first_page.cross_to_product()</span><br><span class="line">        <span class="comment"># 下单</span></span><br><span class="line">        order_page.place_order()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">tearDownClass</span>(<span class="params">cls</span>):</span></span><br><span class="line">        cls.dr.quit()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    unittest.main()</span><br></pre></td></tr></tbody></table></figure>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/05/01/django-web-ui-ce-shi/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/01/django-web-ui-ce-shi/" class="post-title-link" itemprop="url">django web ui测试</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-04-30 17:46:44" itemprop="dateCreated datePublished" datetime="2021-04-30T17:46:44Z">2021-04-30</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-05-07 07:45:23" itemprop="dateModified" datetime="2021-05-07T07:45:23Z">2021-05-07</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%97%85%E6%B8%B8%E7%BD%91%E9%A1%B9%E7%9B%AE/" itemprop="url" rel="index"><span itemprop="name">旅游网项目</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>在我们的页面不太标准化，没有标准的属性功能使用，元素定位方式想用byname不一定有name属性，只有xpath和css_selector能保证一定定位到一个元素，<br>页面与页面直接跳转可能有时间差，如果没有定位完整的、全局的响应等待时间，<code>time.sleep()</code> 减少由于页面跳转所带来的元素还没有加载出来就去<code>find</code><br>它。<br>一旦页面出现了一些元素，不可或不易点击，比如广告弹层刚好把按钮挡住，<br>可以通过<code>.execute_script('arguments[0].click()', el)</code>来调用JavaScript代码处理，可以忽视前端的页面呈现</p>
<h2 id="结合旅游网设计自动化测试脚本"><a href="#结合旅游网设计自动化测试脚本" class="headerlink" title="结合旅游网设计自动化测试脚本"></a>结合旅游网设计自动化测试脚本</h2><p>旅游网核心主线流程<br>进入首页-跳转到登录页-进行登录-跳转首页-选择想要购买的产品-在产品下执行某一个门票或其他类型的预定-完成支付-跳转订单页</p>
<p><code>travelTest.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"></span><br><span class="line">driver_path = <span class="string">'C:\\Users\\rose\\Downloads\\msedgedriver.exe'</span></span><br><span class="line">driver = webdriver.Edge(driver_path)</span><br><span class="line">driver.maximize_window()</span><br><span class="line">driver.get(<span class="string">"http://django.t.mukewang.com/#/"</span>)</span><br><span class="line"><span class="comment"># 跳转至登录页：点击 我的</span></span><br><span class="line">el_mine = driver.find_element_by_xpath(<span class="string">"//*[@id='app']/div[1]/div[5]/div[3]"</span>)</span><br><span class="line">el_mine.click()</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line"><span class="comment"># 登录</span></span><br><span class="line">driver.find_element_by_xpath(</span><br><span class="line">    <span class="string">"//*[@id='app']/div[1]/form/div[1]/div[2]/div/input"</span>).send_keys(</span><br><span class="line">        <span class="string">"13500000001"</span>)</span><br><span class="line">driver.find_element_by_xpath(</span><br><span class="line">    <span class="string">"//*[@id='app']/div[1]/form/div[2]/div[2]/div/input"</span>).send_keys(</span><br><span class="line">        <span class="string">"Success@2020"</span>)</span><br><span class="line">driver.find_element_by_xpath(</span><br><span class="line">    <span class="string">"//*[@id='app']/div[1]/form/div[3]/button"</span>).click()</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line"><span class="comment"># 点击 首页</span></span><br><span class="line">driver.find_element_by_xpath(<span class="string">"//*[@id='app']/div[1]/div[5]/div[1]"</span>).click()</span><br><span class="line">sleep(<span class="number">2</span>)</span><br><span class="line"><span class="comment"># 下单操作</span></span><br><span class="line"><span class="comment"># 点击 一个商品</span></span><br><span class="line">driver.find_element_by_xpath(</span><br><span class="line">    <span class="string">"//*[@id='app']/div[1]/div[4]/div[2]/a[1]"</span>).click()</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line"><span class="comment"># 点击 预定</span></span><br><span class="line">driver.find_element_by_xpath(</span><br><span class="line">    <span class="string">"//*[@id='app']/div[1]/div[5]/div[2]/div[2]/a"</span>).click()</span><br><span class="line"><span class="comment"># 不点击 出行日期而是设置input属性的日期</span></span><br><span class="line">driver.find_element_by_xpath(</span><br><span class="line">    <span class="string">"//*[@id='app']/div[1]/form/div[1]/div[1]/div[2]/div/input"</span>).send_keys(</span><br><span class="line">        <span class="string">"2021-05-01"</span>)</span><br><span class="line"><span class="comment"># 提交订单</span></span><br><span class="line">driver.find_element_by_xpath(</span><br><span class="line">    <span class="string">"//*[@id='app']/div[1]/form/div[4]/div/button"</span>).click()</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line"><span class="comment"># 点击 立即支付</span></span><br><span class="line"><span class="comment"># driver.find_element_by_xpath("//*[@id='app']/div[1]/form/div/div/button").click() # not clickable</span></span><br><span class="line"><span class="comment"># 若元素不能点击，先定位元素，再执行js脚本</span></span><br><span class="line">el = driver.find_element_by_xpath(<span class="string">"//*[@id='app']/div[1]/form/div/div/button"</span>)</span><br><span class="line">driver.execute_script(<span class="string">'arguments[0].click()'</span>, el)</span><br><span class="line"><span class="comment"># 确认</span></span><br><span class="line">driver.find_element_by_xpath(<span class="string">"/html/body/div[5]/div[3]/button[2]"</span>).click()</span><br><span class="line">sleep(<span class="number">2</span>)</span><br><span class="line">driver.quit()</span><br></pre></td></tr></tbody></table></figure>

<p>unittest框架设计应用</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> unittest</span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestTravel</span>(<span class="params">unittest.TestCase</span>):</span></span><br><span class="line">    <span class="comment"># 初始化操作 打开浏览器&amp;浏览器设置</span></span><br><span class="line">    <span class="comment"># 最终结束操作 关闭浏览器</span></span><br><span class="line">    <span class="comment"># 用例分为 登录、下单两个部分</span></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">setUpClass</span>(<span class="params">cls</span>):</span></span><br><span class="line">        driver_path = <span class="string">'C:\\Users\\rose\\Downloads\\msedgedriver.exe'</span></span><br><span class="line">        cls.dr = webdriver.Edge(driver_path)</span><br><span class="line">        cls.dr.maximize_window()</span><br><span class="line">        cls.dr.implicitly_wait(<span class="number">10</span>)</span><br><span class="line">        cls.dr.get(<span class="string">"http://django.t.mukewang.com/#/"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_a_login</span>(<span class="params">self</span>):</span>  <span class="comment"># unittest中的方法不是按书写顺序而是方法名的ASCII</span></span><br><span class="line">        <span class="comment"># 跳转至登录页 点击 我的</span></span><br><span class="line">        el_mine = self.dr.find_element_by_xpath(</span><br><span class="line">            <span class="string">"//*[@id='app']/div[1]/div[5]/div[3]"</span>)</span><br><span class="line">        el_mine.click()</span><br><span class="line">        sleep(<span class="number">1</span>)</span><br><span class="line">        <span class="comment"># 登录</span></span><br><span class="line">        self.dr.find_element_by_xpath(</span><br><span class="line">            <span class="string">"//*[@id='app']/div[1]/form/div[1]/div[2]/div/input"</span>).send_keys(</span><br><span class="line">                <span class="string">"13500000001"</span>)</span><br><span class="line">        self.dr.find_element_by_xpath(</span><br><span class="line">            <span class="string">"//*[@id='app']/div[1]/form/div[2]/div[2]/div/input"</span>).send_keys(</span><br><span class="line">                <span class="string">"Success@2020"</span>)</span><br><span class="line">        self.dr.find_element_by_xpath(</span><br><span class="line">            <span class="string">"//*[@id='app']/div[1]/form/div[3]/button"</span>).click()</span><br><span class="line">        sleep(<span class="number">1</span>)</span><br><span class="line">        self.dr.find_element_by_xpath(</span><br><span class="line">            <span class="string">"//*[@id='app']/div[1]/div[5]/div[1]"</span>).click()</span><br><span class="line">        sleep(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_b_order</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># 下单操作</span></span><br><span class="line">        self.dr.find_element_by_xpath(</span><br><span class="line">            <span class="string">"//*[@id='app']/div[1]/div[4]/div[2]/a[1]"</span>).click()</span><br><span class="line">        sleep(<span class="number">1</span>)</span><br><span class="line">        self.dr.find_element_by_xpath(</span><br><span class="line">            <span class="string">"//*[@id='app']/div[1]/div[5]/div[2]/div[2]/a"</span>).click()</span><br><span class="line">        self.dr.find_element_by_xpath(</span><br><span class="line">            <span class="string">"//*[@id='app']/div[1]/form/div[1]/div[1]/div[2]/div/input"</span></span><br><span class="line">        ).send_keys(<span class="string">"2020-12-01"</span>)</span><br><span class="line">        self.dr.find_element_by_xpath(</span><br><span class="line">            <span class="string">"//*[@id='app']/div[1]/form/div[4]/div/button"</span>).click()</span><br><span class="line">        sleep(<span class="number">1</span>)</span><br><span class="line">        el = self.dr.find_element_by_xpath(</span><br><span class="line">            <span class="string">"//*[@id='app']/div[1]/form/div/div/button"</span>)</span><br><span class="line">        self.dr.```<span class="string">'arguments[0].click()'</span>, el)</span><br><span class="line">        self.dr.find_element_by_xpath(</span><br><span class="line">            <span class="string">"/html/body/div[5]/div[3]/button[2]"</span>).click()</span><br><span class="line">        sleep(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">tearDownClass</span>(<span class="params">cls</span>):</span></span><br><span class="line">        cls.dr.quit()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    unittest.main()</span><br></pre></td></tr></tbody></table></figure><script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/04/26/node.js-restfui-api/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/04/26/node.js-restfui-api/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2021-04-26 02:59:48 / 修改时间：03:58:10" itemprop="dateCreated datePublished" datetime="2021-04-26T02:59:48Z">2021-04-26</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="Node仿知乎RESTful-API开发设计"><a href="#Node仿知乎RESTful-API开发设计" class="headerlink" title="Node仿知乎RESTful API开发设计"></a>Node仿知乎RESTful API开发设计</h3><h4 id="RESTful-架构"><a href="#RESTful-架构" class="headerlink" title="RESTful 架构"></a>RESTful 架构</h4><p><code>REST</code>全称是 <code>Representational State Transfer</code>，中文意思是 <code>表述性状态转移</code>。 它首次出现在2000年Roy Fielding的博士论文中，Roy Fielding是HTTP规范的主要编写者之一。 他在论文中提到：”我这篇文章的写作目的，就是想在符合架构原理的前提下，理解和评估以网络为基础的应用软件的架构设计，得到一个功能强、性能好、适宜通信的架构。**<code>REST指的是一组架构约束条件和原则。" 如果一个架构符合REST的约束条件和原则，我们就称它为RESTful架构。</code>**</p>
<ul>
<li><strong>Representational：数据的表现形式（JSON、XML…..）</strong></li>
<li><strong>State: 当前状态或者数据</strong></li>
<li><strong>Transfer: 数据传输</strong></li>
</ul>
<h5 id="RESTful-六大限制"><a href="#RESTful-六大限制" class="headerlink" title="RESTful 六大限制"></a>RESTful 六大限制</h5><ol>
<li><p><strong>客户-服务器（Client-Server）</strong></p>
<ul>
<li>关注点分离</li>
<li>服务端专注数据存储，提高了简单性</li>
<li>前端专注用户界面，提升了可移植性</li>
</ul>
</li>
<li><p><strong>无状态（StateLess）</strong></p>
<ul>
<li>所有会话信息都保存在客户端</li>
<li>每次请求必须包括所有信息，不能依赖上下文信息</li>
<li>服务端不用保存会话信息，提升简单性、可靠性、可见性（软件工程中接口之间透明程度）</li>
</ul>
</li>
<li><p><strong>缓存（Cache）</strong></p>
<ul>
<li>所有服务端响应都要被表示为可缓存（缓存在客户端（浏览器））或不可缓存</li>
<li>减少前后端交互，提升性能</li>
</ul>
</li>
<li><p><strong>统一接口（Uniform Interface）</strong></p>
<ul>
<li>接口设计尽可能统一通用，提升了简单性、可见性</li>
<li>遵循接口规范，接口与实现解耦，使前后端可以独立开发迭代</li>
</ul>
</li>
<li><p><strong>分层系统（Layered System）</strong></p>
<ul>
<li>每层只知道相邻的一层，后面隐藏的就不知道了</li>
<li>客户端不知道是和代理还是真实服务器通信</li>
<li>其它层：安全层、负载均衡、缓存层等</li>
</ul>
</li>
<li><p><strong>按需代码（Code-On-Demand）（可选）</strong></p>
<ul>
<li>客户端可以下载运行服务端传来的数据（比如JS）</li>
<li>通过减少一些功能，简化了客户端</li>
</ul>
</li>
</ol>
<h5 id="统一接口的限制"><a href="#统一接口的限制" class="headerlink" title="统一接口的限制"></a>统一接口的限制</h5><ol>
<li><p><strong>资源的标识</strong></p>
<ul>
<li>基于“资源”，数据也好、服务也好，是任意可以命名的事物，在RESTFul设计里一切都是资源。</li>
<li>每个资源可以通过<code>URI</code>（统一资源标识符）被唯一的标识  例如 <code>https://api.z.cn/v1/product/recent?page=3&amp;size=20</code></li>
</ul>
</li>
<li><p><strong>通过表述来操作资源</strong></p>
<ul>
<li>通过表述<code>Representation</code> 操作资源，比如<code>JSON</code>、<code>XML</code>等</li>
<li>客户端不能直接操作（比如<code>SQL</code>）服务端资源</li>
<li>客户端应该通过表述（比如<code>JSON</code>）来操作资源</li>
</ul>
</li>
<li><p><strong>自描述消息</strong></p>
<ul>
<li>每个消息（请求或响应）必须提供足够的信息让接受者理解</li>
<li>消息：如媒体类型（<code>application/json、application/xml</code>）</li>
<li>消息：如HTTP方法： <code>GET、POST、DELETE</code></li>
<li>是否缓存： <code>Cache-Control</code></li>
</ul>
</li>
<li><p><strong>超媒体作为应用状态引擎</strong></p>
<ul>
<li>超媒体： 带文字的链接</li>
<li>应用转态：一个网页</li>
<li>引擎：驱动、跳转</li>
<li>合起来就是：点击链接跳转到另一个网页</li>
</ul>
</li>
</ol>
<h5 id="RESTful-API"><a href="#RESTful-API" class="headerlink" title="RESTful API"></a>RESTful API</h5><p>符合REST架构风格的<strong>API</strong>就是 <strong>RESTful API</strong></p>
<p>应该包含三方面：</p>
<ol>
<li>基本的URL 如 <code>https://api.z.cn/v1/product/recent?page=3&amp;size=20</code></li>
<li>标准的HTTP方法，如<code>GET、POST、PUT、DELETE等</code></li>
<li>传输的数据媒体类型，如<code>JSON、XML</code></li>
</ol>
<h4 id="Koa2"><a href="#Koa2" class="headerlink" title="Koa2"></a>Koa2</h4><h5 id="项目初始化"><a href="#项目初始化" class="headerlink" title="项目初始化"></a>项目初始化</h5><ol>
<li><p>安装下载 Koa： <code>npm i koa --save</code></p>
</li>
<li><p>设置自动重启 <strong><code>nodemon</code></strong> ：<code>npm i nodemon --save-dev</code>（<code>-dev</code> 是指只在开发阶段适用）</p>
<p> 在<code>package.json</code>里设置启动方式，再 <code>npm start</code> 启动</p>
 <figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"scripts"</span>: {</span><br><span class="line">    <span class="string">"start"</span>: <span class="string">"nodemon index.js"</span></span><br><span class="line">},</span><br></pre></td></tr></tbody></table></figure>


<h5 id="Koa中间件与洋葱模型"><a href="#Koa中间件与洋葱模型" class="headerlink" title="Koa中间件与洋葱模型"></a>Koa中间件与洋葱模型</h5><blockquote>
<p><strong>当一个中间件调用 <code>next()</code> 则该函数暂停并将控制传递给定义的下一个中间件。当在下游没有更多的中间件执行后，堆栈将展开并且每个中间件恢复执行其上游行为。</strong></p>
</blockquote>
 <figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> app.use(async (ctx, next) =&gt; {</span><br><span class="line">    console.log(<span class="number">1</span>)  // 当执行打印 <span class="number">1</span> 后，调用 next() ,执行下一个中间件，打印 <span class="number">3</span></span><br><span class="line">    <span class="keyword">await</span> next()</span><br><span class="line">    console.log(<span class="number">2</span>)</span><br><span class="line">    console.log(ctx.lastVal) // 通过挂载在ctx，可以取到最后中间件的结果</span><br><span class="line"> })</span><br><span class="line"></span><br><span class="line"> app.use(async (ctx, next) =&gt; {</span><br><span class="line">    console.log(<span class="number">3</span>)</span><br><span class="line">    <span class="keyword">await</span> next()</span><br><span class="line">    console.log(<span class="number">4</span>)</span><br><span class="line"> })</span><br><span class="line"></span><br><span class="line">app.use(async (ctx, next) =&gt; {</span><br><span class="line">    console.log(<span class="number">5</span>)</span><br><span class="line">    ctx.lastVal = <span class="string">"ctx挂载"</span></span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure>

</li>
</ol>
<p>打印顺序为： 1 3 5 4 2 ctx挂载</p>
<p><strong><code>koa-compose：koa-compose则是将 koa/koa-router 各个中间件合并执行，结合 next() 形成一种串行机制，并且是支持异步，这样就形成了洋葱式模型</code></strong></p>
<h5 id="koa-bodyparser中间件"><a href="#koa-bodyparser中间件" class="headerlink" title="koa-bodyparser中间件"></a>koa-bodyparser中间件</h5><p><strong>koa-bodyparser中间件</strong> 是 koa2用来<code>post</code>提交数据的中间件</p>
<ol>
<li><p>下载 <code>npm&nbsp;install&nbsp;koa-bodyparser@2&nbsp;--save</code><br> 引入并挂载配置中间件</p>
 <figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">const bodyParser = require(<span class="string">'koa-bodyparser'</span>)</span><br><span class="line"></span><br><span class="line">app.use(bodyParser())</span><br></pre></td></tr></tbody></table></figure></li>
<li><p>读取<code>post</code>数据 对象格式 <code>ctx.request.body</code></p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">router.post('/doAdd',async (ctx) =&gt;{</span><br><span class="line">    console.log(ctx.request.body)</span><br><span class="line">})  </span><br></pre></td></tr></tbody></table></figure>

<h5 id="koa-router-路由"><a href="#koa-router-路由" class="headerlink" title="koa-router 路由"></a>koa-router 路由</h5></li>
<li><p>下载<code>npm i koa-router --save</code></p>
<p> 引入并挂载</p>
 <figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">const Router = require(<span class="string">"koa-router"</span>)</span><br><span class="line">const router = new Router()</span><br><span class="line"></span><br><span class="line">router.get("/users", (ctx) =&gt; {</span><br><span class="line">    ctx.body = <span class="string">"用户列表页面"</span></span><br><span class="line">})</span><br><span class="line">router.get("/users/:id", ctx =&gt; {</span><br><span class="line">    ctx.body = `当前${ctx.params.id}用户`</span><br><span class="line">})</span><br><span class="line"></span><br><span class="line">app.use(router.routes())</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>路由前缀</p>
<p> 使用路由前缀 <code>prefix</code> 的好处是，当路由前缀需要更改时，直接更改前缀即     可，简洁便利。<br> 如：</p>
 <figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">const userRouter = new Router({ prefix: <span class="string">"/users"</span> })</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">userRouter.get("/", (ctx) =&gt; {</span><br><span class="line">    ctx.body = <span class="string">"用户列表页面"</span></span><br><span class="line">})</span><br><span class="line">userRouter.get("/:id", ctx =&gt; {</span><br><span class="line">    ctx.body = `当前${ctx.params.id}用户`</span><br><span class="line">})</span><br><span class="line"></span><br><span class="line">app.use(userRouter.routes())</span><br></pre></td></tr></tbody></table></figure>
<h5 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h5></li>
</ol>
<p><strong>错误处理</strong> 是指 <code>编程语言或计算机硬件里的一种机制，处理软件或信息系统中出现的异常状况。</code><br>而<code>异常状况</code>又分为：</p>
<ol>
<li>运行错误，返回500</li>
<li>逻辑错误，如找不到（404）、先决条件失败（412）、无法处理的实体（参数格式不对，422）等</li>
</ol>
<p>为保证程序健壮性。防止程序挂掉；告诉用户错误信息；便于开发者调试，需要错误处理。</p>
<p><strong>错误处理中间件：koa-json-error</strong></p>
<ol>
<li><p>安装 <code>npm i koa-json-error --save</code></p>
</li>
<li><p>设置区分生产环境与开发环境： 安装 <code>npm i cross-env --save-dev</code></p>
<p> 在 <strong>package.json</strong> 中设置</p>
 <figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"scripts"</span>:&nbsp;{</span><br><span class="line">    <span class="string">"start"</span>:&nbsp;<span class="string">"cross-env&nbsp;NODE_ENV=production&nbsp;node&nbsp;app"</span>,</span><br><span class="line">    <span class="string">"dev"</span>:&nbsp;<span class="string">"nodemon&nbsp;app"</span></span><br><span class="line">},</span><br></pre></td></tr></tbody></table></figure></li>
<li><p>修改配置使其在生产环境下禁用错误堆栈 <strong>stack</strong> 的返回</p>
 <figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">const&nbsp;jsonError&nbsp;=&nbsp;require(<span class="string">'koa-json-error'</span>)</span><br><span class="line"></span><br><span class="line">app.use(jsonError({</span><br><span class="line">    postFormat:&nbsp;(e,&nbsp;{&nbsp;stack,&nbsp;...rest&nbsp;})&nbsp;=&gt; process.env.NODE_ENV&nbsp;===&nbsp;'production'&nbsp;?&nbsp;rest&nbsp;:&nbsp;{&nbsp;stack,&nbsp;...rest&nbsp;}</span><br><span class="line">}))</span><br></pre></td></tr></tbody></table></figure>
<p> 为使所有请求接口使用错误处理，<code>app.use(jsonError())</code>需放置在前面。</p>
</li>
</ol>
<h5 id="使用-koa-parameter-校验参数"><a href="#使用-koa-parameter-校验参数" class="headerlink" title="使用 koa-parameter 校验参数"></a>使用 koa-parameter 校验参数</h5><ol>
<li>安装 <strong>npm i koa-parameter –save</strong></li>
<li>导入并使用 <figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">const&nbsp;parameter&nbsp;=&nbsp;require(<span class="string">'koa-parameter'</span>)</span><br><span class="line"></span><br><span class="line">// 由于需要在发出请求后进行校验参数，所以校验中间件放在请求之后</span><br><span class="line"></span><br><span class="line">app.use(bodyParser())</span><br><span class="line">app.use(parameter(app))</span><br></pre></td></tr></tbody></table></figure>
</li>
<li>在具体路由中写校验规则，如 users 创建用户接口 <figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ctx.verifyParams({</span><br><span class="line">    name:&nbsp;{&nbsp;type:&nbsp;<span class="string">'string'</span>,&nbsp;required:&nbsp;true&nbsp;},</span><br><span class="line">    age:&nbsp;{&nbsp;type:&nbsp;<span class="string">'number'</span>,&nbsp;required:&nbsp;false&nbsp;}</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>
<h4 id="MongoDB"><a href="#MongoDB" class="headerlink" title="MongoDB"></a>MongoDB</h4></li>
</ol>
<h5 id="Mongoose"><a href="#Mongoose" class="headerlink" title="Mongoose"></a>Mongoose</h5><p><strong>Mongoose</strong>是一个开源的封装好的实现 <code>Node</code> 和 <code>MongoDB</code> 数据通讯的数据建模库。</p>
<ol>
<li><p>安转 <code>npm i mongoose --seve</code> 安装 <code>glob</code>导入所有的 <code>schema</code>: <code>npm i glob --save</code></p>
</li>
<li><p>连接 <strong>Mongoose</strong></p>
<p> 在根目录下创建 <code>database</code> 文件夹，用来存放和数据库操作有关的文件。在 <code>database</code> 文件夹下，建立一个<code>init.js</code> 文件，用来作数据库的连接和一些初始化的事情。</p>
<p> 使用 <code>promise</code> ，确保成功连接数据库，需要对意外处理和逻辑处理。让程序增加健壮性。</p>
 <figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">const&nbsp;mongoose&nbsp;=&nbsp;require("mongoose")</span><br><span class="line">const&nbsp;glob&nbsp;=&nbsp;require("glob")</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 设置  mongoose.set('useFindAndModify',&nbsp;false) 使 mongoose数据库查询与删除不报异常</span><br><span class="line"> *&nbsp;允许使用&nbsp;*&nbsp;符号，来写一个glob规则</span><br><span class="line"> *&nbsp;resolve：将一系列路径或路径段解析为绝对路径</span><br><span class="line"> */</span><br><span class="line"> </span><br><span class="line">mongoose.set('useFindAndModify',&nbsp;false)</span><br><span class="line">const&nbsp;{&nbsp;resolve&nbsp;}&nbsp;=&nbsp;require("path")</span><br><span class="line"></span><br><span class="line">//&nbsp;引入所有定义的schema</span><br><span class="line">exports.initSchemas&nbsp;=&nbsp;()&nbsp;=&gt;&nbsp;{</span><br><span class="line">    glob.sync(resolve(__dirname,&nbsp;"./schema/",&nbsp;"**/*.js")).forEach(require)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">exports.connect&nbsp;=&nbsp;()&nbsp;=&gt;&nbsp;{</span><br><span class="line">    //&nbsp;连接数据库</span><br><span class="line">    mongoose.connect(db)</span><br><span class="line">    let&nbsp;maxConnectTimes&nbsp;=&nbsp;0</span><br><span class="line">    return&nbsp;new&nbsp;Promise((resolve,&nbsp;reject)&nbsp;=&gt;&nbsp;{</span><br><span class="line">        //&nbsp;数据库连接事件监听</span><br><span class="line">        mongoose.connection.on("disconnected",&nbsp;err&nbsp;=&gt;&nbsp;{</span><br><span class="line">            console.log("数据库断开")</span><br><span class="line">            if&nbsp;(maxConnectTimes&nbsp;&lt;&nbsp;3)&nbsp;{</span><br><span class="line">                maxConnectTimes++</span><br><span class="line">                mongoose.connect(db)</span><br><span class="line">            }&nbsp;else&nbsp;{</span><br><span class="line">                reject(err)</span><br><span class="line">                throw&nbsp;new&nbsp;Error("数据库断开")</span><br><span class="line">            }</span><br><span class="line">        })</span><br><span class="line">        //&nbsp;数据库连接错误</span><br><span class="line">        mongoose.connection.on("error",&nbsp;err&nbsp;=&gt;&nbsp;{</span><br><span class="line">            console.log("数据库错误")</span><br><span class="line">            if&nbsp;(maxConnectTimes&nbsp;&lt;&nbsp;3)&nbsp;{</span><br><span class="line">                maxConnectTimes++</span><br><span class="line">                mongoose.connect(db)</span><br><span class="line">            }&nbsp;else&nbsp;{</span><br><span class="line">                reject(err)</span><br><span class="line">                throw&nbsp;new&nbsp;Error("数据库错误")</span><br><span class="line">            }</span><br><span class="line">        })</span><br><span class="line">        //&nbsp;数据库连接打开时，只需要连接一次once</span><br><span class="line">        mongoose.connection.once("open",&nbsp;()&nbsp;=&gt;&nbsp;{</span><br><span class="line">            console.log('MongoDB&nbsp;Connected&nbsp;successfully!')</span><br><span class="line">            resolve()</span><br><span class="line">        })</span><br><span class="line">    })</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
<li></li>
</ol>
<h4 id="App"><a href="#App" class="headerlink" title="App"></a>App</h4><p>一个规范有序的目录更富有表现性与逻辑性，让人耳目一新，简单上手。所有文件是以 <code>app</code>为根路径。</p>
<pre><code>&lt;!--hexoPostRenderEscape:&lt;figure class="highlight awk"&gt;&lt;table&gt;&lt;tr&gt;&lt;td class="gutter"&gt;&lt;pre&gt;&lt;span class="line"&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;13&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class="code"&gt;&lt;pre&gt;&lt;span class="line"&gt;├── routes  &lt;span class="regexp"&gt;//&lt;/span&gt; 路由&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;├──── index.js  &lt;span class="regexp"&gt;//&lt;/span&gt; 路由导入文件&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;├──── home.js  &lt;span class="regexp"&gt;//&lt;/span&gt; home路由&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;├──── users.js  &lt;span class="regexp"&gt;//&lt;/span&gt;  用户路由&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;├── controllers &lt;span class="regexp"&gt;//&lt;/span&gt; 控制器&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;├──── home.js  &lt;span class="regexp"&gt;//&lt;/span&gt; home&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;├──── users.js  &lt;span class="regexp"&gt;//&lt;/span&gt;  users控制器&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;├── database &lt;span class="regexp"&gt;//&lt;/span&gt; 数据库&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;├──── init.js  &lt;span class="regexp"&gt;//&lt;/span&gt;  数据库连接设置文件&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;├──── schema  &lt;span class="regexp"&gt;//&lt;/span&gt; schema&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;├───── Users.js  &lt;span class="regexp"&gt;//&lt;/span&gt;  用户数据库&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;├── public  &lt;span class="regexp"&gt;//&lt;/span&gt;  公共文件&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;├──── upload  &lt;span class="regexp"&gt;//&lt;/span&gt;  图片上传目录&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;:hexoPostRenderEscape--&gt;
</code></pre>
<h5 id="controllers控制器"><a href="#controllers控制器" class="headerlink" title="controllers控制器"></a>controllers控制器</h5><p><strong>Controller控制器</strong>，是MVC中的部分C，此处的控制器主要负责功能处理部分：</p>
<pre><code>1. 收集、验证请求参数并绑定到命令对象；
2. 处理业务，并将业务模块返回给路由。
</code></pre>
<ol>
<li><p>users.js控制器</p>
 <figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">const&nbsp;db&nbsp;=&nbsp;[{&nbsp;name:&nbsp;<span class="string">"lx"</span>&nbsp;}]</span><br><span class="line"></span><br><span class="line">class&nbsp;UsersControl&nbsp;{</span><br><span class="line">    find(ctx)&nbsp;{</span><br><span class="line">        ctx.body&nbsp;=&nbsp;db</span><br><span class="line">    }</span><br><span class="line">    findById(ctx)&nbsp;{</span><br><span class="line">        ctx.body&nbsp;=&nbsp;db[ctx.params.id&nbsp;*&nbsp;<span class="number">1</span>]</span><br><span class="line">    }</span><br><span class="line">    create(ctx)&nbsp;{</span><br><span class="line">        db.push(ctx.request.body)</span><br><span class="line">        ctx.body&nbsp;=&nbsp;ctx.request.body</span><br><span class="line">    }</span><br><span class="line">    update(ctx)&nbsp;{</span><br><span class="line">        db[ctx.params.id&nbsp;*&nbsp;<span class="number">1</span>]&nbsp;=&nbsp;ctx.request.body</span><br><span class="line">        ctx.body&nbsp;=&nbsp;ctx.request.body</span><br><span class="line">    }</span><br><span class="line">    delete(ctx)&nbsp;{</span><br><span class="line">        db.splice(ctx.params.id&nbsp;*&nbsp;<span class="number">1</span>,&nbsp;<span class="number">1</span>)</span><br><span class="line">        ctx.status&nbsp;=&nbsp;<span class="number">204</span></span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">module.exports&nbsp;=&nbsp;new&nbsp;UsersControl()</span><br></pre></td></tr></tbody></table></figure>


</li>
</ol>
<h5 id="routes路由"><a href="#routes路由" class="headerlink" title="routes路由"></a>routes路由</h5><p>将每个功能模块拆分为一个个独立的路由，有助于使代码结构易懂。其中，最重要的是 **<code>路由导入文件index.js</code>**， 它将所有的路由通过脚本引入，不需要一个个的引入，减少代码，使其上档次~。</p>
<ol>
<li><p><strong>index.js</strong></p>
 <figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">const&nbsp;fs&nbsp;=&nbsp;require(<span class="string">"fs"</span>)</span><br><span class="line"></span><br><span class="line">module.exports&nbsp;=&nbsp;(res)&nbsp;=&gt;&nbsp;{</span><br><span class="line">    fs.readdirSync(__dirname).forEach(file&nbsp;=&gt;&nbsp;{</span><br><span class="line">        <span class="keyword">if</span>&nbsp;(file&nbsp;===&nbsp;<span class="string">"index.js"</span>)&nbsp;<span class="keyword">return</span></span><br><span class="line">        const&nbsp;route&nbsp;=&nbsp;require(`./${file}`)</span><br><span class="line">        res.use(route.routes()).use(route.allowedMethods())&nbsp;</span><br><span class="line">    })</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p> **<code>allowedMethods</code>**， 顾名思义，就是当前接口允许运行的<code>method</code>。比如，一个提供数据接的接口，设置为 <code>GET</code>， 当客户端发送 <code>POST</code>请求时就会返回错误信息。</p>
<p> 然后在 <code>index.js</code> 中导入并注册。</p>
 <figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">const&nbsp;router&nbsp;=&nbsp;require(<span class="string">'./routes'</span>)</span><br><span class="line"></span><br><span class="line">router(app)</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>业务路由（如user.js）</p>
<p> 每个业务路由都需导入 <strong>Koa-router ：</strong>  <code>const&nbsp;Router&nbsp;=&nbsp;require("koa-router")</code></p>
<p> 添加路由前缀，方便更改和复用：<code>const&nbsp;router&nbsp;=&nbsp;new&nbsp;Router({&nbsp;prefix:&nbsp;"/users"&nbsp;})</code></p>
<p> 在业务路由中导入相对应的控制器，即可完成对业务控制器的融洽结合，完成其具体业务功能：</p>
 <figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">const&nbsp;{&nbsp;find,&nbsp;findById,&nbsp;create,&nbsp;update,&nbsp;delete:&nbsp;<span class="keyword">del</span>&nbsp;}&nbsp;=&nbsp;require(<span class="string">"../controllers/users"</span>)</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">"/"</span>,&nbsp;find)</span><br><span class="line">router.post(<span class="string">"/"</span>,&nbsp;create)</span><br><span class="line">router.get(<span class="string">"/:id"</span>,&nbsp;findById)</span><br><span class="line">router.put(<span class="string">"/:id"</span>,&nbsp;update)</span><br><span class="line">router.delete(<span class="string">"/:id"</span>,&nbsp;<span class="keyword">del</span>)</span><br><span class="line"></span><br><span class="line">module.exports&nbsp;=&nbsp;router</span><br></pre></td></tr></tbody></table></figure>

</li>
</ol>
<h4 id="用户认证与授权"><a href="#用户认证与授权" class="headerlink" title="用户认证与授权"></a>用户认证与授权</h4><h5 id="Session"><a href="#Session" class="headerlink" title="Session"></a>Session</h5><ol>
<li><p>相比<code>JWT</code>，最大的优势就在于可以主动清除 <code>session</code>。</p>
</li>
<li><p><code>session</code>保存在服务器端，相对较为安全。</p>
</li>
<li><p>结合<code>cookie</code>使用，较为灵活，兼容性较好。但是在跨域场景表现不好。</p>
<h5 id="JWT"><a href="#JWT" class="headerlink" title="JWT"></a>JWT</h5></li>
</ol>
<p><strong><code>JWT</code></strong> 的构成</p>
<p>根据官网的定义，JSON Web Token（以下简称 JWT）是一套开放的标准（RFC 7519），它定义了一套简洁（compact）且 URL 安全（URL-safe）的方案，以安全地在客户端和服务器之间传输 JSON 格式的信息。</p>
<ol>
<li><p>头部（Header）</p>
<ul>
<li>typ（类型）：token的类型，这里固定位为 <code>JWT</code></li>
<li>alg（算法）：使用的hash算法，例如：HMAC SHA256 或者 RSA</li>
</ul>
</li>
<li><p>有效载荷（Payload）</p>
<ul>
<li>存储需要传递的信息。如用户ID、用户名等。</li>
<li>元数据。如过期时间、发布人等。</li>
<li>与Header不同，Payload可以加密。</li>
</ul>
</li>
<li><p>签名（Signature）</p>
<ul>
<li>对Header和Payload部分进行签名</li>
<li>保证Token在传输的过程中没有被篡改或者损坏。</li>
</ul>
</li>
</ol>
<h5 id="koa-jwt-实现认证与授权"><a href="#koa-jwt-实现认证与授权" class="headerlink" title="koa-jwt 实现认证与授权"></a>koa-jwt 实现认证与授权</h5><ol>
<li><p><code>npm install koa-jwt --save</code> 下载</p>
</li>
<li><p>使用中间件保护接口，实现认证</p>
 <figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">const&nbsp;jwt&nbsp;=&nbsp;require(<span class="string">"koa-jwt"</span>)</span><br><span class="line"></span><br><span class="line">引入秘钥</span><br><span class="line">const&nbsp;{&nbsp;secret&nbsp;}&nbsp;=&nbsp;require(<span class="string">"../config"</span>)</span><br><span class="line"></span><br><span class="line">const&nbsp;auth&nbsp;=&nbsp;jwt({&nbsp;secret&nbsp;});</span><br><span class="line"></span><br><span class="line">实现认证</span><br><span class="line"></span><br><span class="line">router.delete(<span class="string">"/:id"</span>,&nbsp;auth,&nbsp;checkOwner,&nbsp;<span class="keyword">del</span>)</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>使用中间件获取用户信息</p>
</li>
</ol>
<h4 id="图片上传"><a href="#图片上传" class="headerlink" title="图片上传"></a>图片上传</h4><h5 id="koa-body"><a href="#koa-body" class="headerlink" title="koa-body"></a>koa-body</h5><p>之前使用 <code>koa2</code> 的时候，处理 <code>post</code> 请求使用的是&nbsp;<code>koa-bodyparser</code>，同时如果是<code>图片上传</code>使用的是&nbsp;<code>koa-multer</code>。</p>
<p>但是这两者可以通过&nbsp;<code>koa-body</code>&nbsp;代替，<strong>并且只是用&nbsp;koa-body&nbsp;即可</strong>。<a target="_blank" rel="noopener" href="http://www.ptbird.cn/koa-body.html">koa-body文档</a></p>
<ol>
<li><p>安装<code>npm i koa-body --save</code></p>
</li>
<li><p>全局设置</p>
 <figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">const koaBody = require(<span class="string">'koa-body'</span>)</span><br><span class="line">const&nbsp;path&nbsp;=&nbsp;require(<span class="string">"path"</span>)</span><br><span class="line"></span><br><span class="line">const app = new koa()</span><br><span class="line"></span><br><span class="line">app.use(koaBody({</span><br><span class="line">    multipart:&nbsp;true,&nbsp;//&nbsp;支持文件上传</span><br><span class="line">    formidable:&nbsp;{</span><br><span class="line">        uploadDir:&nbsp;path.join(__dirname,&nbsp;<span class="string">"/public/uploads"</span>),&nbsp;&nbsp;&nbsp;//&nbsp;上传文件目录</span><br><span class="line">        keepExtensions:&nbsp;true,&nbsp;//&nbsp;保留扩展名</span><br><span class="line">        maxFieldsSize:&nbsp;<span class="number">2</span>&nbsp;*&nbsp;<span class="number">1024</span>&nbsp;*&nbsp;<span class="number">1024</span>,&nbsp;//&nbsp;文件上传大小</span><br><span class="line">        onFileBegin:&nbsp;(name,&nbsp;file)&nbsp;=&gt;&nbsp;{&nbsp;//&nbsp;文件上传前的设置</span><br><span class="line">        },</span><br><span class="line">    }</span><br><span class="line">}))</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>图片上传路由</p>
 <figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">class&nbsp;HomeControl&nbsp;{</span><br><span class="line">    upload(ctx)&nbsp;{</span><br><span class="line">        const&nbsp;file&nbsp;=&nbsp;ctx.request.files.file</span><br><span class="line">        /**</span><br><span class="line">         *&nbsp;获取上传文件信息&nbsp;ctx.request.files</span><br><span class="line">         *&nbsp;&nbsp;size&nbsp;&nbsp;&nbsp;&nbsp;文件大小</span><br><span class="line">            path&nbsp;&nbsp;&nbsp;&nbsp;文件上传后的目录</span><br><span class="line">            name&nbsp;&nbsp;&nbsp;&nbsp;文件的原始名称</span><br><span class="line">            type&nbsp;&nbsp;&nbsp;&nbsp;文件类型</span><br><span class="line">         *&nbsp;</span><br><span class="line">         */</span><br><span class="line">        ctx.body&nbsp;=&nbsp;{&nbsp;path:&nbsp;file.path&nbsp;}</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line">module.exports&nbsp;=&nbsp;new&nbsp;HomeControl()</span><br></pre></td></tr></tbody></table></figure>
<h5 id="koa-static"><a href="#koa-static" class="headerlink" title="koa-static"></a>koa-static</h5></li>
</ol>
<p>使用<code>koa-static</code>生成图片链接</p>
<ol>
<li><p>安装<code>npm i koa-static --save</code></p>
</li>
<li><p>设置静态文件目录</p>
 <figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">const&nbsp;koaStatic&nbsp;=&nbsp;require(<span class="string">"koa-static"</span>)</span><br><span class="line"></span><br><span class="line">app.use(koaStatic(path.join(__dirname,&nbsp;<span class="string">"public"</span>)))</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>生成图片链接</p>
<pre class=" language-python"><code class="language-python">upload<span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token operator">&amp;</span>nbsp<span class="token punctuation">;</span><span class="token punctuation">{</span>
    const<span class="token operator">&amp;</span>nbsp<span class="token punctuation">;</span>file<span class="token operator">&amp;</span>nbsp<span class="token punctuation">;</span><span class="token operator">=</span><span class="token operator">&amp;</span>nbsp<span class="token punctuation">;</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>files<span class="token punctuation">.</span>file
    const<span class="token operator">&amp;</span>nbsp<span class="token punctuation">;</span>basename<span class="token operator">&amp;</span>nbsp<span class="token punctuation">;</span><span class="token operator">=</span><span class="token operator">&amp;</span>nbsp<span class="token punctuation">;</span>path<span class="token punctuation">.</span>basename<span class="token punctuation">(</span>file<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token operator">&amp;</span>nbsp<span class="token punctuation">;</span><span class="token operator">//</span><span class="token operator">&amp;</span>nbsp<span class="token punctuation">;</span>解析图片相对路径
    <span class="token operator">//</span><span class="token operator">&amp;</span>nbsp<span class="token punctuation">;</span>ctx<span class="token punctuation">.</span>origin<span class="token operator">&amp;</span>nbsp<span class="token punctuation">;</span>域名
    ctx<span class="token punctuation">.</span>body<span class="token operator">&amp;</span>nbsp<span class="token punctuation">;</span><span class="token operator">=</span><span class="token operator">&amp;</span>nbsp<span class="token punctuation">;</span><span class="token punctuation">{</span><span class="token operator">&amp;</span>nbsp<span class="token punctuation">;</span>url<span class="token punctuation">:</span><span class="token operator">&amp;</span>nbsp<span class="token punctuation">;</span>`$<span class="token punctuation">{</span>ctx<span class="token punctuation">.</span>origin<span class="token punctuation">}</span><span class="token operator">/</span>uploads<span class="token operator">/</span>$<span class="token punctuation">{</span>basename<span class="token punctuation">}</span>`<span class="token operator">&amp;</span>nbsp<span class="token punctuation">;</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</li>
</ol>
<p>12.4</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/04/26/linux-an-zhuang-mysql/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/04/26/linux-an-zhuang-mysql/" class="post-title-link" itemprop="url">linux安装mysql</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-04-25 17:46:44" itemprop="dateCreated datePublished" datetime="2021-04-25T17:46:44Z">2021-04-25</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-06-06 16:43:00" itemprop="dateModified" datetime="2021-06-06T16:43:00Z">2021-06-06</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" itemprop="url" rel="index"><span itemprop="name">操作系统</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>官方文档<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/linux-installation-yum-repo.html">https://dev.mysql.com/doc/refman/8.0/en/linux-installation-yum-repo.html</a></p>
<ol>
<li>下载 <a target="_blank" rel="noopener" href="https://dev.mysql.com/downloads/file/?id=484922%EF%BC%8C%E6%89%BE%E5%88%B0linux7">https://dev.mysql.com/downloads/file/?id=484922，找到linux7</a> 或 8 对应的版本右键<code>No thanks, just start my download.</code>复制链接<br>下载并安装MySQL官方的Yum Repository</li>
</ol>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://dev.mysql.com/get/Downloads/MySQL-8.0/mysql-community-8.0.24-1.el7.src.rpm</span><br><span class="line">[root@VM-0-9-centos ~]<span class="comment"># ls</span></span><br><span class="line">authorized_keys  dev  file1  file2  file3  mysql-community-8.0.24-1.el7.src.rpm  test1</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y mysql80-community-release-el7-3.noarch.rpm</span><br></pre></td></tr></tbody></table></figure>
<p>安装这个包后，会获得两个mysql的yum repo源：<code>/etc/yum.repos.d/mysql-community.repo</code>，<code>/etc/yum.repos.d/mysql-community-source.repo</code>。</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum install mysqlMySQL</span><br><span class="line">yum install mysql-server</span><br><span class="line"><span class="comment"># 也可以</span></span><br><span class="line">sudo apt-get mysql-server</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-0-9-centos ~]<span class="comment"># yum repolist enabled | grep "mysql.*-community.*"</span></span><br><span class="line">mysql-connectors-community/x86_64    MySQL Connectors Community              194</span><br><span class="line">mysql-tools-community/x86_64         MySQL Tools Community                   126</span><br><span class="line">mysql80-community/x86_64             MySQL 8.0 Community Server              247</span><br></pre></td></tr></tbody></table></figure>

<p>linux MySQL的启动控制 进入mysql的方式：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">systemctl start/stop/restart mysqld</span><br><span class="line">[root@VM-0-9-centos ~]<span class="comment"># ps aux|grep mysql</span></span><br><span class="line">root     20615  0.0  0.0 112816   976 pts/9    R+   12:34   0:00 grep --color=auto mysql</span><br><span class="line">mysql    25791  0.1 20.3 1338744 382980 ?      Ssl  Apr24  32:25 /usr/sbin/mysqld</span><br><span class="line">[root@VM-0-9-centos ~]<span class="comment"># ps -ef | grep mysql</span></span><br><span class="line">root     20797 14488  0 12:35 pts/9    00:00:00 grep --color=auto mysql</span><br><span class="line">mysql    25791     1  0 Apr24 ?        00:32:25 /usr/sbin/mysqld</span><br><span class="line">systemctl status mysqld</span><br><span class="line"></span><br><span class="line">[root@VM-0-9-centos ~]<span class="comment"># sudo grep 'temporary password' /var/log/mysqld.log</span></span><br><span class="line">2021-04-24T08:45:29.536875Z 6 [Note] [MY-010454] [Server] A temporary password is generated <span class="keyword">for</span> root@localhost: Q+s/T:;dS8r9</span><br></pre></td></tr></tbody></table></figure>
<p>Q+s/T:;dS8r9 为mysql root用户密码</p>
<p>查看端口号（默认端口号3306）</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-0-9-centos ~]<span class="comment"># netstat -tnlp</span></span><br><span class="line">Active Internet connections (only servers)</span><br><span class="line">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    </span><br><span class="line">tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      25528/nginx: master </span><br><span class="line">tcp        0      0 127.0.0.1:39602         0.0.0.0:*               LISTEN      14656/node          </span><br><span class="line">tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      1346/sshd           </span><br><span class="line">tcp6       0      0 :::33060                :::*                    LISTEN      25791/mysqld        </span><br><span class="line">tcp6       0      0 :::3306                 :::* </span><br></pre></td></tr></tbody></table></figure>


<p>连接 远程登陆 </p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql -u用户名 -p</span><br><span class="line">mysql -h 服务器IP地址、主机 -P 端口号 -uroot -p</span><br></pre></td></tr></tbody></table></figure>
<p>输入密码</p>
<p>建立用户并授权</p>
<p>自定义密码MyNewPass4</p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// 法1</span><br><span class="line">mysql&gt; ALTER USER 'root'@'localhost' IDENTIFIED BY 'MyNewPass4!';</span><br><span class="line"></span><br><span class="line"><span class="comment"># 法二</span></span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> <span class="keyword">PRIVILEGES</span> <span class="keyword">ON</span> *.* <span class="keyword">TO</span> <span class="string">'root'</span>@<span class="string">'%'</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'MyNewPass4!'</span> <span class="keyword">WITH</span> <span class="keyword">GRANT</span> <span class="keyword">OPTION</span>;</span><br><span class="line"><span class="keyword">flush</span> <span class="keyword">PRIVILEGES</span>;</span><br></pre></td></tr></tbody></table></figure>

<p><code>*.*</code> 表示所有表<br><code>%</code> 表示所有的外部ip</p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">USER</span> <span class="string">'root'</span>@<span class="string">'%'</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">WITH</span> mysql_native_password <span class="keyword">BY</span> <span class="string">'MyNewPass4!'</span>;</span><br></pre></td></tr></tbody></table></figure>

<p>在实际运维工作中，远程连接账号尽量不要使用root。<br>应该手工创建 一个普通账号，然后按需分配权限</p>
<p>退出MySQL到linux命令行：</p>
<figure class="highlight"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql &gt; exit</span><br></pre></td></tr></tbody></table></figure>

<p>默认root只能在本地连接</p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select user,host from mysql.user;</span><br><span class="line">+<span class="comment">------------------+-----------+</span></span><br><span class="line">| user             | host      |</span><br><span class="line">+<span class="comment">------------------+-----------+</span></span><br><span class="line">| mysql.infoschema | localhost |</span><br><span class="line">| mysql.session    | localhost |</span><br><span class="line">| mysql.sys        | localhost |</span><br><span class="line">| root             | localhost |</span><br><span class="line">+<span class="comment">------------------+-----------+</span></span><br><span class="line">4 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></tbody></table></figure>

<p>Linux配置MySQL远程连接访问权限</p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; update mysql.user set host = '%' where user = 'root' ;</span><br><span class="line">mysql&gt; select user,host from mysql.user;</span><br><span class="line">+<span class="comment">------------------+-----------+</span></span><br><span class="line">| user             | host      |</span><br><span class="line">+<span class="comment">------------------+-----------+</span></span><br><span class="line">| root             | %         |</span><br><span class="line">| mysql.infoschema | localhost |</span><br><span class="line">| mysql.session    | localhost |</span><br><span class="line">| mysql.sys        | localhost |</span><br><span class="line">+<span class="comment">------------------+-----------+</span></span><br><span class="line">4 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">select</span> <span class="keyword">user</span>,host <span class="keyword">from</span> mysql.user <span class="keyword">where</span> <span class="keyword">user</span>=<span class="string">'root'</span>;</span><br><span class="line">+<span class="comment">------+------+</span></span><br><span class="line">| user | host |</span><br><span class="line">+<span class="comment">------+------+</span></span><br><span class="line">| root | %    |</span><br><span class="line">+<span class="comment">------+------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></tbody></table></figure>
<p>看到有一条 host值为<code>%</code>，说明授权了</p>
<p>看你的mysql在哪，通过which命令</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-0-9-centos ~]<span class="comment"># which mysql</span></span><br><span class="line">/usr/bin/mysql</span><br></pre></td></tr></tbody></table></figure>

<p>查看 mysql 配置文件加载顺序</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-0-9-centos ~]<span class="comment"># /usr/bin/mysql --verbose --help | grep -A 1 'Default options'</span></span><br><span class="line">Default options are <span class="built_in">read</span> from the following files <span class="keyword">in</span> the given order:</span><br><span class="line">/etc/my.cnf /etc/mysql/my.cnf /usr/etc/my.cnf ~/.my.cnf </span><br><span class="line"></span><br><span class="line">[root@VM-0-9-centos ~]<span class="comment"># mysql --help|grep 'my.cnf'</span></span><br><span class="line">                      order of preference, my.cnf, <span class="variable">$MYSQL_TCP_PORT</span>,</span><br><span class="line">/etc/my.cnf /etc/mysql/my.cnf /usr/etc/my.cnf ~/.my.cnf</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<p>mysql默认会搜寻my.cnf的目录，顺序排前的优先<br>服务器首先读取的是 /etc/my.cnf 文件，如果前一个文件不存在则继续读 /etc/mysql/my.cnf 文件，依此类推，如若还不存在便会去读~/.my.cnf文件。</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ps aux|grep mysql|grep <span class="string">'my.cnf'</span></span><br><span class="line">上面的命令没有输出，表示没有设置使用指定目录的my.cnf</span><br></pre></td></tr></tbody></table></figure>


<p>如果以上文件都不存在，则说明在对mysql编译完成之后你没有对mysql进行配置，<br>启动时没有使用配置文件<br>如果没有设置使用指定目录my.cnf文件及默认读取目录没有my.cnf文件，表示mysql启动时并没有加载配置文件，而是使用默认配置。</p>
<p>需要修改配置，可以在mysql默认读取的目录中，<br>需要你自己复制一份mysql提供的默认配置文件到上面提到的目录中，然后改名为my.cnf(例如:/etc/my.cnf)，把需要修改的配置内容写入，修改文件的所有者和所属组并赋予执行权限。</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mkdir /usr/mysql/etc</span><br><span class="line"></span><br><span class="line">cp /usr/mysql/support-files/my-default.cnf /usr/mysql/etc/my.cnf</span><br><span class="line"></span><br><span class="line">chown -R mysql:mysql /usr/mysql/etc/</span><br><span class="line"></span><br><span class="line">chmod 755 /usr/mysql/etc/my.cnf</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/mysql/etc/my.cnf</span><br><span class="line"></span><br><span class="line">basedir = /usr/mysql              <span class="comment"># 指mysql的安装目录</span></span><br><span class="line">datadir = /usr/mysql/data         <span class="comment"># 指mysql的数据存放目录</span></span><br><span class="line">port = 3306                             <span class="comment"># 指mysql的监听端口</span></span><br></pre></td></tr></tbody></table></figure>

<p>最后重启mysql使配置生效</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/mysql/support-files/mysql.server restart</span><br></pre></td></tr></tbody></table></figure>

<p>如果修改my.cnf后mysql启动不了,可以通过如下方式查看错误信息</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/mysql/bin/mysqld --verbose --<span class="built_in">help</span> | grep -A 1 <span class="string">'Default options'</span></span><br></pre></td></tr></tbody></table></figure><script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/04/26/linux-an-zhuang-redis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/04/26/linux-an-zhuang-redis/" class="post-title-link" itemprop="url">linux安装redis</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-04-25 17:46:44" itemprop="dateCreated datePublished" datetime="2021-04-25T17:46:44Z">2021-04-25</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-05-11 04:09:41" itemprop="dateModified" datetime="2021-05-11T04:09:41Z">2021-05-11</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" itemprop="url" rel="index"><span itemprop="name">操作系统</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://redis.io/download">https://redis.io/download</a> 右键download复制连接</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-0-9-centos ~]<span class="comment"># wget https://download.redis.io/releases/redis-6.0.12.tar.gz</span></span><br></pre></td></tr></tbody></table></figure>
<p>解压</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-0-9-centos ~]<span class="comment"># tar -zxvf redis-6.0.12.tar.gz </span></span><br></pre></td></tr></tbody></table></figure>

<p>设置软连接</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -s redis-6.0.12 redis</span><br></pre></td></tr></tbody></table></figure>

<p>开始进行配置、编译<br>redis用c语言编写</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-0-9-centos ~]<span class="comment"># yum install gcc gcc-c++</span></span><br></pre></td></tr></tbody></table></figure>
<p>yum安装的gcc是4.8.5的，升级gcc</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">yum -y install centos-release-scl</span><br><span class="line"> </span><br><span class="line">yum -y install devtoolset-9-gcc devtoolset-9-gcc-c++ devtoolset-9-binutils</span><br><span class="line"> </span><br><span class="line">scl <span class="built_in">enable</span> devtoolset-9 bash</span><br><span class="line"> </span><br><span class="line"><span class="built_in">echo</span> <span class="string">"source /opt/rh/devtoolset-9/enable"</span> &gt;&gt; /etc/profile</span><br><span class="line"> </span><br><span class="line">gcc -v</span><br><span class="line"></span><br><span class="line">[root@VM-0-9-centos redis-6.0.12]<span class="comment"># make</span></span><br><span class="line">[root@VM-0-9-centos redis-6.0.12]<span class="comment"># make install</span></span><br></pre></td></tr></tbody></table></figure>

<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/27/">27</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>
<script src="/js/comments.js"></script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">外心人D</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
