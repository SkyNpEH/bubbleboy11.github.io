<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.0.2">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"bubbleboy11.github.io","root":"/","images":"/images","scheme":"Muse","version":"8.6.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>
<meta name="description" content="本博客大多内容为慕课和网上博客，并非原创">
<meta property="og:type" content="website">
<meta property="og:title" content="外心人D的博客">
<meta property="og:url" content="https://bubbleboy11.github.io/page/3/index.html">
<meta property="og:site_name" content="外心人D的博客">
<meta property="og:description" content="本博客大多内容为慕课和网上博客，并非原创">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="外心人D">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://bubbleboy11.github.io/page/3/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/3/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>外心人D的博客</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="外心人D的博客" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism.css" type="text/css"></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">外心人D的博客</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-overview">
            <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">外心人D</p>
  <div class="site-description" itemprop="description">本博客大多内容为慕课和网上博客，并非原创</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">344</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">22</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">39</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



          </div>
        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/07/07/go-jie-gou-ti-de-shi-li-hua-he-new-han-shu/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/07/07/go-jie-gou-ti-de-shi-li-hua-he-new-han-shu/" class="post-title-link" itemprop="url">go结构体的实例化和new函数</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-07-06 16:21:41" itemprop="dateCreated datePublished" datetime="2021-07-06T16:21:41Z">2021-07-06</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-08-07 11:08:12" itemprop="dateModified" datetime="2021-08-07T11:08:12Z">2021-08-07</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>结构体和其它高级语言里的「类」比较类似。<br>go语言没有class这个概念，所以说对于很多人来说会少理解很多面向对象抽象的概念</p>
<p>如果说 Go 语言的基础类型是原子，那么结构体就是分子。分子是原子的组合，让形式有限的基础类型变化出丰富多样的形态结构。</p>
<p>结构体字段可以是任何类型，以及结构体本身，函数，接口、切片、字典、数组以及其它类型的结构体等等。<br>因为结构体的存在，Go 语言的变量才有了更加丰富多彩的形式，Go 语言程序的高楼大厦正是通过结构体一层层组装起来的。</p>
<p>go语言的struct更像是namedtuple, 尽量配置简单的语法尽量猜测你的意图，<br>只能存放数据的集合，有成员变量属性的名称，不能定义函数<br>结构体是值类型，通过组合一定数据的字段来完成<br>用于自定义数据类型与实现面向对象</p>
<p>结构体类型是某一类具体事物的抽象<br>以中秋节的月饼举例，月饼的模板，做出月饼</p>
<p>结构创建在堆上还是栈上？ 不需要知道</p>
<p>结构体命名<br>采用驼峰命名法，首字母根据访问控制大写或者小写</p>
<h2 id="结构体类型的定义"><a href="#结构体类型的定义" class="headerlink" title="结构体类型的定义"></a>结构体类型的定义</h2><p>struct 申明格式采用多行</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 多行申明</span></span><br><span class="line"><span class="keyword">type</span> userinfo <span class="keyword">struct</span> {</span><br><span class="line">    name      <span class="keyword">string</span></span><br><span class="line">    age       <span class="keyword">int</span></span><br><span class="line">    height    <span class="keyword">float32</span></span><br><span class="line">    eduschool <span class="keyword">string</span></span><br><span class="line">    hobby     []<span class="keyword">string</span></span><br><span class="line">    moreinfo  <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>{}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>Course结构体内部有三个变量，分别是价格、课程名、url。</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Course <span class="keyword">struct</span> {</span><br><span class="line">    Name  <span class="keyword">string</span></span><br><span class="line">    Price <span class="keyword">int</span></span><br><span class="line">    Url   <span class="keyword">string</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">``</span><span class="string">`</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## 结构体变量的实例化创建</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">创建一个结构体变量有多种形式，</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">我们先看结构体变量最常见的创建形式</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### KV 形式</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">通过显示指定结构体内部字段的名称和初始值来初始化结构体，可以只指定部分字段的初值，甚至可以一个字段都不指定，那些没有指定初值的字段会自动初始化为相应类型的「零值」。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">不论地址还是结构本身，一律使用 `</span>.<span class="string">` 来访问成员</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">`</span><span class="string">``</span><span class="keyword">go</span></span><br><span class="line">    <span class="keyword">var</span> c Course = Course{</span><br><span class="line">        Name:  <span class="string">"django"</span>,</span><br><span class="line">        Price: <span class="number">100</span>,</span><br><span class="line">        Url:   <span class="string">"https://www.imooc.com"</span>,  <span class="comment">// 注意这里的逗号不能少</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 访问</span></span><br><span class="line">    fmt.Printf(<span class="string">"%+v\n"</span>, c) <span class="comment">// {Name:django Price:100 Url:https://www.imooc.com}</span></span><br><span class="line">    fmt.Println(c.Name, c.Price, c.Url) <span class="comment">//django 100 https://www.imooc.com</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> c1 Course = Course{</span><br><span class="line">    Name: <span class="string">"django"</span>,</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 访问</span></span><br><span class="line">fmt.Printf(<span class="string">"%+v\n"</span>, c1)                <span class="comment">// {Name:django Price:0 Url:}</span></span><br><span class="line">fmt.Println(c1.Name, c1.Price, c1.Url) <span class="comment">// django 0</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> bobo userinfo</span><br><span class="line">bobo.name = <span class="string">"波哥"</span></span><br><span class="line">bobo.age = <span class="number">18</span></span><br><span class="line">bobo.height = <span class="number">181</span></span><br><span class="line">bobo.eduschool = <span class="string">"北京邮电大学"</span></span><br><span class="line">bobo.hobby = []<span class="keyword">string</span>{<span class="string">"coding"</span>, <span class="string">"运动"</span>, <span class="string">"旅行"</span>}</span><br><span class="line">bobo.moreinfo = <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>{}{</span><br><span class="line">    <span class="string">"work"</span>: <span class="string">"百度"</span>,</span><br><span class="line">    <span class="string">"duty"</span>: <span class="string">"产品狗"</span>,</span><br><span class="line">}</span><br><span class="line">fmt.Printf(<span class="string">"%v\n"</span>, bobo) <span class="comment">// {波哥 18 181 北京邮电大学 [coding 运动 旅行] map[duty:产品狗 work:百度]}</span></span><br><span class="line">fmt.Printf(<span class="string">"%+v\n"</span>, bobo) <span class="comment">// {name:波哥 age:18 height:181 eduschool:北京邮电大学 hobby:[coding 运动 旅行] moreinfo:map[duty:产品狗 work:百度]}</span></span><br><span class="line">fmt.Printf(<span class="string">"name=%s,hobby=%v\n"</span>, bobo.name, bobo.hobby)</span><br><span class="line"><span class="comment">//name=波哥,hobby=[coding 运动 旅行]</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="顺序形式"><a href="#顺序形式" class="headerlink" title="顺序形式"></a>顺序形式</h3><p>简短声明来实现一个结构变量初始化<br>不指定结构体字段名称的时候，按照定义声明结构体的字段顺序初始化赋值，显示提供所有字段的初值，结构体当中的所有字段必须全部赋值。</p>
<p>指定字段名的时候，可以不按定义结构体时候的顺序赋值<br>对结构体赋值时，如果各个字段不在一行，最后一个字段必须添加逗号<br>对结构体赋值时，如果各个字段在同一行，则最后的一个字段可以不添加逗 号</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="comment">// 定义结构体变量，赋值放在同一行，最后可以省略逗号</span></span><br><span class="line">    <span class="comment">// var c2 Course = Course{"scrapy", 110, "https://www.imooc.com"}</span></span><br><span class="line">    c2 := Course{<span class="string">"scrapy"</span>, <span class="number">110</span>, <span class="string">"https://www.imooc.com"</span>}</span><br><span class="line">    fmt.Printf(<span class="string">"%+v\n"</span>, c2) <span class="comment">// {Name:scrapy Price:110 Url:https://www.imooc.com}</span></span><br><span class="line">    fmt.Println(c2.Name, c2.Price, c2.Url) <span class="comment">// scrapy 110 https://www.imooc.com</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 多行初始化</span></span><br><span class="line"><span class="keyword">var</span> liuge = userinfo{</span><br><span class="line">   name:      <span class="string">""</span>,</span><br><span class="line">   age:       <span class="number">0</span>,</span><br><span class="line">   height:    <span class="number">0</span>,</span><br><span class="line">   eduschool: <span class="string">""</span>,</span><br><span class="line">   hobby:     <span class="literal">nil</span>,</span><br><span class="line">   moreinfo:  <span class="literal">nil</span>,</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">huge := userinfo{</span><br><span class="line">    eduschool: <span class="string">"北京电影学院"</span>,</span><br><span class="line">    hobby:     []<span class="keyword">string</span>{<span class="string">"拍电影"</span>, <span class="string">"唱歌"</span>, <span class="string">"旅行"</span>},</span><br><span class="line">    moreinfo: <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>{}{</span><br><span class="line">        <span class="string">"role"</span>:      <span class="string">"演员"</span>,</span><br><span class="line">        <span class="string">"earnmoney"</span>: <span class="number">300000</span>,</span><br><span class="line">    },</span><br><span class="line">    name:   <span class="string">"胡哥"</span>,</span><br><span class="line">    age:    <span class="number">28</span>,</span><br><span class="line">    height: <span class="number">188</span>,</span><br><span class="line">}</span><br><span class="line">fmt.Printf(<span class="string">"huge=%v\n"</span>, huge)</span><br><span class="line"><span class="comment">//huge={胡哥 28 188 北京电影学院 [拍电影 唱歌 旅行] map[earnmoney:300000 role:演员]}</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义结构体变量，赋值放在同一行，最后可以省略逗号</span></span><br><span class="line">xiaoge := userinfo{<span class="string">"小哥"</span>, <span class="number">12</span>, <span class="number">120</span>, <span class="string">"小学"</span>, []<span class="keyword">string</span>{<span class="string">"学习"</span>, <span class="string">"玩"</span>, <span class="string">"打游戏"</span>}, <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>{}{<span class="string">"年级"</span>: <span class="string">"六年级"</span>}}</span><br><span class="line">fmt.Printf(<span class="string">"xiaoge=%v\n"</span>, xiaoge)</span><br><span class="line"><span class="comment">//xiaoge={小哥 12 120 小学 [学习 玩 打游戏] map[年级:六年级]}</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="地址符，同样是返回的结构体指针"><a href="#地址符，同样是返回的结构体指针" class="headerlink" title="地址符，同样是返回的结构体指针"></a>地址符，同样是返回的结构体指针</h3><p>结构体变量和普通变量都有指针形式，一个指向结构体的指针<br>使用取地址符就可以得到结构体的指针类型<br>通过结构体指针获取对象的值</p>
<p>go语言实际上在借鉴动态语言的特性，在调用的时候，要值还是指针，编译器会帮我们转换<br>另一个根本的原因 - go语言的指针是受限的</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// var c3 *Course = &amp;Course{"tornado", 100, "https://www.imooc.com"}</span></span><br><span class="line">c3 := &amp;Course{<span class="string">"tornado"</span>, <span class="number">100</span>, <span class="string">"https://www.imooc.com"</span>}</span><br><span class="line">fmt.Printf(<span class="string">"%T\n"</span>, c3) <span class="comment">// *main.Course</span></span><br><span class="line">fmt.Printf(<span class="string">"%+v\n"</span>, c3) <span class="comment">// &amp;{Name:tornado Price:100 Url:https://www.imooc.com}</span></span><br><span class="line">fmt.Println((*c3).Name, (*c3).Price, (*c3).Url) <span class="comment">// tornado 100 https://www.imooc.com</span></span><br><span class="line">fmt.Println(c3.Name, c3.Price, c3.Url)          <span class="comment">// tornado 100 https://www.imooc.com</span></span><br><span class="line"><span class="comment">// 这里其实是go语言的一个语法糖 go语言内部会将指向结构体的指针，c3.Name转换成 (*c3).Name，直接当对象来使用而不是当成指针使用</span></span><br></pre></td></tr></tbody></table></figure>

<p>注意上面的输出，指针形式多了一个地址符 <code>&amp;</code>，表示打印的对象是一个指针类型</p>
<h3 id="使用new-函数来创建一个「零值」结构体"><a href="#使用new-函数来创建一个「零值」结构体" class="headerlink" title="使用new() 函数来创建一个「零值」结构体"></a>使用new() 函数来创建一个「零值」结构体</h3><p>new() 函数返回的是指针类型。<br>所有的字段都被初始化为相应类型的零值</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> c12 *Course = <span class="built_in">new</span>(Course)</span><br><span class="line">fmt.Printf(<span class="string">"%+v\n"</span>, c12) <span class="comment">// &amp;{Name: Price:0 Url:}</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> xiaoming *userinfo = <span class="built_in">new</span>(userinfo)</span><br><span class="line">(*xiaoming).name = <span class="string">"小明"</span></span><br><span class="line">(*xiaoming).age = <span class="number">12</span></span><br><span class="line">(*xiaoming).eduschool = <span class="string">"北京小学"</span></span><br><span class="line"><span class="comment">//xiaoming-&gt;(*xiaoming) go语言编译器自动转换</span></span><br><span class="line">xiaoming.hobby = []<span class="keyword">string</span>{<span class="string">"学习"</span>, <span class="string">"玩"</span>, <span class="string">"打游戏"</span>}</span><br><span class="line">fmt.Println(xiaoming) <span class="comment">// &amp;{小明 12 0 北京小学 [学习 玩 打游戏] map[]}</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="零值初始化"><a href="#零值初始化" class="headerlink" title="零值初始化"></a>零值初始化</h3><p>第五种创建形式，如果不给结构体赋值，go语言会默认给每个字段采用默认值</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> c13 Course</span><br><span class="line">fmt.Printf(<span class="string">"%+v\n"</span>, c13) <span class="comment">// {Name: Price:0 Url:}</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">c4 := Course{}</span><br><span class="line">fmt.Println(c4.Price) <span class="comment">// 0</span></span><br><span class="line">fmt.Println(c4.Name)  <span class="comment">//  空字符串</span></span><br></pre></td></tr></tbody></table></figure>

<p>最后我们再将三种零值初始化结构体形式放到一起对比观察一下</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> c5 Course = Course{}</span><br><span class="line"><span class="keyword">var</span> c6 Course              <span class="comment">// c6不是指针 是结构体的类型</span></span><br><span class="line"><span class="keyword">var</span> c7 *Course = &amp;Course{} <span class="comment">// 分配一块内存并初始化</span></span><br><span class="line"><span class="keyword">var</span> c8 *Course             <span class="comment">// 指针如果只申明不赋值 默认值是nil</span></span><br><span class="line">fmt.Println(c8)            <span class="comment">// &lt;nil&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> c12 *Course = <span class="built_in">new</span>(Course)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fmt.Println(c5.Price) <span class="comment">// 0</span></span><br><span class="line">fmt.Println(c6.Price) <span class="comment">// 0</span></span><br><span class="line">fmt.Println(c7.Price) <span class="comment">// 0</span></span><br><span class="line"><span class="comment">//fmt.Println(c8.Price) // panic: runtime error: invalid memory address or nil pointer dereference</span></span><br><span class="line"></span><br><span class="line">fmt.Println(c12.Price) <span class="comment">// 0</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="零值结构体和-nil-结构体"><a href="#零值结构体和-nil-结构体" class="headerlink" title="零值结构体和 nil 结构体"></a>零值结构体和 nil 结构体</h2><p>nil 结构体是指结构体指针变量没有指向一个实际存在的内存。这样的指针变量只会占用 1 个指针的存储空间，也就是一个机器字的内存大小。</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> c *Course = <span class="literal">nil</span></span><br></pre></td></tr></tbody></table></figure>

<p>而零值结构体是会实实在在占用内存空间的，只不过每个字段都是零值。如果结构体里面字段非常多，那么这个内存空间占用肯定也会很大。</p>
<h2 id="结构体的大小"><a href="#结构体的大小" class="headerlink" title="结构体的大小"></a>结构体的大小</h2><p>Go 语言的 unsafe 包提供了获取结构体内存占用字节的函数 <code>Sizeof()</code></p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fmt.Println(unsafe.Sizeof(c9))              <span class="comment">// 40 16+8+16</span></span><br></pre></td></tr></tbody></table></figure>

<p>Circle 结构体在我的 64位机器上占用了 40 个字节，<br>因为每个 int 类型都是 8 字节。<br>字符串头的结构体占用 16 个字节</p>
<p>在 32 位机器上，Circle 结构体只会占用 20 个字节。</p>
<h2 id="slice的结构体"><a href="#slice的结构体" class="headerlink" title="slice的结构体"></a>slice的结构体</h2><p>通过观察 Go 语言的底层源码，可以发现所有的 Go 语言内置的高级数据结构都是由结构体来完成的。<br>slice的函数传递本质上也是值传递</p>
<p>切片头的结构体形式如下，它在 64 位机器上将会占用 24 个字节</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> slice <span class="keyword">struct</span> {</span><br><span class="line">    array unsafe.Pointer <span class="comment">// 底层数组的地址</span></span><br><span class="line">    <span class="built_in">len</span>   <span class="keyword">int</span>            <span class="comment">// 长度</span></span><br><span class="line">    <span class="built_in">cap</span>   <span class="keyword">int</span>            <span class="comment">// 容量</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="字符串头的结构体"><a href="#字符串头的结构体" class="headerlink" title="字符串头的结构体"></a>字符串头的结构体</h2><p>它在 64 位机器上将会占用 16 个字节</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="keyword">string</span> <span class="keyword">struct</span> {</span><br><span class="line">    array unsafe.Pointer <span class="comment">// 底层数组的地址</span></span><br><span class="line">    Data <span class="keyword">uintptr</span> <span class="comment">// 指针占8个长度</span></span><br><span class="line">    Len  <span class="keyword">int</span>     <span class="comment">// 长度64位系统占8个长度</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="字典头的结构体"><a href="#字典头的结构体" class="headerlink" title="字典头的结构体"></a>字典头的结构体</h2><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> hmap <span class="keyword">struct</span> {</span><br><span class="line">  count <span class="keyword">int</span></span><br><span class="line">  ...</span><br><span class="line">  buckets unsafe.Pointer  <span class="comment">// hash桶地址</span></span><br><span class="line">  ...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="数组与切片在内存形式上的区别"><a href="#数组与切片在内存形式上的区别" class="headerlink" title="数组与切片在内存形式上的区别"></a>数组与切片在内存形式上的区别</h2><p>数组只有「体」，切片除了「体」之外，还有「头」部。切片的头部和内容体是分离的，使用指针关联起来。请读者尝试解释一下下面代码的输出结果</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">"unsafe"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> ArrayStruct <span class="keyword">struct</span> {</span><br><span class="line">    value [<span class="number">10</span>]<span class="keyword">int</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> SliceStruct <span class="keyword">struct</span> {</span><br><span class="line">    value []<span class="keyword">int</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="comment">// 数组初始化使用了 […] 语法糖，表示让编译器自动推导数组的长度。</span></span><br><span class="line">    <span class="keyword">var</span> as = ArrayStruct{[...]<span class="keyword">int</span>{<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>}}</span><br><span class="line">    <span class="keyword">var</span> ss = SliceStruct{[]<span class="keyword">int</span>{<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>}}</span><br><span class="line">    fmt.Println(unsafe.Sizeof(as), unsafe.Sizeof(ss)) <span class="comment">// 80 24</span></span><br><span class="line"></span><br><span class="line">    s1 := []<span class="keyword">string</span>{<span class="string">"django"</span>, <span class="string">"tornado"</span>, <span class="string">"scrapy"</span>, <span class="string">"celery"</span>, <span class="string">"snaic"</span>, <span class="string">"flask"</span>}</span><br><span class="line">    fmt.Println(<span class="string">"切片占用的内存:"</span>, unsafe.Sizeof(s1)) <span class="comment">// 切片占用的内存: 24 无论字符串多长多短</span></span><br><span class="line"></span><br><span class="line">    m1 := <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>{</span><br><span class="line">        <span class="string">"bobby1"</span>: <span class="string">"django"</span>,</span><br><span class="line">        <span class="string">"bobby2"</span>: <span class="string">"tornado"</span>,</span><br><span class="line">        <span class="string">"bobby3"</span>: <span class="string">"scrapy"</span>,</span><br><span class="line">        <span class="string">"bobby4"</span>: <span class="string">"celery"</span>,</span><br><span class="line">    }</span><br><span class="line">    fmt.Println(<span class="string">"字典占用的内存:"</span>, unsafe.Sizeof(m1)) <span class="comment">// 字典占用的内存: 8</span></span><br><span class="line"></span><br><span class="line">    fmt.Println(unsafe.Sizeof(<span class="number">1</span>)) <span class="comment">// 8</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//go语言string的本质 其实string是一个结构体</span></span><br><span class="line">    fmt.Println(<span class="string">"字符串占用的内存:"</span>, unsafe.Sizeof(<span class="string">""</span>)) <span class="comment">// 字符串占用的内存: 16 无论字符串多长多短</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>结构体在内存中的布局是连续的存储空间</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> xiaohong *userinfo = &amp;userinfo{</span><br><span class="line">    <span class="string">"小红"</span>, <span class="number">12</span>, <span class="number">120</span>, <span class="string">"小学"</span>, []<span class="keyword">string</span>{<span class="string">"学习"</span>, <span class="string">"玩"</span>, <span class="string">"打游戏"</span>}, <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>{}{<span class="string">"年级"</span>: <span class="string">"五年级"</span>},</span><br><span class="line">}</span><br><span class="line">fmt.Println(xiaohong, *xiaohong)</span><br><span class="line"><span class="comment">//&amp;{小红 12 120 小学 [学习 玩 打游戏] map[年级:五年级]} {小红 12 120 小学 [学习 玩 打游戏] map[年级:五年级]}</span></span><br><span class="line"></span><br><span class="line">fmt.Printf(<span class="string">"name=%p,age=%p,height=%p,eduschool=%p,hobby=%p,moreinfo=%p\n"</span>, &amp;xiaohong.name, &amp;xiaohong.age, &amp;xiaohong.height, &amp;xiaohong.eduschool, &amp;xiaohong.hobby, &amp;xiaohong.moreinfo)</span><br><span class="line"><span class="comment">//name=0xc0000e2140,age=0xc0000e2150,height=0xc0000e2158,eduschool=0xc0000e2160,hobby=0xc0000e2170,moreinfo=0xc0000e2188</span></span><br><span class="line"></span><br><span class="line">fmt.Printf(<span class="string">"name=%d,age=%d,height=%d,eduschool=%d,hobby=%d,moreinfo=%d\n"</span>, unsafe.Sizeof(xiaohong.name), unsafe.Sizeof(xiaohong.age), unsafe.Sizeof(xiaohong.height), unsafe.Sizeof(xiaohong.eduschool), unsafe.Sizeof(xiaohong.hobby), unsafe.Sizeof(xiaohong.moreinfo))</span><br><span class="line"><span class="comment">// name=16,age=8,height=4,eduschool=16,hobby=24,moreinfo=8</span></span><br></pre></td></tr></tbody></table></figure>

<p>结构体之间是否可以相互转换？可以转换，前提条件：具有相同的字段（个数，类型，名称)</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> userinfo <span class="keyword">struct</span> {</span><br><span class="line">    name      <span class="keyword">string</span></span><br><span class="line">    age       <span class="keyword">int</span></span><br><span class="line">    height    <span class="keyword">float32</span></span><br><span class="line">    eduschool <span class="keyword">string</span></span><br><span class="line">    hobby     []<span class="keyword">string</span></span><br><span class="line">    moreinfo  <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>{}</span><br><span class="line">}</span><br><span class="line"><span class="keyword">type</span> peopleinfo <span class="keyword">struct</span> {</span><br><span class="line">    name      <span class="keyword">string</span></span><br><span class="line">    age       <span class="keyword">int</span></span><br><span class="line">    height    <span class="keyword">float32</span></span><br><span class="line">    eduschool <span class="keyword">string</span></span><br><span class="line">    hobby     []<span class="keyword">string</span></span><br><span class="line">    moreinfo  <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>{}</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">    user3 := userinfo{</span><br><span class="line">        name:      <span class="string">"user3"</span>,</span><br><span class="line">        age:       <span class="number">0</span>,</span><br><span class="line">        height:    <span class="number">0</span>,</span><br><span class="line">        eduschool: <span class="string">""</span>,</span><br><span class="line">        hobby:     <span class="literal">nil</span>,</span><br><span class="line">        moreinfo:  <span class="literal">nil</span>,</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    user4 := peopleinfo{</span><br><span class="line">        name:      <span class="string">"user4"</span>,</span><br><span class="line">        age:       <span class="number">0</span>,</span><br><span class="line">        height:    <span class="number">0</span>,</span><br><span class="line">        eduschool: <span class="string">""</span>,</span><br><span class="line">        hobby:     <span class="literal">nil</span>,</span><br><span class="line">        moreinfo:  <span class="literal">nil</span>,</span><br><span class="line">        <span class="comment">//pmoreinfo:nil,</span></span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//user3 = user4 // cannot use user4 (type peopleinfo) as type userinfo in assignment</span></span><br><span class="line"></span><br><span class="line">    user3 = userinfo(user4)</span><br><span class="line">    fmt.Println(user3) <span class="comment">// {user4 0 0  [] map[]}</span></span><br></pre></td></tr></tbody></table></figure>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/07/06/go-de-defer/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/07/06/go-de-defer/" class="post-title-link" itemprop="url">go的defer</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-07-05 16:21:41" itemprop="dateCreated datePublished" datetime="2021-07-05T16:21:41Z">2021-07-05</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-08-16 15:04:11" itemprop="dateModified" datetime="2021-08-16T15:04:11Z">2021-08-16</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>在我们实际的开发过程中，我们经常去连接一个远程的数据库，或者说连接本地的数据库，在我们连接数据库之后呢，就会返回连接的句柄，这种情况我们就占用了这个资源，<br>假如我们程序执行的时候还没来得及关闭这些资源的时候，我们的程序就崩溃了，但是对这个资源的占用还一种存在着，则其他程序无法使用，我们如何解决，以此我们引出defer关键字<br>defer关键字允许我们将业务逻辑延迟到函数返回之前才执行某个语句或函数 确保调用在函数结束<br>参数在调用defer语句时计算<br>关键字 defer 的用法类似于面向对象编程语言 Java 和 C# 的 finally 语句块，<br>它一般用于释放某些已分配的资源、资源的回收。Open\Close Lock\Unlock PrintHeader\PrintFooter</p>
<p>defer本质上是注册了一个延迟函数，一种用于注册延迟调用的机制，它可以让当前函数执行完毕之后执行<br>defer函数的执行顺序已经确定<br>defer 没有嵌套</p>
<ol>
<li>大量的嵌套try finally</li>
<li>打开和关系逻辑离的太远</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/zhangboyu/p/7911190.html">https://www.cnblogs.com/zhangboyu/p/7911190.html</a><br><a target="_blank" rel="noopener" href="https://studygolang.com/articles/24044?fr=sidebar">https://studygolang.com/articles/24044?fr=sidebar</a></p>
<p>defer之后只能是函数调用 不能是表达式 比如 <code>a++</code></p>
<p>可以在一个函数中执行多条defer语句，按照类似栈结构先进后出的顺序执行，执行顺序与声明顺序相反。</p>
<p>对于python的with语句</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">   fmt.Println(<span class="string">"test1"</span>)</span><br><span class="line">   <span class="keyword">defer</span> fmt.Println(<span class="string">"defer test1"</span>)</span><br><span class="line">   <span class="keyword">defer</span> fmt.Println(<span class="string">"defer test2"</span>)</span><br><span class="line">   <span class="keyword">defer</span> fmt.Println(<span class="string">"defer test3"</span>)</span><br><span class="line">   fmt.Println(<span class="string">"test2"</span>)</span><br><span class="line">   fmt.Println(<span class="string">"test3"</span>)</span><br><span class="line">}</span><br><span class="line">---</span><br><span class="line">test1</span><br><span class="line">test2</span><br><span class="line">test3</span><br><span class="line"><span class="keyword">defer</span> test3</span><br><span class="line"><span class="keyword">defer</span> test2</span><br><span class="line"><span class="keyword">defer</span> test1</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">    fmt.Println(<span class="string">"test1"</span>)</span><br><span class="line">    <span class="keyword">defer</span> fmt.Println(<span class="string">"defer test1"</span>)</span><br><span class="line">    <span class="keyword">defer</span> fmt.Println(<span class="string">"defer test2"</span>)</span><br><span class="line">    <span class="keyword">defer</span> fmt.Println(<span class="string">"defer test3"</span>)</span><br><span class="line">    fmt.Println(<span class="string">"test2"</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">    fmt.Println(<span class="string">"test3"</span>)</span><br><span class="line">---</span><br><span class="line">test1</span><br><span class="line">test2</span><br><span class="line"><span class="keyword">defer</span> test3</span><br><span class="line"><span class="keyword">defer</span> test2</span><br><span class="line"><span class="keyword">defer</span> test1</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    fmt.Println(<span class="string">"test1"</span>)</span><br><span class="line">    <span class="keyword">defer</span> fmt.Println(<span class="string">"defer test1"</span>)</span><br><span class="line">    <span class="keyword">defer</span> fmt.Println(<span class="string">"defer test2"</span>)</span><br><span class="line">    <span class="keyword">defer</span> fmt.Println(<span class="string">"defer test3"</span>)</span><br><span class="line">    fmt.Println(<span class="string">"test2"</span>)</span><br><span class="line">    <span class="built_in">panic</span>(<span class="string">"error"</span>)</span><br><span class="line">    fmt.Println(<span class="string">"test3"</span>)</span><br><span class="line">}</span><br><span class="line">---</span><br><span class="line">test1</span><br><span class="line">test2</span><br><span class="line"><span class="keyword">defer</span> test3</span><br><span class="line"><span class="keyword">defer</span> test2</span><br><span class="line"><span class="keyword">defer</span> test1</span><br><span class="line"><span class="built_in">panic</span>: error</span><br></pre></td></tr></tbody></table></figure>

<h3 id="defer语句执行时的拷贝机制"><a href="#defer语句执行时的拷贝机制" class="headerlink" title="defer语句执行时的拷贝机制"></a>defer语句执行时的拷贝机制</h3><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">   test := <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">       fmt.Println(<span class="string">"test1"</span>)</span><br><span class="line">   }</span><br><span class="line">   <span class="keyword">defer</span> test()</span><br><span class="line">   test = <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">       fmt.Println(<span class="string">"test2"</span>)</span><br><span class="line">   }</span><br><span class="line">   fmt.Println(<span class="string">"test3"</span>)</span><br><span class="line">}</span><br><span class="line"><span class="comment">//test3</span></span><br><span class="line"><span class="comment">//test1 因为test1的值已经入栈不能再修改了，所以不再是test2</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">   x := <span class="number">10</span></span><br><span class="line">   <span class="comment">// 此处的defer函数有参数，函数内部使用的值是全局的值</span></span><br><span class="line">   <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">(a <span class="keyword">int</span>)</span></span> {</span><br><span class="line">        fmt.Println(a) <span class="comment">// 10</span></span><br><span class="line">        fmt.Println(x) <span class="comment">// 11</span></span><br><span class="line">   }(x) <span class="comment">// 后面的括号表示调用匿名函数</span></span><br><span class="line">   x++</span><br><span class="line">}</span><br><span class="line"><span class="comment">// 10</span></span><br><span class="line"><span class="comment">// 11</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    x := <span class="number">10</span></span><br><span class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">(a *<span class="keyword">int</span>)</span></span> { <span class="comment">// 指针</span></span><br><span class="line">        fmt.Println(a)  <span class="comment">// 0xc00000a0b8</span></span><br><span class="line">        fmt.Println(*a) <span class="comment">// 11</span></span><br><span class="line">        fmt.Println(x)  <span class="comment">// 11</span></span><br><span class="line">        <span class="comment">//fmt.Println(*x) // invalid indirect of x (type int)</span></span><br><span class="line">    }(&amp;x) <span class="comment">// 后面的括号表示调用匿名函数</span></span><br><span class="line">    x++</span><br><span class="line">}</span><br><span class="line"><span class="comment">// 0xc00000a0b8</span></span><br><span class="line"><span class="comment">// 11</span></span><br><span class="line"><span class="comment">// 11</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    x := <span class="number">10</span></span><br><span class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">        <span class="comment">// 此处的defer函数并没有参数，函数内部使用的值是全局的值，闭包</span></span><br><span class="line">        fmt.Println(x)</span><br><span class="line">    }()</span><br><span class="line">    x++</span><br><span class="line">}</span><br><span class="line"><span class="comment">// 11</span></span><br></pre></td></tr></tbody></table></figure>


<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">f1</span><span class="params">()</span> <span class="title">int</span></span> {</span><br><span class="line">    x := <span class="number">10</span></span><br><span class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">        x++</span><br><span class="line">    }()</span><br><span class="line">    tmp := x <span class="comment">// x是int类型 值传递</span></span><br><span class="line">    <span class="keyword">return</span> tmp</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">f2</span><span class="params">()</span> *<span class="title">int</span></span> { <span class="comment">// 指针</span></span><br><span class="line">    a := <span class="number">10</span></span><br><span class="line">    b := &amp;a</span><br><span class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">        *b++</span><br><span class="line">    }()</span><br><span class="line">    temp_data := b <span class="comment">// b是指针类型，修改指针指向的内存对应的变量的值</span></span><br><span class="line">    <span class="keyword">return</span> temp_data</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    fmt.Println(f1()) <span class="comment">// 10 说明defer中的x++并没有影响return的值</span></span><br><span class="line">    fmt.Println(*f2()) <span class="comment">// 11</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">tryDefer</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">100</span>; i++ {</span><br><span class="line">        <span class="keyword">defer</span> fmt.Println(i)</span><br><span class="line">        <span class="keyword">if</span> i == <span class="number">5</span> {</span><br><span class="line">            <span class="comment">// Uncomment panic to see</span></span><br><span class="line">            <span class="comment">// how it works with defer</span></span><br><span class="line">            <span class="built_in">panic</span>(<span class="string">"printed too many"</span>)</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line">    tryDefer()</span><br><span class="line">---</span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="built_in">panic</span>: printed too many</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">deferAction</span><span class="params">()</span></span> {</span><br><span class="line">    handle, err := os.Open(<span class="string">"hello.txt"</span>)</span><br><span class="line">    <span class="keyword">defer</span> handle.Close()</span><br><span class="line">    <span class="comment">//这里是一大堆的文件操作程序...</span></span><br><span class="line">    <span class="comment">//fmt.Println(5/0)</span></span><br><span class="line">    err = err</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">writeFile</span><span class="params">(filename <span class="keyword">string</span>)</span></span> {</span><br><span class="line">    file, err := os.Create(filename)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">"error"</span>)</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">defer</span> file.Close()  <span class="comment">// 关闭文件</span></span><br><span class="line"></span><br><span class="line">    writer := bufio.NewWriter(file) <span class="comment">// 写进内存</span></span><br><span class="line">    <span class="keyword">defer</span> writer.Flush() <span class="comment">// 把缓存的数据刷到文件中去</span></span><br><span class="line"></span><br><span class="line">    f := fib.Fibonacci()</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">20</span>; i++ {</span><br><span class="line">        fmt.Fprintln(writer, f())</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    writeFile(<span class="string">"fib.txt"</span>)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>


<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/07/06/go-ni-ming-han-shu/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/07/06/go-ni-ming-han-shu/" class="post-title-link" itemprop="url">go匿名函数</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-07-05 16:21:41" itemprop="dateCreated datePublished" datetime="2021-07-05T16:21:41Z">2021-07-05</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-08-16 04:12:41" itemprop="dateModified" datetime="2021-08-16T04:12:41Z">2021-08-16</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>在需要使用函数时再定义函数，<br>匿名函数是指不需要定义函数名的一种函数实现方式，由一个不带函数名的函数声明和函数体组成，是一个”内联”语句或表达式。<br>函数可以作为一种类型被赋值给函数类型的变量，匿名函数也往往以变量方式传递，这与C语言的回调函数比较类似，不同的是，Go语言支持随时在代码里定义匿名函数。</p>
<p>Go语言没有Lambda表达式，<br>匿名函数的优越性在于可以直接使用函数内的变量，不必申明。</p>
<p>应用场景<br>当一个函数仅使用一次的时候，可定义为匿名函数</p>
<h3 id="定义一个匿名函数"><a href="#定义一个匿名函数" class="headerlink" title="定义一个匿名函数"></a>定义一个匿名函数</h3><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span><span class="params">(参数列表)</span><span class="params">(返回参数列表)</span></span> {</span><br><span class="line">    函数体</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>匿名函数的定义就是没有名字的普通函数定义。</p>
<h4 id="1-在定义时调用匿名函数"><a href="#1-在定义时调用匿名函数" class="headerlink" title="1) 在定义时调用匿名函数"></a>1) 在定义时调用匿名函数</h4><p>匿名函数可以在声明后调用，例如：</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span><span class="params">(data <span class="keyword">int</span>)</span></span> {</span><br><span class="line">    fmt.Println(<span class="string">"hello"</span>, data)</span><br><span class="line">}(<span class="number">100</span>)</span><br><span class="line"><span class="comment">// hello 100</span></span><br></pre></td></tr></tbody></table></figure>

<p>注意第3行<code>}</code>后的<code>(100)</code>，表示对匿名函数进行调用，传递参数为 100。</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sumVariables := <span class="function"><span class="keyword">func</span><span class="params">(var1, var2 <span class="keyword">int</span>)</span> <span class="title">int</span></span> {</span><br><span class="line">    <span class="keyword">return</span> var1 + var2</span><br><span class="line">}(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">fmt.Println(sumVariables) <span class="comment">// 3</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="2-将匿名函数赋值给变量"><a href="#2-将匿名函数赋值给变量" class="headerlink" title="2) 将匿名函数赋值给变量"></a>2) 将匿名函数赋值给变量</h4><p>定义一个变量，将匿名函数赋值给该变量，这个变量存储的是这个匿名的地址，变量具体匿名函数的功能</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将匿名函数体保存到f()中</span></span><br><span class="line">f := <span class="function"><span class="keyword">func</span><span class="params">(data <span class="keyword">int</span>)</span></span> {</span><br><span class="line">    fmt.Println(<span class="string">"hello"</span>, data)</span><br><span class="line">}</span><br><span class="line"><span class="comment">// 使用f()调用</span></span><br><span class="line">f(<span class="number">100</span>)</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">func1 := <span class="function"><span class="keyword">func</span><span class="params">(var1, var2 <span class="keyword">int</span>)</span> <span class="title">int</span></span> {</span><br><span class="line">    <span class="keyword">return</span> var1 - var2</span><br><span class="line">}</span><br><span class="line">fmt.Printf(<span class="string">"func1调用的值=%d,func1=%p\n"</span>, func1(<span class="number">1</span>, <span class="number">2</span>), &amp;func1)</span><br><span class="line"><span class="comment">// func1调用的值=-1,func1=0xc000006030</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="匿名函数是不能独立存在的"><a href="#匿名函数是不能独立存在的" class="headerlink" title="匿名函数是不能独立存在的"></a>匿名函数是不能独立存在的</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span><span class="params">(var1, var2 <span class="keyword">int</span>)</span> <span class="title">int</span></span> { <span class="keyword">return</span> <span class="number">1</span> } <span class="comment">// func literal evaluated but not used</span></span><br><span class="line"></span><br><span class="line">sumVariables := <span class="function"><span class="keyword">func</span><span class="params">(var1, var2 <span class="keyword">int</span>)</span> <span class="title">int</span></span> { <span class="keyword">return</span> <span class="number">1</span> } <span class="comment">// func literal evaluated but not used</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sumVariables := <span class="function"><span class="keyword">func</span><span class="params">(var1, var2 <span class="keyword">int</span>)</span> <span class="title">int</span></span> { <span class="keyword">return</span> <span class="number">1</span> }</span><br><span class="line">fmt.Println(sumVariables) <span class="comment">// 0x957a80</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 或者我们直接调用</span></span><br><span class="line">sumVariables1 := <span class="function"><span class="keyword">func</span><span class="params">(var1, var2 <span class="keyword">int</span>)</span> <span class="title">int</span></span> { <span class="keyword">return</span> <span class="number">1</span> }(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">fmt.Println(sumVariables1) <span class="comment">// 1</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="匿名函数用作回调函数"><a href="#匿名函数用作回调函数" class="headerlink" title="匿名函数用作回调函数"></a>匿名函数用作回调函数</h4><p>它本身就是一种值，可以方便地保存在各种容器中实现回调函数和操作封装。</p>
<p>下面的代码实现对切片的遍历操作，遍历中访问每个元素的操作使用匿名函数来实现，用户传入不同的匿名函数体可以实现对元素不同的遍历操作</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 遍历切片的每个元素，通过给定函数进行元素访问</span></span><br><span class="line"><span class="comment">// 使用 visit() 函数将整个遍历过程进行封装，当要获取遍历期间的切片值时，只需要给 visit() 传入一个回调参数即可。</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">visit</span><span class="params">(list []<span class="keyword">int</span>, f <span class="keyword">func</span>(<span class="keyword">int</span>)</span>)</span> {</span><br><span class="line">    <span class="keyword">for</span> _, v := <span class="keyword">range</span> list {</span><br><span class="line">        f(v)</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="comment">// 准备一个整型切片 []int{1, 2, 3, 4} 传入 visit() 函数作为遍历的数据。</span></span><br><span class="line">    visit([]<span class="keyword">int</span>{<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>}, <span class="function"><span class="keyword">func</span><span class="params">(v <span class="keyword">int</span>)</span></span> {</span><br><span class="line">        <span class="comment">// 定义了一个匿名函数，作用使用匿名函数是将遍历切片的每个值打印出来</span></span><br><span class="line">        fmt.Println(v)</span><br><span class="line">    })</span><br><span class="line">}</span><br><span class="line">---</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">4</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">apply</span><span class="params">(op <span class="keyword">func</span>(<span class="keyword">int</span>, <span class="keyword">int</span>)</span> <span class="title">int</span>, <span class="title">a</span>, <span class="title">b</span> <span class="title">int</span>) <span class="title">int</span></span> {</span><br><span class="line">    p := reflect.ValueOf(op).Pointer()</span><br><span class="line">    opName := runtime.FuncForPC(p).Name()</span><br><span class="line">    fmt.Printf(<span class="string">"Calling function %s with args "</span>+</span><br><span class="line">        <span class="string">"(%d, %d)\n"</span>, opName, a, b)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> op(a, b)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    fmt.Println(<span class="string">"pow(3, 4) is:"</span>, apply(</span><br><span class="line">        <span class="function"><span class="keyword">func</span><span class="params">(a <span class="keyword">int</span>, b <span class="keyword">int</span>)</span> <span class="title">int</span></span> { <span class="comment">// 匿名函数</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">int</span>(math.Pow(<span class="keyword">float64</span>(a), <span class="keyword">float64</span>(b)))</span><br><span class="line">        }, <span class="number">3</span>, <span class="number">4</span>))</span><br><span class="line">    <span class="comment">// Calling function main.main.func1 with args (3, 4)</span></span><br><span class="line">    <span class="comment">// pow(3, 4) is: 81</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>匿名函数作为回调函数的设计在Go语言的系统包中也比较常见，strings 包中就有类似的设计，代码如下：</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TrimFunc</span><span class="params">(s <span class="keyword">string</span>, f <span class="keyword">func</span>(<span class="keyword">rune</span>)</span> <span class="title">bool</span>) <span class="title">string</span></span> {</span><br><span class="line">    <span class="keyword">return</span> TrimRightFunc(TrimLeftFunc(s, f), f)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="使用匿名函数实现操作封装"><a href="#使用匿名函数实现操作封装" class="headerlink" title="使用匿名函数实现操作封装"></a>使用匿名函数实现操作封装</h4><p>将匿名函数作为 map 的键值，通过命令行参数动态调用匿名函数</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义命令行参数 skill，从命令行输入 --skill 可以将=后的字符串传入 skillParam 指针变量。</span></span><br><span class="line"><span class="keyword">var</span> skillParam = flag.String(<span class="string">"skill"</span>, <span class="string">""</span>, <span class="string">"skill to perform"</span>)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="comment">// 解析命令行参数，解析完成后，skillParam 指针变量将指向命令行传入的值。</span></span><br><span class="line">    flag.Parse()</span><br><span class="line">    <span class="comment">// 定义一个从字符串映射到 func() 的 map，然后填充这个 map。</span></span><br><span class="line">    <span class="keyword">var</span> skill = <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="function"><span class="keyword">func</span><span class="params">()</span></span>{</span><br><span class="line">        <span class="comment">// 初始化 map 的键值对，值为匿名函数</span></span><br><span class="line">        <span class="string">"fire"</span>: <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">            fmt.Println(<span class="string">"chicken fire"</span>)</span><br><span class="line">        },</span><br><span class="line">        <span class="string">"run"</span>: <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">            fmt.Println(<span class="string">"soldier run"</span>)</span><br><span class="line">        },</span><br><span class="line">        <span class="string">"fly"</span>: <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">            fmt.Println(<span class="string">"angel fly"</span>)</span><br><span class="line">        },</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// skillParam 是一个 *string 类型的指针变量，使用 *skillParam 获取到命令行传过来的值，并在 map 中查找对应命令行参数指定的字符串的函数。</span></span><br><span class="line">    <span class="keyword">if</span> f, ok := skill[*skillParam]; ok {</span><br><span class="line">        f()</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="comment">// 如果在 map 定义中存在这个参数就调用，否则打印“技能没有找到”。</span></span><br><span class="line">        fmt.Println(<span class="string">"skill not found"</span>)</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">D:\code&gt; go run main.go --skill=fly</span><br><span class="line">angel fly</span><br><span class="line">D:\code&gt; go run main.go --skill=run</span><br><span class="line">soldier run </span><br></pre></td></tr></tbody></table></figure><script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/07/06/go-cuo-wu-he-yi-chang-panic-he-recover/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/07/06/go-cuo-wu-he-yi-chang-panic-he-recover/" class="post-title-link" itemprop="url">go错误和异常panic和recover</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-07-05 16:21:41" itemprop="dateCreated datePublished" datetime="2021-07-05T16:21:41Z">2021-07-05</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-08-17 02:53:36" itemprop="dateModified" datetime="2021-08-17T02:53:36Z">2021-08-17</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>错误和异常是两个不同的概念，非常容易混淆。很多程序员习惯将一切非正常情况都看做错误，<br>一切皆错误或一切皆异常的情况，而不区分错误和异常，即使程序中可能有异常抛出，也将异常及时捕获并转换成错误。从表面上看，一切皆错误的思路更简单，而异常的引入仅仅增加了额外的复杂度。<br>但事实并非如此。众所周知，Golang遵循“少即是多”的设计哲学，追求简洁优雅，就是说如果异常价值不大，就不会将异常加入到语言特性中。</p>
<p>错误和异常处理是程序的重要组成部分，我们先看看下面几个问题：</p>
<p>错误和异常如何区分？<br>错误和异常从Golang机制上讲，就是error和panic的区别。</p>
<p>错误处理的方式有哪几种？</p>
<p>什么时候需要使用异常终止程序？异常处理的作用域（场景）：</p>
<ul>
<li>空指针引用</li>
<li>下标越界</li>
<li>除数为0</li>
<li>不应该出现的分支，比如default</li>
<li>输入不应该引起函数错误</li>
</ul>
<p>其他场景我们使用错误处理，这使得我们的函数接口很精炼。</p>
<p>什么时候需要捕获异常？</p>
<p>Golang中引入两个内置函数 panic 和 recover 来触发**和终止异常处理流程，同时引入关键字defer来延迟执行defer后面的函数。<br>一直等到包含defer语句的函数执行完毕时，延迟函数（defer后的函数）才会被执行，而不管包含defer语句的函数是通过return的正常结束，还是由于panic导致的异常结束。</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The panic built-in function stops normal execution of the current</span></span><br><span class="line"><span class="comment">// goroutine. When a function F calls panic, normal execution of F stops</span></span><br><span class="line"><span class="comment">// immediately. Any functions whose execution was deferred by F are run in</span></span><br><span class="line"><span class="comment">// the usual way, and then F returns to its caller. To the caller G, the</span></span><br><span class="line"><span class="comment">// invocation of F then behaves like a call to panic, terminating G's</span></span><br><span class="line"><span class="comment">// execution and running any deferred functions. This continues until all</span></span><br><span class="line"><span class="comment">// functions in the executing goroutine have stopped, in reverse order. At</span></span><br><span class="line"><span class="comment">// that point, the program is terminated with a non-zero exit code. This</span></span><br><span class="line"><span class="comment">// termination sequence is called panicking and can be controlled by the</span></span><br><span class="line"><span class="comment">// built-in function recover.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">panic</span><span class="params">(v <span class="keyword">interface</span>{})</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// The recover built-in function allows a program to manage behavior of a</span></span><br><span class="line"><span class="comment">// panicking goroutine. Executing a call to recover inside a deferred</span></span><br><span class="line"><span class="comment">// function (but not any function called by it) stops the panicking sequence</span></span><br><span class="line"><span class="comment">// by restoring normal execution and retrieves the error value passed to the</span></span><br><span class="line"><span class="comment">// call of panic. If recover is called outside the deferred function it will</span></span><br><span class="line"><span class="comment">// not stop a panicking sequence. In this case, or when the goroutine is not</span></span><br><span class="line"><span class="comment">// panicking, or if the argument supplied to panic was nil, recover returns</span></span><br><span class="line"><span class="comment">// nil. Thus the return value from recover reports whether the goroutine is</span></span><br><span class="line"><span class="comment">// panicking.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">recover</span><span class="params">()</span> <span class="title">interface</span></span>{}</span><br></pre></td></tr></tbody></table></figure>

<p>当有的错误属于异常情况下，正常代码运行不会出现的问题的情况就需要用panic了，但是也需要进行panic的recover处理</p>
<p>意料之外使用panic</p>
<ul>
<li>不要经常用panic，和其他语言的throw差不多 比如C++/Java，没有error但有errno，没有panic但有throw。</li>
<li>停止当前函数的执行</li>
<li>一直向上返回，执行每一层的defer</li>
<li>如果没有遇见recover，程序退出</li>
</ul>
<p>recover</p>
<ul>
<li>仅在 defer 调用中使用</li>
<li>获取 panic 的值</li>
<li>如果无法处理，可以重新 panic</li>
</ul>
<p>当程序运行时，如果遇到引用空指针、下标越界或显式调用panic函数等情况，则先触发panic函数的执行，然后调用延迟函数。调用者继续传递panic，因此该过程一直在调用栈中重复发生：函数停止执行，调用延迟执行函数等。如果一路在延迟函数中没有recover函数的调用，则会到达该携程的起点，该携程结束，然后终止其他所有携程，包括主携程（类似于C语言中的主线程，该携程ID为1）。</p>
<p>对于异常，我们可以选择在一个合适的上游去recover，并打印堆栈信息，使得部署后的程序不会终止。</p>
<h2 id="对待异常的态度"><a href="#对待异常的态度" class="headerlink" title="对待异常的态度"></a>对待异常的态度</h2><h2 id="1-在程序开发阶段，坚持速错"><a href="#1-在程序开发阶段，坚持速错" class="headerlink" title="1. 在程序开发阶段，坚持速错"></a>1. 在程序开发阶段，坚持速错</h2><p>去年学习Erlang的时候，建立了速错的理念，简单来讲就是“让它挂”，只有挂了你才会第一时间知道错误。在早期开发以及任何发布阶段之前，最简单的同时也可能是最好的方法是调用panic函数来中断程序的执行以强制发生错误，使得该错误不会被忽略，因而能够被尽快修复。</p>
<h3 id="2-在程序部署后，应恢复异常避免程序终止"><a href="#2-在程序部署后，应恢复异常避免程序终止" class="headerlink" title="2. 在程序部署后，应恢复异常避免程序终止"></a>2. 在程序部署后，应恢复异常避免程序终止</h3><p>我们在调用recover的延迟函数中以最合理的方式响应该异常：</p>
<ol>
<li>打印堆栈的异常调用信息和关键的业务信息，以便这些问题保留可见；</li>
<li>将异常转换为错误，以便调用者让程序恢复到健康状态并继续安全运行。</li>
</ol>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">funcA</span><span class="params">()</span> <span class="title">error</span></span> {</span><br><span class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">        <span class="keyword">if</span> p := <span class="built_in">recover</span>(); p != <span class="literal">nil</span> {</span><br><span class="line">            fmt.Printf(<span class="string">"panic recover! p: %v"</span>, p)</span><br><span class="line">            debug.PrintStack()</span><br><span class="line">        }</span><br><span class="line">    }()</span><br><span class="line">    <span class="keyword">return</span> funcB()</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">funcB</span><span class="params">()</span> <span class="title">error</span></span> {</span><br><span class="line">    <span class="comment">// simulation</span></span><br><span class="line">    <span class="built_in">panic</span>(<span class="string">"foo"</span>)</span><br><span class="line">    <span class="keyword">return</span> errors.New(<span class="string">"success"</span>)</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">test</span><span class="params">()</span></span> {</span><br><span class="line">    err := funcA()</span><br><span class="line">    <span class="keyword">if</span> err == <span class="literal">nil</span> {</span><br><span class="line">        fmt.Printf(<span class="string">"err is nil\\n"</span>)</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        fmt.Printf(<span class="string">"err is %v\\n"</span>, err)</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>我们期望test函数的输出是：</p>
<figure class="highlight text"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">err is foo</span><br></pre></td></tr></tbody></table></figure>

<p>实际上test函数的输出是：</p>
<figure class="highlight text"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">err is nil</span><br></pre></td></tr></tbody></table></figure>

<p>原因是panic异常处理机制不会自动将错误信息传递给error，所以要在funcA函数中进行显式的传递，代码如下所示：</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">funcA</span><span class="params">()</span> <span class="params">(err error)</span></span> {</span><br><span class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">        <span class="keyword">if</span> p := <span class="built_in">recover</span>(); p != <span class="literal">nil</span> {</span><br><span class="line">            fmt.Println(<span class="string">"panic recover! p:"</span>, p)</span><br><span class="line">            str, ok := p.(<span class="keyword">string</span>)</span><br><span class="line">            <span class="keyword">if</span> ok {</span><br><span class="line">                err = errors.New(str)</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                err = errors.New(<span class="string">"panic"</span>)</span><br><span class="line">            }</span><br><span class="line">            debug.PrintStack()</span><br><span class="line">        }</span><br><span class="line">    }()</span><br><span class="line">    <span class="keyword">return</span> funcB()</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">tryRecover</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> { <span class="comment">// func(){} 只是一个函数体， 要运行这个函数要在后面加上()</span></span><br><span class="line">        r := <span class="built_in">recover</span>() <span class="comment">// recover只能在defer中调用</span></span><br><span class="line">        <span class="keyword">if</span> r == <span class="literal">nil</span> { <span class="comment">// 如果没有异常  r为nil</span></span><br><span class="line">            fmt.Println(<span class="string">"Nothing to recover. "</span> + <span class="string">"Please try uncomment errors "</span> + <span class="string">"below."</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span> err, ok := r.(error); ok {</span><br><span class="line">            fmt.Println(<span class="string">"Error occurred:"</span>, err)</span><br><span class="line">            fmt.Println(<span class="string">"Error occurred:"</span>, err, err.Error())</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// 不知道怎么处理 可以继续panic</span></span><br><span class="line">            <span class="built_in">panic</span>(fmt.Sprintf(<span class="string">"I don't know what to do: %v"</span>, r))</span><br><span class="line">        }</span><br><span class="line">    }()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Uncomment each block to see different panic scenarios.</span></span><br><span class="line">    <span class="comment">// Normal error</span></span><br><span class="line">    <span class="comment">//panic(errors.New("this is an error"))</span></span><br><span class="line">    <span class="comment">// Error occurred: this is an error</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Division by zero</span></span><br><span class="line">    <span class="comment">//b := 0</span></span><br><span class="line">    <span class="comment">//a := 5 / b</span></span><br><span class="line">    <span class="comment">//fmt.Println(a)</span></span><br><span class="line">    <span class="comment">// Error occurred: runtime error: integer divide by zero</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Causes re-panic</span></span><br><span class="line">    <span class="built_in">panic</span>(<span class="number">123</span>) <span class="comment">// 这个因为不是错误 defer中会继续抛出</span></span><br><span class="line">    <span class="comment">// panic: 123 [recovered]</span></span><br><span class="line">    <span class="comment">//     panic: I don't know what to do: 123</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    tryRecover()</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="3-对于不应该出现的分支，使用异常处理"><a href="#3-对于不应该出现的分支，使用异常处理" class="headerlink" title="3. 对于不应该出现的分支，使用异常处理"></a>3. 对于不应该出现的分支，使用异常处理</h3><p>当某些不应该发生的场景发生时，我们就应该调用panic函数来触发异常。比如，当程序到达了某条逻辑上不可能到达的路径：</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> s := suit(drawCard()); s {</span><br><span class="line">    <span class="keyword">case</span> <span class="string">"Spades"</span>:</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">"Hearts"</span>:</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">"Diamonds"</span>:</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">"Clubs"</span>:</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="built_in">panic</span>(fmt.Sprintf(<span class="string">"invalid suit %v"</span>, s))</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="4-针对入参不应该有问题的函数，使用panic设计"><a href="#4-针对入参不应该有问题的函数，使用panic设计" class="headerlink" title="4. 针对入参不应该有问题的函数，使用panic设计"></a>4. 针对入参不应该有问题的函数，使用panic设计</h3><p>入参不应该有问题一般指的是硬编码，我们先看“一个启示”一节中提到的两个函数（Compile和MustCompile），其中MustCompile函数是对Compile函数的包装：</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">MustCompile</span><span class="params">(str <span class="keyword">string</span>)</span> *<span class="title">Regexp</span></span> {</span><br><span class="line">    regexp, error := Compile(str)</span><br><span class="line">    <span class="keyword">if</span> error != <span class="literal">nil</span> {</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">`regexp: Compile(`</span> + quote(str) + <span class="string">`): `</span> + error.Error())</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> regexp</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>所以，对于同时支持用户输入场景和硬编码场景的情况，一般支持硬编码场景的函数是对支持用户输入场景函数的包装。<br>对于只支持硬编码单一场景的情况，函数设计时直接使用panic，即返回值类型列表中不会有error，这使得函数的调用处理非常方便（没有了乏味的”if err != nil {/ 打印 &amp;&amp; 错误处理 /}”代码块）。</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">div</span><span class="params">(a, b <span class="keyword">int</span>)</span> <span class="params">(<span class="keyword">int</span>, error)</span></span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> a / b, <span class="literal">nil</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="comment">//错误就是能遇到可能出现的情况，这些情况会导致你的代码出问题， 参数检查， 数据库访问不了</span></span><br><span class="line">    a := <span class="number">12</span></span><br><span class="line">    b := <span class="number">0</span></span><br><span class="line">    fmt.Println(div(a, b)) <span class="comment">// panic: runtime error: integer divide by zero</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">div1</span><span class="params">(a, b <span class="keyword">int</span>)</span> <span class="params">(<span class="keyword">int</span>, error)</span></span> {</span><br><span class="line">    <span class="keyword">if</span> b == <span class="number">0</span> {</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">"被除数不能为0"</span>)</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> a / b, <span class="literal">nil</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="comment">//错误就是能遇到可能出现的情况，这些情况会导致你的代码出问题， 参数检查， 数据库访问不了</span></span><br><span class="line">    a := <span class="number">12</span></span><br><span class="line">    b := <span class="number">0</span></span><br><span class="line">    fmt.Println(div1(a, b)) <span class="comment">// panic: 被除数不能为0</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">div1</span><span class="params">(a, b <span class="keyword">int</span>)</span> <span class="params">(<span class="keyword">int</span>, error)</span></span> {</span><br><span class="line">    <span class="keyword">if</span> b == <span class="number">0</span> {</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">"被除数不能为0"</span>)</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> a / b, <span class="literal">nil</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="comment">//错误就是能遇到可能出现的情况，这些情况会导致你的代码出问题， 参数检查， 数据库访问不了</span></span><br><span class="line">    a := <span class="number">12</span></span><br><span class="line">    b := <span class="number">0</span></span><br><span class="line">    <span class="comment">// 出现错误函数不会终止，捕获异常</span></span><br><span class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">       err := <span class="built_in">recover</span>()</span><br><span class="line">       <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">           fmt.Println(<span class="string">"异常被捕获到"</span>)</span><br><span class="line">       }</span><br><span class="line">       fmt.Println(<span class="string">"bobby"</span>)</span><br><span class="line">    }()</span><br><span class="line">    fmt.Println(div1(a, b))</span><br><span class="line">    <span class="comment">// 异常被捕获到</span></span><br><span class="line">    <span class="comment">// bobby</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">``</span><span class="string">`</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">panic的坑</span></span><br><span class="line"><span class="string">异常 go语言中如何抛出异常和如何捕捉异常</span></span><br><span class="line"><span class="string">go语言认为错误就要自己处理， 就个人而言，go语言的这种想法是正确的。但是实际的使用中确实人有点烦人</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">`</span><span class="string">``</span><span class="keyword">go</span></span><br><span class="line">    strconv.Itoa(data)             <span class="comment">//go 认为这个Itoa的函数不可能出错， 没有必要返回error 内部代码出错这个时候应该抛出异常 panic</span></span><br><span class="line">    _, err := strconv.Atoi(<span class="string">"abcd"</span>) <span class="comment">//Atoi这个函数认为我的函数内部会出现一些预知错误情况</span></span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">        <span class="comment">//错误</span></span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    http.HandleFunc(<span class="string">"/hello"</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> {</span><br><span class="line">        w.Write([]<span class="keyword">byte</span>(<span class="string">"hello world!"</span>))</span><br><span class="line">    })</span><br><span class="line"></span><br><span class="line">    http.ListenAndServe(<span class="string">"127.0.0.1:8080"</span>, <span class="literal">nil</span>)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><img src="./go%E7%9A%84http/1.png" alt="description"></p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    http.HandleFunc(<span class="string">"/hello"</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> {</span><br><span class="line">        a := <span class="number">12</span></span><br><span class="line">        b := <span class="number">0</span></span><br><span class="line">        fmt.Println(div(a, b)) <span class="comment">// 浏览器刷新 http: panic serving 127.0.0.1:53676: runtime error: integer divide by zero</span></span><br><span class="line">        <span class="comment">// 出现异常这个程序没有挂掉，一个协程挂掉不会影响整体服务的运行</span></span><br><span class="line">        w.Write([]<span class="keyword">byte</span>(<span class="string">"hello world!"</span>))</span><br><span class="line">    })</span><br><span class="line"></span><br><span class="line">    http.ListenAndServe(<span class="string">"127.0.0.1:8080"</span>, <span class="literal">nil</span>)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    http.HandleFunc(<span class="string">"/hello"</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> {</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">"error"</span>)</span><br><span class="line">        <span class="comment">// http: panic serving 127.0.0.1:59184: error</span></span><br><span class="line">        w.Write([]<span class="keyword">byte</span>(<span class="string">"hello world!"</span>))</span><br><span class="line">    })</span><br><span class="line">    http.ListenAndServe(<span class="string">"127.0.0.1:8080"</span>, <span class="literal">nil</span>)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>panic会引起主线程的挂掉， 同时会导致其他的协程都挂掉<br>在父协程中无法捕获子协程中出现的异常</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    http.HandleFunc(<span class="string">"/hello"</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> {</span><br><span class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> { <span class="comment">// 开启一个协程</span></span><br><span class="line">           <span class="built_in">panic</span>(<span class="string">"error"</span>) <span class="comment">// panic: error</span></span><br><span class="line">        }()</span><br><span class="line">        <span class="comment">//操作redis的，有人觉得这段代码可以放到协程中去运行。有一个非常大的隐患了</span></span><br><span class="line">        w.Write([]<span class="keyword">byte</span>(<span class="string">"hello world!"</span>))</span><br><span class="line">    })</span><br><span class="line"></span><br><span class="line">    http.ListenAndServe(<span class="string">"127.0.0.1:8080"</span>, <span class="literal">nil</span>)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">f1</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">        err := <span class="built_in">recover</span>()</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">            fmt.Println(<span class="string">"捕获到了"</span>)</span><br><span class="line">        }</span><br><span class="line">    }()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">panic</span>(<span class="string">"出错了"</span>) <span class="comment">// 主协程</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    f1() <span class="comment">// 捕获到了</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">f1</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">        err := <span class="built_in">recover</span>()</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">            fmt.Println(<span class="string">"捕获到了"</span>)</span><br><span class="line">        }</span><br><span class="line">    }()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> { <span class="comment">// 开启一个协程</span></span><br><span class="line">        <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">            err := <span class="built_in">recover</span>() <span class="comment">// 处理异常，否则会导致其他的整个服务挂掉</span></span><br><span class="line">            <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">                fmt.Println(<span class="string">"捕获到了2"</span>)</span><br><span class="line">            }</span><br><span class="line">        }()</span><br><span class="line"></span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">"出错了"</span>)</span><br><span class="line">    }()</span><br><span class="line">    time.Sleep(<span class="number">10</span> * time.Second) <span class="comment">// 主协程执行完不释放清除，防止主协程退出</span></span><br><span class="line">    <span class="comment">//panic("出错了")</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    f1() <span class="comment">// 捕获到了2</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="错误处理的正确姿势"><a href="#错误处理的正确姿势" class="headerlink" title="错误处理的正确姿势"></a>错误处理的正确姿势</h2><p>意料之中使用error<br>error是用于防止错误情况的问题，用error进行错误提示<br>error接口类型作为错误处理的标准模式，如果函数要返回错误，则返回值类型列表中肯定包含error。<br>error处理过程类似于C语言中的错误码，可逐层返回，直到被处理。</p>
<p>说明： Golang错误处理方式一直是很多人诟病的地方，有些人吐槽说一半的代码都是<code>"if err != nil { / 打印 &amp;&amp; 错误处理 / }"</code>，严重影响正常的处理逻辑。</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The error built-in interface type is the conventional interface for</span></span><br><span class="line"><span class="comment">// representing an error condition, with the nil value representing no error.</span></span><br><span class="line"><span class="keyword">type</span> error <span class="keyword">interface</span> { <span class="comment">// error是一个接口，不能实例化</span></span><br><span class="line">    Error() <span class="keyword">string</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// New returns an error that formats as the given text.</span></span><br><span class="line"><span class="comment">// Each call to New returns a distinct error value even if the text is identical.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(text <span class="keyword">string</span>)</span> <span class="title">error</span></span> {</span><br><span class="line">    <span class="keyword">return</span> &amp;errorString{text}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Errorf formats according to a format specifier and returns the string as a</span></span><br><span class="line"><span class="comment">// value that satisfies error.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// If the format specifier includes a %w verb with an error operand,</span></span><br><span class="line"><span class="comment">// the returned error will implement an Unwrap method returning the operand. It is</span></span><br><span class="line"><span class="comment">// invalid to include more than one %w verb or to supply it with an operand</span></span><br><span class="line"><span class="comment">// that does not implement the error interface. The %w verb is otherwise</span></span><br><span class="line"><span class="comment">// a synonym for %v.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Errorf</span><span class="params">(format <span class="keyword">string</span>, a ...<span class="keyword">interface</span>{})</span> <span class="title">error</span></span> {</span><br><span class="line">    p := newPrinter()</span><br><span class="line">    p.wrapErrs = <span class="literal">true</span></span><br><span class="line">    p.doPrintf(format, a)</span><br><span class="line">    s := <span class="keyword">string</span>(p.buf)</span><br><span class="line">    <span class="keyword">var</span> err error</span><br><span class="line">    <span class="keyword">if</span> p.wrappedErr == <span class="literal">nil</span> {</span><br><span class="line">        err = errors.New(s)</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        err = &amp;wrapError{s, p.wrappedErr}</span><br><span class="line">    }</span><br><span class="line">    p.free()</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> err error = errors.New(<span class="string">"错误"</span>)</span><br><span class="line">fmt.Println(err) <span class="comment">// 错误</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> err1 error = errors.New(fmt.Sprintf(<span class="string">""</span>)) <span class="comment">// 格式化字符串</span></span><br><span class="line">fmt.Println(err1)</span><br><span class="line"></span><br><span class="line">s := <span class="string">"文件不存在"</span></span><br><span class="line"><span class="keyword">var</span> err2 error = fmt.Errorf(<span class="string">"错误:%s"</span>, s) <span class="comment">// 格式化字符串</span></span><br><span class="line">fmt.Println(err2) <span class="comment">// 错误:文件不存在</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">writeFile</span><span class="params">(filename <span class="keyword">string</span>)</span></span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If there is an error, it will be of type *PathError.</span></span><br><span class="line">    file, err := os.OpenFile(filename,</span><br><span class="line">        os.O_EXCL|os.O_CREATE|os.O_WRONLY, <span class="number">0666</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">        <span class="comment">// fmt.Println("error", err.Error()) //error open fib.txt: file exists</span></span><br><span class="line">        <span class="comment">// return</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> pathError, ok := err.(*os.PathError); !ok { <span class="comment">// 判断err是否为指定类型</span></span><br><span class="line">            fmt.Printf(<span class="string">"%s, %s, %s\n"</span>, pathError.Op, pathError.Path, pathError.Err)</span><br><span class="line">            <span class="built_in">panic</span>(err)</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            fmt.Printf(<span class="string">"%s, %s, %s\n"</span>,</span><br><span class="line">                pathError.Op, pathError.Path, pathError.Err)</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">defer</span> file.Close()</span><br><span class="line"></span><br><span class="line">    writer := bufio.NewWriter(file)</span><br><span class="line">    <span class="keyword">defer</span> writer.Flush() <span class="comment">// 把缓存的数据刷到文件中去</span></span><br><span class="line"></span><br><span class="line">    f := fib.Fibonacci()</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">20</span>; i++ {</span><br><span class="line">        fmt.Fprintln(writer, f())</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    writeFile(<span class="string">"fib.txt"</span>) <span class="comment">// open, fib.txt, The file exists.</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="1-失败的原因只有一个时，不使用error"><a href="#1-失败的原因只有一个时，不使用error" class="headerlink" title="1. 失败的原因只有一个时，不使用error"></a>1. 失败的原因只有一个时，不使用error</h3><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(self *AgentContext)</span> <span class="title">CheckHostType</span><span class="params">(host_type <span class="keyword">string</span>)</span> <span class="title">error</span></span> {</span><br><span class="line">    <span class="keyword">switch</span> host_type {</span><br><span class="line">    <span class="keyword">case</span> <span class="string">"virtual_machine"</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">"bare_metal"</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> errors.New(<span class="string">"CheckHostType ERROR:"</span> + host_type)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>我们可以看出，该函数失败的原因只有一个，所以返回值的类型应该为bool，而不是error，重构一下代码：</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(self *AgentContext)</span> <span class="title">IsValidHostType</span><span class="params">(hostType <span class="keyword">string</span>)</span> <span class="title">bool</span></span> {</span><br><span class="line">    <span class="keyword">return</span> hostType == <span class="string">"virtual_machine"</span> || hostType == <span class="string">"bare_metal"</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>说明：大多数情况，导致失败的原因不止一种，尤其是对I/O操作而言，用户需要了解更多的错误信息，这时的返回值类型不再是简单的bool，而是error。</p>
<h3 id="2-没有失败时，不使用error"><a href="#2-没有失败时，不使用error" class="headerlink" title="2. 没有失败时，不使用error"></a>2. 没有失败时，不使用error</h3><h3 id="3-error应放在返回值类型列表的最后"><a href="#3-error应放在返回值类型列表的最后" class="headerlink" title="3. error应放在返回值类型列表的最后"></a>3. error应放在返回值类型列表的最后</h3><h3 id="4-错误值统一定义，而不是跟着感觉走"><a href="#4-错误值统一定义，而不是跟着感觉走" class="headerlink" title="4. 错误值统一定义，而不是跟着感觉走"></a>4. 错误值统一定义，而不是跟着感觉走</h3><p>很多人写代码时，到处<code>return errors.New(value)</code>，而错误value在表达同一个含义时也可能形式不同，比如“记录不存在”的错误value可能为：</p>
<ol>
<li><code>"record is not existed."</code></li>
<li><code>"record is not exist!"</code></li>
<li><code>"###record is not existed！！！"</code></li>
<li>…<br>这使得相同的错误value撒在一大片代码里，当上层函数要对特定错误value进行统一处理时，需要漫游所有下层代码，以保证错误value统一，不幸的是有时会有漏网之鱼，而且这种方式严重阻碍了错误value的重构。<br>于是，我们可以参考C/C++的错误码定义文件，在Golang的每个包中增加一个错误对象定义文件，如下所示</li>
</ol>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ERR_EOF = errors.New(<span class="string">"EOF"</span>)</span><br><span class="line"><span class="keyword">var</span> ERR_CLOSED_PIPE = errors.New(<span class="string">"io: read/write on closed pipe"</span>)</span><br><span class="line"><span class="keyword">var</span> ERR_NO_PROGRESS = errors.New(<span class="string">"multiple Read calls return no data or error"</span>)</span><br><span class="line"><span class="keyword">var</span> ERR_SHORT_BUFFER = errors.New(<span class="string">"short buffer"</span>)</span><br><span class="line"><span class="keyword">var</span> ERR_SHORT_WRITE = errors.New(<span class="string">"short write"</span>)</span><br><span class="line"><span class="keyword">var</span> ERR_UNEXPECTED_EOF = errors.New(<span class="string">"unexpected EOF"</span>)</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"io/ioutil"</span></span><br><span class="line">    <span class="string">"net/http"</span></span><br><span class="line">    <span class="string">"os"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    http.HandleFunc(<span class="string">"/list/"</span>, <span class="function"><span class="keyword">func</span><span class="params">(writer http.ResponseWriter, request *http.Request)</span></span> {</span><br><span class="line">        path := request.URL.Path[<span class="built_in">len</span>(<span class="string">"/list/"</span>):]</span><br><span class="line">        file, err := os.Open(path)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">            <span class="comment">// 访问 ： http://localhost:8888/list/fib.txta</span></span><br><span class="line">            <span class="comment">// open fib.txta: no such file or directory</span></span><br><span class="line">            <span class="comment">// 这样会把我们服务器内部错误暴露给客户端，这样做不好</span></span><br><span class="line">            <span class="comment">// 而且这个本来是一个业务逻辑，不要把错误处理和业务逻辑耦合在一起，把业务逻辑和错误处理分开</span></span><br><span class="line">            http.Error(writer, err.Error(), http.StatusInternalServerError)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">defer</span> file.Close()</span><br><span class="line"></span><br><span class="line">        all, err := ioutil.ReadAll(file)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">            <span class="built_in">panic</span>(err)</span><br><span class="line">        }</span><br><span class="line">        writer.Write(all)</span><br><span class="line">    })</span><br><span class="line"></span><br><span class="line">    err := http.ListenAndServe(<span class="string">":8080"</span>, <span class="literal">nil</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash">curl http://localhost:8080/list/fib.txt</span></span><br><span class="line">1</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">5</span><br><span class="line">8</span><br><span class="line">13</span><br><span class="line">21</span><br><span class="line">34</span><br><span class="line">55</span><br><span class="line">89</span><br><span class="line">144</span><br><span class="line">233</span><br><span class="line">377</span><br><span class="line">610</span><br><span class="line">987</span><br><span class="line">1597</span><br><span class="line">2584</span><br><span class="line">4181</span><br><span class="line">6765</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">curl http://localhost:8080/list/fib2.txt</span></span><br><span class="line">open fib.txta: The system cannot find the file specified.</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 业务逻辑</span></span><br><span class="line"><span class="keyword">package</span> server</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"io/ioutil"</span></span><br><span class="line">    <span class="string">"net/http"</span></span><br><span class="line">    <span class="string">"os"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 把业务逻辑分离开来，如果有错误，就返回一个错误，</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">HandleFileList</span><span class="params">(writer http.ResponseWriter, request *http.Request)</span> <span class="title">error</span></span> {</span><br><span class="line">    path := request.URL.Path[<span class="built_in">len</span>(<span class="string">"/list/"</span>):]</span><br><span class="line">    file, err := os.Open(path)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">        <span class="comment">// panic err</span></span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">defer</span> file.Close()</span><br><span class="line">    all, err := ioutil.ReadAll(file)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    }</span><br><span class="line">    writer.Write(all)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span> <span class="comment">// 没有错误返回nil</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"io/ioutil"</span></span><br><span class="line">    <span class="string">"learn2/learnerror/server"</span></span><br><span class="line">    <span class="string">"net/http"</span></span><br><span class="line">    <span class="string">"os"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">//  定义一下这个函数类型</span></span><br><span class="line"><span class="keyword">type</span> appHandle <span class="function"><span class="keyword">func</span><span class="params">(writer http.ResponseWriter, request *http.Request)</span> <span class="title">error</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 错误统一处理 函数式编程，入参是一个函数，出参也是一个函数</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">errorWrapper</span><span class="params">(handle appHandle)</span> <span class="title">func</span><span class="params">(http.ResponseWriter, *http.Request)</span></span> {</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(writer http.ResponseWriter, request *http.Request)</span></span> {</span><br><span class="line">        err := handle(writer, request)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> { <span class="comment">// 错误统一处理</span></span><br><span class="line">            <span class="comment">// system error</span></span><br><span class="line">            code := http.StatusOK</span><br><span class="line">            <span class="keyword">switch</span> {</span><br><span class="line">            <span class="keyword">case</span> os.IsNotExist(err):</span><br><span class="line">                code = http.StatusNotFound</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                code = http.StatusInternalServerError</span><br><span class="line">            }</span><br><span class="line">            http.Error(writer, http.StatusText(code), code) <span class="comment">// 第二个参数不暴露内部接口</span></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="comment">// 用errorWrapper包装一下这个业务逻辑函数</span></span><br><span class="line">    http.HandleFunc(<span class="string">"/list/"</span>, errorWrapper(server.HandleFileList))</span><br><span class="line">    err := http.ListenAndServe(<span class="string">":8080"</span>, <span class="literal">nil</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash">curl http://localhost:8080/list/fib.txt</span></span><br><span class="line">1</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">5</span><br><span class="line">8</span><br><span class="line">13</span><br><span class="line">21</span><br><span class="line">34</span><br><span class="line">55</span><br><span class="line">89</span><br><span class="line">144</span><br><span class="line">233</span><br><span class="line">377</span><br><span class="line">610</span><br><span class="line">987</span><br><span class="line">1597</span><br><span class="line">2584</span><br><span class="line">4181</span><br><span class="line">6765</span><br></pre></td></tr></tbody></table></figure>

<hr>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> filelisting</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"io/ioutil"</span></span><br><span class="line">    <span class="string">"net/http"</span></span><br><span class="line">    <span class="string">"os"</span></span><br><span class="line">    <span class="string">"strings"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> prefix = <span class="string">"/list/"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> userError <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e userError)</span> <span class="title">Error</span><span class="params">()</span> <span class="title">string</span></span> {</span><br><span class="line">    <span class="keyword">return</span> e.Message()</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e userError)</span> <span class="title">Message</span><span class="params">()</span> <span class="title">string</span></span> {</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">string</span>(e)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 把业务逻辑分离开来，如果有错误，就返回一个错误</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">HandleFileList</span><span class="params">(writer http.ResponseWriter, request *http.Request)</span> <span class="title">error</span></span> {</span><br><span class="line">    fmt.Println()</span><br><span class="line">    <span class="comment">// 如果不是以list开头，我们自己抛出一个自己定义的代码</span></span><br><span class="line">    <span class="keyword">if</span> strings.Index(request.URL.Path, prefix) != <span class="number">0</span> {</span><br><span class="line">        <span class="comment">//return errors.New(request.URL.Path + "path %s must start " + "with %s" + prefix)</span></span><br><span class="line">        <span class="keyword">return</span> userError(fmt.Sprintf(<span class="string">"path %s must start "</span>+<span class="string">"with %s"</span>,</span><br><span class="line">            request.URL.Path, prefix))</span><br><span class="line">        <span class="comment">//path /abc must start with /list/</span></span><br><span class="line">    }</span><br><span class="line">    path := request.URL.Path[<span class="built_in">len</span>(prefix):] <span class="comment">// 这里可能会切片下标越界</span></span><br><span class="line">    file, err := os.Open(path)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">        <span class="comment">//panic err</span></span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">defer</span> file.Close()</span><br><span class="line">    all, err := ioutil.ReadAll(file)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    writer.Write(all)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span> <span class="comment">// 没有错误返回nil</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"log"</span></span><br><span class="line">    <span class="string">"net/http"</span></span><br><span class="line">    _ <span class="string">"net/http/pprof"</span></span><br><span class="line">    <span class="string">"os"</span></span><br><span class="line"></span><br><span class="line">    <span class="string">"imooc.com/ccmouse/learngo/lang/errhandling/filelistingserver/filelisting"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 接口 用户可以看到的error类型</span></span><br><span class="line"><span class="keyword">type</span> userError <span class="keyword">interface</span> {</span><br><span class="line">    error            <span class="comment">// 系统的错误</span></span><br><span class="line">    Message() <span class="keyword">string</span> <span class="comment">// 定义用户可以看的错误</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">//  定义一下这个函数类型</span></span><br><span class="line"><span class="keyword">type</span> appHandler <span class="function"><span class="keyword">func</span><span class="params">(writer http.ResponseWriter, request *http.Request)</span> <span class="title">error</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 错误统一处理 函数式编程，入参是一个函数，出参也是一个函数</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">errWrapper</span><span class="params">(handler appHandler)</span> <span class="title">func</span><span class="params">(http.ResponseWriter, *http.Request)</span></span> {</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(writer http.ResponseWriter, request *http.Request)</span></span> {</span><br><span class="line">        <span class="comment">// 虽然说http里面发生错误会自己recover 但是我们还是自己做下处理比较好</span></span><br><span class="line">        <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">            <span class="keyword">if</span> r := <span class="built_in">recover</span>(); r != <span class="literal">nil</span> {</span><br><span class="line">                log.Printf(<span class="string">"Panic: %v"</span>, r) <span class="comment">// 在ide终端和浏览器输出</span></span><br><span class="line">                http.Error(writer,</span><br><span class="line">                    http.StatusText(http.StatusInternalServerError),</span><br><span class="line">                    http.StatusInternalServerError)</span><br><span class="line">            }</span><br><span class="line">        }()</span><br><span class="line"></span><br><span class="line">        err := handler(writer, request)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> { <span class="comment">// 错误统一处理</span></span><br><span class="line">            log.Printf(<span class="string">"Error occurred "</span>+<span class="string">"handling request: %s %v"</span>, err.Error(), err) <span class="comment">// 在ide终端输出</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// user error  自己定义的错误，有一些要返回给用户，可以这样做</span></span><br><span class="line">            <span class="keyword">if</span> userErr, ok := err.(userError); ok {  <span class="comment">// 判断err是否属于某个接口类型</span></span><br><span class="line">                http.Error(writer, userErr.Message(), http.StatusBadRequest)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="comment">// system error</span></span><br><span class="line">            code := http.StatusOK</span><br><span class="line">            <span class="keyword">switch</span> {</span><br><span class="line">            <span class="keyword">case</span> os.IsNotExist(err):</span><br><span class="line">                code = http.StatusNotFound</span><br><span class="line">            <span class="keyword">case</span> os.IsPermission(err):</span><br><span class="line">                code = http.StatusForbidden</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                code = http.StatusInternalServerError</span><br><span class="line">            }</span><br><span class="line">            http.Error(writer, http.StatusText(code), code) <span class="comment">// 第二个参数不暴露内部接口</span></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="comment">// 用errorWrapper包装一下这个业务逻辑函数</span></span><br><span class="line">    <span class="comment">// 让 / 下的网页都可以访问，</span></span><br><span class="line">    http.HandleFunc(<span class="string">"/"</span>, errWrapper(filelisting.HandleFileList))</span><br><span class="line">    err := http.ListenAndServe(<span class="string">":8080"</span>, <span class="literal">nil</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">``</span><span class="string">`</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">`</span><span class="string">``</span><span class="keyword">go</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">``</span><span class="string">`</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### 5. 错误逐层传递时，层层都加日志</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">根据笔者经验，层层都加日志非常方便故障定位。</span></span><br><span class="line"><span class="string">说明：至于通过测试来发现故障，而不是日志，目前很多团队还很难做到。如果你或你的团队能做到，那么请忽略这个姿势:)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### 6. 错误处理使用defer</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">我们一般通过判断error的值来处理错误，如果当前操作失败，需要将本函数中已经create的资源destroy掉，示例代码如下：</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">`</span><span class="string">``</span><span class="keyword">go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">deferDemo</span><span class="params">()</span> <span class="title">error</span></span> {</span><br><span class="line">    err := createResource1()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">        <span class="keyword">return</span> ERR_CREATE_RESOURCE1_FAILED</span><br><span class="line">    }</span><br><span class="line">    err = createResource2()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">        destroyResource1()</span><br><span class="line">        <span class="keyword">return</span> ERR_CREATE_RESOURCE2_FAILED</span><br><span class="line">    }</span><br><span class="line">    err = createResource3()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">        destroyResource1()</span><br><span class="line">        destroyResource2()</span><br><span class="line">        <span class="keyword">return</span> ERR_CREATE_RESOURCE3_FAILED</span><br><span class="line">    }</span><br><span class="line">    err = createResource4()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">        destroyResource1()</span><br><span class="line">        destroyResource2()</span><br><span class="line">        destroyResource3()</span><br><span class="line">        <span class="keyword">return</span> ERR_CREATE_RESOURCE4_FAILED</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>当Golang的代码执行时，如果遇到defer的闭包调用，则压入堆栈。当函数返回时，会按照后进先出的顺序调用闭包。<br>对于闭包的参数是值传递，而对于外部变量却是引用传递，所以闭包中的外部变量err的值就变成外部函数返回时最新的err值。<br>根据这个结论，我们重构上面的示例代码：</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">deferDemo</span><span class="params">()</span> <span class="title">error</span></span> {</span><br><span class="line">    err := createResource1()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">        <span class="keyword">return</span> ERR_CREATE_RESOURCE1_FAILED</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">            destroyResource1()</span><br><span class="line">        }</span><br><span class="line">    }()</span><br><span class="line">    err = createResource2()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">        <span class="keyword">return</span> ERR_CREATE_RESOURCE2_FAILED</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">            destroyResource2()</span><br><span class="line">        }</span><br><span class="line">    }()</span><br><span class="line">    err = createResource3()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">        <span class="keyword">return</span> ERR_CREATE_RESOURCE3_FAILED</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">            destroyResource3()</span><br><span class="line">        }</span><br><span class="line">    }()</span><br><span class="line">    err = createResource4()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">        <span class="keyword">return</span> ERR_CREATE_RESOURCE4_FAILED</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="7-当发生错误时，不忽略有用的返回值"><a href="#7-当发生错误时，不忽略有用的返回值" class="headerlink" title="7. 当发生错误时，不忽略有用的返回值"></a>7. 当发生错误时，不忽略有用的返回值</h3><p>通常，当函数返回non-nil的error时，其他的返回值是未定义的(undefined)，这些未定义的返回值应该被忽略。然而，有少部分函数在发生错误时，仍然会返回一些有用的返回值。比如，当读取文件发生错误时，Read函数会返回可以读取的字节数以及错误信息。对于这种情况，应该将读取到的字符串和错误信息一起打印出来。</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<h2 id="Golang错误和异常是可以互相转换的："><a href="#Golang错误和异常是可以互相转换的：" class="headerlink" title="Golang错误和异常是可以互相转换的："></a>Golang错误和异常是可以互相转换的：</h2><ol>
<li>错误转异常，比如程序逻辑上尝试请求某个URL，最多尝试三次，尝试三次的过程中请求失败是错误，尝试完第三次还不成功的话，失败就被提升为异常了。</li>
<li>异常转错误，比如panic触发的异常被recover恢复后，将返回值中error类型的变量进行赋值，以便上层函数继续走错误处理流程。</li>
</ol>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/07/05/go-han-shu/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/07/05/go-han-shu/" class="post-title-link" itemprop="url">go函数</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-07-04 16:21:41" itemprop="dateCreated datePublished" datetime="2021-07-04T16:21:41Z">2021-07-04</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-08-03 09:02:59" itemprop="dateModified" datetime="2021-08-03T09:02:59Z">2021-08-03</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>函数<br>为了完成某个具体功能封装起来的功能的集合，构成了代码执行的逻辑结构，在Go语言中，函数的基本组成为：关键字 func、函数名、参数列表、返回值、函数体和返回语句，每一个程序都包含很多的函数，函数是基本的代码块。</p>
<p>因为Go语言是编译型语言，所以函数编写的顺序是无关紧要的，<br>Go 语言最少有个 main() 函数。<br>鉴于可读性的需求，最好把 main() 函数写在文件的前面，其他函数按照一定逻辑顺序进行编写（例如函数被调用的顺序）。</p>
<p>编写多个函数的主要目的是将一个需要很多行代码的复杂问题分解为一系列简单的任务来解决，通过函数来划分不同功能，逻辑上每个函数执行的是指定的任务，同一个任务（函数）可以被多次调用，有助于代码重用（事实上，好的程序是非常注意 DRY 原则的，即不要重复你自己（Don’t Repeat Yourself），意思是执行特定任务的代码只能在程序里面出现一次）。</p>
<p>当函数执行到代码块最后一行<code>}</code>之前或者 return 语句的时候会退出，其中 return 语句可以带有零个或多个参数，这些参数将作为返回值供调用者使用，简单的 return 语句也可以用来结束 for 的死循环，或者结束一个协程（goroutine）。</p>
<p>Go语言里面拥三种类型的函数：</p>
<ul>
<li>普通的带有名字的函数</li>
<li>匿名函数或者 lambda 函数</li>
<li>方法</li>
</ul>
<p>空白标识符<code>_</code>在函数中的使用，忽略函数返回值，可以强调某个参数未被使用。</p>
<p>没有默认参数、可选参数</p>
<h3 id="普通函数声明定义"><a href="#普通函数声明定义" class="headerlink" title="普通函数声明定义"></a>普通函数声明定义</h3><p>函数声明包括函数名、形式参数列表、返回值列表（可省略）以及函数体。</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> 函数名<span class="params">(形式参数列表)</span><span class="params">(返回值列表)</span></span>{</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">function_name</span><span class="params">( [parameter list] )</span> [<span class="title">return</span> <span class="title">list</span>]</span> {</span><br><span class="line">    <span class="comment">//函数体</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>func：函数由 func 开始声明<br>function_name：函数名称，参数列表和返回值类型构成了函数签名。<br>parameter list：形式参数列表，参数就像一个占位符，当函数被调用时，你可以将值传递给参数，这个值被称为实际参数。形式参数列表指定的是参数名以及参数类型、顺序、及参数个数。参数是可选的，也就是说函数也可以不包含参数，这些参数作为局部变量，其值由参数调用者提供，</p>
<p>返回值列表描述了函数返回值的变量名以及类型，如果函数返回一个无名变量或者没有返回值，返回值列表的括号是可以省略的。<br>如果一个函数声明不包括返回值列表，那么函数体执行完毕后，不会返回任何值，</p>
<p>函数体：函数定义的代码集合。</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>{</span><br><span class="line">    fmt.Println(hypot(<span class="number">3</span>, <span class="number">4</span>)) <span class="comment">// 5</span></span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">hypot</span><span class="params">(x, y <span class="keyword">float64</span>)</span> <span class="title">float64</span></span> {</span><br><span class="line">    <span class="keyword">return</span> math.Sqrt(x*x + y*y)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>x 和 y 是形参名，3 和 4 是调用时的传入的实数，函数返回了一个 float64 类型的值，返回值也可以像形式参数一样被命名，在这种情况下，每个返回值被声明成一个局部变量，并根据该返回值的类型，将其初始化为 0。</p>
<p>如果一个函数在声明时，包含返回值列表，那么该函数必须以 return 语句结尾，除非函数明显无法运行到结尾处，例如函数在结尾时调用了 panic 异常或函数中存在无限循环。</p>
<p>函数的类型被称为函数的标识符，如果两个函数形式参数列表和返回值列表中的变量类型一一对应，那么这两个函数被认为有相同的类型和标识符，形参和返回值的变量名不影响函数标识符也不影响它们是否可以以省略参数类型的形式表示。</p>
<p>每一次函数在调用时都必须按照声明顺序为所有参数提供实参（参数值），<br>在函数调用时，Go语言没有默认参数值，也没有任何方法可以通过参数名指定形参，<br>因此形参和返回值的变量名对于函数调用者而言没有意义。</p>
<p>在函数中，实参通过值传递的方式进行传递，因此函数的形参是实参的拷贝，对形参进行修改不会影响实参，<br>但是，如果实参包括引用类型，如指针、slice(切片)、map、function、channel 等类型，实参可能会由于函数的间接引用被修改。</p>
<p>我们给出 4 种方法声明拥有 2 个 int 型参数和 1 个 int 型返回值的函数，</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">add</span><span class="params">(x <span class="keyword">int</span>, y <span class="keyword">int</span>)</span> <span class="title">int</span></span> {<span class="keyword">return</span> x + y}</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sub</span><span class="params">(x, y <span class="keyword">int</span>)</span> <span class="params">(z <span class="keyword">int</span>)</span></span> { z = x - y; <span class="keyword">return</span>}</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">first</span><span class="params">(x <span class="keyword">int</span>, _ <span class="keyword">int</span>)</span> <span class="title">int</span></span> { <span class="keyword">return</span> x }</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">zero</span><span class="params">(<span class="keyword">int</span>, <span class="keyword">int</span>)</span> <span class="title">int</span></span> { <span class="keyword">return</span> <span class="number">0</span> }</span><br><span class="line">fmt.Printf(<span class="string">"%T\n"</span>, add) <span class="comment">// "func(int, int) int"</span></span><br><span class="line">fmt.Printf(<span class="string">"%T\n"</span>, sub) <span class="comment">// "func(int, int) int"</span></span><br><span class="line">fmt.Printf(<span class="string">"%T\n"</span>, first) <span class="comment">// "func(int, int) int"</span></span><br><span class="line">fmt.Printf(<span class="string">"%T\n"</span>, zero) <span class="comment">// "func(int, int) int"</span></span><br></pre></td></tr></tbody></table></figure>

<p>函数第一种定义方法</p>
<p>如果一组形参或返回值有相同的类型，我们不必为每个形参都写出参数类型，则可在最后一个参数中书写类型 下面 2 个声明是等价的：</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">f</span><span class="params">(i, j, k <span class="keyword">int</span>, s, t <span class="keyword">string</span>)</span></span> { <span class="comment">/* ... */</span> }</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">f</span><span class="params">(i <span class="keyword">int</span>, j <span class="keyword">int</span>, k <span class="keyword">int</span>, s <span class="keyword">string</span>, t <span class="keyword">string</span>)</span></span> { <span class="comment">/* ... */</span> }</span><br></pre></td></tr></tbody></table></figure>

<p>函数返回值名称可指定，可忽略</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">add</span><span class="params">(a, b <span class="keyword">int</span>)</span> <span class="title">int</span></span> {</span><br><span class="line">    <span class="keyword">var</span> sum <span class="keyword">int</span></span><br><span class="line">    sum = a + b</span><br><span class="line">    <span class="keyword">return</span> sum</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>函数的第二种定义方法</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">add2</span><span class="params">(a, b <span class="keyword">int</span>)</span> <span class="params">(sum <span class="keyword">int</span>)</span></span> {</span><br><span class="line">    sum = a + b</span><br><span class="line">    <span class="keyword">return</span> sum</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>函数的第三种定义方法<br>指定函数返回值名称时，可直接 return</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">add3</span><span class="params">(a, b <span class="keyword">int</span>)</span> <span class="params">(sum <span class="keyword">int</span>)</span></span> {</span><br><span class="line">    sum = a + b</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">eval</span><span class="params">(a, b <span class="keyword">int</span>, op <span class="keyword">string</span>)</span> <span class="title">int</span></span> {</span><br><span class="line">    <span class="keyword">switch</span> op {</span><br><span class="line">    <span class="keyword">case</span> <span class="string">"+"</span>:</span><br><span class="line">        <span class="keyword">return</span> a + b</span><br><span class="line">    <span class="keyword">case</span> <span class="string">"-"</span>:</span><br><span class="line">        <span class="keyword">return</span> a - b</span><br><span class="line">    <span class="keyword">case</span> <span class="string">"*"</span>:</span><br><span class="line">        <span class="keyword">return</span> a * b</span><br><span class="line">    <span class="keyword">case</span> <span class="string">"/"</span>:</span><br><span class="line">        q, _ := div(a, b)</span><br><span class="line">        <span class="keyword">return</span> q</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">"unsupported operation: %s"</span> + op)</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line">    fmt.Println(eval(<span class="number">3</span>, <span class="number">4</span>, <span class="string">"*"</span>)) <span class="comment">// 12</span></span><br><span class="line">    fmt.Println(eval(<span class="number">3</span>, <span class="number">4</span>, <span class="string">"/"</span>)) <span class="comment">// 0</span></span><br><span class="line">    <span class="comment">//fmt.Println(eval(3, 4, "x")) // panic: unsupported operation: %sx</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="多返回值"><a href="#多返回值" class="headerlink" title="多返回值"></a>多返回值</h3><p>多返回值能方便地获得函数执行后的多个返回参数</p>
<p>多返回值中的最后一个返回参数返回函数执行中可能发生的错误，</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">evalError</span><span class="params">(a, b <span class="keyword">int</span>, op <span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">int</span>, error)</span></span> {</span><br><span class="line">    <span class="keyword">switch</span> op {</span><br><span class="line">    <span class="keyword">case</span> <span class="string">"+"</span>:</span><br><span class="line">        <span class="keyword">return</span> a + b, <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">"-"</span>:</span><br><span class="line">        <span class="keyword">return</span> a - b, <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">"*"</span>:</span><br><span class="line">        <span class="keyword">return</span> a * b, <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">"/"</span>:</span><br><span class="line">        <span class="keyword">return</span> a / b, <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>, fmt.Errorf(<span class="string">"unsupported operation: %s"</span>, op)</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> result, err := evalError(<span class="number">3</span>, <span class="number">4</span>, <span class="string">"*"</span>); err != <span class="literal">nil</span> {</span><br><span class="line">        fmt.Println(err)</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        fmt.Println(result) <span class="comment">// 12</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> result, err := evalError(<span class="number">3</span>, <span class="number">4</span>, <span class="string">"/"</span>); err != <span class="literal">nil</span> {</span><br><span class="line">        fmt.Println(err)</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        fmt.Println(result) <span class="comment">// 0</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> result, err := evalError(<span class="number">3</span>, <span class="number">4</span>, <span class="string">"x"</span>); err != <span class="literal">nil</span> {</span><br><span class="line">        fmt.Println(err)</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        fmt.Println(result) <span class="comment">// unsupported operation: x</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    fmt.Println(evalError(<span class="number">3</span>, <span class="number">4</span>, <span class="string">"x"</span>)) <span class="comment">// 0 unsupported operation: x</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 被除数等于0</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">div</span><span class="params">(a, b <span class="keyword">int</span>)</span> <span class="params">(<span class="keyword">int</span>, error)</span></span> {</span><br><span class="line">    <span class="keyword">var</span> result <span class="keyword">int</span></span><br><span class="line">    <span class="keyword">var</span> err error</span><br><span class="line">    <span class="keyword">if</span> b == <span class="number">0</span> {</span><br><span class="line">        err = errors.New(<span class="string">"被除数不能为0"</span>)</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        result = a / b</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result, err</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">div2</span><span class="params">(a, b <span class="keyword">int</span>)</span> <span class="params">(result <span class="keyword">int</span>, err error)</span></span> {</span><br><span class="line">    <span class="keyword">if</span> b == <span class="number">0</span> {</span><br><span class="line">        err = errors.New(<span class="string">"被除数不能为0"</span>)</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        result = a / b</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    result, err := div(<span class="number">12</span>, <span class="number">3</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">        fmt.Println(err)</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        fmt.Println(result) <span class="comment">// 4</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    result1, err := div(<span class="number">12</span>, <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">        fmt.Println(err) <span class="comment">// 被除数不能为0</span></span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        fmt.Println(result1)</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    result2, err := div2(<span class="number">12</span>, <span class="number">3</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">        fmt.Println(err)</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        fmt.Println(result2) <span class="comment">// 4</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    result3, err := div2(<span class="number">12</span>, <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">        fmt.Println(err) <span class="comment">// 被除数不能为0</span></span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        fmt.Println(result3)</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">conn, err := connectToNetwork()</span><br></pre></td></tr></tbody></table></figure>

<p>在这段代码中，connectToNetwork 返回两个参数，conn 表示连接对象，err 返回错误信息。</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//func actionVariables(var1 int,var2 int)(int,int) {</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">actionVariables</span><span class="params">(var1, var2 <span class="keyword">int</span>)</span> <span class="params">(<span class="keyword">int</span>, <span class="keyword">int</span>)</span></span> {</span><br><span class="line">    <span class="keyword">return</span> var1 + var2, var1 - var2</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> sum <span class="keyword">int</span></span><br><span class="line">    <span class="keyword">var</span> minus <span class="keyword">int</span></span><br><span class="line">    sum, minus = actionVariables(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">    sum1, minus1 := actionVariables(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">    fmt.Println(sum, minus) <span class="comment">// 3 -1</span></span><br><span class="line">    fmt.Println(sum1, minus1) <span class="comment">// 3 -1</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">actionVariables2</span><span class="params">(var1, var2 <span class="keyword">int</span>)</span> <span class="params">(sum, minus <span class="keyword">int</span>)</span></span> {</span><br><span class="line">    sum = var1 + var2</span><br><span class="line">    minus = var1 - var2</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> sum <span class="keyword">int</span></span><br><span class="line">    <span class="keyword">var</span> minus <span class="keyword">int</span></span><br><span class="line">    sum, minus = actionVariables2(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">    fmt.Println(sum, minus)       <span class="comment">// 3 -1</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="同一种类型返回值"><a href="#同一种类型返回值" class="headerlink" title="同一种类型返回值"></a>同一种类型返回值</h4><p>如果返回值是同一种类型，则用括号将多个返回值类型括起来，用逗号分隔每个返回值的类型。<br>纯类型的返回值对于代码可读性不是很友好，特别是在同类型的返回值出现时，无法区分每个返回参数的意义。</p>
<p>使用 return 语句返回时，值列表的顺序需要与函数声明的返回值类型一致，</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">typedTwoValues</span><span class="params">()</span> <span class="params">(<span class="keyword">int</span>, <span class="keyword">int</span>)</span></span> {</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>, <span class="number">2</span></span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    a, b := typedTwoValues()</span><br><span class="line">    fmt.Println(a, b) <span class="comment">// 1 2</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="带有变量名的返回值"><a href="#带有变量名的返回值" class="headerlink" title="带有变量名的返回值"></a>带有变量名的返回值</h4><p>Go语言支持对返回值进行命名，这样返回值就和参数一样拥有参数变量名和类型。<br>当函数使用命名返回值时，可以在 return 中不填写返回值列表，如果填写也是可行的</p>
<p>命名的返回值变量的默认值为类型的默认值，即数值为 0，字符串为空字符串，布尔为 false、指针为 nil 等。</p>
<p>下面代码中的函数拥有两个整型返回值，函数声明时将返回值命名为 a 和 b，因此可以在函数体中直接对函数返回值进行赋值，在命名的返回值方式的函数体中，在函数结束前需要显式地使用 return 语句进行返回，代码如下：</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 对两个整型返回值进行命名，分别为 a 和 b。</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">namedRetValues</span><span class="params">()</span> <span class="params">(a, b <span class="keyword">int</span>)</span></span> {</span><br><span class="line">    <span class="comment">// 命名返回值的变量与这个函数的布局变量的效果一致，可以对返回值进行赋值和值获取。</span></span><br><span class="line">    a = <span class="number">1</span></span><br><span class="line">    b = <span class="number">2</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    fmt.Println(namedRetValues()) <span class="comment">// 1 2</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// func namedRetValues() (a int, b int) {</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">namedRetValues</span><span class="params">()</span> <span class="params">(a, b <span class="keyword">int</span>)</span></span> {</span><br><span class="line">    a = <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> a, <span class="number">2</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>同一种类型返回值和命名返回值两种形式只能二选一，混用时将会发生编译错误，例如下面的代码：</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">namedRetValues</span><span class="params">()</span> <span class="params">(a, b <span class="keyword">int</span>, <span class="keyword">int</span>)</span></span> {</span><br><span class="line">    a = <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> a, <span class="number">2</span></span><br><span class="line">}</span><br><span class="line">---</span><br><span class="line">syntax error: mixed named and unnamed function parameters</span><br></pre></td></tr></tbody></table></figure>

<p>意思是：在函数参数中混合使用了命名和非命名参数。</p>
<h3 id="不定参数（可变参数）"><a href="#不定参数（可变参数）" class="headerlink" title="不定参数（可变参数）"></a>不定参数（可变参数）</h3><p>通过省略号去动态设置不定个参数</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sum</span><span class="params">(numbers ...<span class="keyword">int</span>)</span> <span class="title">int</span></span> {</span><br><span class="line">    s := <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i := <span class="keyword">range</span> numbers {</span><br><span class="line">        s += numbers[i]</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">    fmt.Println(<span class="string">"1+2+...+5 ="</span>, sum(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>)) <span class="comment">// 1+2+...+5 = 15</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">actionVariables3</span><span class="params">(args ...<span class="keyword">interface</span>{})</span></span> {</span><br><span class="line">    <span class="keyword">for</span> _, value := <span class="keyword">range</span> args {</span><br><span class="line">        <span class="keyword">switch</span> value.(<span class="keyword">type</span>) {</span><br><span class="line">        <span class="keyword">case</span> <span class="keyword">int</span>:</span><br><span class="line">            fmt.Println(value, <span class="string">"int"</span>)</span><br><span class="line">        <span class="keyword">case</span> <span class="keyword">string</span>:</span><br><span class="line">            fmt.Println(value, <span class="string">"string"</span>)</span><br><span class="line">        <span class="keyword">case</span> <span class="keyword">float64</span>:</span><br><span class="line">            fmt.Println(value, <span class="string">"float64"</span>)</span><br><span class="line">        <span class="keyword">case</span> <span class="keyword">bool</span>:</span><br><span class="line">            fmt.Println(value, <span class="string">"bool"</span>)</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            fmt.Println(value, <span class="string">"unknow"</span>)</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">    actionVariables3(<span class="number">1</span>, <span class="string">"我是波哥"</span>, <span class="number">3.14</span>, <span class="literal">true</span>)</span><br><span class="line">    <span class="comment">// 1 int</span></span><br><span class="line">    <span class="comment">// 我是波哥 string</span></span><br><span class="line">    <span class="comment">// 3.14 float64</span></span><br><span class="line">    <span class="comment">// true bool</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">actionVariables5</span><span class="params">(args ...<span class="keyword">interface</span>{})</span></span> {</span><br><span class="line">    <span class="keyword">for</span> key, value := <span class="keyword">range</span> args {</span><br><span class="line">        fmt.Println(key, value)</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line">    actionVariables5(<span class="number">1</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line">    <span class="comment">//0 1</span></span><br><span class="line">    <span class="comment">//1 1</span></span><br><span class="line">    <span class="comment">//2 3</span></span><br><span class="line">    <span class="comment">//3 4</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">    judgeVariablesType(<span class="number">1</span>, <span class="string">"hello"</span>, <span class="literal">true</span>, <span class="number">3.14</span>)</span><br><span class="line">    <span class="comment">//x is a int  1</span></span><br><span class="line">    <span class="comment">//x is a string  hello</span></span><br><span class="line">    <span class="comment">//x is a bool true</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">judgeVariablesType</span><span class="params">(variables ...<span class="keyword">interface</span>{})</span></span> {</span><br><span class="line">    <span class="keyword">for</span> _, value := <span class="keyword">range</span> variables {</span><br><span class="line">        <span class="keyword">if</span> x, ok := value.(<span class="keyword">int</span>); ok {</span><br><span class="line">            fmt.Println(<span class="string">"x is a int "</span>, x)</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> x, ok := value.(<span class="keyword">string</span>); ok {</span><br><span class="line">            fmt.Println(<span class="string">"x is a string "</span>, x)</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> x, ok := value.(<span class="keyword">bool</span>); ok {</span><br><span class="line">            fmt.Println(<span class="string">"x is a bool"</span>, x)</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            fmt.Println(<span class="string">"未知的类型"</span>) <span class="comment">// 未知的类型</span></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="调用函数"><a href="#调用函数" class="headerlink" title="调用函数"></a>调用函数</h3><p>函数在定义后，可以通过调用的方式，让当前代码跳转到被调用的函数中进行执行，调用前的函数局部变量都会被保存起来不会丢失，被调用的函数运行结束后，恢复到调用函数的下一行继续执行代码，之前的局部变量也能继续访问。</p>
<p>函数内的局部变量只能在函数体中使用，函数调用结束后，这些局部变量都会被释放并且失效。</p>
<p>Go语言的函数调用格式如下：</p>
<figure class="highlight fix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">返回值变量列表 </span>=<span class="string"> 函数名(参数列表)</span></span><br></pre></td></tr></tbody></table></figure>

<p>下面是对各个部分的说明：<br>函数名：需要调用的函数名。<br>参数列表：参数变量以逗号分隔，尾部无须以分号结尾。<br>返回值变量列表：多个返回值使用逗号分隔。</p>
<ul>
<li><p>将函数视为“一等公民”</p>
<ul>
<li>函数可以赋值给变量</li>
<li>函数可以作为函数的参数</li>
<li>函数可以作为函数的返回值</li>
</ul>
</li>
</ul>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> sub <span class="function"><span class="keyword">func</span><span class="params">(a, b <span class="keyword">int</span>)</span> <span class="title">int</span> // <span class="title">sub</span>就等同于<span class="title">int</span> <span class="title">map</span>是一种类型</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">subImpl</span><span class="params">(a, b <span class="keyword">int</span>)</span> <span class="title">int</span></span> {</span><br><span class="line">    <span class="keyword">return</span> a - b</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">filter</span><span class="params">(score []<span class="keyword">int</span>, f <span class="keyword">func</span>(<span class="keyword">int</span>)</span> <span class="title">bool</span>) []<span class="title">int</span></span> {</span><br><span class="line">    returnSlice := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">for</span> _, v := <span class="keyword">range</span> score {</span><br><span class="line">        <span class="keyword">if</span> f(v) {</span><br><span class="line">            returnSlice = <span class="built_in">append</span>(returnSlice, v)</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> returnSlice</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    slice := []<span class="keyword">int</span>{<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>}</span><br><span class="line">    fmt.Println(add(slice...)) <span class="comment">// 15</span></span><br><span class="line">    fmt.Println(slice)         <span class="comment">// [9 2 3 4 5]</span></span><br><span class="line"></span><br><span class="line">    slice1 := []<span class="keyword">int</span>{<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>}</span><br><span class="line">    fmt.Println(add1(slice1)) <span class="comment">// 15</span></span><br><span class="line">    fmt.Println(slice1)       <span class="comment">// [9 2 3 4 5]</span></span><br><span class="line">    <span class="comment">//这种效果slice</span></span><br><span class="line">    <span class="comment">//区别，slice是一种类型， 还是引用传递， 我们要慎重</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//省略号的用途 1. 函数参数不定长 2. 将slice打散 3.</span></span><br><span class="line">    arr := [...]<span class="keyword">int</span>{<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>}</span><br><span class="line">    fmt.Printf(<span class="string">"%T\n"</span>, arr) <span class="comment">// [3]int</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//匿名函数</span></span><br><span class="line">    myFunc := <span class="function"><span class="keyword">func</span><span class="params">(a, b <span class="keyword">int</span>)</span> <span class="title">int</span></span> {</span><br><span class="line">        <span class="keyword">return</span> a + b</span><br><span class="line">    }</span><br><span class="line">    myFunc(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">    fmt.Printf(<span class="string">"%T"</span>, myFunc) <span class="comment">// func(int, int) int</span></span><br><span class="line"></span><br><span class="line">    result := <span class="function"><span class="keyword">func</span><span class="params">(a, b <span class="keyword">int</span>)</span> <span class="title">int</span></span> {</span><br><span class="line">        <span class="keyword">return</span> a + b</span><br><span class="line">    }(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">    fmt.Println(result)      <span class="comment">// 3</span></span><br><span class="line">    fmt.Printf(<span class="string">"%T"</span>, myFunc) <span class="comment">// func(int, int) int</span></span><br><span class="line"></span><br><span class="line">    fmt.Println(<span class="function"><span class="keyword">func</span><span class="params">(a, b <span class="keyword">int</span>)</span> <span class="title">int</span></span> {</span><br><span class="line">        <span class="keyword">return</span> a + b</span><br><span class="line">    }(<span class="number">1</span>, <span class="number">2</span>)) <span class="comment">// 3</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//myFunc := add</span></span><br><span class="line">    <span class="comment">//fmt.Printf("%T", myFunc) // func(...int) int</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//函数也可以当做参数传递给一个函数</span></span><br><span class="line">    <span class="keyword">var</span> mySub sub = <span class="function"><span class="keyword">func</span><span class="params">(a, b <span class="keyword">int</span>)</span> <span class="title">int</span></span> {</span><br><span class="line">        <span class="keyword">return</span> a - b</span><br><span class="line">    }</span><br><span class="line">    fmt.Println(mySub(<span class="number">1</span>, <span class="number">2</span>)) <span class="comment">// -1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//将函数作为另一个函数的参数</span></span><br><span class="line">    <span class="comment">//写一个函数用于过滤一部分数据</span></span><br><span class="line">    score := []<span class="keyword">int</span>{<span class="number">10</span>, <span class="number">50</span>, <span class="number">80</span>, <span class="number">90</span>, <span class="number">85</span>}</span><br><span class="line">    <span class="comment">//写一个函数过滤掉不合格的成绩</span></span><br><span class="line">    fmt.Println(filter(score, <span class="function"><span class="keyword">func</span><span class="params">(a <span class="keyword">int</span>)</span> <span class="title">bool</span></span> {</span><br><span class="line">        <span class="keyword">if</span> a &gt;= <span class="number">90</span> {</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        }</span><br><span class="line">    })) <span class="comment">// [90]</span></span><br><span class="line">    <span class="comment">//gin, python的装饰器</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="函数做为一种类型，在函数参数中使用"><a href="#函数做为一种类型，在函数参数中使用" class="headerlink" title="函数做为一种类型，在函数参数中使用"></a>函数做为一种类型，在函数参数中使用</h3><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    sum, minus = funcAsArgs(actionVariables4, <span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">    fmt.Println(sum, minus) <span class="comment">// 3 -1</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">actionVariables4</span><span class="params">(var1, var2 <span class="keyword">int</span>)</span> <span class="params">(sum <span class="keyword">int</span>, minus <span class="keyword">int</span>)</span></span> {</span><br><span class="line">    sum = var1 + var2</span><br><span class="line">    minus = var1 - var2</span><br><span class="line">    <span class="comment">//return sum,minus</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">funcAsArgs</span><span class="params">(funcName <span class="keyword">func</span>(<span class="keyword">int</span>, <span class="keyword">int</span>)</span> <span class="params">(<span class="keyword">int</span>, <span class="keyword">int</span>)</span>, <span class="title">var1</span>, <span class="title">var2</span> <span class="title">int</span>) <span class="params">(<span class="keyword">int</span>, <span class="keyword">int</span>)</span></span> {</span><br><span class="line">    <span class="keyword">return</span> funcName(var1, var2)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>go语言官方推荐函数返回值命名，go提供了生成文档的工具，文档是给团队中其他人看的，有助于理解与团队合作</p>
<h3 id="函数作为实参值在函数参数中使用，实现回调"><a href="#函数作为实参值在函数参数中使用，实现回调" class="headerlink" title="函数作为实参值在函数参数中使用，实现回调"></a>函数作为实参值在函数参数中使用，实现回调</h3><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="comment">// 函数做为值 type</span></span><br><span class="line">    slice := []<span class="keyword">int</span>{<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>}</span><br><span class="line"></span><br><span class="line">    evenSlice := judgeSlice(slice, isEven)</span><br><span class="line">    oddSlice := judgeSlice(slice, isOdd)</span><br><span class="line">    fmt.Println(<span class="string">"偶数："</span>, evenSlice) <span class="comment">// 偶数： [2 4 6]</span></span><br><span class="line">    fmt.Println(<span class="string">"奇数："</span>, oddSlice)  <span class="comment">// 奇数： [1 3 5 7]</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 声明一个函数类型</span></span><br><span class="line"><span class="keyword">type</span> Boolean <span class="function"><span class="keyword">func</span><span class="params">(<span class="keyword">int</span>)</span> <span class="title">bool</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 是否为偶数</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">isEven</span><span class="params">(integer <span class="keyword">int</span>)</span> <span class="title">bool</span></span> {</span><br><span class="line">    <span class="keyword">if</span> integer%<span class="number">2</span> == <span class="number">0</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 是否为奇数</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">isOdd</span><span class="params">(integer <span class="keyword">int</span>)</span> <span class="title">bool</span></span> {</span><br><span class="line">    <span class="keyword">if</span> integer%<span class="number">2</span> == <span class="number">0</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">judgeSlice</span><span class="params">(slice []<span class="keyword">int</span>, boolean Boolean)</span> <span class="params">(result []<span class="keyword">int</span>)</span></span> {</span><br><span class="line">    <span class="keyword">for</span> _, value := <span class="keyword">range</span> slice {</span><br><span class="line">        <span class="keyword">if</span> boolean(value) {</span><br><span class="line">            result = <span class="built_in">append</span>(result, value)</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    testCallBack(<span class="number">1</span>, callBack)</span><br><span class="line">    testCallBack(<span class="number">2</span>, <span class="function"><span class="keyword">func</span><span class="params">(x <span class="keyword">int</span>)</span> <span class="title">int</span></span> {</span><br><span class="line">        fmt.Printf(<span class="string">"我是回调，x：%d\n"</span>, x)</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line">    })</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> cb <span class="function"><span class="keyword">func</span><span class="params">(<span class="keyword">int</span>)</span> <span class="title">int</span> // 声明一个函数类型</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">testCallBack</span><span class="params">(x <span class="keyword">int</span>, f cb)</span></span> {</span><br><span class="line">    f(x)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">callBack</span><span class="params">(x <span class="keyword">int</span>)</span> <span class="title">int</span></span> {</span><br><span class="line">    fmt.Printf(<span class="string">"我是回调，x：%d\n"</span>, x)</span><br><span class="line">    <span class="keyword">return</span> x</span><br><span class="line">}</span><br><span class="line">---</span><br><span class="line">我是回调，x：<span class="number">1</span></span><br><span class="line">我是回调，x：<span class="number">2</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="函数（方法）注释"><a href="#函数（方法）注释" class="headerlink" title="函数（方法）注释"></a>函数（方法）注释</h3><p>每个函数，或者方法（结构体或者接口下的函数称为方法）都应该有注释说明，函数的注释应该包括三个方面（严格按照此顺序撰写）：</p>
<ul>
<li>简要说明，格式说明：以函数名开头，“，”分隔说明部分</li>
<li>参数列表：每行一个参数，参数名开头，“，”分隔说明部分</li>
<li>返回值： 每行一个返回值</li>
</ul>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NewtAttrModel ， 属性数据层操作类的工厂方法</span></span><br><span class="line"><span class="comment">// 参数：</span></span><br><span class="line"><span class="comment">//      ctx ： 上下文信息</span></span><br><span class="line"><span class="comment">// 返回值：</span></span><br><span class="line"><span class="comment">//      属性操作类指针</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewAttrModel</span><span class="params">(ctx *common.Context)</span> *<span class="title">AttrModel</span></span> {</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/07/05/python-han-shu/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/07/05/python-han-shu/" class="post-title-link" itemprop="url">python函数</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-07-04 16:21:41" itemprop="dateCreated datePublished" datetime="2021-07-04T16:21:41Z">2021-07-04</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-07-26 12:59:54" itemprop="dateModified" datetime="2021-07-26T12:59:54Z">2021-07-26</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>一个简单的计算器</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">a = int(input(<span class="string">"请输入第一个数："</span>))</span><br><span class="line">op = input(<span class="string">"操作符："</span>)</span><br><span class="line">b = int(input(<span class="string">"请输入第二个数："</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># if op == "+":</span></span><br><span class="line"><span class="comment">#     print(a+b)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># if op == "-":</span></span><br><span class="line"><span class="comment">#     print(a-b)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># if op == "z*":</span></span><br><span class="line"><span class="comment">#     print(a*b)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># if op == "/":</span></span><br><span class="line"><span class="comment">#     print(a/b)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 字典映射代替简单的if语句</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">a, b</span>):</span></span><br><span class="line">    <span class="keyword">return</span> a + b</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add1</span>(<span class="params">a, b</span>):</span></span><br><span class="line">    <span class="keyword">return</span> add()</span><br><span class="line">    <span class="comment"># return add(a, b)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sub</span>(<span class="params">a, b</span>):</span></span><br><span class="line">    <span class="keyword">return</span> a - b</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">div</span>(<span class="params">a, b</span>):</span></span><br><span class="line">    <span class="keyword">return</span> a / b</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mul</span>(<span class="params">a, b</span>):</span></span><br><span class="line">    <span class="keyword">return</span> a * b</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">op_dict = {</span><br><span class="line">    <span class="string">"+"</span>: add,</span><br><span class="line">    <span class="string">"++"</span>: add1,</span><br><span class="line">    <span class="string">"-"</span>: sub,</span><br><span class="line">    <span class="string">"/"</span>: div,</span><br><span class="line">    <span class="string">"*"</span>: mul,</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">func = op_dict[op]</span><br><span class="line"><span class="comment"># print(func(a, b)(a, b))</span></span><br><span class="line">print(func(a, b))</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li><p>将函数视为“一等公民”</p>
<ul>
<li>函数可以赋值给变量</li>
<li>函数可以作为函数的参数</li>
<li>函数可以作为函数的返回值</li>
</ul>
</li>
</ul>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 把函数当做普通的变量使用， 还可以当做一个返回值 这个特性就是一等公民的特性</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">*args, **kwargs</span>):</span></span><br><span class="line">    sum = <span class="number">0</span></span><br><span class="line">    first = kwargs[<span class="string">"first"</span>]</span><br><span class="line">    <span class="keyword">for</span> v <span class="keyword">in</span> args:</span><br><span class="line">        sum += int(v)</span><br><span class="line">    <span class="keyword">return</span> sum</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">printInfo</span>(<span class="params">name=<span class="string">""</span>, age=<span class="number">18</span></span>):</span></span><br><span class="line">    print(<span class="string">"姓名:{}, 年龄:{}"</span>.format(name, age))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">datas = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="string">"6"</span>]</span><br><span class="line">print(add(first=<span class="number">12</span>, last=<span class="number">9</span>))  <span class="comment"># 0</span></span><br><span class="line">printInfo(age=<span class="number">18</span>, name=<span class="string">"bobby"</span>)  <span class="comment"># 姓名:bobby, 年龄:18</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 有一些情况是需要两种操作都出现 1. 文件 （打开，close） 2. 数据库的连接 （开启连接， 关闭连接） 3. 锁(获取、释放)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_file</span>(<span class="params">file_name</span>):</span></span><br><span class="line">    f = open(file_name)</span><br><span class="line">    <span class="keyword">with</span> open(file_name) <span class="keyword">as</span> f:</span><br><span class="line">        sum = <span class="number">0</span></span><br><span class="line">        data = [<span class="number">1</span>, <span class="number">2</span>]</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">            sum += int(line)  <span class="comment">#这一行代码可能有异常  很多容易出现异常</span></span><br><span class="line">        <span class="comment"># f.close()</span></span><br><span class="line">        print(<span class="string">"before return"</span>)</span><br><span class="line">        re_data = data  <span class="comment"># data是list类型 引用传递  re_data中有一个拷贝=3</span></span><br><span class="line">        lock = threading.Lock()</span><br><span class="line">        lock.acquire()</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 此处是多行处理逻辑 这些就可能抛出异常</span></span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            lock.release()  <span class="comment"># 此处可能抛出异常</span></span><br><span class="line">        <span class="comment"># 此处跳往finally执行</span></span><br><span class="line">        <span class="keyword">return</span> re_data</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 代码出现异常导致f.close执行不到</span></span><br><span class="line"><span class="comment"># 2. 我们忘记close了吧</span></span><br><span class="line"><span class="comment"># 无论是否正常运行到吗都能够执行到指定的逻辑</span></span><br><span class="line"><span class="comment"># print(read_file("xxx.txt"))</span></span><br><span class="line"><span class="comment"># 代码很丑陋，一旦逻辑复制 这种代码大量的充斥了我们的代码中， java</span></span><br><span class="line"><span class="comment"># finally有一些细节我们需要知道 就有了第一个印象：finally会在return之后运行</span></span><br><span class="line"><span class="comment"># 事实上真的是这样吗？</span></span><br><span class="line"><span class="comment"># 原因： 实际上finally是在return之前调用的</span></span><br><span class="line"><span class="comment"># finally中是可以return的 而且这个地方一旦有了return就会覆盖原本的return</span></span><br></pre></td></tr></tbody></table></figure>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/07/04/go-zhi-zhen/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/07/04/go-zhi-zhen/" class="post-title-link" itemprop="url">go指针</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-07-03 16:21:41" itemprop="dateCreated datePublished" datetime="2021-07-03T16:21:41Z">2021-07-03</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-08-07 03:35:39" itemprop="dateModified" datetime="2021-08-07T03:35:39Z">2021-08-07</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>像python和java这种语言都是极力的屏蔽指针，<br>c/c++ 都提供了指针功能很强大 指针的转换 指针的偏移 指针的运算</p>
<p>程序在内存中存储它的值，每个内存块都 有一个地址，每一个字节其实都是有地址<br>而存储的是另一个变量的内存地址的变量被称为指针变量，一个指针变量可以指向任何一个值的内存地址指向的空间</p>
<p>通常用0x开头的十六进制数表示，如：0x6b0820 或 0xf84001d7f0</p>
<p>在 32 位机器上占用 4 个字节，在 64 位机器上占用 8 个字节，并且与它所指向的值的大小无关。<br>指针储存的是一个值的地址，但本身这个指针也需要地址来储存<br>指针可以指向任何类型的值的内存地址，但是使用时指定指针的类型在实际编码中具有重要意义；<br>指针可以指向另一个指针，并且可以进行任意深度的嵌套，导致你可以有多级的间接引用，但在大多数情况这会使你的代码结构不清晰</p>
<p>在指针类型前面加上 <code>&amp;</code> 号来获取地址。<br>在指针类型前面加上 <code>*</code> 号来根据地址获取该地址指向空间的值，使用一个指针引用一个值被称为间接引用。<br>引用类型 修改指针指向变量对应的值,但是不会修改地址</p>
<p>取变量值的方式<br>1.直接通过变量名,variables<br>2.通过指针间接访问(指针名),</p>
<p>go语言没有屏蔽指针，但是go语言在指针上做了大量的限制，安全性高很多，相比较 c和c++灵活性就降低了<br>不像c有<code>pointer ++</code> <code>pointer +2</code> 当前指针从当前位置向前或向后移动一定的位置的指针运算，因为指针的乱引用会导致的内存泄漏，以及引发一连串程序的崩溃</p>
<p>很多时候都是函数参数的时候指明的类型</p>
<p>go中数组是值传递 数组中有100万个值，对于这种一般采用切片来传递<br>在python中list和dict这种传递都是引用传递</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 先定义变量</span></span><br><span class="line"><span class="keyword">var</span> intVariables <span class="keyword">int</span> = <span class="number">100</span></span><br><span class="line">fmt.Printf(<span class="string">"intVariables的值=%d, 地址=%v\n"</span>, intVariables, &amp;intVariables)</span><br><span class="line"><span class="comment">//intVariables的值=100, 地址=0xc000128058</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义一个指针类型的变量去指向变量 intVariables 的地址</span></span><br><span class="line"><span class="keyword">var</span> pointerVariables *<span class="keyword">int</span> = &amp;intVariables</span><br><span class="line">fmt.Printf(<span class="string">"pointerVariables的值=%v, 地址=%v\n"</span>, pointerVariables, &amp;pointerVariables)</span><br><span class="line"><span class="comment">//pointerVariables的值=0xc000128058, 地址=0xc000154020</span></span><br></pre></td></tr></tbody></table></figure>

<p>变量名               变量值               地址<br>intVariables        100                 0xc000128058<br>pointerVariables    0xc000128058        0xc000154020</p>
<p>指针的作用及应用场景<br>作用 应用场景</p>
<p>管理节省内存空间，提高执行效率（当操作的数据量较大规模时）<br>访问变量的值<br>修改变量的值</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">fmt.Println(intVariables) <span class="comment">// 100</span></span><br><span class="line">*pointerVariables = <span class="number">200</span></span><br><span class="line">fmt.Println(intVariables) <span class="comment">// 200</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> variables2 <span class="keyword">int</span> = <span class="number">123</span></span><br><span class="line"><span class="keyword">var</span> pointerVariables2 *<span class="keyword">int</span> = &amp;variables2</span><br><span class="line"></span><br><span class="line">fmt.Println(*pointerVariables2, variables2) <span class="comment">// 123 123</span></span><br><span class="line">pointerVariables2 = variables2 <span class="comment">// cannot use variables2 (type int) as type *int in assignment</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">add1</span><span class="params">(params []<span class="keyword">int</span>)</span> <span class="params">(sum <span class="keyword">int</span>)</span></span> {</span><br><span class="line">    <span class="comment">// 切片 解决可能有不定个int值传递进来</span></span><br><span class="line">    <span class="keyword">for</span> _, v := <span class="keyword">range</span> params {</span><br><span class="line">        sum += v</span><br><span class="line">    }</span><br><span class="line">    params[<span class="number">0</span>] = <span class="number">9</span> <span class="comment">// 引用传递影响</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">swap1</span><span class="params">(a, b <span class="keyword">int</span>)</span></span> {</span><br><span class="line">    <span class="comment">// 用于交换a和b</span></span><br><span class="line">    temp := a <span class="comment">/* 保存 a 的值 */</span></span><br><span class="line">    a = b     <span class="comment">/* 将 b 值赋给 a */</span></span><br><span class="line">    b = temp  <span class="comment">/* 将 temp 值赋给 b*/</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 可以不需要临时变量</span></span><br><span class="line">    <span class="comment">// a, b = b, a</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    a, b := <span class="number">10</span>, <span class="number">20</span></span><br><span class="line"></span><br><span class="line">    swap1(a, b)</span><br><span class="line">    fmt.Println(a, b) <span class="comment">// 10 20</span></span><br><span class="line">    <span class="comment">// 这个函数运行完成以后 a和b 的值为什么交换不成功，int类型是值传递</span></span><br><span class="line">    fmt.Printf(<span class="string">"%p\n"</span>, &amp;a) <span class="comment">// 0xc00000a0a8 变量有地址</span></span><br><span class="line"></span><br><span class="line">    a, b = b, a</span><br><span class="line">    fmt.Println(a, b) <span class="comment">// 20 10</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">swap</span><span class="params">(a, b *<span class="keyword">int</span>)</span></span> { <span class="comment">// 参数是指向int的指针</span></span><br><span class="line">    <span class="comment">// 用于交换a和b</span></span><br><span class="line">    temp := *a <span class="comment">/* 保持 a 地址上的值 */</span></span><br><span class="line">    *a = *b    <span class="comment">/* 将 b 地址上的值赋给 a */</span></span><br><span class="line">    *b = temp  <span class="comment">/* 将 temp 值赋给 b */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 可以不需要临时变量</span></span><br><span class="line">    <span class="comment">// *a, *b = *b, *a</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    a, b := <span class="number">10</span>, <span class="number">20</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//a, b = b, a</span></span><br><span class="line">    <span class="comment">//fmt.Println(a, b) // 20 10</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//现在有一种特殊的变量类型，这个变量只能保存地址值</span></span><br><span class="line">    <span class="keyword">var</span> ip *<span class="keyword">int</span> <span class="comment">//这个变量里面就只能保存地址类型这种值</span></span><br><span class="line">    ip = &amp;a</span><br><span class="line">    <span class="comment">// 如果要修改指针指向的内存对应的变量的值，用法也比较特殊</span></span><br><span class="line">    *ip = <span class="number">30</span></span><br><span class="line">    fmt.Println(a) <span class="comment">// 30</span></span><br><span class="line">    <span class="comment">//如何定义指针变量 如果修改指针变量指向的内存中的值。 通过指针去取值的时候不知道应该取多大的连续内存空间</span></span><br><span class="line">    fmt.Printf(<span class="string">"ip所指向的内存空间地址是：%p, 内存中的值是: %d\n"</span>, ip, *ip)</span><br><span class="line">    <span class="comment">//ip所指向的内存空间地址是：0xc00000a0a8, 内存中的值是: 30</span></span><br><span class="line"></span><br><span class="line">    swap(&amp;a, &amp;b)</span><br><span class="line">    fmt.Println(a, b) <span class="comment">// 20 30</span></span><br><span class="line">    <span class="comment">//if a != nil { // Cannot convert 'nil' to type 'int'</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">swap</span><span class="params">(a, b <span class="keyword">int</span>)</span> <span class="params">(<span class="keyword">int</span>, <span class="keyword">int</span>)</span></span> {</span><br><span class="line">    <span class="keyword">return</span> b, a</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    a, b := <span class="number">10</span>, <span class="number">20</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//a, b = b, a</span></span><br><span class="line">    <span class="comment">//fmt.Println(a, b) // 20 10</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//现在有一种特殊的变量类型，这个变量只能保存地址值</span></span><br><span class="line">    <span class="keyword">var</span> ip *<span class="keyword">int</span> <span class="comment">//这个变量里面就只能保存地址类型这种值</span></span><br><span class="line">    ip = &amp;a</span><br><span class="line">    <span class="comment">// 如果要修改指针指向的内存对应的变量的值，用法也比较特殊</span></span><br><span class="line">    *ip = <span class="number">30</span></span><br><span class="line">    fmt.Println(a) <span class="comment">// 30</span></span><br><span class="line">    <span class="comment">//如何定义指针变量 如果修改指针变量指向的内存中的值。 通过指针去取值的时候不知道应该取多大的连续内存空间</span></span><br><span class="line">    fmt.Printf(<span class="string">"ip所指向的内存空间地址是：%p, 内存中的值是: %d\n"</span>, ip, *ip)</span><br><span class="line">    <span class="comment">//ip所指向的内存空间地址是：0xc00000a0a8, 内存中的值是: 30</span></span><br><span class="line"></span><br><span class="line">    a, b = swap(a, b)</span><br><span class="line">    fmt.Println(a, b) <span class="comment">// 20 30</span></span><br><span class="line">    <span class="comment">//if a != nil { // Cannot convert 'nil' to type 'int'</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>指针还可以指向数组 指向数组的指针 数组是值类型</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">arr := [<span class="number">3</span>]<span class="keyword">int</span>{<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>}</span><br><span class="line"><span class="keyword">var</span> ip *[<span class="number">3</span>]<span class="keyword">int</span> = &amp;arr</span><br><span class="line"><span class="comment">// 指针数组</span></span><br><span class="line"><span class="keyword">var</span> ptrs [<span class="number">3</span>]*<span class="keyword">int</span> <span class="comment">//创建能够存放三个指针变量的数组，注意*的位置</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ip != <span class="literal">nil</span> {</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"><span class="comment">//if ptrs != nil { // Cannot convert 'nil' to type '[3]*int'</span></span><br><span class="line"><span class="comment">//}</span></span><br></pre></td></tr></tbody></table></figure>


<p>当一个指针只被申明定义后不赋值分配到任何变量时，它的值为 nil。对一个空指针像普通变量那样给他赋值的反向引用是不合法的，并且会使程序崩溃</p>
<p>申明了一个只能放地址的变量 pointer1 但是变量没有初始值 没有占用内存分配，保留了占位符，占空间（是nil），不指向内存</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">var</span> pointer1 *<span class="keyword">int</span></span><br><span class="line">    *pointer1 = <span class="number">10</span>    <span class="comment">// panic: runtime error: invalid memory address or nil pointer dereference</span></span><br><span class="line">    <span class="comment">//[signal 0xc0000005 code=0x1 addr=0x0 pc=0xee2722]</span></span><br><span class="line">    fmt.Println(pointer1, &amp;pointer1, *pointer1)</span><br></pre></td></tr></tbody></table></figure>


<p>报这个错的原因是 go 初始化指针的时候会为指针 pointer1 的值赋为 nil ，但 pointer1 的值代表的是 *pointer1 的地址， nil 的话系统还并没有给 *pointer1 分配地址，所以这时给 *pointer1 赋值肯定会出错  nil的地址设为10，但是nil的空间地址都没有<br>解决这个问题非常简单，在给指针赋值前可以先创建一块内存分配给赋值对象即可</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">var</span> p *<span class="keyword">int</span></span><br><span class="line">    p = <span class="built_in">new</span>(<span class="keyword">int</span>)</span><br><span class="line">    *p = <span class="number">1</span></span><br><span class="line">    fmt.Println(p, &amp;p, *p) <span class="comment">// 0xc04204a080  0xc042068018  1</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>p 是一个指针，他的值为内存地址 0xc04204a080<br>而 p 的内存地址为 0xc042068018<br>内存地址 0xc04204a080 储存的值为 1</p>
<p>使用指针会增加额外空间<br>默认值 int byte rune float bool string 这些类型都有默认值，占用内存分配<br>指针， 切片 map， 接口这些默认值是nil 理解为none，不能直接赋值</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a <span class="keyword">int</span></span><br><span class="line">a = <span class="number">10</span></span><br><span class="line">fmt.Println(a) <span class="comment">// 10</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//对于指针来说或者说其他的默认值是0的情况来说 如何一开始申明的时候就分配内存</span></span><br><span class="line"><span class="comment">//go的编译器就知道先申请调用操作系统的分配内存空间接口，操作系统预留一个可用的空间把地址给go，go会把操作系统给的地址设置到p变量</span></span><br><span class="line"><span class="keyword">var</span> p *<span class="keyword">int</span> = <span class="built_in">new</span>(<span class="keyword">int</span>) <span class="comment">// 这里的内存中的值全部设置为0</span></span><br><span class="line">*p = <span class="number">10</span></span><br><span class="line">fmt.Println(p) <span class="comment">// 0xc00000a0d0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//int使用make就不行</span></span><br><span class="line"><span class="comment">//除了new函数可以申请内存以外 还有更加常用的是make函数， make函数一般用于切片 map</span></span><br><span class="line"><span class="comment">//var info map[string]string</span></span><br><span class="line"><span class="comment">//info["c"] = "bobby" // panic: assignment to entry in nil map</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> info1 <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span> = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</span><br><span class="line">info1[<span class="string">"c"</span>] = <span class="string">"bobby"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//new函数返回的是这个值的地址 指针 make函数返回的是指定类型的实例</span></span><br><span class="line"><span class="comment">//nil的一些细节</span></span><br><span class="line"><span class="keyword">var</span> info2 <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span></span><br><span class="line"><span class="keyword">if</span> info2 == <span class="literal">nil</span> {</span><br><span class="line">    fmt.Println(<span class="string">"map的默认值是 nil"</span>) <span class="comment">// map的默认值是 nil</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">//var x int = nil // Cannot use 'nil' as the type int</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> slice []<span class="keyword">string</span></span><br><span class="line"><span class="keyword">if</span> slice == <span class="literal">nil</span> {</span><br><span class="line">    fmt.Println(<span class="string">"slice的默认值是 nil"</span>) <span class="comment">// slice的默认值是 nil</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> err error</span><br><span class="line"><span class="keyword">if</span> err == <span class="literal">nil</span> {</span><br><span class="line">    fmt.Println(<span class="string">"error的默认值是 nil"</span>) <span class="comment">// error的默认值是 nil</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>python中的None和go语言中的nil类型不一样，None是全局唯一的<br>go语言中 nil是唯一可以用来表示部分类型的零值的标识符，不是实际的对象，它可以代表许多不同内存布局的值</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fmt.Println(unsafe.Sizeof(slice), unsafe.Sizeof(info2)) <span class="comment">// 24 8</span></span><br></pre></td></tr></tbody></table></figure>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/07/04/go-de-map/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/07/04/go-de-map/" class="post-title-link" itemprop="url">go的map</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-07-03 16:21:41" itemprop="dateCreated datePublished" datetime="2021-07-03T16:21:41Z">2021-07-03</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-08-06 07:14:41" itemprop="dateModified" datetime="2021-08-06T07:14:41Z">2021-08-06</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="map创建"><a href="#map创建" class="headerlink" title="map创建"></a>map创建</h3><p>Map 是一种无序的key-value键值对组成的集合。<br>通过 key 可以快速检索到我们需要的数据value，这里的key 类似于索引，指向对应的数据值。</p>
<p>可以像迭代数组和切片那样迭代它。不过，Map 是无序的，我们无法决定它的返回顺序，每次循环出来的数据的顺序是不一致的，这是因为 Map 是使用 hash 表来实现的，是通过散列函数对key计算一个唯一值与值进行映射</p>
<p>通过散列函数对我们的map<br>0xc0001<br>0xc0002<br>0xc0003</p>
<p>2.函数传参，遵循引用类型规则<br>3.类似perl当中的hash,python当中dict的字典，go当中被称为map</p>
<h3 id="map的定义"><a href="#map的定义" class="headerlink" title="map的定义"></a>map的定义</h3><p>要求所有的key的数据类型相同，所有value数据类型相同(注：key与value可以有不同的数据类型)<br>map的key和value类型申明的就要指明</p>
<p>map中的键是唯一的，不可以重复，值可以重复</p>
<h4 id="在申明同时赋值"><a href="#在申明同时赋值" class="headerlink" title="在申明同时赋值"></a>在申明同时赋值</h4><p>map的初始长度会根据初始化时指定的键值对的数量来确定。</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1. 字面值</span></span><br><span class="line">m1 := <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>{ <span class="comment">// 定义map类型变量m1，key的类型为string支持 == 比较操作，value的类型string</span></span><br><span class="line">    <span class="string">"m1"</span>: <span class="string">"v1"</span>, <span class="comment">// 定义时指定的初始key/value, 后面可以继续添加</span></span><br><span class="line">}</span><br><span class="line">fmt.Printf(<span class="string">"%v\n"</span>, m1) <span class="comment">// map[m1:v1]</span></span><br><span class="line"></span><br><span class="line">m3 := <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>{} <span class="comment">//创建定义一个空的map</span></span><br><span class="line">fmt.Println(m3)           <span class="comment">// map[]</span></span><br><span class="line">fmt.Printf(<span class="string">"%v\n"</span>, m3)    <span class="comment">// map[]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> mapVariables2 = <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">int</span>{</span><br><span class="line">    <span class="string">"Monday"</span>: <span class="number">1</span>, <span class="string">"Tuesday"</span>: <span class="number">2</span>, <span class="string">"Wednesday"</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="string">"Thursday"</span>: <span class="number">4</span>,</span><br><span class="line">}</span><br><span class="line">fmt.Println(mapVariables2) <span class="comment">// map[Monday:1 Thursday:4 Tuesday:2 Wednesday:3]</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="var-map-key的类型-value的类型"><a href="#var-map-key的类型-value的类型" class="headerlink" title="var map[key的类型]value的类型"></a><code>var map[key的类型]value的类型</code></h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.申明</span></span><br><span class="line"><span class="keyword">var</span> mapVariables1 <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span></span><br><span class="line">fmt.Println(mapVariables1) <span class="comment">// map[]</span></span><br><span class="line"><span class="comment">// 2.在使用map前，需要先make , make的作用就是给map分配数据空间，之后才可以进行引用</span></span><br><span class="line">mapVariables1 = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</span><br><span class="line">mapVariables1[<span class="string">"Monday"</span>] = <span class="string">"周一"</span></span><br><span class="line">mapVariables1[<span class="string">"Tuesday"</span>] = <span class="string">"周二"</span></span><br><span class="line">fmt.Println(mapVariables1) <span class="comment">// map[Monday:周一 Tuesday:周二]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//map这里的key是唯一的，会覆盖以前的</span></span><br><span class="line">mapVariables1[<span class="string">"Monday"</span>] = <span class="string">"大周一"</span></span><br><span class="line">fmt.Println(mapVariables1) <span class="comment">// map[Monday:大周一 Tuesday:周二]</span></span><br><span class="line">fmt.Println(<span class="built_in">len</span>(mapVariables1)) <span class="comment">// 2</span></span><br></pre></td></tr></tbody></table></figure>

<p>只申明没有make，没有分配内存空间，值为nil，不能对它赋值</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mapVariables6 <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span></span><br><span class="line">mapVariables6[<span class="string">"hello"</span>] = <span class="string">"波哥"</span> <span class="comment">// panic: assignment to entry in nil map</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="通过短冒号（简短声明）直接使用-make-的形式，当只需要声明一个-map-的时候"><a href="#通过短冒号（简短声明）直接使用-make-的形式，当只需要声明一个-map-的时候" class="headerlink" title="通过短冒号（简短声明）直接使用 := + make 的形式，当只需要声明一个 map 的时候"></a>通过短冒号（简短声明）直接使用 := + make 的形式，当只需要声明一个 map 的时候</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mapVariables3 := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">int</span>)</span><br><span class="line">mapVariables3[<span class="string">"Monday"</span>] = <span class="number">1</span></span><br><span class="line">mapVariables3[<span class="string">"Tuesday"</span>] = <span class="number">2</span></span><br><span class="line">mapVariables3[<span class="string">"Wednesday"</span>] = <span class="number">3</span></span><br><span class="line">fmt.Println(mapVariables3) <span class="comment">// map[Monday:1 Tuesday:2 Wednesday:3]</span></span><br><span class="line"></span><br><span class="line">mapVariables2 := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</span><br><span class="line">mapVariables2[<span class="string">"Monday"</span>] = <span class="string">"周一"</span></span><br><span class="line">mapVariables2[<span class="string">"Tuesday"</span>] = <span class="string">"周二"</span></span><br><span class="line">mapVariables2[<span class="string">"Wednesday"</span>] = <span class="string">"周三"</span></span><br><span class="line"></span><br><span class="line">m2 := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>) <span class="comment">// 创建空的map，里面不含元素，元素都需要后续添加</span></span><br><span class="line">fmt.Println(m2)               <span class="comment">// map[]</span></span><br><span class="line">fmt.Println(<span class="built_in">len</span>(m2))          <span class="comment">// 0</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="map中key的类型"><a href="#map中key的类型" class="headerlink" title="map中key的类型"></a>map中key的类型</h3><p>map中的每个key在keys的集合中是唯一的，而且需要支持 == or != 操作<br>key的常用类型：int, rune, string, 结构体(每个元素需要支持 == or != 操作 不包含slice切片，map,函数), 指针, 基于这些类型自定义的类型，</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> m0 <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span> <span class="comment">// 定义map类型变量m0，key的类型为string，value的类型string</span></span><br><span class="line">fmt.Println(m0)</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">a := []<span class="keyword">int</span>{<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>}</span><br><span class="line">b := []<span class="keyword">int</span>{<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>}</span><br><span class="line"><span class="comment">// 两个切片不能比较</span></span><br><span class="line"><span class="keyword">if</span> a == b { <span class="comment">// Invalid operation: a == b (the operator == is not defined on []int)</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 一个切片slice类型只能与nil比较，其他的都不可以</span></span><br><span class="line"><span class="keyword">if</span> a == <span class="literal">nil</span> {</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>slice切片，map,函数，不支持 == != 操作，不可以作为map key的数据类型</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> m1 <span class="keyword">map</span>[[]<span class="keyword">int</span>]<span class="keyword">string</span> <span class="comment">// Invalid map key type []int: comparison operators == and != must be fully defined for the key type</span></span><br><span class="line">m4 := <span class="keyword">map</span>[[]<span class="keyword">string</span>]<span class="keyword">int</span>{} <span class="comment">// invalid map key type []string</span></span><br></pre></td></tr></tbody></table></figure>

<p><code>interface{}</code>把它当作万能类型</p>
<p><code>interface{}</code>类型可以作为value</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mapVariables6 []<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>{}</span><br><span class="line">mapVariables6 = <span class="built_in">make</span>([]<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>{}, <span class="number">2</span>)</span><br><span class="line">mapVariables6[<span class="number">0</span>] = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>{}, <span class="number">2</span>)</span><br><span class="line">mapVariables6[<span class="number">0</span>][<span class="string">"name"</span>] = <span class="string">"波哥"</span></span><br><span class="line">mapVariables6[<span class="number">0</span>][<span class="string">"age"</span>] = <span class="number">18</span></span><br><span class="line"></span><br><span class="line">mapVariables6[<span class="number">1</span>] = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>{}, <span class="number">2</span>)</span><br><span class="line">mapVariables6[<span class="number">1</span>][<span class="string">"name"</span>] = <span class="string">"胡哥"</span></span><br><span class="line">mapVariables6[<span class="number">1</span>][<span class="string">"age"</span>] = <span class="number">16</span></span><br><span class="line"></span><br><span class="line">fmt.Println(mapVariables6)</span><br><span class="line"><span class="comment">// [map[age:18 name:波哥] map[age:16 name:胡哥]]</span></span><br></pre></td></tr></tbody></table></figure>

<p><code>interface{}</code>类型可以作为key，但是需要加入的key的类型是可以比较的</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> m2 <span class="keyword">map</span>[<span class="keyword">interface</span>{}]<span class="keyword">string</span></span><br><span class="line">m2 = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">interface</span>{}]<span class="keyword">string</span>)</span><br><span class="line"><span class="comment">//m2[[]byte("k2")]="v2" // panic: runtime error: hash of unhashable type []uint8</span></span><br><span class="line">m2[<span class="number">123</span>] = <span class="string">"123"</span></span><br><span class="line">m2[<span class="number">12.3</span>] = <span class="string">"123"</span></span><br><span class="line">fmt.Println(m2) <span class="comment">// map[12.3:123 123:123]</span></span><br><span class="line"></span><br><span class="line">c := [<span class="number">3</span>]<span class="keyword">int</span>{<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>}</span><br><span class="line">d := [<span class="number">3</span>]<span class="keyword">int</span>{<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>}</span><br><span class="line"></span><br><span class="line"><span class="comment">//两个数组可以比较</span></span><br><span class="line"><span class="keyword">if</span> c == d {</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">a3 := [<span class="number">3</span>]<span class="keyword">int</span>{<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>}</span><br><span class="line"><span class="keyword">var</span> m3 <span class="keyword">map</span>[[<span class="number">3</span>]<span class="keyword">int</span>]<span class="keyword">string</span></span><br><span class="line">m3 = <span class="built_in">make</span>(<span class="keyword">map</span>[[<span class="number">3</span>]<span class="keyword">int</span>]<span class="keyword">string</span>)</span><br><span class="line">m3[a3] = <span class="string">"m3"</span></span><br><span class="line">fmt.Println(m3) <span class="comment">// map[[1 2 3]:m3]</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="结构体做为map的值"><a href="#结构体做为map的值" class="headerlink" title="结构体做为map的值"></a>结构体做为map的值</h4><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// m4 可以，book1里面的元素都是支持== !=</span></span><br><span class="line"><span class="keyword">type</span> book1 <span class="keyword">struct</span> {</span><br><span class="line">    name <span class="keyword">string</span></span><br><span class="line">}</span><br><span class="line"><span class="keyword">var</span> m4 <span class="keyword">map</span>[book1]<span class="keyword">string</span></span><br><span class="line">fmt.Println(m4) <span class="comment">// map[]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> book2 <span class="keyword">struct</span> {</span><br><span class="line">    name <span class="keyword">string</span></span><br><span class="line">    text []<span class="keyword">byte</span> <span class="comment">// text元素类型为[]byte, 不满足key的要求</span></span><br><span class="line">}</span><br><span class="line"><span class="keyword">var</span> m5 <span class="keyword">map</span>[book2]<span class="keyword">string</span> <span class="comment">// invalid map key type book2: comparison operators == and != must be fully defined for the key type</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> course <span class="keyword">struct</span> {      <span class="comment">// 定义一个结构体变量</span></span><br><span class="line">    courseName    <span class="keyword">string</span>  <span class="comment">// 课程名称</span></span><br><span class="line">    courseTime    <span class="keyword">float32</span> <span class="comment">// 课程时长 单位分钟</span></span><br><span class="line">    courseTeacher <span class="keyword">string</span>  <span class="comment">// 课程讲师</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">couser1 := course{</span><br><span class="line">    <span class="comment">// 不指定结构体字段名的方式，严格按照定义结构体时的顺序</span></span><br><span class="line">    <span class="string">"go语言体系课"</span>, <span class="number">300.3</span>, <span class="string">"波哥"</span>,</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">courser2 := course{ <span class="comment">// 指明字段名</span></span><br><span class="line">    courseTeacher: <span class="string">"胡哥"</span>,</span><br><span class="line">    courseTime:    <span class="number">100.2</span>,</span><br><span class="line">    courseName:    <span class="string">"如何变帅"</span>,</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义map，key为string，value为结构体</span></span><br><span class="line">courser := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]course)</span><br><span class="line">courser[<span class="string">"go"</span>] = couser1</span><br><span class="line">courser[<span class="string">"美容"</span>] = courser2</span><br><span class="line">fmt.Println(courser)</span><br><span class="line"><span class="comment">//map[go:{go语言体系课 300.3 波哥} 美容:{如何变帅 100.2 胡哥}]</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="map的增删改"><a href="#map的增删改" class="headerlink" title="map的增删改"></a>map的增删改</h3><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">m := <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>{</span><br><span class="line">    <span class="string">"a"</span>: <span class="string">"va"</span>,</span><br><span class="line">    <span class="string">"b"</span>: <span class="string">"vb"</span>,</span><br><span class="line">    <span class="string">"d"</span>: <span class="string">""</span>,</span><br><span class="line">}</span><br><span class="line">fmt.Println(<span class="built_in">len</span>(m)) <span class="comment">// 3 获得m中key/value对的个数</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//1. k不存在为增加，k存在为修改</span></span><br><span class="line">m[<span class="string">"c"</span>] = <span class="string">""</span></span><br><span class="line">m[<span class="string">"c"</span>] = <span class="string">"vc"</span> <span class="comment">// 重复增加(key相同)，使用新的值覆盖</span></span><br><span class="line">m[<span class="string">"b"</span>] = <span class="string">"vb1"</span></span><br><span class="line">fmt.Printf(<span class="string">"%v\n"</span>, m)              <span class="comment">// map[a:va b:vb1 c:vc d:]</span></span><br><span class="line">fmt.Printf(<span class="string">"%#v %d\n"</span>, m, <span class="built_in">len</span>(m)) <span class="comment">// map[string]string{"a":"va", "b":"vb1", "c":"vc", "d":""} 4</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 查询，你返回空的字符串到底是没有获取到还是值本身就是这样空字符串呢</span></span><br><span class="line"><span class="comment">// 从m中取键k对应的值给v，如果k在m中不存在，则将value类型的零值赋值给v</span></span><br><span class="line">v := m[<span class="string">"d"</span>]</span><br><span class="line">fmt.Println(v) <span class="comment">//</span></span><br><span class="line"><span class="comment">// 从m中取键k对应的值给v，如果k存在，ok=true,如果k不存在，将value类型的初始零值赋值给v同时ok=false</span></span><br><span class="line">v1, ok := m[<span class="string">"d"</span>]</span><br><span class="line">fmt.Println(v1, ok) <span class="comment">//  true</span></span><br><span class="line">fmt.Printf(<span class="string">"%#v %#v %#v\n"</span>, v, v1, ok) <span class="comment">// "" "" true 空字符串</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ok {</span><br><span class="line">    fmt.Println(<span class="string">"找到了"</span>, v1) <span class="comment">// 找到了</span></span><br><span class="line">} <span class="keyword">else</span> {</span><br><span class="line">    fmt.Println(<span class="string">"没找到"</span>)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> value, ok := m[<span class="string">"b"</span>]; ok {</span><br><span class="line">    fmt.Println(<span class="string">"找到了"</span>, value) <span class="comment">// 找到了 vb1</span></span><br><span class="line">} <span class="keyword">else</span> {</span><br><span class="line">    fmt.Println(<span class="string">"key 'b' does not exist"</span>)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> value, ok := m[<span class="string">"go"</span>]; ok {</span><br><span class="line">    fmt.Println(<span class="string">"找到了"</span>, value)</span><br><span class="line">} <span class="keyword">else</span> {</span><br><span class="line">    fmt.Println(<span class="string">"key 'go' does not exist"</span>) <span class="comment">// key 'go' does not exist</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">u1 := m[<span class="string">"e"</span>]</span><br><span class="line">u2, ok2 := m[<span class="string">"e"</span>]</span><br><span class="line"><span class="keyword">if</span> ok2 {</span><br><span class="line">    fmt.Println(<span class="string">"找到了"</span>, u2)</span><br><span class="line">} <span class="keyword">else</span> {</span><br><span class="line">    fmt.Println(<span class="string">"没找到"</span>) <span class="comment">// 没找到</span></span><br><span class="line">}</span><br><span class="line">fmt.Println(u2, ok2)                     <span class="comment">//  false</span></span><br><span class="line">fmt.Printf(<span class="string">"%v %v %v\n"</span>, u1, u2, ok2)    <span class="comment">//   false</span></span><br><span class="line">fmt.Printf(<span class="string">"%#v %#v %#v\n"</span>, u1, u2, ok2) <span class="comment">// "" "" false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除</span></span><br><span class="line"><span class="comment">// 使用内置函数delete(m, k) 将k以及k对应的v从m中删掉；如果k不在m中，不执行任何操作</span></span><br><span class="line"><span class="built_in">delete</span>(m, <span class="string">"a"</span>)        <span class="comment">// 删除存在的key</span></span><br><span class="line"><span class="built_in">delete</span>(m, <span class="string">"e"</span>)        <span class="comment">// 删除不存在的key，原m不影响，不会抛出异常</span></span><br><span class="line">fmt.Printf(<span class="string">"%v\n"</span>, m) <span class="comment">// map[b:vb1 c:vc d:]</span></span><br><span class="line">fmt.Printf(<span class="string">"%#v %d\n"</span>, m, <span class="built_in">len</span>(m)) <span class="comment">//map[string]string{"b":"vb1", "c":"vc", "d":""} 3</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">delete</span>(m, <span class="string">"a"</span>)                     <span class="comment">// 重复删除已经删除后不存在的不会抛出异常，m无影响</span></span><br><span class="line">fmt.Printf(<span class="string">"%v\n"</span>, m)              <span class="comment">// map[b:vb1 c:vc d:]</span></span><br><span class="line">fmt.Printf(<span class="string">"%#v %d\n"</span>, m, <span class="built_in">len</span>(m)) <span class="comment">// map[string]string{"b":"vb1", "c":"vc", "d":""} 3</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">changeMap</span><span class="params">(mapVariables <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">int</span>)</span></span> {</span><br><span class="line">    mapVariables[<span class="string">"Monday"</span>] = <span class="number">888</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">    <span class="comment">//map是一个引用</span></span><br><span class="line">    fmt.Printf(<span class="string">"mapVariables3['Monday']在调用函数之前的值:%v\n"</span>, mapVariables3[<span class="string">"Monday"</span>])</span><br><span class="line">    <span class="comment">// mapVariables3['Monday']在调用函数之前的值:1</span></span><br><span class="line">    changeMap(mapVariables3)</span><br><span class="line">    fmt.Printf(<span class="string">"mapVariables3['Monday']在调用函数之后的值:%v\n"</span>, mapVariables3[<span class="string">"Monday"</span>])</span><br><span class="line">    <span class="comment">// mapVariables3['Monday']在调用函数之后的值:888</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="map的遍历"><a href="#map的遍历" class="headerlink" title="map的遍历"></a>map的遍历</h3><ul>
<li>遍历的顺序是随机无序的</li>
<li>使用for range遍历的时候，k,v使用的同一块内存，这也是容易出现错误的地方</li>
</ul>
<p>如何来对map的key进行有顺序输出, for range<br>如何排序<br>1.定义切片存储所有的key<br>2.通过排序算法（排序算法使用内置或者冒泡，选择等排序算法均可）对key进行排序<br>3.按照排序后的key打印map</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Strings sorts a slice of strings in increasing order.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Strings</span><span class="params">(x []<span class="keyword">string</span>)</span></span> { Sort(StringSlice(x)) }</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"sort"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> sortKeys []<span class="keyword">string</span></span><br><span class="line">    <span class="keyword">for</span> key := <span class="keyword">range</span> mapVariables3 { <span class="comment">// 每此运行都是随机，key无序的</span></span><br><span class="line">        sortKeys = <span class="built_in">append</span>(sortKeys, key) <span class="comment">// 每此运行都是随机，加入到切片的key无序的</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    fmt.Printf(<span class="string">"排序前sortkeys的值=%v\n"</span>, sortKeys)</span><br><span class="line">    <span class="comment">// 排序前sortkeys的值=[Monday Tuesday Wednesday] 无序的，每此运行都是随机</span></span><br><span class="line"></span><br><span class="line">    sort.Strings(sortKeys) <span class="comment">// 自带的排序</span></span><br><span class="line">    fmt.Printf(<span class="string">"排序后sortkeys的值=%v\n"</span>, sortKeys)</span><br><span class="line">    <span class="comment">// 排序后sortkeys的值=[Monday Tuesday Wednesday]</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(sortKeys); i++ {</span><br><span class="line">        fmt.Printf(<span class="string">"mapVariables3[%s]=%d\n"</span>, sortKeys[i], mapVariables3[sortKeys[i]])</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// mapVariables3[Monday]=888</span></span><br><span class="line">    <span class="comment">// mapVariables3[Tuesday]=2</span></span><br><span class="line">    <span class="comment">// mapVariables3[Wednesday]=3</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> key, value := <span class="keyword">range</span> mapVariables3 {</span><br><span class="line">        fmt.Println(key, value)</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// Monday 888</span></span><br><span class="line">    <span class="comment">// Tuesday 2</span></span><br><span class="line">    <span class="comment">// Wednesday 3</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="map遍历易错点举例"><a href="#map遍历易错点举例" class="headerlink" title="map遍历易错点举例"></a>map遍历易错点举例</h3><p>由于遍历的时候，遍历v使用的同一块地址，同时这块地址是临时分配的。虽然v的地址没有变化，但v的内容在一直变化，当遍历完成后，v的内容是map遍历时最后遍历的元素的值(map遍历无序，每次不确定哪个元素是最后一个元素)。当程序将v的地址放入到slice中的时候，slice在不断地v的地址插入，由于v一直是那块地址，因此slice中的每个元素记录的都是v的地址。因此当打印slice中的内容的时候，都是同一个值</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">m := <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">int</span>{</span><br><span class="line">    <span class="string">"a"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">"b"</span>: <span class="number">2</span>,</span><br><span class="line">}</span><br><span class="line"><span class="keyword">var</span> bs []*<span class="keyword">int</span></span><br><span class="line"><span class="keyword">for</span> k, v := <span class="keyword">range</span> m {</span><br><span class="line">    fmt.Printf(<span class="string">"k:[%p].v:[%p]\n"</span>, &amp;k, &amp;v) <span class="comment">// 这里的输出可以看到，k一直使用同一块内存，v也是这个状况</span></span><br><span class="line">    bs = <span class="built_in">append</span>(bs, &amp;v) <span class="comment">// 对v取地址</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _, b := <span class="keyword">range</span> bs {</span><br><span class="line">    fmt.Println(*b) <span class="comment">// 输出都是1或者都是2</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>go语言中也有一个list 就是数据结构中提到的链表，不需要连续的内存<br>为什么指针在java python等很多语言中不存在</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/07/03/go-wen-jian/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/07/03/go-wen-jian/" class="post-title-link" itemprop="url">go文件</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-07-02 16:21:41" itemprop="dateCreated datePublished" datetime="2021-07-02T16:21:41Z">2021-07-02</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-08-09 12:15:32" itemprop="dateModified" datetime="2021-08-09T12:15:32Z">2021-08-09</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Open opens the named file for reading. If successful, methods on</span></span><br><span class="line"><span class="comment">// the returned file can be used for reading; the associated file</span></span><br><span class="line"><span class="comment">// descriptor has mode O_RDONLY.</span></span><br><span class="line"><span class="comment">// If there is an error, it will be of type *PathError.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Open</span><span class="params">(name <span class="keyword">string</span>)</span> <span class="params">(*File, error)</span></span> {</span><br><span class="line">    <span class="keyword">return</span> OpenFile(name, O_RDONLY, <span class="number">0</span>)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// File represents an open file descriptor.</span></span><br><span class="line"><span class="keyword">type</span> File <span class="keyword">struct</span> {</span><br><span class="line">    *file <span class="comment">// os specific</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// Read reads up to len(b) bytes from the File.</span></span><br><span class="line"><span class="comment">// It returns the number of bytes read and any error encountered.</span></span><br><span class="line"><span class="comment">// At end of file, Read returns 0, io.EOF.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *File)</span> <span class="title">Read</span><span class="params">(b []<span class="keyword">byte</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> {</span><br><span class="line">    <span class="keyword">if</span> err := f.checkValid(<span class="string">"read"</span>); err != <span class="literal">nil</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>, err</span><br><span class="line">    }</span><br><span class="line">    n, e := f.read(b)</span><br><span class="line">    <span class="keyword">return</span> n, f.wrapErr(<span class="string">"read"</span>, e)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// Write writes len(b) bytes to the File.</span></span><br><span class="line"><span class="comment">// It returns the number of bytes written and an error, if any.</span></span><br><span class="line"><span class="comment">// Write returns a non-nil error when n != len(b).</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *File)</span> <span class="title">Write</span><span class="params">(b []<span class="keyword">byte</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> {</span><br><span class="line">    <span class="keyword">if</span> err := f.checkValid(<span class="string">"write"</span>); err != <span class="literal">nil</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>, err</span><br><span class="line">    }</span><br><span class="line">    n, e := f.write(b)</span><br><span class="line">    <span class="keyword">if</span> n &lt; <span class="number">0</span> {</span><br><span class="line">        n = <span class="number">0</span></span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> n != <span class="built_in">len</span>(b) {</span><br><span class="line">        err = io.ErrShortWrite</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    epipecheck(f, e)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> e != <span class="literal">nil</span> {</span><br><span class="line">        err = f.wrapErr(<span class="string">"write"</span>, e)</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> n, err</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/07/02/go-qie-pian/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/07/02/go-qie-pian/" class="post-title-link" itemprop="url">go切片</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-07-01 16:21:41" itemprop="dateCreated datePublished" datetime="2021-07-01T16:21:41Z">2021-07-01</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-08-06 03:01:32" itemprop="dateModified" datetime="2021-08-06T03:01:32Z">2021-08-06</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="切片"><a href="#切片" class="headerlink" title="切片"></a>切片</h2><p>Go 数组的长度不可改变，在特定场景中这样的集合就不太适用，</p>
<p>数组的传递是值传递<br>Go中提供了一种灵活，功能强悍的内置类型切片</p>
<ol>
<li>一种数据结构，便于处理同类型数据集合序列提供一个方便而高效的方式。</li>
<li>与数组相比，切片动态数组，</li>
<li>长度是不固定的，按需自动增长，通过append来可以追加元素</li>
<li>本身不存值、没有数据，指向底层数组的指针，是对底层array的一个view，如果是基于数组产生的 进行的操作会影响原来的数组。</li>
<li>内存当中是连续的存储空间，可以有效的提升cpu的执行效率。</li>
<li>引用类型，引用传递，同一块内存，做为函数参数，形参的值会改变实参数的值</li>
<li>go的slice更像是python的list，python的list底层也是基于数组实现的</li>
<li>当数据类型数据较大时，使用切片可以有效减少内存占用，提高程序执行效率</li>
</ol>
<ul>
<li>ptr 指向数组中切片第一个元素的指针</li>
<li>切片元素的长度，通过<code>len()</code>获取</li>
<li>容量，底层数组的长度减去初始位置，通过<code>cap()</code>获取</li>
</ul>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The len built-in function returns the length of v, according to its type:</span></span><br><span class="line"><span class="comment">//    Array: the number of elements in v.</span></span><br><span class="line"><span class="comment">//    Pointer to array: the number of elements in *v (even if v is nil).</span></span><br><span class="line"><span class="comment">//    Slice, or map: the number of elements in v; if v is nil, len(v) is zero.</span></span><br><span class="line"><span class="comment">//    String: the number of bytes in v.</span></span><br><span class="line"><span class="comment">//    Channel: the number of elements queued (unread) in the channel buffer;</span></span><br><span class="line"><span class="comment">//             if v is nil, len(v) is zero.</span></span><br><span class="line"><span class="comment">// For some arguments, such as a string literal or a simple array expression, the</span></span><br><span class="line"><span class="comment">// result can be a constant. See the Go language specification's "Length and</span></span><br><span class="line"><span class="comment">// capacity" section for details.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">len</span><span class="params">(v Type)</span> <span class="title">int</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// The cap built-in function returns the capacity of v, according to its type:</span></span><br><span class="line"><span class="comment">//    Array: the number of elements in v (same as len(v)).</span></span><br><span class="line"><span class="comment">//    Pointer to array: the number of elements in *v (same as len(v)).</span></span><br><span class="line"><span class="comment">//    Slice: the maximum length the slice can reach when resliced;</span></span><br><span class="line"><span class="comment">//    if v is nil, cap(v) is zero.</span></span><br><span class="line"><span class="comment">//    Channel: the channel buffer capacity, in units of elements;</span></span><br><span class="line"><span class="comment">//    if v is nil, cap(v) is zero.</span></span><br><span class="line"><span class="comment">// For some arguments, such as a simple array expression, the result can be a</span></span><br><span class="line"><span class="comment">// constant. See the Go language specification's "Length and capacity" section for</span></span><br><span class="line"><span class="comment">// details.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">cap</span><span class="params">(v Type)</span> <span class="title">int</span></span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h3><p>从数据库表中读取商品信息时，用到map切片，每一个map看成一个整体</p>
<h3 id="定义切片初始化"><a href="#定义切片初始化" class="headerlink" title="定义切片初始化"></a>定义切片初始化</h3><p>直接初始化创建切片 slice 的方式有以下几种：<br>  方式                            代码示例<br>直接声明                           <code>var slice []int</code><br>new                              <code>slice := *new([]int)</code><br>字面量 []Type{}                   <code>slice := []int{1, 2, 3, 4, 5}</code><br>make([]Type, length, capacity)   <code>slice := make([]int, 5, 10)</code><br>从切片或数组“截取”引用               <code>slice := array[:]</code>或 <code>slice := sourceSlice[1:5]</code></p>
<p>第一种方法： var identifier []type</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> c []<span class="keyword">string</span>      <span class="comment">// 定义了一个切片</span></span><br><span class="line">fmt.Printf(<span class="string">"%v %T %d %d\n"</span>, c, c, <span class="built_in">len</span>(c), <span class="built_in">cap</span>(c)) <span class="comment">// [] []string 0 0</span></span><br><span class="line"></span><br><span class="line">c1 := []<span class="keyword">string</span>{}      <span class="comment">// 定义了一个切片</span></span><br><span class="line">fmt.Printf(<span class="string">"%v %T %d %d\n"</span>, c1, c1, <span class="built_in">len</span>(c1), <span class="built_in">cap</span>(c1)) <span class="comment">// [] []string 0 0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> c2 = []<span class="keyword">string</span>{<span class="string">"django"</span>, <span class="string">"scrapy"</span>, <span class="string">"tornado"</span>}</span><br><span class="line">fmt.Printf(<span class="string">"%v %T %d %d\n"</span>, c2, c2, <span class="built_in">len</span>(c2), <span class="built_in">cap</span>(c2)) <span class="comment">// [django scrapy tornado] []string 3 3</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="第二种-使用make"><a href="#第二种-使用make" class="headerlink" title="第二种 使用make"></a>第二种 使用make</h4><p>切片不是没有长度限制，为什么使用make初始化的需要我们传递一个长度，<br>那我传递了长度之后是不是意味着就像数组一样长度不能变了呢？</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The make built-in function allocates and initializes an object of type</span></span><br><span class="line"><span class="comment">// slice, map, or chan (only). Like new, the first argument is a type, not a</span></span><br><span class="line"><span class="comment">// value. Unlike new, make's return type is the same as the type of its</span></span><br><span class="line"><span class="comment">// argument, not a pointer to it. The specification of the result depends on</span></span><br><span class="line"><span class="comment">// the type:</span></span><br><span class="line"><span class="comment">//    Slice: The size specifies the length. The capacity of the slice is</span></span><br><span class="line"><span class="comment">//    equal to its length. A second integer argument may be provided to</span></span><br><span class="line"><span class="comment">//    specify a different capacity; it must be no smaller than the</span></span><br><span class="line"><span class="comment">//    length. For example, make([]int, 0, 10) allocates an underlying array</span></span><br><span class="line"><span class="comment">//    of size 10 and returns a slice of length 0 and capacity 10 that is</span></span><br><span class="line"><span class="comment">//    backed by this underlying array.</span></span><br><span class="line"><span class="comment">//    Map: An empty map is allocated with enough space to hold the</span></span><br><span class="line"><span class="comment">//    specified number of elements. The size may be omitted, in which case</span></span><br><span class="line"><span class="comment">//    a small starting size is allocated.</span></span><br><span class="line"><span class="comment">//    Channel: The channel's buffer is initialized with the specified</span></span><br><span class="line"><span class="comment">//    buffer capacity. If zero, or the size is omitted, the channel is</span></span><br><span class="line"><span class="comment">//    unbuffered.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">make</span><span class="params">(t Type, size ...IntegerType)</span> <span class="title">Type</span></span></span><br></pre></td></tr></tbody></table></figure>

<p>make方法初始化创建切片，这种方式可以指定切片的长度和容量。如果没有指定容量不会有多余的预留空间</p>
<p>这种方式切片对应的数组不可见，由make来维护<br>make 用来分配内存主要用来分配引用类型，比如channel, map, slice，返回一个有初始值 (非零) 的 T 类型，不是T类型</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">d := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">0</span>)</span><br><span class="line">fmt.Printf(<span class="string">"len=%d, cap=%d\n"</span>, <span class="built_in">len</span>(d), <span class="built_in">cap</span>(d)) <span class="comment">// len=0, cap=0</span></span><br><span class="line"></span><br><span class="line">a := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">5</span>)</span><br><span class="line">fmt.Println(<span class="string">"%T %v"</span>, a, a) <span class="comment">// []int [0 0 0 0 0]</span></span><br><span class="line">fmt.Printf(<span class="string">"len=%d, cap=%d\n"</span>, <span class="built_in">len</span>(a), <span class="built_in">cap</span>(a)) <span class="comment">// len=5, cap=5</span></span><br><span class="line"></span><br><span class="line">b := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">5</span>, <span class="number">3</span>) <span class="comment">// len larger than cap in make([]int)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建一个初始元素个数为 5 的数组切片，元素初始值为 0，并预留 6 个元素的存储空间</span></span><br><span class="line">c := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">5</span>, <span class="number">6</span>)</span><br><span class="line">fmt.Println(c) <span class="comment">// [0 0 0 0 0]</span></span><br><span class="line">fmt.Printf(<span class="string">"c的长度=%d，容量=%d\n"</span>, <span class="built_in">len</span>(c), <span class="built_in">cap</span>(c)) <span class="comment">// c的长度=5，容量=6</span></span><br><span class="line">fmt.Printf(<span class="string">"切片指向的底层数组的地址=%p，切片自己的地址=%p\n"</span>, c, &amp;c)</span><br><span class="line"><span class="comment">// 切片指向的底层数组的地址=0xc00000c3f0，切片自己的地址=0xc000004078</span></span><br><span class="line"></span><br><span class="line">courses := <span class="built_in">make</span>([]<span class="keyword">string</span>, <span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">fmt.Printf(<span class="string">"%T %v"</span>, courses, courses)            <span class="comment">// []string [    ]</span></span><br><span class="line">fmt.Println(courses, <span class="built_in">len</span>(courses), <span class="built_in">cap</span>(courses)) <span class="comment">// [    ] 5 5</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="第三种，通过对数组操作返回一个切片"><a href="#第三种，通过对数组操作返回一个切片" class="headerlink" title="第三种，通过对数组操作返回一个切片"></a>第三种，通过对数组操作返回一个切片</h4><p>python中的用法叫切片，非常的多灵活，<code>[:-1]</code> <code>[::-1]</code> go都不能用<br>go语言中切片是一种数据结构</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// course := [5]string{"django", "tornado", "scrapy", "python", "asyncio"}</span></span><br><span class="line"><span class="keyword">var</span> courses = [<span class="number">5</span>]<span class="keyword">string</span>{<span class="string">"django"</span>, <span class="string">"scrapy"</span>, <span class="string">"tornado"</span>, <span class="string">"python"</span>, <span class="string">"asyncio"</span>}</span><br><span class="line">fullCourses := courses[:]</span><br><span class="line">fmt.Println(fullCourses)        <span class="comment">// [django scrapy tornado python asyncio]</span></span><br><span class="line">subCourse := courses[<span class="number">1</span>:<span class="number">4</span>]</span><br><span class="line">fmt.Println(subCourse)        <span class="comment">// [scrapy tornado python]</span></span><br><span class="line">subCourse[<span class="number">0</span>] = <span class="string">"bobby"</span>      <span class="comment">// 修改切片，引用传递，原数组会变,python 浅拷贝不可变元素不变</span></span><br><span class="line">fmt.Println(courses)        <span class="comment">// [django bobby tornado python asyncio]</span></span><br><span class="line">fmt.Println(subCourse)      <span class="comment">// [bobby tornado python]</span></span><br><span class="line">fmt.Printf(<span class="string">"%T"</span>, subCourse) <span class="comment">// []string</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">updateSlice</span><span class="params">(s []<span class="keyword">int</span>)</span></span> {</span><br><span class="line">    s[<span class="number">0</span>] = <span class="number">100</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    arr := [...]<span class="keyword">int</span>{<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>}</span><br><span class="line"></span><br><span class="line">    fmt.Println(<span class="string">"arr[2:6] ="</span>, arr[<span class="number">2</span>:<span class="number">6</span>]) <span class="comment">// arr[2:6] = [2 3 4 5]</span></span><br><span class="line">    s2 := arr[:]</span><br><span class="line">    fmt.Println(<span class="string">"arr[:6] ="</span>, arr[:<span class="number">6</span>]) <span class="comment">// arr[:6] = [0 1 2 3 4 5]</span></span><br><span class="line">    s1 := arr[<span class="number">2</span>:]</span><br><span class="line">    fmt.Println(<span class="string">"s1 ="</span>, s1) <span class="comment">// s1 = [2 3 4 5 6 7]</span></span><br><span class="line">    s2 := arr[:]</span><br><span class="line">    fmt.Println(<span class="string">"s2 ="</span>, s2) <span class="comment">// s2 = [0 1 2 3 4 5 6 7]</span></span><br><span class="line"></span><br><span class="line">    fmt.Println(<span class="string">"After updateSlice(s1)"</span>)</span><br><span class="line">    updateSlice(s1)</span><br><span class="line">    fmt.Println(s1) <span class="comment">// [100 3 4 5 6 7]</span></span><br><span class="line">    fmt.Println(arr) <span class="comment">// [0 1 100 3 4 5 6 7]</span></span><br><span class="line"></span><br><span class="line">    fmt.Println(<span class="string">"After updateSlice(s2)"</span>)</span><br><span class="line">    updateSlice(s2)</span><br><span class="line">    fmt.Println(s2) <span class="comment">// [100 1 100 3 4 5 6 7]</span></span><br><span class="line">    fmt.Println(arr) <span class="comment">// [100 1 100 3 4 5 6 7]</span></span><br><span class="line"></span><br><span class="line">    fmt.Println(<span class="string">"Reslice"</span>)</span><br><span class="line">    s2 = s2[:<span class="number">5</span>]</span><br><span class="line">    fmt.Println(s2) <span class="comment">// [100 1 100 3 4]</span></span><br><span class="line">    s2 = s2[<span class="number">2</span>:]</span><br><span class="line">    fmt.Println(s2) <span class="comment">// [100 3 4]</span></span><br></pre></td></tr></tbody></table></figure>

<p>slice 可以向后扩展，不可以向前扩展，s1本身没有s1[4]和s2[5]，但是底层的数组有<br>reslice 向后扩展不可以超越底层数组 cap(s) 长度<br>s[i] 不能超过len(s)的长度<br>一个切片s可以扩展到他的大小上限：s = s[:cap(s)], 如果再扩大的话就会报运行时错误</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">    arr := [...]<span class="keyword">int</span>{<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>}</span><br><span class="line">    fmt.Println(<span class="string">"arr ="</span>, arr) <span class="comment">// arr = [0 1 2 3 4 5 6 7]</span></span><br><span class="line">    s1 = arr[<span class="number">2</span>:<span class="number">6</span>]</span><br><span class="line">    fmt.Printf(<span class="string">"s1=%v, len(s1)=%d, cap(s1)=%d\n"</span>, s1, <span class="built_in">len</span>(s1), <span class="built_in">cap</span>(s1))</span><br><span class="line">    <span class="comment">//s1=[2 3 4 5], len(s1)=4, cap(s1)=6=8-2</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//fmt.Println(s1[4]) // panic: runtime error: index out of range [4] with length 4</span></span><br><span class="line"></span><br><span class="line">    s2 = s1[<span class="number">3</span>:<span class="number">5</span>] <span class="comment">// [s1[3], s1[4]]</span></span><br><span class="line">    fmt.Printf(<span class="string">"s2=%v, len(s2)=%d, cap(s2)=%d\n"</span>, s2, <span class="built_in">len</span>(s2), <span class="built_in">cap</span>(s2))</span><br><span class="line">    <span class="comment">//s2=[5 6], len(s2)=2, cap(s2)=3=8-5 s1本身没有s1[4]，但是底层的数组有</span></span><br><span class="line"></span><br><span class="line">    s6 := s1[<span class="number">3</span>:<span class="number">6</span>]</span><br><span class="line">    fmt.Printf(<span class="string">"s6=%v, len(s6)=%d, cap(s6)=%d\n"</span>, s6, <span class="built_in">len</span>(s6), <span class="built_in">cap</span>(s6))</span><br><span class="line">    <span class="comment">// s6=[5 6 7], len(s6)=3, cap(s6)=3=8-5 s1本身没有s1[4]和s2[5]，但是底层的数组有</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// s7 := s1[3:7]</span></span><br><span class="line">    <span class="comment">//fmt.Println(s7)</span></span><br><span class="line">    <span class="comment">// panic: runtime error: slice bounds out of range [:7] with capacity 6</span></span><br><span class="line">    <span class="comment">// fmt.Printf("s7=%v, len(s7)=%d, cap(s7)=%d\n", s7, len(s7), cap(s7))</span></span><br><span class="line">    <span class="comment">// panic: runtime error: slice bounds out of range [:7] with capacity 6</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">    arrayVariables := [...]<span class="keyword">int</span>{<span class="number">12</span>, <span class="number">21</span>, <span class="number">23</span>, <span class="number">55</span>, <span class="number">98</span>, <span class="number">2</span>} <span class="comment">// 数组</span></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(arrayVariables); i++ {</span><br><span class="line">        fmt.Printf(<span class="string">"arrayVariables[%d]=%d,地址=%p\n"</span>, i, arrayVariables[i], &amp;arrayVariables[i])</span><br><span class="line">    }</span><br><span class="line">---</span><br><span class="line">arrayVariables[<span class="number">0</span>]=<span class="number">12</span>,地址=<span class="number">0xc00000c3f0</span></span><br><span class="line">arrayVariables[<span class="number">1</span>]=<span class="number">21</span>,地址=<span class="number">0xc00000c3f8</span></span><br><span class="line">arrayVariables[<span class="number">2</span>]=<span class="number">23</span>,地址=<span class="number">0xc00000c400</span></span><br><span class="line">arrayVariables[<span class="number">3</span>]=<span class="number">55</span>,地址=<span class="number">0xc00000c408</span></span><br><span class="line">arrayVariables[<span class="number">4</span>]=<span class="number">98</span>,地址=<span class="number">0xc00000c410</span></span><br><span class="line">arrayVariables[<span class="number">5</span>]=<span class="number">2</span>,地址=<span class="number">0xc00000c418</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">var</span> sliceVariables []<span class="keyword">int</span> <span class="comment">// 切片</span></span><br><span class="line">    arrayVariables := [...]<span class="keyword">int</span>{<span class="number">12</span>, <span class="number">21</span>, <span class="number">23</span>, <span class="number">55</span>, <span class="number">98</span>, <span class="number">2</span>} <span class="comment">// 数组</span></span><br><span class="line"></span><br><span class="line">    sliceVariables = arrayVariables[:] <span class="comment">// 切片去引用数组</span></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(sliceVariables); i++ {</span><br><span class="line">        fmt.Printf(<span class="string">"sliceVariables[%d]=%d,地址=%p\n"</span>, i, sliceVariables[i], &amp;sliceVariables[i])</span><br><span class="line">    }</span><br><span class="line">---</span><br><span class="line">sliceVariables[<span class="number">0</span>]=<span class="number">12</span>,地址=<span class="number">0xc00000c3f0</span></span><br><span class="line">sliceVariables[<span class="number">1</span>]=<span class="number">21</span>,地址=<span class="number">0xc00000c3f8</span></span><br><span class="line">sliceVariables[<span class="number">2</span>]=<span class="number">23</span>,地址=<span class="number">0xc00000c400</span></span><br><span class="line">sliceVariables[<span class="number">3</span>]=<span class="number">55</span>,地址=<span class="number">0xc00000c408</span></span><br><span class="line">sliceVariables[<span class="number">4</span>]=<span class="number">98</span>,地址=<span class="number">0xc00000c410</span></span><br><span class="line">sliceVariables[<span class="number">5</span>]=<span class="number">2</span>,地址=<span class="number">0xc00000c418</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> sliceVariables2 []<span class="keyword">int</span></span><br><span class="line">sliceVariables2 = arrayVariables[<span class="number">1</span>:<span class="number">3</span>] <span class="comment">// 从slice中获取slice</span></span><br><span class="line">fmt.Println(sliceVariables2) <span class="comment">// [21 23]</span></span><br><span class="line">fmt.Printf(<span class="string">"len=%d, cap=%d\n"</span>, <span class="built_in">len</span>(sliceVariables2), <span class="built_in">cap</span>(sliceVariables2)) <span class="comment">// len=2, cap=5=6-1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 切片指向的是底层的数组</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(sliceVariables2); i++ {</span><br><span class="line">    fmt.Printf(<span class="string">"sliceVariables2[%d]=%d,地址=%p\n"</span>, i, sliceVariables2[i], &amp;sliceVariables2[i])</span><br><span class="line">    <span class="comment">//sliceVariables2[0]=21,地址=0xc00000c3f8</span></span><br><span class="line">    <span class="comment">//sliceVariables2[1]=23,地址=0xc00000c400</span></span><br><span class="line">}</span><br><span class="line">sliceVariables2[<span class="number">0</span>] = <span class="number">100</span></span><br><span class="line"></span><br><span class="line">fmt.Println(arrayVariables)  <span class="comment">// [12 100 23 55 98 2] 原数组会变</span></span><br><span class="line">fmt.Println(sliceVariables2) <span class="comment">// [100 23]</span></span><br></pre></td></tr></tbody></table></figure>

<p>通过数组取切片</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">data := [<span class="number">10</span>]<span class="keyword">int</span>{<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>}</span><br><span class="line">slice := data[<span class="number">2</span>:<span class="number">4</span>]</span><br><span class="line">newSlice := data[<span class="number">3</span>:<span class="number">6</span>]</span><br><span class="line"><span class="keyword">for</span> index, value := <span class="keyword">range</span> slice {</span><br><span class="line">    fmt.Println(index, value)</span><br><span class="line">}</span><br><span class="line"><span class="comment">//0 2</span></span><br><span class="line"><span class="comment">//1 3</span></span><br><span class="line">fmt.Printf(<span class="string">"len=%d, cap=%d\n"</span>, <span class="built_in">len</span>(slice), <span class="built_in">cap</span>(slice))       <span class="comment">// len=2, cap=8=10-2</span></span><br><span class="line">fmt.Printf(<span class="string">"len=%d, cap=%d\n"</span>, <span class="built_in">len</span>(newSlice), <span class="built_in">cap</span>(newSlice)) <span class="comment">// len=3, cap=7=10-3</span></span><br></pre></td></tr></tbody></table></figure>

<p>第四种方式： new</p>
<p>new 用于各种类型的内存分配 返回的是指针,var variables = new(T)<br>返回的是T，指针类型，即返回的是一个地址，默认是当前类型的零值，指向新分配的类型 T 的零值。</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The new built-in function allocates memory. The first argument is a type,</span></span><br><span class="line"><span class="comment">// not a value, and the value returned is a pointer to a newly</span></span><br><span class="line"><span class="comment">// allocated zero value of that type.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">new</span><span class="params">(Type)</span> *<span class="title">Type</span></span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">subCourse2 := <span class="built_in">new</span>([]<span class="keyword">int</span>)</span><br><span class="line">fmt.Println(subCourse2) <span class="comment">// &amp;[]</span></span><br><span class="line">subCourse3 := *<span class="built_in">new</span>([]<span class="keyword">int</span>)</span><br><span class="line">fmt.Println(subCourse3) <span class="comment">// []</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The append built-in function appends elements to the end of a slice. If</span></span><br><span class="line"><span class="comment">// it has sufficient capacity, the destination is resliced to accommodate the</span></span><br><span class="line"><span class="comment">// new elements. If it does not, a new underlying array will be allocated.</span></span><br><span class="line"><span class="comment">// Append returns the updated slice. It is therefore necessary to store the</span></span><br><span class="line"><span class="comment">// result of append, often in the variable holding the slice itself:</span></span><br><span class="line"><span class="comment">//    slice = append(slice, elem1, elem2)</span></span><br><span class="line"><span class="comment">//    slice = append(slice, anotherSlice...)</span></span><br><span class="line"><span class="comment">// As a special case, it is legal to append a string to a byte slice, like this:</span></span><br><span class="line"><span class="comment">//    slice = append([]byte("hello "), "world"...)</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">append</span><span class="params">(slice []Type, elems ...Type)</span> []<span class="title">Type</span></span></span><br></pre></td></tr></tbody></table></figure>

<p>append 函数的参数长度可变，因此可以追加多个值到 slice 中，还可以用 <code>...</code> 传入 slice，直接追加一个切片。</p>
<p>append函数返回值是一个新的slice，Go编译器不允许调用了 append 函数后不使用返回值。<br>由于值传递的关系，必须接收 append 的返回值</p>
<p>为什么append函数之后再调用<code>c[0] = 8</code>不会影响到原来的数组<br>使用 append 可以向 slice 追加元素，实际上是往底层数组添加元素。<br>但是底层数组的长度是固定的，如果索引 len-1 所指向的元素已经是底层数组的最后一个元素，<br>追加切片的容量如果超出了cap，产生了扩容机制，<br>go语言会新申请一块内存分配更大的底层数组将原始数据拷贝到新的内存当中，<br>切片指向新的内存空间地址，修改新切片不影响原来地址的数组<br>新底层数组的长度也会增加，这样就可以放置新增的元素。同时，为了应对未来可能再次发生的 append 操作，新的底层数组的长度，也就是新 slice 的容量是留了一定的 buffer 的。否则，每次添加元素的时候，都会发生迁移，成本太高。</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> sliceVariables3 []<span class="keyword">int</span> = <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">5</span>, <span class="number">6</span>)</span><br><span class="line">fmt.Printf(<span class="string">"sliceVariables3的长度=%d，容量=%d\n"</span>, <span class="built_in">len</span>(sliceVariables3), <span class="built_in">cap</span>(sliceVariables3))</span><br><span class="line"><span class="comment">//sliceVariables3的长度=5，容量=6</span></span><br><span class="line">fmt.Printf(<span class="string">"切片指向的底层数组的地址=%p，切片自己的地址=%p\n"</span>, sliceVariables3, &amp;sliceVariables3)</span><br><span class="line"><span class="comment">//切片指向的底层数组的地址=0xc00000c450，切片自己的地址=0xc0000040a8</span></span><br><span class="line"></span><br><span class="line">sliceVariables3 = <span class="built_in">append</span>(sliceVariables3, <span class="number">7</span>)</span><br><span class="line">fmt.Println(sliceVariables3) <span class="comment">// [0 0 0 0 0 7]  对于很多初学者来说我们期望的是只有一个数字就是7</span></span><br><span class="line">fmt.Printf(<span class="string">"第一次追加sliceVariables3的长度=%d，容量=%d\n"</span>, <span class="built_in">len</span>(sliceVariables3), <span class="built_in">cap</span>(sliceVariables3))</span><br><span class="line"><span class="comment">//第一次追加sliceVariables3的长度=6，容量=6</span></span><br><span class="line">fmt.Printf(<span class="string">"切片指向的底层数组的地址=%p，切片自己的地址=%p\n"</span>, sliceVariables3, &amp;sliceVariables3)</span><br><span class="line"><span class="comment">//切片指向的底层数组的地址=0xc00000c450，切片自己的地址=0xc0000040a8</span></span><br><span class="line"></span><br><span class="line">sliceVariables3 = <span class="built_in">append</span>(sliceVariables3, <span class="number">8</span>)</span><br><span class="line">fmt.Println(sliceVariables3) <span class="comment">// [0 0 0 0 0 7 8]</span></span><br><span class="line">fmt.Printf(<span class="string">"第二次追加sliceVariables3的长度=%d，容量=%d,\n"</span>, <span class="built_in">len</span>(sliceVariables3), <span class="built_in">cap</span>(sliceVariables3))</span><br><span class="line"><span class="comment">//第二次追加sliceVariables3的长度=7，容量=12</span></span><br><span class="line">fmt.Printf(<span class="string">"切片指向的底层数组的地址=%p，切片自己的地址=%p\n"</span>, sliceVariables3, &amp;sliceVariables3)</span><br><span class="line"><span class="comment">//切片指向的底层数组的地址=0xc000050060，切片自己的地址=0xc0000040a8</span></span><br><span class="line"></span><br><span class="line">sliceVariables3 = <span class="built_in">append</span>(sliceVariables3, <span class="number">9</span>, <span class="number">10</span>)</span><br><span class="line">fmt.Println(sliceVariables3) <span class="comment">// [0 0 0 0 0 7 8]</span></span><br><span class="line">fmt.Printf(<span class="string">"第三次追加sliceVariables3的长度=%d，容量=%d,\n"</span>, <span class="built_in">len</span>(sliceVariables3), <span class="built_in">cap</span>(sliceVariables3))</span><br><span class="line"><span class="comment">//第三次追加sliceVariables3的长度=9，容量=12</span></span><br><span class="line">fmt.Printf(<span class="string">"切片指向的底层数组的地址=%p，切片自己的地址=%p\n"</span>, sliceVariables3, &amp;sliceVariables3)</span><br><span class="line"><span class="comment">//切片指向的底层数组的地址=0xc000050060，切片自己的地址=0xc0000040a8</span></span><br><span class="line"></span><br><span class="line">appendedNum := []<span class="keyword">int</span>{<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>}</span><br><span class="line">sliceVariables3 = <span class="built_in">append</span>(sliceVariables3, appendedNum...) <span class="comment">// 函数的参数传递，第二个参数的值传递到第一个参数</span></span><br><span class="line">fmt.Println(sliceVariables3)</span><br><span class="line">fmt.Printf(<span class="string">"第四次追加sliceVariables3的长度=%d，容量=%d,\n"</span>, <span class="built_in">len</span>(sliceVariables3), <span class="built_in">cap</span>(sliceVariables3))</span><br><span class="line"><span class="comment">//第四次追加sliceVariables3的长度=12，容量=12                            // [0 0 0 0 0 7 8 9 10 1 2 3]</span></span><br><span class="line">fmt.Printf(<span class="string">"切片指向的底层数组的地址=%p，切片自己的地址=%p\n"</span>, sliceVariables3, &amp;sliceVariables3)</span><br><span class="line"><span class="comment">//切片指向的底层数组的地址=0xc000050060，切片自己的地址=0xc0000040a8</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">b := []<span class="keyword">int</span>{<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>}</span><br><span class="line">fmt.Printf(<span class="string">"切片指向的底层数组的地址=%p，切片自己的地址=%p\n"</span>, b, &amp;b)</span><br><span class="line"><span class="comment">// 切片指向的底层数组的地址=0xc0000ae078，切片自己的地址=0xc000096060</span></span><br><span class="line"></span><br><span class="line">c := b[:]</span><br><span class="line">fmt.Printf(<span class="string">"切片指向的底层数组的地址=%p，切片自己的地址=%p\n"</span>, c, &amp;c)</span><br><span class="line"><span class="comment">// 切片指向的底层数组的地址=0xc0000ae078，切片自己的地址=0xc000096090</span></span><br><span class="line"></span><br><span class="line">c = <span class="built_in">append</span>(c, <span class="number">9</span>)</span><br><span class="line">fmt.Printf(<span class="string">"%v len=%d cap=%d\n"</span>, c, <span class="built_in">len</span>(c), <span class="built_in">cap</span>(c)) <span class="comment">// [1 2 3 9] len=4 cap=6</span></span><br><span class="line">fmt.Printf(<span class="string">"切片指向的底层数组的地址=%p，切片自己的地址=%p\n"</span>, c, &amp;c)</span><br><span class="line"><span class="comment">// 切片指向的底层数组的地址=0xc0000c0090，切片自己的地址=0xc000096090</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// append函数没有影响到原来的数组</span></span><br><span class="line">fmt.Printf(<span class="string">"%v len=%d cap=%d\n"</span>, b, <span class="built_in">len</span>(b), <span class="built_in">cap</span>(b)) <span class="comment">// [1 2 3] len=3 cap=3</span></span><br><span class="line">fmt.Printf(<span class="string">"切片指向的底层数组的地址=%p，切片自己的地址=%p\n"</span>, b, &amp;b)</span><br><span class="line"><span class="comment">// 切片指向的底层数组的地址=0xc0000ae078，切片自己的地址=0xc000096060</span></span><br><span class="line"></span><br><span class="line">c[<span class="number">0</span>] = <span class="number">8</span></span><br><span class="line">fmt.Printf(<span class="string">"%v len=%d cap=%d\n"</span>, c, <span class="built_in">len</span>(c), <span class="built_in">cap</span>(c)) <span class="comment">// [8 2 3 9] len=4 cap=6</span></span><br><span class="line">fmt.Printf(<span class="string">"切片指向的底层数组的地址=%p，切片自己的地址=%p\n"</span>, c, &amp;c)</span><br><span class="line"><span class="comment">// 切片指向的底层数组的地址=0xc0000c0090，切片自己的地址=0xc000096090</span></span><br><span class="line">fmt.Printf(<span class="string">"%v len=%d cap=%d\n"</span>, b, <span class="built_in">len</span>(b), <span class="built_in">cap</span>(b)) <span class="comment">// [1 2 3] len=3 cap=3</span></span><br><span class="line">fmt.Printf(<span class="string">"切片指向的底层数组的地址=%p，切片自己的地址=%p\n"</span>, b, &amp;b)</span><br><span class="line"><span class="comment">// 切片指向的底层数组的地址=0xc0000ae078，切片自己的地址=0xc000096060</span></span><br><span class="line"></span><br><span class="line">fmt.Println(<span class="string">"b ="</span>, b) <span class="comment">// b = [1 2 3] 底层数组没变，底层数组长度没变</span></span><br><span class="line"></span><br><span class="line">s2 := b[:<span class="number">1</span>] <span class="comment">// [b[0]]</span></span><br><span class="line">s3 := <span class="built_in">append</span>(s2, <span class="number">10</span>)</span><br><span class="line">fmt.Println(<span class="string">"s3 ="</span>, s3) <span class="comment">// s3 = [1 10]</span></span><br><span class="line"><span class="comment">// s4 and s5 no longer view b. 系统分配了新的 b</span></span><br><span class="line">fmt.Println(<span class="string">"b ="</span>, b) <span class="comment">// b = [1 10 3] 底层数组变了</span></span><br><span class="line"></span><br><span class="line">s4 := <span class="built_in">append</span>(s3, <span class="number">11</span>)</span><br><span class="line">fmt.Println(<span class="string">"s4 ="</span>, s4) <span class="comment">// s4 = [1 10 11]</span></span><br><span class="line">fmt.Println(<span class="string">"b ="</span>, b) <span class="comment">// b = [1 10 11] 底层数组变</span></span><br><span class="line"></span><br><span class="line">d := []<span class="keyword">int</span>{<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>}</span><br><span class="line">s5 := d[:<span class="number">1</span>] <span class="comment">// [d[0]]</span></span><br><span class="line"></span><br><span class="line">s6 := <span class="built_in">append</span>(s5, <span class="number">12</span>)</span><br><span class="line">fmt.Println(<span class="string">"s6 ="</span>, s6) <span class="comment">// s6 = [1 12]</span></span><br><span class="line">fmt.Println(<span class="string">"d ="</span>, d) <span class="comment">// d = [1 12 3] 底层数组变</span></span><br><span class="line"></span><br><span class="line">s7 := <span class="built_in">append</span>(s6, <span class="number">13</span>, <span class="number">14</span>)</span><br><span class="line">fmt.Println(<span class="string">"s7 ="</span>, s7) <span class="comment">// s7 = [1 12 13 14]</span></span><br><span class="line">fmt.Println(<span class="string">"d ="</span>, d) <span class="comment">// d = [1 12 3] 底层数组没变，底层数组长度没变</span></span><br></pre></td></tr></tbody></table></figure>


<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The copy built-in function copies elements from a source slice into a</span></span><br><span class="line"><span class="comment">// destination slice. (As a special case, it also will copy bytes from a</span></span><br><span class="line"><span class="comment">// string to a slice of bytes.) The source and destination may overlap. Copy</span></span><br><span class="line"><span class="comment">// returns the number of elements copied, which will be the minimum of</span></span><br><span class="line"><span class="comment">// len(src) and len(dst).拷贝元素的数量以两个切片中最小切片的长度</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">copy</span><span class="params">(dst, src []Type)</span> <span class="title">int</span></span></span><br></pre></td></tr></tbody></table></figure>

<p>复制不会去扩展a的空间</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">sliceVariables4 := []<span class="keyword">int</span>{<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>}</span><br><span class="line">fmt.Println(sliceVariables4) <span class="comment">// [1 2 3 4 5]</span></span><br><span class="line"></span><br><span class="line">sliceVariables5 := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">10</span>)</span><br><span class="line"><span class="comment">// copy(sliceVariables4, sliceVariables5)</span></span><br><span class="line">fmt.Println(<span class="built_in">copy</span>(sliceVariables4, sliceVariables5)) <span class="comment">// 5</span></span><br><span class="line">fmt.Println(sliceVariables4) <span class="comment">// [0 0 0 0 0]</span></span><br><span class="line">fmt.Println(sliceVariables5) <span class="comment">// [0 0 0 0 0 0 0 0 0 0]</span></span><br><span class="line"></span><br><span class="line">sliceVariables4 := []<span class="keyword">int</span>{<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>}</span><br><span class="line">sliceVariables5 := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">10</span>)</span><br><span class="line">fmt.Println(sliceVariables5) <span class="comment">// [0 0 0 0 0 0 0 0 0 0]</span></span><br><span class="line"><span class="comment">// copy(sliceVariables5, sliceVariables4)</span></span><br><span class="line">fmt.Println(<span class="built_in">copy</span>(sliceVariables5, sliceVariables4)) <span class="comment">// 5</span></span><br><span class="line">fmt.Println(sliceVariables4) <span class="comment">// [1 2 3 4 5]</span></span><br><span class="line">fmt.Println(sliceVariables5, <span class="built_in">len</span>(sliceVariables5), <span class="built_in">cap</span>(sliceVariables5)) <span class="comment">// [1 2 3 4 5 0 0 0 0 0] 10 10</span></span><br><span class="line"></span><br><span class="line">sliceVariables7 := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">5</span>)</span><br><span class="line">fmt.Printf(<span class="string">"%v len=%d\n"</span>, sliceVariables7, <span class="built_in">len</span>(sliceVariables7), <span class="built_in">cap</span>(sliceVariables7)) <span class="comment">// [0 0 0 0 0] len=5 cap=5</span></span><br><span class="line"><span class="built_in">copy</span>(sliceVariables7, sliceVariables4)</span><br><span class="line">fmt.Println(sliceVariables4) <span class="comment">// [1 2 3 4 5]</span></span><br><span class="line">fmt.Printf(<span class="string">"%v len=%d cap=%d\n"</span>, sliceVariables7, <span class="built_in">len</span>(sliceVariables7), <span class="built_in">cap</span>(sliceVariables7)) <span class="comment">// [1 2 3 4 5] len=5 cap=5</span></span><br><span class="line"></span><br><span class="line">sliceVariables8 := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">6</span>)</span><br><span class="line">fmt.Printf(<span class="string">"%v len=%d\n"</span>, sliceVariables8, <span class="built_in">len</span>(sliceVariables8)) <span class="comment">// [0 0 0 0 0 0] len=6</span></span><br><span class="line"><span class="built_in">copy</span>(sliceVariables8, sliceVariables4)</span><br><span class="line">fmt.Println(sliceVariables4) <span class="comment">// [1 2 3 4 5]</span></span><br><span class="line">fmt.Printf(<span class="string">"%v len=%d cap=%d\n"</span>, sliceVariables8, <span class="built_in">len</span>(sliceVariables8), <span class="built_in">cap</span>(sliceVariables8)) <span class="comment">// [1 2 3 4 5 0] len=6 cap=6</span></span><br><span class="line"></span><br><span class="line">sliceVariables9 := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">1</span>)</span><br><span class="line">fmt.Printf(<span class="string">"%v len=%d cap=%d\n"</span>, sliceVariables9, <span class="built_in">len</span>(sliceVariables9), <span class="built_in">cap</span>(sliceVariables9)) <span class="comment">// [0] len=1 cap=1</span></span><br><span class="line"><span class="built_in">copy</span>(sliceVariables9, sliceVariables4)</span><br><span class="line">fmt.Println(sliceVariables4) <span class="comment">// [1 2 3 4 5]</span></span><br><span class="line"><span class="comment">// fmt.Println(copy(sliceVariables9, sliceVariables4)) // 1</span></span><br><span class="line">fmt.Printf(<span class="string">"%v len=%d cap=%d\n"</span>, sliceVariables9, <span class="built_in">len</span>(sliceVariables9), <span class="built_in">cap</span>(sliceVariables9)) <span class="comment">// [1] len=1 cap=1</span></span><br><span class="line"></span><br><span class="line">sliceVariables10 := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">0</span>)</span><br><span class="line">fmt.Printf(<span class="string">"%v len=%d\n"</span>, sliceVariables10, <span class="built_in">len</span>(sliceVariables10), <span class="built_in">cap</span>(sliceVariables8)) <span class="comment">// [] len=0 cap=0</span></span><br><span class="line"><span class="built_in">copy</span>(sliceVariables10, sliceVariables4)</span><br><span class="line"><span class="comment">// fmt.Println(copy(sliceVariables10, sliceVariables4)) // 0</span></span><br><span class="line">fmt.Println(sliceVariables4) <span class="comment">// [1 2 3 4 5]</span></span><br><span class="line">fmt.Printf(<span class="string">"%v len=%d\n"</span>, sliceVariables10, <span class="built_in">len</span>(sliceVariables10), <span class="built_in">cap</span>(sliceVariables8)) <span class="comment">// [] len=0 cap=0</span></span><br></pre></td></tr></tbody></table></figure>

<p>append函数追加多个元素，既然是切片，那为什么这个时候有来提出长度的要求</p>
<p>想从切片中删除元素怎么办？</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">printSlice</span><span class="params">(s []<span class="keyword">int</span>)</span></span> {</span><br><span class="line">    fmt.Printf(<span class="string">"%v, len=%d, cap=%d\n"</span>,</span><br><span class="line">        s, <span class="built_in">len</span>(s), <span class="built_in">cap</span>(s))</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">    s2 := []<span class="keyword">int</span>{<span class="number">2</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>}</span><br><span class="line"></span><br><span class="line">    s2 = <span class="built_in">append</span>(s2[:<span class="number">3</span>], s2[<span class="number">4</span>:]...) <span class="comment">// 把位置为3的删掉 取巧的做法，第一段+第二段</span></span><br><span class="line">    <span class="comment">// 中间位置删除一个元素容量不变</span></span><br><span class="line">    printSlice(s2) <span class="comment">// [2 4 6 0 0 0 0 0 0 0 0 0 0 0 0], len=15, cap=16</span></span><br><span class="line"></span><br><span class="line">    fmt.Println(<span class="string">"Popping from front"</span>)</span><br><span class="line">    front := s2[<span class="number">0</span>]</span><br><span class="line">    s2 = s2[<span class="number">1</span>:] <span class="comment">// 删除头</span></span><br><span class="line"></span><br><span class="line">    fmt.Println(front) <span class="comment">// 2</span></span><br><span class="line">    <span class="comment">// 左端位置删除一个元素容量变</span></span><br><span class="line">    printSlice(s2) <span class="comment">// [4 6 0 0 0 0 0 0 0 0 0 0 0 0], len=14, cap=15</span></span><br><span class="line"></span><br><span class="line">    fmt.Println(<span class="string">"Popping from back"</span>)</span><br><span class="line">    tail := s2[<span class="built_in">len</span>(s2)<span class="number">-1</span>]</span><br><span class="line">    s2 = s2[:<span class="built_in">len</span>(s2)<span class="number">-1</span>] <span class="comment">// 删除尾</span></span><br><span class="line"></span><br><span class="line">    fmt.Println(tail) <span class="comment">// 0</span></span><br><span class="line">    <span class="comment">// 右端位置删除一个元素容量变</span></span><br><span class="line">    printSlice(s2) <span class="comment">// [4 6 0 0 0 0 0 0 0 0 0 0 0], len=13, cap=15</span></span><br></pre></td></tr></tbody></table></figure>

<p>两个切片不能比较<br>一个切片slice类型只能与nil比较，其他的都不可以</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">a := []<span class="keyword">int</span>{<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>}</span><br><span class="line">b := []<span class="keyword">int</span>{<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>}</span><br><span class="line"><span class="comment">// 两个切片不能比较</span></span><br><span class="line"><span class="keyword">if</span> a == b { <span class="comment">// Invalid operation: a == b (the operator == is not defined on []int)</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 一个切片slice类型只能与nil比较，其他的都不可以</span></span><br><span class="line"><span class="keyword">var</span> c []<span class="keyword">int</span></span><br><span class="line"><span class="keyword">if</span> c == <span class="literal">nil</span> { <span class="comment">//  Zero value for slice is nil</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>切片底层是使用数组实现的，既要使用数组 又要满足动态的功能 怎么实现？<br>假设有一个值 实际上申请数组的时候可能是两个，如果后续要增加数据那么就直接添加到数据的结尾，这个时候我不要额外重新申请<br>切片有不同的初始化方式</p>
<p>底层存储<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/kikajack/article/details/79833674">https://blog.csdn.net/kikajack/article/details/79833674</a><br>go和python的切片区别<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_15437667/article/details/70191873">https://blog.csdn.net/qq_15437667/article/details/70191873</a></p>
<p>Go 中切片 slice扩容机制</p>
<p>首先判断，如果新申请容量（cap）大于2倍的旧容量（old.cap），最终容量（newcap）就是新申请的容量（cap）<br>否则判断，如果旧切片的长度小于1024，则最终容量(newcap)就是旧容量(old.cap)的两倍，即（newcap=doublecap）<br>否则判断，如果旧切片长度大于等于1024，则最终容量（newcap）从旧容量（old.cap）开始循环增加原来的 1/4，<br>即（newcap=old.cap,for {newcap += newcap/4}）<br>直到最终容量（newcap）大于等于新申请的容量(cap)，即（newcap &gt;= cap）<br>如果最终容量（cap）计算值溢出，则最终容量（cap）就是新申请容量（cap）</p>
<p>大家可以通过源码了解，<br>文章推荐：<a target="_blank" rel="noopener" href="https://juejin.im/post/5ca2b75f51882543ea4b81c8#heading-7">https://juejin.im/post/5ca2b75f51882543ea4b81c8#heading-7</a></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/35/">35</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">外心人D</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  




  





</body>
</html>
