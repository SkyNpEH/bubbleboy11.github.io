<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.0.2">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"bubbleboy11.github.io","root":"/","images":"/images","scheme":"Muse","version":"8.6.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>
<meta name="description" content="本博客大多内容为慕课和网上博客，并非原创">
<meta property="og:type" content="website">
<meta property="og:title" content="外心人D的博客">
<meta property="og:url" content="https://bubbleboy11.github.io/page/8/index.html">
<meta property="og:site_name" content="外心人D的博客">
<meta property="og:description" content="本博客大多内容为慕课和网上博客，并非原创">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="外心人D">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://bubbleboy11.github.io/page/8/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/8/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>外心人D的博客</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="外心人D的博客" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism.css" type="text/css"></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">外心人D的博客</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-overview">
            <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">外心人D</p>
  <div class="site-description" itemprop="description">本博客大多内容为慕课和网上博客，并非原创</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">336</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">25</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">40</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



          </div>
        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/05/06/drf-de-request-he-response-lei/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/06/drf-de-request-he-response-lei/" class="post-title-link" itemprop="url">DRF视图开发RESTful API接口的方式</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-05-05 16:21:41" itemprop="dateCreated datePublished" datetime="2021-05-05T16:21:41Z">2021-05-05</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-06-23 02:12:09" itemprop="dateModified" datetime="2021-06-23T02:12:09Z">2021-06-23</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/django/" itemprop="url" rel="index"><span itemprop="name">django</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://www.django-rest-framework.org/api-guide/requests/#data">https://www.django-rest-framework.org/api-guide/requests/#data</a></p>
<p>REST framework 传入视图的request对象不再是Django默认的HttpRequest对象，而是REST framework提供的扩展了django原生<code>HttpRequest</code>类的<code>Request</code>类的对象。</p>
<p>比如更加灵活的请求解析（request parsing）和认证（request authentication）。</p>
<p>REST framework 提供了Parser解析器，在接收到请求后会自动根据Content-Type指明的请求数据类型（如JSON、表单等）将请求数据进行parse解析，解析为类字典[QueryDict]对象保存到Request对象中。</p>
<p><strong>Request对象的数据是自动根据前端发送数据的格式进行解析之后的结果。</strong></p>
<p>无论前端发送的哪种格式的数据，我们都可以以统一的方式读取数据。</p>
<ul>
<li><p><code>request.data</code>  <code>&lt;class 'dict'&gt;</code><br>返回请求主体的解析内容，类似Django中标准的<code>request.POST</code>和<code>request.FILES</code>属性，具体如下：</p>
<ul>
<li>它包括所有已解析的内容，包括文件和非文件输入；</li>
<li>它支持解析HTTP方法不只是<code>POST</code>，这意味着您可以访问<code>PUT</code>和<code>PATCH</code>请求的内容；</li>
<li>它支持REST框架的灵活请求解析器parsers，而不仅仅是支持表单数据。例如，可以以处理传入表单数据的相同方式处理传入JSON数据。</li>
</ul>
</li>
<li><p><code>request.query_params</code><br>等同于Django标准的<code>request.GET</code>，有助于使代码库更加正确和明显，这样那够让你的代码更加明显的体现出 —-任何HTTP方法类型都可能包括查询参数，而不仅仅是GET请求。</p>
</li>
<li><p><code>request.parsers</code> <code>APIView</code> 类或者 <code>@api_view</code> 装饰器将根据视图上设置的 parser_classes 或 settings 文件中的 DEFAULT_PARSER_CLASSES 设置来确保此属性（.parsers）自动设置为 Parser 实例列表。用于解析数据。通常不需要关注该属性……DRF包括许多内置的Parser类，以保证可以接收各种媒体类型的请求并解析，包括JSONParser、FormParser、MultiPartParser等。还支持定义自己的自定义解析器，这使您可以灵活地设计API接受的媒体类型。</p>
</li>
<li><p><code>request.user</code>通常会返回的实例django.contrib.auth.models.User，尽管其行为取决于所使用的身份验证策略。</p>
</li>
</ul>
<p>drf 二次封装后的 request 对象</p>
<p>怎么拿到请求传递过来的数据（url 拼接的数据，数据包传过来的数据）</p>
<p>源码</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">APIView</span>(<span class="params">View</span>):</span></span><br><span class="line">    <span class="comment"># Note: Views are made CSRF exempt from within `as_view` as to prevent</span></span><br><span class="line">    <span class="comment"># accidental removal of this exemption in cases where `dispatch` needs to</span></span><br><span class="line">    <span class="comment"># be overridden.</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dispatch</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        `.dispatch()` is pretty much the same as Django's regular dispatch,</span></span><br><span class="line"><span class="string">        but with extra hooks for startup, finalize, and exception handling.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        self.args = args</span><br><span class="line">        self.kwargs = kwargs</span><br><span class="line">        <span class="comment"># 请求模块</span></span><br><span class="line">        request = self.initialize_request(request, *args, **kwargs)</span><br><span class="line">        self.request = request</span><br><span class="line">        self.headers = self.default_response_headers  <span class="comment"># deprecate?</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 三大认证模块</span></span><br><span class="line">            self.initial(request, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Get the appropriate handler method</span></span><br><span class="line">            <span class="keyword">if</span> request.method.lower() <span class="keyword">in</span> self.http_method_names:</span><br><span class="line">                handler = getattr(self, request.method.lower(),</span><br><span class="line">                                  self.http_method_not_allowed)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                handler = self.http_method_not_allowed</span><br><span class="line"></span><br><span class="line">            response = handler(request, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> exc:</span><br><span class="line">            response = self.handle_exception(exc)</span><br><span class="line"></span><br><span class="line">        self.response = self.finalize_response(request, response, *args, **kwargs)</span><br><span class="line">        <span class="keyword">return</span> self.response</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Dispatch methods</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">initialize_request</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        Returns the initial request object.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        parser_context = self.get_parser_context(request)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Request(  <span class="comment"># 对应下面的__init__</span></span><br><span class="line">            request,</span><br><span class="line">            parsers=self.get_parsers(),</span><br><span class="line">            authenticators=self.get_authenticators(),</span><br><span class="line">            negotiator=self.get_content_negotiator(),</span><br><span class="line">            parser_context=parser_context</span><br><span class="line">        )</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Request</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Wrapper allowing to enhance a standard `HttpRequest` instance.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Kwargs:</span></span><br><span class="line"><span class="string">        - request(HttpRequest). The original request instance.</span></span><br><span class="line"><span class="string">        - parsers(list/tuple). The parsers to use for parsing the</span></span><br><span class="line"><span class="string">          request content.</span></span><br><span class="line"><span class="string">        - authenticators(list/tuple). The authenticators used to try</span></span><br><span class="line"><span class="string">          authenticating the request's user.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, request, parsers=None, authenticators=None,</span></span></span><br><span class="line"><span class="function"><span class="params">                 negotiator=None, parser_context=None</span>):</span></span><br><span class="line">        <span class="keyword">assert</span> isinstance(request, HttpRequest), (</span><br><span class="line">            <span class="string">'The `request` argument must be an instance of '</span></span><br><span class="line">            <span class="string">'`django.http.HttpRequest`, not `{}.{}`.'</span></span><br><span class="line">            .format(request.__class__.__module__, request.__class__.__name__)</span><br><span class="line">        )</span><br><span class="line">        <span class="comment"># 二次封装 request，将原生 request 作为 drf request 对象的 _request 属性</span></span><br><span class="line">        self._request = request</span><br><span class="line">        <span class="comment"># 虽然 drf 对 request 对象做了二次封装，但是它也做了完全兼容（见下面的 __getattr__ 方法）</span></span><br><span class="line"></span><br><span class="line">        self.parsers = parsers <span class="keyword">or</span> ()</span><br><span class="line">        self.authenticators = authenticators <span class="keyword">or</span> ()</span><br><span class="line">        self.negotiator = negotiator <span class="keyword">or</span> self._default_negotiator()</span><br><span class="line">        self.parser_context = parser_context</span><br><span class="line">        self._data = Empty</span><br><span class="line">        self._files = Empty</span><br><span class="line">        self._full_data = Empty</span><br><span class="line">        self._content_type = Empty</span><br><span class="line">        self._stream = Empty</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.parser_context <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            self.parser_context = {}</span><br><span class="line">        self.parser_context[<span class="string">'request'</span>] = self</span><br><span class="line">        self.parser_context[<span class="string">'encoding'</span>] = request.encoding <span class="keyword">or</span> settings.DEFAULT_CHARSET</span><br><span class="line"></span><br><span class="line">        force_user = getattr(request, <span class="string">'_force_auth_user'</span>, <span class="literal">None</span>)</span><br><span class="line">        force_token = getattr(request, <span class="string">'_force_auth_token'</span>, <span class="literal">None</span>)</span><br><span class="line">        <span class="keyword">if</span> force_user <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">or</span> force_token <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            forced_auth = ForcedAuthentication(force_user, force_token)</span><br><span class="line">            self.authenticators = (forced_auth,)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span>(<span class="params">self, attr</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        If an attribute does not exist on this instance, then we also attempt</span></span><br><span class="line"><span class="string">        to proxy it to the underlying HttpRequest object.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 对原有的 request 做了完全兼容</span></span><br><span class="line">            <span class="keyword">return</span> getattr(self._request, attr)</span><br><span class="line">        <span class="keyword">except</span> AttributeError:</span><br><span class="line">            <span class="keyword">return</span> self.__getattribute__(attr)</span><br></pre></td></tr></tbody></table></figure>

<p>url 拼接的参数都可以用 request.query_params 来取<br>所有请求的数据包方式数据都可以用 request.data 来取，所有数据方式（from-data、json…）它都做解析了</p>
<p>在 APIView 视图类的方法中</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="comment"># 获取 url 拼接的参数</span></span><br><span class="line">        print(request._request.GET)  <span class="comment"># 二次封装</span></span><br><span class="line">        print(request.GET)  <span class="comment"># 兼容</span></span><br><span class="line">        print(request.query_params)  <span class="comment"># 扩展，推荐用这个</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Response(<span class="string">"drf get ok."</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="comment"># 获取 url 拼接的参数 (所有请求方式都可以携带这个)</span></span><br><span class="line">        print(request._request.GET)</span><br><span class="line">        print(request.GET)  <span class="comment"># 兼容</span></span><br><span class="line">        print(request.query_params)  <span class="comment"># 扩展，推荐用这个</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 获取 post 参数</span></span><br><span class="line">        print(request._request.POST)  <span class="comment"># 拿不到 json 的数据 </span></span><br><span class="line">        print(request.POST)  <span class="comment"># 兼容，拿不到 json 的数据</span></span><br><span class="line">        print(request.data)  <span class="comment"># 扩展，兼容性最强，三种数据方式都可以，推荐用这个</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Response(<span class="string">"drf post ok"</span>)</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>drf 对原生 request 做了二次封装，<code>request._request</code> 就是原生 <code>request</code></li>
<li>原生 request 对象的属性和方法都可以被 drf 的 request 对象直接访问（向下兼容）</li>
<li>drf 请求的所有 url 拼接参数都被解析到 <code>request.query_params</code> 中，所有数据包数据都被解析到 <code>request.data</code> 中<br>任何请求都可以通过 url 拼接参数来传递参数，同样通过 <code>request.query_params</code> 获取</li>
</ul>
<h2 id="Response"><a href="#Response" class="headerlink" title="Response()"></a>Response()</h2><p><a target="_blank" rel="noopener" href="https://www.django-rest-framework.org/api-guide/responses/">https://www.django-rest-framework.org/api-guide/responses/</a></p>
<p>DRF通过提供一个Response类来支持HTTP内容协商，该类允许您根据客户端请求返回可以呈现为多种内容类型的内容。</p>
<p>也可以根据需要从视图中返回常规<code>HttpResponse</code>或<code>StreamingHttpResponse</code>对象。使用<code>Response</code>类只是为返回内容协商的Web API响应提供了一个更好的接口，该响应可以呈现为多种格式。</p>
<p>构造方法: <code>Response(data, status=None, template_name=None, headers=None, content_type=None)</code></p>
<p>与普通 HttpResponse 对象不同，您不会使用渲染的内容实例化 Response 对象。相反，您传递的是未渲染的数据，可能包含任何 Python 对象。</p>
<p>由于 Response 类使用的渲染器不能处理复杂的数据类型（比如 Django 的模型实例），所以需要在创建 <code>Response</code> 对象之前将数据序列化为基本的数据类型。</p>
<p>你可以使用 REST framework 的 Serializer 类来执行序列化的操作，也可以用自己的方式来序列化。</p>
<h4 id="Arguments参数"><a href="#Arguments参数" class="headerlink" title="Arguments参数"></a>Arguments参数</h4><p>data： 为响应准备的序列化后的数据。<br>status： 响应的状态代码。默认为200。<br>template_name： 选择 HTMLRenderer 时使用的模板名称。<br>headers： 设置 HTTP header，字典类型。<br>content_type： 响应的内容类型，通常渲染器会根据内容协商的结果自动设置，但有些时候需要手动指定。</p>
<h4 id="Attributes属性"><a href="#Attributes属性" class="headerlink" title="Attributes属性"></a>Attributes属性</h4><p><code>.data</code>还没有渲染，但已经序列化的响应数据。</p>
<p><code>.status_code</code> 状态码</p>
<p>.content<br>将会返回的响应内容，必须先调用 <code>.render()</code>方法，才能访问 <code>.content</code> 。</p>
<p>.template_name</p>
<p>只有在 response 的渲染器是 HTMLRenderer 或其他自定义模板渲染器时才需要提供。</p>
<p>.accepted_renderer</p>
<p>用于将会返回的响应内容的渲染器实例。</p>
<p>从视图返回响应之前由 APIView 或 @api_view 自动设置。</p>
<p>.accepted_media_type</p>
<p>内容协商阶段选择的媒体类型。</p>
<p>从视图返回响应之前由 APIView 或 @api_view 自动设置。</p>
<p>.renderer_context</p>
<p>将传递给渲染器的 .render() 方法的附加的上下文信息字典。</p>
<p>从视图返回响应之前由 APIView 或 @api_view 自动设置。</p>
<p>标准 HttpResponse 属性</p>
<p>Response 类扩展于 SimpleTemplateResponse，并且响应中也提供了所有常用的属性和方法。例如，您可以用标准方式在响应中设置 header：</p>
<p>response = Response()<br>response[‘Cache-Control’] = ‘no-cache’<br>.render()</p>
<p>与其他任何 TemplateResponse 一样，调用此方法将响应的序列化数据呈现为最终响应内容。响应内容将设置为在 accepted_renderer 实例上调用 .render(data，accepted_media_type，renderer_context) 方法的结果。</p>
<p>通常不需要自己调用 .render() ，因为它是由 Django 处理的。</p>
<p>一般都用 Response 对象来做返回（最后一定是打包成符合 HTTP 协议的数据格式来传输，Response 类做了一系列处理，所以这里我们只需要关注下它的那些参数即可）</p>
<p>响应类构造器</p>
<p>源码</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Response</span>(<span class="params">SimpleTemplateResponse</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    An HttpResponse that allows its data to be rendered into</span></span><br><span class="line"><span class="string">    arbitrary media types.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, data=None, status=None,</span></span></span><br><span class="line"><span class="function"><span class="params">                    template_name=None, headers=None,</span></span></span><br><span class="line"><span class="function"><span class="params">                    exception=False, content_type=None</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        Alters the init arguments slightly.</span></span><br><span class="line"><span class="string">        For example, drop 'template_name', and instead use 'data'.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Setting 'renderer' and 'media_type' will typically be deferred,</span></span><br><span class="line"><span class="string">        For example being set automatically by the `APIView`.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            :param data: 响应数据</span></span><br><span class="line"><span class="string">            :param status: http响应状态码</span></span><br><span class="line"><span class="string">            :param template_name: drf也可以渲染页面，渲染的页面模板地址（不用了解）</span></span><br><span class="line"><span class="string">            :param headers: 响应头</span></span><br><span class="line"><span class="string">            :param exception: 是否异常了</span></span><br><span class="line"><span class="string">            :param content_type: 响应的数据格式（一般不用处理，响应头中带了，且默认是json）</span></span><br><span class="line"><span class="string">        """</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> status</span><br><span class="line"><span class="comment"># status就是解释一堆 数字 网络状态码的模块</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 一般情况下只需要返回数据，status和headers都有默认值</span></span><br><span class="line"><span class="keyword">return</span> Response(data={数据}, status=status.HTTP_200_OK, headers={设置的响应头})</span><br></pre></td></tr></tbody></table></figure>

<p>models.py</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseModel</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    is_delete = models.BooleanFiled(default=Flase)</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        abstract = <span class="literal">True</span>  <span class="comment"># *****</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span>(<span class="params">BaseModel</span>):</span></span><br><span class="line">    name = models.CharFiled(max_length=<span class="number">64</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">my_name</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># 自定义字段：可以连表，可以完成数据相关的逻辑</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'插拔式字段的值'</span></span><br></pre></td></tr></tbody></table></figure>

<p>serializes.py</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CarModelSerializer</span>(<span class="params">ModelSerializer</span>):</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = models.Car</span><br><span class="line">        fields = (<span class="string">'name'</span>, )</span><br><span class="line">        extra_kwargs = {<span class="string">'name'</span>: {<span class="string">'write_only|read_only'</span>: <span class="literal">True</span>}}</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 局部钩子、全局钩子</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 重点：ListSerializer与ModelSerializer建立关联的是：</span></span><br><span class="line"><span class="comment"># ModelSerializer的Meta类的 - list_serializer_class</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">V2BookListSerializer</span>(<span class="params">ListSerializer</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">update</span>(<span class="params">self, instance, validated_data</span>):</span></span><br><span class="line">        <span class="comment"># print(instance)  # 要更新的对象们</span></span><br><span class="line">        <span class="comment"># print(validated_data)  # 更新的对象对应的数据们</span></span><br><span class="line">        <span class="comment"># print(self.child)  # 服务的模型序列化类 - V2BookModelSerializer</span></span><br><span class="line">        <span class="keyword">for</span> index, obj <span class="keyword">in</span> enumerate(instance):</span><br><span class="line">            self.child.update(obj, validated_data[index])</span><br><span class="line">        <span class="keyword">return</span> instance</span><br><span class="line"></span><br><span class="line"><span class="comment"># 原模型序列化类变化</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">V2BookModelSerializer</span>(<span class="params">ModelSerializer</span>):</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        <span class="comment"># ...</span></span><br><span class="line">        <span class="comment"># 群改，需要设置 自定义ListSerializer，重写群改的 update 方法</span></span><br><span class="line">        list_serializer_class = V2BookListSerializer</span><br><span class="line">    <span class="comment"># ...</span></span><br></pre></td></tr></tbody></table></figure>

<p>views.py</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">    ser_obj = CarModelSerializer(数据)  <span class="comment"># 产生序列化类对象(可能参与序列化，也可能参与反序列化)</span></span><br><span class="line">    ser_obj.data  <span class="comment"># 序列化的数据</span></span><br><span class="line">    ser_obj.is_valid()  <span class="comment"># 启动序列化校验规则（系统内容=&gt;局部钩子=&gt;全局钩子）</span></span><br><span class="line">    ser_obj.save()  <span class="comment"># 序列化校验后的数据操作（保存、修改）</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">V2Book</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="comment"># 单整体改: 对 v2/books/(pk)/ 传的数据是与model对应的字典{name|price|publish|authors}</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        request_data = request.data</span><br><span class="line">        pk = kwargs.get(<span class="string">'pk'</span>)</span><br><span class="line">        old_book_obj = models.Book.objects.filter(pk=pk).first()</span><br><span class="line">        <span class="comment"># 目的：将众多数据的校验交给序列化类来处理 - 让序列化类扮演反序列化角色，校验成功后，序列化类来帮你入库</span></span><br><span class="line">        book_ser = serializers.V2BookModelSerializer(instance=old_book_obj, data=request_data, partial=<span class="literal">False</span>)</span><br><span class="line">        book_ser.is_valid(raise_exception=<span class="literal">True</span>)</span><br><span class="line">        <span class="comment"># 校验通过，完成数据的更新：要更新的目标，用来更新的新数据</span></span><br><span class="line">        book_obj = book_ser.save()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Response({</span><br><span class="line">            <span class="string">'status'</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="string">'msg'</span>: <span class="string">'ok'</span>,</span><br><span class="line">            <span class="string">'results'</span>: serializers.V2BookModelSerializer(book_obj).data</span><br><span class="line">        })</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 单局部改：对 v2/books/(pk)/ 传的数据，数据字段key都是选填</span></span><br><span class="line">    <span class="comment"># 群局部改：对 v2/books/ </span></span><br><span class="line">    <span class="comment"># 请求数据 - [{pk:1, name:123}, {pk:3, price:7}, {pk:7, publish:2}]</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">patch</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        request_data = request.data</span><br><span class="line">        pk = kwargs.get(<span class="string">'pk'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 将单改，群改的数据都格式化成 pks=[要需要的对象主键标识] | request_data=[每个要修改的对象对应的修改数据]</span></span><br><span class="line">        <span class="keyword">if</span> pk <span class="keyword">and</span> isinstance(request_data, dict):  <span class="comment"># 单改</span></span><br><span class="line">            pks = [pk, ]</span><br><span class="line">            request_data = [request_data, ]</span><br><span class="line">        <span class="keyword">elif</span> <span class="keyword">not</span> pk <span class="keyword">and</span> isinstance(request_data, list): <span class="comment"># 群改</span></span><br><span class="line">            pks = []</span><br><span class="line">            <span class="keyword">for</span> dic <span class="keyword">in</span> request_data:  <span class="comment"># 遍历前台数据[{pk:1, name:123}, {pk:3, price:7}, {pk:7, publish:2}]，拿一个个字典</span></span><br><span class="line">                pk = dic.pop(<span class="string">'pk'</span>, <span class="literal">None</span>)</span><br><span class="line">                <span class="keyword">if</span> pk:</span><br><span class="line">                    pks.append(pk)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">return</span> Response({</span><br><span class="line">                        <span class="string">'status'</span>: <span class="number">1</span>,</span><br><span class="line">                        <span class="string">'msg'</span>: <span class="string">'数据有误'</span>,</span><br><span class="line">                    })</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> Response({</span><br><span class="line">                <span class="string">'status'</span>: <span class="number">1</span>,</span><br><span class="line">                <span class="string">'msg'</span>: <span class="string">'数据有误'</span>,</span><br><span class="line">            })</span><br><span class="line"></span><br><span class="line">        <span class="comment"># pks与request_data数据筛选，</span></span><br><span class="line">        <span class="comment"># 1）将pks中的没有对应数据的pk与数据已删除的pk移除，request_data对应索引位上的数据也移除</span></span><br><span class="line">        <span class="comment"># 2）将合理的pks转换为 objs</span></span><br><span class="line">        objs = []</span><br><span class="line">        new_request_data = []</span><br><span class="line">        <span class="keyword">for</span> index, pk <span class="keyword">in</span> enumerate(pks):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># pk对应的数据合理，将合理的对象存储</span></span><br><span class="line">                obj = models.Book.objects.get(pk=pk)</span><br><span class="line">                objs.append(obj)</span><br><span class="line">                <span class="comment"># 对应索引的数据就需要保存下来</span></span><br><span class="line">                new_request_data.append(request_data[index])</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                <span class="comment"># 重点：反面教材 - pk对应的数据有误，将对应索引的data中request_data中移除</span></span><br><span class="line">                <span class="comment"># index = pks.index(pk)</span></span><br><span class="line">                <span class="comment"># request_data.pop(index)</span></span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        book_ser = serializers.V2BookModelSerializer(instance=objs, data=new_request_data, partial=<span class="literal">True</span>, many=<span class="literal">True</span>)</span><br><span class="line">        book_ser.is_valid(raise_exception=<span class="literal">True</span>)</span><br><span class="line">        book_objs = book_ser.save()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Response({</span><br><span class="line">            <span class="string">'status'</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="string">'msg'</span>: <span class="string">'ok'</span>,</span><br><span class="line">            <span class="string">'results'</span>: serializers.V2BookModelSerializer(book_objs, many=<span class="literal">True</span>).data</span><br><span class="line">        })</span><br></pre></td></tr></tbody></table></figure>


<ol>
<li>单整体改，说明前台要提供修改的数据，那么数据就需要校验，校验的数据应该在实例化“序列化类对象”时，赋值给data<br>2）修改，就必须明确被修改的模型类对象，并在实例化“序列化类对象”时，赋值给instance<br>3）整体修改，所有校验规则有required=True的字段，都必须提供，因为在实例化“序列化类对象”时，参数partial默认为False</li>
</ol>
<p>注：如果partial值设置为True，就是可以局部改<br>1）单整体修改，一般用put请求：</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">V2BookModelSerializer(</span><br><span class="line">    instance=要被更新的对象,</span><br><span class="line">    data=用来更新的数据,</span><br><span class="line">    partial=默认<span class="literal">False</span>，必须的字段全部参与校验</span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure>

<p>2）单局部修改，一般用patch请求：</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">V2BookModelSerializer(</span><br><span class="line">    instance=要被更新的对象,</span><br><span class="line">    data=用来更新的数据,</span><br><span class="line">    partial=设置<span class="literal">True</span>，必须的字段都变为选填字段</span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure>

<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/05/06/django-shi-tu-kai-fa-restful-api-jie-kou/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/06/django-shi-tu-kai-fa-restful-api-jie-kou/" class="post-title-link" itemprop="url">原生 django视图序列化RESTful API接口</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-05-05 16:21:41" itemprop="dateCreated datePublished" datetime="2021-05-05T16:21:41Z">2021-05-05</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-06-17 03:23:41" itemprop="dateModified" datetime="2021-06-17T03:23:41Z">2021-06-17</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/django/" itemprop="url" rel="index"><span itemprop="name">django</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>缺点：分页、排序、认证、权限、限流都需要自己实现</p>
</blockquote>
<p><code>JsonResponse</code> 和 <code>JsonResponse</code> 都能把传进来的参数直接化成一个字典 /json串？，<br>把响应头里面的<code>content_type</code>变成 <code>application/json</code></p>
<p>写法一</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django <span class="keyword">import</span> http</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> http.JsonResponse(data)</span><br><span class="line"><span class="keyword">return</span> http.HttpResponse(<span class="string">''</span>, status=<span class="number">200</span>)</span><br></pre></td></tr></tbody></table></figure>

<p>写法二</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse, JsonResponse</span><br><span class="line"></span><br><span class="line"><span class="comment"># In order to allow non-dict objects to be serialized set the safe parameter to False.</span></span><br><span class="line"><span class="keyword">return</span> JsonResponse(json.loads(json_data), safe=<span class="literal">False</span>)  <span class="comment"># 传递dict或list</span></span><br><span class="line"><span class="keyword">return</span> HttpResponse(json_data, content_type=<span class="string">'application/json'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> HttpResponse(json.dumps(json_list), content_type=<span class="string">'application/json'</span>)  <span class="comment"># 传递str类型</span></span><br><span class="line"><span class="comment"># In order to allow non-dict objects to be serialized set the safe parameter to False.</span></span><br><span class="line"><span class="keyword">return</span> JsonResponse(json_list, safe=<span class="literal">False</span>)</span><br></pre></td></tr></tbody></table></figure>

<h3 id="FBV-Function-Based-View-基于函数的视图"><a href="#FBV-Function-Based-View-基于函数的视图" class="headerlink" title="FBV Function Based View 基于函数的视图"></a>FBV Function Based View 基于函数的视图</h3><ul>
<li>对于 <code>POST</code> 请求，用装饰器，取消csrf的限制，就不用 <code>setting</code> 里面去注释掉了</li>
</ul>
<p><code>request.body</code>请求体里面所有数据，为json字符串，bytes类型</p>
<p><code>course_dict</code>相当于序列化后的dict数据</p>
<p><code>course\views.py</code><br>下面两种方法等价</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> JsonResponse</span><br><span class="line"><span class="comment"># 对于POST请求，用装饰器，取消csrf的限制，就不用setting里面去注释掉了</span></span><br><span class="line"><span class="keyword">from</span> django.views.decorators.csrf <span class="keyword">import</span> csrf_exempt</span><br><span class="line"></span><br><span class="line">course_dict = {<span class="string">'name'</span>: <span class="string">"课程"</span>, <span class="string">'introduction'</span>: <span class="string">"课程简介"</span>, <span class="string">'price'</span>: <span class="string">"课程价格"</span>}</span><br><span class="line"></span><br><span class="line"><span class="meta">@csrf_exempt</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">course_list</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'GET'</span>:</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(course_dict)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</span><br><span class="line">        course = json.loads(request.body.decode(<span class="string">'utf-8'</span>))</span><br><span class="line">        <span class="comment"># 解析数据不是字典而是字符串类型，要safe=False</span></span><br><span class="line">        <span class="keyword">return</span> JsonResponse(course, safe=<span class="literal">False</span>)  <span class="comment"># safe默认True</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse</span><br><span class="line"><span class="comment"># 对于POST请求，用装饰器，取消csrf的限制，就不用setting里面去注释掉了。</span></span><br><span class="line"><span class="keyword">from</span> django.views.decorators.csrf <span class="keyword">import</span> csrf_exempt</span><br><span class="line"></span><br><span class="line">course_dict = {<span class="string">'name'</span>: <span class="string">"课程"</span>, <span class="string">'introduction'</span>: <span class="string">"课程简介"</span>, <span class="string">'price'</span>: <span class="string">"课程价格"</span>}</span><br><span class="line"></span><br><span class="line"><span class="meta">@csrf_exempt</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">course_list</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'GET'</span>:</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(json.dumps(course_dict), content_type=<span class="string">'application/json'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</span><br><span class="line">        course = json.loads(request.body.decode(<span class="string">'utf-8'</span>))  <span class="comment"># request.body.decode()获取前端数据</span></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(json.dumps(course), content_type=<span class="string">'application/json'</span>)</span><br></pre></td></tr></tbody></table></figure>

<h3 id="CBV-Classed-Based-View-基于类的视图"><a href="#CBV-Classed-Based-View-基于类的视图" class="headerlink" title="CBV Classed Based View 基于类的视图"></a>CBV Classed Based View 基于类的视图</h3><figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> JsonResponse</span><br><span class="line"><span class="keyword">from</span> django.views <span class="keyword">import</span> View</span><br><span class="line"><span class="keyword">from</span> django.views.decorators.csrf <span class="keyword">import</span> csrf_exempt</span><br><span class="line"></span><br><span class="line">course_dict = {<span class="string">'name'</span>: <span class="string">"课程"</span>, <span class="string">'introduction'</span>: <span class="string">"课程简介"</span>, <span class="string">'price'</span>: <span class="string">"课程价格"</span>}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CourseList</span>(<span class="params">View</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        <span class="keyword">return</span> JsonResponse(course_dict)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @csrf_exempt</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        course = json.loads(request.body.decode(<span class="string">'utf-8'</span>))  <span class="comment"># request.body.decode()获取前端数据</span></span><br><span class="line">        <span class="comment"># 解析数据不是字典而是字符串类型，要safe=False</span></span><br><span class="line">        <span class="keyword">return</span> JsonResponse(course, safe=<span class="literal">False</span>)  <span class="comment"># safe默认True</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Json</span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse</span><br><span class="line"><span class="keyword">from</span> django.views <span class="keyword">import</span> View</span><br><span class="line"><span class="keyword">from</span> django.views.decorators.csrf <span class="keyword">import</span> csrf_exempt</span><br><span class="line"></span><br><span class="line">course_dict = {<span class="string">'name'</span>: <span class="string">"课程"</span>, <span class="string">'introduction'</span>: <span class="string">"课程简介"</span>, <span class="string">'price'</span>: <span class="string">"课程价格"</span>}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CourseList</span>(<span class="params">View</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(json.dumps(course_dict), content_type=<span class="string">'application/json'</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @csrf_exempt</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        course = json.loads(request.body.decode(<span class="string">'utf-8'</span>))  <span class="comment"># request.body.decode()获取前端数据</span></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(json.dumps(course), content_type=<span class="string">'application/json'</span>)</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.views <span class="keyword">import</span> View</span><br><span class="line"><span class="keyword">from</span> django.utils.decorators <span class="keyword">import</span> method_decorator</span><br><span class="line">course_dict = {<span class="string">'name'</span>: <span class="string">"课程"</span>, <span class="string">'introduction'</span>: <span class="string">"课程简介"</span>, <span class="string">'price'</span>: <span class="string">"课程价格"</span>}</span><br><span class="line"></span><br><span class="line"><span class="meta">@method_decorator(csrf_exempt, name='dispatch')  # 不是post，是由django的请求响应原理决定的，</span></span><br><span class="line"><span class="comment"># 当http request拿到的时候，首先到达dispatch方法，通过dispatch方法处理后再找到post方法</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CourseList</span>(<span class="params">View</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        <span class="keyword">return</span> JsonResponse(course_dict)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        course = json.loads(request.body.decode(<span class="string">'utf-8'</span>))  <span class="comment"># request.body.decode()获取前端数据</span></span><br><span class="line">    <span class="comment"># 解析数据不是字典而是字符串类型，要safe=False</span></span><br><span class="line">        <span class="keyword">return</span> JsonResponse(course, safe=<span class="literal">False</span>)  <span class="comment"># safe默认True</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="视图实现商品列表-最好用序列化"><a href="#视图实现商品列表-最好用序列化" class="headerlink" title="视图实现商品列表 最好用序列化"></a>视图实现商品列表 最好用序列化</h3><h4 id="麻烦的方法"><a href="#麻烦的方法" class="headerlink" title="麻烦的方法"></a>麻烦的方法</h4><p>通过在新建列表、其元素为单个商品信息组成的字典，当字段比较多时，一个字段一个字段的提取</p>
<p>有些字段不能直接用<code>json.dumps()</code>方法序列化，如datetime，会报错<code>TypeError: Object of type date is not JSON serializable</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.views.generic <span class="keyword">import</span> View</span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse, JsonResponse</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> goods.models <span class="keyword">import</span> Goods</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GoodsListView</span>(<span class="params">View</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        json_list = []</span><br><span class="line">        <span class="comment"># 获取所有商品</span></span><br><span class="line">        goods = Goods.objects.all()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> good <span class="keyword">in</span> goods:</span><br><span class="line">            json_dict = {}</span><br><span class="line">            <span class="comment"># 获取商品的每个字段，键值对形式</span></span><br><span class="line">            json_dict[<span class="string">'name'</span>] = good.name</span><br><span class="line">            json_dict[<span class="string">'category'</span>] = good.category.name</span><br><span class="line">            json_dict[<span class="string">'market_price'</span>] = good.market_price</span><br><span class="line">            json_list.append(json_dict)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># HttpResponse返回json，一定要指定类型content_type='application/json'</span></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(json.dumps(json_list), content_type=<span class="string">'application/json'</span>)</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.views.generic <span class="keyword">import</span> View</span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse, JsonResponse</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> goods.models <span class="keyword">import</span> Goods</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GoodsListView</span>(<span class="params">View</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        json_list = []</span><br><span class="line">        <span class="comment"># 获取所有商品</span></span><br><span class="line">        goods = Goods.objects.all()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> good <span class="keyword">in</span> goods:</span><br><span class="line">            json_dict = {}</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 获取商品的每个字段，键值对形式</span></span><br><span class="line">            json_dict[<span class="string">'name'</span>] = good.name</span><br><span class="line">            json_dict[<span class="string">'category'</span>] = good.category.name</span><br><span class="line">            json_dict[<span class="string">'market_price'</span>] = good.market_price</span><br><span class="line">            json_list.append(json_dict)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> JsonResponse(json_list, safe=<span class="literal">False</span>)</span><br></pre></td></tr></tbody></table></figure>

<h4 id="model-to-dict-实现直接将模型数据转化为字典形式"><a href="#model-to-dict-实现直接将模型数据转化为字典形式" class="headerlink" title="model_to_dict()实现直接将模型数据转化为字典形式"></a><code>model_to_dict()</code>实现直接将模型数据转化为字典形式</h4><p>但是对于<code>DateTimeField</code>、<code>ImageField</code>等字段时还是无法序列化</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.views.generic <span class="keyword">import</span> View</span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse, JsonResponse</span><br><span class="line"><span class="keyword">from</span> django.forms.models <span class="keyword">import</span> model_to_dict</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> goods.models <span class="keyword">import</span> Goods</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GoodsListView</span>(<span class="params">View</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        json_list = []</span><br><span class="line">        <span class="comment"># 获取所有商品</span></span><br><span class="line">        goods = Goods.objects.all()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> good <span class="keyword">in</span> goods:</span><br><span class="line">            json_dict = model_to_dict(good)</span><br><span class="line">            json_list.append(json_dict)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># HttpResponse返回json，一定要指定类型content_type='application/json'</span></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(json.dumps(json_list), content_type=<span class="string">'application/json'</span>)</span><br><span class="line">        <span class="comment"># return JsonResponse(json_list, safe=False)</span></span><br></pre></td></tr></tbody></table></figure>

<p>users/view.py</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">users</span>(<span class="params">request</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</span><br><span class="line">        course = json.loads(request.body.decode(<span class="string">'utf-8'</span>))  <span class="comment"># request.body.decode()获取前端数据</span></span><br><span class="line">        <span class="comment"># 解析数据不是字典而是字符串类型，要safe=False</span></span><br><span class="line">        <span class="keyword">return</span> JsonResponse(course, safe=<span class="literal">False</span>)  <span class="comment"># safe默认True</span></span><br></pre></td></tr></tbody></table></figure><script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/05/06/drf-shu-ju-fen-ye/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/06/drf-shu-ju-fen-ye/" class="post-title-link" itemprop="url">DRF数据分页</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-05-05 16:21:41" itemprop="dateCreated datePublished" datetime="2021-05-05T16:21:41Z">2021-05-05</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-06-05 08:08:08" itemprop="dateModified" datetime="2021-06-05T08:08:08Z">2021-06-05</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/django/" itemprop="url" rel="index"><span itemprop="name">django</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="数据分页"><a href="#数据分页" class="headerlink" title="数据分页"></a>数据分页</h3><p>在使用GET请求获取资源列表时，我们通常不会一次性的加载所有的数据，除非数据量真的很小。<br>大多数获取资源列表的操作都支持数据分页展示，<br>也就说我们可以通过指定页码（或类似于页码的标识）和页面大小（一次加载多少条数据）来获取不同的数据。<br>我们可以通过对<code>QuerySet</code>对象的切片操作来实现分页，也可以利用Django框架封装的<code>Paginator</code>和<code>Page</code>对象来实现分页。</p>
<p><code>rest_framework/settings.py</code>源码 DRF 默认分页</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Generic view behavior</span></span><br><span class="line"><span class="string">'DEFAULT_PAGINATION_CLASS'</span>: <span class="literal">None</span>,  <span class="comment"># 默认没有分页功能</span></span><br><span class="line"><span class="string">'DEFAULT_FILTER_BACKENDS'</span>: (),</span><br><span class="line"></span><br><span class="line"><span class="comment"># Pagination</span></span><br><span class="line"><span class="string">'PAGE_SIZE'</span>: <span class="literal">None</span>,</span><br></pre></td></tr></tbody></table></figure>

<p>使用DRF时，可以在Django配置文件中修改<code>REST_FRAMEWORK</code>并配置默认的分页类和页面大小来实现分页，<br>包括了总数、当前页的上一页、下一页等信息，并且图片地址也添加了域名、成为可访问的完整路径。</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">REST_FRAMEWORK = {</span><br><span class="line">    <span class="string">'PAGE_SIZE'</span>: <span class="number">10</span>,  <span class="comment"># #每页显示的个数</span></span><br><span class="line">    <span class="string">'DEFAULT_PAGINATION_CLASS'</span>: <span class="string">'rest_framework.pagination.PageNumberPagination'</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>除了上面配置的<code>PageNumberPagination</code>分页器之外，DRF还提供了<code>LimitOffsetPagination</code>和<code>CursorPagination</code>分页器，值得一提的是<code>CursorPagination</code>，它可以避免使用页码分页时暴露网站的数据体量，有兴趣的读者可以自行了解。</p>
<p>如果不希望使用配置文件中默认的分页设定，可以在视图类中添加一个<code>pagination_class</code>属性来重新指定分页器，通常可以将该属性指定为自定义的分页器，如下所示。</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.pagination <span class="keyword">import</span> PageNumberPagination</span><br><span class="line"><span class="keyword">from</span> django.utils.translation <span class="keyword">import</span> ugettext_lazy</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CustomizedPagination</span>(<span class="params">PageNumberPagination</span>):</span></span><br><span class="line">    page_size = <span class="number">5</span>  <span class="comment"># 默认每页显示的个数</span></span><br><span class="line">    max_page_size = <span class="number">50</span>  <span class="comment"># 最多能显示多少页</span></span><br><span class="line">    page_size_query_param = <span class="string">'size'</span>  <span class="comment"># 页面大小对应的查询参数</span></span><br><span class="line">    page_query_param = <span class="string">'page'</span>  <span class="comment"># 页码参数</span></span><br><span class="line">    page_query_description = ugettext_lazy(<span class="string">'使用分页后的页码'</span>)  <span class="comment"># 分页文档中文描述</span></span><br><span class="line">    page_size_query_description = ugettext_lazy(<span class="string">'每页返回的结果数'</span>)</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SubjectView</span>(<span class="params">ListAPIView</span>):</span></span><br><span class="line">    <span class="comment"># 指定如何获取数据</span></span><br><span class="line">    queryset = Subject.objects.all()</span><br><span class="line">    <span class="comment"># 指定如何序列化数据</span></span><br><span class="line">    serializer_class = SubjectSerializer</span><br><span class="line">    <span class="comment"># 指定如何分页</span></span><br><span class="line">    pagination_class = CustomizedPagination</span><br></pre></td></tr></tbody></table></figure>

<p>如果不希望数据分页，可以将<code>pagination_class</code>属性设置为<code>None</code>来取消默认的分页器。</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/05/06/drf-shi-tu-kai-fa-restfulapi-jie-kou-de-fang-shi/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/06/drf-shi-tu-kai-fa-restfulapi-jie-kou-de-fang-shi/" class="post-title-link" itemprop="url">DRF视图开发RESTful API接口的方式</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-05-05 16:21:41" itemprop="dateCreated datePublished" datetime="2021-05-05T16:21:41Z">2021-05-05</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-07-01 13:52:35" itemprop="dateModified" datetime="2021-07-01T13:52:35Z">2021-07-01</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/django/" itemprop="url" rel="index"><span itemprop="name">django</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="DRF视图开发RESTful-API接口的方式"><a href="#DRF视图开发RESTful-API接口的方式" class="headerlink" title="DRF视图开发RESTful API接口的方式"></a>DRF视图开发RESTful API接口的方式</h1><blockquote>
<p>优点：集成了分页、排序、认证、权限、限流、文档生成，form和request bosy的输入检测<br>身份验证策略，包括OAuth1a和OAuth2的软件包；<br>支持ORM和非ORM数据源的序列化；<br>完全可自定义；<br>广泛的文档资料以及强大的社区支持。</p>
</blockquote>
<h2 id="基于函数的视图-Function-Based-View"><a href="#基于函数的视图-Function-Based-View" class="headerlink" title="基于函数的视图 Function Based View"></a>基于函数的视图 Function Based View</h2><p>灵活，一个接口对应一个函数，面向过程的方式重复率高，要自己实现的东西多</p>
<h3 id="获取所有课程信息或新增一个课程"><a href="#获取所有课程信息或新增一个课程" class="headerlink" title="获取所有课程信息或新增一个课程"></a>获取所有课程信息或新增一个课程</h3><p><code>course\views.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> status</span><br><span class="line"><span class="keyword">from</span> rest_framework.authentication <span class="keyword">import</span> BasicAuthentication, SessionAuthentication, TokenAuthentication</span><br><span class="line"><span class="keyword">from</span> rest_framework.decorators <span class="keyword">import</span> api_view, authentication_classes, permission_classes</span><br><span class="line"><span class="keyword">from</span> rest_framework.permissions <span class="keyword">import</span> IsAuthenticated</span><br><span class="line"><span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Course</span><br><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> CourseSerializer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@api_view(["GET", "POST"])</span></span><br><span class="line"><span class="meta">@authentication_classes(</span></span><br><span class="line">    (BasicAuthentication, SessionAuthentication, TokenAuthentication))</span><br><span class="line"><span class="meta">@permission_classes((IsAuthenticated, ))</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">course_list</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    获取所有课程信息或新增一个课程</span></span><br><span class="line"><span class="string">    :param request:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">"GET"</span>:</span><br><span class="line">        <span class="comment"># 创建序列化器对象并指定要序列化的模型，序列化课程的所有字段</span></span><br><span class="line">        s = CourseSerializer(instance=Course.objects.all(), many=<span class="literal">True</span>)</span><br><span class="line">        <span class="comment"># 通过序列化器从模型类里面拿到数据的data属性获得模型对应的字典并通过创建Response对象返回JSON格式的数据</span></span><br><span class="line">        print(type(request), type(request.data), type(s), type(s.data))</span><br><span class="line">        <span class="comment"># &lt;class 'rest_framework.request.Request'&gt; &lt;class 'dict'&gt; &lt;class 'rest_framework.serializers.ListSerializer'&gt; &lt;class 'rest_framework.utils.serializer_helpers.ReturnList'&gt;</span></span><br><span class="line">        <span class="keyword">return</span> Response(data=s.data, status=status.HTTP_200_OK)  <span class="comment"># 获取当然有返回对应的数据给前端</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">elif</span> request.method == <span class="string">"POST"</span>:</span><br><span class="line">        <span class="comment"># 反序列化：前端POST过来的数据request.data转换成django能够识别的queryset或模型类实例instance</span></span><br><span class="line">        s = CourseSerializer(data=request.data)</span><br><span class="line">        <span class="comment"># partial=True属性使字段 `required=True` 校验规则失效，</span></span><br><span class="line">        <span class="comment"># 适用于非必填的字段部分更新用，前端传递的数据比django ORM的模型类的字段要少</span></span><br><span class="line">        <span class="comment"># 如果把这个字段设置为主键或必填的字段（没有设置null=True，blank=True），那前端必须传过来，否则is_valid()为False</span></span><br><span class="line">        <span class="comment"># 对数据进行校验是否符合定义的字段属性再返回</span></span><br><span class="line">        <span class="keyword">if</span> s.is_valid():</span><br><span class="line">            <span class="comment"># 模型类.save()方法会调用create()函数保存对象实例，相当于执行了创建数据的sql语句，序列化时只可读属性前端不能传过来</span></span><br><span class="line">            <span class="comment"># request可以获取当前登录的用户，是哪一个用户post过来的就把它设为讲师，</span></span><br><span class="line">            <span class="comment"># 因为前端用户已经登录了，POST创建的course实例数据时没有teacher这个外键字段的，但又是模型类必填的，把课程信息的讲师设为自己登录的这个用户</span></span><br><span class="line">            s.save(teacher=request.user)</span><br><span class="line">            print(type(request), type(request.data), type(s), type(s.data))</span><br><span class="line">            <span class="comment"># &lt;class 'rest_framework.request.Request'&gt; &lt;class 'dict'&gt; &lt;class 'course.serializers.CourseSerializer'&gt; &lt;class 'rest_framework.utils.serializer_helpers.ReturnDict'&gt;</span></span><br><span class="line">            <span class="keyword">return</span> Response(data=s.data,</span><br><span class="line">                            status=status.HTTP_201_CREATED)  <span class="comment"># 反序列化后的数据返回给前端</span></span><br><span class="line">        <span class="keyword">return</span> Response(s.errors, status=status.HTTP_400_BAD_REQUEST)  <span class="comment"># 新增当然有返回对应的数据给前端</span></span><br></pre></td></tr></tbody></table></figure>

<p>配置URL映射 <code>course\urls.py</code> 域名：应该尽量将 API 部署在专用域名之</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path, include</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> course <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    <span class="comment"># Function Based View</span></span><br><span class="line">    <span class="comment"># 获取所有课程信息或新增一个课程</span></span><br><span class="line">    path(<span class="string">"fbv/list/"</span>, views.course_list, name=<span class="string">"fbv-list"</span>),</span><br><span class="line">]</span><br></pre></td></tr></tbody></table></figure>

<p>DRF本身自带了一套页面，可以方便我们查看我们使用DRF定制的数据接口，如下图所示。<br><img src="/2021/05/06/drf-shi-tu-kai-fa-restfulapi-jie-kou-de-fang-shi/0.png" alt="http://127.0.0.1:8000/course/fbv/list/"></p>
<p>POST请求添加数据</p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"Python体验课"</span>,</span><br><span class="line">    <span class="attr">"introduction"</span>: <span class="string">"9元包邮"</span>,</span><br><span class="line">    <span class="attr">"price"</span>: <span class="string">"9.00"</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><code>id</code> 不需要，<code>teacher</code> 是当前已登录的用户，<code>created_at</code> 和 <code>updated_at</code> django ORM 会自动加上</p>
<p><img src="/2021/05/06/drf-shi-tu-kai-fa-restfulapi-jie-kou-de-fang-shi/2.png" alt="description"></p>
<h3 id="获取一个课程的详细信息、更新、删除一个课程"><a href="#获取一个课程的详细信息、更新、删除一个课程" class="headerlink" title="获取一个课程的详细信息、更新、删除一个课程"></a>获取一个课程的详细信息、更新、删除一个课程</h3><p><code>course\views.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> status</span><br><span class="line"><span class="keyword">from</span> rest_framework.authentication <span class="keyword">import</span> BasicAuthentication, SessionAuthentication, TokenAuthentication</span><br><span class="line"><span class="keyword">from</span> rest_framework.decorators <span class="keyword">import</span> api_view, authentication_classes, permission_classes</span><br><span class="line"><span class="keyword">from</span> rest_framework.permissions <span class="keyword">import</span> IsAuthenticated</span><br><span class="line"><span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Course</span><br><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> CourseSerializer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">"""一、 函数式编程 Function Based View"""</span></span><br><span class="line"><span class="meta">@api_view(["GET", "PUT", "DELETE"])</span></span><br><span class="line"><span class="comment"># 对象级别的设置优先全局设置</span></span><br><span class="line"><span class="meta">@authentication_classes(</span></span><br><span class="line">    (BasicAuthentication, SessionAuthentication, TokenAuthentication))</span><br><span class="line"><span class="meta">@permission_classes((IsAuthenticated, ))</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">course_detail</span>(<span class="params">request, pk</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    获取一个课程的详细信息、更新、删除一个课程</span></span><br><span class="line"><span class="string">    :param request:</span></span><br><span class="line"><span class="string">    :param pk: url传递过来的主键</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 通过pk获取课程的queryset</span></span><br><span class="line">        course = Course.objects.get(pk=pk)</span><br><span class="line">    <span class="keyword">except</span> Course.DoesNotExist:  <span class="comment"># 前端传递过来的pk在数据表查不到，不存在</span></span><br><span class="line">        <span class="keyword">return</span> Response(data={<span class="string">"msg"</span>: <span class="string">"没有此课程信息"</span>},</span><br><span class="line">                        status=status.HTTP_404_NOT_FOUND)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">if</span> request.method == <span class="string">"GET"</span>:</span><br><span class="line">            s = CourseSerializer(instance=course)</span><br><span class="line">            print(type(request), type(request.data), type(s), type(s.data))</span><br><span class="line">            <span class="comment"># &lt;class 'rest_framework.request.Request'&gt; &lt;class 'dict'&gt; &lt;class 'course.serializers.CourseSerializer'&gt; &lt;class 'rest_framework.utils.serializer_helpers.ReturnDict'&gt;</span></span><br><span class="line">            <span class="keyword">return</span> Response(data=s.data, status=status.HTTP_200_OK)  <span class="comment"># 获取当然有返回对应的数据给前端</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span> request.method == <span class="string">"PUT"</span>:</span><br><span class="line">            s = CourseSerializer(instance=course, data=request.data)</span><br><span class="line">            <span class="comment"># `instance` 要序列化的查询集实例，要序列化的 `course` 是查询出来的实例</span></span><br><span class="line">            <span class="comment"># `data` 数据哪里来的，`request.data` 是前端传递过来的数据，，就是Postman body里面 raw-json的数据</span></span><br><span class="line">            <span class="comment"># 把`data`的数据序列化后保存或跟新到 `course` 这个对象里面</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> s.is_valid():</span><br><span class="line">                s.save()  <span class="comment"># 不用像POST请求一样设置teacher字段为当前登录的用户，</span></span><br><span class="line">                <span class="comment"># PUT为更新操作，这条数据teacher字段已经有了并且是登录用户，是当前登录用户更改自己的数据，不能把别人的课程改成自己是讲师</span></span><br><span class="line">                print(type(request), type(request.data), type(s), type(s.data))</span><br><span class="line">                <span class="comment"># &lt;class 'rest_framework.request.Request'&gt; &lt;class 'dict'&gt; &lt;class 'course.serializers.CourseSerializer'&gt; &lt;class 'rest_framework.utils.serializer_helpers.ReturnDict'&gt;</span></span><br><span class="line">                <span class="keyword">return</span> Response(data=s.data, status=status.HTTP_200_OK)  <span class="comment"># 更新当然有返回数据</span></span><br><span class="line">            <span class="keyword">return</span> Response(data=s.errors, status=status.HTTP_400_BAD_REQUEST)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span> request.method == <span class="string">"DELETE"</span>:</span><br><span class="line">            course.delete()</span><br><span class="line">            <span class="keyword">return</span> Response(status=status.HTTP_204_NO_CONTENT)  <span class="comment"># 删除不返回数据，只返回状态码</span></span><br></pre></td></tr></tbody></table></figure>

<p>配置URL映射<code>course\urls.py</code> 域名：应该尽量将 API 部署在专用域名之</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path, include</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> course <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    <span class="comment"># Function Based View</span></span><br><span class="line">    <span class="comment"># 获取一个课程的详细信息、更新、删除一个课程，类型是int，名称是pk</span></span><br><span class="line">    path(<span class="string">"fbv/detail/&lt;int:pk&gt;/"</span>, views.course_detail, name=<span class="string">"fbv-detail"</span>),  <span class="comment"># 结尾的/不能少</span></span><br><span class="line">]</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/05/06/drf-shi-tu-kai-fa-restfulapi-jie-kou-de-fang-shi/3.png" alt="'http://127.0.0.1:8000/course/fbv/detail/1/'"></p>
<h2 id="基于类的视图-Classed-Based-View-继承APIView的子类"><a href="#基于类的视图-Classed-Based-View-继承APIView的子类" class="headerlink" title="基于类的视图 Classed Based View 继承APIView的子类"></a>基于类的视图 Classed Based View 继承<code>APIView</code>的子类</h2><p>可以用到python类的特性，封装继承多态，减少代码重复率<br>如果不定义HTTP方法，默认不接受改请求<br>可以通过pycharm External Libraries - Lib - site-packages - rest_framework-generics.py选中 - 旁边的structure<br>列出所有的APIView可以继承</p>
<p><code>APIView</code>源码的常用属性和方法</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">APIView</span>(<span class="params">View</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># The following policies may be set at either globally, or per-view.</span></span><br><span class="line">    renderer_classes = api_settings.DEFAULT_RENDERER_CLASSES</span><br><span class="line">    parser_classes = api_settings.DEFAULT_PARSER_CLASSES</span><br><span class="line">    authentication_classes = api_settings.DEFAULT_AUTHENTICATION_CLASSES</span><br><span class="line">    throttle_classes = api_settings.DEFAULT_THROTTLE_CLASSES</span><br><span class="line">    permission_classes = api_settings.DEFAULT_PERMISSION_CLASSES</span><br><span class="line">    content_negotiation_class = api_settings.DEFAULT_CONTENT_NEGOTIATION_CLASS</span><br><span class="line">    metadata_class = api_settings.DEFAULT_METADATA_CLASS</span><br><span class="line">    versioning_class = api_settings.DEFAULT_VERSIONING_CLASS</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_authenticators</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        Instantiates and returns the list of authenticators that this view can use.认证</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">return</span> [auth() <span class="keyword">for</span> auth <span class="keyword">in</span> self.authentication_classes]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_permissions</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        Instantiates and returns the list of permissions that this view requires.</span></span><br><span class="line"><span class="string">        遍历此视图所需的权限列表并实例化返回。</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">return</span> [permission() <span class="keyword">for</span> permission <span class="keyword">in</span> self.permission_classes]  <span class="comment"># 一定要加()表明返回它的实例</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_throttles</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        Instantiates and returns the list of throttles that this view uses.限流 防爬虫</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">return</span> [throttle() <span class="keyword">for</span> throttle <span class="keyword">in</span> self.throttle_classes]</span><br></pre></td></tr></tbody></table></figure>

<p><code>APIView</code>是REST framework提供的所有视图的基类，继承自Django的<code>View</code>父类。<br>在APIView中仍以常规的类视图定义方法来实现get() 、post() 或者其他请求方式的方法。</p>
<p><code>APIView</code>与<code>View</code>的不同之处在于</p>
<ul>
<li>传入到视图方法中的是REST framework的Request对象，而不是Django的HttpRequeset对象；<br>获取前端数据<code>request.data</code>代替<code>json.loads(request.body.decode())</code></li>
<li>视图方法可以返回REST framework的Response对象，视图会为响应数据设置（render）符合前端要求的格式；</li>
<li>任何<code>APIException</code>异常都会被捕获到，并且处理成合适的响应信息；</li>
<li>在进行dispatch()分发前，会对请求进行身份认证、权限检查、流量控制。</li>
</ul>
<p>代码简单，开发效率高，<br>没有FBV（基于函数的视图）灵活，因为使用FBV的方式，数据接口对应的视图函数执行什么样的代码以及返回什么的数据是高度可定制的。</p>
<h3 id="获取所有课程信息或新增一个课程-1"><a href="#获取所有课程信息或新增一个课程-1" class="headerlink" title="获取所有课程信息或新增一个课程"></a>获取所有课程信息或新增一个课程</h3><p><code>course\views.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> status</span><br><span class="line"><span class="keyword">from</span> rest_framework.authentication <span class="keyword">import</span> BasicAuthentication, SessionAuthentication, TokenAuthentication</span><br><span class="line"><span class="keyword">from</span> rest_framework.decorators <span class="keyword">import</span> permission_classes</span><br><span class="line"><span class="keyword">from</span> rest_framework.permissions <span class="keyword">import</span> IsAuthenticated</span><br><span class="line"><span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> APIView</span><br><span class="line"><span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Course</span><br><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> CourseSerializer</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CourseListView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="comment"># 获取所有课程信息或新增一个课程</span></span><br><span class="line">    authentication_classes = (BasicAuthentication, SessionAuthentication, TokenAuthentication)</span><br><span class="line">    permission_classes = (IsAuthenticated, )  <span class="comment"># settings.py中已设置，此处是多余的</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        获取数据列表并返回JSON数据</span></span><br><span class="line"><span class="string">        :param request:</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        queryset = Course.objects.all()  <span class="comment"># APIView没有queryset属性</span></span><br><span class="line">        s = CourseSerializer(instance=queryset, many=<span class="literal">True</span>)  <span class="comment"># 这里是instance = xx 查询集</span></span><br><span class="line">        print(type(request), type(request.data), type(s), type(s.data))</span><br><span class="line">        <span class="comment"># &lt;class 'rest_framework.request.Request'&gt; &lt;class 'dict'&gt; &lt;class 'rest_framework.serializers.ListSerializer'&gt; &lt;class 'rest_framework.utils.serializer_helpers.ReturnList'&gt;</span></span><br><span class="line">        <span class="keyword">return</span> Response(s.data, status=status.HTTP_200_OK)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        s = CourseSerializer(</span><br><span class="line">            data=request.data)  <span class="comment"># 这里是data = xx, return前要先调用.is_valid()</span></span><br><span class="line">        <span class="keyword">if</span> s.is_valid():</span><br><span class="line">            s.save(teacher=self.request.user)  <span class="comment"># 外键teacher</span></span><br><span class="line">            print(type(request.data), type(s), type(s.data))</span><br><span class="line">            <span class="comment"># &lt;class 'dict'&gt; &lt;class 'course.serializers.CourseSerializer'&gt; &lt;class 'rest_framework.utils.serializer_helpers.ReturnDict'&gt;</span></span><br><span class="line">            <span class="keyword">return</span> Response(data=s.data, status=status.HTTP_201_CREATED)</span><br><span class="line">        <span class="keyword">return</span> Response(data=s.errors, status=status.HTTP_400_BAD_REQUEST)</span><br></pre></td></tr></tbody></table></figure>

<p><code>course\urls.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">urlpatterns = [</span><br><span class="line">    <span class="comment"># Class Based View</span></span><br><span class="line">    path(<span class="string">"cbv/list/"</span>, views.CourseListView.as_view(), name=<span class="string">"cbv-list"</span>),</span><br><span class="line">]</span><br></pre></td></tr></tbody></table></figure>

<h3 id="获取一个课程的详细信息、更新、删除一个课程-1"><a href="#获取一个课程的详细信息、更新、删除一个课程-1" class="headerlink" title="获取一个课程的详细信息、更新、删除一个课程"></a>获取一个课程的详细信息、更新、删除一个课程</h3><p><code>course\views.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> status</span><br><span class="line"><span class="keyword">from</span> rest_framework.authentication <span class="keyword">import</span> BasicAuthentication, SessionAuthentication, TokenAuthentication</span><br><span class="line"><span class="keyword">from</span> rest_framework.decorators <span class="keyword">import</span> permission_classes</span><br><span class="line"><span class="keyword">from</span> rest_framework.permissions <span class="keyword">import</span> IsAuthenticated</span><br><span class="line"><span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> APIView</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CourseDetailView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    authentication_classes = (BasicAuthentication, SessionAuthentication, TokenAuthentication)</span><br><span class="line">    permission_classes = (IsAuthenticated, )</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod  # 没有用到self</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_object</span>(<span class="params">pk</span>):</span></span><br><span class="line">        <span class="comment"># 获取实例对象</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> Course.objects.get(pk=pk)</span><br><span class="line">        <span class="keyword">except</span> Course.DoesNotExist:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request, pk</span>):</span></span><br><span class="line">        obj = self.get_object(pk=pk)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> obj:</span><br><span class="line">            <span class="keyword">return</span> Response(data={<span class="string">"msg"</span>: <span class="string">"没有此课程信息"</span>},</span><br><span class="line">                            status=status.HTTP_404_NOT_FOUND)</span><br><span class="line"></span><br><span class="line">        s = CourseSerializer(instance=obj)</span><br><span class="line">        <span class="keyword">return</span> Response(s.data, status=status.HTTP_200_OK)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put</span>(<span class="params">self, request, pk</span>):</span></span><br><span class="line">        obj = self.get_object(pk=pk)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> obj:</span><br><span class="line">            <span class="keyword">return</span> Response(data={<span class="string">"msg"</span>: <span class="string">"没有此课程信息"</span>},</span><br><span class="line">                            status=status.HTTP_404_NOT_FOUND)</span><br><span class="line"></span><br><span class="line">        s = CourseSerializer(instance=obj, data=request.data)  <span class="comment"># 反序列化</span></span><br><span class="line">        <span class="keyword">if</span> s.is_valid():</span><br><span class="line">            s.save()</span><br><span class="line">            <span class="keyword">return</span> Response(data=s.data, status=status.HTTP_200_OK)</span><br><span class="line">        <span class="keyword">return</span> Response(data=s.errors, status=status.HTTP_400_BAD_REQUEST)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">self, request, pk</span>):</span></span><br><span class="line">        obj = self.get_object(pk=pk)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> obj:</span><br><span class="line">            <span class="keyword">return</span> Response(data={<span class="string">"msg"</span>: <span class="string">"没有此课程信息"</span>},</span><br><span class="line">                            status=status.HTTP_404_NOT_FOUND)</span><br><span class="line">        obj.delete()</span><br><span class="line">        <span class="keyword">return</span> Response(status=status.HTTP_204_NO_CONTENT)</span><br></pre></td></tr></tbody></table></figure>

<p><code>course\urls.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">urlpatterns = [</span><br><span class="line">    <span class="comment"># Class Based View</span></span><br><span class="line">    path(<span class="string">"cbv/detail/&lt;int:pk&gt;/"</span>,</span><br><span class="line">         views.CourseDetailView.as_view(),</span><br><span class="line">         name=<span class="string">"cbv-detail"</span>),</span><br><span class="line">]</span><br></pre></td></tr></tbody></table></figure>

<h2 id="通用类视图-Generic-Classed-Based-View-GenericAPIView-整合了增删改查的类"><a href="#通用类视图-Generic-Classed-Based-View-GenericAPIView-整合了增删改查的类" class="headerlink" title="通用类视图 Generic Classed Based View GenericAPIView 整合了增删改查的类"></a>通用类视图 Generic Classed Based View <code>GenericAPIView</code> 整合了增删改查的类</h2><p>This class extends REST framework’s <code>APIView</code> class, adding commonly required behavior for standard list and detail views.</p>
<p>Each of the concrete generic views provided is built by combining <code>GenericAPIView</code>, with one or more mixin classes.</p>
<h3 id="Attributes"><a href="#Attributes" class="headerlink" title="Attributes"></a>Attributes</h3><p>Basic settings:</p>
<p>The following attributes control the basic view behavior.</p>
<ul>
<li><code>queryset</code> - The queryset that should be used for returning objects from this view.  指定当前类视图如何获取查询集数据<br>Typically, you must either set this attribute, or override the <code>get_queryset()</code> method.<br>If you are overriding a view method, it is important that you call <code>get_queryset()</code> instead of accessing this property directly, as <code>queryset</code> will get evaluated once, and those results will be cached for all subsequent requests.用于从视图返回对象的查询结果集。<br>通常，你必须设置此属性或者重写<code>get_queryset()</code> 方法。如果你重写了一个视图的方法，重要的是你应该调用 <code>get_queryset()</code> 方法而不是直接访问该属性，因为 <code>queryset</code> 将被计算一次，这些结果将为后续请求缓存起来。</li>
</ul>
<ul>
<li><p><code>serializer_class</code> - The serializer class that should be used for validating and deserializing input, and for serializing output.<br>Typically, you must either set this attribute, or override the <code>get_serializer_class()</code> method.<br>用于验证和反序列化输入以及用于序列化输出的Serializer类。<br>通常，你必须设置此属性或者重写<code>get_serializer_class()</code> 方法。指定当前类视图如何序列化数据</p>
</li>
<li><p><code>lookup_field</code> - The model field that should be used to for performing object lookup of individual model instances. Defaults to <code>'pk'</code>. Note that when using hyperlinked APIs you’ll need to ensure that both the API views and the serializer classes set the lookup fields if you need to use a custom value.用于执行单个模型实例的对象查找的模型字段，默认为 <code>'pk'</code>，即主键。 即查询单一数据库对象时使用的条件字段<br>请注意，在使用超链接API时，如果需要使用自定义的值，你需要确保在API视图和序列化类都设置查找字段。</p>
</li>
<li><p><code>lookup_url_kwarg</code> - The URL keyword argument that should be used for object lookup. The URL conf should include a keyword argument corresponding to this value. If unset this defaults to using the same value as <code>lookup_field</code>.应用于对象查找的URL关键字参数。它的 URL conf 应该包括一个与这个值相对应的关键字参数。如果取消设置，默认情况下使用与 <code>lookup_field</code>相同的值。</p>
</li>
</ul>
<p>继承自<code>APIView</code>，在APIView的基础上实现过滤、分页等功能；</p>
<p>源码</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GenericAPIView</span>(<span class="params">views.APIView</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Base class for all other generic views.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># You'll need to either set these attributes,</span></span><br><span class="line">    <span class="comment"># or override `get_queryset()`/`get_serializer_class()`.</span></span><br><span class="line">    <span class="comment"># If you are overriding a view method, it is important that you call</span></span><br><span class="line">    <span class="comment"># `get_queryset()` instead of accessing the `queryset` property directly,</span></span><br><span class="line">    <span class="comment"># as `queryset` will get evaluated only once, and those results are cached</span></span><br><span class="line">    <span class="comment"># for all subsequent requests.</span></span><br><span class="line">    queryset = <span class="literal">None</span></span><br><span class="line">    serializer_class = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># If you want to use object lookups other than pk, set 'lookup_field'.</span></span><br><span class="line">    <span class="comment"># For more complex lookup requirements override `get_object()`.</span></span><br><span class="line">    lookup_field = <span class="string">'pk'</span></span><br><span class="line">    lookup_url_kwarg = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># The filter backend classes to use for queryset filtering</span></span><br><span class="line">    filter_backends = api_settings.DEFAULT_FILTER_BACKENDS</span><br><span class="line"></span><br><span class="line">    <span class="comment"># The style to use for queryset pagination.</span></span><br><span class="line">    pagination_class = api_settings.DEFAULT_PAGINATION_CLASS</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_queryset</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        Get the list of items for this view.指定获取视图查询集</span></span><br><span class="line"><span class="string">        主要用来提供给Mixin扩展类使用</span></span><br><span class="line"><span class="string">        This must be an iterable, and may be a queryset.</span></span><br><span class="line"><span class="string">        Defaults to using `self.queryset`.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        This method should always be used rather than accessing `self.queryset`</span></span><br><span class="line"><span class="string">        directly, as `self.queryset` gets evaluated only once, and those results</span></span><br><span class="line"><span class="string">        are cached for all subsequent requests.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        You may want to override this if you need to provide different</span></span><br><span class="line"><span class="string">        querysets depending on the incoming request.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        (Eg. return a list of items that is specific to the user)</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">assert</span> self.queryset <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>, (</span><br><span class="line">            <span class="string">"'%s' should either include a `queryset` attribute, "</span></span><br><span class="line">            <span class="string">"or override the `get_queryset()` method."</span></span><br><span class="line">            % self.__class__.__name__</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        queryset = self.queryset</span><br><span class="line">        <span class="keyword">if</span> isinstance(queryset, QuerySet):</span><br><span class="line">            <span class="comment"># Ensure queryset is re-evaluated on each request.</span></span><br><span class="line">            queryset = queryset.all()</span><br><span class="line">        <span class="keyword">return</span> queryset</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_object</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        Returns the object the view is displaying.返回视图显示的对象</span></span><br><span class="line"><span class="string">        主要用来提供给Mixin扩展类使用。</span></span><br><span class="line"><span class="string">        You may want to override this if you need to provide non-standard</span></span><br><span class="line"><span class="string">        queryset lookups. 如果需要提供非标准的查询集查找，则可能需要重写此项</span></span><br><span class="line"><span class="string">        Eg if objects are referenced using multiple</span></span><br><span class="line"><span class="string">        keyword arguments in the url conf.</span></span><br><span class="line"><span class="string">        例如，如果在url conf中使用多个关键字参数引用对象。</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        queryset = self.filter_queryset(self.get_queryset())</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Perform the lookup filtering.</span></span><br><span class="line">        lookup_url_kwarg = self.lookup_url_kwarg <span class="keyword">or</span> self.lookup_field  <span class="comment"># 默认根据主键pk值查询</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">assert</span> lookup_url_kwarg <span class="keyword">in</span> self.kwargs, (</span><br><span class="line">            <span class="string">'Expected view %s to be called with a URL keyword argument '</span></span><br><span class="line">            <span class="string">'named "%s". Fix your URL conf, or set the `.lookup_field` '</span></span><br><span class="line">            <span class="string">'attribute on the view correctly.'</span> %</span><br><span class="line">            (self.__class__.__name__, lookup_url_kwarg)</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        filter_kwargs = {self.lookup_field: self.kwargs[lookup_url_kwarg]}</span><br><span class="line">        <span class="comment"># 若详情访问的模型类对象不存在，会返回404。</span></span><br><span class="line">        obj = get_object_or_404(queryset, **filter_kwargs)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># May raise a permission denied  检查当前对象是否有权限被访问。</span></span><br><span class="line">        self.check_object_permissions(self.request, obj)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> obj</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_serializer</span>(<span class="params">self, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        Return the serializer instance that should be used for validating and</span></span><br><span class="line"><span class="string">        deserializing input, and for serializing output.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        serializer_class = self.get_serializer_class()</span><br><span class="line">        kwargs.setdefault(<span class="string">'context'</span>, self.get_serializer_context())</span><br><span class="line">        <span class="keyword">return</span> serializer_class(*args, **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_serializer_class</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        Return the class to use for the serializer.返回用于序列化的类。</span></span><br><span class="line"><span class="string">        Defaults to using `self.serializer_class`.默认使用self.serializer_class</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        You may want to override this if you need to provide different</span></span><br><span class="line"><span class="string">        serializations depending on the incoming request.</span></span><br><span class="line"><span class="string">        如果需要根据传入请求提供不同的序列化，则可能需要重写此项。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        (Eg. admins get full serialization, others get basic serialization)</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">assert</span> self.serializer_class <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>, (</span><br><span class="line">            <span class="string">"'%s' should either include a `serializer_class` attribute, "</span></span><br><span class="line">            <span class="string">"or override the `get_serializer_class()` method."</span></span><br><span class="line">            % self.__class__.__name__</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> self.serializer_class</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_serializer_context</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        Extra context provided to the serializer class.</span></span><br><span class="line"><span class="string">        会向序列化器对象的context属性补充三个数据,可以在定义序列化器时使用</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">return</span> {</span><br><span class="line">            <span class="string">'request'</span>: self.request,  <span class="comment"># 当前视图的请求对象</span></span><br><span class="line">            <span class="string">'format'</span>: self.format_kwarg,  <span class="comment"># 当前请求的类视图对象</span></span><br><span class="line">            <span class="string">'view'</span>: self  <span class="comment"># 当前请求期望返回的数据格式</span></span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">filter_queryset</span>(<span class="params">self, queryset</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        Given a queryset, filter it with whichever filter backend is in use.过滤</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        You are unlikely to want to override this method, although you may need</span></span><br><span class="line"><span class="string">        to call it either from a list view, or from a custom `get_object`</span></span><br><span class="line"><span class="string">        method if you want to apply the configured filtering backend to the</span></span><br><span class="line"><span class="string">        default queryset.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">for</span> backend <span class="keyword">in</span> list(self.filter_backends):</span><br><span class="line">            queryset = backend().filter_queryset(self.request, queryset, self)</span><br><span class="line">        <span class="keyword">return</span> queryset</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">paginator</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        The paginator instance associated with the view, or `None`.分页</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> hasattr(self, <span class="string">'_paginator'</span>):</span><br><span class="line">            <span class="keyword">if</span> self.pagination_class <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                self._paginator = <span class="literal">None</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self._paginator = self.pagination_class()</span><br><span class="line">        <span class="keyword">return</span> self._paginator</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">paginate_queryset</span>(<span class="params">self, queryset</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        Return a single page of results, or `None` if pagination is disabled.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> self.paginator <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">return</span> self.paginator.paginate_queryset(queryset, self.request, view=self)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_paginated_response</span>(<span class="params">self, data</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        Return a paginated style `Response` object for the given output data.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">assert</span> self.paginator <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">return</span> self.paginator.get_paginated_response(data)</span><br></pre></td></tr></tbody></table></figure>

<h2 id="mixins都有继承GenericAPIView的get-serializer和get-object"><a href="#mixins都有继承GenericAPIView的get-serializer和get-object" class="headerlink" title="mixins都有继承GenericAPIView的get_serializer和get_object"></a><code>mixins</code>都有继承<code>GenericAPIView</code>的<code>get_serializer</code>和<code>get_object</code></h2><p>与多种通用CRUD类视图的继承关系</p>
<p><code>CreateModelMixin</code>有<code>create()</code>方法  Create a queryset<br><code>ListModelMixin</code>有<code>list()</code>方法  List a queryset<br><code>RetrieveModelMixin</code>有<code>retrieve()</code>方法 Retrieve a model instance 视图定义不用加pk，在路由后面增加id就可以获取一个实例的的详情（包括其基本信息和子类别）<br><code>UpdateModelMixin</code> 有<code>update()</code>方法 Upadate a model instance 更新一个实例的<br><code>DestroyModelMixin</code> 有<code>destroy()</code>方法 Destroy a model instance 获取一个实例的</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ListModelMixin</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    List a queryset.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">list</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="comment"># 过滤</span></span><br><span class="line">        queryset = self.filter_queryset(self.get_queryset())</span><br><span class="line">        <span class="comment"># 分页</span></span><br><span class="line">        page = self.paginate_queryset(queryset)</span><br><span class="line">        <span class="keyword">if</span> page <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            serializer = self.get_serializer(page, many=<span class="literal">True</span>)</span><br><span class="line">            <span class="keyword">return</span> self.get_paginated_response(serializer.data)</span><br><span class="line">        <span class="comment"># 序列化</span></span><br><span class="line">        serializer = self.get_serializer(queryset, many=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> Response(serializer.data)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RetrieveModelMixin</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Retrieve a model instance.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">retrieve</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="comment"># 获取对象，会检查对象的权限</span></span><br><span class="line">        instance = self.get_object()</span><br><span class="line">        <span class="comment"># 序列化</span></span><br><span class="line">        serializer = self.get_serializer(instance)</span><br><span class="line">        <span class="keyword">return</span> Response(serializer.data)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CreateModelMixin</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Create a model instance.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="comment"># 获取序列化器</span></span><br><span class="line">        serializer = self.get_serializer(data=request.data)</span><br><span class="line">        <span class="comment"># 验证</span></span><br><span class="line">        serializer.is_valid(raise_exception=<span class="literal">True</span>)</span><br><span class="line">        <span class="comment"># 保存</span></span><br><span class="line">        self.perform_create(serializer)</span><br><span class="line">        headers = self.get_success_headers(serializer.data)</span><br><span class="line">        <span class="keyword">return</span> Response(serializer.data, status=status.HTTP_201_CREATED, headers=headers)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">perform_create</span>(<span class="params">self, serializer</span>):</span></span><br><span class="line">        serializer.save()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_success_headers</span>(<span class="params">self, data</span>):</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> {<span class="string">'Location'</span>: str(data[api_settings.URL_FIELD_NAME])}</span><br><span class="line">        <span class="keyword">except</span> (TypeError, KeyError):</span><br><span class="line">            <span class="keyword">return</span> {}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UpdateModelMixin</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Update a model instance.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">update</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        partial = kwargs.pop(<span class="string">'partial'</span>, <span class="literal">False</span>)</span><br><span class="line">        instance = self.get_object()</span><br><span class="line">        serializer = self.get_serializer(instance, data=request.data, partial=partial)</span><br><span class="line">        serializer.is_valid(raise_exception=<span class="literal">True</span>)</span><br><span class="line">        self.perform_update(serializer)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> getattr(instance, <span class="string">'_prefetched_objects_cache'</span>, <span class="literal">None</span>):</span><br><span class="line">            <span class="comment"># If 'prefetch_related' has been applied to a queryset, we need to</span></span><br><span class="line">            <span class="comment"># forcibly invalidate the prefetch cache on the instance.</span></span><br><span class="line">            instance._prefetched_objects_cache = {}</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Response(serializer.data)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">perform_update</span>(<span class="params">self, serializer</span>):</span></span><br><span class="line">        serializer.save()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">partial_update</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        kwargs[<span class="string">'partial'</span>] = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">return</span> self.update(request, *args, **kwargs)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DestroyModelMixin</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Destroy a model instance.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">destroy</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        instance = self.get_object()</span><br><span class="line">        self.perform_destroy(instance)</span><br><span class="line">        <span class="keyword">return</span> Response(status=status.HTTP_204_NO_CONTENT)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">perform_destroy</span>(<span class="params">self, instance</span>):</span></span><br><span class="line">        instance.delete()</span><br></pre></td></tr></tbody></table></figure>

<h3 id="获取所有课程信息或新增一个课程-2"><a href="#获取所有课程信息或新增一个课程-2" class="headerlink" title="获取所有课程信息或新增一个课程"></a>获取所有课程信息或新增一个课程</h3><figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Course</span><br><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> CourseSerializer</span><br><span class="line"><span class="keyword">from</span> rest_framework.generics <span class="keyword">import</span> GenericAPIView</span><br><span class="line"><span class="keyword">from</span> rest_framework.mixins <span class="keyword">import</span> ListModelMixin, CreateModelMixin</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CourseListView</span>(<span class="params">ListModelMixin, CreateModelMixin, GenericAPIView</span>):</span></span><br><span class="line">    <span class="comment"># 获取所有课程信息或新增一个课程</span></span><br><span class="line">    queryset = Course.objects.all()</span><br><span class="line">    serializer_class = CourseSerializer</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        获取数据列表并返回JSON数据</span></span><br><span class="line"><span class="string">        :param request:</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">return</span> self.list(request)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.create(request)</span><br></pre></td></tr></tbody></table></figure>

<h3 id="获取一个课程的详细信息、更新、删除一个课程-2"><a href="#获取一个课程的详细信息、更新、删除一个课程-2" class="headerlink" title="获取一个课程的详细信息、更新、删除一个课程"></a>获取一个课程的详细信息、更新、删除一个课程</h3><p><code>course\views.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Course</span><br><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> CourseSerializer</span><br><span class="line"><span class="keyword">from</span> rest_framework.mixins <span class="keyword">import</span> ListModelMixin, CreateModelMixin, RetrieveModelMixin, UpdateModelMixin, DestroyModelMixin</span><br><span class="line"><span class="keyword">from</span> rest_framework.generics <span class="keyword">import</span> GenericAPIView</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CourseDetailView</span>(<span class="params">RetrieveModelMixin, UpdateModelMixin, DestroyModelMixin, GenericAPIView</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request, pk</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.retrieve(request, pk)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put</span>(<span class="params">self, request, pk</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.update(request, pk)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">self, request, pk</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.destroy(request, pk)</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">urlpatterns = [</span><br><span class="line">    <span class="comment"># Generic Class Based View</span></span><br><span class="line">    path(<span class="string">"gcbMixinv/detail/&lt;int:pk&gt;/"</span>,</span><br><span class="line">         views.CourseDetailView.as_view(),</span><br><span class="line">         name=<span class="string">"gcbMixinv-detail"</span>),</span><br><span class="line">]</span><br></pre></td></tr></tbody></table></figure>


<h2 id="mixins都有继承GenericAPIView的get-serializer-结合形成各种APIView，如"><a href="#mixins都有继承GenericAPIView的get-serializer-结合形成各种APIView，如" class="headerlink" title="mixins都有继承GenericAPIView的get_serializer 结合形成各种APIView，如"></a><code>mixins</code>都有继承<code>GenericAPIView</code>的<code>get_serializer</code> 结合形成各种<code>APIView</code>，如</h2><ul>
<li><code>ListAPIView(mixins.ListModelMixin, GenericAPIView)</code>能接收GET请求，它封装了获取多个数据对象列表并返回JSON数据的<code>get</code>方法。</li>
<li><code>CreateAPIView</code>可以支持POST请求，保存数据</li>
<li><code>UpdateAPIView</code>可以支持PUT和PATCH请求，</li>
<li><code>DestoryAPIView</code>可以支持DELETE请求</li>
<li><code>RetrieveAPIView</code> 视图定义不用加pk，在路由后面增加id就可以获取一个实例的的详情</li>
<li><code>ListCreateAPIView</code></li>
<li><code>RetrieveUpdateAPIView</code></li>
<li><code>RetrieveUpdateDestoryAPIView</code></li>
</ul>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CreateAPIView</span>(<span class="params">mixins.CreateModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                    GenericAPIView</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Concrete view for creating a model instance.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.create(request, *args, **kwargs)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ListAPIView</span>(<span class="params">mixins.ListModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                  GenericAPIView</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Concrete view for listing a queryset.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.list(request, *args, **kwargs)</span><br></pre></td></tr></tbody></table></figure>

<h3 id="获取所有课程信息"><a href="#获取所有课程信息" class="headerlink" title="获取所有课程信息"></a>获取所有课程信息</h3><p><code>course\views.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.authentication <span class="keyword">import</span> BasicAuthentication, SessionAuthentication, TokenAuthentication</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> generics  <span class="comment"># from rest_framework.generics import ListAPIView</span></span><br><span class="line"><span class="keyword">from</span> rest_framework.permissions <span class="keyword">import</span> IsAuthenticated</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Course</span><br><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> CourseSerializer</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GCourseListView</span>(<span class="params">generics.ListAPIView</span>):</span></span><br><span class="line">    queryset = Course.objects.all()</span><br><span class="line">    serializer_class = CourseSerializer</span><br><span class="line">    authentication_classes = (BasicAuthentication, SessionAuthentication, TokenAuthentication)</span><br><span class="line">    permission_classes = (IsAuthenticated, )</span><br></pre></td></tr></tbody></table></figure>

<p><code>course\urls.py</code> 使用上面的<code>GCourseListView</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">urlpatterns = [</span><br><span class="line">    <span class="comment"># Generic Class Based View</span></span><br><span class="line">    path(<span class="string">"api/gcbv/courses/"</span>, views.GCourseListView.as_view(), name=<span class="string">"gcbv-list"</span>),</span><br><span class="line">]</span><br></pre></td></tr></tbody></table></figure>

<h3 id="获取所有课程信息或新增一个课程-3"><a href="#获取所有课程信息或新增一个课程-3" class="headerlink" title="获取所有课程信息或新增一个课程"></a>获取所有课程信息或新增一个课程</h3><p><code>course\views.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> generics</span><br><span class="line"><span class="keyword">from</span> rest_framework.permissions <span class="keyword">import</span> IsAuthenticated</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Course</span><br><span class="line"><span class="keyword">from</span> utils.permissions <span class="keyword">import</span> IsOwnerOrReadOnly</span><br><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> CourseSerializer</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GCourseListView</span>(<span class="params">generics.ListCreateAPIView</span>):</span></span><br><span class="line">    queryset = Course.objects.all()</span><br><span class="line">    serializer_class = CourseSerializer</span><br><span class="line">    authentication_classes = (BasicAuthentication, SessionAuthentication, TokenAuthentication)</span><br><span class="line">    permission_classes = (IsAuthenticated, )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">perform_create</span>(<span class="params">self, serializer</span>):</span></span><br><span class="line">        serializer.save(teacher=self.request.user)  <span class="comment"># 当前请求的登录用户赋值给teacher</span></span><br></pre></td></tr></tbody></table></figure>

<p><code>course\urls.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">urlpatterns = [</span><br><span class="line">    <span class="comment"># Generic Class Based View</span></span><br><span class="line">    path(<span class="string">"gcbv/list/"</span>, views.GCourseListView.as_view(), name=<span class="string">"gcbv-list"</span>),</span><br><span class="line">]</span><br></pre></td></tr></tbody></table></figure>

<h3 id="获取一个课程的详细信息、更新、删除一个课程-3"><a href="#获取一个课程的详细信息、更新、删除一个课程-3" class="headerlink" title="获取一个课程的详细信息、更新、删除一个课程"></a>获取一个课程的详细信息、更新、删除一个课程</h3><p><code>course\views.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> generics</span><br><span class="line"><span class="keyword">from</span> rest_framework.permissions <span class="keyword">import</span> IsAuthenticated</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Course</span><br><span class="line"><span class="keyword">from</span> utils.permissions <span class="keyword">import</span> IsOwnerOrReadOnly</span><br><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> CourseSerializer</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GCourseDetailView</span>(<span class="params">generics.RetrieveUpdateDestroyAPIView</span>):</span></span><br><span class="line">    queryset = Course.objects.all()</span><br><span class="line">    serializer_class = CourseSerializer</span><br><span class="line">    authentication_classes = (BasicAuthentication, SessionAuthentication, TokenAuthentication)</span><br><span class="line">    permission_classes = (IsAuthenticated, IsOwnerOrReadOnly)</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">urlpatterns = [</span><br><span class="line">    <span class="comment"># Generic Class Based View</span></span><br><span class="line">    path(<span class="string">"gcbv/detail/&lt;int:pk&gt;/"</span>,</span><br><span class="line">         views.GCourseDetailView.as_view(),</span><br><span class="line">         name=<span class="string">"gcbv-detail"</span>),</span><br><span class="line">]</span><br></pre></td></tr></tbody></table></figure>

<h2 id="DRF的视图集viewsets-整合了FBV-CBV-GCBV和的方法"><a href="#DRF的视图集viewsets-整合了FBV-CBV-GCBV和的方法" class="headerlink" title="DRF的视图集viewsets 整合了FBV CBV GCBV和的方法"></a>DRF的视图集<code>viewsets</code> 整合了FBV CBV GCBV和的方法</h2><p>同时继承<code>APIView</code>和<code>generics</code>继承了 mixins<br>高度定制化、灵活性低，开发效率高，几行代码可以完成CRUD</p>
<p><code>class GenericViewSet(ViewSetMixin, generics.GenericAPIView)</code>继承自<code>GenericAPIView</code>，而GenericAPIView又继承自<code>APIView</code>，APIView又继承自<code>View</code>，前3个均属于DRF，<code>View</code>属于Django。</p>
<p><code>ViewSetMixin</code>允许且要求在urls.py中通过<code>router</code>进行方法的绑定或者自定义绑定，<br>ViewSet类与View类其实几乎是相同的,但提供的是read或update这些操作,而不是get或put 等HTTP动作。</p>
<p><code>viewsets</code>还实现了<code>initialize_request(request, *args, **kwargs)</code>方法，绑定了很多action，<br>同时还实现了一些组合，包括<code>ReadOnlyModelViewSet</code>、<code>ModelViewSet</code></p>
<p>如果学科对应的数据接口需要支持GET、POST、PUT、PATCH、DELETE请求来支持对学科资源的获取、新增、更新、删除操作，<br>更为简单的做法是继承<code>ModelViewSet</code>来编写学科视图类。</p>
<p>通过查看<code>ModelViewSet</code>类的源代码可以发现，该类共有6个父类，其中前5个父类分别实现对POST（新增学科）、GET（获取指定学科）、PUT/PATCH（更新学科）、DELETE（删除学科）和GET（获取学科列表）操作的支持，对应的方法分别是<code>create</code>、<code>retrieve</code>、<code>update</code>、<code>destroy</code>和<code>list</code>。<br>由于<code>ModelViewSet</code>的父类中已经实现了这些方法，<br>所以我们几乎没有编写任何代码就完成了学科数据全套接口的开发，<br>我们要做的仅仅是指出如何获取到数据（通过<code>queryset</code>属性指定）以及如何序列化数据（通过<code>serializer_class</code>属性指定），<br>这一点跟上面继承<code>APIView</code>的子类做法是一致的。</p>
<p><code>ReadOnlyModelViewSet</code> 的类，只读视图的集合，继承该类定制的数据接口只能支持GET请求，也就是获取单个资源和资源列表的请求。</p>
<p>源码</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReadOnlyModelViewSet</span>(<span class="params">mixins.RetrieveModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                           mixins.ListModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                           GenericViewSet</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    A viewset that provides default `list()` and `retrieve()` actions.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ModelViewSet</span>(<span class="params">mixins.CreateModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                   mixins.RetrieveModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                   mixins.UpdateModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                   mixins.DestroyModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                   mixins.ListModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                   GenericViewSet</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    A viewset that provides default `create()`, `retrieve()`, `update()`,</span></span><br><span class="line"><span class="string">    `partial_update()`, `destroy()` and `list()` actions.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></tbody></table></figure>

<p><code>course\views.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> viewsets</span><br><span class="line"><span class="keyword">from</span> rest_framework.permissions <span class="keyword">import</span> IsAuthenticated</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Course</span><br><span class="line"><span class="keyword">from</span> utils.permissions <span class="keyword">import</span> IsOwnerOrReadOnly</span><br><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> CourseSerializer</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CourseViewSet</span>(<span class="params">viewsets.ModelViewSet</span>):</span></span><br><span class="line">    queryset = Course.objects.all()</span><br><span class="line">    serializer_class = CourseSerializer</span><br><span class="line">    authentication_classes = (BasicAuthentication, SessionAuthentication, TokenAuthentication)</span><br><span class="line">    permission_classes = (IsAuthenticated, IsOwnerOrReadOnly)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">perform_create</span>(<span class="params">self, serializer</span>):</span></span><br><span class="line">        serializer.save(teacher=self.request.user)</span><br></pre></td></tr></tbody></table></figure>

<p><code>goods/views.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GoodsListViewSet</span>(<span class="params">mixins.ListModelMixin, viewsets.GenericViewSet</span>):</span></span><br><span class="line">    <span class="string">'商品列表页'</span></span><br><span class="line">    <span class="comment"># 有指定分页必须要定义一个默认的排序，否则会报错</span></span><br><span class="line">    queryset = Goods.objects.all().order_by(<span class="string">'id'</span>)</span><br><span class="line">    serializer_class = GoodsSerializer</span><br><span class="line">    pagination_class = GoodsPagination</span><br></pre></td></tr></tbody></table></figure>

<p>要使用上面的<code>SubjectViewSet</code>，需要在<code>urls.py</code>文件中进行URL映射。<br><code>ViewSet</code>配置路由法一</p>
<p>Generic Class Based View 同一个类视图对应2个不同的url<br>给视图集指定请求的url应该调用哪些方法<br>字典的key是HTTP方法，<br>字典的value是调用视图集里面父类方法<br><code>value</code>的<code>list</code>是视图集<code>ModelViewSet</code>的子类<code>ListModelMixin</code>的<code>list</code>方法<br><code>value</code>的<code>create</code>是视图集<code>ModelViewSet</code>的子类<code>CreateModelMixin</code>的<code>create</code>方法</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">"viewsets/"</span>,</span><br><span class="line">         views.CourseViewSet.as_view({</span><br><span class="line">             <span class="string">"get"</span>: <span class="string">"list"</span>,</span><br><span class="line">             <span class="string">"post"</span>: <span class="string">"create"</span></span><br><span class="line">         }),</span><br><span class="line">         name=<span class="string">"viewsets-list"</span>),</span><br><span class="line"></span><br><span class="line">    path(<span class="string">"viewsets/&lt;int:pk&gt;/"</span>,</span><br><span class="line">         views.CourseViewSet.as_view({</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    This is the magic.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Overrides `.as_view()` so that it takes an `actions` keyword that performs</span></span><br><span class="line"><span class="string">    the binding of HTTP methods to actions on the Resource.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    For example, to create a concrete view binding the 'GET' and 'put' methods</span></span><br><span class="line"><span class="string">    to the 'retrieve' and 'update' actions...</span></span><br><span class="line"><span class="string">    view = MyViewSet.as_view({'get': 'retrieve', 'put': 'update', 'patch': 'partial_update', 'delete': 'destroy'})</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">             <span class="string">"get"</span>: <span class="string">"retrieve"</span>,</span><br><span class="line">             <span class="string">"put"</span>: <span class="string">"update"</span>,</span><br><span class="line">             <span class="string">"patch"</span>: <span class="string">"partial_update"</span>,</span><br><span class="line">             <span class="string">"delete"</span>: <span class="string">"destroy"</span></span><br><span class="line">         }),</span><br><span class="line">         name=<span class="string">"viewsets-detail"</span>),</span><br><span class="line">]</span><br></pre></td></tr></tbody></table></figure>

<p><code>mxshop/url.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> goods.views <span class="keyword">import</span> GoodsListViewSet</span><br><span class="line"></span><br><span class="line">goods_list = GoodsListViewSet.as_view({</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    This is the magic.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Overrides `.as_view()` so that it takes an `actions` keyword that performs</span></span><br><span class="line"><span class="string">    the binding of HTTP methods to actions on the Resource.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    For example, to create a concrete view binding the 'GET' methods</span></span><br><span class="line"><span class="string">    to the 'list' actions...</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    view = MyViewSet.as_view({'get': 'list'})</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="string">'get'</span>: <span class="string">'list'</span>,  <span class="comment"># 使get()请求绑定到list()方法</span></span><br><span class="line">})</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">'goods/'</span>, goods_list, name=<span class="string">"goods-list"</span>),</span><br><span class="line">]</span><br></pre></td></tr></tbody></table></figure>

<p><code>ViewSet</code>配置路由法二<br>由于<code>ModelViewSet</code>相当于是多个视图函数的汇总，所以不同于之前映射URL的方式，<br>我们需要先创建一个drf自带路由<code>routers</code>并通过它注册<code>SubjectViewSet</code>，<br>添加其他模型的视图也直接添加一行代码<code>router.register('xxx', XxxListViewSet)</code>即可。<br>然后将注册成功后生成的URL一并添加到<code>urlspattern</code>列表中，。</p>
<p>提供了一种简单，快速，集成的方式来定义一系列的urls<br>将<code>get()</code>请求转到<code>list()</code>方法、<code>post()</code>请求转到<code>create()</code>方法，</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path, include</span><br><span class="line"><span class="keyword">from</span> rest_framework.routers <span class="keyword">import</span> DefaultRouter</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> course <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line">router = DefaultRouter()  <span class="comment"># 生成一个路由实例对象</span></span><br><span class="line"><span class="comment"># 视图集注册到路由实例</span></span><br><span class="line">router.register(prefix=<span class="string">"viewsets"</span>, viewset=views.CourseViewSet)</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">""</span>, include(router.urls))</span><br><span class="line">]</span><br></pre></td></tr></tbody></table></figure>

<p><code>mxshop/url.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> goods.views <span class="keyword">import</span> GoodsListViewSet</span><br><span class="line"><span class="keyword">from</span> rest_framework.routers <span class="keyword">import</span> DefaultRouter</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> goods.views <span class="keyword">import</span> GoodsListViewSet</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">router = DefaultRouter()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 商品列表页</span></span><br><span class="line">router.register(prefix=<span class="string">'goods'</span>, viewset=GoodsListViewSet)</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">''</span>, include(router.urls)),</span><br><span class="line">]</span><br></pre></td></tr></tbody></table></figure>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/05/06/drf-shi-tu-viewsets-he-guo-lu-qi-shi-xian-zhan-shi-shang-pin-lie-biao-ye-he-xiang-qing/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/06/drf-shi-tu-viewsets-he-guo-lu-qi-shi-xian-zhan-shi-shang-pin-lie-biao-ye-he-xiang-qing/" class="post-title-link" itemprop="url">DRF视图viewsets和过滤器实现展示商品列表页和详情</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-05-05 16:21:41" itemprop="dateCreated datePublished" datetime="2021-05-05T16:21:41Z">2021-05-05</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-06-17 07:24:53" itemprop="dateModified" datetime="2021-06-17T07:24:53Z">2021-06-17</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/django/" itemprop="url" rel="index"><span itemprop="name">django</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>The default behavior of REST framework’s generic list views is to return the entire queryset for a model manager. Often you will want your API to restrict the items that are returned by the queryset.</p>
<p>The simplest way to filter the queryset of any view that subclasses <code>GenericAPIView</code> is to override the <code>.get_queryset()</code> method.</p>
<p>Overriding this method allows you to customize the queryset returned by the view in a number of different ways.</p>
<p>DRF配置</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">REST_FRAMEWORK = {</span><br><span class="line">    <span class="string">'DEFAULT_FILTER_BACKENDS'</span>: [<span class="string">'django_filters.rest_framework.DjangoFilterBackend'</span>]</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h1 id="viewsets实现展示商品列表页数据"><a href="#viewsets实现展示商品列表页数据" class="headerlink" title="viewsets实现展示商品列表页数据"></a>viewsets实现展示商品列表页数据</h1><p>点击某一个商品分类下面显示出商品详情，具体包括分类显示、价格筛选、分页和排序、显示商品数量、搜索<br>本项目可以看到，通过搜索和点击Tab页左侧显示的导航栏是不同的，其数据接口也不一样</p>
<p><code>goods/serializers.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GoodsSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="string">'''商品列表序列化'''</span></span><br><span class="line">    <span class="comment"># 关联对象嵌套序列化，返回当前类数据和关联模型类的数据</span></span><br><span class="line">    category = CategorySerializer()  <span class="comment"># 一对一</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Goods</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br></pre></td></tr></tbody></table></figure>

<p><code>apps/goods/views.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GoodsListViewSet</span>(<span class="params">mixins.ListModelMixin, viewsets.GenericViewSet</span>):</span></span><br><span class="line">    <span class="string">'''list: 商品列表页'''</span></span><br><span class="line">    queryset = Goods.objects.all()</span><br><span class="line">    serializer_class = GoodsSerializer</span><br><span class="line"></span><br><span class="line">    filter_backends = (DjangoFilterBackend,)</span><br><span class="line">    filter_fields = (<span class="string">'name'</span>,<span class="string">'shop_price'</span>)</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/05/06/drf-shi-tu-viewsets-he-guo-lu-qi-shi-xian-zhan-shi-shang-pin-lie-biao-ye-he-xiang-qing/9.png" alt="description"><br><img src="/2021/05/06/drf-shi-tu-viewsets-he-guo-lu-qi-shi-xian-zhan-shi-shang-pin-lie-biao-ye-he-xiang-qing/0.png" alt="description"></p>
<p>根据字段进行过滤，但是只能精确比配，对于字符串型字段不能模糊匹配，对于数值型字段也不能匹配区间，</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GoodsListViewSet</span>(<span class="params">mixins.ListModelMixin, viewsets.GenericViewSet</span>):</span></span><br><span class="line">    <span class="string">'''list: 商品列表页，并实现分页、搜索、过滤、排序'''</span></span><br><span class="line">    <span class="comment"># queryset = Goods.objects.all()  # 切换get_queryset方法</span></span><br><span class="line">    serializer_class = GoodsSerializer</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_queryset</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        This view should return a list of all the goods</span></span><br><span class="line"><span class="string">        for shop_price &gt;= price_min.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        queryset = Goods.objects.all()</span><br><span class="line">        price_min = self.request.query_params.get(<span class="string">'price_min'</span>, <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">if</span> price_min:</span><br><span class="line">            queryset = queryset.filter(shop_price__gt=int(price_min))  <span class="comment"># django的filter</span></span><br><span class="line">        <span class="keyword">return</span> queryset</span><br></pre></td></tr></tbody></table></figure>

<p><a target="_blank" rel="noopener" href="http://127.0.0.1:8000/goods/?price_min=200">http://127.0.0.1:8000/goods/?price_min=200</a>通过url传递参数实现过滤数据</p>
<h3 id="通过第三方包django-filters-的-DjangoFilterBackend类实现字段过滤（与后台管理系统表现相同）"><a href="#通过第三方包django-filters-的-DjangoFilterBackend类实现字段过滤（与后台管理系统表现相同）" class="headerlink" title="通过第三方包django_filters 的 DjangoFilterBackend类实现字段过滤（与后台管理系统表现相同）"></a>通过第三方包<code>django_filters</code> 的 <code>DjangoFilterBackend</code>类实现字段过滤（与后台管理系统表现相同）</h3><p><code>mxshop/settings.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">INSTALLED_APPS = [</span><br><span class="line">     <span class="string">'django_filters'</span>,</span><br><span class="line">]</span><br></pre></td></tr></tbody></table></figure>

<p>新建自定义 <code>goods/filters.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> django_filters</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Goods</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GoodsFilter</span>(<span class="params">django_filters.rest_framework.FilterSet</span>):</span></span><br><span class="line">    <span class="string">'''商品过滤类'''</span></span><br><span class="line">    <span class="comment"># 两个参数，field_name是要过滤的字段，lookup是执行的行为，‘小于等于本店价格’</span></span><br><span class="line">    pricemin = django_filters.NumberFilter(field_name=<span class="string">"market_price"</span>, lookup_expr=<span class="string">'gte'</span>)</span><br><span class="line">    pricemax = django_filters.NumberFilter(field_name=<span class="string">"market_price"</span>, lookup_expr=<span class="string">'lte'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Goods</span><br><span class="line">        fields = [<span class="string">'pricemin'</span>, <span class="string">'pricemax'</span>]</span><br></pre></td></tr></tbody></table></figure>

<p><code>apps/goods/views.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django_filters.rest_framework <span class="keyword">import</span> DjangoFilterBackend</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .filters <span class="keyword">import</span> GoodsFilter</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GoodsListViewSet</span>(<span class="params">mixins.ListModelMixin,viewsets.GenericViewSet</span>):</span></span><br><span class="line">    <span class="string">'商品列表页'</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 这里必须要定义一个默认的排序否则会报错</span></span><br><span class="line">    queryset = Goods.objects.all().order_by(<span class="string">'id'</span>)</span><br><span class="line">    serializer_class = GoodsSerializer</span><br><span class="line"></span><br><span class="line">    filter_backends = (DjangoFilterBackend, )</span><br><span class="line">    <span class="comment"># 设置filter的类为我们自定义的类</span></span><br><span class="line">    filter_class = GoodsFilter</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/05/06/drf-shi-tu-viewsets-he-guo-lu-qi-shi-xian-zhan-shi-shang-pin-lie-biao-ye-he-xiang-qing/1.png" alt="description"></p>
<h3 id="SearchFilter-类实现字段搜索"><a href="#SearchFilter-类实现字段搜索" class="headerlink" title="SearchFilter 类实现字段搜索"></a><code>SearchFilter</code> 类实现字段搜索</h3><p>新建自定义 <code>goods/filters.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Goods</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GoodsFilter</span>(<span class="params">django_filters.rest_framework.FilterSet</span>):</span></span><br><span class="line">    <span class="string">'''商品过滤类'''</span></span><br><span class="line">    <span class="comment"># 两个参数，field_name是要过滤的字段，lookup是执行的行为，‘小于等于本店价格’</span></span><br><span class="line">    name = django_filters.CharFilter(field_name=<span class="string">"name"</span>, lookup_expr=<span class="string">'contains'</span>)  <span class="comment"># 指定包含，默认是全部匹配</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Goods</span><br><span class="line">        fields = [<span class="string">'name'</span>]</span><br></pre></td></tr></tbody></table></figure>

<p><code>apps/goods/views.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> mixins, viewsets, filters</span><br><span class="line"><span class="keyword">from</span> django_filters.rest_framework <span class="keyword">import</span> DjangoFilterBackend</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .filters <span class="keyword">import</span> GoodsFilter</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GoodsListViewSet</span>(<span class="params">mixins.ListModelMixin,viewsets.GenericViewSet</span>):</span></span><br><span class="line">    <span class="string">'商品列表页'</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 这里必须要定义一个默认的排序否则会报错</span></span><br><span class="line">    queryset = Goods.objects.all().order_by(<span class="string">'id'</span>)</span><br><span class="line">    serializer_class = GoodsSerializer</span><br><span class="line"></span><br><span class="line">    filter_backends = (filters.SearchFilter, )</span><br><span class="line">    search_fields = [<span class="string">'name'</span>, <span class="string">'goods_brief'</span>, <span class="string">'goods_desc'</span>]</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/05/06/drf-shi-tu-viewsets-he-guo-lu-qi-shi-xian-zhan-shi-shang-pin-lie-biao-ye-he-xiang-qing/3.png" alt="description"></p>
<h3 id="drf-的-OrderingFilter-类实现字段排序"><a href="#drf-的-OrderingFilter-类实现字段排序" class="headerlink" title="drf 的 OrderingFilter 类实现字段排序"></a>drf 的 <code>OrderingFilter</code> 类实现字段排序</h3><p><code>apps/goods/views.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> mixins, viewsets, filters</span><br><span class="line"><span class="keyword">from</span> django_filters.rest_framework <span class="keyword">import</span> DjangoFilterBackend</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .filters <span class="keyword">import</span> GoodsFilter</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GoodsListViewSet</span>(<span class="params">mixins.ListModelMixin,viewsets.GenericViewSet</span>):</span></span><br><span class="line">    <span class="string">'商品列表页'</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 这里必须要定义一个默认的排序否则会报错</span></span><br><span class="line">    queryset = Goods.objects.all().order_by(<span class="string">'id'</span>)</span><br><span class="line">    serializer_class = GoodsSerializer</span><br><span class="line"></span><br><span class="line">    filter_backends = (filters.OrderingFilter, )</span><br><span class="line">    ordering_fields = [<span class="string">'sold_num'</span>, <span class="string">'shop_price'</span>]  <span class="comment"># 按销量或价格排序</span></span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/05/06/drf-shi-tu-viewsets-he-guo-lu-qi-shi-xian-zhan-shi-shang-pin-lie-biao-ye-he-xiang-qing/4.png" alt="description"><br><img src="/2021/05/06/drf-shi-tu-viewsets-he-guo-lu-qi-shi-xian-zhan-shi-shang-pin-lie-biao-ye-he-xiang-qing/5.png" alt="description"></p>
<p>新建自定义 <code>goods/filters.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> Q</span><br><span class="line"><span class="keyword">import</span> django_filters</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Goods</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GoodsFilter</span>(<span class="params">django_filters.rest_framework.FilterSet</span>):</span></span><br><span class="line">    <span class="string">'''商品过滤类'''</span></span><br><span class="line">    <span class="comment"># 两个参数，field_name是要过滤的字段，lookup是执行的行为，‘小于等于本店价格’</span></span><br><span class="line">    <span class="comment"># 价格区间过滤</span></span><br><span class="line">    pricemin = django_filters.NumberFilter(field_name=<span class="string">"market_price"</span>, lookup_expr=<span class="string">'gte'</span>, help_text=<span class="string">'最小价格'</span>)</span><br><span class="line">    pricemax = django_filters.NumberFilter(field_name=<span class="string">"market_price"</span>, lookup_expr=<span class="string">'lte'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 自定义过滤，过滤某个一级分类</span></span><br><span class="line">    top_category = django_filters.NumberFilter(method=<span class="string">'top_category_filter'</span>, help_text=<span class="string">'自定义过滤某个一级分类'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">top_category_filter</span>(<span class="params">self, queryset, name, value</span>):</span></span><br><span class="line">        <span class="string">'''</span></span><br><span class="line"><span class="string">        自定义过滤</span></span><br><span class="line"><span class="string">        不管当前点击的是一级分类二级分类还是三级分类，</span></span><br><span class="line"><span class="string">        需要传入参数：一级分类的id</span></span><br><span class="line"><span class="string">        在已有商品查询集基础上获取分类id，一级一级往上找，直到将三级类别找完</span></span><br><span class="line"><span class="string">        '''</span></span><br><span class="line">        <span class="keyword">return</span> queryset.filter(Q(category_id=value) | Q(category__parent_category_id=value) | Q(</span><br><span class="line">            category__parent_category__parent_category_id=value))</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Goods</span><br><span class="line">        fields = [<span class="string">'pricemin'</span>, <span class="string">'pricemax'</span>]</span><br></pre></td></tr></tbody></table></figure>

<h1 id="viewsets继承mixins-RetrieveModelMixin实现商品详情页"><a href="#viewsets继承mixins-RetrieveModelMixin实现商品详情页" class="headerlink" title="viewsets继承mixins.RetrieveModelMixin实现商品详情页"></a>viewsets继承<code>mixins.RetrieveModelMixin</code>实现商品详情页</h1><p>左侧有商品轮播图，右侧是商品的详情信息，包括商品名称、商品描述、是否包邮、市场价、本店价、销量、库存量、购物车按钮、收藏按钮，还包括富文本详情和热卖商品等。</p>
<p><code>apps/goods/views.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GoodsListViewSet</span>(<span class="params">mixins.RetrieveModelMixin, viewsets.GenericViewSet</span>):</span></span><br><span class="line">    <span class="string">'''retrieve:根据ID商品详情'''</span></span><br></pre></td></tr></tbody></table></figure>

<p><code>goods/serializers.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GoodsImageSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="string">'''商品图片'''</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = GoodsImage</span><br><span class="line">        fields = [<span class="string">'image'</span>, ]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GoodsSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="string">'''商品详情序列化'''</span></span><br><span class="line">    <span class="comment"># 关联对象嵌套序列化，返回当前类数据和关联模型类的数据</span></span><br><span class="line">    <span class="comment"># images是数据库中设置的related_name="images"，把商品图嵌套进来</span></span><br><span class="line">    images = GoodsImageSerializer(many=<span class="literal">True</span>)  <span class="comment"># 字段名和外键名称一样，一对多</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Goods</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/05/06/drf-shi-tu-viewsets-he-guo-lu-qi-shi-xian-zhan-shi-shang-pin-lie-biao-ye-he-xiang-qing/6.png" alt="description"><br>可以看到每个商品的轮播图字段都已经显示了，整个轮播图url都能拼凑好，指定商品id，可以看到该商品的详细信息，</p>
<h2 id="热卖商品接口实现"><a href="#热卖商品接口实现" class="headerlink" title="热卖商品接口实现"></a>热卖商品接口实现</h2><p>在商品详情页右侧有热卖商品，这要用到商品的<code>is_hot</code>字段，在商品的过滤类中增加一个<code>is_hot</code></p>
<p><code>goods/filters.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Goods</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GoodsFilter</span>(<span class="params">django_filters.rest_framework.FilterSet</span>):</span></span><br><span class="line">    <span class="string">'''商品过滤类'''</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Goods</span><br><span class="line">        fields = [<span class="string">'is_hot'</span>]</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/05/06/drf-shi-tu-viewsets-he-guo-lu-qi-shi-xian-zhan-shi-shang-pin-lie-biao-ye-he-xiang-qing/7.png" alt="description"><br><img src="/2021/05/06/drf-shi-tu-viewsets-he-guo-lu-qi-shi-xian-zhan-shi-shang-pin-lie-biao-ye-he-xiang-qing/8.png" alt="description"></p>
<h2 id="新品接口功能开发"><a href="#新品接口功能开发" class="headerlink" title="新品接口功能开发"></a>新品接口功能开发</h2><p>在首页商品列表的接口有新增商品，这要用到商品的<code>is_new</code>字段，在商品的过滤类中增加一个<code>is_new</code></p>
<p><code>goods/filters.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Goods</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GoodsFilter</span>(<span class="params">django_filters.rest_framework.FilterSet</span>):</span></span><br><span class="line">    <span class="string">'''商品过滤类'''</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Goods</span><br><span class="line">        fields = [<span class="string">'is_new'</span>]</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/05/06/drf-shi-tu-viewsets-he-guo-lu-qi-shi-xian-zhan-shi-shang-pin-lie-biao-ye-he-xiang-qing/13.jpeg" alt="description"></p>
<h3 id="轮播图"><a href="#轮播图" class="headerlink" title="轮播图"></a>轮播图</h3><p><code>goods/model.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GoodsImage</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    <span class="string">'''商品轮播图'''</span></span><br><span class="line">    goods = models.ForeignKey(Goods, verbose_name=<span class="string">'商品'</span>, related_name=<span class="string">'images'</span>, null=<span class="literal">True</span>, on_delete=models.CASCADE)</span><br><span class="line">    image = models.ImageField(upload_to=<span class="string">''</span>, null=<span class="literal">True</span>, blank=<span class="literal">True</span>, verbose_name=<span class="string">'图片'</span>)</span><br><span class="line">    image_url = models.CharField(max_length=<span class="number">300</span>, null=<span class="literal">True</span>, blank=<span class="literal">True</span>, verbose_name=<span class="string">'图片链接'</span>)</span><br><span class="line"></span><br><span class="line">    add_time = models.DateTimeField(auto_now_add=<span class="literal">True</span>, verbose_name=<span class="string">u'添加时间'</span>)</span><br><span class="line">    is_delete = models.BooleanField(default=<span class="literal">False</span>, verbose_name=<span class="string">'是否删除'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        verbose_name = <span class="string">'商品轮播图'</span></span><br><span class="line">        verbose_name_plural = verbose_name</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.goods.name</span><br></pre></td></tr></tbody></table></figure>

<p><code>goods/serializer.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Banner</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BannerSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="string">'''轮播图'''</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Banner</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br></pre></td></tr></tbody></table></figure>

<p><code>goods/views.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Banner</span><br><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> BannerSerializer</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BannerViewSet</span>(<span class="params">mixins.ListModelMixin, viewsets.GenericViewSet</span>):</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    list:</span></span><br><span class="line"><span class="string">        轮播图列表</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    queryset = Banner.objects.filter(is_delete=<span class="literal">False</span>).order_by(<span class="string">'index'</span>)</span><br><span class="line">    serializer_class = BannerSerializer</span><br></pre></td></tr></tbody></table></figure>

<p><code>url.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> goods.views <span class="keyword">import</span> BannerViewSet</span><br><span class="line">router.register(<span class="string">'banners'</span>, BannerViewSet)</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/05/06/drf-shi-tu-viewsets-he-guo-lu-qi-shi-xian-zhan-shi-shang-pin-lie-biao-ye-he-xiang-qing/10.png" alt="description"><br><img src="/2021/05/06/drf-shi-tu-viewsets-he-guo-lu-qi-shi-xian-zhan-shi-shang-pin-lie-biao-ye-he-xiang-qing/11.png" alt="description"></p>
<h2 id="首页商品分类显示功能"><a href="#首页商品分类显示功能" class="headerlink" title="首页商品分类显示功能"></a>首页商品分类显示功能</h2><p>商品系列分类包括<br>左侧的导航栏<br>右侧的商品列表</p>
<p>3个一对多关系，<br>一级分类—品牌商标图片Brand<br>一级分类—二级分类<br>一级分类—广告商品<br>一级分类—所有商品<br>在定义序列化时需要嵌套定义。</p>
<p><img src="/2021/05/06/drf-shi-tu-viewsets-he-guo-lu-qi-shi-xian-zhan-shi-shang-pin-lie-biao-ye-he-xiang-qing/12.png" alt="description"></p>
<p>从分类中通过关联名称直接取到品牌图片和商品</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Goods</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    <span class="string">'''商品'''</span></span><br><span class="line">    category = models.ForeignKey(GoodsCategory, verbose_name=<span class="string">'商品类目'</span>, on_delete=models.CASCADE)  <span class="comment"># 分类关联名</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GoodsCategoryBrand</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    <span class="string">'''品牌名 某一大类下的宣传商标'''</span></span><br><span class="line">    category = models.ForeignKey(GoodsCategory, verbose_name=<span class="string">'商品类目'</span>, related_name=<span class="string">'brands'</span>, null=<span class="literal">True</span>,</span><br><span class="line">                                 on_delete=models.CASCADE)  <span class="comment"># 分类的外键关联名</span></span><br><span class="line">    name = models.CharField(default=<span class="string">''</span>, max_length=<span class="number">30</span>, verbose_name=<span class="string">'品牌名'</span>, help_text=<span class="string">'品牌名'</span>)</span><br><span class="line">    desc = models.TextField(default=<span class="string">''</span>, max_length=<span class="number">200</span>, verbose_name=<span class="string">'品牌描述'</span>, help_text=<span class="string">'品牌描述'</span>)</span><br><span class="line">    image = models.ImageField(max_length=<span class="number">200</span>, upload_to=<span class="string">'brands/'</span>)  <span class="comment"># 上传到image/brands</span></span><br><span class="line">    add_time = models.DateTimeField(auto_now_add=<span class="literal">True</span>, verbose_name=<span class="string">u'添加时间'</span>)</span><br><span class="line">    is_delete = models.BooleanField(default=<span class="literal">False</span>, verbose_name=<span class="string">'是否删除'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        verbose_name = <span class="string">'品牌'</span></span><br><span class="line">        verbose_name_plural = verbose_name</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.name</span><br></pre></td></tr></tbody></table></figure>

<p><code>goods/serializer.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexCategorySerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    序列化一级分类，以及该分类下的品牌图片，二级分类，和子分类下的所有商品。</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># 某个大类的品牌商标图片，可以有多个商标，一对多的关系</span></span><br><span class="line">    brands = BrandSerializer(many=<span class="literal">True</span>)</span><br><span class="line">    <span class="comment"># goods = GoodsSerializer(many=True)  # 不能这样用，</span></span><br><span class="line">    <span class="comment"># 因为现在需要的是一级分类，</span></span><br><span class="line">    <span class="comment"># good有一个外键category，但而大多数商品的外键指向的是三级类，直接反向通过外键category（三级类），取某个大类下面的商品是取不出来的</span></span><br><span class="line">    <span class="comment"># 所以到自己查询一级分类子类别下的所有商品</span></span><br><span class="line">    goods = serializers.SerializerMethodField()</span><br><span class="line">    <span class="comment"># model中parent_category字段中定义的related_name="sub_cat"</span></span><br><span class="line">    sub_cat = SecondCategorySerializer(many=<span class="literal">True</span>)  <span class="comment"># 序列化二级商品分类</span></span><br><span class="line">    ad_goods = serializers.SerializerMethodField()  <span class="comment"># 广告商品</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_goods</span>(<span class="params">self, obj</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        自定义获取方法</span></span><br><span class="line"><span class="string">        查询相关父类子类每级分类下的所有商品</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        all_goods = Goods.objects.filter(Q(category_id=obj.id) | Q(category__parent_category_id=obj.id) | Q(</span><br><span class="line">            category__parent_category__parent_category_id=obj.id))</span><br><span class="line">        <span class="comment"># 将查询的商品集进行序列化</span></span><br><span class="line">        goods_serializer = GoodsSerializer(instance=all_goods, many=<span class="literal">True</span>, context={<span class="string">'request'</span>: self.context[<span class="string">'request'</span>]})</span><br><span class="line">        <span class="comment"># 返回json对象</span></span><br><span class="line">        <span class="keyword">return</span> goods_serializer.data</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = GoodsCategory</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br></pre></td></tr></tbody></table></figure>

<p><code>goods/views.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexCategoryViewSet</span>(<span class="params">mixins.ListModelMixin, viewsets.GenericViewSet</span>):</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    list:</span></span><br><span class="line"><span class="string">        首页分类、商品数据</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    queryset = GoodsCategory.objects.filter(is_delete=<span class="literal">False</span>, is_tab=<span class="literal">True</span>, name__in=[<span class="string">'生鲜食品'</span>, <span class="string">'酒水饮料'</span>])</span><br><span class="line">    serializer_class = IndexCategorySerializer</span><br></pre></td></tr></tbody></table></figure>

<p><code>url.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> goods.views <span class="keyword">import</span> IndexCategoryGoodsViewSet</span><br><span class="line">router.register(<span class="string">'indexgoods'</span>, IndexCategoryViewSet)</span><br></pre></td></tr></tbody></table></figure>

<p>后台类别广告中category过滤<br>当选择商品类别时，会显示所有级别的类别，如果想只显示一级分类，<br> apps/goods/admin.py</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@admin.register(IndexAd)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexAdAdmin</span>(<span class="params">admin.ModelAdmin</span>):</span></span><br><span class="line">    list_display = [<span class="string">'category'</span>, <span class="string">'goods'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">formfield_for_foreignkey</span>(<span class="params">self, db_field, request, **kwargs</span>):</span></span><br><span class="line">        <span class="keyword">if</span> db_field.name == <span class="string">'category'</span>:</span><br><span class="line">            <span class="comment"># 外键下拉框添加过滤</span></span><br><span class="line">            kwargs[<span class="string">'queryset'</span>] = GoodsCategory.objects.filter(category_type=<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> super(IndexAdAdmin, self).formfield_for_foreignkey(db_field, request, **kwargs)</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/05/06/drf-shi-tu-viewsets-he-guo-lu-qi-shi-xian-zhan-shi-shang-pin-lie-biao-ye-he-xiang-qing/14.png" alt="description"><br><img src="/2021/05/06/drf-shi-tu-viewsets-he-guo-lu-qi-shi-xian-zhan-shi-shang-pin-lie-biao-ye-he-xiang-qing/15.png" alt="description"><br><img src="/2021/05/06/drf-shi-tu-viewsets-he-guo-lu-qi-shi-xian-zhan-shi-shang-pin-lie-biao-ye-he-xiang-qing/16.png" alt="description"></p>
<h2 id="首页类别中的广告位和品牌图片"><a href="#首页类别中的广告位和品牌图片" class="headerlink" title="首页类别中的广告位和品牌图片"></a>首页类别中的广告位和品牌图片</h2><figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexAd</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    <span class="string">"""首页广告"""</span></span><br><span class="line">    category = models.ForeignKey(GoodsCategory, verbose_name=<span class="string">'商品类目'</span>, related_name=<span class="string">'category'</span>, null=<span class="literal">True</span>,</span><br><span class="line">                                 on_delete=models.CASCADE)</span><br><span class="line">    goods = models.ForeignKey(Goods, verbose_name=<span class="string">'商品'</span>, related_name=<span class="string">'goods'</span>, null=<span class="literal">True</span>, on_delete=models.CASCADE)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        verbose_name = <span class="string">'首页商品类别广告'</span></span><br><span class="line">        verbose_name_plural = verbose_name</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.goods.name</span><br></pre></td></tr></tbody></table></figure>

<p>``</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexCategorySerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    序列化一级分类，以及该分类下的品牌图片，二级分类，和子分类下的所有商品。</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># 某个大类的品牌商标图片，可以有多个商标，一对多的关系</span></span><br><span class="line">    brands = BrandSerializer(many=<span class="literal">True</span>)</span><br><span class="line">    <span class="comment"># goods = GoodsSerializer(many=True)  # 不能这样用，</span></span><br><span class="line">    <span class="comment"># 因为现在需要的是一级分类，</span></span><br><span class="line">    <span class="comment"># good有一个外键category，但而大多数商品的外键指向的是三级类，直接反向通过外键category（三级类），取某个大类下面的商品是取不出来的</span></span><br><span class="line">    <span class="comment"># 所以到自己查询一级分类子类别下的所有商品</span></span><br><span class="line">    goods = serializers.SerializerMethodField()</span><br><span class="line">    <span class="comment"># model中parent_category字段中定义的related_name="sub_cat"</span></span><br><span class="line">    sub_cat = SecondCategorySerializer(many=<span class="literal">True</span>)  <span class="comment"># 序列化二级商品分类</span></span><br><span class="line">    ad_goods = serializers.SerializerMethodField()  <span class="comment"># 广告商品</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_ad_goods</span>(<span class="params">self, obj</span>):</span></span><br><span class="line">        goods_json = {}</span><br><span class="line">        ad_goods = IndexAd.objects.filter(category_id=obj.id)</span><br><span class="line">        <span class="keyword">if</span> ad_goods:</span><br><span class="line">            good_instance = ad_goods[<span class="number">0</span>].goods  <span class="comment"># 获取到商品分类对应的商品</span></span><br><span class="line">            <span class="comment"># 在serializer里面调用用另一个serializer是不会自动加上域名的，序列化嵌套序列化商品图片url加上域名，需要在嵌套的Serializer中添加一个参数ontext（上下文request），</span></span><br><span class="line">            <span class="comment"># serializer返回的时候一定要加 “.data” ，这样才是json数据</span></span><br><span class="line">            goods_json = GoodsSerializer(instance=good_instance, many=<span class="literal">False</span>,</span><br><span class="line">                                         context={<span class="string">'request'</span>: self.context[<span class="string">'request'</span>]}).data</span><br><span class="line">        <span class="keyword">return</span> goods_json</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = GoodsCategory</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br></pre></td></tr></tbody></table></figure>

<p>商品点击数，<a target="_blank" rel="noopener" href="http://127.0.0.1:8000/goods/12/">http://127.0.0.1:8000/goods/12/</a>进入商品详情时，增加点击数。</p>
<p><code>apps/goods/views.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GoodsListViewSet</span>(<span class="params">mixins.ListModelMixin, mixins.RetrieveModelMixin, viewsets.GenericViewSet</span>):</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    retrieve:</span></span><br><span class="line"><span class="string">        商品详情，并实现热卖商品接口</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    queryset = Goods.objects.filter(is_delete=<span class="literal">False</span>).order_by(<span class="string">'id'</span>)</span><br><span class="line">    serializer_class = GoodsSerializer</span><br><span class="line">    pagination_class = GoodsPagination</span><br><span class="line"></span><br><span class="line">    filter_backends = [DjangoFilterBackend, filters.SearchFilter, filters.OrderingFilter]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># filter_fields = ('name', 'shop_price')</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># def get_queryset(self):</span></span><br><span class="line">    <span class="comment">#     queryset = Goods.objects.all()</span></span><br><span class="line">    <span class="comment">#     price_min = self.request.query_params.get('price_min', 0)</span></span><br><span class="line">    <span class="comment">#     if price_min:</span></span><br><span class="line">    <span class="comment">#         queryset = queryset.filter(shop_price__gt=int(price_min))</span></span><br><span class="line">    <span class="comment">#     return queryset</span></span><br><span class="line"></span><br><span class="line">    filter_class = GoodsFilter</span><br><span class="line">    search_fields = [<span class="string">'name'</span>, <span class="string">'goods_brief'</span>, <span class="string">'goods_desc'</span>]</span><br><span class="line">    ordering_fields = [<span class="string">'sold_num'</span>, <span class="string">'shop_price'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_queryset</span>(<span class="params">self</span>):</span></span><br><span class="line">        keyword = self.request.query_params.get(<span class="string">'search'</span>)</span><br><span class="line">        <span class="keyword">if</span> keyword:</span><br><span class="line">            <span class="keyword">from</span> utils.hotsearch <span class="keyword">import</span> HotSearch</span><br><span class="line">            hot_search = HotSearch()</span><br><span class="line">            hot_search.save_keyword(keyword)</span><br><span class="line">        <span class="keyword">return</span> self.queryset</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">retrieve</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="string">'''重写实现点击数'''</span></span><br><span class="line">        instance = self.get_object()</span><br><span class="line">        instance.click_num += <span class="number">1</span></span><br><span class="line">        instance.save()</span><br><span class="line">        serializer = self.get_serializer(instance)</span><br><span class="line">        <span class="keyword">return</span> Response(serializer.data)</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/05/06/drf-shi-tu-viewsets-he-guo-lu-qi-shi-xian-zhan-shi-shang-pin-lie-biao-ye-he-xiang-qing/17.png" alt="description"></p>
<h2 id="结合Redis实现热搜关键字显示"><a href="#结合Redis实现热搜关键字显示" class="headerlink" title="结合Redis实现热搜关键字显示"></a>结合Redis实现热搜关键字显示</h2><p>采用redis的有序集合实现，每次搜索的关键字保存在redis，重复时将对应的分数+1</p>
<h4 id="获取参数中的关键字"><a href="#获取参数中的关键字" class="headerlink" title="获取参数中的关键字"></a>获取参数中的关键字</h4><p>apps/goods/views.py GoodsListViewSet在商品过滤时提取集中的搜索关键字参数</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/05/06/beego-de-orm/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/06/beego-de-orm/" class="post-title-link" itemprop="url">beego的orm</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-05-05 16:21:41" itemprop="dateCreated datePublished" datetime="2021-05-05T16:21:41Z">2021-05-05</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-07-10 12:13:48" itemprop="dateModified" datetime="2021-07-10T12:13:48Z">2021-07-10</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/django/" itemprop="url" rel="index"><span itemprop="name">django</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="orm"><a href="#orm" class="headerlink" title="orm"></a>orm</h3><p>在关系型数据库和对象之间作一个映射，在操作数据库时，不需要写复杂的SQL语句，只需要像操作对象一样。</p>
<p>ORM对象被设计为无状态的，因而天然是线程安全的。<br>建议在使用过程中，一个数据库应该只存在一个ORM对象。</p>
<p><code>conf/app.conf</code></p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">appname = demo</span><br><span class="line">httpport = 8080</span><br><span class="line">runmode = dev</span><br><span class="line"></span><br><span class="line">[dev]</span><br><span class="line">defaultdb = root:password@(127.0.0.1:3306)/fyouku?charset=utf8</span><br><span class="line">redisdb = 127.0.0.1:6379</span><br><span class="line">rabbitmq = amqp://guest:guest@127.0.0.1:5672/</span><br><span class="line"></span><br><span class="line">[prod]</span><br><span class="line">defaultdb = root:password@(127.0.0.1:3306)/fyouku?charset=utf8</span><br><span class="line">redisdb = 127.0.0.1:6379</span><br><span class="line">rabbitmq = amqp://guest:guest@127.0.0.1:5672/</span><br></pre></td></tr></tbody></table></figure>

<h3 id="配置数据库信息，加载信息"><a href="#配置数据库信息，加载信息" class="headerlink" title="配置数据库信息，加载信息"></a>配置数据库信息，加载信息</h3><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    _ <span class="string">"demo/routers"</span></span><br><span class="line">    <span class="comment">// 引入orm</span></span><br><span class="line">    <span class="string">"github.com/beego/beego/v2/client/orm"</span></span><br><span class="line">    <span class="string">"github.com/beego/beego/v2/server/web"</span></span><br><span class="line">    _ <span class="string">"github.com/go-sql-driver/mysql"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="comment">//获取配置文件中信息</span></span><br><span class="line">    <span class="comment">//defaultdb := web.AppConfig.String("defaultdb")</span></span><br><span class="line">    <span class="comment">//defaultdb := web.AppConfig.String("root:123456@(127.0.0.1:3306)/fyouku?charset=utf8")</span></span><br><span class="line">    orm.RegisterDriver(<span class="string">"mysql"</span>, orm.DRMySQL)</span><br><span class="line">    <span class="comment">//orm.RegisterDataBase("default", "mysql", defaultdb)</span></span><br><span class="line">    <span class="comment">// ORM 必须注册一个别名为 default 的数据库，作为默认使用</span></span><br><span class="line">    orm.RegisterDataBase(<span class="string">"default"</span>, <span class="string">"mysql"</span>, <span class="string">"root:password@(127.0.0.1:3306)/fyouku?charset=utf8"</span>)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    web.Run()</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="crud的read"><a href="#crud的read" class="headerlink" title="crud的read"></a>crud的read</h2><p><code>models/User.go</code></p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> models</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"github.com/beego/beego/v2/client/orm"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 操作数据库都需要定义struct和表结构对应</span></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> {</span><br><span class="line">    Id      <span class="keyword">int</span></span><br><span class="line">    Name    <span class="keyword">string</span></span><br><span class="line">    AddTime <span class="keyword">int64</span></span><br><span class="line">    Status  <span class="keyword">int</span></span><br><span class="line">    Mobile  <span class="keyword">string</span></span><br><span class="line">    Avatar  <span class="keyword">string</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化注册对应model</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="comment">// 注册model</span></span><br><span class="line">    orm.RegisterModel(<span class="built_in">new</span>(User))</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取用户信息</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">UserInfo</span><span class="params">(id <span class="keyword">int</span>)</span> <span class="params">(User, error)</span></span> {</span><br><span class="line">    <span class="comment">// 通过orm中的Read函数获取</span></span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        err error</span><br><span class="line">    )</span><br><span class="line">    o := orm.NewOrm()</span><br><span class="line">    user := User{Id: id}</span><br><span class="line">    err = o.Read(&amp;user)</span><br><span class="line">    <span class="keyword">return</span> user, err</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><code>controllers/demo.go</code></p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通过id获取用户名</span></span><br><span class="line"><span class="comment">// @router /user/username [get]</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(this *DemoController)</span> <span class="title">GetUsername</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        id    <span class="keyword">int</span></span><br><span class="line">        err   error</span><br><span class="line">        title <span class="keyword">string</span></span><br><span class="line">        user  models.User</span><br><span class="line">    )</span><br><span class="line">    <span class="comment">//接受浏览器中的参数</span></span><br><span class="line">    id, err = this.GetInt(<span class="string">"id"</span>)</span><br><span class="line">    user, err = models.UserInfo(id)</span><br><span class="line">    <span class="keyword">if</span> err == <span class="literal">nil</span> {</span><br><span class="line">        title = user.Name</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        title = <span class="string">"抱歉，服务器走丢了"</span></span><br><span class="line">    }</span><br><span class="line">    this.Ctx.WriteString(title)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/05/06/beego-de-orm/1.png" alt="description"></p>
<h3 id="insert"><a href="#insert" class="headerlink" title="insert"></a>insert</h3><p><code>models/User.go</code></p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 保存用户</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Save</span><span class="params">(name <span class="keyword">string</span>, mobile <span class="keyword">string</span>, avatar <span class="keyword">string</span>)</span> <span class="title">error</span></span> {</span><br><span class="line">    <span class="comment">// 通过orm中的Insert来保存</span></span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        err  error</span><br><span class="line">        user User</span><br><span class="line">    )</span><br><span class="line">    o := orm.NewOrm()</span><br><span class="line">    <span class="comment">// 设置字段的值</span></span><br><span class="line">    user.Name = name</span><br><span class="line">    user.Mobile = mobile</span><br><span class="line">    user.Avatar = avatar</span><br><span class="line">    user.Status = <span class="number">0</span></span><br><span class="line">    _, err = o.Insert(&amp;user)</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><code>controllers/demo.go</code></p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 实现用户注册功能</span></span><br><span class="line"><span class="comment">// @router /user/save [get]</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(this *DemoController)</span> <span class="title">Save</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        name   <span class="keyword">string</span></span><br><span class="line">        mobile <span class="keyword">string</span></span><br><span class="line">        avatar <span class="keyword">string</span></span><br><span class="line">        err    error</span><br><span class="line">        title  <span class="keyword">string</span></span><br><span class="line">    )</span><br><span class="line">    name = this.GetString(<span class="string">"name"</span>)</span><br><span class="line">    mobile = this.GetString(<span class="string">"mobile"</span>)</span><br><span class="line">    avatar = this.GetString(<span class="string">"avatar"</span>)</span><br><span class="line">    err = models.Save(name, mobile, avatar)</span><br><span class="line">    <span class="keyword">if</span> err == <span class="literal">nil</span> {</span><br><span class="line">        title = <span class="string">"恭喜，保存成功了"</span></span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        title = <span class="string">"抱歉，服务器又走丢了"</span></span><br><span class="line">    }</span><br><span class="line">    this.Ctx.WriteString(title)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/05/06/beego-de-orm/2.png" alt="description"><br><img src="/2021/05/06/beego-de-orm/3.png" alt="description"></p>
<h3 id="Update"><a href="#Update" class="headerlink" title="Update"></a>Update</h3><p><code>models/User.go</code></p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 更新用户名</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">UpdateUsername</span><span class="params">(id <span class="keyword">int</span>, name <span class="keyword">string</span>)</span> <span class="title">error</span></span> {</span><br><span class="line">    <span class="comment">// 通过orm中的Update来保存</span></span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        user User</span><br><span class="line">        err  error</span><br><span class="line">    )</span><br><span class="line">    o := orm.NewOrm()</span><br><span class="line">    user = User{Id: id}</span><br><span class="line">    <span class="keyword">if</span> o.Read(&amp;user) == <span class="literal">nil</span> {</span><br><span class="line">        user.Name = name</span><br><span class="line">        _, err = o.Update(&amp;user)</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><code>controllers/demo.go</code></p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 实现修改用户名</span></span><br><span class="line"><span class="comment">// @router /user/update [get]</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(this *DemoController)</span> <span class="title">UpdateUsername</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        id    <span class="keyword">int</span></span><br><span class="line">        name  <span class="keyword">string</span></span><br><span class="line">        title <span class="keyword">string</span></span><br><span class="line">        err   error</span><br><span class="line">    )</span><br><span class="line">    id, err = this.GetInt(<span class="string">"id"</span>)</span><br><span class="line">    name = this.GetString(<span class="string">"name"</span>)</span><br><span class="line">    err = models.UpdateUsername(id, name)</span><br><span class="line">    <span class="keyword">if</span> err == <span class="literal">nil</span> {</span><br><span class="line">        title = <span class="string">"恭喜，名字修改成功了"</span></span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        title = <span class="string">"抱歉，服务器又走丢了"</span></span><br><span class="line">    }</span><br><span class="line">    this.Ctx.WriteString(title)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/05/06/beego-de-orm/4.png" alt="description"><br><img src="/2021/05/06/beego-de-orm/5.png" alt="description"></p>
<h3 id="delete"><a href="#delete" class="headerlink" title="delete"></a>delete</h3><p><code>models/User.go</code></p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 删除用户，通过ID删除数据</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Delete</span><span class="params">(id <span class="keyword">int</span>)</span> <span class="title">error</span></span> {</span><br><span class="line">    <span class="comment">// 通过orm中的Delete来保存</span></span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        user User</span><br><span class="line">        err  error</span><br><span class="line">    )</span><br><span class="line">    o := orm.NewOrm()</span><br><span class="line">    user = User{Id: id}</span><br><span class="line">    _, err = o.Delete(&amp;user)</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><code>controllers/demo.go</code></p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 删除用户</span></span><br><span class="line"><span class="comment">// @router /user/delete [get]</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(this *DemoController)</span> <span class="title">Delete</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        id    <span class="keyword">int</span></span><br><span class="line">        err   error</span><br><span class="line">        title <span class="keyword">string</span></span><br><span class="line">    )</span><br><span class="line">    id, err = this.GetInt(<span class="string">"id"</span>)</span><br><span class="line"></span><br><span class="line">    err = models.Delete(id)</span><br><span class="line">    <span class="keyword">if</span> err == <span class="literal">nil</span> {</span><br><span class="line">        title = <span class="string">"恭喜，您成功的把自己删除了"</span></span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        title = <span class="string">"抱歉，服务器怎么又走丢了"</span></span><br><span class="line">    }</span><br><span class="line">    this.Ctx.WriteString(title)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/05/06/beego-de-orm/6.png" alt="description"><br><img src="/2021/05/06/beego-de-orm/7.png" alt="description"></p>
<h3 id="高级查询"><a href="#高级查询" class="headerlink" title="高级查询"></a>高级查询</h3><p><code>models/User.go</code></p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取用户列表</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">List</span><span class="params">()</span> <span class="params">([]User, error)</span></span> {</span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        users []User</span><br><span class="line">        err   error</span><br><span class="line">    )</span><br><span class="line">    o := orm.NewOrm()</span><br><span class="line">    qs := o.QueryTable(<span class="string">"user"</span>)  <span class="comment">// 声明操作的表</span></span><br><span class="line">    qs = qs.Filter(<span class="string">"id__lt"</span>, <span class="number">15</span>)  <span class="comment">// 条件id小于15</span></span><br><span class="line">    qs = qs.Limit(<span class="number">2</span>)  <span class="comment">// 返回几条数据</span></span><br><span class="line">    qs = qs.OrderBy(<span class="string">"-id"</span>) <span class="comment">// 倒序是前面加上负号</span></span><br><span class="line">    qs.All(&amp;users, <span class="string">"Id"</span>, <span class="string">"Name"</span>)  <span class="comment">// 设置返回的字段</span></span><br><span class="line">    <span class="keyword">return</span> users, err</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><code>controllers/demo.go</code></p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取用户列表</span></span><br><span class="line"><span class="comment">// @router /user/list [get]</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(this *DemoController)</span> <span class="title">List</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        err   error</span><br><span class="line">        title <span class="keyword">string</span></span><br><span class="line">        users []models.User</span><br><span class="line">    )</span><br><span class="line">    users, err = models.List()</span><br><span class="line">    <span class="keyword">if</span> err == <span class="literal">nil</span> {</span><br><span class="line">        <span class="keyword">for</span> _, v := <span class="keyword">range</span> users {</span><br><span class="line">            title += v.Name + <span class="string">","</span></span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        title = <span class="string">"抱歉，一个人也没有了"</span></span><br><span class="line">    }</span><br><span class="line">    this.Ctx.WriteString(title)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/05/06/beego-de-orm/8.png" alt="description"></p>
<h2 id="数据库原生SQL语句操作数据库"><a href="#数据库原生SQL语句操作数据库" class="headerlink" title="数据库原生SQL语句操作数据库"></a>数据库原生SQL语句操作数据库</h2><ul>
<li><p><code>QueryRow</code> 获取单条数据使用</p>
</li>
<li><p><code>QueryRows</code> 获取多条数据使用</p>
</li>
<li><p><code>Exec</code>  执行insert\update\delete语句</p>
</li>
</ul>
<h2 id="crud的read-1"><a href="#crud的read-1" class="headerlink" title="crud的read"></a>crud的read</h2><p><code>models/User.go</code></p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通过sql获取用户信息</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SqlUserInfo</span><span class="params">(id <span class="keyword">int</span>)</span> <span class="params">(User, error)</span></span> {</span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        user User</span><br><span class="line">        err  error</span><br><span class="line">    )</span><br><span class="line">    o := orm.NewOrm()</span><br><span class="line">    err = o.Raw(<span class="string">"SELECT `name`,`mobile` FROM user Where id=? LIMIT 1"</span>, id).QueryRow(&amp;user)</span><br><span class="line">    <span class="keyword">return</span> user, err</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><code>controllers/demo.go</code></p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通过原生sql方式获取用户信息</span></span><br><span class="line"><span class="comment">// @router /sql/user/userinfo [get]</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(this *DemoController)</span> <span class="title">SqlUserInfo</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        id    <span class="keyword">int</span></span><br><span class="line">        err   error</span><br><span class="line">        title <span class="keyword">string</span></span><br><span class="line">        user  models.User</span><br><span class="line">    )</span><br><span class="line">    id, err = this.GetInt(<span class="string">"id"</span>)</span><br><span class="line">    user, err = models.SqlUserInfo(id)</span><br><span class="line">    <span class="keyword">if</span> err == <span class="literal">nil</span> {</span><br><span class="line">        title = <span class="string">"用户名："</span> + user.Name + <span class="string">"，手机号："</span> + user.Mobile</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        title = <span class="string">"抱歉，没有这个人"</span></span><br><span class="line">    }</span><br><span class="line">    this.Ctx.WriteString(title)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/05/06/beego-de-orm/9.png" alt="description"></p>
<h2 id="crud的INSERT"><a href="#crud的INSERT" class="headerlink" title="crud的INSERT"></a>crud的INSERT</h2><p><code>models/User.go</code></p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通过sql保存用户</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SqlSave</span><span class="params">(name <span class="keyword">string</span>, mobile <span class="keyword">string</span>, avatar <span class="keyword">string</span>)</span> <span class="title">error</span></span> {</span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        err error</span><br><span class="line">    )</span><br><span class="line">    o := orm.NewOrm()</span><br><span class="line">    _, err = o.Raw(<span class="string">"INSERT INTO user (`name`, `mobile`, `avatar`, `status`) VALUES (?, ?, ?, ?)"</span>, name, mobile, avatar, <span class="number">0</span>).Exec()</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><code>controllers/demo.go</code></p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通过原生sql保存用户</span></span><br><span class="line"><span class="comment">// @router /sql/user/save [get]</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(this *DemoController)</span> <span class="title">SqlSave</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        err    error</span><br><span class="line">        title  <span class="keyword">string</span></span><br><span class="line">        name   <span class="keyword">string</span></span><br><span class="line">        mobile <span class="keyword">string</span></span><br><span class="line">        avatar <span class="keyword">string</span></span><br><span class="line">    )</span><br><span class="line">    name = this.GetString(<span class="string">"name"</span>)</span><br><span class="line">    mobile = this.GetString(<span class="string">"mobile"</span>)</span><br><span class="line">    avatar = this.GetString(<span class="string">"avatar"</span>)</span><br><span class="line">    err = models.SqlSave(name, mobile, avatar)</span><br><span class="line">    <span class="keyword">if</span> err == <span class="literal">nil</span> {</span><br><span class="line">        title = <span class="string">"保存成功了"</span></span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        title = <span class="string">"抱歉，服务器走丢了"</span></span><br><span class="line">    }</span><br><span class="line">    this.Ctx.WriteString(title)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/05/06/beego-de-orm/10.png" alt="description"><br><img src="/2021/05/06/beego-de-orm/11.png" alt="description"></p>
<h2 id="crud的UPDATE"><a href="#crud的UPDATE" class="headerlink" title="crud的UPDATE"></a>crud的UPDATE</h2><p><code>models/User.go</code></p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 原生sql修改用户名</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SqlUpdateUsername</span><span class="params">(id <span class="keyword">int</span>, name <span class="keyword">string</span>)</span> <span class="title">error</span></span> {</span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        err error</span><br><span class="line">    )</span><br><span class="line">    o := orm.NewOrm()</span><br><span class="line">    _, err = o.Raw(<span class="string">"UPDATE user SET name=? WHERE id=?"</span>, name, id).Exec()</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><code>controllers/demo.go</code></p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 原生sql修改用户名</span></span><br><span class="line"><span class="comment">// @router /sql/user/updatename [get]</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(this *DemoController)</span> <span class="title">SqlUpdateUsername</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        err   error</span><br><span class="line">        title <span class="keyword">string</span></span><br><span class="line">        id    <span class="keyword">int</span></span><br><span class="line">        name  <span class="keyword">string</span></span><br><span class="line">    )</span><br><span class="line">    id, err = this.GetInt(<span class="string">"id"</span>)</span><br><span class="line">    name = this.GetString(<span class="string">"name"</span>)</span><br><span class="line">    err = models.SqlUpdateUsername(id, name)</span><br><span class="line">    <span class="keyword">if</span> err == <span class="literal">nil</span> {</span><br><span class="line">        title = <span class="string">"恭喜，您把自己的名字改了"</span></span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        title = <span class="string">"抱歉，服务器又丢了~"</span></span><br><span class="line">    }</span><br><span class="line">    this.Ctx.WriteString(title)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/05/06/beego-de-orm/12.png" alt="description"><br><img src="/2021/05/06/beego-de-orm/13.png" alt="description"></p>
<h2 id="crud的UPDATE-1"><a href="#crud的UPDATE-1" class="headerlink" title="crud的UPDATE"></a>crud的UPDATE</h2><p><code>models/User.go</code></p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 原生sql删除用户</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SqlDelete</span><span class="params">(id <span class="keyword">int</span>)</span> <span class="title">error</span></span> {</span><br><span class="line">    o := orm.NewOrm()</span><br><span class="line">    _, err := o.Raw(<span class="string">"DELETE FROM user WHERE id=?"</span>, id).Exec()</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><code>controllers/demo.go</code></p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通过原生sql删除用户</span></span><br><span class="line"><span class="comment">// @router /sql/user/delete [get]</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(this *DemoController)</span> <span class="title">SqlDelete</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        id    <span class="keyword">int</span></span><br><span class="line">        err   error</span><br><span class="line">        title <span class="keyword">string</span></span><br><span class="line">    )</span><br><span class="line">    id, err = this.GetInt(<span class="string">"id"</span>)</span><br><span class="line">    err = models.SqlDelete(id)</span><br><span class="line">    <span class="keyword">if</span> err == <span class="literal">nil</span> {</span><br><span class="line">        title = <span class="string">"恭喜，您成功把自己删除了"</span></span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        title = <span class="string">"抱歉，删除错误，请联系客服"</span></span><br><span class="line">    }</span><br><span class="line">    this.Ctx.WriteString(title)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/05/06/beego-de-orm/14.png" alt="description"><br><img src="/2021/05/06/beego-de-orm/15.png" alt="description"></p>
<h2 id="crud的查询"><a href="#crud的查询" class="headerlink" title="crud的查询"></a>crud的查询</h2><p><code>models/User.go</code></p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 原生sql实现获取用户列表</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SqlList</span><span class="params">()</span> <span class="params">(<span class="keyword">int64</span>, []User, error)</span></span> {</span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        users []User</span><br><span class="line">    )</span><br><span class="line">    o := orm.NewOrm()</span><br><span class="line">    num, err := o.Raw(<span class="string">"SELECT * FROM user WHERE id&lt;? ORDER BY id DESC LIMIT 2"</span>, <span class="number">15</span>).QueryRows(&amp;users)</span><br><span class="line">    <span class="keyword">return</span> num, users, err</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><code>controllers/demo.go</code></p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 原生sql获取用户列表</span></span><br><span class="line"><span class="comment">// @router /sql/user/list [get]</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(this *DemoController)</span> <span class="title">SqlList</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        err   error</span><br><span class="line">        title <span class="keyword">string</span></span><br><span class="line">        users []models.User</span><br><span class="line">    )</span><br><span class="line">    _, users, err = models.SqlList()</span><br><span class="line">    <span class="keyword">if</span> err == <span class="literal">nil</span> {</span><br><span class="line">        <span class="keyword">for</span> _, v := <span class="keyword">range</span> users {</span><br><span class="line">            title += v.Name + <span class="string">","</span></span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        title = <span class="string">"没有相关信息"</span></span><br><span class="line">    }</span><br><span class="line">    this.Ctx.WriteString(title)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">WHERE</span> <span class="keyword">id</span>&lt;<span class="number">15</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">id</span> <span class="keyword">DESC</span> <span class="keyword">LIMIT</span> <span class="number">2</span>;</span><br><span class="line">id | name | password | addtime | stauts | mobile | avatar</span><br><span class="line">14,test3,,1583293416,0,18600008888,我是头像</span><br><span class="line">13,王五,781305f065731d4dffc1033493b03c9c,1581631477,0,18699993333,</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/05/06/beego-de-orm/16.png" alt="description"></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/05/06/drf-yong-hu-liu-yan-he-huo-qu-shou-huo-di-zhi/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/06/drf-yong-hu-liu-yan-he-huo-qu-shou-huo-di-zhi/" class="post-title-link" itemprop="url">drf用户留言和获取收获地址</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-05-05 16:21:41" itemprop="dateCreated datePublished" datetime="2021-05-05T16:21:41Z">2021-05-05</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-06-09 02:45:03" itemprop="dateModified" datetime="2021-06-09T02:45:03Z">2021-06-09</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/django/" itemprop="url" rel="index"><span itemprop="name">django</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="用户留言功能"><a href="#用户留言功能" class="headerlink" title="用户留言功能"></a>用户留言功能</h2><p>用户留言包括添加、获取和删除等功能。</p>
<p><code>user_operation/serializers.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> UserFav, UserLeavingMessage</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LeavingMessageSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    用户留言序列化</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    <span class="comment"># 获取当前登录的用户</span></span><br><span class="line">    user = serializers.HiddenField(default=serializers.CurrentUserDefault())</span><br><span class="line">    <span class="comment"># read_only=True只返回而不提交，不手动输入时间、而是自动生成</span></span><br><span class="line">    add_time = serializers.DateTimeField(read_only=<span class="literal">True</span>, format=<span class="string">'%Y-%m-%d %H:%M'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = UserLeavingMessage</span><br><span class="line">        fields = [<span class="string">'id'</span>, <span class="string">'user'</span>, <span class="string">'message_type'</span>, <span class="string">'subject'</span>, <span class="string">'message'</span>, <span class="string">'file'</span>, <span class="string">'add_time'</span>]</span><br></pre></td></tr></tbody></table></figure>

<p><code>user_operation/views.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> UserLeavingMessageSerializer</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> UserLeavingMessage</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LeavingMessageViewSet</span>(<span class="params">mixins.CreateModelMixin, mixins.ListModelMixin, mixins.DestroyModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                            viewsets.GenericViewSet</span>):</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    list:</span></span><br><span class="line"><span class="string">        留言列表</span></span><br><span class="line"><span class="string">    create:</span></span><br><span class="line"><span class="string">        添加留言</span></span><br><span class="line"><span class="string">    delete:</span></span><br><span class="line"><span class="string">        删除留言</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    queryset = UserLeavingMessage.objects.all()</span><br><span class="line">    permission_classes = [IsAuthenticated, IsOwnerOrReadOnly]</span><br><span class="line">    authentication_classes = [JWTAuthentication, SessionAuthentication]</span><br><span class="line">    serializer_class = LeavingMessageSerializer</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_queryset</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">"""只能看到自己的留言"""</span></span><br><span class="line">        <span class="comment"># return self.queryset.filter(user=self.request.user)</span></span><br><span class="line">        <span class="keyword">return</span> UserLeavingMessage.objects.filter(user=self.request.user, is_delete=<span class="literal">False</span>)</span><br></pre></td></tr></tbody></table></figure>

<p><code>url.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> user_operation.views <span class="keyword">import</span> UserLeavingMessageViewSet</span><br><span class="line"></span><br><span class="line">router.register(<span class="string">'messages'</span>, LeavingMessageViewSet)</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/05/06/drf-yong-hu-liu-yan-he-huo-qu-shou-huo-di-zhi/0.png" alt="description"><br><img src="/2021/05/06/drf-yong-hu-liu-yan-he-huo-qu-shou-huo-di-zhi/1.jpeg" alt="description"></p>
<h2 id="用户收获地址"><a href="#用户收获地址" class="headerlink" title="用户收获地址"></a>用户收获地址</h2><p><code>user_operation/serializers.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> UserAddress</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AddressSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    user = serializers.HiddenField(default=serializers.CurrentUserDefault())</span><br><span class="line">    <span class="comment"># read_only=True只返回而不提交，不手动输入时间、而是自动生成</span></span><br><span class="line">    add_time = serializers.DateTimeField(read_only=<span class="literal">True</span>, format=<span class="string">'%Y-%m-%d %H:%M'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = UserAddress</span><br><span class="line">        fields = [<span class="string">'id'</span>, <span class="string">'user'</span>, <span class="string">'province'</span>, <span class="string">'city'</span>, <span class="string">'district'</span>, <span class="string">'address'</span>, <span class="string">'signer_name'</span>, <span class="string">'add_time'</span>, <span class="string">'signer_mobile'</span>]</span><br></pre></td></tr></tbody></table></figure>

<p>如果地址对应的数据接口需要支持GET、POST、PUT、PATCH、DELETE请求来支持对地址资源的获取、新增、更新、删除 增删改查操作，<br>更为简单的做法是继承<code>ModelViewSet</code>来编写地址视图类。再次修改<code>user_operation/views.py</code>文件添加一个名为<code>LeavingMessageViewSet</code>的类</p>
<p>通过查看<code>ModelViewSet</code>类的源代码可以发现，该类共有6个父类，其中前5个父类分别实现对POST（新增地址）、GET（获取指定地址）、PUT/PATCH（更新地址）、DELETE（删除地址）和GET（获取地址列表）操作的支持，对应的方法分别是<code>create</code>、<code>retrieve</code>、<code>update</code>、<code>destroy</code>和<code>list</code>。由于<code>ModelViewSet</code>的父类中已经实现了这些方法，所以我们几乎没有编写任何代码就完成了地址数据全套接口的开发，我们要做的仅仅是指出如何获取到数据（通过<code>queryset</code>属性指定）以及如何序列化数据（通过<code>serializer_class</code>属性指定）</p>
<p><code>user_operation/views.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AddressViewSet</span>(<span class="params">viewsets.ModelViewSet</span>):</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    收货地址管理</span></span><br><span class="line"><span class="string">    list:</span></span><br><span class="line"><span class="string">        收货地址列表</span></span><br><span class="line"><span class="string">    create:</span></span><br><span class="line"><span class="string">        新建收货地址</span></span><br><span class="line"><span class="string">    update:</span></span><br><span class="line"><span class="string">        更新收货地址</span></span><br><span class="line"><span class="string">    delete:</span></span><br><span class="line"><span class="string">        删除收货地址</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    queryset = UserAddress.objects.all()</span><br><span class="line">    <span class="comment"># 用户必须登录才能访问</span></span><br><span class="line">    permission_classes = [IsAuthenticated, IsOwnerOrReadOnly]</span><br><span class="line">    <span class="comment"># 配置登录认证：支持JWT认证和DRF基本认证</span></span><br><span class="line">    authentication_classes = [JWTAuthentication, SessionAuthentication]</span><br><span class="line">    serializer_class = AddressSerializer</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_queryset</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> UserAddress.objects.filter(user=self.request.user, is_delete=<span class="literal">False</span>)</span><br></pre></td></tr></tbody></table></figure>

<p><code>url.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> user_operation.views <span class="keyword">import</span> AddressViewSet</span><br><span class="line"></span><br><span class="line">router.register(<span class="string">'address'</span>, AddressViewSet)</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/05/06/drf-yong-hu-liu-yan-he-huo-qu-shou-huo-di-zhi/2.png" alt="description"><br><img src="/2021/05/06/drf-yong-hu-liu-yan-he-huo-qu-shou-huo-di-zhi/3.png" alt="description"></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/05/06/drf-ding-dan/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/06/drf-ding-dan/" class="post-title-link" itemprop="url">drf订单</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-05-05 16:21:41" itemprop="dateCreated datePublished" datetime="2021-05-05T16:21:41Z">2021-05-05</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-06-15 01:50:33" itemprop="dateModified" datetime="2021-06-15T01:50:33Z">2021-06-15</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/django/" itemprop="url" rel="index"><span itemprop="name">django</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>用户添加商品到购物车，点去购物车结算，填上地址留言，结算生成订单，在会员中心我的订单里面，可以看到订单列表，点订单可以看到订单的详细信息。</p>
<p>先看模型</p>
<p><code>trade/model.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderInfo</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    <span class="string">'''订单信息'''</span></span><br><span class="line">    ORDER_STATUS = (</span><br><span class="line">        (<span class="string">"TRADE_SUCCESS"</span>, <span class="string">"支付成功"</span>),</span><br><span class="line">        (<span class="string">"TRADE_CLOSED"</span>, <span class="string">"交易关闭"</span>),</span><br><span class="line">        (<span class="string">"WAIT_BUYER_PAY"</span>, <span class="string">"交易创建"</span>),</span><br><span class="line">        (<span class="string">"TRADE_FINISHED"</span>, <span class="string">"交易完结"</span>),</span><br><span class="line">    )</span><br><span class="line">    user = models.ForeignKey(User, verbose_name=<span class="string">'用户'</span>, null=<span class="literal">True</span>, on_delete=models.CASCADE)</span><br><span class="line">    <span class="comment"># 订单编号是在提交订单之后生成的，因此在创建记录时应该允许为空</span></span><br><span class="line">    order_sn = models.CharField(max_length=<span class="number">30</span>, unique=<span class="literal">True</span>, null=<span class="literal">True</span>, blank=<span class="literal">True</span>, verbose_name=<span class="string">'订单号'</span>)</span><br><span class="line">    trade_no = models.CharField(max_length=<span class="number">50</span>, unique=<span class="literal">True</span>, null=<span class="literal">True</span>, blank=<span class="literal">True</span>, verbose_name=<span class="string">'交易号'</span>)</span><br><span class="line">    pay_status = models.CharField(max_length=<span class="number">30</span>, default=<span class="string">'WAIT_BUYER_PAY'</span>, choices=ORDER_STATUS, verbose_name=<span class="string">'订单状态'</span>)</span><br><span class="line">    post_script = models.CharField(max_length=<span class="number">11</span>, default=<span class="string">''</span>, null=<span class="literal">True</span>, blank=<span class="literal">True</span>, verbose_name=<span class="string">'订单留言'</span>)</span><br><span class="line">    order_amount = models.FloatField(default=<span class="number">0.0</span>, verbose_name=<span class="string">'订单金额'</span>)</span><br><span class="line">    pay_time = models.DateTimeField(null=<span class="literal">True</span>, blank=<span class="literal">True</span>, verbose_name=<span class="string">'支付时间'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 用户基本信息</span></span><br><span class="line">    <span class="comment"># address不直接使用外键，因为用户如果修改了个人中心的收货地址，订单中地址就会跟着变化</span></span><br><span class="line">    address = models.CharField(max_length=<span class="number">100</span>, default=<span class="string">''</span>, verbose_name=<span class="string">'收货地址'</span>)</span><br><span class="line">    signer_name = models.CharField(max_length=<span class="number">20</span>, default=<span class="string">''</span>, verbose_name=<span class="string">'签收人'</span>)</span><br><span class="line">    signer_mobile = models.CharField(max_length=<span class="number">11</span>, verbose_name=<span class="string">'联系电话'</span>)</span><br><span class="line"></span><br><span class="line">    add_time = models.DateTimeField(auto_now_add=<span class="literal">True</span>, verbose_name=<span class="string">u'添加时间'</span>)</span><br><span class="line">    is_delete = models.BooleanField(default=<span class="literal">False</span>, verbose_name=<span class="string">'是否删除'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        verbose_name = <span class="string">u"订单信息"</span></span><br><span class="line">        verbose_name_plural = verbose_name</span><br><span class="line">        ordering = [<span class="string">'-add_time'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> str(self.order_sn)</span><br></pre></td></tr></tbody></table></figure>

<p><code>order_sn</code>字段能为空，订单号需要由后台生成。但用户点击去结算时，后台需要生成一个订单号，但是如果我们用到<code>CreateModelMixin</code>，这个会对该字段进行验证，在用户界面是不可能post一个订单号到后台，从而导致验证失败，所以该字段增加设置<code>blank=True, null=True</code></p>
<p><code>pay_status</code>可以设置一个默认值，为待支付状态<code>default='WAIT_BUYER_PAY'</code>，提交订单时，用户也不用指定该字段了。</p>
<p><code>address</code>不直接使用外键的原因是：用户如果修改了个人中心的收货地址，订单中地址就会跟着变化，显然是不对的，所以订单中的地址就保存一个当时下单的地址组合的字符串。</p>
<p>对于一个订单，有多个商品，所以需要设置另外一个model，用外键关联。</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderGoods</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    <span class="string">'''订单商品详情'''</span></span><br><span class="line">    order = models.ForeignKey(OrderInfo, verbose_name=<span class="string">'订单信息'</span>, on_delete=models.CASCADE, related_name=<span class="string">'goods'</span>)</span><br><span class="line">    goods = models.ForeignKey(Goods, verbose_name=<span class="string">'商品'</span>, null=<span class="literal">True</span>, on_delete=models.CASCADE)</span><br><span class="line">    goods_num = models.IntegerField(default=<span class="number">0</span>, verbose_name=<span class="string">'商品数量'</span>)</span><br><span class="line"></span><br><span class="line">    add_time = models.DateTimeField(auto_now_add=<span class="literal">True</span>, verbose_name=<span class="string">u'添加时间'</span>)</span><br><span class="line">    is_delete = models.BooleanField(default=<span class="literal">False</span>, verbose_name=<span class="string">'是否删除'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        verbose_name = <span class="string">'订单商品'</span></span><br><span class="line">        verbose_name_plural = verbose_name</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> str(self.order.order_sn)</span><br></pre></td></tr></tbody></table></figure>

<p><code>trade/serializer.py</code></p>
<p>用户添加商品到购物车，点去购物车结算，填上地址留言，结算生成订单，在会员中心我的订单里面，可以看到订单列表，点订单可以看到订单的详细信息。</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> trade.models <span class="keyword">import</span> OrderInfo</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderListSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="comment"># 表示user为隐藏字段，默认为获取当前登录用户</span></span><br><span class="line">    user = serializers.HiddenField(default=serializers.CurrentUserDefault())</span><br><span class="line">    <span class="comment"># 生成订单的时候这些不能显示给用户修改和post，只能后台去修改</span></span><br><span class="line">    pay_status = serializers.CharField(read_only=<span class="literal">True</span>)</span><br><span class="line">    trade_no = serializers.CharField(read_only=<span class="literal">True</span>)</span><br><span class="line">    order_sn = serializers.CharField(read_only=<span class="literal">True</span>)</span><br><span class="line">    pay_time = serializers.DateTimeField(read_only=<span class="literal">True</span>)</span><br><span class="line">    is_delete = serializers.BooleanField(read_only=<span class="literal">True</span>)</span><br><span class="line">    <span class="comment"># 用于订单创建时，生成支付宝的支付url</span></span><br><span class="line">    alipay_url = serializers.SerializerMethodField(read_only=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_alipay_url</span>(<span class="params">self, obj</span>):</span></span><br><span class="line">        <span class="comment"># 方法命名规则为：get_&lt;field_name&gt;</span></span><br><span class="line">        alipay = AliPay(  <span class="comment"># 创建调用支付宝的对象</span></span><br><span class="line">            appid=settings.ALI_APP_ID,</span><br><span class="line">            app_notify_url=settings.NOTIFY_URL,</span><br><span class="line">            app_private_key_string=open(settings.APP_PRIVATE_KEY_PATH).read(),</span><br><span class="line">            alipay_public_key_string=open(settings.ALIPAY_PUBLIC_KEY_PATH).read(),</span><br><span class="line">            sign_type=<span class="string">"RSA2"</span>,</span><br><span class="line">            debug=settings.DEBUG,</span><br><span class="line">        )</span><br><span class="line">        <span class="comment"># 调用获取支付页面操作</span></span><br><span class="line">        <span class="comment"># 电脑网站支付，需要跳转到：</span></span><br><span class="line">        <span class="comment"># 真实环境：https://openapi.alipay.com/gateway.do? + order_string</span></span><br><span class="line">        <span class="comment"># 沙箱环境：https://openapi.alipaydev.com/gateway.do? + order_string</span></span><br><span class="line">        order_string = alipay.api_alipay_trade_page_pay(</span><br><span class="line">            out_trade_no=obj.order_sn,</span><br><span class="line">            total_amount=obj.order_amount,</span><br><span class="line">            subject=<span class="string">'订单号：%s'</span> % obj.order_sn,</span><br><span class="line">            return_url=settings.RETURN_URL,</span><br><span class="line">            notify_url=settings.NOTIFY_URL</span><br><span class="line">        )</span><br><span class="line">        <span class="comment"># 生成完整的支付页面URL</span></span><br><span class="line">        pay_url = alipay._gateway + <span class="string">'?'</span> + order_string</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> pay_url</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">generate_order_sn</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        生成订单编号=当前时间+userid+随机数</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'%s%d%d'</span> % (time.strftime(<span class="string">'%Y%m%d%H%M%S'</span>), self.context[<span class="string">'request'</span>].user.id, randint(<span class="number">1000</span>, <span class="number">9999</span>))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate</span>(<span class="params">self, attrs</span>):</span></span><br><span class="line">        <span class="comment"># 数据验证validate成功后，生成一个订单号，</span></span><br><span class="line">        <span class="comment"># 然后在view中就可以perform_create(self, serializer)执行.save()</span></span><br><span class="line">        attrs[<span class="string">'order_sn'</span>] = self.generate_order_sn()</span><br><span class="line">        <span class="keyword">return</span> attrs</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = OrderInfo</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> trade.models <span class="keyword">import</span> OrderInfo, OrderGoods</span><br><span class="line"><span class="keyword">from</span> goods.serializers <span class="keyword">import</span> GoodsSerializer</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderGoodsSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="string">"""订单中的商品序列化"""</span></span><br><span class="line">    goods = GoodsSerializer(many=<span class="literal">False</span>)  <span class="comment"># 一对一，嵌套商品详情的序列化</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = OrderGoods</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderDetailSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="string">"""订单详情显示"""</span></span><br><span class="line">    goods = OrderGoodsSerializer(many=<span class="literal">True</span>)  <span class="comment"># 为OrderGoods中外键关联字段</span></span><br><span class="line">    <span class="comment"># 在订单详情页也能显示支付的url</span></span><br><span class="line">    alipay_url = serializers.SerializerMethodField(read_only=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_alipay_url</span>(<span class="params">self, obj</span>):</span></span><br><span class="line">        <span class="comment"># 方法命名规则为：get_&lt;field_name&gt;</span></span><br><span class="line">        alipay = AliPay(  <span class="comment"># 创建调用支付宝的对象</span></span><br><span class="line">            appid=settings.ALI_APP_ID,</span><br><span class="line">            app_notify_url=settings.NOTIFY_URL,</span><br><span class="line">            app_private_key_string=open(settings.APP_PRIVATE_KEY_PATH).read(),</span><br><span class="line">            alipay_public_key_string=open(settings.ALIPAY_PUBLIC_KEY_PATH).read(),</span><br><span class="line">            sign_type=<span class="string">"RSA2"</span>,</span><br><span class="line">            debug=settings.DEBUG,  <span class="comment"># 默认False</span></span><br><span class="line">        )</span><br><span class="line">        <span class="comment"># 调用获取支付页面操作</span></span><br><span class="line">        <span class="comment"># 电脑网站支付，需要跳转到：https://openapi.alipay.com/gateway.do? + order_string</span></span><br><span class="line">        order_string = alipay.api_alipay_trade_page_pay(</span><br><span class="line">            out_trade_no=obj.order_sn,</span><br><span class="line">            total_amount=obj.order_amount,</span><br><span class="line">            subject=<span class="string">'订单号：%s'</span> % obj.order_sn,</span><br><span class="line">            return_url=settings.RETURN_URL,</span><br><span class="line">            notify_url=settings.NOTIFY_URL</span><br><span class="line">        )</span><br><span class="line">        <span class="comment"># 生成完整的支付页面URL</span></span><br><span class="line">        pay_url = alipay._gateway + <span class="string">'?'</span> + order_string</span><br><span class="line">        <span class="keyword">return</span> pay_url</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = OrderInfo</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br></pre></td></tr></tbody></table></figure>

<p>对于订单提交，会告诉后台创建一个订单，将购物车<code>ShoppingCart</code>中的该用户对应的单品和数量，添加到订单商品<code>OrderGoods</code>中，然后清空该用户的购物车。</p>
<p><code>trade/views.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderInfoViewSet</span>(<span class="params">mixins.CreateModelMixin, mixins.ListModelMixin, mixins.RetrieveModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                       mixins.DestroyModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                       viewsets.GenericViewSet</span>):</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    订单管理，不能修改，不需要继承自UpdateModelMixin</span></span><br><span class="line"><span class="string">    list:</span></span><br><span class="line"><span class="string">        订单列表</span></span><br><span class="line"><span class="string">    retrieve:</span></span><br><span class="line"><span class="string">        订单详情</span></span><br><span class="line"><span class="string">    delete:</span></span><br><span class="line"><span class="string">        删除订单</span></span><br><span class="line"><span class="string">    create:</span></span><br><span class="line"><span class="string">        新增订单</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    queryset = OrderInfo.objects.all()</span><br><span class="line">    permission_classes = [IsAuthenticated, IsOwnerOrReadOnly]  <span class="comment"># 用户必须登录才能访问</span></span><br><span class="line">    authentication_classes = [JWTAuthentication, SessionAuthentication]  <span class="comment"># 配置登录认证：支持JWT认证和DRF基本认证</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># serializer_class = OrderListSerializer</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_queryset</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> OrderInfo.objects.filter(user=self.request.user, is_delete=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_serializer_class</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.action == <span class="string">'retrieve'</span>:</span><br><span class="line">            <span class="keyword">return</span> OrderDetailSerializer</span><br><span class="line">        <span class="keyword">return</span> OrderListSerializer</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">perform_create</span>(<span class="params">self, serializer</span>):</span></span><br><span class="line">        <span class="string">"""在完成创建订单后提交保存之前保存到数据库的OrderInfo对象还需要多两步步骤"""</span></span><br><span class="line">        order = serializer.save()</span><br><span class="line">        shop_carts = ShoppingCart.objects.filter(user=self.request.user, is_delete=<span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">for</span> shop_cart <span class="keyword">in</span> shop_carts:</span><br><span class="line">            <span class="comment"># 将该用户购物车所有商品都取出来保存到订单商品中</span></span><br><span class="line">            OrderGoods.objects.create(</span><br><span class="line">                order=order,</span><br><span class="line">                goods=shop_cart.goods,</span><br><span class="line">                goods_num=shop_cart.nums</span><br><span class="line">            )</span><br><span class="line">            <span class="comment"># 清空该用户购物车</span></span><br><span class="line">            shop_cart.delete()</span><br><span class="line">        <span class="keyword">return</span> order</span><br></pre></td></tr></tbody></table></figure>

<p><code>url.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> trade.views <span class="keyword">import</span> OrderInfoViewSet</span><br><span class="line"></span><br><span class="line">router.register(<span class="string">'orders'</span>, OrderInfoViewSet)</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/05/06/drf-ding-dan/1.png" alt="description"><br><img src="/2021/05/06/drf-ding-dan/2.png" alt="description"><br><img src="/2021/05/06/drf-ding-dan/3.png" alt="description"><br><img src="/2021/05/06/drf-ding-dan/5.png" alt="description"><br><img src="/2021/05/06/drf-ding-dan/4.png" alt="description"><br><img src="/2021/05/06/drf-ding-dan/6.jpeg" alt="description"><br><img src="/2021/05/06/drf-ding-dan/7.png" alt="description"></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/05/06/python-zhi-fu-bao/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/06/python-zhi-fu-bao/" class="post-title-link" itemprop="url">python支付宝</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-05-05 16:21:41" itemprop="dateCreated datePublished" datetime="2021-05-05T16:21:41Z">2021-05-05</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-06-15 01:39:34" itemprop="dateModified" datetime="2021-06-15T01:39:34Z">2021-06-15</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/django/" itemprop="url" rel="index"><span itemprop="name">django</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>微信支付和支付宝支付都是要求企业认证才可以完成的，个人开发不可以，所以我们需要用</p>
<p>沙箱环境，它可以让我们不具备这些应用或者说应用审核还没通过的时候先开发调试</p>
<p>如何接入支付宝？（接入其他平台基本类似）</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://open.alipay.com/platform/home.htm">蚂蚁金服开放平台</a>。</li>
<li><a target="_blank" rel="noopener" href="https://open.alipay.com/platform/homeRoleSelection.htm">入驻平台</a>。</li>
<li><a target="_blank" rel="noopener" href="https://openhome.alipay.com/platform/appManage.htm#/apps">开发者中心</a>。</li>
<li><a target="_blank" rel="noopener" href="https://docs.open.alipay.com/270/105899/">文档中心</a>。</li>
<li><a target="_blank" rel="noopener" href="https://docs.open.alipay.com/54/103419">SDK集成</a> - <a target="_blank" rel="noopener" href="https://pypi.org/project/alipay-sdk-python/">PYPI链接</a>。</li>
<li><a target="_blank" rel="noopener" href="https://docs.open.alipay.com/270/105900/">API列表</a>。</li>
</ol>
<p>支付宝的支付API还提供了交易查询、交易结算、退款、退款查询等一系列的接口，可以根据业务需要进行调用</p>
<p>沙箱地址<br><a target="_blank" rel="noopener" href="https://openhome.alipay.com/platform/appDaily.htm?tab=info">https://openhome.alipay.com/platform/appDaily.htm?tab=info</a>此时可以看到APPID、支付宝网关和RSA2(SHA256)密钥</p>
<p>应用私钥需填写到代码中供签名时使用。<br>应用公钥需提供给支付宝账号管理者上传到支付宝开放平台。<br>，这个支付宝公钥在代码中验签使用。<br>应用私钥和支付宝公钥特别重要，应用公钥对我们用处不大。请求支付宝接口时，用我们的应用私钥来进行加密，支付宝用我们上传的应用公钥对签名做验证；支付宝公钥用来查询订单状态。</p>
<p>公钥和私钥的生成<br><a target="_blank" rel="noopener" href="https://docs.open.alipay.com/291/105971/">https://docs.open.alipay.com/291/105971/</a>下载后安装按照以下示意生成应用公钥和私钥：</p>
<p>把生成的公钥和私钥拷贝到到项目trade/keys下面—&gt;&gt;&gt;重命名—&gt;&gt;首位各添加下面的内容<br>中间部分对应着公钥或私钥，</p>
<figure class="highlight vbnet"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-----BEGIN RSA <span class="keyword">PRIVATE</span> <span class="keyword">KEY</span>-----</span><br><span class="line"></span><br><span class="line">-----<span class="keyword">END</span> RSA <span class="keyword">PRIVATE</span> <span class="keyword">KEY</span>-----</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight txt"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-----BEGIN PUBLIC KEY-----</span><br><span class="line">-----END PUBLIC KEY-----</span><br></pre></td></tr></tbody></table></figure>

<p>文档说明<br>我们主要用到电脑网站支付，<br>文档-网页&amp;移动-API<br>文档地址：<a target="_blank" rel="noopener" href="https://docs.open.alipay.com/270">https://docs.open.alipay.com/270</a><br>用到的API接口：统一收单下单并支付页面接口<br>在公共请求参数中，大部分的参数已经获取到或为固定值，比较重要的两个为sign和biz_content，其中sign是商户请求参数的签名串，biz_content是请求参数的集合，最大长度不限，除公共参数外所有请求参数都必须放在这个参数中传递；在请求参数中，out_trade_no、product_code、total_amount和subject为必填参数，其他均为选填，可根据需要填写。</p>
<p>sign参数即签名，需要专门生成，可参考<a target="_blank" rel="noopener" href="https://opendocs.alipay.com/open/291/105974%EF%BC%8C%E8%BF%99%E9%87%8C%E9%80%89%E6%8B%A9%E6%99%AE%E9%80%9A%E5%85%AC%E9%92%A5%E6%96%B9%E5%BC%8F%E7%94%9F%E6%88%90%E7%AD%BE%E5%90%8D%EF%BC%8C%E5%8F%AF%E4%BB%A5%E4%BD%BF%E7%94%A8%E5%BC%80%E6%94%BE%E5%B9%B3%E5%8F%B0SDK%E6%8E%A5%E5%85%A5%EF%BC%8C%E4%B9%9F%E5%8F%AF%E4%BB%A5%E6%9C%AA%E4%BD%BF%E7%94%A8%E5%BC%80%E6%94%BE%E5%B9%B3%E5%8F%B0SDK%E3%80%81%E8%87%AA%E8%A1%8C%E5%AE%9E%E7%8E%B0%E7%AD%BE%E5%90%8D%E8%BF%87%E7%A8%8B%EF%BC%8C%E8%BF%98%E5%8F%AF%E4%BB%A5%E7%9B%B4%E6%8E%A5%E4%BD%BF%E7%94%A8%E6%94%AF%E4%BB%98%E5%AE%9D%E5%BC%80%E6%94%BE%E5%B9%B3%E5%8F%B0%E5%BC%80%E5%8F%91%E5%8A%A9%E6%89%8B%E7%9A%84%E7%AD%BE%E5%90%8D%E5%8A%9F%E8%83%BD%E3%80%82">https://opendocs.alipay.com/open/291/105974，这里选择普通公钥方式生成签名，可以使用开放平台SDK接入，也可以未使用开放平台SDK、自行实现签名过程，还可以直接使用支付宝开放平台开发助手的签名功能。</a></p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install python-alipay-sdk</span><br></pre></td></tr></tbody></table></figure>

<p>下载不了</p>
<p><a target="_blank" rel="noopener" href="https://github.com/fzlee/alipay/releases">https://github.com/fzlee/alipay/releases</a><br><a target="_blank" rel="noopener" href="https://github.com/fzlee/alipay/blob/master/docs/apis.zh-hans.md#alipay.trade.page.pay">https://github.com/fzlee/alipay/blob/master/docs/apis.zh-hans.md#alipay.trade.page.pay</a></p>
<p>下载模块包到安装地址（压缩文件zip或tar.gz），进行解压，到达指定位置进入模块文件夹，执行：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python setup.py install</span><br></pre></td></tr></tbody></table></figure>

<p>django集成支付宝notify_url和return_url</p>
<p><code>settings.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 支付宝相关的key</span></span><br><span class="line">APP_PRIVATE_KEY_PATH = str(BASE_DIR / <span class="string">'apps/trade/keys/app_private.txt'</span>)</span><br><span class="line">ALIPAY_PUBLIC_KEY_PATH = str(BASE_DIR / <span class="string">'apps/trade/keys/ali_public.txt'</span>)</span><br><span class="line">ALI_APP_ID= <span class="string">"2021000116675762"</span></span><br><span class="line">RETURN_URL = <span class="string">'http://127.0.0.1:8000/alipay/return/'</span></span><br><span class="line">NOTIFY_URL = <span class="string">'http://127.0.0.1:8000/alipay/return/'</span></span><br></pre></td></tr></tbody></table></figure>

<p><code>trade/views.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> utils.alipay <span class="keyword">import</span> AliPay</span><br><span class="line"><span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> APIView</span><br><span class="line"><span class="keyword">from</span> mxshop.settings <span class="keyword">import</span> ali_pub_key_path, private_key_path</span><br><span class="line"><span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</span><br></pre></td></tr></tbody></table></figure>

<p>创建订单的时候生成一个支付的url，通过上面返回的链接可以进入支付页面，支付完成后会自动跳转回上面代码中设定好的项目页面，在该页面中可以获得订单号（out_trade_no）、支付流水号（trade_no）、交易金额（total_amount）和对应的签名（sign）并请求后端验证和保存交易结果，</p>
<p>这个逻辑<code>OderSerializer</code>和<code>OrderDetailSerializer</code>中都添加<br><code>trade/serializers.py</code></p>
<p><code>/trade/views.py</code> 增加一个API视图，用于处理支付宝的返回</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> ShoppingCart</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"><span class="keyword">from</span> goods.models <span class="keyword">import</span> Goods</span><br><span class="line"><span class="keyword">from</span> goods.serializers <span class="keyword">import</span> GoodsSerializer</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> OrderInfo,OrderGoods</span><br><span class="line"><span class="keyword">from</span> MxShop.settings <span class="keyword">import</span> ali_pub_key_path, private_key_path</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AliPayView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    通知验证 支付宝的返回</span></span><br><span class="line"><span class="string">    get:</span></span><br><span class="line"><span class="string">        处理支付宝return_url请求</span></span><br><span class="line"><span class="string">    post:</span></span><br><span class="line"><span class="string">        处理支付宝notify_url请求</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line"></span><br><span class="line">    alipay = AliPay(</span><br><span class="line">        appid=settings.ALI_APP_ID,</span><br><span class="line">        app_notify_url=<span class="literal">None</span>,  <span class="comment"># 默认回调 url</span></span><br><span class="line">        app_private_key_string=open(settings.APP_PRIVATE_KEY_PATH).read(),</span><br><span class="line">        alipay_public_key_string=open(settings.ALIPAY_PUBLIC_KEY_PATH).read(),</span><br><span class="line">        sign_type=<span class="string">"RSA2"</span>,</span><br><span class="line">        debug=settings.DEBUG,  <span class="comment"># 默认 False</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        处理支付宝的return_url返回</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="comment"># 1. 获取GET中参数</span></span><br><span class="line">        data = dict(request.GET.items())</span><br><span class="line">        <span class="comment"># 2. 取出sign</span></span><br><span class="line">        signature = data.pop(<span class="string">"sign"</span>, <span class="literal">None</span>)</span><br><span class="line">        print(data)</span><br><span class="line">        success = self.alipay.verify(data, signature)</span><br><span class="line">        order_sn = data.get(<span class="string">'out_trade_no'</span>, <span class="literal">None</span>)</span><br><span class="line">        print(success)</span><br><span class="line">        trade_status = self.alipay.api_alipay_trade_query(out_trade_no=order_sn).get(<span class="string">"trade_status"</span>, <span class="literal">None</span>)</span><br><span class="line">        print(trade_status)</span><br><span class="line">        <span class="keyword">if</span> success <span class="keyword">and</span> trade_status <span class="keyword">in</span> (<span class="string">"TRADE_SUCCESS"</span>, <span class="string">"TRADE_FINISHED"</span>):</span><br><span class="line">            trade_no = data.get(<span class="string">'trade_no'</span>, <span class="literal">None</span>)</span><br><span class="line">            existed_orders = OrderInfo.objects.filter(order_sn=order_sn, is_delete=<span class="literal">False</span>)</span><br><span class="line">            <span class="keyword">if</span> existed_orders:</span><br><span class="line">                <span class="keyword">for</span> order <span class="keyword">in</span> existed_orders:</span><br><span class="line">                    order_goods = order.goods.all()</span><br><span class="line">                    <span class="keyword">for</span> order_good <span class="keyword">in</span> order_goods:</span><br><span class="line">                        goods = order_good.goods</span><br><span class="line">                        goods.sold_num += order_good.goods_num</span><br><span class="line">                        goods.save()</span><br><span class="line">                    order.pay_status = trade_status</span><br><span class="line">                    order.trade_no = trade_no</span><br><span class="line">                    order.pay_time = datetime.now()</span><br><span class="line">                    order.save()</span><br><span class="line">                response = HttpResponseRedirect(<span class="string">'http://127.0.0.1:8080/#/app/home/member/order'</span>)</span><br><span class="line">                response.set_cookie(<span class="string">'nextPath'</span>, <span class="string">'pay'</span>, max_age=<span class="number">2</span>)</span><br><span class="line">                print(<span class="string">'cookie'</span>, response.cookies)</span><br><span class="line">                <span class="keyword">return</span> response</span><br><span class="line">        <span class="keyword">return</span> HttpResponseRedirect(<span class="string">'http://127.0.0.1:8080/#/app/shoppingcart/cart'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        处理支付宝的notify_url 验签处理订单状态</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="comment"># 请求参数（假设是POST请求）中包括订单号、支付流水号、交易金额和签名</span></span><br><span class="line">        data = dict(request.POST.items())</span><br><span class="line">        <span class="comment"># 把sign pop掉，文档有说明</span></span><br><span class="line">        signature = data.pop(<span class="string">"sign"</span>, <span class="literal">None</span>)</span><br><span class="line">        <span class="comment"># 调用验证操作</span></span><br><span class="line">        success = self.alipay.verify(data, signature)</span><br><span class="line">        order_sn = data.get(<span class="string">'out_trade_no'</span>, <span class="literal">None</span>)  <span class="comment"># 原支付请求的商户订单号</span></span><br><span class="line">        trade_status = self.alipay.api_alipay_trade_query(out_trade_no=order_sn).get(<span class="string">"trade_status"</span>, <span class="literal">None</span>)</span><br><span class="line">        <span class="keyword">if</span> success <span class="keyword">and</span> trade_status <span class="keyword">in</span> (<span class="string">"TRADE_SUCCESS"</span>, <span class="string">"TRADE_FINISHED"</span>):</span><br><span class="line">            trade_no = data.get(<span class="string">'trade_no'</span>, <span class="literal">None</span>)  <span class="comment"># 支付宝交易凭证号</span></span><br><span class="line">            <span class="comment"># 订单商品</span></span><br><span class="line">            existed_orders = OrderInfo.objects.filter(order_sn=order_sn, is_delete=<span class="literal">False</span>)</span><br><span class="line">            print(len(existed_orders))</span><br><span class="line">            <span class="keyword">if</span> existed_orders:</span><br><span class="line">                <span class="keyword">for</span> order <span class="keyword">in</span> existed_orders:</span><br><span class="line">                    order_goods = order.goods.all()</span><br><span class="line">                    <span class="comment"># 商品销量增加订单中数值</span></span><br><span class="line">                    <span class="keyword">for</span> order_good <span class="keyword">in</span> order_goods:</span><br><span class="line">                        <span class="comment"># 获取订单中商品</span></span><br><span class="line">                        goods = order_good.goods</span><br><span class="line">                        <span class="comment"># 销量根据订单商品数量增加增加</span></span><br><span class="line">                        goods.sold_num += order_good.goods_num</span><br><span class="line">                        goods.save()</span><br><span class="line">                    <span class="comment"># 更新数据库订单状态</span></span><br><span class="line">                    order.pay_status = trade_status</span><br><span class="line">                    order.trade_no = trade_no</span><br><span class="line">                    order.pay_time = datetime.now()</span><br><span class="line">                    order.save()</span><br><span class="line">                response = HttpResponseRedirect(<span class="string">'http://127.0.0.1:8080/#/app/home/member/order'</span>)</span><br><span class="line">                response.set_cookie(<span class="string">'nextPath'</span>, <span class="string">'pay'</span>, max_age=<span class="number">2</span>)</span><br><span class="line">                print(<span class="string">'cookie'</span>, response.cookies)</span><br><span class="line">                <span class="keyword">return</span> response</span><br><span class="line">        <span class="keyword">return</span> HttpResponseRedirect(<span class="string">'http://127.0.0.1:8080/#/app/shoppingcart/cart'</span>)</span><br></pre></td></tr></tbody></table></figure>

<p><code>url.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">path(<span class="string">'alipay/return/'</span>, AlipayView.as_view())</span><br></pre></td></tr></tbody></table></figure>

<p>添加商品到购物车–&gt;&gt;去结算–&gt;&gt;生成订单–&gt;&gt;跳到支付页面了–&gt;支付完成后跳转回订单页面。</p>
<h3 id="分析returnurl和notifyurl"><a href="#分析returnurl和notifyurl" class="headerlink" title="分析returnurl和notifyurl"></a>分析returnurl和notifyurl</h3><p>当用户创建好订单之后，跳转到支付宝页面进行支付，如果用户通过扫码或登录支付宝，就会创建一个支付宝订单，确认支付后，支付宝会自动跳转到<code>return_url="http://{}:8000/".format(server_ip)</code>配置的商户页面地址，并且传入很多参数<br>我们可以获取到url中的参数，验证支付宝返回的数据判断用户是否已经支付，<br>判定用户是否确认时已支付的，因为数据在传输过程中可能会被截获修改，<br>如果不去做验证，系统上修改订单状态后，却没收到款。如果支付就修改订单状态。</p>
<p>还有一种情况就是创建订单，通过扫码，或登录支付宝创建支付宝订单后，用户并没有确认支付，而是关闭了该页面，在手机上个人订单中去支付，那么<code>return_url</code>就无效了，而此时，我们的应用就无法判断该订单是否已支付。这时候<code>notify_url</code>就有用了，支付宝会通过异步方式，向该url发起一个请求（POST），并传递一些参数，我们的应用获取参数，解析其中的信息，对订单状态进行修改。</p>
<p><a target="_blank" rel="noopener" href="https://docs.open.alipay.com/270/105902/">https://docs.open.alipay.com/270/105902/</a> 查看参数</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>参数名称</th>
<th>类型</th>
<th>必填</th>
<th>描述</th>
<th>范例</th>
</tr>
</thead>
<tbody><tr>
<td>sign</td>
<td>签名</td>
<td>String(256)</td>
<td>是</td>
<td>请参考异步返回结果的验签</td>
<td>601510b7970e52cc63db0f44997cf70e</td>
</tr>
</tbody></table>
<p>获取url中所有参数，拿到这个sign后，可以通过支付宝的公钥进行验签，验证是否是支付宝发过来的。</p>
<p>支付宝支付逻辑编写<br>由于<code>return_url</code>是一个同步GET请求，<code>notify_url</code>是一个异步POST请求，可以将其放在一个API中实现，跟支付宝相关，没有model，所以就用最底层的APIView。</p>
<p>对于<code>return_url</code>，用户支付完成后，支付宝会根据API中商户传入的<code>return_url</code>参数，通过GET请求的形式将部分支付结果参数通知到商户系统。</p>
<p><code>notify_url</code>很重要，只要用户完成支付，就向该url发起一个异步请求，告诉用户已支付。</p>
<p>在 支付宝开放平台文档中心-电脑网站支付 中，支付结果异步通知 <a target="_blank" rel="noopener" href="https://docs.open.alipay.com/270/105902/">https://docs.open.alipay.com/270/105902/</a> 文档可以看到相关参数</p>
<p>对于 PC 网站支付的交易，在用户支付完成之后，支付宝会根据 API 中商户传入的 <code>notify_url</code>，通过 POST 请求的形式将支付结果作为参数通知到商户系统。<br>当前在return_url的GET逻辑中，可以不用再次修改订单状态，因为在用户支付成功后，支付宝发送的POST请求已经修改了订单状态了。</p>
<p>对比下POST和GET中的内容</p>
<figure class="highlight 1c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">08</span>/Aug/<span class="number">2019</span> <span class="number">13</span>:<span class="number">25</span>:<span class="number">45</span>] <span class="string">"POST /orderinfo/ HTTP/1.1"</span> <span class="number">201</span> <span class="number">12954</span></span><br><span class="line">request.POST的值： {'gmt_create': '<span class="number">2019-08-08</span> 13:26:12', 'charset': 'utf-8', 'gmt_payment': '<span class="number">2019-08-08</span> 13:26:20', 'notify_time': '<span class="number">2019-08-08</span> 13:26:21', 'subject': '生鲜超市-<span class="number">20190808132544</span>135', 'sign': 'DkQqkJwi5BnNKdlaVrybA0oLC9wL7aD61aV7vaF6jF6KrFsdDKAS+fS8Y2MQuKqAcPobsM/8ab3FVo7diRnEwXckugP8m6KW5TxFnnPwDh6J3dbNDUNyXTWYKiHCAKMvsV4ZuM7YkJQEGGbs2irf90uM8kxvOaZBGuI6D8QPhc/o6CyCYUJgJU4Zvs6DFuu9Wo1JwldnA9K4E9dd5UJpLI5KmIP6OTjZ13EcoXaslRgjcYdDAj21+cqCpwuD5+EGOuO+6/7T/WMgNSjPPy+cSehVBI9GnhuM7WmH2IQafR+510BLgN12agv4DJB+E1dZAibFAMJFA3Gn/cKDPPjqeQ==', 'buyer_id': '<span class="number">20881021794215</span>71', 'invoice_amount': '10.00', 'version': '1.0', 'notify_id': '<span class="number">20190808002221</span><span class="number">32620021571000</span><span class="number">416125</span>', 'fund_bill_list': '[{"amount":"10.00","fundChannel":"ALIPAYACCOUNT"}]', 'notify_type': 'trade_status_sync', 'out_trade_no': '<span class="number">20190808132544</span>135', 'total_amount': '10.00', 'trade_status': 'TRADE_SUCCESS', 'trade_no': '<span class="number">20190808220014</span><span class="number">21571000029372</span>', 'auth_app_id': '<span class="number">20161009006466</span>09', 'receipt_amount': '10.00', 'point_amount': '0.00', 'app_id': '<span class="number">20161009006466</span>09', 'buyer_pay_amount': '10.00', 'sign_type': 'RSA2', 'seller_id': '<span class="number">20881021787621</span>03'}</span><br><span class="line"></span><br><span class="line">[<span class="number">08</span>/Aug/<span class="number">2019</span> <span class="number">13</span>:<span class="number">26</span>:<span class="number">22</span>] <span class="string">"POST /alipay/return/ HTTP/1.1"</span> <span class="number">200</span> <span class="number">9</span></span><br><span class="line">request.GET的值： {'charset': 'utf-8', 'out_trade_no': '<span class="number">20190808132544</span>135', 'method': 'alipay.trade.page.pay.return', 'total_amount': '10.00', 'sign': 'FJputH1jTssknTDV1C5OUOkk3mFNK8qQj5EdszFrizxPmOvS5++v0Apl8ajggksgwlDk20yF/JwI3CdozpnErxZ/4pDMdU2I2A99vXb55akbVPJK6T9/YOo10HC/X+ctctm63ew/vRBIcxtP+BTgj7U+TvKwGkCdy0ZxRm1Ja9GJOwE8Nb4qdp0BQo4hFQ96QNVb0tQ9wTPe6R3qdjLdfyqHhj+GnILxBBehOSHJmDzsQMeMrKhOdY9FtXj21b8aW1YKNulhIU7C8TeUAifu3khmocNMwH+iv9A/hhlqrWjCvlCDUi1GDNRm1W9PCHl+vV6XIitetIOOOsmLlAfq2A==', 'trade_no': '<span class="number">20190808220014</span><span class="number">21571000029372</span>', 'auth_app_id': '<span class="number">20161009006466</span>09', 'version': '1.0', 'app_id': '<span class="number">20161009006466</span>09', 'sign_type': 'RSA2', 'seller_id': '<span class="number">20881021787621</span>03', 'timestamp': '<span class="number">2019-08-08</span> 13:26:27'}</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/05/06/python-zhi-fu-bao/1.png" alt="description"><br><img src="/2021/05/06/python-zhi-fu-bao/2.png" alt="description"></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/05/05/xu-lie-hua/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/05/xu-lie-hua/" class="post-title-link" itemprop="url">序列化</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-05-04 16:21:41" itemprop="dateCreated datePublished" datetime="2021-05-04T16:21:41Z">2021-05-04</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-06-17 12:27:22" itemprop="dateModified" datetime="2021-06-17T12:27:22Z">2021-06-17</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/django/" itemprop="url" rel="index"><span itemprop="name">django</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>把查询集归为queryset或者模型类生成实例instance的django模型类数据转换成json/ xml / yaml，再传给前端js进行渲染<br>反序列化，前端post请求的body里面带有json数据，使用django的orm转换成新的模型类数据对象更新或保存到数据库里</p>
<p>django自带序列化功能，但是不完善<br>字段序列化定死的，要想重组的话非常麻烦<br>images保存的是一个相对路径，我们还需要补全路径，而这些drf自动补全完整路径</p>
<p><code>Python Console</code>是针对当前项目环境的console或者<code>python manage.py shell</code></p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.core <span class="keyword">import</span> serializers</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> course.models <span class="keyword">import</span> Course  <span class="comment"># 引入课程</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 第一个参数想要序列化后的类型</span></span><br><span class="line"><span class="comment"># 第二个参数是序列化模型类已有的所有字段对象</span></span><br><span class="line">serializers.serialize(<span class="string">'json'</span>, Course.objects.all())</span><br><span class="line"><span class="string">'[{"model": "course.course", "pk": 1, "fields": {"name": "django rest framework快速入门", "introduction": "API接口开发无需费时费力，本课程将从零开始引导同学们快速开发自己的RESTful API接口，从Django项目环境搭建、API接口生成数据、Postman接口测试到DRF认证方式的讲解，通过一个典型的课程信息接口（含增删改查），给同学们讲解完DRF中的序列化（serializers）、视图集（viewsets）、路由（routers）、认证（authentication）、权限（permission），为将来前后端分离项目的开发打下基础。", "teacher": 1, "price": "9.99", "created_at": "2021-05-04T22:35:31.439", "updated_at": "2021-05-04T22:35:31.439"}}]'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 序列号特定字段</span></span><br><span class="line">serializers.serialize(<span class="string">'json'</span>, Course.objects.all(), fields=(<span class="string">"name"</span>))</span><br><span class="line"><span class="string">'[{"model": "course.course", "pk": 1, "fields": {"name": "django rest framework快速入门"}}]'</span></span><br></pre></td></tr></tbody></table></figure>

<p><code>teacher</code>不是外键所关联的用户名称而是对应Teacher模型的主键id，<br>当然还可以显示teacher的具体信息，此时需要使用嵌套序列化，如下：</p>
<figure class="highlight pgsql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">```</span><br><span class="line"></span><br><span class="line">### 视图实现商品列表</span><br><span class="line"></span><br><span class="line">```py</span><br><span class="line"><span class="keyword">import</span> <span class="type">json</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.views.generic <span class="keyword">import</span> <span class="keyword">View</span></span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> JsonResponse</span><br><span class="line"><span class="keyword">from</span> django.core <span class="keyword">import</span> serializers</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> goods.models <span class="keyword">import</span> Goods</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> GoodsListView(<span class="keyword">View</span>):</span><br><span class="line">    def <span class="keyword">get</span>(self, request):</span><br><span class="line">        # 获取所有商品</span><br><span class="line">        goods = Goods.objects.<span class="keyword">all</span>()</span><br><span class="line"></span><br><span class="line">        # 通过serializers实现商品列表页</span><br><span class="line">        json_data = serializers.serialize(<span class="string">'json'</span>, goods)</span><br><span class="line"></span><br><span class="line">        # <span class="keyword">In</span> <span class="keyword">order</span> <span class="keyword">to</span> allow non-dict objects <span class="keyword">to</span> be serialized <span class="keyword">set</span> the safe parameter <span class="keyword">to</span> <span class="keyword">False</span>.</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(<span class="type">json</span>.loads(json_data), safe=<span class="keyword">False</span>)</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.views.generic <span class="keyword">import</span> View</span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse</span><br><span class="line"><span class="keyword">from</span> django.core <span class="keyword">import</span> serializers</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> goods.models <span class="keyword">import</span> Goods</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GoodsListView</span>(<span class="params">View</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        <span class="comment"># 获取所有商品</span></span><br><span class="line">        goods = Goods.objects.all()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 通过serializers实现商品列表页</span></span><br><span class="line">        json_data = serializers.serialize(<span class="string">'json'</span>, goods)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(json_data, content_type=<span class="string">'application/json'</span>)</span><br></pre></td></tr></tbody></table></figure>

<p>如何序列化模型类<br>在各个应用下面建一个<code>serializers.py</code></p>
<h3 id="drf-的序列化作用"><a href="#drf-的序列化作用" class="headerlink" title="drf 的序列化作用"></a>drf 的序列化作用</h3><p>自定义序列化器继承<code>Serializer</code>类或<code>ModelSerializer</code>类，<br>用于将对象处理成字典，</p>
<p>继承<code>Serializer</code>，必须指定<code>queryset</code>对象，<br>如果继承<code>ModelSerializer</code>则不需要指定</p>
<ul>
<li>同时序列化多个对象</li>
<li>序列化包含多条数据的查询集加上<code>many=True</code></li>
<li>序列化的过程添加上下文</li>
<li>无限的数据异常处理</li>
</ul>
<p>关系字段的外键字段序列化可以指定遍历的序列化深度<code>depth</code>，如果表结构有子表关联到父表，父表又关联到另外的父表，可以设置深度</p>
<p>serializer不是只能为数据库模型类定义，也可以为非数据库模型类的数据定义。serializer是独立于数据库之外的存在。</p>
<p>字段|字段构造方式<br>BooleanField()<br><code>CharField(max_length=None, min_length=None, allow_blank=False, trim_whitespace=True)</code></p>
<h4 id="选项参数-作用"><a href="#选项参数-作用" class="headerlink" title="选项参数|作用"></a>选项参数|作用</h4><p><code>max_length</code> |最大长度<br><code>min_lenght</code> 最小长度<br><code>allow_blank</code>是否允许为空<br><code>trim_whitespace</code>是否截断空白字符<br><code>max_value</code> 最小值<br><code>min_value</code> 最大值</p>
<h4 id="Serializer-fields-通用参数"><a href="#Serializer-fields-通用参数" class="headerlink" title="Serializer fields 通用参数"></a>Serializer fields 通用参数</h4><p><a target="_blank" rel="noopener" href="https://www.django-rest-framework.org/api-guide/fields/#core-arguments">https://www.django-rest-framework.org/api-guide/fields/#core-arguments</a></p>
<ul>
<li><code>read_only</code> fields are included in the API output, but should not be included in the input during create or update operations.<br>包含在API输出中，但在创建或更新操作期间不应包含在输入中，<br>Any <code>read_only</code> fields that are incorrectly included in the serializer input will be ignored.</li>
</ul>
<p>Set this to <code>True</code> to ensure that the field is used when serializing a representation, but is not used when creating or updating an instance during deserialization. 设置为<code>True</code>以确保序列化输出表示形式时使用该字段，而在反序列化期间创建或更新实例时不使用该字段。只返回而不提交</p>
<p>Defaults to <code>False</code>默认False</p>
<ul>
<li><code>write_only</code><br>Set this to <code>True</code> to ensure that the field may be used when updating or creating an instance, but is not included when serializing the representation. 以确保在更新或创建实例（反序列化输入）时可以使用该字段，但在序列化表示时不包括该字段<br>Defaults to <code>False</code> 默认False</li>
</ul>
<p><code>required</code><br>Normally an error will be raised if a field is not supplied during deserialization. Set to false if this field is not required to be present during deserialization.</p>
<p>Setting this to <code>False</code> also allows the object attribute or dictionary key to be omitted from output when serializing the instance. If the key is not present it will simply not be included in the output representation.<br>表明该字段在反序列化时必须输入<br>Defaults to <code>True</code>.默认True</p>
<p><code>default</code> 反序列化时使用的默认值<br><code>allow_null</code> 该字段是否允许传入None，默认False</p>
<p><code>validators</code>该字段选项使用的验证，自定义方法验证</p>
<p>We now use single-step object creation, like so:</p>
<ol>
<li>Validating the data makes the cleaned data available as <code>serializer.validated_data</code>.</li>
<li>Calling <code>serializer.save()</code> then saves and returns the new object instance.</li>
</ol>
<p><code>error_messages</code> 包含错误编号与错误信息的字典<br><code>label</code> 用于HTML展示API页面时，显示的字段名称<br><code>help_text</code> 用于HTML展示API页面时，显示的字段帮助提示信息</p>
<h3 id="BaseSerializer"><a href="#BaseSerializer" class="headerlink" title="BaseSerializer"></a>BaseSerializer</h3><figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseSerializer</span>(<span class="params">Field</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    The BaseSerializer class provides a minimal class which may be used</span></span><br><span class="line"><span class="string">    for writing custom serializer implementations.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Note that we strongly restrict the ordering of operations/properties</span></span><br><span class="line"><span class="string">    that may be used on the serializer in order to enforce correct usage.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    In particular, if a `data=` argument is passed then:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    .is_valid() - Available.</span></span><br><span class="line"><span class="string">    .initial_data - Available.</span></span><br><span class="line"><span class="string">    .validated_data - Only available after calling `is_valid()`</span></span><br><span class="line"><span class="string">    .errors - Only available after calling `is_valid()`</span></span><br><span class="line"><span class="string">    .data - Only available after calling `is_valid()`</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    If a `data=` argument is not passed then:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    .is_valid() - Not available.</span></span><br><span class="line"><span class="string">    .initial_data - Not available.</span></span><br><span class="line"><span class="string">    .validated_data - Not available.</span></span><br><span class="line"><span class="string">    .errors - Not available.</span></span><br><span class="line"><span class="string">    .data - Available.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, instance=None, data=empty, **kwargs</span>):</span></span><br><span class="line">        self.instance = instance</span><br><span class="line">        <span class="keyword">if</span> data <span class="keyword">is</span> <span class="keyword">not</span> empty:</span><br><span class="line">            self.initial_data = data</span><br><span class="line">        self.partial = kwargs.pop(<span class="string">'partial'</span>, <span class="literal">False</span>)</span><br><span class="line">        self._context = kwargs.pop(<span class="string">'context'</span>, {})</span><br><span class="line">        kwargs.pop(<span class="string">'many'</span>, <span class="literal">None</span>)</span><br><span class="line">        super().__init__(**kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__new__</span>(<span class="params">cls, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="comment"># We override this method in order to automatically create</span></span><br><span class="line">        <span class="comment"># `ListSerializer` classes instead when `many=True` is set.</span></span><br><span class="line">        <span class="keyword">if</span> kwargs.pop(<span class="string">'many'</span>, <span class="literal">False</span>):</span><br><span class="line">            <span class="keyword">return</span> cls.many_init(*args, **kwargs)</span><br><span class="line">        <span class="keyword">return</span> super().__new__(cls, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Allow type checkers to make serializers generic.</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__class_getitem__</span>(<span class="params">cls, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="keyword">return</span> cls</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">many_init</span>(<span class="params">cls, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        This method implements the creation of a `ListSerializer` parent</span></span><br><span class="line"><span class="string">        class when `many=True` is used. You can customize it if you need to</span></span><br><span class="line"><span class="string">        control which keyword arguments are passed to the parent, and</span></span><br><span class="line"><span class="string">        which are passed to the child.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Note that we're over-cautious in passing most arguments to both parent</span></span><br><span class="line"><span class="string">        and child classes in order to try to cover the general case. If you're</span></span><br><span class="line"><span class="string">        overriding this method you'll probably want something much simpler, eg:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        @classmethod</span></span><br><span class="line"><span class="string">        def many_init(cls, *args, **kwargs):</span></span><br><span class="line"><span class="string">            kwargs['child'] = cls()</span></span><br><span class="line"><span class="string">            return CustomListSerializer(*args, **kwargs)</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        allow_empty = kwargs.pop(<span class="string">'allow_empty'</span>, <span class="literal">None</span>)</span><br><span class="line">        child_serializer = cls(*args, **kwargs)</span><br><span class="line">        list_kwargs = {</span><br><span class="line">            <span class="string">'child'</span>: child_serializer,</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span> allow_empty <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            list_kwargs[<span class="string">'allow_empty'</span>] = allow_empty</span><br><span class="line">        list_kwargs.update({</span><br><span class="line">            key: value <span class="keyword">for</span> key, value <span class="keyword">in</span> kwargs.items()</span><br><span class="line">            <span class="keyword">if</span> key <span class="keyword">in</span> LIST_SERIALIZER_KWARGS</span><br><span class="line">        })</span><br><span class="line">        meta = getattr(cls, <span class="string">'Meta'</span>, <span class="literal">None</span>)</span><br><span class="line">        list_serializer_class = getattr(meta, <span class="string">'list_serializer_class'</span>, ListSerializer)</span><br><span class="line">        <span class="keyword">return</span> list_serializer_class(*args, **list_kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">to_internal_value</span>(<span class="params">self, data</span>):</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError(<span class="string">'`to_internal_value()` must be implemented.'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">to_representation</span>(<span class="params">self, instance</span>):</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError(<span class="string">'`to_representation()` must be implemented.'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">update</span>(<span class="params">self, instance, validated_data</span>):</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError(<span class="string">'`update()` must be implemented.'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">self, validated_data</span>):</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError(<span class="string">'`create()` must be implemented.'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">save</span>(<span class="params">self, **kwargs</span>):</span></span><br><span class="line">        <span class="keyword">assert</span> hasattr(self, <span class="string">'_errors'</span>), (</span><br><span class="line">            <span class="string">'You must call `.is_valid()` before calling `.save()`.'</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="keyword">assert</span> <span class="keyword">not</span> self.errors, (</span><br><span class="line">            <span class="string">'You cannot call `.save()` on a serializer with invalid data.'</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Guard against incorrect use of `serializer.save(commit=False)`</span></span><br><span class="line">        <span class="keyword">assert</span> <span class="string">'commit'</span> <span class="keyword">not</span> <span class="keyword">in</span> kwargs, (</span><br><span class="line">            <span class="string">"'commit' is not a valid keyword argument to the 'save()' method. "</span></span><br><span class="line">            <span class="string">"If you need to access data before committing to the database then "</span></span><br><span class="line">            <span class="string">"inspect 'serializer.validated_data' instead. "</span></span><br><span class="line">            <span class="string">"You can also pass additional keyword arguments to 'save()' if you "</span></span><br><span class="line">            <span class="string">"need to set extra attributes on the saved model instance. "</span></span><br><span class="line">            <span class="string">"For example: 'serializer.save(owner=request.user)'.'"</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="keyword">assert</span> <span class="keyword">not</span> hasattr(self, <span class="string">'_data'</span>), (</span><br><span class="line">            <span class="string">"You cannot call `.save()` after accessing `serializer.data`."</span></span><br><span class="line">            <span class="string">"If you need to access data before committing to the database then "</span></span><br><span class="line">            <span class="string">"inspect 'serializer.validated_data' instead. "</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        validated_data = {**self.validated_data, **kwargs}</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.instance <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:  <span class="comment"># instance不为空修改</span></span><br><span class="line">            self.instance = self.update(self.instance, validated_data)</span><br><span class="line">            <span class="keyword">assert</span> self.instance <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>, (</span><br><span class="line">                <span class="string">'`update()` did not return an object instance.'</span></span><br><span class="line">            )</span><br><span class="line">        <span class="keyword">else</span>:  <span class="comment"># instance为空创建</span></span><br><span class="line">            self.instance = self.create(validated_data)</span><br><span class="line">            <span class="keyword">assert</span> self.instance <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>, (</span><br><span class="line">                <span class="string">'`create()` did not return an object instance.'</span></span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> self.instance</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">is_valid</span>(<span class="params">self, raise_exception=False</span>):</span></span><br><span class="line">        <span class="keyword">assert</span> hasattr(self, <span class="string">'initial_data'</span>), (</span><br><span class="line">            <span class="string">'Cannot call `.is_valid()` as no `data=` keyword argument was '</span></span><br><span class="line">            <span class="string">'passed when instantiating the serializer instance.'</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> hasattr(self, <span class="string">'_validated_data'</span>):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                self._validated_data = self.run_validation(self.initial_data)</span><br><span class="line">            <span class="keyword">except</span> ValidationError <span class="keyword">as</span> exc:</span><br><span class="line">                self._validated_data = {}</span><br><span class="line">                self._errors = exc.detail</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self._errors = {}</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self._errors <span class="keyword">and</span> raise_exception:</span><br><span class="line">            <span class="keyword">raise</span> ValidationError(self.errors)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">not</span> bool(self._errors)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">data</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> hasattr(self, <span class="string">'initial_data'</span>) <span class="keyword">and</span> <span class="keyword">not</span> hasattr(self, <span class="string">'_validated_data'</span>):</span><br><span class="line">            msg = (</span><br><span class="line">                <span class="string">'When a serializer is passed a `data` keyword argument you '</span></span><br><span class="line">                <span class="string">'must call `.is_valid()` before attempting to access the '</span></span><br><span class="line">                <span class="string">'serialized `.data` representation.\n'</span></span><br><span class="line">                <span class="string">'You should either call `.is_valid()` first, '</span></span><br><span class="line">                <span class="string">'or access `.initial_data` instead.'</span></span><br><span class="line">            )</span><br><span class="line">            <span class="keyword">raise</span> AssertionError(msg)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> hasattr(self, <span class="string">'_data'</span>):</span><br><span class="line">            <span class="keyword">if</span> self.instance <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> <span class="keyword">not</span> getattr(self, <span class="string">'_errors'</span>, <span class="literal">None</span>):</span><br><span class="line">                self._data = self.to_representation(self.instance)</span><br><span class="line">            <span class="keyword">elif</span> hasattr(self, <span class="string">'_validated_data'</span>) <span class="keyword">and</span> <span class="keyword">not</span> getattr(self, <span class="string">'_errors'</span>, <span class="literal">None</span>):</span><br><span class="line">                self._data = self.to_representation(self.validated_data)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self._data = self.get_initial()</span><br><span class="line">        <span class="keyword">return</span> self._data</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">errors</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> hasattr(self, <span class="string">'_errors'</span>):</span><br><span class="line">            msg = <span class="string">'You must call `.is_valid()` before accessing `.errors`.'</span></span><br><span class="line">            <span class="keyword">raise</span> AssertionError(msg)</span><br><span class="line">        <span class="keyword">return</span> self._errors</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validated_data</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> hasattr(self, <span class="string">'_validated_data'</span>):</span><br><span class="line">            msg = <span class="string">'You must call `.is_valid()` before accessing `.validated_data`.'</span></span><br><span class="line">            <span class="keyword">raise</span> AssertionError(msg)</span><br><span class="line">        <span class="keyword">return</span> self._validated_data</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p><code>BaseSerializer</code> class that can be used to easily support alternative serialization and deserialization styles.</p>
<p>This class implements the same basic API as the <code>Serializer</code> class:</p>
<ul>
<li><code>.data</code> - Returns the outgoing primitive representation.返回传出的原始表示法 序列化对象返回的dict类型<br>把传递过来的数据对象当中所对应的字段提取出来构建成字段形式<br>源码</li>
</ul>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Serializer</span>(<span class="params">BaseSerializer, metaclass=SerializerMetaclass</span>):</span></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">data</span>(<span class="params">self</span>):</span></span><br><span class="line">        ret = super().data</span><br><span class="line">        <span class="keyword">return</span> ReturnDict(ret, serializer=self)</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li><code>.is_valid()</code> - Deserializes and validates incoming data. 会调用如果存在的验证器或自定义验证函数<code>def validate</code></li>
</ul>
<p>Using <code>.is_valid(raise_exception=True)</code><br>The <code>.is_valid()</code> method now takes an optional boolean flag, <code>raise_exception</code>.</p>
<p>Calling <code>.is_valid(raise_exception=True)</code> will cause a <code>ValidationError</code> to be raised if the serializer data contains validation errors. This error will be handled by REST framework’s default exception handler, allowing you to remove error response handling from your view code.</p>
<p>The handling and formatting of error responses may be altered globally by using the <code>EXCEPTION_HANDLER</code> settings key.</p>
<p>This change also means it’s now possible to alter the style of error responses used by the built-in generic views, without having to include mixin classes or other overrides.</p>
<ul>
<li><code>.validated_data</code> - Returns the validated incoming data.反序列化对象返回的dict类型</li>
</ul>
<p>Use <code>.validated_data</code> instead of <code>.object</code>.<br>You must now use the <code>.validated_data</code> attribute if you need to inspect the data before saving, rather than using the <code>.object attribute</code>, which no longer exists.</p>
<p>For example the following code is no longer valid:</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> serializer.is_valid():</span><br><span class="line">    name = serializer.object.name  <span class="comment"># Inspect validated field data.</span></span><br><span class="line">    logging.info(<span class="string">'Creating ticket "%s"'</span> % name)</span><br><span class="line">    serializer.object.user = request.user  <span class="comment"># Include the user when saving.</span></span><br><span class="line">    serializer.save()</span><br></pre></td></tr></tbody></table></figure>

<p>Instead of using <code>.object</code> to inspect a partially constructed instance,<br>you would now use <code>.validated_data</code> to inspect the cleaned incoming values.<br>Also you can’t set extra attributes on the instance directly,<br>but instead pass them to the <code>.save()</code> method as keyword arguments.</p>
<p>The corresponding code would now look like this:</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> serializer.is_valid():</span><br><span class="line">    name = serializer.validated_data[<span class="string">'name'</span>]  <span class="comment"># Inspect validated field data.</span></span><br><span class="line">    logging.info(<span class="string">'Creating ticket "%s"'</span> % name)</span><br><span class="line">    serializer.save(user=request.user)  <span class="comment"># Include the user when saving.</span></span><br></pre></td></tr></tbody></table></figure>

<ul>
<li><code>.errors</code> - Returns any errors during validation.</li>
<li><code>.save()</code> - Persists the validated data into an object instance.</li>
</ul>
<h4 id="视图函数创建Serializer对象的构造方法"><a href="#视图函数创建Serializer对象的构造方法" class="headerlink" title="视图函数创建Serializer对象的构造方法"></a>视图函数创建Serializer对象的构造方法</h4><figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CourseSerializer(instance=course, data=request.data)</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>用于序列化时，将模型类对象传入<code>instance</code>，要序列化的查询集实例，要序列化的 <code>course</code> 是查询出来的实例，<br>把<code>data</code>的数据序列化后保存或跟新到 <code>course</code> 这个对象里面，通过<code>data</code>属性可以获取序列化后的数据</li>
<li>用于反序列化时，将要被反序列化的数据传入<code>data</code>， POST BODY来的数据，<code>request.data</code> 是前端传递过来的数据</li>
<li>还可通过context参数额外添加数据，可以通过Serializer对象的context属性获取。</li>
</ul>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">serializer = AccountSerializer(account, context={<span class="string">'request'</span>: request})</span><br></pre></td></tr></tbody></table></figure>

<h3 id="ModelSerializer"><a href="#ModelSerializer" class="headerlink" title="ModelSerializer"></a><code>ModelSerializer</code></h3><p>相比于 <code>Serializer</code>，提供了：</p>
<ul>
<li>它省去了模型所有字段的添加和处理数据方法的实现</li>
<li>基于模型类自动生成模型中相应字段的映射</li>
<li>基于模型类自动为Serializer添加validators</li>
<li>包含默认的<code>create()</code>和<code>update()</code>的实现</li>
</ul>
<p>可以将字段转换成json，</p>
<p>写法和form表单类的建一个<code>form.py</code>类似，<code>modelform</code> 可以将字段转成html。<br><a target="_blank" rel="noopener" href="https://www.django-rest-framework.org/community/3.0-announcement/#differences-between-modelserializer-validation-and-modelform">https://www.django-rest-framework.org/community/3.0-announcement/#differences-between-modelserializer-validation-and-modelform</a></p>
<h4 id="实现课程信息数据接口"><a href="#实现课程信息数据接口" class="headerlink" title="实现课程信息数据接口"></a>实现课程信息数据接口</h4><p><code>course/serializers.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django <span class="keyword">import</span> forms</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> User</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Course</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># form类这里用不到，只是对比类似的样子</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CourseForm</span>(<span class="params">forms.ModelForm</span>):</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Course</span><br><span class="line">        fields = (<span class="string">'name'</span>, <span class="string">'introduction'</span>, <span class="string">'teacher'</span>, <span class="string">'price'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = User  <span class="comment"># 指定序列化生成字段的用户模型类</span></span><br><span class="line">        fields = <span class="string">'__all__'</span>  <span class="comment"># 指定序列化所有字段</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CourseSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="comment"># teacher是外键关联到用户表，并不是新建过程中新建的一个用户，</span></span><br><span class="line">    <span class="comment"># 法一：详细显示外键老师信息，想得到对应的名字，可以把用户的名称序列化，和使用ORM查询外键关联查询一样，</span></span><br><span class="line">    teacher = serializers.ReadOnlyField(source=<span class="string">'teacher.username'</span>)  <span class="comment"># 序列化模型类中指定字段，外键字段，指定只读字段</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Course  <span class="comment"># 要序列化的模型课程类</span></span><br><span class="line">        <span class="comment"># exclude = ('id', )  # 排除字段</span></span><br><span class="line">        <span class="comment"># fields = ('id', 'name', 'introduction', 'teacher', 'price', 'created_at', 'updated_at')</span></span><br><span class="line">        fields = <span class="string">'__all__'</span>  <span class="comment"># 要序列化的模型字段，模型类所有字段</span></span><br><span class="line">        depth = <span class="number">2</span>  <span class="comment"># 深度</span></span><br></pre></td></tr></tbody></table></figure>

<p>上面的代码直接继承了<code>ModelSerializer</code>，<br>通过<code>Meta</code>类的<code>model</code>属性指定要序列化的模型以及<code>fields</code>属性指定需要序列化的模型字段，</p>
<p>在视图函数中使用该类来实现对<code>Course</code>模型的序列化。</p>
<p>法二</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TeacherSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Teacher  <span class="comment"># 序列化用户模型类</span></span><br><span class="line">        fields = <span class="string">'__all__'</span> <span class="comment"># 要序列化的模型字段，模型类所有字段</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CourseSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    teacher = TeacherSerializer()  <span class="comment"># 详细显示一对一外键老师信息，Serialzer还可以嵌套使用，覆盖外键字段</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Course  <span class="comment"># 要序列化的模型课程类</span></span><br><span class="line">        <span class="comment"># exclude = ('id', )  # 排除指定字段</span></span><br><span class="line">        <span class="comment"># fields = ('id', 'name', 'introduction', 'teacher', 'price', 'created_at', 'updated_at')</span></span><br><span class="line">        fields = <span class="string">'__all__'</span>  <span class="comment"># 要序列化的模型字段，模型类所有字段</span></span><br><span class="line">        depth = <span class="number">2</span>  <span class="comment"># 深度</span></span><br><span class="line">        extra_kwargs = {  <span class="comment"># 添加修改字段选项参数</span></span><br><span class="line">            <span class="string">'name'</span>: {<span class="string">'write_only|read_only'</span>: <span class="literal">True</span>}</span><br><span class="line">            }</span><br><span class="line">        read_only_fields = (<span class="string">'name'</span>,)  <span class="comment"># 只读字段，即仅用于序列化输出的字段</span></span><br></pre></td></tr></tbody></table></figure>

<p>在python manage.py shell中查看自动生成的BookInfoSerializer的具体</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> .serializers <span class="keyword">import</span> TeacherSerializer</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>serializer = TeacherSerializer()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>serializer</span><br><span class="line">TeacherSerializer():</span><br><span class="line">    id = IntegerField(label=<span class="string">'ID'</span>, read_only=<span class="literal">True</span>)</span><br><span class="line">    btitle = CharField(label=<span class="string">'名称'</span>, max_length=<span class="number">20</span>)</span><br><span class="line">    bpub_date = DateField(allow_null=<span class="literal">True</span>, label=<span class="string">'发布日期'</span>, required=<span class="literal">False</span>)</span><br><span class="line">    bread = IntegerField(label=<span class="string">'阅读量'</span>, max_value=<span class="number">2147483647</span>, min_value=<span class="number">-2147483648</span>, required=<span class="literal">False</span>)</span><br><span class="line">    bcomment = IntegerField(label=<span class="string">'评论量'</span>, max_value=<span class="number">2147483647</span>, min_value=<span class="number">-2147483648</span>, required=<span class="literal">False</span>)</span><br><span class="line">    image = ImageField(allow_null=<span class="literal">True</span>, label=<span class="string">'图片'</span>, max_length=<span class="number">100</span>, required=<span class="literal">False</span>)</span><br></pre></td></tr></tbody></table></figure>

<p>实现序列化结果带绝对和相对URL超链接的<code>HyperlinkedModelSerializer</code>的api，在<code>fields</code> 加上 <code>url</code>，不用用于FBV</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Course</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CourseSerializer</span>(<span class="params">serializers.HyperlinkedModelSerializer</span>):</span></span><br><span class="line">    teacher = serializers.ReadOnlyField(source=<span class="string">'teacher.username'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Course  <span class="comment"># 要序列化的模型课程类</span></span><br><span class="line">        <span class="comment"># url是默认值，可在settings.py中设置URL_FIELD_NAME使全局生效</span></span><br><span class="line">        fields = (<span class="string">'id'</span>, <span class="string">'url'</span>, <span class="string">'name'</span>, <span class="string">'introduction'</span>, <span class="string">'teacher'</span>, <span class="string">'price'</span>, <span class="string">'created_at'</span>, <span class="string">'updated_at'</span>)  <span class="comment"># 要序列化的模型字段</span></span><br><span class="line">        exclude = (<span class="string">'subject'</span>, )</span><br></pre></td></tr></tbody></table></figure>

<p>上面的代码直接继承了<code>HyperlinkedModelSerializer</code>，<br>通过<code>Meta</code>类的<code>model</code>属性指定要序列化的模型以及<code>fields</code>属性指定需要序列化的模型字段，<br>稍后我们就可以在视图函数中使用该类来实现对<code>Course</code>模型的序列化。</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@api_view(('GET', ))</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_teachers</span>(<span class="params">request: HttpRequest</span>) -&gt; HttpResponse:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        sno = int(request.GET.get(<span class="string">'sno'</span>))</span><br><span class="line">        subject = Subject.objects.only(<span class="string">'name'</span>).get(no=sno)</span><br><span class="line">        teachers = Teacher.objects.filter(subject=subject).defer(<span class="string">'subject'</span>).order_by(<span class="string">'no'</span>)</span><br><span class="line">        subject_seri = SubjectSimpleSerializer(subject)</span><br><span class="line">        teacher_seri = TeacherSerializer(teachers, many=<span class="literal">True</span>)  <span class="comment"># 一对多</span></span><br><span class="line">        <span class="keyword">return</span> Response({<span class="string">'subject'</span>: subject_seri.data, <span class="string">'teachers'</span>: teacher_seri.data})</span><br><span class="line">    <span class="keyword">except</span> (TypeError, ValueError, Subject.DoesNotExist):</span><br><span class="line">        <span class="keyword">return</span> Response(status=<span class="number">404</span>)</span><br></pre></td></tr></tbody></table></figure>

<h3 id="序列化使用"><a href="#序列化使用" class="headerlink" title="序列化使用"></a>序列化使用</h3><p>1 基本使用</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py shell</span><br></pre></td></tr></tbody></table></figure>

<p>1） 先查询出<strong>一个</strong>图书对象</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> booktest.models <span class="keyword">import</span> BookInfo</span><br><span class="line">book = BookInfo.objects.get(id=<span class="number">2</span>)</span><br></pre></td></tr></tbody></table></figure>

<p>2） 构造序列化器对象</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> booktest.serializers <span class="keyword">import</span> BookInfoSerializer</span><br><span class="line">serializer = BookInfoSerializer(book)</span><br></pre></td></tr></tbody></table></figure>

<p>3）获取序列化数据<br>通过<code>.data</code>属性可以获取序列化后的数据</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">serializer.data</span><br><span class="line"><span class="comment"># {'id': 2, 'btitle': '天龙八部', 'bpub_date': '1986-07-24', 'bread': 36, 'bcomment': 40, 'image': None}</span></span><br></pre></td></tr></tbody></table></figure>

<p>4）如果要被序列化的是包含<strong>多条</strong>数据的查询集QuerySet，可以通过添加<code>many=True</code>参数补充说明</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">book_qs = BookInfo.objects.all()</span><br><span class="line">serializer = BookInfoSerializer(book_qs, many=<span class="literal">True</span>)</span><br><span class="line">serializer.data</span><br><span class="line"><span class="comment"># [OrderedDict([('id', 2), ('btitle', '天龙八部'), ('bpub_date', '1986-07-24'), ('bread', 36), ('bcomment', 40), ('image', N]), OrderedDict([('id', 3), ('btitle', '笑傲江湖'), ('bpub_date', '1995-12-24'), ('bread', 20), ('bcomment', 80), ('image'ne)]), OrderedDict([('id', 4), ('btitle', '雪山飞狐'), ('bpub_date', '1987-11-11'), ('bread', 58), ('bcomment', 24), ('ima None)]), OrderedDict([('id', 5), ('btitle', '西游记'), ('bpub_date', '1988-01-01'), ('bread', 10), ('bcomment', 10), ('im', 'booktest/xiyouji.png')])]</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="关联对象嵌套序列化"><a href="#关联对象嵌套序列化" class="headerlink" title="关联对象嵌套序列化"></a>关联对象嵌套序列化</h3><p>返回当前类数据和关联模型类的数据</p>
<p>如果需要序列化的数据中包含有其他关联对象，则对关联对象数据的序列化需要指明。</p>
<p><a target="_blank" rel="noopener" href="https://www.django-rest-framework.org/api-guide/relations/#primarykeyrelatedfield">https://www.django-rest-framework.org/api-guide/relations/#primarykeyrelatedfield</a></p>
<h4 id="PrimaryKeyRelatedField"><a href="#PrimaryKeyRelatedField" class="headerlink" title="PrimaryKeyRelatedField"></a><code>PrimaryKeyRelatedField</code></h4><p>may be used to represent the target of the relationship using its primary key. 此字段将被序列化为关联对象的主键，<br>By default this field is read-write, although you can change this behavior using the <code>read_only</code> flag.默认可以读写</p>
<p>Arguments:</p>
<ul>
<li><p><code>queryset</code> - The queryset used for model instance lookups when validating the field input.在验证字段输入（反序列化）时用于模型实例查找的<code>queryset</code>。<br>Relationships must either set a queryset explicitly, or set <code>read_only=True</code>.关系必须显式设置<code>queryset</code>，或者设置<code>read_only=True</code>。</p>
</li>
<li><p><code>many</code> - If applied to a to-many relationship, you should set this argument to <code>True</code>.如果应用于多?对多关系，则应将此参数设置为<code>True</code></p>
</li>
<li><p><code>allow_null</code> - If set to <code>True</code>, the field will accept values of <code>None</code> or the empty string for nullable relationships. Defaults to <code>False</code>.<br>如果设置为<code>True</code>，该字段将接受<code>None</code>值或空字符串，用于可空关系。默认值为<code>False</code>。</p>
</li>
<li><p><code>pk_field</code> - Set to a field to control serialization/deserialization of the primary key’s value.设置为一个字段来控制主键值的序列化/反序列化。<br>For example, <code>pk_field=UUIDField(format='hex')</code> would serialize a UUID primary key into its compact hex representation.<br>例如，<code>pk_field=UUIDField(format='hex')</code>将把UUID主键序列化为紧凑的十六进制表示形式。</p>
</li>
</ul>
<p><code>heroinfo_set = serializers.PrimaryKeyRelatedField(read_only=True, many=True)</code></p>
<p>For example, the following serializer:</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AlbumSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="comment"># 每个Album对象关联的多个歌曲tracks对象</span></span><br><span class="line">    tracks = serializers.PrimaryKeyRelatedField(many=<span class="literal">True</span>, read_only=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Album</span><br><span class="line">        fields = [<span class="string">'album_name'</span>, <span class="string">'artist'</span>, <span class="string">'tracks'</span>]</span><br></pre></td></tr></tbody></table></figure>

<p>Would serialize to a representation like this:</p>
<figure class="highlight"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// serializer = HeroInfoSerializer(hero)</span></span><br><span class="line"><span class="comment">// serializer.data</span></span><br><span class="line">{</span><br><span class="line">    'album_name': 'Undun',</span><br><span class="line">    'artist': 'The Roots',</span><br><span class="line">    'tracks': [  // 每个Album对象关联的多个歌曲tracks对象</span><br><span class="line">        89,</span><br><span class="line">        90,</span><br><span class="line">        91,</span><br><span class="line">        ...</span><br><span class="line">    ]</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 多类</span></span><br><span class="line">hbook = serializers.PrimaryKeyRelatedField(label=<span class="string">'图书'</span>, read_only=<span class="literal">True</span>)</span><br><span class="line"><span class="comment"># 或</span></span><br><span class="line">hbook = serializers.PrimaryKeyRelatedField(label=<span class="string">'图书'</span>, queryset=BookInfo.objects.all())</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 一类</span></span><br><span class="line">heroinfo_set = serializers.PrimaryKeyRelatedField(label=<span class="string">'图书'</span>,read_only=<span class="literal">True</span>, many= <span class="literal">True</span>)</span><br></pre></td></tr></tbody></table></figure>

<h4 id="StringRelatedField"><a href="#StringRelatedField" class="headerlink" title="StringRelatedField"></a><code>StringRelatedField</code></h4><p>may be used to represent the target of the relationship using its <code>__str__</code> method.<br>此字段将被序列化为关联对象的字符串表示方式，关联对象模型类的<code>__str__</code>方法值<br>his field is read only.</p>
<p>Arguments:</p>
<ul>
<li><code>many</code> - If applied to a to-many relationship, you should set this argument to True.</li>
</ul>
<p><code>heroinfo_set = serializers.StringRelatedField(read_only=True, many=True)</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 多类</span></span><br><span class="line"> hbook = serializers.StringRelatedField(label=<span class="string">'图书'</span>)</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 一类</span></span><br><span class="line"> heroinfo_set = serializers.StringRelatedField(label=<span class="string">'图书'</span>,read_only=<span class="literal">True</span>, many=<span class="literal">True</span>)</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>在当前的序列化类指定实例化其关联对象序列化器类<br><code>heroinfo_set = HeroInfoSerialzier(many=True)</code></li>
</ul>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 多类</span></span><br><span class="line">hbook = BookInfoSerializer()</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 一类</span></span><br><span class="line">heroinfo_set = HeroInfoSerializer(label=<span class="string">'图书'</span>, many=<span class="literal">True</span>)</span><br></pre></td></tr></tbody></table></figure>

<p>使用效果</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> booktest.serializers <span class="keyword">import</span> HeroInfoSerializer</span><br><span class="line"><span class="keyword">from</span> booktest.models <span class="keyword">import</span> HeroInfo</span><br><span class="line">hero = HeroInfo.objects.get(id=<span class="number">6</span>)</span><br><span class="line">serializer = HeroInfoSerializer(hero)</span><br><span class="line">serializer.data</span><br><span class="line"><span class="comment"># {'id': 6, 'hname': '乔峰', 'hgender': 1, 'hcomment': '降龙十八掌', 'hbook': 2}</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GoodsImageSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="string">'''商品图片'''</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = GoodsImage</span><br><span class="line">        fields = [<span class="string">'image'</span>, ]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GoodsSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="string">'''商品详情序列化'''</span></span><br><span class="line">    <span class="comment"># 关联对象嵌套序列化，返回当前类数据和关联模型类的数据</span></span><br><span class="line">    category = CategorySerializer()  <span class="comment"># 一对一</span></span><br><span class="line">    <span class="comment"># images是数据库中设置的related_name="images"，把商品图嵌套进来</span></span><br><span class="line">    images = GoodsImageSerializer(many=<span class="literal">True</span>)  <span class="comment"># 一对多</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Goods</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="SerializerMethodField"><a href="#SerializerMethodField" class="headerlink" title="SerializerMethodField"></a><code>SerializerMethodField</code></h4><p>This is a read-only field. It gets its value by calling a method on the serializer class it is attached to. It can be used to add any sort of data to the serialized representation of your object.<br>这是一个只读字段。它通过在附加的序列化器类上调用一个方法来获取其值。它可以用于将任何类型的数据添加到对象的序列化表示中。<br>Signature: <code>SerializerMethodField(method_name=None)</code></p>
<ul>
<li><code>method_name</code> - The name of the method on the serializer to be called. If not included this defaults to <code>get_&lt;field_name&gt;</code>.<br>是要调用的序列化程序上的方法的名称，如果未包括，则默认为<code>get_&lt;field_name&gt;</code>。</li>
</ul>
<p>The serializer method referred to by the <code>method_name</code> argument should accept a single argument (in addition to <code>self</code>), which is the object being serialized. It should return whatever you want to be included in the serialized representation of the object. For example:<br><code>method_name</code>参数所对应的序列化器方法应接受单个参数（除了<code>self</code>之外），<br>该参数是要被序列化的对象，它应该返回想要包含在对象序列化表示中的任何内容。</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/7/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><span class="page-number current">8</span><a class="page-number" href="/page/9/">9</a><span class="space">&hellip;</span><a class="page-number" href="/page/34/">34</a><a class="extend next" rel="next" href="/page/9/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">外心人D</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  




  





</body>
</html>
