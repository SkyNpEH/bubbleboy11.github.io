<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.0.2">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<meta name="hexo-config" content="{&quot;hostname&quot;:&quot;bubbleboy11.github.io&quot;,&quot;root&quot;:&quot;/&quot;,&quot;images&quot;:&quot;/images&quot;,&quot;scheme&quot;:&quot;Muse&quot;,&quot;version&quot;:&quot;8.3.0&quot;,&quot;exturl&quot;:false,&quot;sidebar&quot;:{&quot;position&quot;:&quot;left&quot;,&quot;display&quot;:&quot;post&quot;,&quot;padding&quot;:18,&quot;offset&quot;:12},&quot;copycode&quot;:true,&quot;bookmark&quot;:{&quot;enable&quot;:false,&quot;color&quot;:&quot;#222&quot;,&quot;save&quot;:&quot;auto&quot;},&quot;fancybox&quot;:false,&quot;mediumzoom&quot;:false,&quot;lazyload&quot;:false,&quot;pangu&quot;:false,&quot;comments&quot;:{&quot;style&quot;:&quot;tabs&quot;,&quot;active&quot;:null,&quot;storage&quot;:true,&quot;lazyload&quot;:false,&quot;nav&quot;:null},&quot;motion&quot;:{&quot;enable&quot;:true,&quot;async&quot;:false,&quot;transition&quot;:{&quot;post_block&quot;:&quot;fadeIn&quot;,&quot;post_header&quot;:&quot;fadeInDown&quot;,&quot;post_body&quot;:&quot;fadeInDown&quot;,&quot;coll_header&quot;:&quot;fadeInLeft&quot;,&quot;sidebar&quot;:&quot;fadeInUp&quot;}},&quot;prism&quot;:false,&quot;i18n&quot;:{&quot;placeholder&quot;:&quot;搜索...&quot;,&quot;empty&quot;:&quot;没有找到任何搜索结果：${query}&quot;,&quot;hits_time&quot;:&quot;找到 ${hits} 个搜索结果（用时 ${time} 毫秒）&quot;,&quot;hits&quot;:&quot;找到 ${hits} 个搜索结果&quot;}}">
<meta name="description" content="本博客大多内容为慕课和网上博客，并非原创">
<meta property="og:type" content="website">
<meta property="og:title" content="外心人D的博客">
<meta property="og:url" content="https://bubbleboy11.github.io/page/2/index.html">
<meta property="og:site_name" content="外心人D的博客">
<meta property="og:description" content="本博客大多内容为慕课和网上博客，并非原创">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="外心人D">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://bubbleboy11.github.io/page/2/">



<meta name="hexo-config-page" content="{&quot;sidebar&quot;:&quot;&quot;,&quot;isHome&quot;:true,&quot;isPost&quot;:false,&quot;lang&quot;:&quot;zh-CN&quot;}">
<meta name="hexo-config-calendar" content="">
<script data-pjax src="/js/load-config.js"></script>
  <title>外心人D的博客</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="外心人D的博客" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism.css" type="text/css"></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">外心人D的博客</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">外心人D</p>
  <div class="site-description" itemprop="description">本博客大多内容为慕课和网上博客，并非原创</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">267</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">24</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">40</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/05/29/drf-simplejwt/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/29/drf-simplejwt/" class="post-title-link" itemprop="url">drf-simplejwt</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-05-28 16:21:41" itemprop="dateCreated datePublished" datetime="2021-05-28T16:21:41Z">2021-05-28</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-06-07 06:55:46" itemprop="dateModified" datetime="2021-06-07T06:55:46Z">2021-06-07</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/django/" itemprop="url" rel="index"><span itemprop="name">django</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>JSON Web Token Authentication<br>JSON Web Token is a fairly new standard which can be used for token-based authentication. Unlike the built-in TokenAuthentication scheme, JWT Authentication doesn’t need to use a database to validate a token. A package for JWT authentication is djangorestframework-simplejwt which provides some features as well as a pluggable token blacklist app.</p>
</blockquote>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install djangorestframework-simplejwt</span><br></pre></td></tr></tbody></table></figure>

<p>Some of Simple JWT’s behavior can be customized through settings variables in <code>settings.py</code>:</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">REST_FRAMEWORK = {</span><br><span class="line">    <span class="string">'DEFAULT_AUTHENTICATION_CLASSES'</span>: [</span><br><span class="line">        <span class="comment"># 'rest_framework_simplejwt.authentication.JWTAuthentication',</span></span><br><span class="line">    ],</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment"># JWT自定义配置</span></span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> timedelta</span><br><span class="line">SIMPLE_JWT = {</span><br><span class="line">    <span class="string">'ACCESS_TOKEN_LIFETIME'</span>: timedelta(days=<span class="number">1</span>),  <span class="comment"># 设置token过期时间</span></span><br><span class="line">    <span class="string">'REFRESH_TOKEN_LIFETIME'</span>: timedelta(days=<span class="number">1</span>),  <span class="comment"># 这个时间段内刷新JWT可以保持登录状态</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>token认证最好是放在view里面去配置局部JWTAuthentication认证，不要配置在全局变量中，如果再前端请求中，每一个request都加入token，这个token恰好过期了，那么用户在访问category、goods这种公开数据时，就会抛异常，连商品的列表页都访问不了了。</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> permissions</span><br><span class="line"><span class="keyword">from</span> rest_framework_simplejwt <span class="keyword">import</span> authentication</span><br><span class="line"><span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> APIView</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    permission_classes = [permissions.IsAuthenticated]</span><br><span class="line">    authentication_classes = [authentication.JWTAuthentication]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="keyword">return</span> Response(<span class="string">'ok'</span>)</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework_simplejwt.views <span class="keyword">import</span> (</span><br><span class="line">    TokenObtainPairView,</span><br><span class="line">    TokenRefreshView,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">'api/auth/token/obtain/'</span>, TokenObtainPairView.as_view()),  <span class="comment"># 不需要添加的内容</span></span><br><span class="line">    path(<span class="string">'api/auth/token/refresh/'</span>, TokenRefreshView.as_view()),  <span class="comment"># 不需要添加的内容</span></span><br><span class="line">    path(<span class="string">'api/test/'</span>, TestView.as_view()),  <span class="comment"># 添加测试views的路由</span></span><br><span class="line">]</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/05/29/drf-simplejwt/1.png" alt="description"></p>
<p>使用返回的<code>access</code> 这个就是<code>token</code>但是框架里叫做<code>access</code>，验证受保护视图的身份验证。</p>
<p>验证格式为：<code>Authorization: Bearer [access对应的值]</code> 不再是<code>Token</code></p>
<p>当这个短暂的access token过期时，可以使用较长时间的refresh token获得另一个accesstoken。<br>页面上测试使用这个access请求，同样在list函数中打上断点。进入调试状态。</p>
<p>refresh：当前端token过期需要刷新token的时候就可以访问<a href="api/token/refresh">api/token/refresh</a>，<br>表单参数就是refresh的值。将refresh的值传入后POST提交得到新的access</p>
<p><img src="/2021/05/29/drf-simplejwt/2.png" alt="description"></p>
<h3 id="手动为用户创建令牌"><a href="#手动为用户创建令牌" class="headerlink" title="手动为用户创建令牌"></a>手动为用户创建令牌</h3><p><a target="_blank" rel="noopener" href="https://django-rest-framework-simplejwt.readthedocs.io/en/latest/creating_tokens_manually.html">https://django-rest-framework-simplejwt.readthedocs.io/en/latest/creating_tokens_manually.html</a><br>Sometimes, you may wish to manually create a token for a user. This could be done as follows:</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework_simplejwt.tokens <span class="keyword">import</span> RefreshToken</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_tokens_for_user</span>(<span class="params">user</span>):</span></span><br><span class="line">    refresh = RefreshToken.for_user(user)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> {</span><br><span class="line">        <span class="string">'refresh'</span>: str(refresh),</span><br><span class="line">        <span class="string">'access'</span>: str(refresh.access_token),</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure>

<p>The above function <code>get_tokens_for_user</code> will return the serialized representations of new refresh and access tokens for the given user.<br>In general, a token for any subclass of <code>rest_framework_simplejwt.tokens.Token</code> can be created in this way.</p>
<p><code>get_tokens_for_user</code>将返回给定用户的新<code>refresh</code>和<code>access tokens</code>的序列化表示。<br>通常，<code>rest_framework_simplejwt.token</code>的任何子类的令牌。可以用这种方式创建令牌。</p>
<p>自定义djangorestframework-simplejwt</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework_simplejwt.serializers <span class="keyword">import</span> TokenObtainPairSerializer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyTokenObtainPairSerializer</span>(<span class="params">TokenObtainPairSerializer</span>):</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    token验证</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate</span>(<span class="params">self, attrs</span>):</span></span><br><span class="line">        data = super().validate(attrs)</span><br><span class="line"></span><br><span class="line">        refresh = self.get_token(self.user)</span><br><span class="line"></span><br><span class="line">        data[<span class="string">'refresh'</span>] = str(refresh)</span><br><span class="line">        data[<span class="string">'access'</span>] = str(refresh.access_token)</span><br><span class="line">        data[<span class="string">'username'</span>] = self.user.username <span class="comment">#这个是你的自定义返回的</span></span><br><span class="line">        data[<span class="string">'user_id'</span>] = self.user.id <span class="comment">#这个是你的自定义返回的</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> data</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework_simplejwt.views <span class="keyword">import</span> TokenViewBase</span><br><span class="line"><span class="keyword">from</span> rest_framework_simplejwt.serializers <span class="keyword">import</span> TokenRefreshSerializer</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyTokenObtainPairView</span>(<span class="params">TokenObtainPairView</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    自定义得到token username: 账号或者密码 password: 密码或者验证码</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    serializer_class = MyTokenObtainPairSerializer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyTokenRefreshView</span>(<span class="params">TokenViewBase</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    自定义刷新token refresh: 刷新token的元素</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    serializer_class = TokenRefreshSerializer</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">'api/test/'</span>, MyTokenObtainPairView.as_view()),  <span class="comment"># 添加测试views的路由</span></span><br><span class="line">]</span><br></pre></td></tr></tbody></table></figure>


<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">    <span class="attr">"msg"</span>: <span class="string">"success"</span>,</span><br><span class="line">    <span class="attr">"code"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"data"</span>: {</span><br><span class="line">        <span class="attr">"refresh"</span>: <span class="string">"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ0b2tlbl90eXBlIjoicmVmcmVzaCIsImV4cCI6MTU4NjMxMjYyOSwianRpIjoiZWUzNTQxNmIzMDZjNDIyY2EyOWFiOGQ5NjhlNjc3ZWYiLCJ1c2VyX2lkIjoxfQ.th5AfYNsd9UK3zL9LEhnDRNrd37Ut8ucl-G9VzYlCHI"</span>,</span><br><span class="line">        <span class="attr">"access"</span>: <span class="string">"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ0b2tlbl90eXBlIjoiYWNjZXNzIiwiZXhwIjoxNTg1NjIxNDI5LCJqdGkiOiJlYmI3ZDdmOTBlNzU0OTNkYjM4NTNiNTJkYzA0Yjk3NiIsInVzZXJfaWQiOjF9.WeoTxQ2rG0BOl9ji6KO3yfLm83kcsHV1drFDxGxAvGA"</span>,</span><br><span class="line">        <span class="attr">"username"</span>: <span class="string">"hahn"</span>,</span><br><span class="line">        <span class="attr">"user_id"</span>: <span class="number">1</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>刷新token</p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">    <span class="attr">"msg"</span>: <span class="string">"success"</span>,</span><br><span class="line">    <span class="attr">"code"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"data"</span>: {</span><br><span class="line">        <span class="attr">"access"</span>: <span class="string">"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ0b2tlbl90eXBlIjoiYWNjZXNzIiwiZXhwIjoxNTg1NjIxNTIyLCJqdGkiOiI4MzcyN2UwYWVhMDU0MWYyYmE1ODljOWY5NTMzYjE2OSIsInVzZXJfaWQiOjF9.NTo1YKFl9tvcCYQVmBWLz0rhRL8044qT65jbe7okeG0"</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>jwt解码</p>
<p>源码</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TokenVerifySerializer</span>(<span class="params">serializers.Serializer</span>):</span></span><br><span class="line">    token = serializers.CharField()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate</span>(<span class="params">self, attrs</span>):</span></span><br><span class="line">        UntypedToken(attrs[<span class="string">'token'</span>])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> {}</span><br></pre></td></tr></tbody></table></figure>

<p>根据token返回对于的数据</p>
<p><code>serializers.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework_simplejwt.serializers <span class="keyword">import</span> TokenVerifySerializer</span><br><span class="line"><span class="keyword">from</span> jwt <span class="keyword">import</span> decode</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyTokenVerifySerializer</span>(<span class="params">TokenVerifySerializer</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    token验证</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate</span>(<span class="params">self, attrs</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        attrs['token']: 是请求的token</span></span><br><span class="line"><span class="string">        settings.SECRET_KEY: setting.py默认的key 除非在配置文件中修改了</span></span><br><span class="line"><span class="string">        algorithms: 加密的方法</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        decoded_data = decode(attrs[<span class="string">'token'</span>], settings.SECRET_KEY, algorithms=[<span class="string">"HS256"</span>])</span><br><span class="line">        <span class="keyword">return</span> decoded_data</span><br></pre></td></tr></tbody></table></figure>

<p><code>views.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework_simplejwt.views <span class="keyword">import</span> TokenObtainPairView, TokenViewBase</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyTokenVerifyView</span>(<span class="params">TokenViewBase</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    验证token得到用户信息 token: 验证的token</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    serializer_class = MyTokenVerifySerializer</span><br></pre></td></tr></tbody></table></figure>

<p>返回的数据<br>user_id就是你的用户ID</p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">    <span class="attr">"msg"</span>: <span class="string">"success"</span>,</span><br><span class="line">    <span class="attr">"status"</span>: <span class="number">200</span>,</span><br><span class="line">    <span class="attr">"data"</span>: {</span><br><span class="line">        <span class="attr">"token_type"</span>: <span class="string">"access"</span>,</span><br><span class="line">        <span class="attr">"exp"</span>: <span class="number">1585710741</span>,</span><br><span class="line">        <span class="attr">"jti"</span>: <span class="string">"97b42a6570d84108bf09701a60fbf5c1"</span>,</span><br><span class="line">        <span class="attr">"user_id"</span>: <span class="number">1</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="djangorestframework-simplejwt退出登录"><a href="#djangorestframework-simplejwt退出登录" class="headerlink" title="djangorestframework-simplejwt退出登录"></a>djangorestframework-simplejwt退出登录</h3><p>JWT是不带退出内置的办法的<br>JWT退出登录很多方法<br>我这里是使用Django-redis库、用redis管理JWT的状态。用用户作为key保存token。</p>
<p><code>setting.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># redis配置</span></span><br><span class="line">CACHES = {</span><br><span class="line">    <span class="string">"default"</span>: {</span><br><span class="line">        <span class="string">"BACKEND"</span>: <span class="string">"django_redis.cache.RedisCache"</span>,</span><br><span class="line">        <span class="string">"LOCATION"</span>: <span class="string">"redis://127.0.0.1:6379"</span>,</span><br><span class="line">        <span class="string">"OPTIONS"</span>: {</span><br><span class="line">            <span class="string">"CLIENT_CLASS"</span>: <span class="string">"django_redis.client.DefaultClient"</span>,</span><br><span class="line">            <span class="string">"PASSWORD"</span>: <span class="string">""</span>,</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment"># redis缓存时间</span></span><br><span class="line">REDIS_TIMEOUT = <span class="number">60</span>*<span class="number">60</span>*<span class="number">24</span>*<span class="number">7</span></span><br></pre></td></tr></tbody></table></figure>

<p>保存redis缓存</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.core.cache <span class="keyword">import</span> cache</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 设置redis缓存</span></span><br><span class="line">        <span class="comment"># redis_key你的key</span></span><br><span class="line">        <span class="comment"># token token</span></span><br><span class="line">        <span class="comment"># REDIS_TIMEOUT 保存的数据</span></span><br><span class="line">        cache.set(redis_key, token, REDIS_TIMEOUT)</span><br></pre></td></tr></tbody></table></figure>

<p>清除redis缓存<br>我这里是把value变成空了、方便判断</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置redis缓存</span></span><br><span class="line"><span class="comment"># redis_key你的key</span></span><br><span class="line"><span class="comment"># REDIS_TIMEOUT 保存的数据</span></span><br><span class="line">cache.set(redis_key,<span class="string">''</span>, REDIS_TIMEOUT)</span><br></pre></td></tr></tbody></table></figure>

<p>查看redis缓存</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 解码token得到user_id</span></span><br><span class="line">decoded_data = jwt_decode(token algorithms=[<span class="string">"HS256"</span>])</span><br><span class="line"><span class="comment"># redis_key 你设置的redis的key</span></span><br><span class="line">results = cache.get(redis_key)</span><br><span class="line"><span class="comment"># 判断、写自己的业务逻辑</span></span><br></pre></td></tr></tbody></table></figure>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/05/24/pyjwt/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/24/pyjwt/" class="post-title-link" itemprop="url">drf认证和权限</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-05-23 16:21:41" itemprop="dateCreated datePublished" datetime="2021-05-23T16:21:41Z">2021-05-23</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-05-29 07:38:06" itemprop="dateModified" datetime="2021-05-29T07:38:06Z">2021-05-29</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/django/" itemprop="url" rel="index"><span itemprop="name">django</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前后端分离下-微信小程序-app的用户登录"><a href="#前后端分离下-微信小程序-app的用户登录" class="headerlink" title="前后端分离下/微信小程序/app的用户登录"></a>前后端分离下/微信小程序/app的用户登录</h1><p>HTTP是无状态的，一次请求结束连接断开，下次服务器再收到请求，它就不知道这个请求是哪个用户发过来的。<br>但是对于一个Web应用而言，它是需要有状态管理的，这样才能让服务器知道HTTP请求来自哪个用户，从而判断是否允许该用户请求以及为用户提供更好的服务，这个过程就是常说的<strong>会话管理</strong>。</p>
<p>之前我们做会话管理（用户跟踪）的方法是：用户登录成功后，在服务器端通过一个session对象保存用户相关数据，然后把session对象的ID写入浏览器的cookie中；<br>下一次请求时，HTTP请求头中携带cookie的数据，<br>服务器从HTTP请求头读取cookie中的sessionid，根据这个标识符找到对应的session对象，这样就能够获取到之前保存在session中的用户数据。</p>
<p>REST架构是最适合互联网应用的架构，它强调了HTTP的无状态性，这样才能保证应用的水平扩展能力（当并发访问量增加时，可以通过增加新的服务器节点来为系统扩容）。<br>基于session实现用户跟踪的方式需要服务器保存session对象在内存中，每个用户经过我们的应用认证之后，我们的应用都要在服务端做一次记录，以方便用户下次请求的鉴别，而随着认证用户和多个客户端的增多，在做水平扩展增加新的服务器节点时，需要复制和同步session对象，服务端的开销会明显增大</p>
<ol>
<li>相比<code>JWT</code>，最大的优势就在于可以主动清除 <code>session</code>。</li>
<li><code>session</code>保存在服务器端，相对较为安全。</li>
<li>结合<code>cookie</code>使用，较为灵活，兼容性较好。但是在跨域场景表现不好。<br>cookie是用来前后端传输来做用户识别的，cookie如果被截获，用户就会很容易受到跨站请求伪造的攻击。</li>
</ol>
<p>解决这个问题有两种方案，<br>一种是架设缓存服务器（如Redis），让多个服务器节点共享缓存服务并将session对象直接置于缓存服务器中；<br>当用户对其他的接口访问时，必须携带这个token，接着服务器判断这个token是否存在与redis中，来判断用户是否已经登陆或者是否有相应的权限</p>
<p>另一种方式放弃基于session的用户跟踪，使用<strong>基于token令牌的用户跟踪</strong>。<br>传统的token是某个用户登录成功之后，服务器生成一个随机token给用户保存，并且服务器(数据库或缓存)保留同一份token，以后用户再来访问时需携带 token，服务端接收到 token 之后，去数据库或缓存中进行校验 token 的是否超时、是否合法</p>
<p>基于token的用户跟踪具体流程如下：</p>
<ol>
<li>用户使用用户名密码来请求服务器，服务器进行验证用户的信息，如果登录成功，服务器为用户加密生成一个字符串（token）令牌发给作客户端作为请求的一个身份标识，<br>该令牌中通常包含了用户标识、过期时间等信息而且需要加密并生成指纹（避免伪造或篡改令牌），</li>
<li>前端获取到服务器返回的token，保存在浏览器本地存储（可以保存在<code>localStorage</code>或<code>sessionStorage</code>中，对于使用Vue.js的前端项目来说，还可以通过Vuex进行状态管理）；</li>
<li>对于使用了前端路由的项目来说，前端每次路由跳转，可以先判断<code>localStroage</code>中有无token，如果没有则跳转到登录页；通过js取出本地数据按需使用这个数据，</li>
<li>以后每次请求后端数据接口，客户端只需在HTTP请求头里携带token来请求数据，无需再次带上用户名和密码。服务端后端接口判断请求头有无token，如果没有token以及token是无效的或过期的，服务器统一返回401；</li>
<li>如果前端收到HTTP响应状态码401，则重定向到登录页面。</li>
</ol>
<p>在很多项目案例中，需要实现账户的功能，客户端所有的功能都基于用户已登陆的前提下才可以使用。<br>这就要求每次客户端像服务器请求数据时都要验证账户是否正确，<br>如果正确则按正常方式返回数据，如果错误则进行拦截并返回错误信息。<br>但是当客户端频繁向服务器请求数据的话，每次服务器都要频繁地查询数据库。<br>而Token正是为了减轻服务器的压力，减少频繁的查询数据库，使服务器更加健壮。并取代传统使用session的方法来进行验证。</p>
<p>相比于sesssion保存在服务器，JWT是不用保存的。<br>这样的话服务器不需要保存用户状态，从而可以很容易的做到水平扩展。</p>
<p>生成token的方法很多，其中一种比较成熟的解决方案是使用JSON Web Token。</p>
<h2 id="JWT概述"><a href="#JWT概述" class="headerlink" title="JWT概述"></a>JWT概述</h2><p>官网<a target="_blank" rel="noopener" href="https://jwt.io/">https://jwt.io/</a> 根据前2个部分和右小叫的key，计算第三部分的signature，和自己生成的对比<br>JSON Web Token JWT，它是一种开放标准（RFC 7519）。<br>它定义了一套简洁紧凑（compact）且 URL 安全（URL-safe）的方案，<br>以安全地在客户端和服务器网络应用环境之间传输 JSON 格式的信息。<br>JWT的声明一般被用来在身份提供者和服务提供者间传递被认证的用户身份信息，以便于从资源服务器获取资源，也可以增加一些额外的其它业务逻辑所必须的声明信息，该token也可直接被用于认证，也可被加密<br>随着RESTful架构前后端分离、分布式站点的单点登录（SSO）场景的项目使用JWT作为用户身份认证的方式。</p>
<p><img src="/2021/05/24/pyjwt/json-web-token.png"></p>
<ol>
<li><p>头部</p>
 <figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"alg"</span>: <span class="string">"HS256"</span>,</span><br><span class="line">  <span class="attr">"typ"</span>: <span class="string">"JWT"</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p> <code>alg</code>属性表示签名的hash算法，默认是HMAC SHA256（简写成<code>HS256</code>）<br> <code>typ</code>属性表示这个令牌的类型，为大写的<code>JWT</code>。<br> 该部分数据需要转换成json串并用base64编码</p>
</li>
<li><p>载荷<br>用来存放实际需要传递的数据。<br>格式为字典-此部分分为公有声明和私有声明</p>
</li>
</ol>
<p>公共声明：JWT提供了内置关键字用于描述常见的问题<br>用户根据自己需求按需添加key，<br>JWT官方文档中规定了7个可选的字段 常见公共声明如下<br>    - iss：Issuer签发人<br>    - exp：Expiration过期时间，按当地时间确定，所以设置时要使用utc时间。<br>    - sub：jwt所面向的用户<br>    - aud：Audience受众接收者，分为web端、Android、iOS端<br>    - nbf：生效时间，当前时间在nbf里的定义时间之前，则Token不被接受<br>    - iat：Issued At签发时间<br>    - jti：编号，唯一身份标识，主要用来作为一次性token,从而回避重放攻击。</p>
<p>我们可以根据业务需要添加自定义的字段，如下所示。<br>第一部分是一个Json对象，称为payload可以存储一些不敏感的有效的信息，<br>例如用户名，过期时间等等所有你想要传递的信息，<br>不建议添加密码等敏感信息，因为该部分在客户端可解密</p>
<p>在“用户鉴权”方法中，解析token完成后要利用这个username来查找并返回用户信息给用户。<br>这里的data声明是自定义需要传递的信息，</p>
<p>公共声明和私有声明均在同一个字典中<br>转成json串并用base64加密</p>
<pre><code>&lt;!--hexoPostRenderEscape:&lt;figure class="highlight json"&gt;&lt;table&gt;&lt;tr&gt;&lt;td class="gutter"&gt;&lt;pre&gt;&lt;span class="line"&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class="code"&gt;&lt;pre&gt;&lt;span class="line"&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;  &lt;span class="attr"&gt;&amp;quot;sub&amp;quot;&lt;/span&gt;: &lt;span class="string"&gt;&amp;quot;1234567890&amp;quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;  &lt;span class="attr"&gt;&amp;quot;nickname&amp;quot;&lt;/span&gt;: &lt;span class="string"&gt;&amp;quot;jackfrued&amp;quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;  &lt;span class="attr"&gt;&amp;quot;role&amp;quot;&lt;/span&gt;: &lt;span class="string"&gt;&amp;quot;admin&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;:hexoPostRenderEscape--&gt;
</code></pre>
<p>其中第一部分Header和第二部分Payload只是对原始输入的信息转成了base64编码，</p>
<ol start="3">
<li>签名<ul>
<li>保证Token在传输的过程中没有被篡改或者损坏<br>实现签名首先需要读取配置文件中的SECRET_KEY配置变量，<br>这个秘钥your-256-bit-secret主要用在下文Signature签名中，服务端用来校验Token合法性，<br>这个密钥只有服务器才知道，不能泄露给用户。</li>
</ul>
</li>
</ol>
<p>签名规则如下:<br>根据header头部的alg算法（默认是<code>HS256</code>） 以下用HS256为例，按照下面的公式产生签名。</p>
<pre><code>&lt;!--hexoPostRenderEscape:&lt;figure class="highlight python"&gt;&lt;table&gt;&lt;tr&gt;&lt;td class="gutter"&gt;&lt;pre&gt;&lt;span class="line"&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class="code"&gt;&lt;pre&gt;&lt;span class="line"&gt;HS256(base64Encode(header) + &lt;span class="string"&gt;&amp;#x27;.&amp;#x27;&lt;/span&gt; + base64Encode(payload), secret_key)&lt;/span&gt;&lt;br&gt;&lt;span class="line"&gt;HS256(自定义的key, base64后的 header + &lt;span class="string"&gt;&amp;quot;.&amp;quot;&lt;/span&gt; + base64后的payload)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;:hexoPostRenderEscape--&gt;
</code></pre>
<p>解释：用自定义的key,对base64后的 header+”+”.”+base64后的payload进行hmac计算</p>
<p>JWT生成的Token相当于是三个JSON对象经过编码后，<br>把头部、载荷、签名三个部分用两个点<code>.</code>拼接成一个字符串，如下图所示。</p>
<pre><code>&lt;!--hexoPostRenderEscape:&lt;figure class="highlight python"&gt;&lt;table&gt;&lt;tr&gt;&lt;td class="gutter"&gt;&lt;pre&gt;&lt;span class="line"&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class="code"&gt;&lt;pre&gt;&lt;span class="line"&gt;base64Encode(header) + &lt;span class="string"&gt;&amp;#x27;.&amp;#x27;&lt;/span&gt; + base64Encode(payload) + &lt;span class="string"&gt;&amp;#x27;.&amp;#x27;&lt;/span&gt; + base64Encode(sign)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;:hexoPostRenderEscape--&gt;
</code></pre>
<h4 id="JWT的优缺点"><a href="#JWT的优缺点" class="headerlink" title="JWT的优缺点"></a>JWT的优缺点</h4><p>使用JWT的优点非常明显，包括：</p>
<ol>
<li>更容易实现水平扩展，因为令牌保存在浏览器中，服务器不需要做状态管理。</li>
<li>更容易防范CSRF攻击，因为在请求头中添加<code>localStorage</code>或<code>sessionStorage</code>中的token必须靠JavaScript代码完成，而不是自动添加到请求头中的。</li>
<li>可以防伪造和篡改，因为JWT有签名，伪造和篡改的令牌无法通过签名验证，会被认定是无效的令牌。<br>体积小，因而传输速度快<br>传输方式多样，可以通过URL/POST参数/HTTP头部等方式传输<br>严格的结构化。它自身（在 payload 中）就包含了所有与用户相关的验证消息，如用户可访问路由、访问有效期等信息，服务器无需再去连接数据库验证信息的有效性，并且 payload 支持为你的应用而定制化。<br>支持跨域验证，可以应用于单点登录。<br>jwt 默认是不加密，但也是可以加密的。生成原始 Token 以后，可以用密钥再加密一次。<br>jwt在不加密的情况下，不能将涉密信息写入jwt</li>
</ol>
<p>当然，任何技术不可能只有优点没有缺点，JWT也有诸多缺点，大家需要在使用的时候引起注意，具体包括：</p>
<ol>
<li>可能会遭受到XSS攻击（跨站脚本攻击），通过注入恶意脚本执行JavaScript代码获取到用户令牌。</li>
<li>在令牌过期之前，无法作废已经颁发的令牌，要解决这个问题，还需要额外的中间层和代码来辅助。</li>
<li>JWT是用户的身份令牌，一旦泄露，任何人都可以获得该用户的所有权限。为了降低令牌被盗用后产生的风险，JWT的有效期应该设置得比较短。对于一些比较重要的权限，使用时应通过其他方式再次对用户进行认证，例如短信验证码等。</li>
</ol>
<p>与session共享机制的对比<br>代码侵入，在每个服务上必须有存取session鉴权判断的代码；<br>不安全，虽然redis等可以很方便的进行分布式部署，假若session服务器挂掉，系统便完全无法使用，不满足分布式系统中的高可用；<br>内存无法控制，若用户访问量激增极可能冲破内存，对内存要求高；<br>与之相反这些正是JWT的优势所在：</p>
<p>无代码侵入 ，只需要配置一个认证服务，其他服务可以无需关注权限，并可以提高到API网关进行权限拦截；<br>JWT不依赖session，对内存无要求，大量的访问也从容应对，不易产生硬件瓶颈；<br>可以在JWT中存储角色等信息，减少数据库查询或无需查询；</p>
<p>1、首先，前端通过Web表单将自己的用户名和密码发送到后端的接口。这一过程一般是一个HTTP POST请求。建议的方式是通过SSL加密的传输（https协议），从而避免敏感信息被嗅探。<br>2、后端校验用户名和密码成功后，把用户的相关信息(比如用户id)以及过期时间等其他信息作为JWT Payload（负载），将其与头部分别进行Base64编码拼接后签名，形成一个JWT。形成的JWT就是一个形同lll.zzz.xxx的字符串。<br>3、后端将JWT字符串作为登录成功的返回结果返回给客户端前端。客户端前端将返回的结果保存在localStorage或sessionStorage上，退出登录时前端删除保存的JWT即可。<br>4、前端以后在每次请求时将JWT放入HTTP Header中的Authorization位。(解决XSS和XSRF问题)<br>5、服务器在接收到需要登录的API请求候，检查是否存在，若存在对这个 token进行解密验证有效性。,然后获取过期时间和用户信息(比如用户id) ，检查签名是否正确；检查Token是否过期；检查Token的接收方是否是自己（可选）。<br>6、验证通过后后端使用JWT中包含的用户信息进行其他逻辑操作，返回相应结果。</p>
<p>JWT无法被破解的关键，是在其第三部分签名里的哈希加密中的Signature<br>由于哈希加密是无法直接解密的，所以jwt实际上只是重复使用加密的过程进行验证而已。</p>
<h3 id="使用PyJWT"><a href="#使用PyJWT" class="headerlink" title="使用PyJWT"></a>使用PyJWT</h3><p>用于编码和解码JSON Web令牌（JWT）</p>
<p>在Python代码中，可以使用三方库<code>PyJWT</code>生成和验证JWT，下面是安装<code>PyJWT</code>的命令。</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install pyjwt</span><br></pre></td></tr></tbody></table></figure>

<h4 id="利用PyJWT生成令牌Token"><a href="#利用PyJWT生成令牌Token" class="headerlink" title="利用PyJWT生成令牌Token"></a>利用PyJWT生成令牌Token</h4><p><code>jwt.encode(payload=payload, key=key, algorithms='HS256', headers=headers)</code></p>
<ul>
<li><code>payload</code>:具体内容自己添加，分为公有声明和私有声明，字典类型</li>
<li><code>key</code>:自定义的加密key，字符串str类型</li>
<li><code>algorithm</code>:使用的加密算法[HS256, RSA256] str字符串</li>
<li><code>headers</code>:，字典类型</li>
<li>返回值为token串 新版本返回类型：str字节,1.7版本是byte</li>
</ul>
<h4 id="解密并校验Token"><a href="#解密并校验Token" class="headerlink" title="解密并校验Token"></a>解密并校验Token</h4><ul>
<li><code>jwt.decode(jwt, key, algorithms='HS256')</code></li>
<li><code>jwt</code>: str,</li>
<li><code>key</code>: str = “”, 秘钥和生成token的秘钥一样</li>
<li><code>algorithms</code>: List[str] = None,</li>
<li>返回值payload明文 返回类型：dict</li>
</ul>
<p>dic 有官方指定的 key，程序在解密的时候会根据 key 的 Value 判断是否合法。这些 key 有：<br><code>issuer</code>: 发布者，若encode payload中添加 ‘iss’ 字段，则可针对该字段校验 参数类型：str，若iss校验失败，则抛出<code>jwt.exceptions.InvalidIssuerError: Invalid issuer</code><br><code>audience</code>：签发的受众群体，若encode payload中添加’aud’字段，则可针对该字段校验 参数类型：str<br>若aud校验失败，则抛出<code>jwt.exceptions.InvalidAudienceError: Invalid audience</code></p>
<ol>
<li>比对从token中取出的key对应的值，和各种请求中传来的值</li>
<li><code>exp</code>：在生成 token 时，可以设置该 token 的有效时间，检查到exp字段，且token过期，则抛出<code>jwt.ExpiredSignatureError</code><br>若encode得时候 payload中添加了exp字段;<br>则exp字段得值需为 当前时间戳+此token得有效期时间，<br>例如希望token 300秒后过期 {‘exp’: time.time() + 300};<br>在执行decode时，</li>
</ol>
<p><code>nbf</code>：它指的是该 token 的生效时间，如果使用但是没到生效时间则抛出：<br><code>jwt.exceptions.ImmatureSignatureError: The token is not yet valid (nbf)</code></p>
<p>iat：token 的开始时间，如果当前时间在开始时间之前则抛出<br><code>jwt.exceptions.InvalidIssuedAtError: Issued At claim (iat) cannot be in the future.</code></p>
<p><code>setting.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># SECURITY WARNING: keep the secret key used in production secret!</span></span><br><span class="line">SECRET_KEY = <span class="string">'django-insecure-ko!(dd)glepzzin%r%l--jbvg3=xm%v1fmx=uj1=6l#er06rgg'</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> jwt</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings</span><br><span class="line"></span><br><span class="line">headers = {  <span class="comment"># 默认内容</span></span><br><span class="line">    <span class="string">'typ'</span>: <span class="string">'jwt'</span>,</span><br><span class="line">    <span class="string">'alg'</span>: <span class="string">'HS256'</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">payload = {</span><br><span class="line">    <span class="comment"># 设置过期时间要设置 UTC 时间 因为内部检查使用的也是 UTC 时间</span></span><br><span class="line">    <span class="comment"># Expiration time will be compared to the current UTC time</span></span><br><span class="line">    <span class="comment"># (as given by timegm(datetime.utcnow().utctimetuple())),</span></span><br><span class="line">    <span class="comment"># so be sure to use a UTC timestamp or datetime in encoding</span></span><br><span class="line">    <span class="string">'exp'</span>:</span><br><span class="line">        datetime.datetime.utcnow() +</span><br><span class="line">        datetime.timedelta(days=<span class="number">1</span>, minutes=<span class="number">5</span>, seconds=<span class="number">10</span>),</span><br><span class="line">    <span class="string">'iat'</span>:</span><br><span class="line">        datetime.datetime.utcnow(),  <span class="comment"># 开始时间</span></span><br><span class="line">    <span class="string">'iss'</span>:</span><br><span class="line">        <span class="string">'Ashe'</span>,  <span class="comment"># 签名</span></span><br><span class="line">    <span class="string">'data'</span>: {  <span class="comment"># 自定义的数据，一般存放该用户id和开始时间</span></span><br><span class="line">        <span class="string">'userid'</span>: <span class="number">10001</span>,  <span class="comment"># 'id':user_id,</span></span><br><span class="line">        <span class="string">'username'</span>: <span class="string">'Jack'</span>,</span><br><span class="line">        <span class="comment"># 'login_time': login_time</span></span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment"># key = settings.SECRET_KEY  # 这个可以自定义密钥，为了方便直接使用Django的密钥</span></span><br><span class="line">key = <span class="string">'123'</span></span><br><span class="line"></span><br><span class="line">encoded_jwt = jwt.encode(payload=payload, key=key, algorithm=<span class="string">'HS256'</span>, headers=headers)</span><br><span class="line">print(encoded_jwt)  <span class="comment"># 查看生成的Token</span></span><br><span class="line"><span class="comment"># b'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VybmFtZSI6Ilx1OGZkMFx1N2VmNFx1NTQ5Nlx1NTU2MVx1NTQyNyIsInNpdGUiOiJodHRwczovL29wcy1jb2ZmZWUuY24ifQ.fIpSXy476r9F9i7GhdYFNkd-2Ndz8uKLgJPcd84BkJ4'</span></span><br><span class="line">print(type(encoded_jwt))  <span class="comment"># &lt;class 'str'&gt;</span></span><br><span class="line"></span><br><span class="line">verified_payload = jwt.decode(encoded_jwt, key=key, issuer=<span class="string">'Ashe'</span>, algorithms=[<span class="string">'HS256'</span>])</span><br><span class="line">print(verified_payload)</span><br><span class="line"><span class="comment"># {'exp': 1622044499, 'iat': 1621957789, 'iss': 'Ashe', 'data': {'userid': 10001, 'username': 'Jack'}}</span></span><br><span class="line">print(type(verified_payload))  <span class="comment"># &lt;class 'dict'&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="用base64对Header和Payload进行解码得到相应的信息"><a href="#用base64对Header和Payload进行解码得到相应的信息" class="headerlink" title="用base64对Header和Payload进行解码得到相应的信息"></a>用base64对Header和Payload进行解码得到相应的信息</h4><figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 部分源码</span></span><br><span class="line">signing_input, crypto_segment = jwt.rsplit(<span class="string">b"."</span>, <span class="number">1</span>)</span><br><span class="line">header_segment, payload_segment = signing_input.split(<span class="string">b"."</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        segments.append(base64url_encode(json_header))  <span class="comment"># 通过</span></span><br><span class="line">        segments.append(base64url_encode(payload))  <span class="comment">#</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Segments</span></span><br><span class="line">        signing_input = <span class="string">b"."</span>.join(segments)  <span class="comment"># 用点拼接</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            alg_obj = self._algorithms[algorithm]</span><br><span class="line">            key = alg_obj.prepare_key(key)</span><br><span class="line">            signature = alg_obj.sign(signing_input, key)</span><br><span class="line">        segments.append(base64url_encode(signature))</span><br></pre></td></tr></tbody></table></figure>

<p>将token分割成 <code>header_segment</code> 、<code>payload_segment</code> 、<code>crypto_segment</code> 三部分</p>
<ul>
<li>对第一部分 header_segment 进行 base64url 解密，得到 header</li>
<li>对第二部分 payload_segment 进行 base64url 解密，得到 payload</li>
<li>对第三部分 crypto_segment 进行 <code>base64url</code> 解密，得到 signature，针对 signature 部分数据进行合法性校验<ul>
<li>拼接前两段密文，即：<code>signing_input</code></li>
<li>从第一段明文中获取加密算法，默认：HS256</li>
<li>使用算法+盐 对 <code>signing_input</code> 进行加密，将得到的结果和 <code>signature</code> 密文进行比较</li>
</ul>
</li>
</ul>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> base64</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>base64.b64decode(<span class="string">'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9'</span>)</span><br><span class="line"><span class="string">b'{"typ":"JWT","alg":"HS256"}'</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>base64.b64decode(<span class="string">"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VybmFtZSI6ImFkbWluIiwic2l0ZSI6Imh0dHA6Ly9zdWliaWFuLnN0YXJtZW93LmNuIn0=="</span>)</span><br><span class="line"><span class="string">b'{"typ":"JWT","alg":"HS256"}{"username":"admin","site":"http://testdomain.starmeow.cn"}'</span></span><br></pre></td></tr></tbody></table></figure>
<p>加<code>==</code>：如果要base64编码的二进制数据不是3的倍数，最后会剩下1个或2个字节怎么办？此时，需在原数据后面添加1个或2个零值字节，使其字节数是3的倍数。<br>然后，在编码后的字符串后面添加1个或2个等号“=”，表示所添加的零值字节数。解码的时候，会自动去掉。<br>第二部分主要存放有效信息，由于这里用的是可逆的base64 编码，所以第二部分的数据实际上是明文的。应该避免在这里存放不能公开的隐私信息。</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>base64.b64decode(<span class="string">"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VybmFtZSI6ImFkbWluIiwic2l0ZSI6Imh0dHA6Ly9zdWliaWFuLnN0YXJtZW93LmNuIn0.5CzNoZ2aWyNYYnImrJvGJuLZlJbUeCVTg-_PFq_XF7o=="</span>)</span><br><span class="line"><span class="string">b'{"typ":"JWT","alg":"HS256"}{"username":"admin","site":"http://testdomain.starmeow.cn"}9\x0b3hgf\x96\xc8\xd6\x18\x9c\x89\xab&amp;\xf1\x89\xb8\xb6e%\xb5\x1e\tT\xe0&lt;Z\x97\x17\xba'</span></span><br></pre></td></tr></tbody></table></figure>
<p>三部分一起解码，可以看到最后一部分被加密了无法查看</p>
<p>校验jwt规则<br>​1，解析header, 确认alg<br>2，签名校验 - 根据传过来的header和payload按 alg指明的算法进行签名，将签名结果和传过来的sign进行对比，若对比一致，则校验通过<br>3，获取payload自定义内容，有exp,则校验过期时间</p>
<p>服务端在有秘钥的情况下可以直接对JWT生成的Token进行解密，解密成功说明Token正确，且数据没有被篡改</p>
<p>当然我们前文说了JWT并没有对数据进行加密，如果没有secret_key也可以直接获取到Payload里边的数据，只是缺少了签名算法无法验证数据是否准确，pyjwt也提供了直接获取Payload数据的方法</p>
<p>如果不清楚JWT具体的使用方式，可以先看看第55天的内容，里面提供了完整的投票项目代码的地址。</p>
<p>从<code>django.contrib.auth.get_user_model</code>去<code>setting</code>中找<code>AUTH_USER_MODEL</code>，源码</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_user_model</span>():</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Return the User model that is active in this project.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> django_apps.get_model(settings.AUTH_USER_MODEL, require_ready=<span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">except</span> ValueError:</span><br><span class="line">        <span class="keyword">raise</span> ImproperlyConfigured(<span class="string">"AUTH_USER_MODEL must be of the form 'app_label.model_name'"</span>)</span><br><span class="line">    <span class="keyword">except</span> LookupError:</span><br><span class="line">        <span class="keyword">raise</span> ImproperlyConfigured(</span><br><span class="line">            <span class="string">"AUTH_USER_MODEL refers to model '%s' that has not been installed"</span> % settings.AUTH_USER_MODEL</span><br><span class="line">        )</span><br></pre></td></tr></tbody></table></figure>

<hr>
<p>django 案例</p>
<p>在用户登录成功之后，生成token并返回，用户再次来访问时需携带token。<br>从token中取出用户名并从数据库中取出该用户对象</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_user_id</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="comment"># 取token</span></span><br><span class="line">    token = request.META.get(<span class="string">'HTTP_AUTHORIZATION'</span>)</span><br><span class="line">    <span class="comment"># 若没取出token，则用户未登录</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> token:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 若token不对，返回一个none</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        res = jwt.decode(token, TOKEN_KEY, algorithms=<span class="string">'HS256'</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 如果没报错，拿出username</span></span><br><span class="line">    username = res[<span class="string">'username'</span>]</span><br><span class="line">    <span class="comment"># 从数据库中取出用户对象</span></span><br><span class="line">    users = UserProfile.objects.filter(username=username)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> users:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    user = users[<span class="number">0</span>]</span><br></pre></td></tr></tbody></table></figure>

<hr>
<p>封装获取 token 函数</p>
<p><code>views.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> jwt</span><br><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings  <span class="comment"># 不要用相对导入的方式导入配置文件</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_token</span>(<span class="params">username, expire=<span class="number">3600</span> * <span class="number">24</span></span>):</span></span><br><span class="line">    <span class="string">"""生成 token，有效期一天"""</span></span><br><span class="line">    <span class="keyword">import</span> jwt</span><br><span class="line">    now = time.time()</span><br><span class="line">    key = settings.SECRET_KEY</span><br><span class="line">    payload = {<span class="string">'username'</span>: username, <span class="string">'exp'</span>: int(now + expire)}</span><br><span class="line">    <span class="keyword">return</span> jwt.encode(payload, key, algorithm=<span class="string">'HS256'</span>)</span><br></pre></td></tr></tbody></table></figure>

<p>封装校验 token 函数</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> jwt</span><br><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings</span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> JsonResponse</span><br><span class="line"><span class="keyword">from</span> user.models <span class="keyword">import</span> User</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># token 验证装饰器</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login_check</span>(<span class="params">func</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span>(<span class="params">request, *args, **kwargs</span>):</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 取token</span></span><br><span class="line">        token = request.META.get(<span class="string">'HTTP_AUTHORIZATION'</span>)</span><br><span class="line">        <span class="comment"># 没有 token，则用户未登录</span></span><br><span class="line">        <span class="keyword">if</span> token <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            result = {<span class="string">'code'</span>: <span class="number">403</span>, <span class="string">'error'</span>: <span class="string">u'用户未登录 - 没有权限！'</span>}</span><br><span class="line">            <span class="keyword">return</span> JsonResponse(result)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            res = jwt.decode(token,</span><br><span class="line">                             settings.LIZI_TOKEN_KEY,</span><br><span class="line">                             algorithms=<span class="string">'HS256'</span>)</span><br><span class="line">        <span class="comment"># 若token不对，</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            print(<span class="string">'jwt error {}'</span>.format(e))</span><br><span class="line">            result = {<span class="string">'code'</span>: <span class="number">403</span>, <span class="string">'msg'</span>: <span class="string">u'用户未登录!'</span>}</span><br><span class="line">            <span class="keyword">return</span> JsonResponse(result)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 如果没报错，拿出username</span></span><br><span class="line">        username = res[<span class="string">'username'</span>]</span><br><span class="line">        user = User.objects.get(username=username)</span><br><span class="line">        <span class="comment"># user 挂载 request 上，以便后面方法可以直接取出用户</span></span><br><span class="line">        request.myuser = user</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> func(request, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br></pre></td></tr></tbody></table></figure>

<hr>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_token</span>(<span class="params">username, password</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">  生成jwt</span></span><br><span class="line"><span class="string">  :param payload: dict 载荷</span></span><br><span class="line"><span class="string">  :param expiry: datetime 有效期</span></span><br><span class="line"><span class="string">  :param JWT_KEY: 密钥</span></span><br><span class="line"><span class="string">  :return: jwt</span></span><br><span class="line"><span class="string">   """</span></span><br><span class="line">    payload = {</span><br><span class="line">        <span class="string">"iat"</span>: int(time.time()),</span><br><span class="line">        <span class="string">"exp"</span>: int(time.time()) + <span class="number">3600</span> * <span class="number">12</span>,</span><br><span class="line">        <span class="string">"password"</span>: password,</span><br><span class="line">        <span class="string">"username"</span>: username,</span><br><span class="line">    }</span><br><span class="line">    token = jwt.encode(payload, JWT_KEY, algorithm=<span class="string">'HS256'</span>)</span><br><span class="line">    <span class="keyword">return</span> token.decode()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">verify</span>(<span class="params">token, db</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">  :param token: jwt</span></span><br><span class="line"><span class="string">  :param JWT_KEY: 密钥</span></span><br><span class="line"><span class="string">  :return: dict: payload</span></span><br><span class="line"><span class="string">  """</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        payload = jwt.decode(token, JWT_KEY, algorithm=[<span class="string">'HS256'</span>])</span><br><span class="line">        user = db.query(User).filter(</span><br><span class="line">            User.account == payload[<span class="string">'username'</span>]).first()</span><br><span class="line">        <span class="keyword">if</span> user == <span class="literal">None</span>:</span><br><span class="line">            msg = <span class="string">'用户不存在'</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span>, msg</span><br><span class="line">        <span class="keyword">if</span> user.status == <span class="number">1</span>:</span><br><span class="line">            msg = <span class="string">'用户被禁用'</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span>, msg</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span>, user</span><br><span class="line">    <span class="keyword">except</span> jwt.PyJWTError:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span>, <span class="string">'Token异常！'</span></span><br></pre></td></tr></tbody></table></figure>

<hr>
<p>此示例在django的中间件中对token进行校验，内部编写了两个中间件来支持用户通过两种方式传递token。</p>
<p>Postman-Header-Authorization请求头</p>
<p>Django要兼容session认证的方式，还需要同时支持JWT，并且两种验证需要共用同一套权限系统，该如何处理呢？我们可以参考Django的解决方案：<br>装饰器，例如用来检查用户是否登录的login_required和用来检查用户是否有权限的permission_required两个装饰器，<br>我们可以自己实现一个装饰器，检查用户的认证模式，同时认证完成后验证用户是否有权限操作</p>
<p>于是一个auth_permission_required的装饰器产生了：</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings</span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> JsonResponse</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth <span class="keyword">import</span> get_user_model</span><br><span class="line"><span class="keyword">from</span> django.core.exceptions <span class="keyword">import</span> PermissionDenied</span><br><span class="line"></span><br><span class="line">UserModel = get_user_model()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">auth_permission_required</span>(<span class="params">perm</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">decorator</span>(<span class="params">view_func</span>):</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">_wrapped_view</span>(<span class="params">request, *args, **kwargs</span>):</span></span><br><span class="line">            <span class="comment"># 格式化权限</span></span><br><span class="line">            perms = (perm, ) <span class="keyword">if</span> isinstance(perm, str) <span class="keyword">else</span> perm</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> request.user.is_authenticated:</span><br><span class="line">                <span class="comment"># 正常登录用户判断是否有权限</span></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> request.user.has_perms(perms):</span><br><span class="line">                    <span class="keyword">raise</span> PermissionDenied</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    auth = request.META.get(<span class="string">'HTTP_AUTHORIZATION'</span>).split()</span><br><span class="line">                <span class="keyword">except</span> AttributeError:</span><br><span class="line">                    <span class="keyword">return</span> JsonResponse({</span><br><span class="line">                        <span class="string">"code"</span>: <span class="number">401</span>,</span><br><span class="line">                        <span class="string">"message"</span>: <span class="string">"No authenticate header"</span></span><br><span class="line">                    })</span><br><span class="line"></span><br><span class="line">                <span class="comment"># 用户通过API获取数据验证流程</span></span><br><span class="line">                <span class="keyword">if</span> auth[<span class="number">0</span>].lower() == <span class="string">'token'</span>:</span><br><span class="line">                    <span class="keyword">try</span>:</span><br><span class="line">                        dict = jwt.decode(auth[<span class="number">1</span>],</span><br><span class="line">                                          settings.SECRET_KEY,</span><br><span class="line">                                          algorithms=[<span class="string">'HS256'</span>])</span><br><span class="line">                        username = dict.get(<span class="string">'data'</span>).get(<span class="string">'username'</span>)</span><br><span class="line">                    <span class="keyword">except</span> jwt.ExpiredSignatureError:</span><br><span class="line">                        <span class="keyword">return</span> JsonResponse({</span><br><span class="line">                            <span class="string">"status_code"</span>: <span class="number">401</span>,</span><br><span class="line">                            <span class="string">"message"</span>: <span class="string">"Token expired"</span></span><br><span class="line">                        })</span><br><span class="line">                    <span class="keyword">except</span> jwt.InvalidTokenError:</span><br><span class="line">                        <span class="keyword">return</span> JsonResponse({</span><br><span class="line">                            <span class="string">"status_code"</span>: <span class="number">401</span>,</span><br><span class="line">                            <span class="string">"message"</span>: <span class="string">"Invalid token"</span></span><br><span class="line">                        })</span><br><span class="line">                    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                        <span class="keyword">return</span> JsonResponse({</span><br><span class="line">                            <span class="string">"status_code"</span>:</span><br><span class="line">                            <span class="number">401</span>,</span><br><span class="line">                            <span class="string">"message"</span>:</span><br><span class="line">                            <span class="string">"Can not get user object"</span></span><br><span class="line">                        })</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">try</span>:</span><br><span class="line">                        user = UserModel.objects.get(username=username)</span><br><span class="line">                    <span class="keyword">except</span> UserModel.DoesNotExist:</span><br><span class="line">                        <span class="keyword">return</span> JsonResponse({</span><br><span class="line">                            <span class="string">"status_code"</span>: <span class="number">401</span>,</span><br><span class="line">                            <span class="string">"message"</span>: <span class="string">"User Does not exist"</span></span><br><span class="line">                        })</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">not</span> user.is_active:</span><br><span class="line">                        <span class="keyword">return</span> JsonResponse({</span><br><span class="line">                            <span class="string">"status_code"</span>:</span><br><span class="line">                            <span class="number">401</span>,</span><br><span class="line">                            <span class="string">"message"</span>:</span><br><span class="line">                            <span class="string">"User inactive or deleted"</span></span><br><span class="line">                        })</span><br><span class="line"></span><br><span class="line">                    <span class="comment"># Token登录的用户判断是否有权限</span></span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">not</span> user.has_perms(perms):</span><br><span class="line">                        <span class="keyword">return</span> JsonResponse({</span><br><span class="line">                            <span class="string">"status_code"</span>: <span class="number">403</span>,</span><br><span class="line">                            <span class="string">"message"</span>: <span class="string">"PermissionDenied"</span></span><br><span class="line">                        })</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">return</span> JsonResponse({</span><br><span class="line">                        <span class="string">"status_code"</span>: <span class="number">401</span>,</span><br><span class="line">                        <span class="string">"message"</span>: <span class="string">"Not support auth type"</span></span><br><span class="line">                    })</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> view_func(request, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> _wrapped_view</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> decorator</span><br></pre></td></tr></tbody></table></figure>

<p>在view使用时就可以用这个装饰器来代替原本的login_required和permission_required装饰器了</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@auth_permission_required('account.select_user')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">user</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'GET'</span>:</span><br><span class="line">        _jsondata = {<span class="string">"user"</span>: <span class="string">"ops-coffee"</span>, <span class="string">"site"</span>: <span class="string">"https://ops-coffee.cn"</span>}</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> JsonResponse({<span class="string">"state"</span>: <span class="number">1</span>, <span class="string">"message"</span>: _jsondata})</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> JsonResponse({</span><br><span class="line">            <span class="string">"state"</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="string">"message"</span>: <span class="string">"Request method 'POST' not supported"</span></span><br><span class="line">        })</span><br></pre></td></tr></tbody></table></figure>

<p>需要一个生成用户Token的方法，通过给User model添加一个token的静态方法来处理</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>(<span class="params">AbstractBaseUser, PermissionsMixin</span>):</span></span><br><span class="line">    create_time = models.DateTimeField(auto_now_add=<span class="literal">True</span>, verbose_name=<span class="string">'创建时间'</span>)</span><br><span class="line">    update_time = models.DateTimeField(auto_now=<span class="literal">True</span>, verbose_name=<span class="string">'更新时间'</span>)</span><br><span class="line">    username = models.EmailField(max_length=<span class="number">255</span>,</span><br><span class="line">                                 unique=<span class="literal">True</span>,</span><br><span class="line">                                 verbose_name=<span class="string">'用户名'</span>)</span><br><span class="line">    fullname = models.CharField(max_length=<span class="number">64</span>, null=<span class="literal">True</span>, verbose_name=<span class="string">'中文名'</span>)</span><br><span class="line">    phonenumber = models.CharField(max_length=<span class="number">16</span>,</span><br><span class="line">                                   null=<span class="literal">True</span>,</span><br><span class="line">                                   unique=<span class="literal">True</span>,</span><br><span class="line">                                   verbose_name=<span class="string">'电话'</span>)</span><br><span class="line">    is_active = models.BooleanField(default=<span class="literal">True</span>, verbose_name=<span class="string">'激活状态'</span>)</span><br><span class="line"></span><br><span class="line">    objects = UserManager()</span><br><span class="line"></span><br><span class="line">    USERNAME_FIELD = <span class="string">'username'</span></span><br><span class="line">    REQUIRED_FIELDS = []</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.username</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">token</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self._generate_jwt_token()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_generate_jwt_token</span>(<span class="params">self</span>):</span></span><br><span class="line">        token = jwt.encode(</span><br><span class="line">            {</span><br><span class="line">                <span class="string">'exp'</span>: datetime.utcnow() + timedelta(days=<span class="number">1</span>),</span><br><span class="line">                <span class="string">'iat'</span>: datetime.utcnow(),</span><br><span class="line">                <span class="string">'data'</span>: {</span><br><span class="line">                    <span class="string">'username'</span>: self.username</span><br><span class="line">                }</span><br><span class="line">            },</span><br><span class="line">            settings.SECRET_KEY,</span><br><span class="line">            algorithm=<span class="string">'HS256'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> token.decode(<span class="string">'utf-8'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        default_permissions = ()</span><br><span class="line"></span><br><span class="line">        permissions = (</span><br><span class="line">            (<span class="string">"select_user"</span>, <span class="string">"查看用户"</span>),</span><br><span class="line">            (<span class="string">"change_user"</span>, <span class="string">"修改用户"</span>),</span><br><span class="line">            (<span class="string">"delete_user"</span>, <span class="string">"删除用户"</span>),</span><br><span class="line">        )</span><br></pre></td></tr></tbody></table></figure>

<p>直接通过用户对象来生成Token：</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> accounts.models <span class="keyword">import</span> User</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>u = User.objects.get(username=<span class="string">'admin@ops-coffee.cn'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>u.token</span><br><span class="line"><span class="string">'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJleHAiOjE1NDgyMjg3NzksImlhdCI6MTU0ODE0MjM3OSwiZGF0YSI6eyJ1c2VybmFtZSI6ImFkbWluQDE2My5jb20ifX0.akZNU7t_z2kwPxDJjmc-QxtNdICK0yhnwWmKxqqXKLw'</span></span><br></pre></td></tr></tbody></table></figure>

<p>生成的Token给到客户端，客户端就可以拿这个Token进行鉴权了</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> requests</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>token = <span class="string">'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJleHAiOjE1NDgyMjg4MzgsImlhdCI6MTU0ODE0MjQzOCwiZGF0YSI6eyJ1c2VybmFtZSI6ImFkbWluQDE2My5jb20ifX0.oKc0SafgksMT9ZIhTACupUlz49Q5kI4oJA-B8-GHqLA'</span></span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>r = requests.get(<span class="string">'http://localhost/api/user'</span>, headers={<span class="string">'Authorization'</span>: <span class="string">'Token '</span>+token})</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>r.json()</span><br><span class="line">{<span class="string">'username'</span>: <span class="string">'admin@ops-coffee.cn'</span>, <span class="string">'fullname'</span>: <span class="string">'运维咖啡吧'</span>, <span class="string">'is_active'</span>: <span class="literal">True</span>}</span><br></pre></td></tr></tbody></table></figure>

<p>这样一个auth_permission_required方法就可以搞定上边的全部需求</p>
<hr>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> datetime, jwt, time</span><br><span class="line"><span class="keyword">from</span> app.dao.userDao <span class="keyword">import</span> UserDao</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> jsonify</span><br><span class="line"><span class="keyword">from</span> .. <span class="keyword">import</span> common</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Auth</span>():</span></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">encode_auth_token</span>(<span class="params">user_id, login_time</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        生成认证Token</span></span><br><span class="line"><span class="string">        :param user_id: int</span></span><br><span class="line"><span class="string">        :param login_time: int(timestamp)</span></span><br><span class="line"><span class="string">        :return: string</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            payload = {</span><br><span class="line">                <span class="string">'exp'</span>: datetime.datetime.utcnow() + datetime.timedelta(days=<span class="number">0</span>, seconds=<span class="number">10</span>),</span><br><span class="line">                <span class="string">'iat'</span>: datetime.datetime.utcnow(),</span><br><span class="line">                <span class="string">'iss'</span>: <span class="string">'ken'</span>,</span><br><span class="line">                <span class="string">'data'</span>: {</span><br><span class="line">                    <span class="string">'id'</span>:user_id,</span><br><span class="line">                    <span class="string">'login_time'</span>: login_time</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">return</span> jwt.encode(</span><br><span class="line">                payload,</span><br><span class="line">                <span class="string">'secret'</span>,</span><br><span class="line">                algorithm=<span class="string">'HS256'</span></span><br><span class="line">            )</span><br><span class="line">        <span class="keyword">except</span> Exception  <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> e</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">decode_auth_token</span>(<span class="params">auth_token</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        验证Token</span></span><br><span class="line"><span class="string">        :param auth_token:</span></span><br><span class="line"><span class="string">        :return: integer|string</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            payload = jwt.decode(auth_token, <span class="string">'secret'</span>, options= {<span class="string">'verify_exp'</span>:<span class="literal">False</span>})</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">'data'</span> <span class="keyword">in</span> payload <span class="keyword">and</span> <span class="string">'id'</span> <span class="keyword">in</span> payload[<span class="string">'data'</span>]):</span><br><span class="line">                <span class="keyword">return</span> payload</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">raise</span> jwt.InvalidTokenError</span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> jwt.ExpiredSignatureError:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"Token过期"</span></span><br><span class="line">        <span class="keyword">except</span> jwt.InvalidTokenError:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"无效的Token"</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">authenticate</span>(<span class="params">self, username, password</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        用户登录，登录成功返回token，写将登录时间写入数据库；登录失败返回失败原因</span></span><br><span class="line"><span class="string">        根据用户名/密码，到DB中进行校验，如果是合法的用户名/密码，调用encode_auth_token生成token返回；username加入到token的payload中。</span></span><br><span class="line"><span class="string">        :param password:</span></span><br><span class="line"><span class="string">        :return: json</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        userDao = UserDao()</span><br><span class="line">        user = userDao.search(username)</span><br><span class="line">        <span class="keyword">if</span> (user <span class="keyword">is</span> <span class="literal">None</span>):</span><br><span class="line">            <span class="keyword">return</span> jsonify(common.falseReturn(<span class="string">''</span>, <span class="string">'找不到用户'</span>))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> (user.password == password):</span><br><span class="line">                login_time = int(time.time())</span><br><span class="line">                token = self.encode_auth_token(user.username, login_time)</span><br><span class="line">                <span class="keyword">return</span> jsonify(common.trueReturn(token.decode(), <span class="string">'登陆成功'</span>))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> jsonify(common.falseReturn(<span class="string">''</span>, <span class="string">'密码不正确'</span>))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">identify</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        用户鉴权，用户的请求需要携带token信息，这个函数对request进行校验，调用decode_auth_token完成的校验。</span></span><br><span class="line"><span class="string">        :return: list</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        auth_header = request.headers.get(<span class="string">'Authorization'</span>)</span><br><span class="line">        <span class="keyword">if</span> (auth_header):</span><br><span class="line">            auth_tokenArr = auth_header.split(<span class="string">" "</span>)</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">not</span> auth_tokenArr <span class="keyword">or</span> auth_tokenArr[<span class="number">0</span>]!= <span class="string">'jwt'</span> <span class="keyword">or</span> len(auth_tokenArr) != <span class="number">2</span> ):</span><br><span class="line">                result = common.falseReturn(<span class="string">''</span>,<span class="string">'请传递正确的验证头信息'</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                auth_token = auth_tokenArr[<span class="number">1</span>]</span><br><span class="line">                payload = self.decode_auth_token(auth_token)</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> isinstance(payload, str):</span><br><span class="line">                    userDao = UserDao()</span><br><span class="line">                    user = userDao.search(payload[<span class="string">'data'</span>][<span class="string">'id'</span>])</span><br><span class="line">                    <span class="keyword">if</span> (user <span class="keyword">is</span> <span class="literal">None</span>):</span><br><span class="line">                        result = common.falseReturn(<span class="string">''</span>, <span class="string">'找不到该用户信息'</span>)</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        result = common.trueReturn(<span class="string">''</span>, <span class="string">'请求成功'</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    result = common.falseReturn(<span class="string">''</span>, payload)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            result = common.falseReturn(<span class="string">''</span>,<span class="string">'没有提供认证token'</span>)</span><br><span class="line">        <span class="keyword">return</span> result</span><br></pre></td></tr></tbody></table></figure>

<p>拦截所有的请求，都进行token校验</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.before_request</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">before_request</span>():</span></span><br><span class="line">    Auth.identify(Auth,request )</span><br></pre></td></tr></tbody></table></figure>

<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/05/22/zhuang-shi-qi-yu-zhi-shu/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/22/zhuang-shi-qi-yu-zhi-shu/" class="post-title-link" itemprop="url">python装饰器与质数</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2021-05-21 16:21:41 / 修改时间：16:04:42" itemprop="dateCreated datePublished" datetime="2021-05-21T16:21:41Z">2021-05-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 结构混乱</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_prime</span>(<span class="params">num</span>):</span></span><br><span class="line">    <span class="keyword">if</span> num &lt; <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">elif</span> num == <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>, num):</span><br><span class="line">            <span class="keyword">if</span> num % i == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">prime_nums</span>():</span></span><br><span class="line">    t1 = time.time()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>, <span class="number">10</span>):</span><br><span class="line">        <span class="keyword">if</span> is_prime(i):</span><br><span class="line">            print(i)</span><br><span class="line">    t2 = time.time()</span><br><span class="line">    print(t2 - t1)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">prime_nums()</span><br><span class="line"><span class="comment"># 2</span></span><br><span class="line"><span class="comment"># 3</span></span><br><span class="line"><span class="comment"># 5</span></span><br><span class="line"><span class="comment"># 7</span></span><br><span class="line"><span class="comment"># 0.0</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">display_time</span>(<span class="params">func</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span>():</span></span><br><span class="line">        t1 = time.time()</span><br><span class="line">        func()</span><br><span class="line">        t2 = time.time()</span><br><span class="line">        print(t2 - t1)</span><br><span class="line">        print(<span class="string">'%s executed in %.4f s'</span> % (func.__name__, float(t2 - t1)))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_Prime</span>(<span class="params">num</span>):</span></span><br><span class="line">    <span class="keyword">if</span> num &lt; <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">elif</span> num == <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>, num):</span><br><span class="line">            <span class="keyword">if</span> num % i == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@display_time  # find_Prime=display_time(find_Prime)</span></span><br><span class="line"><span class="comment"># 相当于偷梁换柱了，我们后面再调用的时候实际上调用的是display_time</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_Prime</span>():</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>, <span class="number">10</span>):</span><br><span class="line">        <span class="keyword">if</span> is_Prime(i):</span><br><span class="line">            print(i)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">find_Prime()</span><br><span class="line"><span class="comment"># 2</span></span><br><span class="line"><span class="comment"># 3</span></span><br><span class="line"><span class="comment"># 5</span></span><br><span class="line"><span class="comment"># 7</span></span><br><span class="line"><span class="comment"># 0.0009953975677490234</span></span><br><span class="line"><span class="comment"># find_Prime executed in 0.0010 s</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/local/bin/python3</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">display_time</span>(<span class="params">func</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span>():</span></span><br><span class="line">        t1 = time.time()</span><br><span class="line">        result = func()</span><br><span class="line">        t2 = time.time()</span><br><span class="line">        print(<span class="string">'Total time: {:.4f} s'</span>.format(t2 - t1))</span><br><span class="line">        print(<span class="string">'%s executed in %.4f s'</span> % (func.__name__, float(t2 - t1)))</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_Prime</span>(<span class="params">num</span>):</span></span><br><span class="line">    <span class="keyword">if</span> num &lt; <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">elif</span> num == <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>, num):</span><br><span class="line">            <span class="keyword">if</span> num % i == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@display_time  # find_Prime = display_time(find_Prime)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_Prime</span>():</span></span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>, <span class="number">10</span>):</span><br><span class="line">        <span class="keyword">if</span> is_Prime(i):</span><br><span class="line">            count += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> count</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">count = find_Prime()</span><br><span class="line">print(count)</span><br><span class="line"><span class="comment"># Total time: 0.0000 s</span></span><br><span class="line"><span class="comment"># find_Prime executed in 0.0000 s</span></span><br><span class="line"><span class="comment"># 4</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/local/bin/python3</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">display_time</span>(<span class="params">func</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span>(<span class="params">*args</span>):</span></span><br><span class="line">        t1 = time.time()</span><br><span class="line">        result = func(*args)</span><br><span class="line">        t2 = time.time()</span><br><span class="line">        print(<span class="string">'Total time: {:.4f} s'</span>.format(t2 - t1))</span><br><span class="line">        print(<span class="string">'%s executed in %.4f s'</span> % (func.__name__, float(t2 - t1)))</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_Prime</span>(<span class="params">num</span>):</span></span><br><span class="line">    <span class="keyword">if</span> num &lt; <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">elif</span> num == <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>, num):</span><br><span class="line">            <span class="keyword">if</span> num % i == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@display_time  # find_Prime = display_time(find_Prime)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_Prime</span>(<span class="params">maxnum</span>):</span></span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>, maxnum):</span><br><span class="line">        <span class="keyword">if</span> is_Prime(i):</span><br><span class="line">            count += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> count</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">count = find_Prime(<span class="number">100</span>)</span><br><span class="line">print(count)</span><br><span class="line"><span class="comment"># Total time: 0.0010 s</span></span><br><span class="line"><span class="comment"># find_Prime executed in 0.0010 s</span></span><br><span class="line"><span class="comment"># 25</span></span><br></pre></td></tr></tbody></table></figure>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/05/22/shang-pin-lei-bie-shu-ju-jie-kou/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/22/shang-pin-lei-bie-shu-ju-jie-kou/" class="post-title-link" itemprop="url">商品类别数据接口</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-05-21 16:21:41" itemprop="dateCreated datePublished" datetime="2021-05-21T16:21:41Z">2021-05-21</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-06-05 02:18:27" itemprop="dateModified" datetime="2021-06-05T02:18:27Z">2021-06-05</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/django/" itemprop="url" rel="index"><span itemprop="name">django</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="商品分类有两个接口"><a href="#商品分类有两个接口" class="headerlink" title="商品分类有两个接口"></a>商品分类有两个接口</h3><ul>
<li><p>全部分类：一级二级三级<br><img src="/2021/05/22/shang-pin-lei-bie-shu-ju-jie-kou/0.png" alt="description"></p>
</li>
<li><p>某一类的分类导航栏以及商品详细信息：<br><img src="/2021/05/22/shang-pin-lei-bie-shu-ju-jie-kou/1.png" alt="description"></p>
</li>
</ul>
<p>在搜索结果页只展示一级和二级分类</p>
<h2 id="写商品分类的接口"><a href="#写商品分类的接口" class="headerlink" title="写商品分类的接口"></a>写商品分类的接口</h2><p><code>goods/serializers.py</code> 给分类添加三级分类的serializer<br>定义模型<code>GoodsCategory</code>的字段<code>parent_category</code>时指定的<code>related_name='sub_cat'</code>，此属性表示可以反向查询引用，即通过父类别可以通过该属性查询子类别，利用该属性实现Serializer的三层嵌套引用，从而实现类别的嵌套显示，</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> GoodsCategory</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ThirdCategorySerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="string">'''三级商品子类别序列化'''</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = GoodsCategory</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SecondCategorySerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="string">'''二级商品子类别序列化'''</span></span><br><span class="line">    <span class="comment"># model中parent_category字段中定义的related_name="sub_cat"</span></span><br><span class="line">    sub_cat = ThirdCategorySerializer(many=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = GoodsCategory</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CategorySerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="string">'''一级商品类别序列化'''</span></span><br><span class="line">    <span class="comment"># model中parent_category字段中定义的related_name="sub_cat"</span></span><br><span class="line">    sub_cat = SecondCategorySerializer(many=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = GoodsCategory</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br></pre></td></tr></tbody></table></figure>

<p><code>goods/views.py</code></p>
<p>只要使CategoryViewSet继承 <code>mixins.RetrieveModelMixin</code>在浏览器路由后面增加入商品类别对应的id就现获取某一个一级分类具体的详情（包括其基本信息和子类别），但是二级找不到？</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CategoryViewSet</span>(<span class="params">mixins.ListModelMixin, mixins.RetrieveModelMixin, viewsets.GenericViewSet</span>):</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    list:</span></span><br><span class="line"><span class="string">        列出所有商品分类</span></span><br><span class="line"><span class="string">    retrieve:</span></span><br><span class="line"><span class="string">        根据id获取单个商品分类详情</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line"></span><br><span class="line">    queryset = GoodsCategory.objects.filter(category_type=<span class="number">1</span>).filter(is_delete=<span class="literal">False</span>)</span><br><span class="line">    serializer_class = CategorySerializer</span><br></pre></td></tr></tbody></table></figure>

<p><code>mxshop/url.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path, include</span><br><span class="line"><span class="keyword">from</span> rest_framework.routers <span class="keyword">import</span> DefaultRouter</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> goods.views <span class="keyword">import</span> CategoryViewSet</span><br><span class="line"></span><br><span class="line">router = DefaultRouter()</span><br><span class="line"><span class="comment"># 视图集注册到路由实例</span></span><br><span class="line">router.register(<span class="string">'categories'</span>, CategoryViewSet)</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">''</span>, include(router.urls)),</span><br><span class="line">]</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/05/22/shang-pin-lei-bie-shu-ju-jie-kou/2.png" alt="description"><br><img src="/2021/05/22/shang-pin-lei-bie-shu-ju-jie-kou/3.png" alt="description"></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/05/08/drf-de-api-jie-kou-wen-dang/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/08/drf-de-api-jie-kou-wen-dang/" class="post-title-link" itemprop="url">DRF的API接口文档</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-05-07 16:21:41" itemprop="dateCreated datePublished" datetime="2021-05-07T16:21:41Z">2021-05-07</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-06-07 04:39:36" itemprop="dateModified" datetime="2021-06-07T04:39:36Z">2021-06-07</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/django/" itemprop="url" rel="index"><span itemprop="name">django</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="Schemas"><a href="#Schemas" class="headerlink" title="Schemas"></a>Schemas</h3><p>它允许一系列用例，包括生成参考文档，或者驱动可以与 API 交互的动态客户端库。<br>一个 schema 就是一个机器可读的文档，它对可用的 API 端点进行描述，给出它们的 URL，以及支持的操作。</p>
<p>服务端可以生成 schema 文档，而客户端可以基于该 schema 文档，与服务端交互。</p>
<h3 id="Core-API"><a href="#Core-API" class="headerlink" title="Core API"></a>Core API</h3><p><a target="_blank" rel="noopener" href="https://www.django-rest-framework.org/coreapi/7-schemas-and-client-libraries/#core-api">https://www.django-rest-framework.org/coreapi/7-schemas-and-client-libraries/#core-api</a></p>
<p>REST 框架通过 Core API 提供 schema 支持。</p>
<p>Core API 是一种用于描述 API 的文档标准。在服务端，通过 Core API 可以将 API 呈现成各种支持的 schema 或超媒体格式文件。而在客户端，在获取服务端生成的 schema 文件后，可以与服务端进行交互。</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install coreapi</span><br></pre></td></tr></tbody></table></figure>

<h4 id="生成API接口文档"><a href="#生成API接口文档" class="headerlink" title="生成API接口文档"></a>生成API接口文档</h4><p><a target="_blank" rel="noopener" href="https://www.django-rest-framework.org/topics/documenting-your-api/">https://www.django-rest-framework.org/topics/documenting-your-api/</a><br>ViewSet的格式，更多请看官方文档</p>
<p>drf文档的优点：</p>
<ul>
<li>自动生成的接口文档是继承自APIView及其子类的视图。</li>
<li>一目了然看到各个模块的所有接口</li>
<li>文档里可以做交互和测试</li>
<li>生成Shell、JavaScript和Python等多种测试代码方式。</li>
<li>权限验证，对于需要验证后才能访问的接口，必须先进行验证，然后才能进行测试，</li>
</ul>
<p>设置<code>DEFAULT_SCHEMA_CLASS</code>和<code>docs</code>路由，访问文档页面。</p>
<p><code>setting.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># DRF 全局配置</span></span><br><span class="line">REST_FRAMEWORK = {</span><br><span class="line">    <span class="string">"DEFAULT_SCHEMA_CLASS"</span>: <span class="string">'rest_framework.schemas.openapi.AutoSchema'</span>,  <span class="comment"># 新版drf schema_class默认用的是</span></span><br><span class="line">    <span class="comment"># 如果报错AttributeError: ‘AutoSchema’ object has no attribute ‘get_link’</span></span><br><span class="line">    <span class="string">'DEFAULT_SCHEMA_CLASS'</span>: <span class="string">'rest_framework.schemas.AutoSchema'</span>,</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><code>drf_tutorial\urls.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.documentation <span class="keyword">import</span> include_docs_urls</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">"docs/"</span>, include_docs_urls(title=<span class="string">"DRF API文档"</span>, description=<span class="string">"Django REST framework快速入门"</span>)),</span><br><span class="line">]</span><br></pre></td></tr></tbody></table></figure>

<h3 id="文档描述说明的定义位置"><a href="#文档描述说明的定义位置" class="headerlink" title="文档描述说明的定义位置"></a>文档描述说明的定义位置</h3><p>对于每种类型的请求，都以固定的格式定义了说明；</p>
<p>1） 单一方法的视图，可直接使用类视图的文档字符串，如</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookListView</span>(<span class="params">generics.ListAPIView</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    返回所有图书信息.</span></span><br><span class="line"><span class="string">    """</span></span><br></pre></td></tr></tbody></table></figure>
<p>2）包含多个方法的视图，在类视图的文档字符串中，分开方法定义，如</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookListCreateView</span>(<span class="params">generics.ListCreateAPIView</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    get:</span></span><br><span class="line"><span class="string">    返回所有图书信息.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    post:</span></span><br><span class="line"><span class="string">    新建图书.</span></span><br><span class="line"><span class="string">    """</span></span><br></pre></td></tr></tbody></table></figure>

<p>3）对于视图集ViewSet，仍在类视图的文档字符串中封开定义，但是应使用action名称区分，如<br>视图集ViewSet中的retrieve名称，在接口文档网站中叫做read</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookInfoViewSet</span>(<span class="params">mixins.ListModelMixin, mixins.RetrieveModelMixin, GenericViewSet</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    list:</span></span><br><span class="line"><span class="string">    返回图书列表数据</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    retrieve:</span></span><br><span class="line"><span class="string">    返回图书详情数据</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    latest:</span></span><br><span class="line"><span class="string">    返回最新的图书数据</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    read:</span></span><br><span class="line"><span class="string">    修改图书的阅读量</span></span><br><span class="line"><span class="string">    """</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserFavViewSet</span>(<span class="params">mixins.CreateModelMixin, mixins.ListModelMixin, mixins.RetrieveModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                     mixins.DestroyModelMixin, viewsets.GenericViewSet</span>):</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    list:用户收藏列表</span></span><br><span class="line"><span class="string">    create:</span></span><br><span class="line"><span class="string">        创建添加一条收藏</span></span><br><span class="line"><span class="string">    retrieve:</span></span><br><span class="line"><span class="string">        根据ID查询到用户收藏详情</span></span><br><span class="line"><span class="string">    destroy:</span></span><br><span class="line"><span class="string">        删除用户收藏</span></span><br><span class="line"><span class="string">    '''</span></span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/05/08/drf-de-api-jie-kou-wen-dang/1.png" alt="description"><br><img src="/2021/05/08/drf-de-api-jie-kou-wen-dang/2.png" alt="description"><br><img src="/2021/05/08/drf-de-api-jie-kou-wen-dang/3.png" alt="description"></p>
<p>goods文档<br><a target="_blank" rel="noopener" href="http://127.0.0.1:8000/docs/#goods">http://127.0.0.1:8000/docs/#goods</a> 很多字段描述不完整，先进行配置</p>
<p>Query Parameters<br>The following parameters should be included as part of a URL query string.</p>
<table>
<thead>
<tr>
<th><strong>Parameter</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody><tr>
<td><code>AutoField</code></td>
<td>自增ID字段</td>
</tr>
<tr>
<td><code>page</code></td>
<td>A page number within the paginated result set.</td>
</tr>
<tr>
<td><code>page_size</code></td>
<td>Number of results to return per page.</td>
</tr>
<tr>
<td><code>name</code></td>
<td>分类名模糊匹配</td>
</tr>
<tr>
<td><code>pricemin</code></td>
<td></td>
</tr>
<tr>
<td><code>pricemax</code></td>
<td></td>
</tr>
<tr>
<td><code>is_hot</code></td>
<td></td>
</tr>
<tr>
<td><code>is_new</code></td>
<td></td>
</tr>
<tr>
<td><code>top_category</code></td>
<td></td>
</tr>
<tr>
<td><code>search</code></td>
<td>A search term.</td>
</tr>
<tr>
<td><code>ordering</code></td>
<td>Which field to use when ordering the results.</td>
</tr>
</tbody></table>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GoodsListViewSet</span>(<span class="params">mixins.ListModelMixin, mixins.RetrieveModelMixin, viewsets.GenericViewSet</span>):</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    list:</span></span><br><span class="line"><span class="string">        商品列表页，并实现分页、搜索、过滤、排序</span></span><br><span class="line"><span class="string">    retrieve:</span></span><br><span class="line"><span class="string">        商品详情，并实现热卖商品接口</span></span><br><span class="line"><span class="string">    '''</span></span><br></pre></td></tr></tbody></table></figure>

<p>本地化<a target="_blank" rel="noopener" href="http://djangobook.py3k.cn/2.0/chapter19/">http://djangobook.py3k.cn/2.0/chapter19/</a></p>
<p>分页中文描述<br><code>apps/goods/views.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.pagination <span class="keyword">import</span> PageNumberPagination</span><br><span class="line"><span class="keyword">from</span> django.utils.translation <span class="keyword">import</span> ugettext_lazy</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GoodsPagination</span>(<span class="params">PageNumberPagination</span>):</span></span><br><span class="line">    page_size = <span class="number">12</span>  <span class="comment"># 默认每页显示的个数</span></span><br><span class="line">    max_page_size = <span class="number">100</span>  <span class="comment"># 最多能显示多少页</span></span><br><span class="line">    page_size_query_param = <span class="string">'page_size'</span>  <span class="comment"># 页面大小对应的查询参数</span></span><br><span class="line">    page_query_param = <span class="string">'page'</span>  <span class="comment"># 页码参数?page=xx</span></span><br><span class="line">    page_query_description = ugettext_lazy(<span class="string">'使用分页后的页码'</span>)  <span class="comment"># 分页文档中文描述</span></span><br><span class="line">    page_size_query_description = ugettext_lazy(<span class="string">'每页返回的结果数'</span>)</span><br></pre></td></tr></tbody></table></figure>

<table>
<thead>
<tr>
<th><strong>Parameter</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody><tr>
<td><code>AutoField</code></td>
<td>自增ID字段</td>
</tr>
<tr>
<td><code>page</code></td>
<td>使用分页后的页码</td>
</tr>
<tr>
<td><code>page_size</code></td>
<td>每页返回的结果数</td>
</tr>
<tr>
<td><code>name</code></td>
<td>分类名模糊匹配</td>
</tr>
<tr>
<td><code>pricemin</code></td>
<td></td>
</tr>
<tr>
<td><code>pricemax</code></td>
<td></td>
</tr>
<tr>
<td><code>is_hot</code></td>
<td></td>
</tr>
<tr>
<td><code>is_new</code></td>
<td></td>
</tr>
<tr>
<td><code>top_category</code></td>
<td></td>
</tr>
<tr>
<td><code>search</code></td>
<td>A search term.</td>
</tr>
<tr>
<td><code>ordering</code></td>
<td>Which field to use when ordering the results.</td>
</tr>
</tbody></table>
<p>添加字段参数的Description描述需要<br>在<code>model</code>模型类或<code>serializer</code>序列化器类或<code>filter</code>过滤类的字段中指定<code>help_text</code>属性<br><code>apps/goods/filters.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GoodsFilter</span>(<span class="params">django_filters.rest_framework.FilterSet</span>):</span></span><br><span class="line">    <span class="string">'''商品过滤类'''</span></span><br><span class="line">    <span class="comment"># 两个参数，name是要过滤的字段，lookup是执行的行为，‘小与等于本店价格’</span></span><br><span class="line">    name = django_filters.CharFilter(field_name=<span class="string">"name"</span>, lookup_expr=<span class="string">'contains'</span>, help_text=<span class="string">'分类名模糊匹配'</span>)  <span class="comment"># 包含关系，模糊匹配</span></span><br><span class="line">    pricemin = django_filters.NumberFilter(field_name=<span class="string">"market_price"</span>, lookup_expr=<span class="string">'gte'</span>, help_text=<span class="string">'最低价格'</span>)  <span class="comment"># 自定义字段</span></span><br><span class="line">    pricemax = django_filters.NumberFilter(field_name=<span class="string">"market_price"</span>, lookup_expr=<span class="string">'lte'</span>, help_text=<span class="string">'最高价格'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 自定义过滤，过滤某个一级分类</span></span><br><span class="line">    top_category = django_filters.NumberFilter(method=<span class="string">'top_category_filter'</span>, help_text=<span class="string">'自定义过滤某个一级分类'</span>)</span><br></pre></td></tr></tbody></table></figure>

<table>
<thead>
<tr>
<th><strong>Parameter</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody><tr>
<td><code>AutoField</code></td>
<td>自增ID字段</td>
</tr>
<tr>
<td><code>page</code></td>
<td>使用分页后的页码</td>
</tr>
<tr>
<td><code>page_size</code></td>
<td>每页返回的结果数</td>
</tr>
<tr>
<td><code>name</code></td>
<td>分类名模糊匹配</td>
</tr>
<tr>
<td><code>pricemin</code></td>
<td>最低价格</td>
</tr>
<tr>
<td><code>pricemax</code></td>
<td>最高价格</td>
</tr>
<tr>
<td><code>is_hot</code></td>
<td></td>
</tr>
<tr>
<td><code>is_new</code></td>
<td></td>
</tr>
<tr>
<td><code>top_category</code></td>
<td>自定义过滤某个一级分类</td>
</tr>
<tr>
<td><code>search</code></td>
<td>A search term.</td>
</tr>
<tr>
<td><code>ordering</code></td>
<td>Which field to use when ordering the results.</td>
</tr>
</tbody></table>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></tbody></table></figure><script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/05/08/mq/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/08/mq/" class="post-title-link" itemprop="url">mq（message queue）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-05-07 16:21:41" itemprop="dateCreated datePublished" datetime="2021-05-07T16:21:41Z">2021-05-07</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-06-07 03:25:24" itemprop="dateModified" datetime="2021-06-07T03:25:24Z">2021-06-07</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/django/" itemprop="url" rel="index"><span itemprop="name">django</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>消息队列是一种“先进先出”的数据结构</p>
<h3 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h3><ul>
<li>应用解耦<br>系统的耦合性越高，容错性就越低。以电商应用为例，用户创建订单后，如果耦合调用库存系统、物流系统、支付系统，任何一个子系统出了故障或者因为升级等原因暂时不可用，都会造成下单操作异常，影响用户使用体验。</li>
</ul>
<p>使用消息队列解耦合，系统的耦合性就会提高了。比如物流系统发生故障，需要几分钟才能来修复，在这段时间内，物流系统要处理的数据被缓存到消息队列中，用户的下单操作正常完成。当物流系统回复后，补充处理存在消息队列中的订单消息即可，终端系统感知不到物流系统发生过几分钟故障。</p>
<ul>
<li>流量削峰</li>
</ul>
<p>应用系统如果遇到系统请求流量的瞬间猛增，有可能会将系统压垮。有了消息队列可以将大量请求缓存起来，分散到很长一段时间处理，这样可以大大提到系统的稳定性和用户体验。</p>
<p>每秒5k个请求MQ用户A系统从MQ中每秒拉取2k个请求A系统MySQL</p>
<p>一般情况，为了保证系统的稳定性，如果系统负载超过阈值，就会阻止用户请求，这会影响用户体验，而如果使用消息队列将请求缓存起来，等待系统处理完毕后通知用户下单完毕，这样总不能下单体验要好。</p>
<p>出于经济考量目的：<br>业务系统正常时段的QPS如果是1000，流量最高峰是10000，为了应对流量高峰配置高性能的服务器显然不划算，这时可以使用消息队列对峰值流量削峰</p>
<ul>
<li>数据分发</li>
</ul>
<p>通过消息队列可以让数据在多个系统更加之间进行流通。数据的产生方不需要关心谁来使用数据，只需要将数据发送到消息队列，数据使用方直接在消息队列中直接获取数据即可。</p>
<h3 id="MQ的优点和缺点"><a href="#MQ的优点和缺点" class="headerlink" title="MQ的优点和缺点"></a>MQ的优点和缺点</h3><p>优点：解耦、削峰、数据分发<br>缺点包含以下几点：</p>
<ul>
<li><p>系统可用性降低<br>系统引入的外部依赖越多，系统稳定性越差。一旦MQ宕机，就会对业务造成影响。<br>如何保证MQ的高可用？</p>
</li>
<li><p>系统复杂度提高<br>MQ的加入大大增加了系统的复杂度，以前系统间是同步的远程调用，现在是通过MQ进行异步调用。<br>如何保证消息没有被重复消费？怎么处理消息丢失情况？那么保证消息传递的顺序性？</p>
</li>
<li><p>一致性问题<br>A系统处理完业务，通过MQ给B、C、D三个系统发消息数据，如果B系统、C系统处理成功，D系统处理失败。<br>如何保证消息数据处理的一致性？</p>
</li>
</ul>
<p>结论:</p>
<p>(1)中小型软件公司，建议选RabbitMQ.一方面，erlang语言天生具备高并发的特性，而且他的管理界面用起来十分方便。正所谓，成也萧何，败也萧何！他的弊端也在这里，虽然RabbitMQ是开源的，然而国内有几个能定制化开发erlang的程序员呢？所幸，RabbitMQ的社区十分活跃，可以解决开发过程中遇到的bug，这点对于中小型公司来说十分重要。不考虑rocketmq和kafka的原因是，一方面中小型软件公司不如互联网公司，数据量没那么大，选消息中间件，应首选功能比较完备的，所以kafka排除。但是rocketmq已经交给apache管理，所以rocketmq的未来发展趋势看好。</p>
<p>(2)大型软件公司，根据具体使用在rocketMq和kafka之间二选一。一方面，大型软件公司，具备足够的资金搭建分布式环境，也具备足够大的数据量。针对rocketMQ,大型软件公司也可以抽出人手对rocketMQ进行定制化开发，毕竟国内有能力改JAVA源码的人，还是相当多的。至于kafka，根据业务场景选择，如果有日志采集功能，肯定是首选kafka了。具体该选哪个，看使用场景。</p>
<p>选择rocketmq，基于两点考虑：</p>
<ul>
<li>延迟消息简单高效</li>
<li>死信队列</li>
<li>完善的事务消息功能</li>
</ul>
<p>安装rocketmqmq</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-0-9-centos ~]<span class="comment"># cd /root/project/mxshop_srvs/order_srv/</span></span><br><span class="line">[root@VM-0-9-centos order_srv]<span class="comment"># ls</span></span><br><span class="line">install  install.zip</span><br><span class="line">[root@VM-0-9-centos order_srv]<span class="comment"># cd install/</span></span><br><span class="line">[root@VM-0-9-centos install]<span class="comment"># ls</span></span><br><span class="line">conf  docker-compose.yml  README.md</span><br><span class="line">[root@VM-0-9-centos install]<span class="comment"># cd conf/</span></span><br><span class="line">[root@VM-0-9-centos conf]<span class="comment"># vim broker.conf</span></span><br><span class="line">brokerIP1=81.69.41.250  <span class="comment"># linux的ip</span></span><br><span class="line">[root@VM-0-9-centos conf]<span class="comment"># cd ..</span></span><br><span class="line">[root@VM-0-9-centos install]<span class="comment"># ls</span></span><br><span class="line">conf  docker-compose.yml  logs  README.md  store</span><br><span class="line">[root@VM-0-9-centos install]<span class="comment"># docker ps -a</span></span><br><span class="line">CONTAINER ID   IMAGE                           COMMAND                  CREATED          STATUS                       PORTS                                                  NAMES</span><br><span class="line">bd592bce48b8   styletang/rocketmq-console-ng   <span class="string">"sh -c 'java <span class="variable">$JAVA_O</span>…"</span>   16 minutes ago   Exited (137) 6 minutes ago                                                          rmqconsole</span><br><span class="line">01a559d554f8   foxiswho/rocketmq:broker        <span class="string">"mqbroker -c /etc/ro…"</span>   16 minutes ago   Exited (137) 6 minutes ago                                                          rmqbroker</span><br><span class="line">bff14878447c   foxiswho/rocketmq:server        <span class="string">"/bin/sh -c 'cd <span class="variable">${RO…"   16 minutes ago   Exited (137) 6 minutes ago                                                          rmqnamesrv</span></span></span><br><span class="line"><span class="string"><span class="variable">a7df53a51485   mysql:5.7                       "docker-entrypoint.s…"   11 hours ago     Up 11 hours                  0.0.0.0:3306-&gt;3306/tcp, :::3306-&gt;3306/tcp, 33060/tcp   mymysql</span></span></span><br><span class="line"><span class="string"><span class="variable">[root@VM-0-9-centos install]# docker-compose up</span></span></span><br></pre></td></tr></tbody></table></figure>

<p><a target="_blank" rel="noopener" href="http://81.69.41.250:8080/#/">http://81.69.41.250:8080/#/</a></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/05/06/drf-de-request-he-response-lei/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/06/drf-de-request-he-response-lei/" class="post-title-link" itemprop="url">DRF视图开发RESTful API接口的方式</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-05-05 16:21:41" itemprop="dateCreated datePublished" datetime="2021-05-05T16:21:41Z">2021-05-05</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-06-06 13:02:14" itemprop="dateModified" datetime="2021-06-06T13:02:14Z">2021-06-06</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/django/" itemprop="url" rel="index"><span itemprop="name">django</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://www.django-rest-framework.org/api-guide/requests/#data">https://www.django-rest-framework.org/api-guide/requests/#data</a></p>
<p>REST framework 传入视图的request对象不再是Django默认的HttpRequest对象，而是REST framework提供的扩展了HttpRequest类的Request类的对象。</p>
<p>比如更加灵活的请求解析（request parsing）和认证（request authentication）。</p>
<p>REST framework 提供了Parser解析器，在接收到请求后会自动根据Content-Type指明的请求数据类型（如JSON、表单等）将请求数据进行parse解析，解析为类字典[QueryDict]对象保存到Request对象中。</p>
<p><strong>Request对象的数据是自动根据前端发送数据的格式进行解析之后的结果。</strong></p>
<p>无论前端发送的哪种格式的数据，我们都可以以统一的方式读取数据。</p>
<ul>
<li><p><code>request.data</code><br>返回请求主体的解析内容，类似Django中标准的<code>request.POST</code>和<code>request.FILES</code>属性，具体如下：</p>
<ul>
<li>它包括所有已解析的内容，包括文件和非文件输入；</li>
<li>它支持解析HTTP方法不只是<code>POST</code>，这意味着您可以访问<code>PUT</code>和<code>PATCH</code>请求的内容；</li>
<li>它支持REST框架的灵活请求解析，而不仅仅是支持表单数据。例如，可以以处理传入表单数据的相同方式处理传入JSON数据。</li>
</ul>
</li>
<li><p><code>request.query_params</code><br>等同于Django标准的<code>request.GET</code>，有助于使代码库更加正确和明显，这样那够让你的代码更加明显的体现出 —-任何HTTP方法类型都可能包括查询参数，而不仅仅是GET请求。</p>
</li>
<li><p><code>request.parsers</code> <code>APIView</code> 类或者 <code>@api_view</code> 装饰器将根据视图上设置的 parser_classes 或 settings 文件中的 DEFAULT_PARSER_CLASSES 设置来确保此属性（.parsers）自动设置为 Parser 实例列表。用于解析数据。通常不需要关注该属性……DRF包括许多内置的Parser类，以保证可以接收各种媒体类型的请求并解析，包括JSONParser、FormParser、MultiPartParser等。还支持定义自己的自定义解析器，这使您可以灵活地设计API接受的媒体类型。</p>
</li>
<li><p><code>request.user</code>通常会返回的实例django.contrib.auth.models.User，尽管其行为取决于所使用的身份验证策略。</p>
</li>
</ul>
<p>drf 二次封装后的 request 对象</p>
<p>怎么拿到请求传递过来的数据（url 拼接的数据，数据包传过来的数据）</p>
<p>源码</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">APIView</span>(<span class="params">View</span>):</span></span><br><span class="line">    <span class="comment"># Note: Views are made CSRF exempt from within `as_view` as to prevent</span></span><br><span class="line">    <span class="comment"># accidental removal of this exemption in cases where `dispatch` needs to</span></span><br><span class="line">    <span class="comment"># be overridden.</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dispatch</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        `.dispatch()` is pretty much the same as Django's regular dispatch,</span></span><br><span class="line"><span class="string">        but with extra hooks for startup, finalize, and exception handling.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        self.args = args</span><br><span class="line">        self.kwargs = kwargs</span><br><span class="line">        <span class="comment"># 请求模块</span></span><br><span class="line">        request = self.initialize_request(request, *args, **kwargs)</span><br><span class="line">        self.request = request</span><br><span class="line">        self.headers = self.default_response_headers  <span class="comment"># deprecate?</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 三大认证模块</span></span><br><span class="line">            self.initial(request, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Get the appropriate handler method</span></span><br><span class="line">            <span class="keyword">if</span> request.method.lower() <span class="keyword">in</span> self.http_method_names:</span><br><span class="line">                handler = getattr(self, request.method.lower(),</span><br><span class="line">                                  self.http_method_not_allowed)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                handler = self.http_method_not_allowed</span><br><span class="line"></span><br><span class="line">            response = handler(request, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> exc:</span><br><span class="line">            response = self.handle_exception(exc)</span><br><span class="line"></span><br><span class="line">        self.response = self.finalize_response(request, response, *args, **kwargs)</span><br><span class="line">        <span class="keyword">return</span> self.response</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Dispatch methods</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">initialize_request</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        Returns the initial request object.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        parser_context = self.get_parser_context(request)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Request(  <span class="comment"># 对应下面的__init__</span></span><br><span class="line">            request,</span><br><span class="line">            parsers=self.get_parsers(),</span><br><span class="line">            authenticators=self.get_authenticators(),</span><br><span class="line">            negotiator=self.get_content_negotiator(),</span><br><span class="line">            parser_context=parser_context</span><br><span class="line">        )</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Request</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Wrapper allowing to enhance a standard `HttpRequest` instance.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Kwargs:</span></span><br><span class="line"><span class="string">        - request(HttpRequest). The original request instance.</span></span><br><span class="line"><span class="string">        - parsers(list/tuple). The parsers to use for parsing the</span></span><br><span class="line"><span class="string">          request content.</span></span><br><span class="line"><span class="string">        - authenticators(list/tuple). The authenticators used to try</span></span><br><span class="line"><span class="string">          authenticating the request's user.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, request, parsers=None, authenticators=None,</span></span></span><br><span class="line"><span class="function"><span class="params">                 negotiator=None, parser_context=None</span>):</span></span><br><span class="line">        <span class="keyword">assert</span> isinstance(request, HttpRequest), (</span><br><span class="line">            <span class="string">'The `request` argument must be an instance of '</span></span><br><span class="line">            <span class="string">'`django.http.HttpRequest`, not `{}.{}`.'</span></span><br><span class="line">            .format(request.__class__.__module__, request.__class__.__name__)</span><br><span class="line">        )</span><br><span class="line">        <span class="comment"># 二次封装 request，将原生 request 作为 drf request 对象的 _request 属性</span></span><br><span class="line">        self._request = request</span><br><span class="line">        <span class="comment"># 虽然 drf 对 request 对象做了二次封装，但是它也做了完全兼容（见下面的 __getattr__ 方法）</span></span><br><span class="line"></span><br><span class="line">        self.parsers = parsers <span class="keyword">or</span> ()</span><br><span class="line">        self.authenticators = authenticators <span class="keyword">or</span> ()</span><br><span class="line">        self.negotiator = negotiator <span class="keyword">or</span> self._default_negotiator()</span><br><span class="line">        self.parser_context = parser_context</span><br><span class="line">        self._data = Empty</span><br><span class="line">        self._files = Empty</span><br><span class="line">        self._full_data = Empty</span><br><span class="line">        self._content_type = Empty</span><br><span class="line">        self._stream = Empty</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.parser_context <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            self.parser_context = {}</span><br><span class="line">        self.parser_context[<span class="string">'request'</span>] = self</span><br><span class="line">        self.parser_context[<span class="string">'encoding'</span>] = request.encoding <span class="keyword">or</span> settings.DEFAULT_CHARSET</span><br><span class="line"></span><br><span class="line">        force_user = getattr(request, <span class="string">'_force_auth_user'</span>, <span class="literal">None</span>)</span><br><span class="line">        force_token = getattr(request, <span class="string">'_force_auth_token'</span>, <span class="literal">None</span>)</span><br><span class="line">        <span class="keyword">if</span> force_user <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">or</span> force_token <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            forced_auth = ForcedAuthentication(force_user, force_token)</span><br><span class="line">            self.authenticators = (forced_auth,)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span>(<span class="params">self, attr</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        If an attribute does not exist on this instance, then we also attempt</span></span><br><span class="line"><span class="string">        to proxy it to the underlying HttpRequest object.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 对原有的 request 做了完全兼容</span></span><br><span class="line">            <span class="keyword">return</span> getattr(self._request, attr)</span><br><span class="line">        <span class="keyword">except</span> AttributeError:</span><br><span class="line">            <span class="keyword">return</span> self.__getattribute__(attr)</span><br></pre></td></tr></tbody></table></figure>

<p>url 拼接的参数都可以用 request.query_params 来取<br>所有请求的数据包方式数据都可以用 request.data 来取，所有数据方式（from-data、json…）它都做解析了</p>
<p>在 APIView 视图类的方法中</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="comment"># 获取 url 拼接的参数</span></span><br><span class="line">        print(request._request.GET)  <span class="comment"># 二次封装</span></span><br><span class="line">        print(request.GET)  <span class="comment"># 兼容</span></span><br><span class="line">        print(request.query_params)  <span class="comment"># 扩展，推荐用这个</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Response(<span class="string">"drf get ok."</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="comment"># 获取 url 拼接的参数 (所有请求方式都可以携带这个)</span></span><br><span class="line">        print(request._request.GET)</span><br><span class="line">        print(request.GET)  <span class="comment"># 兼容</span></span><br><span class="line">        print(request.query_params)  <span class="comment"># 扩展，推荐用这个</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 获取 post 参数</span></span><br><span class="line">        print(request._request.POST)  <span class="comment"># 拿不到 json 的数据 </span></span><br><span class="line">        print(request.POST)  <span class="comment"># 兼容，拿不到 json 的数据</span></span><br><span class="line">        print(request.data)  <span class="comment"># 扩展，兼容性最强，三种数据方式都可以，推荐用这个</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Response(<span class="string">"drf post ok"</span>)</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>drf 对原生 request 做了二次封装，<code>request._request</code> 就是原生 <code>request</code></li>
<li>原生 request 对象的属性和方法都可以被 drf 的 request 对象直接访问（向下兼容）</li>
<li>drf 请求的所有 url 拼接参数都被解析到 <code>request.query_params</code> 中，所有数据包数据都被解析到 <code>request.data</code> 中<br>任何请求都可以通过 url 拼接参数来传递参数，同样通过 <code>request.query_params</code> 获取</li>
</ul>
<h2 id="Response"><a href="#Response" class="headerlink" title="Response()"></a>Response()</h2><p><a target="_blank" rel="noopener" href="https://www.django-rest-framework.org/api-guide/responses/">https://www.django-rest-framework.org/api-guide/responses/</a></p>
<p>DRF通过提供一个Response类来支持HTTP内容协商，该类允许您根据客户端请求返回可以呈现为多种内容类型的内容。</p>
<p>也可以根据需要从视图中返回常规<code>HttpResponse</code>或<code>StreamingHttpResponse</code>对象。使用<code>Response</code>类只是为返回内容协商的Web API响应提供了一个更好的接口，该响应可以呈现为多种格式。</p>
<p>构造方法: <code>Response(data, status=None, template_name=None, headers=None, content_type=None)</code></p>
<p>与普通 HttpResponse 对象不同，您不会使用渲染的内容实例化 Response 对象。相反，您传递的是未渲染的数据，可能包含任何 Python 对象。</p>
<p>由于 Response 类使用的渲染器不能处理复杂的数据类型（比如 Django 的模型实例），所以需要在创建 <code>Response</code> 对象之前将数据序列化为基本的数据类型。</p>
<p>你可以使用 REST framework 的 Serializer 类来执行序列化的操作，也可以用自己的方式来序列化。</p>
<h4 id="Arguments参数"><a href="#Arguments参数" class="headerlink" title="Arguments参数"></a>Arguments参数</h4><p>data： 为响应准备的序列化后的数据。<br>status： 响应的状态代码。默认为200。<br>template_name： 选择 HTMLRenderer 时使用的模板名称。<br>headers： 设置 HTTP header，字典类型。<br>content_type： 响应的内容类型，通常渲染器会根据内容协商的结果自动设置，但有些时候需要手动指定。</p>
<h4 id="Attributes属性"><a href="#Attributes属性" class="headerlink" title="Attributes属性"></a>Attributes属性</h4><p><code>.data</code>还没有渲染，但已经序列化的响应数据。</p>
<p><code>.status_code</code> 状态码</p>
<p>.content<br>将会返回的响应内容，必须先调用 <code>.render()</code>方法，才能访问 <code>.content</code> 。</p>
<p>.template_name</p>
<p>只有在 response 的渲染器是 HTMLRenderer 或其他自定义模板渲染器时才需要提供。</p>
<p>.accepted_renderer</p>
<p>用于将会返回的响应内容的渲染器实例。</p>
<p>从视图返回响应之前由 APIView 或 @api_view 自动设置。</p>
<p>.accepted_media_type</p>
<p>内容协商阶段选择的媒体类型。</p>
<p>从视图返回响应之前由 APIView 或 @api_view 自动设置。</p>
<p>.renderer_context</p>
<p>将传递给渲染器的 .render() 方法的附加的上下文信息字典。</p>
<p>从视图返回响应之前由 APIView 或 @api_view 自动设置。</p>
<p>标准 HttpResponse 属性</p>
<p>Response 类扩展于 SimpleTemplateResponse，并且响应中也提供了所有常用的属性和方法。例如，您可以用标准方式在响应中设置 header：</p>
<p>response = Response()<br>response[‘Cache-Control’] = ‘no-cache’<br>.render()</p>
<p>与其他任何 TemplateResponse 一样，调用此方法将响应的序列化数据呈现为最终响应内容。响应内容将设置为在 accepted_renderer 实例上调用 .render(data，accepted_media_type，renderer_context) 方法的结果。</p>
<p>通常不需要自己调用 .render() ，因为它是由 Django 处理的。</p>
<p>一般都用 Response 对象来做返回（最后一定是打包成符合 HTTP 协议的数据格式来传输，Response 类做了一系列处理，所以这里我们只需要关注下它的那些参数即可）</p>
<p>响应类构造器</p>
<p>源码</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Response</span>(<span class="params">SimpleTemplateResponse</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    An HttpResponse that allows its data to be rendered into</span></span><br><span class="line"><span class="string">    arbitrary media types.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, data=None, status=None,</span></span></span><br><span class="line"><span class="function"><span class="params">                    template_name=None, headers=None,</span></span></span><br><span class="line"><span class="function"><span class="params">                    exception=False, content_type=None</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        Alters the init arguments slightly.</span></span><br><span class="line"><span class="string">        For example, drop 'template_name', and instead use 'data'.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Setting 'renderer' and 'media_type' will typically be deferred,</span></span><br><span class="line"><span class="string">        For example being set automatically by the `APIView`.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            :param data: 响应数据</span></span><br><span class="line"><span class="string">            :param status: http响应状态码</span></span><br><span class="line"><span class="string">            :param template_name: drf也可以渲染页面，渲染的页面模板地址（不用了解）</span></span><br><span class="line"><span class="string">            :param headers: 响应头</span></span><br><span class="line"><span class="string">            :param exception: 是否异常了</span></span><br><span class="line"><span class="string">            :param content_type: 响应的数据格式（一般不用处理，响应头中带了，且默认是json）</span></span><br><span class="line"><span class="string">        """</span></span><br></pre></td></tr></tbody></table></figure>



<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> status</span><br><span class="line"><span class="comment"># status就是解释一堆 数字 网络状态码的模块</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 一般情况下只需要返回数据，status和headers都有默认值</span></span><br><span class="line"><span class="keyword">return</span> Response(data={数据}, status=status.HTTP_200_OK, headers={设置的响应头})</span><br></pre></td></tr></tbody></table></figure>

<p>models.py</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseModel</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    is_delete = models.BooleanFiled(default=Flase)</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        abstract = <span class="literal">True</span>  <span class="comment"># *****</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span>(<span class="params">BaseModel</span>):</span></span><br><span class="line">    name = models.CharFiled(max_length=<span class="number">64</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">my_name</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># 自定义字段：可以连表，可以完成数据相关的逻辑</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'插拔式字段的值'</span></span><br></pre></td></tr></tbody></table></figure>

<p>serializes.py</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CarModelSerializer</span>(<span class="params">ModelSerializer</span>):</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = models.Car</span><br><span class="line">        fields = (<span class="string">'name'</span>, )</span><br><span class="line">        extra_kwargs = {<span class="string">'name'</span>: {<span class="string">'write_only|read_only'</span>: <span class="literal">True</span>}}</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 局部钩子、全局钩子</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 重点：ListSerializer与ModelSerializer建立关联的是：</span></span><br><span class="line"><span class="comment"># ModelSerializer的Meta类的 - list_serializer_class</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">V2BookListSerializer</span>(<span class="params">ListSerializer</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">update</span>(<span class="params">self, instance, validated_data</span>):</span></span><br><span class="line">        <span class="comment"># print(instance)  # 要更新的对象们</span></span><br><span class="line">        <span class="comment"># print(validated_data)  # 更新的对象对应的数据们</span></span><br><span class="line">        <span class="comment"># print(self.child)  # 服务的模型序列化类 - V2BookModelSerializer</span></span><br><span class="line">        <span class="keyword">for</span> index, obj <span class="keyword">in</span> enumerate(instance):</span><br><span class="line">            self.child.update(obj, validated_data[index])</span><br><span class="line">        <span class="keyword">return</span> instance</span><br><span class="line"></span><br><span class="line"><span class="comment"># 原模型序列化类变化</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">V2BookModelSerializer</span>(<span class="params">ModelSerializer</span>):</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        <span class="comment"># ...</span></span><br><span class="line">        <span class="comment"># 群改，需要设置 自定义ListSerializer，重写群改的 update 方法</span></span><br><span class="line">        list_serializer_class = V2BookListSerializer</span><br><span class="line">    <span class="comment"># ...</span></span><br></pre></td></tr></tbody></table></figure>

<p>views.py</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">    ser_obj = CarModelSerializer(数据)  <span class="comment"># 产生序列化类对象(可能参与序列化，也可能参与反序列化)</span></span><br><span class="line">    ser_obj.data  <span class="comment"># 序列化的数据</span></span><br><span class="line">    ser_obj.is_valid()  <span class="comment"># 启动序列化校验规则（系统内容=&gt;局部钩子=&gt;全局钩子）</span></span><br><span class="line">    ser_obj.save()  <span class="comment"># 序列化校验后的数据操作（保存、修改）</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">V2Book</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="comment"># 单整体改: 对 v2/books/(pk)/ 传的数据是与model对应的字典{name|price|publish|authors}</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        request_data = request.data</span><br><span class="line">        pk = kwargs.get(<span class="string">'pk'</span>)</span><br><span class="line">        old_book_obj = models.Book.objects.filter(pk=pk).first()</span><br><span class="line">        <span class="comment"># 目的：将众多数据的校验交给序列化类来处理 - 让序列化类扮演反序列化角色，校验成功后，序列化类来帮你入库</span></span><br><span class="line">        book_ser = serializers.V2BookModelSerializer(instance=old_book_obj, data=request_data, partial=<span class="literal">False</span>)</span><br><span class="line">        book_ser.is_valid(raise_exception=<span class="literal">True</span>)</span><br><span class="line">        <span class="comment"># 校验通过，完成数据的更新：要更新的目标，用来更新的新数据</span></span><br><span class="line">        book_obj = book_ser.save()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Response({</span><br><span class="line">            <span class="string">'status'</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="string">'msg'</span>: <span class="string">'ok'</span>,</span><br><span class="line">            <span class="string">'results'</span>: serializers.V2BookModelSerializer(book_obj).data</span><br><span class="line">        })</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 单局部改：对 v2/books/(pk)/ 传的数据，数据字段key都是选填</span></span><br><span class="line">    <span class="comment"># 群局部改：对 v2/books/ </span></span><br><span class="line">    <span class="comment"># 请求数据 - [{pk:1, name:123}, {pk:3, price:7}, {pk:7, publish:2}]</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">patch</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        request_data = request.data</span><br><span class="line">        pk = kwargs.get(<span class="string">'pk'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 将单改，群改的数据都格式化成 pks=[要需要的对象主键标识] | request_data=[每个要修改的对象对应的修改数据]</span></span><br><span class="line">        <span class="keyword">if</span> pk <span class="keyword">and</span> isinstance(request_data, dict):  <span class="comment"># 单改</span></span><br><span class="line">            pks = [pk, ]</span><br><span class="line">            request_data = [request_data, ]</span><br><span class="line">        <span class="keyword">elif</span> <span class="keyword">not</span> pk <span class="keyword">and</span> isinstance(request_data, list): <span class="comment"># 群改</span></span><br><span class="line">            pks = []</span><br><span class="line">            <span class="keyword">for</span> dic <span class="keyword">in</span> request_data:  <span class="comment"># 遍历前台数据[{pk:1, name:123}, {pk:3, price:7}, {pk:7, publish:2}]，拿一个个字典</span></span><br><span class="line">                pk = dic.pop(<span class="string">'pk'</span>, <span class="literal">None</span>)</span><br><span class="line">                <span class="keyword">if</span> pk:</span><br><span class="line">                    pks.append(pk)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">return</span> Response({</span><br><span class="line">                        <span class="string">'status'</span>: <span class="number">1</span>,</span><br><span class="line">                        <span class="string">'msg'</span>: <span class="string">'数据有误'</span>,</span><br><span class="line">                    })</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> Response({</span><br><span class="line">                <span class="string">'status'</span>: <span class="number">1</span>,</span><br><span class="line">                <span class="string">'msg'</span>: <span class="string">'数据有误'</span>,</span><br><span class="line">            })</span><br><span class="line"></span><br><span class="line">        <span class="comment"># pks与request_data数据筛选，</span></span><br><span class="line">        <span class="comment"># 1）将pks中的没有对应数据的pk与数据已删除的pk移除，request_data对应索引位上的数据也移除</span></span><br><span class="line">        <span class="comment"># 2）将合理的pks转换为 objs</span></span><br><span class="line">        objs = []</span><br><span class="line">        new_request_data = []</span><br><span class="line">        <span class="keyword">for</span> index, pk <span class="keyword">in</span> enumerate(pks):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># pk对应的数据合理，将合理的对象存储</span></span><br><span class="line">                obj = models.Book.objects.get(pk=pk)</span><br><span class="line">                objs.append(obj)</span><br><span class="line">                <span class="comment"># 对应索引的数据就需要保存下来</span></span><br><span class="line">                new_request_data.append(request_data[index])</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                <span class="comment"># 重点：反面教材 - pk对应的数据有误，将对应索引的data中request_data中移除</span></span><br><span class="line">                <span class="comment"># index = pks.index(pk)</span></span><br><span class="line">                <span class="comment"># request_data.pop(index)</span></span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        book_ser = serializers.V2BookModelSerializer(instance=objs, data=new_request_data, partial=<span class="literal">True</span>, many=<span class="literal">True</span>)</span><br><span class="line">        book_ser.is_valid(raise_exception=<span class="literal">True</span>)</span><br><span class="line">        book_objs = book_ser.save()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Response({</span><br><span class="line">            <span class="string">'status'</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="string">'msg'</span>: <span class="string">'ok'</span>,</span><br><span class="line">            <span class="string">'results'</span>: serializers.V2BookModelSerializer(book_objs, many=<span class="literal">True</span>).data</span><br><span class="line">        })</span><br></pre></td></tr></tbody></table></figure>


<ol>
<li>单整体改，说明前台要提供修改的数据，那么数据就需要校验，校验的数据应该在实例化“序列化类对象”时，赋值给data<br>2）修改，就必须明确被修改的模型类对象，并在实例化“序列化类对象”时，赋值给instance<br>3）整体修改，所有校验规则有required=True的字段，都必须提供，因为在实例化“序列化类对象”时，参数partial默认为False</li>
</ol>
<p>注：如果partial值设置为True，就是可以局部改<br>1）单整体修改，一般用put请求：</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">V2BookModelSerializer(</span><br><span class="line">    instance=要被更新的对象,</span><br><span class="line">    data=用来更新的数据,</span><br><span class="line">    partial=默认<span class="literal">False</span>，必须的字段全部参与校验</span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure>

<p>2）单局部修改，一般用patch请求：</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">V2BookModelSerializer(</span><br><span class="line">    instance=要被更新的对象,</span><br><span class="line">    data=用来更新的数据,</span><br><span class="line">    partial=设置<span class="literal">True</span>，必须的字段都变为选填字段</span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure>

<p><code>partial=True</code>的本质就是使字段 <code>required=True</code> 校验规则失效</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/05/06/django-shi-tu-kai-fa-restful-api-jie-kou/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/06/django-shi-tu-kai-fa-restful-api-jie-kou/" class="post-title-link" itemprop="url">原生 django视图序列化RESTful API接口</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-05-05 16:21:41" itemprop="dateCreated datePublished" datetime="2021-05-05T16:21:41Z">2021-05-05</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-05-29 02:47:29" itemprop="dateModified" datetime="2021-05-29T02:47:29Z">2021-05-29</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/django/" itemprop="url" rel="index"><span itemprop="name">django</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>缺点：分页、排序、认证、权限、限流都需要自己实现</p>
</blockquote>
<p><code>JsonResponse</code> 和 <code>JsonResponse</code> 都能把传进来的参数直接化成一个字典 /json串？，<br>把响应头里面的<code>content_type</code>变成 <code>application/json</code></p>
<p>写法一</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django <span class="keyword">import</span> http</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> http.JsonResponse(data)</span><br><span class="line"><span class="keyword">return</span> http.HttpResponse(<span class="string">''</span>, status=<span class="number">200</span>)</span><br></pre></td></tr></tbody></table></figure>

<p>写法二</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse, JsonResponse</span><br><span class="line"></span><br><span class="line"><span class="comment"># In order to allow non-dict objects to be serialized set the safe parameter to False.</span></span><br><span class="line"><span class="keyword">return</span> JsonResponse(json.loads(json_data), safe=<span class="literal">False</span>)</span><br><span class="line"><span class="keyword">return</span> HttpResponse(json_data, content_type=<span class="string">'application/json'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> HttpResponse(json.dumps(json_list), content_type=<span class="string">'application/json'</span>)</span><br><span class="line"><span class="comment"># In order to allow non-dict objects to be serialized set the safe parameter to False.</span></span><br><span class="line"><span class="keyword">return</span> JsonResponse(json_list, safe=<span class="literal">False</span>)</span><br></pre></td></tr></tbody></table></figure>

<h3 id="FBV-Function-Based-View-基于函数的视图"><a href="#FBV-Function-Based-View-基于函数的视图" class="headerlink" title="FBV Function Based View 基于函数的视图"></a>FBV Function Based View 基于函数的视图</h3><ul>
<li>对于 <code>POST</code> 请求，用装饰器，取消csrf的限制，就不用 <code>setting</code> 里面去注释掉了<br><code>request.body</code>请求体里面所有数据，为json字符串，bytes类型</li>
</ul>
<p><code>course\views.py</code><br>下面两种方法等价</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> JsonResponse</span><br><span class="line"><span class="comment"># 对于POST请求，用装饰器，取消csrf的限制，就不用setting里面去注释掉了</span></span><br><span class="line"><span class="keyword">from</span> django.views.decorators.csrf <span class="keyword">import</span> csrf_exempt</span><br><span class="line"></span><br><span class="line">course_dict = {<span class="string">'name'</span>: <span class="string">"课程"</span>, <span class="string">'introduction'</span>: <span class="string">"课程简介"</span>, <span class="string">'price'</span>: <span class="string">"课程价格"</span>}</span><br><span class="line"></span><br><span class="line"><span class="meta">@csrf_exempt</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">course_list</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'GET'</span>:</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(course_dict)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</span><br><span class="line">        course = json.loads(request.body.decode(<span class="string">'utf-8'</span>))</span><br><span class="line">        <span class="comment"># 解析数据不是字典而是字符串类型，要safe=False</span></span><br><span class="line">        <span class="keyword">return</span> JsonResponse(course, safe=<span class="literal">False</span>)  <span class="comment"># safe默认True</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse</span><br><span class="line"><span class="comment"># 对于POST请求，用装饰器，取消csrf的限制，就不用setting里面去注释掉了。</span></span><br><span class="line"><span class="keyword">from</span> django.views.decorators.csrf <span class="keyword">import</span> csrf_exempt</span><br><span class="line"></span><br><span class="line">course_dict = {<span class="string">'name'</span>: <span class="string">"课程"</span>, <span class="string">'introduction'</span>: <span class="string">"课程简介"</span>, <span class="string">'price'</span>: <span class="string">"课程价格"</span>}</span><br><span class="line"></span><br><span class="line"><span class="meta">@csrf_exempt</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">course_list</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'GET'</span>:</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(json.dumps(course_dict), content_type=<span class="string">'application/json'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</span><br><span class="line">        course = json.loads(request.body.decode(<span class="string">'utf-8'</span>))</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(json.dumps(course), content_type=<span class="string">'application/json'</span>)</span><br></pre></td></tr></tbody></table></figure>

<h3 id="CBV-Classed-Based-View-基于类的视图"><a href="#CBV-Classed-Based-View-基于类的视图" class="headerlink" title="CBV Classed Based View 基于类的视图"></a>CBV Classed Based View 基于类的视图</h3><figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> JsonResponse</span><br><span class="line"><span class="keyword">from</span> django.views <span class="keyword">import</span> View</span><br><span class="line"><span class="keyword">from</span> django.views.decorators.csrf <span class="keyword">import</span> csrf_exempt</span><br><span class="line"></span><br><span class="line">course_dict = {<span class="string">'name'</span>: <span class="string">"课程"</span>, <span class="string">'introduction'</span>: <span class="string">"课程简介"</span>, <span class="string">'price'</span>: <span class="string">"课程价格"</span>}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CourseList</span>(<span class="params">View</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        <span class="keyword">return</span> JsonResponse(course_dict)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @csrf_exempt</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        course = json.loads(request.body.decode(<span class="string">'utf-8'</span>))  <span class="comment"># 解析数据不是字典而是字符串类型，要safe=False</span></span><br><span class="line">        <span class="keyword">return</span> JsonResponse(course, safe=<span class="literal">False</span>)  <span class="comment"># safe默认True</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Json</span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse</span><br><span class="line"><span class="keyword">from</span> django.views <span class="keyword">import</span> View</span><br><span class="line"><span class="keyword">from</span> django.views.decorators.csrf <span class="keyword">import</span> csrf_exempt</span><br><span class="line"></span><br><span class="line">course_dict = {<span class="string">'name'</span>: <span class="string">"课程"</span>, <span class="string">'introduction'</span>: <span class="string">"课程简介"</span>, <span class="string">'price'</span>: <span class="string">"课程价格"</span>}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CourseList</span>(<span class="params">View</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(json.dumps(course_dict), content_type=<span class="string">'application/json'</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @csrf_exempt</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        course = json.loads(request.body.decode(<span class="string">'utf-8'</span>))</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(json.dumps(course), content_type=<span class="string">'application/json'</span>)</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.views <span class="keyword">import</span> View</span><br><span class="line"><span class="keyword">from</span> django.utils.decorators <span class="keyword">import</span> method_decorator</span><br><span class="line">course_dict = {<span class="string">'name'</span>: <span class="string">"课程"</span>, <span class="string">'introduction'</span>: <span class="string">"课程简介"</span>, <span class="string">'price'</span>: <span class="string">"课程价格"</span>}</span><br><span class="line"></span><br><span class="line"><span class="meta">@method_decorator(csrf_exempt, name='dispatch')  # 不是post，是由django的请求响应原理决定的，</span></span><br><span class="line"><span class="comment"># 当http request拿到的时候，首先到达dispatch方法，通过dispatch方法处理后再找到post方法</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CourseList</span>(<span class="params">View</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        <span class="keyword">return</span> JsonResponse(course_dict)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        course = json.loads(request.body.decode(<span class="string">'utf-8'</span>))  <span class="comment"># 解析数据不是字典而是字符串类型，要safe=False</span></span><br><span class="line">        <span class="keyword">return</span> JsonResponse(course, safe=<span class="literal">False</span>)  <span class="comment"># safe默认True</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="视图实现商品列表-最好用序列化"><a href="#视图实现商品列表-最好用序列化" class="headerlink" title="视图实现商品列表 最好用序列化"></a>视图实现商品列表 最好用序列化</h3><h4 id="麻烦的方法"><a href="#麻烦的方法" class="headerlink" title="麻烦的方法"></a>麻烦的方法</h4><p>通过在新建列表、其元素为单个商品信息组成的字典，当字段比较多时，一个字段一个字段的提取</p>
<p>有些字段不能直接用<code>json.dumps()</code>方法序列化，如datetime，会报错<code>TypeError: Object of type date is not JSON serializable</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.views.generic <span class="keyword">import</span> View</span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse, JsonResponse</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> goods.models <span class="keyword">import</span> Goods</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GoodsListView</span>(<span class="params">View</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        json_list = []</span><br><span class="line">        <span class="comment"># 获取所有商品</span></span><br><span class="line">        goods = Goods.objects.all()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> good <span class="keyword">in</span> goods:</span><br><span class="line">            json_dict = {}</span><br><span class="line">            <span class="comment"># 获取商品的每个字段，键值对形式</span></span><br><span class="line">            json_dict[<span class="string">'name'</span>] = good.name</span><br><span class="line">            json_dict[<span class="string">'category'</span>] = good.category.name</span><br><span class="line">            json_dict[<span class="string">'market_price'</span>] = good.market_price</span><br><span class="line">            json_list.append(json_dict)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># HttpResponse返回json，一定要指定类型content_type='application/json'</span></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(json.dumps(json_list), content_type=<span class="string">'application/json'</span>)</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.views.generic <span class="keyword">import</span> View</span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse, JsonResponse</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> goods.models <span class="keyword">import</span> Goods</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GoodsListView</span>(<span class="params">View</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        json_list = []</span><br><span class="line">        <span class="comment"># 获取所有商品</span></span><br><span class="line">        goods = Goods.objects.all()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> good <span class="keyword">in</span> goods:</span><br><span class="line">            json_dict = {}</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 获取商品的每个字段，键值对形式</span></span><br><span class="line">            json_dict[<span class="string">'name'</span>] = good.name</span><br><span class="line">            json_dict[<span class="string">'category'</span>] = good.category.name</span><br><span class="line">            json_dict[<span class="string">'market_price'</span>] = good.market_price</span><br><span class="line">            json_list.append(json_dict)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> JsonResponse(json_list, safe=<span class="literal">False</span>)</span><br></pre></td></tr></tbody></table></figure>

<h4 id="model-to-dict-实现直接将模型数据转化为字典形式"><a href="#model-to-dict-实现直接将模型数据转化为字典形式" class="headerlink" title="model_to_dict()实现直接将模型数据转化为字典形式"></a><code>model_to_dict()</code>实现直接将模型数据转化为字典形式</h4><p>但是对于<code>DateTimeField</code>、<code>ImageField</code>等字段时还是无法序列化</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.views.generic <span class="keyword">import</span> View</span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse, JsonResponse</span><br><span class="line"><span class="keyword">from</span> django.forms.models <span class="keyword">import</span> model_to_dict</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> goods.models <span class="keyword">import</span> Goods</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GoodsListView</span>(<span class="params">View</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        json_list = []</span><br><span class="line">        <span class="comment"># 获取所有商品</span></span><br><span class="line">        goods = Goods.objects.all()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> good <span class="keyword">in</span> goods:</span><br><span class="line">            json_dict = model_to_dict(good)</span><br><span class="line">            json_list.append(json_dict)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># HttpResponse返回json，一定要指定类型content_type='application/json'</span></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(json.dumps(json_list), content_type=<span class="string">'application/json'</span>)</span><br><span class="line">        <span class="comment"># return JsonResponse(json_list, safe=False)</span></span><br></pre></td></tr></tbody></table></figure>

<p>users/view.py</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">users</span>(<span class="params">request</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</span><br><span class="line">        course = json.loads(request.body.decode(<span class="string">'utf-8'</span>))</span><br><span class="line">        <span class="comment"># 解析数据不是字典而是字符串类型，要safe=False</span></span><br><span class="line">        <span class="keyword">return</span> JsonResponse(course, safe=<span class="literal">False</span>)  <span class="comment"># safe默认True</span></span><br></pre></td></tr></tbody></table></figure><script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/05/06/drf-shu-ju-fen-ye/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/06/drf-shu-ju-fen-ye/" class="post-title-link" itemprop="url">DRF数据分页</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-05-05 16:21:41" itemprop="dateCreated datePublished" datetime="2021-05-05T16:21:41Z">2021-05-05</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-06-05 08:08:08" itemprop="dateModified" datetime="2021-06-05T08:08:08Z">2021-06-05</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/django/" itemprop="url" rel="index"><span itemprop="name">django</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="数据分页"><a href="#数据分页" class="headerlink" title="数据分页"></a>数据分页</h3><p>在使用GET请求获取资源列表时，我们通常不会一次性的加载所有的数据，除非数据量真的很小。<br>大多数获取资源列表的操作都支持数据分页展示，<br>也就说我们可以通过指定页码（或类似于页码的标识）和页面大小（一次加载多少条数据）来获取不同的数据。<br>我们可以通过对<code>QuerySet</code>对象的切片操作来实现分页，也可以利用Django框架封装的<code>Paginator</code>和<code>Page</code>对象来实现分页。</p>
<p><code>rest_framework/settings.py</code>源码 DRF 默认分页</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Generic view behavior</span></span><br><span class="line"><span class="string">'DEFAULT_PAGINATION_CLASS'</span>: <span class="literal">None</span>,  <span class="comment"># 默认没有分页功能</span></span><br><span class="line"><span class="string">'DEFAULT_FILTER_BACKENDS'</span>: (),</span><br><span class="line"></span><br><span class="line"><span class="comment"># Pagination</span></span><br><span class="line"><span class="string">'PAGE_SIZE'</span>: <span class="literal">None</span>,</span><br></pre></td></tr></tbody></table></figure>

<p>使用DRF时，可以在Django配置文件中修改<code>REST_FRAMEWORK</code>并配置默认的分页类和页面大小来实现分页，<br>包括了总数、当前页的上一页、下一页等信息，并且图片地址也添加了域名、成为可访问的完整路径。</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">REST_FRAMEWORK = {</span><br><span class="line">    <span class="string">'PAGE_SIZE'</span>: <span class="number">10</span>,  <span class="comment"># #每页显示的个数</span></span><br><span class="line">    <span class="string">'DEFAULT_PAGINATION_CLASS'</span>: <span class="string">'rest_framework.pagination.PageNumberPagination'</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>除了上面配置的<code>PageNumberPagination</code>分页器之外，DRF还提供了<code>LimitOffsetPagination</code>和<code>CursorPagination</code>分页器，值得一提的是<code>CursorPagination</code>，它可以避免使用页码分页时暴露网站的数据体量，有兴趣的读者可以自行了解。</p>
<p>如果不希望使用配置文件中默认的分页设定，可以在视图类中添加一个<code>pagination_class</code>属性来重新指定分页器，通常可以将该属性指定为自定义的分页器，如下所示。</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.pagination <span class="keyword">import</span> PageNumberPagination</span><br><span class="line"><span class="keyword">from</span> django.utils.translation <span class="keyword">import</span> ugettext_lazy</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CustomizedPagination</span>(<span class="params">PageNumberPagination</span>):</span></span><br><span class="line">    page_size = <span class="number">5</span>  <span class="comment"># 默认每页显示的个数</span></span><br><span class="line">    max_page_size = <span class="number">50</span>  <span class="comment"># 最多能显示多少页</span></span><br><span class="line">    page_size_query_param = <span class="string">'size'</span>  <span class="comment"># 页面大小对应的查询参数</span></span><br><span class="line">    page_query_param = <span class="string">'page'</span>  <span class="comment"># 页码参数</span></span><br><span class="line">    page_query_description = ugettext_lazy(<span class="string">'使用分页后的页码'</span>)  <span class="comment"># 分页文档中文描述</span></span><br><span class="line">    page_size_query_description = ugettext_lazy(<span class="string">'每页返回的结果数'</span>)</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SubjectView</span>(<span class="params">ListAPIView</span>):</span></span><br><span class="line">    <span class="comment"># 指定如何获取数据</span></span><br><span class="line">    queryset = Subject.objects.all()</span><br><span class="line">    <span class="comment"># 指定如何序列化数据</span></span><br><span class="line">    serializer_class = SubjectSerializer</span><br><span class="line">    <span class="comment"># 指定如何分页</span></span><br><span class="line">    pagination_class = CustomizedPagination</span><br></pre></td></tr></tbody></table></figure>

<p>如果不希望数据分页，可以将<code>pagination_class</code>属性设置为<code>None</code>来取消默认的分页器。</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://bubbleboy11.github.io/2021/05/06/drf-shi-tu-kai-fa-restfulapi-jie-kou-de-fang-shi/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="外心人D">
      <meta itemprop="description" content="本博客大多内容为慕课和网上博客，并非原创">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外心人D的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/06/drf-shi-tu-kai-fa-restfulapi-jie-kou-de-fang-shi/" class="post-title-link" itemprop="url">DRF视图开发RESTful API接口的方式</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-05-05 16:21:41" itemprop="dateCreated datePublished" datetime="2021-05-05T16:21:41Z">2021-05-05</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-06-07 12:17:32" itemprop="dateModified" datetime="2021-06-07T12:17:32Z">2021-06-07</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/django/" itemprop="url" rel="index"><span itemprop="name">django</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="DRF视图开发RESTful-API接口的方式"><a href="#DRF视图开发RESTful-API接口的方式" class="headerlink" title="DRF视图开发RESTful API接口的方式"></a>DRF视图开发RESTful API接口的方式</h1><blockquote>
<p>优点：集成了分页、排序、认证、权限、限流、文档生成，form和request bosy的输入检测<br>身份验证策略，包括OAuth1a和OAuth2的软件包；<br>支持ORM和非ORM数据源的序列化；<br>完全可自定义；<br>广泛的文档资料以及强大的社区支持。</p>
</blockquote>
<h2 id="基于函数的视图-Function-Based-View"><a href="#基于函数的视图-Function-Based-View" class="headerlink" title="基于函数的视图 Function Based View"></a>基于函数的视图 Function Based View</h2><p>灵活，一个接口对应一个函数，面向过程的方式重复率高，要自己实现的东西多</p>
<p><code>queryset = None</code>属性或者 <code>get_queryset(self)</code>方法 指定如何获取数据，后者继承 <code>GenericAPIView</code><br><code>serializer_class = None</code> 指定对应的Serializers如何序列化数据</p>
<h3 id="获取所有课程信息或新增一个课程"><a href="#获取所有课程信息或新增一个课程" class="headerlink" title="获取所有课程信息或新增一个课程"></a>获取所有课程信息或新增一个课程</h3><p><code>course\views.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> status</span><br><span class="line"><span class="keyword">from</span> rest_framework.authentication <span class="keyword">import</span> BasicAuthentication, SessionAuthentication, TokenAuthentication</span><br><span class="line"><span class="keyword">from</span> rest_framework.decorators <span class="keyword">import</span> api_view, authentication_classes, permission_classes</span><br><span class="line"><span class="keyword">from</span> rest_framework.permissions <span class="keyword">import</span> IsAuthenticated</span><br><span class="line"><span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Course</span><br><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> CourseSerializer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">"""一、 函数式编程 Function Based View"""</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@api_view(["GET", "POST"])</span></span><br><span class="line"><span class="meta">@authentication_classes(</span></span><br><span class="line">    (BasicAuthentication, SessionAuthentication, TokenAuthentication))</span><br><span class="line"><span class="meta">@permission_classes((IsAuthenticated, ))</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">course_list</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    获取所有课程信息或新增一个课程</span></span><br><span class="line"><span class="string">    :param request:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">"GET"</span>:</span><br><span class="line">        <span class="comment"># 创建序列化器对象并指定要序列化的模型，序列化课程的所有字段</span></span><br><span class="line">        s = CourseSerializer(instance=Course.objects.all(), many=<span class="literal">True</span>)</span><br><span class="line">        <span class="comment"># 通过序列化器从模型类里面拿到数据的data属性获得模型对应的字典并通过创建Response对象返回JSON格式的数据</span></span><br><span class="line">        print(type(request), type(request.data), type(s), type(s.data))</span><br><span class="line">        <span class="comment"># &lt;class 'rest_framework.request.Request'&gt; &lt;class 'dict'&gt; &lt;class 'rest_framework.serializers.ListSerializer'&gt; &lt;class 'rest_framework.utils.serializer_helpers.ReturnList'&gt;</span></span><br><span class="line">        <span class="keyword">return</span> Response(data=s.data, status=status.HTTP_200_OK)  <span class="comment"># 获取当然有返回对应的数据给前端</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">elif</span> request.method == <span class="string">"POST"</span>:</span><br><span class="line">        <span class="comment"># 反序列化：前端POST过来的数据request.data转换成django能够识别的queryset或模型类实例instance</span></span><br><span class="line">        s = CourseSerializer(data=request.data)</span><br><span class="line">        <span class="comment"># partial=True属性适用于非必填的字段部分更新用，前端传递的数据比django ORM的模型类的字段要少</span></span><br><span class="line">        <span class="comment"># 如果把这个字段设置为主键或必填的字段（没有设置null=True，blank=True），那前端必须传过来，否则is_valid()为False</span></span><br><span class="line">        <span class="comment"># 对数据进行校验是否符合定义的字段属性再返回</span></span><br><span class="line">        <span class="keyword">if</span> s.is_valid():</span><br><span class="line">            <span class="comment"># 模型类.save()方法会调用create()函数保存对象实例，相当于执行了创建数据的sql语句，序列化时只可读属性前端不能传过来</span></span><br><span class="line">            <span class="comment"># quest可以获取当前登录的用户，是哪一个用户post过来的就把它设为讲师，</span></span><br><span class="line">            <span class="comment"># 因为前端用户已经登录了，POST创建的course实例数据时没有teacher这个外键字段的，但又是模型类必填的，把课程信息的讲师设为自己登录的这个用户</span></span><br><span class="line">            s.save(teacher=request.user)</span><br><span class="line">            print(type(request), type(request.data), type(s), type(s.data))</span><br><span class="line">            <span class="comment"># &lt;class 'rest_framework.request.Request'&gt; &lt;class 'dict'&gt; &lt;class 'course.serializers.CourseSerializer'&gt; &lt;class 'rest_framework.utils.serializer_helpers.ReturnDict'&gt;</span></span><br><span class="line">            <span class="keyword">return</span> Response(data=s.data,</span><br><span class="line">                            status=status.HTTP_201_CREATED)  <span class="comment"># 反序列化后的数据返回给前端</span></span><br><span class="line">        <span class="keyword">return</span> Response(s.errors, status=status.HTTP_400_BAD_REQUEST)  <span class="comment"># 新增当然有返回对应的数据给前端</span></span><br></pre></td></tr></tbody></table></figure>

<p>配置URL映射 <code>course\urls.py</code> 域名：应该尽量将 API 部署在专用域名之</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path, include</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> course <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    <span class="comment"># Function Based View</span></span><br><span class="line">    <span class="comment"># 获取所有课程信息或新增一个课程</span></span><br><span class="line">    path(<span class="string">"fbv/list/"</span>, views.course_list, name=<span class="string">"fbv-list"</span>),</span><br><span class="line">]</span><br></pre></td></tr></tbody></table></figure>
<p>DRF本身自带了一套页面，可以方便我们查看我们使用DRF定制的数据接口，如下图所示。<br><img src="/2021/05/06/drf-shi-tu-kai-fa-restfulapi-jie-kou-de-fang-shi/0.png" alt="http://127.0.0.1:8000/course/fbv/list/"></p>
<p>POST请求添加数据</p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"Python体验课"</span>,</span><br><span class="line">    <span class="attr">"introduction"</span>: <span class="string">"9元包邮"</span>,</span><br><span class="line">    <span class="attr">"price"</span>: <span class="string">"9.00"</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><code>id</code> 不需要，<code>teacher</code> 是当前已登录的用户，<code>created_at</code> 和 <code>updated_at</code> django ORM 会自动加上</p>
<p><img src="/2021/05/06/drf-shi-tu-kai-fa-restfulapi-jie-kou-de-fang-shi/2.png" alt="description"></p>
<h3 id="获取一个课程的详细信息、更新、删除一个课程"><a href="#获取一个课程的详细信息、更新、删除一个课程" class="headerlink" title="获取一个课程的详细信息、更新、删除一个课程"></a>获取一个课程的详细信息、更新、删除一个课程</h3><p><code>course\views.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> status</span><br><span class="line"><span class="keyword">from</span> rest_framework.authentication <span class="keyword">import</span> BasicAuthentication, SessionAuthentication, TokenAuthentication</span><br><span class="line"><span class="keyword">from</span> rest_framework.decorators <span class="keyword">import</span> api_view, authentication_classes, permission_classes</span><br><span class="line"><span class="keyword">from</span> rest_framework.permissions <span class="keyword">import</span> IsAuthenticated</span><br><span class="line"><span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Course</span><br><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> CourseSerializer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">"""一、 函数式编程 Function Based View"""</span></span><br><span class="line"><span class="meta">@api_view(["GET", "PUT", "DELETE"])</span></span><br><span class="line"><span class="comment"># 对象级别的设置优先全局设置</span></span><br><span class="line"><span class="meta">@authentication_classes(</span></span><br><span class="line">    (BasicAuthentication, SessionAuthentication, TokenAuthentication))</span><br><span class="line"><span class="meta">@permission_classes((IsAuthenticated, ))</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">course_detail</span>(<span class="params">request, pk</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    获取一个课程的详细信息、更新、删除一个课程</span></span><br><span class="line"><span class="string">    :param request:</span></span><br><span class="line"><span class="string">    :param pk: url传递过来的主键</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 通过pk获取课程的queryset</span></span><br><span class="line">        course = Course.objects.get(pk=pk)</span><br><span class="line">    <span class="keyword">except</span> Course.DoesNotExist:  <span class="comment"># 前端传递过来的pk在数据表查不到，不存在</span></span><br><span class="line">        <span class="keyword">return</span> Response(data={<span class="string">"msg"</span>: <span class="string">"没有此课程信息"</span>},</span><br><span class="line">                        status=status.HTTP_404_NOT_FOUND)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">if</span> request.method == <span class="string">"GET"</span>:</span><br><span class="line">            s = CourseSerializer(instance=course)</span><br><span class="line">            print(type(request), type(request.data), type(s), type(s.data))</span><br><span class="line">            <span class="comment"># &lt;class 'rest_framework.request.Request'&gt; &lt;class 'dict'&gt; &lt;class 'course.serializers.CourseSerializer'&gt; &lt;class 'rest_framework.utils.serializer_helpers.ReturnDict'&gt;</span></span><br><span class="line">            <span class="keyword">return</span> Response(data=s.data, status=status.HTTP_200_OK)  <span class="comment"># 获取当然有返回对应的数据给前端</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span> request.method == <span class="string">"PUT"</span>:</span><br><span class="line">            s = CourseSerializer(instance=course, data=request.data)</span><br><span class="line">            <span class="comment"># `instance` 要序列化的查询集实例，要序列化的 `course` 是查询出来的实例</span></span><br><span class="line">            <span class="comment"># `data` 数据哪里来的，`request.data` 是前端传递过来的数据，，就是Postman body里面 raw-json的数据</span></span><br><span class="line">            <span class="comment"># 把`data`的数据序列化后保存或跟新到 `course` 这个对象里面</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> s.is_valid():</span><br><span class="line">                s.save()  <span class="comment"># 不用像POST请求一样设置teacher字段为当前登录的用户，</span></span><br><span class="line">                <span class="comment"># PUT为更新操作，这条数据teacher字段已经有了并且是登录用户，是当前登录用户更改自己的数据，不能把别人的课程改成自己是讲师</span></span><br><span class="line">                print(type(request), type(request.data), type(s), type(s.data))</span><br><span class="line">                <span class="comment"># &lt;class 'rest_framework.request.Request'&gt; &lt;class 'dict'&gt; &lt;class 'course.serializers.CourseSerializer'&gt; &lt;class 'rest_framework.utils.serializer_helpers.ReturnDict'&gt;</span></span><br><span class="line">                <span class="keyword">return</span> Response(data=s.data, status=status.HTTP_200_OK)  <span class="comment"># 更新当然有返回数据</span></span><br><span class="line">            <span class="keyword">return</span> Response(data=s.errors, status=status.HTTP_400_BAD_REQUEST)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span> request.method == <span class="string">"DELETE"</span>:</span><br><span class="line">            course.delete()</span><br><span class="line">            <span class="keyword">return</span> Response(status=status.HTTP_204_NO_CONTENT)  <span class="comment"># 删除不返回数据，只返回状态码</span></span><br></pre></td></tr></tbody></table></figure>

<p>配置URL映射<code>course\urls.py</code> 域名：应该尽量将 API 部署在专用域名之</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path, include</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> course <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    <span class="comment"># Function Based View</span></span><br><span class="line">    <span class="comment"># 获取一个课程的详细信息、更新、删除一个课程，类型是int，名称是pk</span></span><br><span class="line">    path(<span class="string">"fbv/detail/&lt;int:pk&gt;/"</span>, views.course_detail, name=<span class="string">"fbv-detail"</span>),  <span class="comment"># 结尾的/不能少</span></span><br><span class="line">]</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/05/06/drf-shi-tu-kai-fa-restfulapi-jie-kou-de-fang-shi/3.png" alt="'http://127.0.0.1:8000/course/fbv/detail/1/'"></p>
<h2 id="基于类的视图-Classed-Based-View-继承APIView的子类"><a href="#基于类的视图-Classed-Based-View-继承APIView的子类" class="headerlink" title="基于类的视图 Classed Based View 继承APIView的子类"></a>基于类的视图 Classed Based View 继承<code>APIView</code>的子类</h2><p>可以用到python类的特性，封装继承多态，减少代码重复率<br>如果不定义HTTP方法，默认不接受改请求<br>可以通过pycharm External Libraries - Lib - site-packages - rest_framework-generics.py选中 - 旁边的structure<br>列出所有的APIView可以继承</p>
<p><code>APIViw</code>源码的常用属性和方法</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">APIView</span>(<span class="params">View</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># The following policies may be set at either globally, or per-view.</span></span><br><span class="line">    renderer_classes = api_settings.DEFAULT_RENDERER_CLASSES</span><br><span class="line">    parser_classes = api_settings.DEFAULT_PARSER_CLASSES</span><br><span class="line">    authentication_classes = api_settings.DEFAULT_AUTHENTICATION_CLASSES</span><br><span class="line">    throttle_classes = api_settings.DEFAULT_THROTTLE_CLASSES</span><br><span class="line">    permission_classes = api_settings.DEFAULT_PERMISSION_CLASSES</span><br><span class="line">    content_negotiation_class = api_settings.DEFAULT_CONTENT_NEGOTIATION_CLASS</span><br><span class="line">    metadata_class = api_settings.DEFAULT_METADATA_CLASS</span><br><span class="line">    versioning_class = api_settings.DEFAULT_VERSIONING_CLASS</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_authenticators</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        Instantiates and returns the list of authenticators that this view can use.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">return</span> [auth() <span class="keyword">for</span> auth <span class="keyword">in</span> self.authentication_classes]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_permissions</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        Instantiates and returns the list of permissions that this view requires.</span></span><br><span class="line"><span class="string">        遍历此视图所需的权限列表并实例化返回。</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">return</span> [permission() <span class="keyword">for</span> permission <span class="keyword">in</span> self.permission_classes]  <span class="comment"># 一定要加()表明返回它的实例</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_throttles</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        Instantiates and returns the list of throttles that this view uses.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">return</span> [throttle() <span class="keyword">for</span> throttle <span class="keyword">in</span> self.throttle_classes]</span><br></pre></td></tr></tbody></table></figure>

<p>代码简单，开发效率高，<br>没有FBV（基于函数的视图）灵活，因为使用FBV的方式，数据接口对应的视图函数执行什么样的代码以及返回什么的数据是高度可定制的。</p>
<p>类定义的注释的内容<code>""" """</code>，在后面生成drf文档的时候会显示出来，所有要写清楚</p>
<h3 id="获取所有课程信息或新增一个课程-1"><a href="#获取所有课程信息或新增一个课程-1" class="headerlink" title="获取所有课程信息或新增一个课程"></a>获取所有课程信息或新增一个课程</h3><p><code>course\views.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> status</span><br><span class="line"><span class="keyword">from</span> rest_framework.authentication <span class="keyword">import</span> BasicAuthentication, SessionAuthentication, TokenAuthentication</span><br><span class="line"><span class="keyword">from</span> rest_framework.decorators <span class="keyword">import</span> permission_classes</span><br><span class="line"><span class="keyword">from</span> rest_framework.permissions <span class="keyword">import</span> IsAuthenticated</span><br><span class="line"><span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> APIView</span><br><span class="line"><span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Course</span><br><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> CourseSerializer</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CourseListView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="comment"># 获取所有课程信息或新增一个课程</span></span><br><span class="line">    authentication_classes = (BasicAuthentication, SessionAuthentication, TokenAuthentication)</span><br><span class="line">    permission_classes = (IsAuthenticated, )  <span class="comment"># settings.py中已设置，此处是多余的</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        获取数据列表并返回JSON数据</span></span><br><span class="line"><span class="string">        :param request:</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        queryset = Course.objects.all()</span><br><span class="line">        s = CourseSerializer(instance=queryset, many=<span class="literal">True</span>)  <span class="comment"># 这里是instance = xx 查询集</span></span><br><span class="line">        print(type(request), type(request.data), type(s), type(s.data))</span><br><span class="line">        <span class="comment"># &lt;class 'rest_framework.request.Request'&gt; &lt;class 'dict'&gt; &lt;class 'rest_framework.serializers.ListSerializer'&gt; &lt;class 'rest_framework.utils.serializer_helpers.ReturnList'&gt;</span></span><br><span class="line">        <span class="keyword">return</span> Response(s.data, status=status.HTTP_200_OK)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        :param request:</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        s = CourseSerializer(</span><br><span class="line">            data=request.data)  <span class="comment"># 这里是data = xx, return前要先调用.is_valid()</span></span><br><span class="line">        <span class="keyword">if</span> s.is_valid():</span><br><span class="line">            s.save(teacher=self.request.user)  <span class="comment"># 外键teacher</span></span><br><span class="line">            print(type(request.data), type(s), type(s.data))</span><br><span class="line">            <span class="comment"># &lt;class 'dict'&gt; &lt;class 'course.serializers.CourseSerializer'&gt; &lt;class 'rest_framework.utils.serializer_helpers.ReturnDict'&gt;</span></span><br><span class="line">            <span class="keyword">return</span> Response(data=s.data, status=status.HTTP_201_CREATED)</span><br><span class="line">        <span class="keyword">return</span> Response(data=s.errors, status=status.HTTP_400_BAD_REQUEST)</span><br></pre></td></tr></tbody></table></figure>

<p><code>course\urls.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">urlpatterns = [</span><br><span class="line">    <span class="comment"># Class Based View</span></span><br><span class="line">    path(<span class="string">"cbv/list/"</span>, views.CourseListView.as_view(), name=<span class="string">"cbv-list"</span>),</span><br><span class="line">]</span><br></pre></td></tr></tbody></table></figure>

<h3 id="获取一个课程的详细信息、更新、删除一个课程-1"><a href="#获取一个课程的详细信息、更新、删除一个课程-1" class="headerlink" title="获取一个课程的详细信息、更新、删除一个课程"></a>获取一个课程的详细信息、更新、删除一个课程</h3><p><code>course\views.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> status</span><br><span class="line"><span class="keyword">from</span> rest_framework.authentication <span class="keyword">import</span> BasicAuthentication, SessionAuthentication, TokenAuthentication</span><br><span class="line"><span class="keyword">from</span> rest_framework.decorators <span class="keyword">import</span> permission_classes</span><br><span class="line"><span class="keyword">from</span> rest_framework.permissions <span class="keyword">import</span> IsAuthenticated</span><br><span class="line"><span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> APIView</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CourseDetailView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    authentication_classes = (BasicAuthentication, SessionAuthentication, TokenAuthentication)</span><br><span class="line">    permission_classes = (IsAuthenticated, )</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod  # 没有用到self</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_object</span>(<span class="params">pk</span>):</span></span><br><span class="line">        <span class="comment"># 获取实例对象</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> Course.objects.get(pk=pk)</span><br><span class="line">        <span class="keyword">except</span> Course.DoesNotExist:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request, pk</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        :param request:</span></span><br><span class="line"><span class="string">        :param pk:</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        obj = self.get_object(pk=pk)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> obj:</span><br><span class="line">            <span class="keyword">return</span> Response(data={<span class="string">"msg"</span>: <span class="string">"没有此课程信息"</span>},</span><br><span class="line">                            status=status.HTTP_404_NOT_FOUND)</span><br><span class="line"></span><br><span class="line">        s = CourseSerializer(instance=obj)</span><br><span class="line">        <span class="keyword">return</span> Response(s.data, status=status.HTTP_200_OK)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put</span>(<span class="params">self, request, pk</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        :param request:</span></span><br><span class="line"><span class="string">        :param pk:</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        obj = self.get_object(pk=pk)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> obj:</span><br><span class="line">            <span class="keyword">return</span> Response(data={<span class="string">"msg"</span>: <span class="string">"没有此课程信息"</span>},</span><br><span class="line">                            status=status.HTTP_404_NOT_FOUND)</span><br><span class="line"></span><br><span class="line">        s = CourseSerializer(instance=obj, data=request.data)  <span class="comment"># 反序列化</span></span><br><span class="line">        <span class="keyword">if</span> s.is_valid():</span><br><span class="line">            s.save()</span><br><span class="line">            <span class="keyword">return</span> Response(data=s.data, status=status.HTTP_200_OK)</span><br><span class="line">        <span class="keyword">return</span> Response(data=s.errors, status=status.HTTP_400_BAD_REQUEST)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">self, request, pk</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        :param request:</span></span><br><span class="line"><span class="string">        :param pk:</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        obj = self.get_object(pk=pk)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> obj:</span><br><span class="line">            <span class="keyword">return</span> Response(data={<span class="string">"msg"</span>: <span class="string">"没有此课程信息"</span>},</span><br><span class="line">                            status=status.HTTP_404_NOT_FOUND)</span><br><span class="line">        obj.delete()</span><br><span class="line">        <span class="keyword">return</span> Response(status=status.HTTP_204_NO_CONTENT)</span><br></pre></td></tr></tbody></table></figure>

<p><code>course\urls.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">urlpatterns = [</span><br><span class="line">    <span class="comment"># Class Based View</span></span><br><span class="line">    path(<span class="string">"cbv/detail/&lt;int:pk&gt;/"</span>,</span><br><span class="line">         views.CourseDetailView.as_view(),</span><br><span class="line">         name=<span class="string">"cbv-detail"</span>),</span><br><span class="line">]</span><br></pre></td></tr></tbody></table></figure>

<h2 id="通用类视图-Generic-Classed-Based-View-GenericAPIView-整合了增删改查的类"><a href="#通用类视图-Generic-Classed-Based-View-GenericAPIView-整合了增删改查的类" class="headerlink" title="通用类视图 Generic Classed Based View GenericAPIView 整合了增删改查的类"></a>通用类视图 Generic Classed Based View <code>GenericAPIView</code> 整合了增删改查的类</h2><p>This class extends REST framework’s <code>APIView</code> class, adding commonly required behavior for standard list and detail views.</p>
<p>Each of the concrete generic views provided is built by combining <code>GenericAPIView</code>, with one or more mixin classes.</p>
<h3 id="Attributes"><a href="#Attributes" class="headerlink" title="Attributes"></a>Attributes</h3><p>Basic settings:</p>
<p>The following attributes control the basic view behavior.</p>
<ul>
<li><p><code>queryset</code> - The queryset that should be used for returning objects from this view. Typically, you must either set this attribute, or override the <code>get_queryset()</code> method. If you are overriding a view method, it is important that you call <code>get_queryset()</code> instead of accessing this property directly, as <code>queryset</code> will get evaluated once, and those results will be cached for all subsequent requests.用于从视图返回对象的查询结果集。通常，你必须设置此属性或者重写 <code>get_queryset()</code> 方法。如果你重写了一个视图的方法，重要的是你应该调用 <code>get_queryset()</code> 方法而不是直接访问该属性，因为 <code>queryset</code> 将被计算一次，这些结果将为后续请求缓存起来。</p>
</li>
<li><p><code>serializer_class</code> - The serializer class that should be used for validating and deserializing input, and for serializing output. Typically, you must either set this attribute, or override the <code>get_serializer_class()</code> method.用于验证和反序列化输入以及用于序列化输出的Serializer类。 通常，你必须设置此属性或者重写<code>get_serializer_class()</code> 方法。</p>
</li>
<li><p><code>lookup_field</code> - The model field that should be used to for performing object lookup of individual model instances. Defaults to <code>'pk'</code>. Note that when using hyperlinked APIs you’ll need to ensure that both the API views and the serializer classes set the lookup fields if you need to use a custom value.用于执行单个模型实例的对象查找的模型字段，默认为 <code>'pk'</code>，即主键。 即查询单一数据库对象时使用的条件字段<br>请注意，在使用超链接API时，如果需要使用自定义的值，你需要确保在API视图和序列化类都设置查找字段。</p>
</li>
<li><p><code>lookup_url_kwarg</code> - The URL keyword argument that should be used for object lookup. The URL conf should include a keyword argument corresponding to this value. If unset this defaults to using the same value as <code>lookup_field</code>.应用于对象查找的URL关键字参数。它的 URL conf 应该包括一个与这个值相对应的关键字参数。如果取消设置，默认情况下使用与 <code>lookup_field</code>相同的值。</p>
</li>
</ul>
<p>源码</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GenericAPIView</span>(<span class="params">views.APIView</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Base class for all other generic views.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># You'll need to either set these attributes,</span></span><br><span class="line">    <span class="comment"># or override `get_queryset()`/`get_serializer_class()`.</span></span><br><span class="line">    <span class="comment"># If you are overriding a view method, it is important that you call</span></span><br><span class="line">    <span class="comment"># `get_queryset()` instead of accessing the `queryset` property directly,</span></span><br><span class="line">    <span class="comment"># as `queryset` will get evaluated only once, and those results are cached</span></span><br><span class="line">    <span class="comment"># for all subsequent requests.</span></span><br><span class="line">    queryset = <span class="literal">None</span></span><br><span class="line">    serializer_class = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># If you want to use object lookups other than pk, set 'lookup_field'.</span></span><br><span class="line">    <span class="comment"># For more complex lookup requirements override `get_object()`.</span></span><br><span class="line">    lookup_field = <span class="string">'pk'</span></span><br><span class="line">    lookup_url_kwarg = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># The filter backend classes to use for queryset filtering</span></span><br><span class="line">    filter_backends = api_settings.DEFAULT_FILTER_BACKENDS</span><br><span class="line"></span><br><span class="line">    <span class="comment"># The style to use for queryset pagination.</span></span><br><span class="line">    pagination_class = api_settings.DEFAULT_PAGINATION_CLASS</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_queryset</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        Get the list of items for this view.</span></span><br><span class="line"><span class="string">        This must be an iterable, and may be a queryset.</span></span><br><span class="line"><span class="string">        Defaults to using `self.queryset`.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        This method should always be used rather than accessing `self.queryset`</span></span><br><span class="line"><span class="string">        directly, as `self.queryset` gets evaluated only once, and those results</span></span><br><span class="line"><span class="string">        are cached for all subsequent requests.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        You may want to override this if you need to provide different</span></span><br><span class="line"><span class="string">        querysets depending on the incoming request.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        (Eg. return a list of items that is specific to the user)</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">assert</span> self.queryset <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>, (</span><br><span class="line">            <span class="string">"'%s' should either include a `queryset` attribute, "</span></span><br><span class="line">            <span class="string">"or override the `get_queryset()` method."</span></span><br><span class="line">            % self.__class__.__name__</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        queryset = self.queryset</span><br><span class="line">        <span class="keyword">if</span> isinstance(queryset, QuerySet):</span><br><span class="line">            <span class="comment"># Ensure queryset is re-evaluated on each request.</span></span><br><span class="line">            queryset = queryset.all()</span><br><span class="line">        <span class="keyword">return</span> queryset</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_object</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        Returns the object the view is displaying.返回视图显示的对象</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        You may want to override this if you need to provide non-standard</span></span><br><span class="line"><span class="string">        queryset lookups. 如果需要提供非标准的查询集查找，则可能需要重写此项</span></span><br><span class="line"><span class="string">        Eg if objects are referenced using multiple</span></span><br><span class="line"><span class="string">        keyword arguments in the url conf.</span></span><br><span class="line"><span class="string">        例如，如果在url conf中使用多个关键字参数引用对象。</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        queryset = self.filter_queryset(self.get_queryset())</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Perform the lookup filtering.</span></span><br><span class="line">        lookup_url_kwarg = self.lookup_url_kwarg <span class="keyword">or</span> self.lookup_field</span><br><span class="line"></span><br><span class="line">        <span class="keyword">assert</span> lookup_url_kwarg <span class="keyword">in</span> self.kwargs, (</span><br><span class="line">            <span class="string">'Expected view %s to be called with a URL keyword argument '</span></span><br><span class="line">            <span class="string">'named "%s". Fix your URL conf, or set the `.lookup_field` '</span></span><br><span class="line">            <span class="string">'attribute on the view correctly.'</span> %</span><br><span class="line">            (self.__class__.__name__, lookup_url_kwarg)</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        filter_kwargs = {self.lookup_field: self.kwargs[lookup_url_kwarg]}</span><br><span class="line">        obj = get_object_or_404(queryset, **filter_kwargs)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># May raise a permission denied</span></span><br><span class="line">        self.check_object_permissions(self.request, obj)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> obj</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_serializer</span>(<span class="params">self, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        Return the serializer instance that should be used for validating and</span></span><br><span class="line"><span class="string">        deserializing input, and for serializing output.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        serializer_class = self.get_serializer_class()</span><br><span class="line">        kwargs.setdefault(<span class="string">'context'</span>, self.get_serializer_context())</span><br><span class="line">        <span class="keyword">return</span> serializer_class(*args, **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_serializer_class</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        Return the class to use for the serializer.返回用于序列化的类。</span></span><br><span class="line"><span class="string">        Defaults to using `self.serializer_class`.默认使用self.serializer_class</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        You may want to override this if you need to provide different</span></span><br><span class="line"><span class="string">        serializations depending on the incoming request.</span></span><br><span class="line"><span class="string">        如果需要根据传入请求提供不同的序列化，则可能需要重写此项。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        (Eg. admins get full serialization, others get basic serialization)</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">assert</span> self.serializer_class <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>, (</span><br><span class="line">            <span class="string">"'%s' should either include a `serializer_class` attribute, "</span></span><br><span class="line">            <span class="string">"or override the `get_serializer_class()` method."</span></span><br><span class="line">            % self.__class__.__name__</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> self.serializer_class</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_serializer_context</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        Extra context provided to the serializer class.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">return</span> {</span><br><span class="line">            <span class="string">'request'</span>: self.request,</span><br><span class="line">            <span class="string">'format'</span>: self.format_kwarg,</span><br><span class="line">            <span class="string">'view'</span>: self</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">filter_queryset</span>(<span class="params">self, queryset</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        Given a queryset, filter it with whichever filter backend is in use.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        You are unlikely to want to override this method, although you may need</span></span><br><span class="line"><span class="string">        to call it either from a list view, or from a custom `get_object`</span></span><br><span class="line"><span class="string">        method if you want to apply the configured filtering backend to the</span></span><br><span class="line"><span class="string">        default queryset.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">for</span> backend <span class="keyword">in</span> list(self.filter_backends):</span><br><span class="line">            queryset = backend().filter_queryset(self.request, queryset, self)</span><br><span class="line">        <span class="keyword">return</span> queryset</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">paginator</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        The paginator instance associated with the view, or `None`.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> hasattr(self, <span class="string">'_paginator'</span>):</span><br><span class="line">            <span class="keyword">if</span> self.pagination_class <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                self._paginator = <span class="literal">None</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self._paginator = self.pagination_class()</span><br><span class="line">        <span class="keyword">return</span> self._paginator</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">paginate_queryset</span>(<span class="params">self, queryset</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        Return a single page of results, or `None` if pagination is disabled.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> self.paginator <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">return</span> self.paginator.paginate_queryset(queryset, self.request, view=self)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_paginated_response</span>(<span class="params">self, data</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        Return a paginated style `Response` object for the given output data.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">assert</span> self.paginator <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">return</span> self.paginator.get_paginated_response(data)</span><br></pre></td></tr></tbody></table></figure>

<h3 id="同时继承APIView和generics继承了mixins与多种通用CRUD类视图的继承关系"><a href="#同时继承APIView和generics继承了mixins与多种通用CRUD类视图的继承关系" class="headerlink" title="同时继承APIView和generics继承了mixins与多种通用CRUD类视图的继承关系"></a>同时继承<code>APIView</code>和<code>generics</code>继承了<code>mixins</code>与多种通用CRUD类视图的继承关系</h3><p><code>GenericAPIView</code>继承自<code>APIView</code>，在APIView的基础上实现过滤、分页等功能；</p>
<p><code>GenericAPIView</code>结合<code>mixins</code>形成各种<code>APIView</code>，如</p>
<ul>
<li><code>ListAPIView(mixins.ListModelMixin, GenericAPIView)</code>能接收GET请求，它封装了获取数据列表并返回JSON数据的<code>get</code>方法。</li>
<li><code>CreateAPIView</code>可以支持POST请求，</li>
<li><code>UpdateAPIView</code>可以支持PUT和PATCH请求，</li>
<li><code>DestoryAPIView</code>可以支持DELETE请求</li>
<li><code>RetrieveAPIView</code> 视图定义不用加pk，在路由后面增加id就可以获取一个实例的的详情</li>
<li><code>ListCreateAPIView</code></li>
<li><code>RetrieveUpdateAPIView</code></li>
</ul>
<h3 id="获取所有课程信息"><a href="#获取所有课程信息" class="headerlink" title="获取所有课程信息"></a>获取所有课程信息</h3><p><code>course\views.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.authentication <span class="keyword">import</span> BasicAuthentication, SessionAuthentication, TokenAuthentication</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> generics  <span class="comment"># from rest_framework.generics import ListAPIView</span></span><br><span class="line"><span class="keyword">from</span> rest_framework.permissions <span class="keyword">import</span> IsAuthenticated</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Course</span><br><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> CourseSerializer</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GCourseListView</span>(<span class="params">generics.ListAPIView</span>):</span></span><br><span class="line">    queryset = Course.objects.all()</span><br><span class="line">    serializer_class = CourseSerializer</span><br><span class="line">    authentication_classes = (BasicAuthentication, SessionAuthentication, TokenAuthentication)</span><br><span class="line">    permission_classes = (IsAuthenticated, )</span><br></pre></td></tr></tbody></table></figure>

<p><code>course\urls.py</code> 使用上面的<code>GCourseListView</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">urlpatterns = [</span><br><span class="line">    <span class="comment"># Generic Class Based View</span></span><br><span class="line">    path(<span class="string">"api/gcbv/courses/"</span>, views.GCourseListView.as_view(), name=<span class="string">"gcbv-list"</span>),</span><br><span class="line">]</span><br></pre></td></tr></tbody></table></figure>

<h3 id="获取所有课程信息或新增一个课程-2"><a href="#获取所有课程信息或新增一个课程-2" class="headerlink" title="获取所有课程信息或新增一个课程"></a>获取所有课程信息或新增一个课程</h3><p><code>course\views.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> generics</span><br><span class="line"><span class="keyword">from</span> rest_framework.permissions <span class="keyword">import</span> IsAuthenticated</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Course</span><br><span class="line"><span class="keyword">from</span> utils.permissions <span class="keyword">import</span> IsOwnerOrReadOnly</span><br><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> CourseSerializer</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GCourseListView</span>(<span class="params">generics.ListCreateAPIView</span>):</span></span><br><span class="line">    queryset = Course.objects.all()</span><br><span class="line">    serializer_class = CourseSerializer</span><br><span class="line">    authentication_classes = (BasicAuthentication, SessionAuthentication, TokenAuthentication)</span><br><span class="line">    permission_classes = (IsAuthenticated, )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">perform_create</span>(<span class="params">self, serializer</span>):</span></span><br><span class="line">        serializer.save(teacher=self.request.user)  <span class="comment"># 当前请求的登录用户赋值给teacher</span></span><br></pre></td></tr></tbody></table></figure>

<p><code>course\urls.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">urlpatterns = [</span><br><span class="line">    <span class="comment"># Generic Class Based View</span></span><br><span class="line">    path(<span class="string">"gcbv/list/"</span>, views.GCourseListView.as_view(), name=<span class="string">"gcbv-list"</span>),</span><br><span class="line">]</span><br></pre></td></tr></tbody></table></figure>

<h3 id="获取一个课程的详细信息、更新、删除一个课程-2"><a href="#获取一个课程的详细信息、更新、删除一个课程-2" class="headerlink" title="获取一个课程的详细信息、更新、删除一个课程"></a>获取一个课程的详细信息、更新、删除一个课程</h3><p><code>course\views.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> generics</span><br><span class="line"><span class="keyword">from</span> rest_framework.permissions <span class="keyword">import</span> IsAuthenticated</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Course</span><br><span class="line"><span class="keyword">from</span> utils.permissions <span class="keyword">import</span> IsOwnerOrReadOnly</span><br><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> CourseSerializer</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GCourseDetailView</span>(<span class="params">generics.RetrieveUpdateDestroyAPIView</span>):</span></span><br><span class="line">    queryset = Course.objects.all()</span><br><span class="line">    serializer_class = CourseSerializer</span><br><span class="line">    authentication_classes = (BasicAuthentication, SessionAuthentication, TokenAuthentication)</span><br><span class="line">    permission_classes = (IsAuthenticated, IsOwnerOrReadOnly)</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">urlpatterns = [</span><br><span class="line">    <span class="comment"># Generic Class Based View</span></span><br><span class="line">    path(<span class="string">"gcbv/detail/&lt;int:pk&gt;/"</span>,</span><br><span class="line">         views.GCourseDetailView.as_view(),</span><br><span class="line">         name=<span class="string">"gcbv-detail"</span>),</span><br><span class="line">]</span><br></pre></td></tr></tbody></table></figure>

<h2 id="DRF的视图集viewsets-整合了FBV-CBV-GCBV和的方法"><a href="#DRF的视图集viewsets-整合了FBV-CBV-GCBV和的方法" class="headerlink" title="DRF的视图集viewsets 整合了FBV CBV GCBV和的方法"></a>DRF的视图集<code>viewsets</code> 整合了FBV CBV GCBV和的方法</h2><p>高度定制化、灵活性低，开发效率高，几行代码可以完成CRUD</p>
<p><code>GenericViewSet(ViewSetMixin, generics.GenericAPIView)</code>继承自<code>GenericAPIView</code>，而GenericAPIView又继承自<code>APIView</code>，APIView又继承自<code>View</code>，前3个均属于DRF，<code>View</code>属于Django。</p>
<p>它们的主要差异在于<code>mixins</code>，包括<br><code>CreateModelMixin</code>有<code>create()</code>方法  Create a queryset<br><code>ListModelMixin</code>有<code>list()</code>方法  List a queryset<br><code>RetrieveModelMixin</code>有<code>retrieve()</code>方法 Retrieve a model instance 视图定义不用加pk，在路由后面增加id就可以获取一个实例的的详情（包括其基本信息和子类别）<br><code>UpdateModelMixin</code> 有<code>update()</code>方法 Upadate a model instance 更新一个实例的<br><code>DestroyModelMixin</code> 有<code>destroy()</code>方法 Destroy a model instance 获取一个实例的</p>
<p><code>class GenericViewSet(ViewSetMixin, generics.GenericAPIView)</code>继承自<code>ViewSetMixin</code>和<code>GenericAPIView</code>，<br><code>ViewSetMixin</code>允许且要求在urls.py中通过<code>router</code>进行方法的绑定或者自定义绑定，<br>ViewSet类与View类其实几乎是相同的,但提供的是read或update这些操作,而不是get或put 等HTTP动作。</p>
<p><code>viewsets</code>还实现了<code>initialize_request(request, *args, **kwargs)</code>方法，绑定了很多action，同时还实现了一些组合，包括<code>ReadOnlyModelViewSet</code>、<code>ModelViewSet</code>等。</p>
<p>源码</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReadOnlyModelViewSet</span>(<span class="params">mixins.RetrieveModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                           mixins.ListModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                           GenericViewSet</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    A viewset that provides default `list()` and `retrieve()` actions.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ModelViewSet</span>(<span class="params">mixins.CreateModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                   mixins.RetrieveModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                   mixins.UpdateModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                   mixins.DestroyModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                   mixins.ListModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                   GenericViewSet</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    A viewset that provides default `create()`, `retrieve()`, `update()`,</span></span><br><span class="line"><span class="string">    `partial_update()`, `destroy()` and `list()` actions.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></tbody></table></figure>

<p><code>course\views.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> viewsets</span><br><span class="line"><span class="keyword">from</span> rest_framework.permissions <span class="keyword">import</span> IsAuthenticated</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Course</span><br><span class="line"><span class="keyword">from</span> utils.permissions <span class="keyword">import</span> IsOwnerOrReadOnly</span><br><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> CourseSerializer</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CourseViewSet</span>(<span class="params">viewsets.ModelViewSet</span>):</span></span><br><span class="line">    queryset = Course.objects.all()</span><br><span class="line">    serializer_class = CourseSerializer</span><br><span class="line">    authentication_classes = (BasicAuthentication, SessionAuthentication, TokenAuthentication)</span><br><span class="line">    permission_classes = (IsAuthenticated, IsOwnerOrReadOnly)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">perform_create</span>(<span class="params">self, serializer</span>):</span></span><br><span class="line">        serializer.save(teacher=self.request.user)</span><br></pre></td></tr></tbody></table></figure>

<p><code>goods/views.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GoodsListViewSet</span>(<span class="params">mixins.ListModelMixin,viewsets.GenericViewSet</span>):</span></span><br><span class="line">    <span class="string">'商品列表页'</span></span><br><span class="line">    <span class="comment"># 有指定分页必须要定义一个默认的排序，否则会报错</span></span><br><span class="line">    queryset = Goods.objects.all().order_by(<span class="string">'id'</span>)</span><br><span class="line">    serializer_class = GoodsSerializer</span><br><span class="line">    pagination_class = GoodsPagination</span><br></pre></td></tr></tbody></table></figure>

<p><code>ViewSet</code>配置路由法一<br>Generic Class Based View 同一个类视图对应2个不同的url<br>给视图集指定请求的url应该调用哪些方法<br>字典的key是HTTP方法，<br>字典的value是调用视图集里面父类方法<br><code>value</code>的<code>list</code>是视图集<code>ModelViewSet</code>的子类<code>ListModelMixin</code>的<code>list</code>方法<br><code>value</code>的<code>create</code>是视图集<code>ModelViewSet</code>的子类<code>CreateModelMixin</code>的<code>create</code>方法</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">"viewsets/"</span>,</span><br><span class="line">         views.CourseViewSet.as_view({</span><br><span class="line">             <span class="string">"get"</span>: <span class="string">"list"</span>,</span><br><span class="line">             <span class="string">"post"</span>: <span class="string">"create"</span></span><br><span class="line">         }),</span><br><span class="line">         name=<span class="string">"viewsets-list"</span>),</span><br><span class="line"></span><br><span class="line">    path(<span class="string">"viewsets/&lt;int:pk&gt;/"</span>,</span><br><span class="line">         views.CourseViewSet.as_view({</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    This is the magic.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Overrides `.as_view()` so that it takes an `actions` keyword that performs</span></span><br><span class="line"><span class="string">    the binding of HTTP methods to actions on the Resource.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    For example, to create a concrete view binding the 'GET' and 'put' methods</span></span><br><span class="line"><span class="string">    to the 'retrieve' and 'update' actions...</span></span><br><span class="line"><span class="string">    view = MyViewSet.as_view({'get': 'retrieve', 'put': 'update', 'patch': 'partial_update', 'delete': 'destroy'})</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">             <span class="string">"get"</span>: <span class="string">"retrieve"</span>,</span><br><span class="line">             <span class="string">"put"</span>: <span class="string">"update"</span>,</span><br><span class="line">             <span class="string">"patch"</span>: <span class="string">"partial_update"</span>,</span><br><span class="line">             <span class="string">"delete"</span>: <span class="string">"destroy"</span></span><br><span class="line">         }),</span><br><span class="line">         name=<span class="string">"viewsets-detail"</span>),</span><br><span class="line">]</span><br></pre></td></tr></tbody></table></figure>

<p><code>mxshop/url.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> goods.views <span class="keyword">import</span> GoodsListViewSet</span><br><span class="line"></span><br><span class="line">goods_list = GoodsListViewSet.as_view({</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    This is the magic.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Overrides `.as_view()` so that it takes an `actions` keyword that performs</span></span><br><span class="line"><span class="string">    the binding of HTTP methods to actions on the Resource.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    For example, to create a concrete view binding the 'GET' methods</span></span><br><span class="line"><span class="string">    to the 'list' actions...</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    view = MyViewSet.as_view({'get': 'list'})</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="string">'get'</span>: <span class="string">'list'</span>,  <span class="comment"># 使get()请求绑定到list()方法</span></span><br><span class="line">})</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">'goods/'</span>, goods_list, name=<span class="string">"goods-list"</span>),</span><br><span class="line">]</span><br></pre></td></tr></tbody></table></figure>

<p><code>ViewSet</code>配置路由法二<br>drf自带路由<code>routers</code> 提供了一种简单，快速，集成的方式来定义一系列的urls<br>将<code>get()</code>请求转到<code>list()</code>方法、<code>post()</code>请求转到<code>create()</code>方法，<br>还执行一些其他默认操作，以后添加其他模型的视图也直接添加一行代码<code>router.register('xxx', XxxListViewSet)</code>即可。</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path, include</span><br><span class="line"><span class="keyword">from</span> rest_framework.routers <span class="keyword">import</span> DefaultRouter</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> course <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line">router = DefaultRouter()  <span class="comment"># 生成一个路由实例对象</span></span><br><span class="line"><span class="comment"># 视图集注册到路由实例</span></span><br><span class="line">router.register(prefix=<span class="string">"viewsets"</span>, viewset=views.CourseViewSet)</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">""</span>, include(router.urls))</span><br><span class="line">]</span><br></pre></td></tr></tbody></table></figure>

<p><code>mxshop/url.py</code></p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> goods.views <span class="keyword">import</span> GoodsListViewSet</span><br><span class="line"><span class="keyword">from</span> rest_framework.routers <span class="keyword">import</span> DefaultRouter</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> goods.views <span class="keyword">import</span> GoodsListViewSet</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">router = DefaultRouter()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 商品列表页</span></span><br><span class="line">router.register(prefix=<span class="string">'goods'</span>, viewset=GoodsListViewSet)</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">''</span>, include(router.urls)),</span><br><span class="line">]</span><br></pre></td></tr></tbody></table></figure>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/27/">27</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>
<script src="/js/comments.js"></script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">外心人D</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
